"","guid","title","report_attrs","description","required_modules","additional_display_type_id","database_connection","legacy_identifier","user_report_id","entered_by","last_modified_by","option_labels","last_modified_date_time","sql_query","report_group_by"
"1","bc9a54e1-4322-49e5-ba87-710cd5108129","LONGLINE - National fleet vessel catch report ","year",NA,"Logsheets",NA,NA,"4",2890,"andrewh@spc.int","benoitp@spc.int","Logsheet, Longline, ByVessel, RegionalReporting, Tuna","2024-04-11T08:58:46.357"," SELECT  vi.vesselname vessel_name, 
		:group_by, 
		COUNT(DISTINCT t.log_trip_id) as trips,
		COUNT(DISTINCT s.log_set_id) logdays,
		COUNT(DISTINCT CASE s.l_activity_id WHEN 1 THEN s.log_set_id ELSE NULL END) sets,
		t2.sea_days,		
		MAX(tmp.hhooks) hooks_100,  
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_kg_est ELSE 000.0 END) / 1000 AS DECIMAL(5,2)) alb_mt, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_kg_est ELSE 000.0 END) / MAX(tmp.hhooks) AS DECIMAL(6,2)) alb_cpue, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0)) alb_n, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_n_est ELSE 000.0 END)  / MAX(tmp.hhooks) AS DECIMAL(6,2)) alb_npue, 
		CAST(SUM(CASE WHEN sp_code in ('BET','BE0') THEN sp_kg_est ELSE 000.0 END) /1000 AS DECIMAL(5,2)) bet_mt, 
		CAST(SUM(CASE WHEN sp_code in ('BET','BE0') THEN sp_kg_est ELSE 000.0 END) / MAX(tmp.hhooks) AS DECIMAL(6,2)) bet_cpue, 
		CAST(SUM(CASE WHEN sp_code in ('BET','BE0') THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0)) bet_n, 
		CAST(SUM(CASE WHEN sp_code in ('BET','BE0') THEN sp_n_est ELSE 000.0 END)  / MAX(tmp.hhooks) AS DECIMAL(6,2)) bet_npue, 
		CAST(SUM(CASE WHEN sp_code in ('YFT','YF0') THEN sp_kg_est ELSE 000.0 END) /1000 AS DECIMAL(5,2)) yft_mt, 
		CAST(SUM(CASE WHEN sp_code in ('YFT','YF0') THEN sp_kg_est ELSE 000.0 END) / MAX(tmp.hhooks) AS DECIMAL(6,2)) yft_cpue, 
		CAST(SUM(CASE WHEN sp_code in ('YFT','YF0') THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0)) yft_n, 
		CAST(SUM(CASE WHEN sp_code in ('YFT','YF0') THEN sp_n_est ELSE 000.0 END) / MAX(tmp.hhooks) AS DECIMAL(6,2)) yft_npue, 
		CAST(SUM(CASE sp_code WHEN 'YFT' THEN 0 WHEN 'YF0' THEN 0 WHEN 'ALB' THEN 0 WHEN 'BET' THEN 000.0 WHEN 'BE0' THEN 000.0 ELSE sp_kg_est END)/1000 AS DECIMAL(5,0)) oth_mt, 
		CAST(SUM(CASE sp_code WHEN 'YFT' THEN 0 WHEN 'YF0' THEN 0 WHEN 'ALB' THEN 0 WHEN 'BET' THEN 0 WHEN 'BE0' THEN 0 ELSE sp_n_est END) AS DECIMAL(7,0)) oth_n, 
		CAST(SUM(sp_kg_est) /1000.0  AS DECIMAL(5,0)) tot_mt, 
		CAST(SUM(sp_n_est) AS DECIMAL(7,0)) tot_n 
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id
		LEFT JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND vi.flag_id = @@entity
		JOIN (
			SELECT  vi.vessel_instance_id,
					vi.vesselname,
					:group_by key1, 
					SUM(hooks_n)/100 hhooks  
			FROM    log.trips_ll  t inner join log.sets_ll  s on t.log_trip_id = s.log_trip_id
					JOIN ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND vi.flag_id = @@entity
			WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
			GROUP BY vi.vessel_instance_id, vi.vesselname, :group_by
			having SUM(hooks_n)/100 > 0
		) tmp ON tmp.vessel_instance_id = vi.vessel_instance_id AND tmp.key1 = :group_by
		JOIN (
			SELECT  :group_by groupBy,
					vi.vesselname,
					vi.vessel_instance_id,
					COUNT(distinct c.logdate) sea_days
			FROM    log.trips_ll  t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND vi.flag_id = @@entity
					JOIN (SELECT date_day logdate FROM ref.calendar) c ON c.logdate BETWEEN t.depart_date AND t.return_date
			WHERE   YEAR(c.logdate) = COALESCE(:year, YEAR(c.logdate))
			GROUP BY vi.vessel_instance_id, vi.vesselname, :group_by
		) t2 ON t2.groupBy = :group_by and t2.vessel_instance_id = vi.vessel_instance_id
WHERE    YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
GROUP BY vi.vesselname, :group_by, t2.sea_days","YearMonth"
"2","1a70dd40-7cca-46ab-b078-e02fd81f67cf"," PURSE SEINE - Tuna Catch and Effort - BY FLAG","flag_code, year","BY FLEET - Tuna Catch and Effort by EEZ","Logsheets",NA,NA,"11",2900,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2021-09-28T14:07:25.597"," SELECT  vi.flag_id flag_code,
		:group_by,
        COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips, 
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		max(x.fish_days) as fish_days, 
		max(x.fish_days_AWs_only) as fish_days_AWs_only, 
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as  decimal(9,2))            AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end)  as  decimal(9,2))               AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end) as  decimal(9,2))             AS yft_mt, 
		cast(Sum(case when sp_code not in ('YFT','BET','SKJ') then sp_mt_est else 000.0 end) as decimal(9,2))             AS oth_mt, 		
        cast(Sum(sp_mt_est) as  decimal(11,2))   AS tot_mt 
FROM log.trips_ps t 
			inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
			inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
			inner join (
				select  vi.flag_id flag_code,
						:group_by as key1,
                        SUM(case when s_activity_id in (1,2) then effort_factor else 00000.000 end) as fish_days,
                        SUM(case when s_activity_id in (1,2) and in_AWS = 1 then effort_factor else 00000.000 end) as fish_days_AWs_only
				FROM log.trips_ps t 
						inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
						inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
				WHERE year(logdate) = coalesce(:year, year(logdate)) 
      				and vi.flag_id = coalesce(:flag_code, vi.flag_id)
      				AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
				group by vi.flag_id, :group_by) x on x.flag_code = vi.flag_id and x.key1 = :group_by
			left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and vi.flag_id = coalesce(:flag_code, vi.flag_id)
      AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, :group_by","YearMonth"
"3","07d74811-e607-46e8-a6eb-45e8eabb737a"," Part1 - Annual LONGLINE catch and effort estimates by FLEET in the Home EEZ (national waters)","year","Annual LONGLINE catch and effort estimates by FLEET in the Home EEZ (national waters)","Logsheets",NA,"Live","11a",2911,"andrewh@spc.int","benoitp@spc.int","Logsheet, Longline, CMM","2022-04-07T14:30:24.21"," SELECT  vi.flag_id flag_code,
		COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips,
		Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000				AS alb_mt, 
		Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) /1000				AS bet_mt, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end) /1000				AS yft_mt, 
		Sum(case sp_code when 'YFT' then 0 when 'ALB' then 0 when 'BET' then 000.0 else sp_kg_est end)/1000 AS oth_mt, 
		Sum(sp_kg_est) /1000.0  AS tot_mt 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id",NA
"4","2bedfb31-dfc8-4363-a89c-67d8fa3cb533"," LONGLINE - NATIONAL FLEET - Tuna Catch and Effort in the WCPFC Area","year","NATIONAL FLEET - LONGLINE Catch and Effort in the WCPFC Area","Logsheets",1,NA,"1",2887,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, RegionalReporting","2021-10-07T13:09:51.76"," SELECT :group_by, 
		COUNT(DISTINCT t.vessel_id) vessels,
		COUNT(DISTINCT t.log_trip_id) trips,
		COUNT(DISTINCT CAST(t.log_trip_id AS VARCHAR(50)) + CAST(CAST(logdate AS DATE) AS VARCHAR(10))) log_days,
		t2.sea_days,		
		MAX(tmp.hhooks) hooks_100,  
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_kg_est ELSE 000.0 END) / 1000 AS DECIMAL(5,0))	alb_mt, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_kg_est ELSE 000.0 END) / max(tmp.hhooks) AS DECIMAL(6,2)) alb_cpue, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0))	alb_n, 
		CAST(SUM(CASE sp_code WHEN 'ALB' THEN sp_n_est ELSE 000.0 END) / max(tmp.hhooks) AS DECIMAL(6,2)) alb_npue, 
		CAST(SUM(CASE WHEN sp_code IN ('BET','BE0') THEN sp_kg_est ELSE 000.0 END) /1000 AS DECIMAL(5,0)) bet_mt, 
		CAST(SUM(CASE WHEN sp_code IN ('BET','BE0') THEN sp_kg_est ELSE 000.0 END) / max(tmp.hhooks) AS DECIMAL(6,2)) bet_cpue, 
		CAST(SUM(CASE WHEN sp_code IN ('BET','BE0') THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0)) bet_n, 
		CAST(SUM(CASE WHEN sp_code IN ('BET','BE0') THEN sp_n_est ELSE 000.0 END) / max(tmp.hhooks)	AS DECIMAL(6,2)) bet_npue, 
		CAST(SUM(CASE WHEN sp_code IN ('YFT','YF0') THEN sp_kg_est ELSE 000.0 END) /1000 AS DECIMAL(5,0)) yft_mt, 
		CAST(SUM(CASE WHEN sp_code IN ('YFT','YF0') THEN sp_kg_est ELSE 000.0 END) / max(tmp.hhooks) AS DECIMAL(6,2)) yft_cpue, 
		CAST(SUM(CASE WHEN sp_code IN ('YFT','YF0') THEN sp_n_est ELSE 0 END) AS DECIMAL(7,0)) yft_n, 
		CAST(SUM(CASE WHEN sp_code IN ('YFT','YF0') THEN sp_n_est ELSE 000.0 END) / max(tmp.hhooks)	AS DECIMAL(6,2)) yft_npue, 
		CAST(SUM(CASE sp_code WHEN 'YFT' THEN 0 WHEN 'YF0' THEN 0 WHEN 'ALB' THEN 0 WHEN 'BET' THEN 000.0 WHEN 'BE0' THEN 000.0 ELSE sp_kg_est END)/1000 AS DECIMAL(5,0)) oth_mt, 
		CAST(SUM(CASE sp_code WHEN 'YFT' THEN 0 WHEN 'YF0' THEN 0 WHEN 'ALB' THEN 0 WHEN 'BET' THEN 0 WHEN 'BE0' THEN 0 ELSE sp_n_est END) AS DECIMAL(7,0)) oth_n, 
		CAST(SUM(sp_kg_est) /1000.0 AS DECIMAL(5,0)) tot_mt, 
		CAST(SUM(sp_n_est) AS DECIMAL(7,0))	tot_n 
FROM    log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
        LEFT JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
        JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
JOIN ( 
            SELECT  :group_by key1, 
                    SUM(hooks_n)/100 hhooks  
            FROM    log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
                    JOIN ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
            WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
            GROUP BY :group_by
        ) tmp ON tmp.key1 = :group_by
        JOIN (
            SELECT  :group_by groupBy,
                    COUNT(DISTINCT CONVERT(VARCHAR(100),log_trip_id)+CONVERT(VARCHAR(100),c.logdate,103)) sea_days
            FROM    log.trips_ll   t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
                    JOIN (SELECT date_day logdate FROM ref.calENDar) c ON c.logdate BETWEEN t.depart_date AND t.return_date
            WHERE   YEAR(c.logdate) = COALESCE(:year, YEAR(c.logdate))
            GROUP BY :group_by
        ) t2 ON t2.groupBy = :group_by
WHERE    YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
GROUP BY :group_by, t2.sea_days","YearMonth"
"5","e61c16f2-76f3-4609-93bc-de4b973a9af6"," PURSE SEINE - Length Frequency","sp_code, flag_code, year, obsv_prg, set_type_cat, set_type","Produces length Frequency observer data for selected SPECIES, YEAR Range and SET TYPE, with grouping by YEAR, MONTH or QUARTER","Observer",NA,"Observer","6",2923,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2021-12-15T14:26:01.873"," select tmp1.species,
		len,
		SUM(f_q1) as f_q1,
		SUM(f_q2) as f_q2,
		SUM(f_q3) as f_q3,
		SUM(f_q4) as f_q4,
		SUM(f_m1) as f_m1,
		SUM(f_m2) as f_m2,
		SUM(f_m3) as f_m3,
		SUM(f_m4) as f_m4,
		SUM(f_m5) as f_m5,
		SUM(f_m6) as f_m6,
		SUM(f_m7) as f_m7,
		SUM(f_m8) as f_m8,
		SUM(f_m9) as f_m9,
		SUM(f_m10) as f_m10,
		SUM(f_m11) as f_m11,
		SUM(f_m12) as f_m12
from (
	SELECT 	
		sp_code as species,
		sl.len as len,
		sum(case when month(act_date) in (1,2,3)	then 00001 else 00000 end) as f_q1, 
		sum(case when month(act_date) in (4,5,6)	then 00001 else 00000 end) as f_q2, 
		sum(case when month(act_date) in (7,8,9)	then 00001 else 00000 end) as f_q3, 
		sum(case when month(act_date) in (10,11,12)	then 00001 else 00000 end) as f_q4, 
		sum(case when month(act_date) = 01	then 00001 else 00000 end) as f_m1, 
		sum(case when month(act_date) = 02	then 00001 else 00000 end) as f_m2, 
		sum(case when month(act_date) = 03	then 00001 else 00000 end) as f_m3, 
		sum(case when month(act_date) = 04	then 00001 else 00000 end) as f_m4, 
		sum(case when month(act_date) = 05	then 00001 else 00000 end) as f_m5, 
		sum(case when month(act_date) = 06	then 00001 else 00000 end) as f_m6, 
		sum(case when month(act_date) = 07	then 00001 else 00000 end) as f_m7, 
		sum(case when month(act_date) = 08	then 00001 else 00000 end) as f_m8, 
		sum(case when month(act_date) = 09	then 00001 else 00000 end) as f_m9, 
		sum(case when month(act_date) = 10	then 00001 else 00000 end) as f_m10, 
		sum(case when month(act_date) = 11	then 00001 else 00000 end) as f_m11, 
		sum(case when month(act_date) = 12	then 00001 else 00000 end) as f_m12 
	FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_lf slf on ss.s_set_id = slf.s_set_id
				inner join obsv.s_lfmeas sl on slf.s_lf_id = sl.s_lf_id
	WHERE YEAR(act_date) = coalesce(:year,year(act_date))
		AND s_activ_id = 1 
		AND sp_code = :sp_code
	    AND flag_id = coalesce(:flag_code,flag_id)
		AND coalesce(schas_id,20) = coalesce(:set_type_id,coalesce(schas_id,20))
		AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
		AND case 	when coalesce(schas_id,20)-20 in (1,2) then 'U' 
 					when coalesce(schas_id,20)-20 in (3,4,5,6) then 'A' 
 					else 'O' end 
 			= coalesce(:set_type_cat_code,
				case when coalesce(schas_id,20)-20 in (1,2) then 'U' 
			   			when coalesce(schas_id,20)-20 in (3,4,5,6) then 'A' 
					else 'O' end)
	GROUP BY sp_code, sl.len 
	UNION 
	SELECT 	
		:sp_code as species,
		tmp.key1 as len,
		sum(00000) as f_q1, 
		sum(00000) as f_q2, 
		sum(00000) as f_q3, 
		sum(00000) as f_q4, 
		sum(00000) as f_m1, 
		sum(00000) as f_m2, 
		sum(00000) as f_m3, 
		sum(00000) as f_m4, 
		sum(00000) as f_m5, 
		sum(00000) as f_m6, 
		sum(00000) as f_m7, 
		sum(00000) as f_m8, 
		sum(00000) as f_m9, 
		sum(00000) as f_m10, 
		sum(00000) as f_m11, 
		sum(00000) as f_m12 
	FROM	(	select key1 
				from (	select n as key1
						from ref.numbers) tmp0
						where key1 <= 200) tmp 
	GROUP BY tmp.key1 ) tmp1
GROUP BY tmp1.species, tmp1.len",NA
"6","caf3b4e4-52d5-40af-beec-8b1d1c2fd6a5"," Aircraft and Vessel Sightings by Observer Trip (GEN-1)","obsv_prg","Aircraft and Vessel Sightings by Observer Trip (GEN-1) - Deirdre's Request","Observer",NA,"Observer","4",2931,"andrewh@spc.int","colleyf@spc.int","Observer, MyEEZ","2025-10-06T11:42:24.357"," SELECT t.obsprg_code AS obsprg_code,
 DATEPART(yyyy,t.dep_date) AS trip_year,
 t.obstrip_id AS obstrip_id,
 staff_code AS staff_code,
 t.tripno AS tripno,
 t.gear_code as gear_code,
 count(s.sighting_id) as total_sightings_count
FROM obsv.gen1sightings s INNER JOIN obsv.trip t
ON s.obstrip_id = t.obstrip_id
inner join ref.field_staff f on f.staff_id=t.observer_id
WHERE t.gear_code = 'S'
AND (t.obsprg_code = :obsv_prg OR COALESCE(:obsv_prg,'X')='X')
group by t.dep_date,t.obsprg_code, t.gear_code,t.obstrip_id,staff_code,t.tripno",NA
"7","7a104266-fe85-4fde-bf60-826ecc4d81c2"," CMM 11-03 - CETACEAN interactions in Purse seine fishery for NATIONAL FLEET","flag_code, min_year, max_year","CCMs shall include in their Part 1 Annual Report any instances in which cetaceans have been encircled by the purse seine nets of their flagged vessels, reported under paragraph 2(b).","Observer",NA,"Observer","9",2940,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Purseseine, CMM, Raised, RegionalReporting, ByCatch","2025-09-15T15:49:52.147"," SELECT 	'S' as gear,
		flag_id as flag, 
		sp.sp_name as species,
		CONVERT(VARCHAR(10), act_date, 103) as date, 
		sa.lat, 
		sa.lon, 
		eez_code, 
		fate_code, 
		cond_code as caught_cond_code,
		discard_cond_code as discarded_cond_code,
		gr_interact_code,
				case gr_interact_code 
			when 'INT' then 'Migrated from old GEN2' 
			when 'IEN' then 'Entangled in gear'
			when 'IJO' then 'Jump out over net'
			when 'ICR' then 'Crew released from net'
			when 'IBR' then 'Broke through net'
			when 'IRN' then 'Roped, pulled from net'
			when 'OTH' then 'Other'
			else '-' END  as gear_interaction_desc,
		case when gr_interact_code is null then 'LANDED' else 'INTERACTION' end as type,
		case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end as Individuals
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(act_date) between coalesce(:min_year,year(act_date)) and coalesce(:max_year,year(act_date))
	AND s_activ_id = 1 
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'MAM' 
	AND case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end > 0
UNION 
SELECT 	'L' as gear, 
		flag_id as flag, 
		sp.sp_name as species,
		CONVERT(VARCHAR(10), sc.catch_date, 103) as date, 
		sa.lat, 
		sa.lon, 
		eez_code, 
		fate_code, 
		cond_code as caught_cond_code,
		cond_code2 as discarded_cond_code,
		gr_interact_code,
			case gr_interact_code 
			when 'INT' then 'Migrated from old GEN2' 
			when 'IEN' then 'Entangled in gear'
			when 'IHE' then 'Hooked Externally'
			when 'IHI' then 'Hooked Internally'
			when 'IHJ' then 'Hooked in jaw'
			when 'IHE' then 'Hooked deeply - throat or stomach'
			when 'IHU' then 'Hooked Unknown'
			when 'IFB' then 'Feeding on bait during set'
			else '-' END  as gear_interaction_desc,
		case when gr_interact_code is null then 'LANDED' else 'INTERACTION' end as type,
		1 as Individuals
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83 
				inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(sc.catch_date) between coalesce(:min_year,year(sc.catch_date)) and coalesce(:max_year,year(sc.catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'MAM'",NA
"8","b205ae4c-2da1-293b-828a-3a0231d0500d"," LONGLINE - NATIONAL FLEET - Effort - Map","year",NA,"Logsheets",2,NA,NA,3463,"brunod@spc.int","brunod@spc.int","Logsheet, Longline, RegionalReporting","2023-09-19T10:47:52.883"," SELECT  :group_by, 
		SUM(COALESCE(hooks_n,0)) hooks
FROM     log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
		JOIN ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND vi.flag_id = @@entity 
WHERE   YEAR(logdate) = COALESCE(:year, year(logdate)) 
AND        vi.flag_id = COALESCE(:flag_code,vi.flag_id)
GROUP BY :group_by","Latitude5Longitude5"
"9","dbb9b8fc-35b4-40fa-a31c-1f636264182f"," CMM 12-01 – FAD sets in the FAD Closure period","flag_code, year","CMM 2012-01 – FAD sets in the FAD Closure period","Observer",NA,"Observer","EXTRA",2957,"andrewh@spc.int","andrewh@spc.int","Observer, Purseseine, CMM, Raised, RegionalReporting, Tuna","2022-04-06T14:19:52.8"," SELECT 	distinct vesselname,
		flag_id as flag, 
		cast(convert( char(8), dep_date,112) as char(8)) as dep_date, 
		cast(convert( char(8), ret_date,112) as char(8)) as ret_date,
		cast(convert( char(8), act_date,112) as char(8)) as logdate, 
		act_time,
		r1.school_association_desc as set_type, 
		r.detection_desc as detection, 
		beacon, 
		payao, 
		lat, 
		lon, 
		eez_code,
        case when coalesce(in_AWs,999) = 999		then '???'	when coalesce(in_AWs,999) = 0 then 'No' else 'Yes' end as in_AWs,
        case when coalesce(WCPFC_Area,999) = 999	then '???'	when coalesce(WCPFC_Area,999) = 0 then 'No' else 'Yes' end as WCPFC_Area,
        case when coalesce(WCPFC_Overlap,999) = 999 then '???'	when coalesce(WCPFC_Overlap,999) = 0 then 'No' else 'Yes' end as WCPFC_Overlap,
        ot.obsprg_code,
		staff_code,
        ot.tripno,
		cast(sa.comments as char(50)) as comments,
		SUM(case when sp_code in ('SKJ','YFT','BET') then coalesce(obs_mt,00000) else 00000 end) as tuna_c
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join ref.field_staff f on f.staff_id=ot.observer_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref_static.ps_detection_codes r on sa.deton_id = r.deton_id
				left outer join ref_static.ps_school_associations r1 on sa.schas_id = r1.schas_id
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
	AND s_activ_id = 1 
    AND flag_id = coalesce(:flag_code,flag_id)
	AND MONTH(act_date) in (7,8,9,10)
	and  coalesce(sa.schas_id,20)-20 in (3,4,5)
 group by vesselname,
		flag_id, 
		cast(convert( char(8), dep_date,112) as char(8)), 
		cast(convert( char(8), ret_date,112) as char(8)),
		cast(convert( char(8), act_date,112) as char(8)), 
		act_time,
		r1.school_association_desc,
		r.detection_desc, 
		beacon, 
		payao, 
		lat, 
		lon, 
		eez_code,
        case when coalesce(in_AWs,999) = 999		then '???'	when coalesce(in_AWs,999) = 0 then 'No' else 'Yes' end,
        case when coalesce(WCPFC_Area,999) = 999	then '???'	when coalesce(WCPFC_Area,999) = 0 then 'No' else 'Yes' end,
        case when coalesce(WCPFC_Overlap,999) = 999 then '???'	when coalesce(WCPFC_Overlap,999) = 0 then 'No' else 'Yes' end,
        ot.obsprg_code,
        staff_code,
        ot.tripno,
		cast(sa.comments as char(50))",NA
"10","9f2fca5c-ac63-46dc-9c4f-008b5ad75586"," LONGLINE - Logsheets with future dates","","This report shows all the logsheets with a depart date or return date in the future.","Logsheets",NA,NA,"7",2976,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, DataQuality","2021-10-11T14:27:58.16"," Select t.log_trip_id,
t.depart_date, 
t.return_date,
vi.vesselname
from log.trips_ll t inner join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.depart_date > vi.start_date and t.depart_date < vi.calculated_end_date
where YEAR (return_date) > YEAR (GETDATE()) 

UNION ALL

Select t.log_trip_id,
t.depart_date, 
t.return_date, 
vi.vesselname
from log.trips_ll t inner join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.depart_date > vi.start_date and t.depart_date < vi.calculated_end_date
where YEAR (depart_date) > YEAR (GETDATE())",NA
"11","ff7a4150-1ca5-45f1-ae8c-cd8944656a87"," CMM 10-07 - Shark catches by NATIONAL FLEET DETAILED VERSION with VESSEL NAME","flag_code, year","Each CCM shall include key shark species*, as identified by the Scientific Committee, in their annual reporting to the Commission of annual catch and fishing effort statistics by gear type, including available historical data, in accordance with the WCPF Convention and agreed reporting procedures. …
*footnote 2: The key shark species are blue shark, silky shark, oceanic whitetip shark, mako sharks, and thresher sharks, porbeagle shark (south of 20°S, until biological data shows this or another geographic limit to be appropriate) and hammerhead sharks (winghead, scalloped, great, and smooth).]
Whale Sharks (Rhincodon typus) was included as a key shark species by SC8 (2012)","Logsheets",NA,NA,"26b",3000,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, ByVessel, CMM, RegionalReporting, ByCatch","2022-12-19T14:53:02.01"," SELECT  'PS' as gear,   
        v.flag_id as flag,
		v.vesselname as vessel_name,
        sp.sp_name as species,
		catch_ps.sp_n as number,
		catch_ps.sp_n_est as number_est,
		catch_ps.sp_mt * 1000 as weight,
		catch_ps.sp_mt_est * 1000 as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when discard=1 then 'Discarded' else 'Retained' end as fate
        
FROM    log.trips_ps trip_ps 
        inner join ref.vessel_instances v on trip_ps.vessel_id = v.vessel_id AND trip_ps.depart_date BETWEEN v.start_date AND v.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code

WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND v.flag_id = coalesce(:flag_code,v.flag_id)
        AND sp.sp_cat_code = 'SHK' 

UNION  

SELECT  'LL' as gear,   
        v.flag_id as flag,
		v.vesselname as vessel_name,
        sp.sp_name as species,
		catch_ll.sp_n as number,
		catch_ll.sp_n_est as number_est,
		catch_ll.sp_kg as weight,
		catch_ll.sp_kg_est as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when spdiscard_n>0 then 'Discarded' else 'Retained' end as life_status
        
FROM    log.trips_ll trip_ll 
        inner join ref.vessel_instances v on trip_ll.vessel_id = v.vessel_id AND trip_ll.depart_date BETWEEN v.start_date AND v.calculated_end_date
        inner join log.sets_ll set_ll on set_ll.log_trip_id = trip_ll.log_trip_id
        inner join log.catch_ll catch_ll on catch_ll.log_set_id = set_ll.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ll.sp_code

WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND v.flag_id = coalesce(:flag_code,v.flag_id)
        AND sp.sp_cat_code = 'SHK'",NA
"12","e775ffd0-23b5-489c-9cbe-dcaa6ce57172"," PURSE SEINE - Missing Logsheets in EEZ","flag_code, year","Using VMS data, lists the logsheet that you should see and not entered yet in TUFMAN2","Logsheets,VMS",NA,NA,"1.1.1",3017,"andrewh@spc.int","eparamal@spc.int","Logsheet, Purseseine, CoverageMissingData, MyEEZ","2024-11-28T14:01:01.063","SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                        INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
                              (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                              OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                              OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                              OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
                        )
			) t 

SELECT  vi.vesselname vessel_name,vi.flag_id flag_code,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing 
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND (@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
        /*INNER JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)*/
        INNER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='S'
AND		COALESCE(:flag_code,vi.flag_id)=vi.flag_id
AND		COALESCE(:year, eez.year)=eez.year 
AND     eez.eez_code <> 'IW' 
GROUP BY vi.vesselname,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"13","a00f48a9-a6d1-4d27-a694-477d31d32fdc"," PURSE SEINE - FFA API Report - PS Unloadings","flag_code, year",NA,"Port",NA,NA,"89.2",3025,"andrewh@spc.int","brunod@spc.int","Unloading, Purseseine, API","2021-10-08T13:54:07.75"," SELECT	p.country_code,vi.flag_id flag_code, YEAR(u.unload_startdate) year, MONTH(u.unload_startdate) month, COUNT(*) nb_unloadings
FROM	unload2.carrier_loading cl INNER JOIN unload2.unloadings_ps u ON cl.carrier_loading_id = u.carrier_loading_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = u.vessel_id AND u.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date		
		INNER JOIN ref.ports p ON cl.port_id = p.port_id
WHERE	(@@entity = 'HIVE' OR p.country_code = @@entity)
AND		COALESCE(:flag_code,flag_id)=flag_id
AND		COALESCE(:year,YEAR(u.unload_startdate))=YEAR(u.unload_startdate)
GROUP BY p.country_code,vi.flag_id,YEAR(u.unload_startdate), MONTH(u.unload_startdate)",NA
"14","9c211041-9a60-4803-9375-9e2068ff3082"," Position Reports by Vessel","year","Shows all the recorded position reports by vessel","Port",NA,NA,"55",3033,"andrewh@spc.int","brunod@spc.int","Logsheet, Tuna","2022-02-28T15:04:10.473"," select rpt_code,
	coalesce(vi.vesselname, 'none') as vessel_name,
	v.gear,
	licence_no,
	month(telex_date) as month,
	telex_date,
	telex_time,
	lat latitude,
	lon longitude,
	fish_days_n,
	fuel,
	skj_mt,
	yft_mt,
	bet_mt,
	alb_mt,
	oth_mt,
	catch_mt
from pos.position_reports p inner join ref.vessel_instances vi on p.vessel_id = vi.vessel_id AND p.telex_date BETWEEN vi.start_date AND vi.calculated_end_date
	inner join ref.vessels v on v.vessel_id = vi.vessel_id
	inner join tufman2.licence_info l on l.vessel_id = p.vessel_id AND p.telex_date BETWEEN l.lic_startdate AND l.lic_enddate
where YEAR(telex_date) = :year",NA
"15","05dc6a5c-cc6b-4de8-8d2d-f1b3f9a6ab73"," PURSE SEINE - Unloadings coverage","",NA,"Logsheets",1,NA,"3.1.2",3041,"andrewh@spc.int","brunod@spc.int","Unloading, Purseseine, CoverageMissingData","2021-10-26T12:14:32.737"," SELECT	YEAR(t.depart_date) year, 
		CONVERT(DECIMAL(5,2),count(distinct l.dto_guid_right)*100.0/count(distinct t.log_trip_id)) cov_unloading
FROM	log.trips_ps t LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='PurseseineLogsheetDTO'  AND l.dto_type_right='CarrierLoadingDTO'
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(t.depart_date) >= YEAR(GETDATE())-10
GROUP BY YEAR(t.depart_date)",NA
"16","083abb4b-1e0b-49d4-9d01-a3a9bb261770"," PURSE SEINE - Tuna catches in EEZ raised with VMS","flag_code, year",NA,"Logsheets,VMS",NA,NA,"1.1.5",3047,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2023-03-14T14:41:10.703","/* 

-- Old code
--

SELECT vms_trip_id INTO #mapped_trip FROM (
	SELECT	dto_guid_left vms_trip_id
	FROM	tufman2.viewpersist_entity_links_two_way
	WHERE	dto_type_left = 'Ofp.Tufman2.Models.DTOs.VmsTripDTO'
	AND		dto_type_right = 'Ofp.Tufman2.Models.DTOs.PurseseineLogsheetDTO'
) t 
*/

/*
--
-- New code
--
*/

SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ps l 
				INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id /* AND l.first_logdate BETWEEN vi.start_date AND vi.calculated_end_date*/
                INNER JOIN vms.vms_trips t ON 
						t.vessel_id = vi.vessel_id
							AND l.depart_date < t.return_date
							AND l.return_date > t.departure_date
			) t

SELECT	vi.flag_id,eez.year,eez.month,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
        JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
        /*INNER JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)*/
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id FROM #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND     ve.gear = 'S'
AND		eez.year = coalesce(:year,eez.year)
GROUP BY vi.flag_id,eez.year,eez.month

SELECT	DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        vi.flag_id,
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id=s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = COALESCE(:year,YEAR(logdate))
AND		s_activity_id = 1
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY DATEPART(YEAR, s.logdate),DATEPART(MONTH,s.logdate),s.eez_code,vi.flag_id

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        c.sp_code,
        vi.flag_id,
        SUM(COALESCE(c.sp_mt_est,c.sp_mt)) catch into #catch
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id=s.log_trip_id
        JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = COALESCE(:year,year(logdate))
AND		s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity))
AND		c.sp_code IN ('SKJ','YFT','BET')
GROUP BY DATEPART(YEAR, s.logdate),DATEPART(MONTH,s.logdate),s.eez_code, c.sp_code,vi.flag_id

SELECT  e.year, e.month, e.eez_code, c.sp_code,e.flag_id,c.catch/nullif(e.nb_days,0) CPUE, e.nb_days, c.catch, 'Month / Fleet / EEZ' raising_factor into #cpue
FROM    #effort e JOIN #catch c ON e.eez_code = c.eez_code AND e.year = c.year AND e.flag_id = c.flag_id AND e.month = c.month

SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor INTO #missing_catch
FROM    #missing_trip JOIN #cpue c ON #missing_trip.flag_id = c.flag_id AND #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days >= 100 
AND     c.sp_code IN ('SKJ','YFT','BET')

/*-------------------*/

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        vi.flag_id,
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_1
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id=s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate)=COALESCE(:year,year(logdate))
AND     s_activity_id=1
GROUP BY DATEPART(YEAR, s.logdate),DATEPART(MONTH,s.logdate),vi.flag_id

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        c.sp_code,
        vi.flag_id,
        SUM(COALESCE(c.sp_mt_est,c.sp_mt)) catch INTO #catch_raised_1
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id=s.log_trip_id
        JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = COALESCE(:year,YEAR(logdate))
AND     c.sp_code IN ('SKJ','YFT','BET')
GROUP BY DATEPART(YEAR, s.logdate),DATEPART(MONTH,s.logdate),c.sp_code,vi.flag_id

SELECT  e.year, e.month, c.sp_code,e.flag_id,c.catch/e.nb_days CPUE, e.nb_days, c.catch, 'MONTH / Fleet' raising_factor into #cpue_raised_1
FROM    #effort_raised_1 e JOIN #catch_raised_1 c ON e.year = c.year AND e.flag_id = c.flag_id AND e.month = c.month

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM	#missing_trip JOIN #cpue_raised_1 c ON #missing_trip.flag_id = c.flag_id AND #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days >= 100 
AND     c.sp_code IN ('SKJ','YFT','BET')
AND NOT EXISTS (
    SELECT  1
    FROM    #missing_catch temp
    WHERE   temp.year =  #missing_trip.year
    AND     temp.flag_id = #missing_trip.flag_id
    AND     temp.month = #missing_trip.month
)

/*-------------------*/

SELECT  e.year, e.month, c.sp_code, SUM(c.catch)/SUM(e.nb_days) CPUE, 'MONTH' raising_factor into #cpue_raised_2
FROM    #effort_raised_1 e JOIN #catch_raised_1 c ON e.year = c.year AND e.flag_id = c.flag_id AND e.month = c.month
GROUP BY e.year, e.month, c.sp_code

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM    #missing_trip JOIN #cpue_raised_2 c ON #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE	c.sp_code IN ('SKJ','YFT','BET')
AND NOT EXISTS (
    SELECT  1
    FROM    #missing_catch temp
    WHERE   temp.year =  #missing_trip.year
    AND     temp.flag_id = #missing_trip.flag_id
    AND     temp.month = #missing_trip.month
)

SELECT  COALESCE(c.year,mc.year) year,COALESCE(c.flag_id,mc.flag_id) flag_id,  COALESCE(c.sp_code,mc.sp_code) sp_code, CONVERT(DECIMAL(8,2),SUM(COALESCE(c.catch,0))) log_c, CONVERT(DECIMAL(8,2),SUM(COALESCE(mc.sp_mt,0))) vms_c, SUM(COALESCE(mc.day_fishing,0)) vms_missing_days into #final
FROM    #catch c FULL OUTER JOIN #missing_catch mc ON c.flag_id=mc.flag_id AND c.year = mc.year AND c.month = mc.month AND c.sp_code = mc.sp_code
GROUP BY COALESCE(c.year,mc.year),COALESCE(c.flag_id,mc.flag_id), COALESCE(c.sp_code,mc.sp_code)

SELECT  f.year, f.flag_id,sp_code,log_c+vms_c tot_c,SUM(COALESCE(e.nb_days,0)) nb_days,vms_missing_days INTO #final2
FROM    #final f LEFT OUTER JOIN #effort e ON e.flag_id = f.flag_id AND e.year=f.year
GROUP BY f.year, f.flag_id,sp_code,log_c, vms_c, vms_missing_days  SELECT 	:group_by,sp_code,SUM(tot_c) tot_c, CONVERT(DECIMAL(5,2),SUM(nb_days)*100/(SUM(nb_days)+SUM(vms_missing_days))) log_cov
FROM 	#final2
WHERE 	COALESCE(:flag_code,flag_id)=flag_id
GROUP BY :group_by,sp_code","Year"
"17","522493c3-8ebd-4afa-a9c4-79544515c53c","PURSE SEINE - Missing Logsheets in WCPFC Area - NATIONAL FLEET ","year",NA,"Logsheets,VMS",NA,"Live","2.1.1",3057,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Purseseine, CoverageMissingData, RegionalReporting","2025-06-04T11:10:17.037","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT  DISTINCT t.vms_trip_id
    FROM	log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
            INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
                  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
            )
	) t 

SELECT  vi.vesselname vessel_name,vi.flag_rg_id,vi.flag_id flag_code,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing INTO #temp
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
        LEFT OUTER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		LEFT OUTER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='S'
AND		COALESCE(:year, eez.year)=eez.year
GROUP BY vi.vesselname,vi.flag_rg_id,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name

SELECT *
FROM #temp
WHERE @@entity = 'HIVE' OR flag_code = @@entity",NA
"18","c8b04a88-2681-4028-a9e6-16ff46340197"," LONGLINE-  logsheet Coverage in EEZ - SUMMARY","year",NA,"Logsheets,VMS",NA,NA,"1.2.7",3075,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData, MyEEZ","2023-10-06T11:13:40.79","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND		ve.gear='L'
and     exists(
select 1 from tufman2.licence_info 
where (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) 
and (@@entity = 'HIVE' OR instance_source = ref.GetBitFromEntity(@@entity))))
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		l_activity_id=1
AND	(@@entity = 'HIVE' OR S.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id select COALESCE(mt.year,e.year) year, CONVERT(DECIMAL(5,2),sum(COALESCE(nb_days,0))*100/sum((COALESCE(nb_days,0)+COALESCE(day_fishing,0)))) cov
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year
group by COALESCE(mt.year,e.year)",NA
"19","3e1246da-6b0f-4ac5-9a37-2fbd0504211a"," LONGLINE - Catch by North/South pacific ocean area - By Flag","flag_code, year","BY FLAG - All Species Catch and Effort for WCPFC Area","Logsheets",NA,NA,"41",3083,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, AllSpecies","2025-07-16T10:45:37.367"," SELECT  v.flag_id flag_code, 
		case when right(lat,1) = 'N' then 'NPAC' else 'SPAC' end as area,
		sp.sp_name, 
                sp.sp_code,
		cast(Sum(case when coalesce(sp_kg_est,0) > coalesce(sp_kg,0) then coalesce(sp_kg_est,0) else coalesce(sp_kg,0) end *1.000) / 1000				as decimal(8,3))	AS metric_tonnes
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					join log.catch_ll c on s.log_set_id = c.log_set_id 
					join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.depart_date BETWEEN v.start_date AND v.calculated_end_date
					join ref.species sp on c.sp_code = sp.sp_code
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and v.flag_id	= coalesce(:flag_code,v.flag_id)
  and ref.GetLonD360fromLon(lon) > 115 and ref.GetLonD360fromLon(lon) < 285 
group by v.flag_id,
		case when right(lat,1) = 'N' then 'NPAC' else 'SPAC' end,
		sp.sp_name, sp.sp_code",NA
"20","67e0b5dd-6dbc-4dd9-af27-a314604b2f9b"," ARTISANAL - FAD Total catches per fishing method","year",NA,"Artisanal",NA,NA,"4.3.1",3091,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:19:58.623"," SELECT	:group_by,f.fad_name, l.landing_site_name, c.sp_code,tr.value_en, SUM(COALESCE(c.sp_kg,0)) tot_catch
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY :group_by,f.fad_name, l.landing_site_name, c.sp_code,tr.value_en","Year"
"21","20cec630-c83b-4f04-af01-81363550ca3a"," LONGLINE - Unloading (port, flag, destination) - BY FLAG","flag_code, year",NA,"Port",NA,NA,"32",3099,"andrewh@spc.int","andrewh@spc.int","Unloading, Longline, Tuna","2023-09-14T13:49:45.113","SELECT
	YEAR(up.unload_startdate) Year, 
	MONTH(up.unload_startdate) Month, 
	up.port_id,
	COUNT(DISTINCT up.vessel_id) vessels into #vessels
FROM unload2.unloadings up JOIN ref.vessels v ON v.vessel_id = up.vessel_id
JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
WHERE
	COALESCE(:year, YEAR(up.unload_startdate)) = YEAR(up.unload_startdate)
	AND	COALESCE(:flag_code, vi.flag_id) = vi.flag_id
AND v.gear = 'L'
GROUP BY YEAR(up.unload_startdate), MONTH(up.unload_startdate), up.port_id
ORDER BY YEAR(up.unload_startdate), MONTH(up.unload_startdate) SELECT 
	t1.Year,
	t1.Month,
	t1.vessels,
	:group_by,
	Sum(case sp_code when 'SKJ' then sp_kg else 000.0 end) as SKJ,
	Sum(case sp_code when 'YFT' then sp_kg else 000.0 end) as YFT,
	Sum(case sp_code when 'BET' then sp_kg else 000.0 end) as BET,
	Sum(case sp_code when 'ALB' then sp_kg else 000.0 end) as ALB,
	Sum(case when sp_code not in ('SKJ','YFT','BET','ALB') then sp_kg else 000.0 end) as Other
FROM (
    SELECT 
		src.*, 
		#vessels.vessels
    FROM (
        SELECT COALESCE(p.port_name, 'UNKNOWN') port_name, 
		up.port_id,
		dest_code,
		vi.vesselname vesselname,
		vi.flag_id,
		YEAR(up.unload_startdate) Year,
		MONTH(up.unload_startdate) Month,
		sp_code,
		SUM(sp_kg) / 1000 sp_kg
        FROM
			unload2.unloadings up LEFT OUTER JOIN ref.ports p ON p.port_id = up.port_id 
            JOIN ref.vessels v ON v.vessel_id = up.vessel_id
            JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
            JOIN unload2.unloading_catch upc ON up.unload_id = upc.unload_id
		WHERE COALESCE(:year,YEAR(up.unload_startdate)) = YEAR(up.unload_startdate)
		AND COALESCE(:flag_code, vi.flag_id) = vi.flag_id
AND v.gear = 'L'
        GROUP BY port_name, up.port_id, dest_code, vesselname, flag_id, YEAR(up.unload_startdate), MONTH(up.unload_startdate), sp_code
    	) src
	JOIN #vessels ON src.Year = #vessels.Year AND src.Month = #vessels.Month and src.port_id = #vessels.port_id
	) t1
GROUP BY Year, Month, :group_by, vessels","Port-Flag"
"22","320074f7-84cf-45dd-a3a8-c063733daf96"," ARTISANAL - DUMP - All fishing activity data","","Full artisanal vessel activity log data","Artisanal",NA,"Live","6.1",3110,"andrewh@spc.int","emmanuels@spc.int","Artisanal","2025-09-22T11:42:15.943","  SELECT ls.[landing_site_name]
	  ,CONVERT(VARCHAR(10),[activity_date],103) as activity_date
	  ,DATENAME(dw,[activity_date]) as day
      ,[start_time]
      ,[end_time]
      ,[motor_vessels_n]
      ,[paddle_vessels_n]
      ,[sail_vessels_n]      
  FROM art2.fishing_activity_log val
  inner join art2.landing_sites ls ON val.landing_site_id = ls.landing_site_id",NA
"23","c579f4d4-6364-37de-6657-3a16e910eb1a","OLLO SSI Bycatch Summary","year, trip_id","OLLO SSI Bycatch Summary","Observer",NA,"Observer",NA,3571,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2024-12-18T10:42:41.147","SELECT  
		ot.obstrip_id, ot.obsprg_code,vesselname,flag_id,staff_code,'T'+tripno as tripno,ot.dep_date,
		sp.sp_cat_code,
		sp.sp_name,
		lc.sp_code,
		sum(case when fate_code = 'DPA' then 0001 else 0000 end) as DPA,
		sum(case when fate_code = 'DPD' then 0001 else 0000 end) as DPD,
		sum(case when fate_code = 'DPU' then 0001 else 0000 end) as DPU,
		sum(case when fate_code = 'DFR' then 0001 else 0000 end) as DFR,
		sum(case when fate_code = 'DCF' or fate_code = 'DSO'then 0001 else 0000 end) as DCF,
		sum(case when fate_code = 'DUS' then 0001 else 0000 end) as DUS,
		sum(case when left(fate_code,1) = 'D' and fate_code not in ('DPA','DPD','DPU','DFR','DUS','DCF','DSO') then 0001 else 0000 end) as DOR,
		sum(case when fate_code = 'RWW' then 0001 else 0000 end) as RWW,
		sum(case when fate_code = 'RCC' then 0001 else 0000 end) as RCC,
		sum(case when fate_code = 'RFR' then 0001 else 0000 end) as RFR,
		sum(case when left(fate_code,1) = 'R' and fate_code not in ('RWW','RCC','RFR') then 0001 else 0000 end) as ROR,
		gr_interact_code
FROM obsv.trip ot 
     INNER JOIN ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
     INNER JOIN obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
     INNER JOIN obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
     INNER JOIN ref.species sp on lc.sp_code = sp.sp_code
	 INNER JOIN ref.field_staff f on f.staff_id = ot.observer_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
AND ot.system_source = 'Ollo'
AND sp.sp_cat_code in ('TTX','SHK','MAM','BRD','RAY')
GROUP BY ot.obstrip_id, ot.obsprg_code,vesselname,flag_id,staff_code,tripno,ot.dep_date,sp.sp_name,lc.sp_code,flag_id,sp.sp_cat_code,gr_interact_code",NA
"24","4a22f5fa-e0b1-479e-857d-9dad807826dc"," LONGLINE -  Unloadings vs Logsheet Catch Comparison","year","Built for FJ fisheries, compares logsheet catch to unloadings catch","Logsheets,Port",NA,NA,"45",3136,"andrewh@spc.int","andrewh@spc.int","Logsheet, Unloading, Longline, Custom, Tuna","2023-08-28T14:51:01.887","WITH #logcatch AS (
	SELECT vi.vesselname,
		vi.flag_id,
		CONVERT(nvarchar,t.depart_date,111) depart_date,
		CONVERT(nvarchar,t.return_date,111) return_date,
		p.port_name,
		CAST(SUM(CASE c.sp_code WHEN 'ALB' THEN sp_kg_est ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS log_alb_mt,
		CAST(SUM(CASE c.sp_code WHEN 'YFT' THEN sp_kg_est ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS log_yft_mt, 
		CAST(SUM(CASE c.sp_code WHEN 'BET' THEN sp_kg_est ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS log_bet_mt,
		CAST(SUM(sp_kg_est) /1000.0 AS DECIMAL(7,2)) AS log_tot_mt,
		t.log_trip_id LonglineLogsheetDTO,
		l.dto_guid_right LonglineUnloadingDTO
	FROM log.trips_ll t LEFT JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO' AND l.dto_type_right='UnloadingDTO'
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
		JOIN log.sets_ll s ON s.log_trip_id = t.log_trip_id
		JOIN ref.ports p ON p.port_id = t.return_port_id
		LEFT JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
	WHERE COALESCE(:year,YEAR(t.depart_date)) = YEAR(t.depart_date)
GROUP BY vesselname, flag_id, depart_date, return_date, t.log_trip_id, l.dto_guid_right, p.port_name),
	#unlcatch AS (SELECT unl.unload_id,
		CAST(SUM(CASE c.sp_code WHEN 'ALB' THEN sp_kg ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS unl_alb_mt,
		CAST(SUM(CASE c.sp_code WHEN 'YFT' THEN sp_kg ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS unl_yft_mt, 
		CAST(SUM(CASE c.sp_code WHEN 'BET' THEN sp_kg ELSE 000.0 END) / 1000 AS DECIMAL(7,2)) AS unl_bet_mt,
		cast(SUM(sp_kg) /1000.0 AS DECIMAL(7,2)) AS unl_tot_mt
	FROM unload2.unloadings unl JOIN unload2.unloading_catch c ON c.unload_id = unl.unload_id
	GROUP BY unl.unload_id)

SELECT vesselname vessel_name,
	flag_id flag_code,
	depart_date,
	return_date,
	port_name return_port,
	l.LonglineLogsheetDTO,
	l.LonglineUnloadingDTO,
	log_tot_mt,
	unl_tot_mt,
	CONVERT(DECIMAL(5,2), (CASE SIGN(log_tot_mt - unl_tot_mt) WHEN -1 THEN ((unl_tot_mt - log_tot_mt) / unl_tot_mt * 100) WHEN 1 THEN 0 - ((log_tot_mt - unl_tot_mt) / log_tot_mt * 100) ELSE 0 END)) AS diff_tot_percent,
	log_alb_mt,
	unl_alb_mt,
	CONVERT(DECIMAL(5,2), (CASE SIGN(log_alb_mt - unl_alb_mt) WHEN -1 THEN ((unl_alb_mt - log_alb_mt) / unl_alb_mt * 100) WHEN 1 THEN 0 - ((log_alb_mt - unl_alb_mt) / log_tot_mt * 100) ELSE 0 END)) AS diff_alb_percent,
	log_yft_mt,
	unl_yft_mt,
	CONVERT(DECIMAL(5,2), (CASE SIGN(log_yft_mt - unl_yft_mt) WHEN -1 THEN ((unl_yft_mt - log_yft_mt) / unl_yft_mt * 100) WHEN 1 THEN 0 - ((log_yft_mt - unl_yft_mt) / log_yft_mt * 100) ELSE 0 END)) AS diff_yft_percent,
	log_bet_mt,
	unl_bet_mt,
	CONVERT(DECIMAL(5,2), (CASE SIGN(log_bet_mt - unl_bet_mt) WHEN -1 THEN ((unl_bet_mt - log_bet_mt) / unl_bet_mt * 100) WHEN 1 THEN 0 - ((log_bet_mt - unl_bet_mt) / log_bet_mt * 100) ELSE 0 END)) AS diff_bet_percent
FROM	#logcatch l full JOIN #unlcatch u ON l.LonglineUnloadingDTO = u.unload_id
WHERE	log_tot_mt IS NOT NULL 
AND		unl_tot_mt IS NOT NULL ",NA
"25","a12a606b-a9ae-46da-865f-a6e300b22309"," LONGLINE Observer Trip -- SSI Bycatch Summary","trip_id","A Summary of Species of Special Interest (SSI) Bycatch information from the selected LONGLINE observer trip","Observer",NA,"Observer","21",3145,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-01T14:38:43.193"," SELECT  sp.sp_name,
		lc.sp_code,
		sum(case when fate_code = 'DPA' then 0001 else 0000 end) as DPA,
		sum(case when fate_code = 'DPD' then 0001 else 0000 end) as DPD,
		sum(case when fate_code = 'DPU' then 0001 else 0000 end) as DPU,
		sum(case when fate_code = 'DFR' then 0001 else 0000 end) as DFR,
		sum(case when fate_code = 'DCF' or fate_code = 'DSO'then 0001 else 0000 end) as DCF,
		sum(case when fate_code = 'DUS' then 0001 else 0000 end) as DUS,
		sum(case when left(fate_code,1) = 'D' and fate_code not in ('DPA','DPD','DPU','DFR','DUS','DCF','DSO') then 0001 else 0000 end) as DOR,
		sum(case when fate_code = 'RWW' then 0001 else 0000 end) as RWW,
		sum(case when fate_code = 'RCC' then 0001 else 0000 end) as RCC,
		sum(case when fate_code = 'RFR' then 0001 else 0000 end) as RFR,
		sum(case when left(fate_code,1) = 'R' and fate_code not in ('RWW','RCC','RFR') then 0001 else 0000 end) as ROR
FROM    obsv.trip ot 
            inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
            inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join ref.field_staff f on f.staff_id=ot.observer_id
WHERE LEFT(:trip_id,3)=RTRIM(staff_code) and RIGHT(:trip_id,5)=tripno
  and sp.sp_cat_code in ('TTX','SHK','MAM','BRD')
group by sp.sp_name,lc.sp_code",NA
"26","8d2b6167-e2c5-a73e-8437-3a1a884a4088","Species catch summary by year","","Species catch summary by year","",NA,"Observer",NA,3584,"eparamal@spc.int","eparamal@spc.int","Longline, Emonitoring","2025-06-16T11:41:54.697","WITH CatchData AS (
    SELECT 	
        lc.sp_code,
        YEAR(ls.set_date) as catch_year,
        COUNT(*) as catch_count  -- or use SUM(lc.wt_est) if you want weight totals
    FROM em.trip et 
        INNER JOIN ref.vessel_instances v ON et.vessel_id = v.vessel_id 
            AND et.dep_date BETWEEN v.start_date AND v.calculated_end_date
        INNER JOIN em.l_set ls ON et.obstrip_id = ls.obstrip_id 
        INNER JOIN em.l_setcatch lc ON ls.l_set_id = lc.l_set_id
        INNER JOIN ref.species sp ON lc.sp_code = sp.sp_code 
        LEFT JOIN ref.field_staff st ON st.staff_id = et.observer_id
        INNER JOIN ref.ports dp ON dp.port_id = et.dep_port_id
        INNER JOIN ref.ports rp ON rp.port_id = et.ret_port_id
    WHERE et.obsprg_code = 'fjem'
    GROUP BY lc.sp_code, YEAR(ls.set_date)
),
PivotData AS (
    SELECT 
        sp_code,
        ISNULL([2015], 0) AS [2015],
        ISNULL([2016], 0) AS [2016], 
        ISNULL([2017], 0) AS [2017],
        ISNULL([2018], 0) AS [2018],
        ISNULL([2019], 0) AS [2019],
        ISNULL([2021], 0) AS [2021],
        ISNULL([2022], 0) AS [2022]
    FROM (
        SELECT sp_code, catch_year, catch_count
        FROM CatchData
    ) AS SourceTable
    PIVOT (
        SUM(catch_count)
        FOR catch_year IN ([2015], [2016], [2017], [2018], [2019], [2021], [2022])
    ) AS PivotTable
)
SELECT 
    sp_code AS [Species Code],
    [2015],
    [2016],
    [2017], 
    [2018],
    [2019],
    [2021],
    [2022]--,
    --([2015] + [2016] + [2017] + [2018] + [2019] + [2021] + [2022]) AS [Grand Total]
FROM PivotData",NA
"27","a438b78e-14f8-4cbd-9784-a70c0087f794","LONGLINE - Logsheet coverage - SUMMARY - NATIONAL FLEET ","year","National fleet Longline logsheet coverage - SUMMARY","Logsheets,VMS",NA,NA,"2.2.4",3153,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, CoverageMissingData, RegionalReporting","2025-04-14T08:22:55.257","SELECT  vi.flag_id,eez.year,COUNT(DISTINCT t.vms_trip_id) as trips,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
        INNER JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)
WHERE	t.vms_trip_id NOT IN (SELECT      distinct t.vms_trip_id
								FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
								INNER JOIN log.sets_ll s on l.log_trip_id = s.log_trip_id
								INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
								(l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
								OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
								OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
								OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate)
								WHERE ref.PositionInWCPFC(s.latd,s.lond) = 1)
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND 	COALESCE(:year, eez.year) between YEAR(vi.start_date) and YEAR(vi.calculated_end_date)
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		ve.gear='L'
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		l_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		ref.PositionInWCPFC(s.latd,s.lond) = 1
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id 

SELECT	COALESCE(mt.year,e.year) year,
	COALESCE(mt.flag_id,e.flag_id) flag_code,
	CONVERT(INT,COALESCE(trips,0)) vms_trips,
	CONVERT(DECIMAL(10,2),COALESCE(nb_days,0)*100/(COALESCE(day_fishing,0)+COALESCE(nb_days,0))) cov,
	COALESCE(nb_days,0) log_days,
	CONVERT(INT,COALESCE(day_fishing,0)) vms_days
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year",NA
"28","2221e811-3fc9-46c6-b8cd-a72c00960e96"," ARTISANAL - Vessel number of trips and hours fished","year","Total hours fished per vessel per month, and the number of trips","Artisanal",NA,NA,"2.1",3161,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, ByVessel, CoverageMissingData","2021-10-06T16:18:14.37","
 select	:group_by,
		v.vessel_name,
		COUNT (distinct t.art_trip_id) as num_of_trips,
		SUM(e.hours_fished_n) as hours_fished
from	art2.trips t inner join art2.effort e ON t.art_trip_id=e.art_trip_id
		inner join art2.landing_sites ls ON t.landing_site_id = ls.landing_site_id
		inner join art2.vessels v on v.vessel_id = t.vessel_id
where	year(trip_date) = coalesce(:year, year(trip_date))
group by :group_by,v.vessel_name","Year"
"29","7f335dc4-2e28-4cf1-903c-a74d0112956c"," LONGLINE -- WCPFC key species catch and discard/release used to produce estimate for Part 1 Report","flag_code, year",NA,"Observer",NA,"Observer","31",3170,"andrewh@spc.int","shaazreenb@spc.int","Observer, Longline","2025-07-14T12:55:13.54","DECLARE @sp_code nvarchar(90)
DECLARE @sp_name char(3)
DECLARE @sp_list nvarchar(90)
DECLARE @cnt_0 int

set @sp_list = 'ALBBETPBFSKJYFTBLMBUMMLSSWOSFASSPBSHFALHAMMAKOCSPORRHNTHR'
set @cnt_0 = 1

If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

If(OBJECT_ID('tempdb..#temp_d2') Is Not Null)
Begin
    Drop Table #temp_d2
End

create table #temp_d2 (
	sp_name char(3),
	trips	int,
	days	int,
	No_Ret_days	int,
	No_Disc_days int,
	No_Ret	int,
	Kgs_Ret	decimal(19,8),
	No_Disc int,
	kgs_Disc decimal(19,8),
	AVG_No_Ret	decimal(19,8),
	AVG_Kgs_Ret decimal(19,8),
	AVG_No_Disc	decimal(19,8),
	AVG_kgs_Disc decimal(19,8),
	AVG_D_No_Ret	decimal(19,8),
	AVG_D_Kgs_Ret decimal(19,8),
	AVG_D_No_Disc	decimal(19,8),
	AVG_D_kgs_Disc decimal(19,8))

while @cnt_0 < 20
begin

	set @sp_name = substring(@sp_list,(@cnt_0-1)*3+1,3)
	
	if @sp_name = 'THR' 
		set @sp_code = 'BTH,PTH,THR,ALV'
	if @sp_name = 'MAK' 
		set @sp_code = 'MAK,LMA,SMA'
	if @sp_name = 'HAM' 
		set @sp_code = 'SPK,SPL,SPN,SPQ,SPZ'
	if @sp_name <> 'HAM' and @sp_name <> 'MAK' and @sp_name <> 'THR' 
		set @sp_code = @sp_name

If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

SELECT     
    ot.obstrip_id,
    ls.l_set_id,

    sum(
        case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R'
             then cast(cast(splw.lenwt_a as decimal(38,8)) * 
                       power(cast(
                           case when len is null or len < 20 then 
                                case when sp.sp_cat_code = 'SHK' then 150 
                                     when sp.sp_cat_code = 'BIL' then 150
                                     else 100 end
                           else len end
                       as decimal(38,8)), cast(splw.lenwt_b as float))
             as decimal(38,8))
             else 0.0 
        end
    ) as kgs_ret,

    sum(
        case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' and coalesce(cond_code2,'XX') not in ('A1')
             then cast(cast(splw.lenwt_a as decimal(38,8)) * 
                       power(cast(
                           case when len is null or len < 20 then 
                                case when sp.sp_cat_code = 'SHK' then 150 
                                     when sp.sp_cat_code = 'BIL' then 150
                                     else 100 end
                           else len end
                       as decimal(38,8)), cast(splw.lenwt_b as float))
             as decimal(38,8))
             else 0.0 
        end
    ) as kgs_disc,

    sum(cast(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then 1.0 else 0.0 end as decimal(38,8))) as No_ret,
    sum(cast(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' and coalesce(cond_code2,'XX') not in ('A1') then 1.0 else 0.0 end as decimal(38,8))) as No_disc
INTO #temp_d1
FROM    obsv.trip ot 
        inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
        inner join obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
        inner join obsv.l_sethaullog lsh on ls.l_set_id = lsh.l_set_id and lsh.stend_id = 83
        inner join obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
        inner join ref.species sp on lc.sp_code = sp.sp_code
        inner join ref.species_lenwt splw on lc.sp_code = splw.sp_id
WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
  AND flag_id = coalesce(:flag_code,flag_id)
GROUP BY ot.obstrip_id, ls.l_set_id


insert into #temp_d2
select 
	max(@sp_name) as sp_name,
	count(distinct obstrip_id) as trips,
	count(distinct l_set_id) as days,
	sum(case when No_Ret>0 then 1 else 0 end)  as No_Ret_days,
	sum(case when No_Disc>0 then 1 else 0 end) as No_Disc_days,
	sum(No_Ret)  as No_Ret,
	sum(kgs_ret) as Kgs_Ret,
	sum(No_Disc) as No_Disc,
	sum(kgs_disc) as kgs_Disc,
	cast(sum(No_Ret) as decimal(19,8)) / nullif(cast(count(distinct obstrip_id) as decimal(19,8)),0) as AVG_No_Ret,
	cast(sum(kgs_ret) as decimal(19,8)) / nullif(cast(count(distinct obstrip_id) as decimal(19,8)),0) as AVG_Kgs_Ret,
	cast(sum(No_Disc) as decimal(19,8)) / nullif(cast(count(distinct obstrip_id) as decimal(19,8)),0) as AVG_No_Disc,
	cast(sum(kgs_disc) as decimal(19,8)) / nullif(cast(count(distinct obstrip_id) as decimal(19,8)),0) as AVG_kgs_Disc,
	cast(sum(No_Ret) as decimal(19,8)) / nullif(cast(count(distinct l_set_id) as decimal(19,8)),0) as AVG_D_No_Ret,
	cast(sum(kgs_ret) as decimal(19,8)) / nullif(cast(count(distinct l_set_id) as decimal(19,8)),0) as AVG_D_Kgs_Ret,
	cast(sum(No_Disc) as decimal(19,8)) / nullif(cast(count(distinct l_set_id) as decimal(19,8)),0) as AVG_D_No_Disc,
	cast(sum(kgs_disc) as decimal(19,8)) / nullif(cast(count(distinct l_set_id) as decimal(19,8)),0) as AVG_D_kgs_Disc
from #temp_d1

set @cnt_0 = @cnt_0 + 1

end

select 
	sp_name,
	trips,
	No_Ret_days,
	No_Disc_days,
	No_Ret,
	Kgs_Ret,
	No_Disc,
	kgs_Disc,
	AVG_No_Ret,
	AVG_Kgs_Ret,
	AVG_No_Disc,
	AVG_kgs_Disc,
	AVG_D_No_Ret,
	AVG_D_Kgs_Ret,
	AVG_D_No_Disc,
	AVG_D_kgs_Disc	
from #temp_d2
where sp_name is not null",NA
"30","425c42fd-d08f-4641-a61c-a79b00e13e04"," CMM 15-02 - South Pacific Albacore","","description","",NA,NA,"27",3186,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM, RegionalReporting, Tuna","2024-04-11T15:52:04.747"," select 'Addressed through the regular provision of operational catch/effort logsheet data to SPC, who automatically include these data in the WCPFC databases, as per our authorisation.' as response",NA
"31","835b25a8-99ef-4263-8276-a7bb00b9d01d"," ARTISANAL - FAD CPUE - Catch per line hour (Year)","year",NA,"Artisanal",NA,NA,"4.1.1",3202,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData","2023-03-28T11:23:53.723","SELECT	YEAR(t.trip_date) [year],f.fad_name, SUM(e.hours_fished_n * e.lines_n) effort, SUM(e.hours_fished_n) effort_hours into #t
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY YEAR(t.trip_date),f.fad_name SELECT	YEAR(t.trip_date) [year],f.fad_name, c.sp_code,CONVERT(DECIMAL(7,2),SUM(COALESCE(c.sp_kg,0))) catch,#t.effort, CONVERT(DECIMAL(6,2),SUM(COALESCE(c.sp_kg,0))/#t.effort) cpue, #t.effort_hours,  CONVERT(DECIMAL(7,2),SUM(COALESCE(c.sp_kg,0))/#t.effort_hours) cpue2
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN #t ON #t.year = YEAR(t.trip_date)  AND #t.fad_name = f.fad_name
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
		and #t.effort > 0
GROUP BY YEAR(t.trip_date),f.fad_name, c.sp_code, #t.effort,#t.effort_hours",NA
"32","a150b774-a135-4e2f-aa52-a7cd0061ff41"," PURSE SEINE - Observer Effort","min_year",NA,"Observer",NA,"Observer","99",3210,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2025-08-18T13:39:40.603"," SELECT     
        year(act_date) as yr, vesselname,
		flag_id as flag,
		count(*) as Obsv_sets
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
WHERE YEAR(act_date) >= :min_year and s_activ_id = 1
GROUP BY  year(act_date),vesselname,
		flag_id",NA
"33","c648df03-570f-42c0-bba9-a81200e9d602"," Species composition for a paired trip: E-Monitoring vs Logbook vs Port sampling","trip_id","Species composition for a paired trip: E-Monitoring vs Logbook vs Port sampling.
 NOTE: You will need to enter the EM_STAFF_CODE together with the TRIPNO as the Observer Trip Id without any space character between them in the box provided below eg 'xxx17-01'","Logsheets,Port",1,"Observer","7b",3220,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, PortSampling, Longline, Emonitoring","2024-10-17T11:22:59.307","IF OBJECT_ID('tempdb.dbo.#temp_EMLOG_1', 'U') IS NOT NULL
	DROP TABLE #temp_EMLOG_1;

SELECT sp.sp_name collate database_default AS sp_name
	,lc.sp_code collate database_default AS sp_code
	,sum(0001) AS obs_reported
	,SUM(0000) AS log_reported
	,SUM(0000) AS prt_reported
INTO #temp_EMLOG_1
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	AND et.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.port.samples pl ON pl.vessel_id = et.vessel_id
	AND pl.sample_date BETWEEN et.ret_date-1
		AND et.ret_date + 2
INNER JOIN em.l_set ls ON et.obstrip_id = ls.obstrip_id
INNER JOIN em.l_setcatch lc ON ls.l_set_id = lc.l_set_id
INNER JOIN ref.species sp ON lc.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY obstrip_key
	,sp.sp_name
	,lc.sp_code

UNION

SELECT sp.sp_name collate database_default AS sp_name
	,sp.sp_code collate database_default AS sp_code
	,SUM(0000) AS obs_reported
	,sum(coalesce(sp_n, 0000)) AS log_reported
	,SUM(0000) AS prt_reported
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	AND et.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.port.samples pl ON pl.vessel_id = et.vessel_id
	AND pl.sample_date BETWEEN et.ret_date-1 AND et.ret_date + 2
INNER JOIN tufman2_dorado.log.sets_ll s ON lt.log_trip_id = s.log_trip_id
INNER JOIN tufman2_dorado.log.catch_ll c ON c.log_set_id = s.log_set_id
INNER JOIN tufman2_dorado.ref.species sp ON c.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name
	,sp.sp_code

UNION

SELECT sp.sp_name collate database_default AS sp_name
	,sp.sp_code collate database_default AS sp_code
	,SUM(0000) AS obs_reported
	,sum(0000) AS log_reported
	,SUM(samples_n) AS prt_reported
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	AND et.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.port.samples pl ON pl.vessel_id = et.vessel_id
	AND pl.sample_date BETWEEN et.ret_date AND et.ret_date + 3
INNER JOIN tufman2_dorado.port.sample_tot c ON c.sample_id = pl.sample_id
INNER JOIN tufman2_dorado.ref.species sp ON c.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name
	,sp.sp_code; SELECT sp_name
	,sp_code
	,sum(obs_reported) AS em_reported
	,sum(log_reported) AS log_reported
	,sum(prt_reported) AS prt_reported
FROM #temp_EMLOG_1
GROUP BY sp_name
	,sp_code",NA
"34","5d554e98-d2c0-4cd6-825a-a82600fc2f64"," LONGLINE - Species Catch composition chart (ER) - DRAFT","year","Species compostion for ER (ONBOARD mainly) longline trips imported into TUFMAN2","Logsheets",1,NA,"4b",3228,"andrewh@spc.int","brunod@spc.int","Logsheet, Ereporting, AllSpecies","2021-10-11T15:57:48.443","SELECT  sp.sp_name, 
		sp.sp_code,
		SUM(0000) as em_reported,
    sum(case when t.system_source='onboard' then coalesce(sp_n,0000) else 0 end) as ER_reported
INTO #t1
FROM   tufman2.log.trips_ll t 
		INNER JOIN tufman2.log.sets_ll s    ON t.log_trip_id = s.log_trip_id
		INNER JOIN tufman2.log.catch_ll c   ON c.log_set_id = s.log_set_id
		INNER JOIN tufman2.ref.species sp on c.sp_code = sp.sp_code 
WHERE  year(first_logdate) = COALESCE(:year, year(first_logdate))
group by sp.sp_name,sp.sp_code

 select 
	sp_name, 
	sp_code,
	sum(ER_reported) as ER_nb
from #t1
group by sp_name, sp_code",NA
"35","7c05f88f-f6be-475a-88dd-a8900093a56c","LONGLINE - Vessel catch with lat/long - BY SET - HIDDEN as double of 2521657c-b6ee-4ab0-94e3-bf3d5a2984d4 ","eez_code, flag_code, year","BY FLAG - VESSEL Catch By Set","Logsheets",NA,NA,"14b",3236,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline","2022-09-20T16:04:32.053"," SELECT  vi.flag_id flag_code, 
		vi.vesselname vessel_name, 
		s.logdate,
		s.lat,		
		s.lon,
		ref.GetLatDfromLat(s.lat) latd,
		ref.GetLonDfromLon(s.lon) lond,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000 				as decimal(5,2))	AS alb_mt,  
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n,  
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000 				as decimal(5,2))	AS bet_mt, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n,  
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000				as decimal(5,2))	AS yft_mt, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 000.0 when 'BE0' then 0 else sp_kg_est end)/1000 as decimal(5,2)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BE0' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(5,2)) 	AS tot_mt, 
		cast(Sum(sp_n_est)         															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(s.logdate) = coalesce(:year, year(s.logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
  and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
group by vi.flag_id, vi.vesselname, s.logdate,s.lat,s.lon",NA
"36","c999d8a2-2049-43a0-b702-a8a8010d0bbd"," PURSE SEINE -- SSI Length Reports from PS-4 form","flag_code, year",NA,"Observer",NA,"Observer","11c",3244,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2021-12-15T15:43:26.49"," SELECT   
		ot.obstrip_id,
        ot.gear_code as gear,
        v.flag_id as flag,
        YEAR(sa.act_date) as trip_year,
        fs.family_name as obsv_family_name,
        fs.first_name as obsv_first_name,
        ot.tripno as observer_trip_id,
        v.vesselname as vessel_name, 
        cast(sa.act_date as date) as date, 
		set_number,
        coalesce(sa.lat,'-') as lat, 
        coalesce(sa.lon,'-') as lon,
        coalesce(sa.eez_code,'-') as eez_code, 
        'PS-4' as form,
        sp.sp_cat_code as sp_cat_cod,
        sp.sp_code as sp_code,
        sp.sp_name as species,
        coalesce(lfm.len,'-') as len,
		coalesce(lfm.sex_code,'-') as sex_code
FROM    obsv.trip ot
                inner join  obsv.s_day sd on ot.obstrip_id = sd.obstrip_id
                inner join  obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
                inner join  obsv.s_set ss on ss.s_daylog_id = sa.s_daylog_id
                inner join  obsv.s_lf lf on ss.s_set_id = lf.s_set_id
				inner join  obsv.s_lfmeas lfm on lfm.s_lf_id = lf.s_lf_id
                inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                inner join ref.species sp on lfm.sp_code = sp.sp_code
                inner join ref.field_staff fs on fs.staff_id = ot.observer_id
                left outer join ref_static.ps_school_associations ids on ids.schas_id = sa.schas_id
WHERE YEAR(sa.act_date) = coalesce(:year,YEAR(sa.act_date))  
AND flag_id = coalesce(:flag_code,flag_id)
AND sp_cat_code in ('MAM','SHK','TTX','BRD')
AND ot.gear_code = 'S'",NA
"37","56ec59a9-6ff4-697b-e03f-3a1cc9324347","Aircraft and Vessel Sightings by Observer Trip (GEN-1)  by Year - Detail","min_year, max_year","Aircraft and Vessel Sightings by Observer Trip (GEN-1) by Year - Detail","Observer",NA,"Live",NA,3596,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Purseseine","2025-10-06T16:01:40.9","SELECT t.obsprg_code AS obsprg_code,
 DATEPART(yyyy,t.dep_date) AS trip_year,
 t.obstrip_id AS obstrip_id,
 staff_code AS staff_code,
 'T'+t.tripno AS tripno,
 t.gear_code as gear_code,
 CONVERT(VARCHAR, t.dep_date, 106) as depart_date,
 CONVERT(VARCHAR, t.ret_date, 106) as return_date,
CONVERT(VARCHAR,s.sighting_date, 106) as sighting_date, 
s.sighting_time as sighting_time,
s.latd as latd,
s.lond as lond,
s.eez_code as eez_code,
v.vesselname as vesselname,
COALESCE(v.ircs,'-') as ircs,
v.flag_rg_id as flag,
s.vatyp_id as activity_id,
COALESCE(s.bearing_dir,0) as bearing_direction,
COALESCE(s.distance,0) as distance,
COALESCE(c.sighting_desc,'-') as sighting_desc,
COALESCE(photo_number,'-') as photo_number,
s.comments as comments

FROM obsv.gen1sightings s 
INNER JOIN obsv.trip t ON s.obstrip_id = t.obstrip_id
INNER JOIN ref.vessel_instances v on s.vessel_id = v.vessel_id and s.sighting_date between v.start_date and v.calculated_end_date
INNER JOIN ref.field_staff f on f.staff_id=t.observer_id
INNER JOIN ref_static.gen1_sighting_codes c on s.action_code = c.sighting_code
WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) AND YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))

GROUP BY t.dep_date,t.ret_date,t.obsprg_code, t.gear_code,t.obstrip_id,staff_code,t.tripno,
s.sighting_date,s.sighting_time,s.latd,s.lond,s.eez_code,v.vesselname,v.ircs,v.flag_rg_id,s.vatyp_id,s.bearing_dir,
s.distance,c.sighting_desc,s.photo_number, s.comments;",NA
"38","390b941c-3ec6-4bbd-b66a-a8f600e112c7"," TAILS in app report - Total catches","staff_code","Total catch in last 12 months of top five species per landing site","Artisanal",NA,NA,"98.2",3260,"andrewh@spc.int","andrewh@spc.int","API","2021-10-13T12:07:51.347","SELECT TOP 1 WITH TIES landing_site_name,sp_code,sp_kg into #t
FROM (
	SELECT	l.landing_site_name,c.sp_code + ' - ' + s.sp_name sp_code, SUM(c.sp_kg) sp_kg 
	FROM    art2.trips t JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
			JOIN art2.catch c ON c.art_effort_id = e.art_effort_id
			JOIN ref.species s ON s.sp_code = c.sp_code
			JOIN art2.landing_sites l ON l.landing_site_id=t.landing_site_id
	WHERE   t.entered_by=:staff_code
	AND		DATEDIFF(MONTH,t.trip_date, CURRENT_TIMESTAMP)<13
	GROUP BY l.landing_site_name,c.sp_code + ' - ' + s.sp_name
) t
ORDER BY
	CASE WHEN ROW_NUMBER() OVER (PARTITION BY landing_site_name ORDER BY sp_kg DESC)<=5
		THEN 0
		ELSE 1
	END; 
 select landing_site_name,sp_code,sp_kg from #t",NA
"39","57b8f500-6966-43ee-9f15-a92200d7aabd"," LONGLINE - Effort - MAP","flag_code, year","MAP -- LONGLINE Effort by FLEET","Logsheets",2,NA,"21a",3268,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, MyEEZ","2021-10-06T10:53:31.43"," SELECT  :group_by, 
		Sum(coalesce(hooks_n,0))			AS hooks
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by :group_by","Latitude5Longitude5"
"40","c2e3fba6-e28b-4567-8698-a95b01147654"," LONGLINE - Vessel trip catch report - BY FLAG","flag_code, year","BY FLAG - VESSEL TRIP Catch Report","Logsheets",NA,NA,"13b",3277,"andrewh@spc.int","benoitp@spc.int","Logsheet, Longline, MyEEZ, Tuna","2025-06-05T14:57:49.857"," select	vi.flag_id flag_country_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,  
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) as decimal (9,2))   AS alb_kg,
		cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 000.0 end) as decimal (9,2))   AS skj_kg,
		cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) as decimal (9,2))  AS bet_kg, 
		cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end)  as decimal (9,2))    AS yft_kg,
                cast(Sum(case when sp_code NOT IN ('ALB', 'SKJ', 'BET', 'YFT') then sp_kg_est else 000.0 end) as decimal (9,2)) AS oth_kg
from	log.trips_ll t JOIN log.sets_ll s on t.log_trip_id = s.log_trip_id
		JOIN  log.catch_ll c on s.log_set_id = c.log_set_id 
		JOIN ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate)",NA
"41","810e5e62-93dc-4ac1-9ace-a99100a335fd"," PURSE SEINE - Annual VESSEL catch/effort report - BY EEZ","eez_code, year",NA,"Logsheets",NA,NA,"101",3285,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Purseseine, ByVessel","2025-10-02T18:05:53.467","SELECT  z1.vesselname,
		z1.flag_id,
		YEAR(z1.logdate) as year,
		z1.eez_code as EEZ, 
		SUM(1.00 * z1.eez_days / z2.eezs) as eez_days
into #t1
FROM
(SELECT 	distinct vi.vesselname, 
				vi.flag_id,
				s.logdate,
				s.eez_code, 
				1 as eez_days
		FROM	log.trips_ps t 
				INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
				INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id
		WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
			AND		( COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
			and s_activity_id in (1,2)	) z1 inner join 
(SELECT 	vi.vesselname,
			vi.flag_id,
			s.logdate,
			count(distinct s.eez_code) as eezs
		FROM	log.trips_ps t 
				INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
				INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id
		WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
				and s_activity_id in (1,2)
		GROUP BY vi.vesselname, vi.flag_id,s.logdate) z2 on z1.vesselname = z2.vesselname and z1.logdate = z2.logdate
group by z1.vesselname,
		z1.flag_id,
		YEAR(z1.logdate),
		z1.eez_code	
		
SELECT eez_code as EEZ,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate) as year,
		count(*) as sets
into #t2
FROM	log.trips_ps t 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id
WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
		AND		(COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
		and s_activity_id in (1)
GROUP BY 
		eez_code,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate)
		
SELECT eez_code as EEZ,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate) as year,
		sum(case when sp_code = 'SKJ' then COALESCE(c.sp_mt_est,0) else 0000.000 end) as skj_c,
		sum(case when sp_code = 'YFT' then COALESCE(c.sp_mt_est,0) else 0000.000 end) as yft_c,
		sum(case when sp_code = 'BET' then COALESCE(c.sp_mt_est,0) else 0000.000 end) as bet_c,
		sum(case when sp_code in ('SKJ','YFT','BET') then 0000.000 else COALESCE(c.sp_mt_est,0) end) as oth_c
into #t3
FROM	log.trips_ps t 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id
        INNER JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
		AND		(COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
		and s_activity_id in (1)
GROUP BY 
		eez_code,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate)
 SELECT	#t1.EEZ as EEZ,
		#t1.vesselname as vessel_name, 
		#t1.flag_id as flag_code,
		#t1.year as year,
		#t1.eez_days as days,
		sum(coalesce(#t2.sets,0)) as sets,
		sum(coalesce(#t3.skj_c,000)) as skj_c,
		sum(coalesce(#t3.yft_c,000)) as yft_c,
		sum(coalesce(#t3.bet_c,000)) as bet_c,
		sum(coalesce(#t3.oth_c,000)) as oth_c
FROM	#t1 left outer join #t2 on #t2.vesselname = #t1.vesselname and #t2.year = #t1.year and #t2.EEZ = #t1.EEZ
			left outer join #t3 on #t2.EEZ = #t3.EEZ and #t2.vesselname = #t3.vesselname and #t2.flag_id = #t3.flag_id and #t2.year = #t3.year
GROUP BY 
		#t1.EEZ,
		#t1.vesselname, 
		#t1.flag_id,
		#t1.year,
		#t1.eez_days",NA
"42","6159a5f2-dd82-4b39-8ee5-a9ad00c0440a"," Gear and Effort summary","year",NA,"",NA,"Observer","2",3291,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Emonitoring","2025-10-21T10:10:53.683"," SELECT staff_code
	,tripno
	,vesselname
	,obsprg_code
	,CONVERT(VARCHAR(10), dep_date, 103) AS dep_date
	,CONVERT(VARCHAR(10), ret_date, 103) AS ret_date
	,convert(VARCHAR(10), MIN(set_date), 103) AS start_set_date
	,convert(VARCHAR(10), MAX(set_date), 103) AS end_set_date
	,DATEDIFF(DAY, dep_date, ret_date) + 1 AS tripdays
	,DATEDIFF(DAY, MIN(set_date), MAX(set_date)) + 1 AS setdays
	,count(DISTINCT l_set_id) AS sets_obs
	,SUM(cast(bask_set AS INT)) AS bask
	,SUM(cast(hook_set AS INT)) AS hook_set
	,MIN(hk_bt_flt) AS min_HBF
	,MAX(hk_bt_flt) AS max_HBF
	,AVG(hk_bt_flt) AS avg_HBF
	,MIN(bask_observed) AS min_bask
	,MAX(bask_observed) AS max_bask
	,AVG(bask_observed) AS avg_bask
	,MIN(hook_set) AS min_hooks
	,MAX(hook_set) AS max_hooks
	,AVG(hook_set) AS avg_hooks
FROM em.trip et
INNER JOIN ref.vessel_instances v ON et.vessel_id = v.vessel_id   
and et.dep_date between v.start_date and v.calculated_end_date 
INNER JOIN em.[l_set] l ON et.obstrip_id = l.obstrip_id
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE right(et.obsprg_code, 2) = 'EM'
	AND COALESCE(:year, year(dep_date)) = year(dep_date)
GROUP BY staff_code
	,tripno
	,vesselname
	,obsprg_code
	,dep_date
	,ret_date",NA
"43","5e2828a9-dfe0-473e-99f7-a9f100f3b80e"," Annual Aggregate Species composition - EM vs Logbook","year",NA,"Logsheets",1,"Observer","4c",3295,"andrewh@spc.int","brunod@spc.int","Logsheet, Observer, Longline, Emonitoring","2024-11-19T11:34:52.993"," Select COALESCE(x.sp_name,z.sp_name) COLLATE DATABASE_DEFAULT as sp_name,
	COALESCE(x.sp_code,z.sp_code) COLLATE DATABASE_DEFAULT  as sp_code, 
	x.EM_count,
	z.LOG_count from 
	(
		select sp.sp_name,
			sc.sp_code, 
			count(sc.sp_code) as EM_count
		from em.trip et
		inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
				and et.dep_date between vi.start_date and vi.calculated_end_date
		inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
				and et.dep_date between lt.depart_date and lt.return_date+2
		inner join em.l_set s on et.obstrip_id=s.obstrip_id
		inner join em.l_setcatch sc on sc.l_set_id=s.l_set_id
		inner join ref.species sp on sp.sp_code=sc.sp_code
		inner join ref.countries rc on rc.country_code=vi.flag_id COLLATE DATABASE_DEFAULT
		where coalesce(:year,year(et.dep_date))=year(et.dep_date)
		group by sc.sp_code, sp.sp_name

	) x
FULL OUTER JOIN 
	(
		select sp.sp_name,
			sc.sp_code, 
			sum(coalesce(sc.spdiscard_n + sc.sp_n,sc.sp_n + 0)) as LOG_count
		from em.trip et
		inner join tufman2_dorado.ref.vessel_instances vi on vi.vessel_id=et.vessel_id
				and et.dep_date between vi.start_date and vi.calculated_end_date
		inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
				and et.dep_date between lt.depart_date and lt.return_date
		inner join tufman2_dorado.log.sets_ll s on s.log_trip_id=lt.log_trip_id
		inner join tufman2_dorado.log.catch_ll sc on sc.log_set_id=s.log_set_id
		inner join tufman2_dorado.ref.species sp on sp.sp_code=sc.sp_code
		where coalesce(:year,year(et.dep_date))=year(et.dep_date)
		group by sc.sp_code, sp.sp_name
	) z on z.sp_code=x.sp_code",NA
"44","8d0d1536-35cd-42a3-a502-a8a8011b33f9"," SSI Sightings Reports from GEN-2 form by YEAR and FLAG","flag_code, year",NA,"Observer",NA,"Observer","11a",3245,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2023-02-03T08:56:43.953"," SELECT 
ot.obstrip_id,
ot.gear_code as gear,
v.flag_id as flag,
year(ot.dep_date) as trip_year,
f.family_name as obsv_family_name,
f.first_name as obsv_first_name,
ot.tripno as observer_trip_id,
v.vesselname as vessel_name,
g2.sighting_date as date,
coalesce(g2.lat,'-') as lat,
coalesce(g2.lon,'-') as lon,
coalesce(g2.eez_code,'-') as eez_code,
'GEN2' as form,
sp.sp_cat_code as sp_cat_code,
sp.sp_code as sp_code,
sp.sp_name as species,
coalesce(g2.species_desc,'-') as [desc],
'SIGHTING' as type,
g2.total_n as number,
case vessel_activity when 73 then 'Setting'
	when 74 then 'Hauling'
	when 75 then 'Searching'
	when 76 then 'Transiting'
	when 77 then 'Other' end as vess_act_interaction,
g2.adults_n as sight_adults,
g2.juveniles_n as sight_juveniles,
coalesce(g2.sighting_len,'-') as sight_length,
g2.dist_from_vessel as sight_distance,
coalesce(g2.sighting_code,'-') as sighting_code,
CASE g2.sighting_code 
	WHEN 'SDS' then 'Distance swimming'
	WHEN 'SBR' then 'Breaching'
	WHEN 'STP' then 'Tail slapping or playing'
	WHEN 'SMG' then 'Motionless in group'
	WHEN 'SDW' then 'Dead in water'
	WHEN 'SBO' then 'Bird overhead'
	WHEN 'OTH' then 'Other'
	ELSE '-' END as sighting_code_desc,
coalesce(g2.behaviour_desc,'-') as sight_behavior
FROM obsv.trip ot 
join obsv.gen2sightings g2 on ot.obstrip_id = g2.obstrip_id 
join ref.vessel_instances v on v.vessel_id = ot.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join ref.species sp on sp.sp_code = g2.sp_code
where sp_cat_code in ('MAM','SHK','TTX','BRD') and
YEAR(sighting_date) = coalesce(:year,year(sighting_date)) 
    AND flag_id = coalesce(:flag_code,flag_id)",NA
"45","d5d15632-3872-464f-9669-aa2a00ea640a"," - List of NATIONAL FLEET Vessels (Flag of Registration and Charters) - based on VMS or fishing activity","year",NA,"Logsheets,VMS",NA,NA,"0",3305,"andrewh@spc.int","brunod@spc.int","Logsheet, ByVessel, RegionalReporting","2023-04-20T10:05:44.35"," SELECT DISTINCT g.[gear_desc]
      ,vin.[vesselname]
      ,[flag_id]
      ,[flag_rg_id]
	  ,grt
      ,case when flag_id <> flag_rg_id then 'CHARTERED' else 'FLAG of REGISTRATION' end as status
      ,[start_date]
      ,[end_date]
      ,vin.calculated_end_date
      ,[ffa_vid]
      ,[uvi]
	  ,case when coalesce(x.wcpfc,0) > 0 then 'Y' else 'N' end as wcpfc
	  ,case when coalesce(x.iattc,0) > 0 then 'Y' else 'N' end as iattc
      ,LEFT(v.[vessel_id],38) as VesselDTO
  FROM [ref].[vessels] v
			inner join [ref].[vessel_instances] vin on v.vessel_id = vin.vessel_id
			inner join [ref].[gears] g on v.gear = g.gear_code
			left outer join vms.vms_trips vms on v.vessel_id = vms.vessel_id
			left outer join 
				(select vin.vesselname,
						sum(case when eez_code = 'IW'  then 0001 else 0000 end) as iattc,
						sum(case when eez_code <> 'IW' then 0001 else 0000 end) as wcpfc
				from vms.vms_trips vms 
						inner join vms.vms_trip_efforts e on vms.vms_trip_id = e.vms_trip_id
						inner join [ref].[vessel_instances] vin on vms.vessel_id = vin.vessel_id
				where year(vms.departure_date) = coalesce(:year, year(vms.departure_date))
      					AND (@@entity = 'HIVE' OR vin.flag_id = @@entity)
						and day_fishing > 0
				group by vin.vesselname) x on x.vesselname = vin.[vesselname]
			left outer join log.trips_ll lt on v.vessel_id = lt.vessel_id and (YEAR(lt.first_logdate) = coalesce(:year, YEAR(lt.first_logdate)) or YEAR(lt.last_logdate) = coalesce(:year, YEAR(lt.last_logdate)))
			left outer join log.trips_ps st on v.vessel_id = st.vessel_id and YEAR(st.first_logdate) = coalesce(:year, YEAR(st.first_logdate))
  WHERE   coalesce(v.is_active,0) = 1
      AND (@@entity = 'HIVE' OR vin.flag_id = @@entity)
      AND year(vin.start_date) <= coalesce(:year, year(vin.start_date))
      AND year(vin.calculated_end_date) >= coalesce(:year, year(vin.calculated_end_date))
	  AND (
			year(vms.departure_date) = coalesce(:year, year(vms.departure_date)) or 
			year(lt.first_logdate) = coalesce(:year, year(lt.first_logdate)) or 
			year(st.first_logdate) = coalesce(:year, year(st.first_logdate)) )",NA
"46","3a5e036b-b5a7-4542-b9b5-aa460090d210"," PURSE SEINE - Activity Log by YEAR","flag_code, min_year, max_year",NA,"Observer",NA,"Observer","62",3308,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-12-01T11:06:29.023"," SELECT 	distinct vesselname,
		flag_id as flag, 
               YEAR(dep_date) as trip_year, 
               MONTH(dep_date) as trip_month, 
		cast(convert( char(8), dep_date,112) as char(8)) as dep_date, 
		cast(convert( char(8), ret_date,112) as char(8)) as ret_date,
		cast(convert( char(8), act_date,112) as char(8)) as logdate, 
		act_time,
		sa.s_activ_id as activity_code, 
		r2.activity_desc as activity, 
		r1.school_association_desc as set_type, 
		r.detection_desc as detection, 
		beacon, 
		payao, 
		lat, 
		lon, 
		eez_code,
		case when sa.s_activ_id = 1 then act_time end as start_set,
		s.stop_time
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left join obsv.s_set s on s.s_daylog_id = sa.s_daylog_id
				left join ref_static.ps_activities r2 on r2.s_activ_id = sa.s_activ_id
				left join ref_static.ps_school_associations r1 on r1.schas_id = sa.schas_id
				left join ref_static.ps_detection_codes r on r.deton_id = sa.deton_id
WHERE YEAR(act_date) >= coalesce(:min_year,year(act_date)) and YEAR(act_date) <= coalesce(:max_year,year(act_date)) and flag_id = coalesce(:flag_code,flag_id)",NA
"47","8b2df6e7-afc2-4ac2-910b-aa4f00abf0b8"," PURSE SEINE - VESSEL TRIP Catch Report -BY FLAG -- (Date Selection)","flag_code, date_from, date_to",NA,"Logsheets",NA,"Live","13d",3311,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2025-08-20T15:27:13.56"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		s.eez_code as eez,
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + convert(nvarchar(10),logdate,103)) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then (cast(s.log_trip_id as varchar(50)) + convert(nvarchar(10),logdate,103)) else null end) as fish_days,
        Sum(case when c.sp_code = 'SKJ' and c.discard = 0 then c.sp_mt_est else 000.0 end)   AS skj_mt_ret,
        Sum(case when c.sp_code = 'BET' and c.discard = 0 then c.sp_mt_est else 000.0 end)  AS bet_mt_ret, 
        Sum(case when c.sp_code = 'YFT' and c.discard = 0 then c.sp_mt_est else 000.0 end)    AS yft_mt_ret,
        Sum(case when c.sp_code = 'SKJ' and c.discard = 1 then c.sp_mt_est else 000.0 end)   AS skj_mt_disc,
        Sum(case when c.sp_code = 'BET' and c.discard = 1 then c.sp_mt_est else 000.0 end)  AS bet_mt_disc, 
        Sum(case when c.sp_code = 'YFT' and c.discard = 1 then c.sp_mt_est else 000.0 end)    AS yft_mt_disc,
		Sum(case when nsc.sp_code = 'SKJ' then c.sp_mt_est else 000.0 end)   AS skj_mt_net_share,
        Sum(case when nsc.sp_code = 'BET' then c.sp_mt_est else 000.0 end)  AS bet_mt_net_share, 
        Sum(case when nsc.sp_code = 'YFT' then c.sp_mt_est else 000.0 end)    AS yft_mt_net_share
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		left outer join log.net_share_catch nsc on nsc.log_set_id = s.log_set_id
where   
		logdate >= :date_from
and 	logdate <= :date_to 
and		COALESCE(:flag_code,vi.flag_id) =vi.flag_id
AND	(@@entity = 'HIVE' OR s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id,s.eez_code",NA
"48","f4c6a9d3-1c2c-4538-a95a-aa7900f52cc3"," CMM 18-03 (table z) LL Seabird Interactions","flag_code, year","Table Z for seabird interactions","Observer",NA,"Observer","14c",3314,"andrewh@spc.int","andrewh@spc.int","Observer, Longline, CMM, RegionalReporting, ByCatch","2021-10-06T10:54:11.493"," SELECT         
       YEAR(sc.catch_date) as year,
       sp.sp_name as species,
    cast(SUM(case when latd < -30 then 1 else 0 end) as int) as birds_below_30S,
    cast(SUM(case when latd < -25 and latd >= -30 then 1 else 0 end) as int) as birds_between_25and30S,
	cast(SUM(case when latd <= 23 and latd >= -25 then 1 else 0 end) as int) as birds_between_23N_and_25S,
cast(SUM(case when latd > 23 then 1 else 0 end) as int) as birds_above_23N,    
    count(*) as total_number
FROM    obsv.trip ot 
                inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id 
                inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83 
                inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
                inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))
AND ot.gear_code = 'L'
AND flag_id = coalesce(:flag_code,flag_id)
AND sp.sp_cat_code = 'BRD'
group by YEAR(sc.catch_date), sp.sp_name",NA
"49","06a0103a-5547-4e4b-9a48-aa7e008ead1e"," CMM 18-03 (Table x) LL Seabird Interactions","flag_code","Table X for 18-03","Observer",NA,"Observer","14a",3317,"andrewh@spc.int","benoitp@spc.int","Observer, Longline, CMM, RegionalReporting, ByCatch","2025-10-15T14:11:26.28"," SELECT year(set_date) as year,
	'Enter vessel count here' as total_vessels,
	'Enter your total hooks here' as total_hooks,
	SUM(HOOK_OBSERVED) as hooks_observed,
	'enter your percentage here' as perc_hooks_observed,
	SUM(coalesce(sc.brd_no,0)) as brd_no,
	SUM(coalesce(sc.brd_no,0))*1.0/SUM(HOOK_OBSERVED)*1000 as capture_rate,
	SUM( case when latd < -30 then sc.brd_no else 0 end) as south_of_30s,
	SUM(case when latd > 23  then sc.brd_no else 0 end) as north_of_23n,
	SUM(case when latd between -30 and -25  then sc.brd_no else 0 end) as between_25s_30s,
	SUM(case when latd between -25 and 23 then sc.brd_no else 0 end) as between_25s_23n
 FROM    obsv.trip ot 
         JOIN obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
		 JOIN ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
		 LEFT JOIN (
			SELECT sc.l_set_id,latd,count(*) brd_no from obsv.l_setcatch sc
			JOIN ref.species sp on sc.sp_code = sp.sp_code
			JOIN obsv.l_set l on l.l_set_id = sc.l_set_id
			join obsv.l_sethaullog sh on sh.l_set_id = l.l_set_id and stend_id=83
			WHERE sp_cat_code = 'BRD'
			GROUP BY sc.l_set_id,latd) sc on sc.l_set_id = ls.l_set_id
WHERE year(set_date)>=2014 AND flag_id = coalesce(:flag_code,flag_id)
GROUP BY year(set_date)",NA
"50","bcc72187-19ae-42da-bd18-aa9500a661ee"," LONGLINE SSI Bycatch Summary (Year)","flag_code, year","A Summary of Species of Special Interest (SSI) Bycatch information by year","Observer",NA,"Observer","24",3320,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2025-07-15T12:30:24.13"," SELECT  
		YEAR(ls.set_date) yr,
		flag_id flag,
		sp.sp_cat_code,
		sp.sp_name,
		lc.sp_code,
		sum(case when fate_code = 'DPA' then 0001 else 0000 end) as DPA,
		sum(case when fate_code = 'DPD' then 0001 else 0000 end) as DPD,
		sum(case when fate_code = 'DPU' then 0001 else 0000 end) as DPU,
		sum(case when fate_code = 'DFR' then 0001 else 0000 end) as DFR,
		sum(case when fate_code = 'DCF' or fate_code = 'DSO'then 0001 else 0000 end) as DCF,
		sum(case when fate_code = 'DUS' then 0001 else 0000 end) as DUS,
		sum(case when left(fate_code,1) = 'D' and fate_code not in ('DPA','DPD','DPU','DFR','DUS','DCF','DSO') then 0001 else 0000 end) as DOR,
		sum(case when fate_code = 'RWW' then 0001 else 0000 end) as RWW,
		sum(case when fate_code = 'RCC' then 0001 else 0000 end) as RCC,
		sum(case when fate_code = 'RFR' then 0001 else 0000 end) as RFR,
		sum(case when left(fate_code,1) = 'R' and fate_code not in ('RWW','RCC','RFR') then 0001 else 0000 end) as ROR,
		gr_interact_code
FROM    obsv.trip ot 
            inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
            inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
            inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
WHERE YEAR(ls.set_date) = coalesce(:year,YEAR(ls.set_date))  
	AND flag_id = coalesce(:flag_code,flag_id)
  and sp.sp_cat_code in ('TTX','SHK','MAM','BRD','RAY')
group by sp.sp_name,lc.sp_code,flag_id,YEAR(ls.set_date),sp.sp_cat_code,gr_interact_code",NA
"51","25ee82c4-faab-45f0-8149-a94900a1847e"," CMM 2016-01 para. 18 - Purse seine FAD sets on the high seas -- (vessel reported; unraised)","flag_code, year",NA,"Logsheets",NA,NA,"41",3274,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CMM, Raised, RegionalReporting, Unraised","2021-12-15T15:58:33.227"," SELECT  vi.flag_id as flag,
        vi.vesselname as vessel,
		CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
		eez_code,
        school_id as sch_id
FROM    log.trips_ps trip_ps 
            inner join ref.vessel_instances vi 
                    on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND school_id in (3,4,5,6,7)
		and eez_code in ('I1','I2','I3','I4','I5','I6','I7','I8','I9','H4','H5')
		and ref.GetLonD360fromLon(lon) > 115 and ref.GetLonD360fromLon(lon) < 229 
  		and not (ref.GetLatDfromLat(lat) > -4 and  ref.GetLonD360fromLon(lon) > 210)",NA
"52","e0871507-2bdb-4a2f-8838-aac600f85cf8"," Total Catch by species by Month","year","Total Catch by species","Logsheets",NA,NA,"8",3323,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ","2023-10-12T13:51:11.55"," select

	v.vesselname vessel_name,
	month(s.logdate) month,
	Year(s.logdate) year,
	sum(s.hooks_n) as Tot_hks,
	c.sp_code,
	sp.sp_name,
	sum(c.sp_kg) as Tot_kg,
	sum(c.sp_n) as Tot_no

from log.trips_ds t


	join log.sets_ds S on t.log_trip_id = S.log_trip_id

	join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.species sp on c.sp_code = sp.sp_code

	join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date

where Year(s.logdate) = :year
	AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))

Group by v.vesselname, 
	month(s.logdate),
	Year(s.logdate),
		c.sp_code, sp.sp_name",NA
"53","d2951c88-4467-4a56-8e80-a95e00df1b84"," PURSE SEINE - VESSEL TRIP Catch Report - BY FLAG","flag_code, year",NA,"Logsheets",NA,NA,"13c",3278,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2021-10-07T15:04:30.487"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		s.eez_code as eez,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as int)   AS skj_mt,
		cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as int)  AS bet_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end)  as int)    AS yft_mt
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		inner join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id,s.eez_code",NA
"54","cc7442f9-71d3-4449-afbe-a8a2010778fe"," List of EM trips with corresponding Observer and Logbook data","year",NA,"Logsheets,Observer",NA,"Observer","5a",3241,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Longline, Emonitoring","2024-10-17T11:22:54.227"," select distinct vi.vesselname as VESSEL_NAME,
		et.obsprg_code as PROG_CODE,
		st.staff_code as EM_STAFF_CODE, 
		('trip@'+et.TRIPNO) AS TRIPNO, 
		CONVERT(VARCHAR(10),et.dep_date,103) as EM_DEP_DATE, 
		CONVERT(VARCHAR(10),et.ret_date,103) as EM_RET_DATE, 
		CONVERT(VARCHAR(10),ot.dep_date,103) as OBS_DEP_DATE, 
		CONVERT(VARCHAR(10), ot.ret_date,103) AS OBS_RET_DATE, 
		CONVERT(VARCHAR(10), lt.depart_date,103) as LOG_DEP_DATE, 
		CONVERT(VARCHAR(10), lt.return_date,103) AS LOG_RET_DATE
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
		AND et.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
		and et.dep_date between ot.dep_date and ot.ret_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
		AND lt.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
		and et.dep_date between lt.depart_date and lt.return_date
inner join ref.field_staff st on st.staff_id=et.observer_id
where COALESCE(:year,year(et.dep_date)) = year(et.dep_date)",NA
"55","d74e39f6-1fa7-4515-8d81-a7bb00baec24"," ARTISANAL - NON FAD CPUE - Catch per line hour (Year)","year",NA,"Artisanal",NA,NA,"4.2.1",3203,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:19:47.76","SELECT	YEAR(t.trip_date) [year],a.art_area_name, SUM(e.hours_fished_n * e.lines_n) effort into #t
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.areas a ON a.art_area_id = e.art_area_id
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY YEAR(t.trip_date),a.art_area_name SELECT	YEAR(t.trip_date) [year],a.art_area_name, c.sp_code,CONVERT(DECIMAL(7,2),SUM(COALESCE(c.sp_kg,0))) catch,#t.effort, CONVERT(DECIMAL(7,2),SUM(COALESCE(c.sp_kg,0))/#t.effort) cpue
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.areas a ON a.art_area_id = e.art_area_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN #t ON #t.year = YEAR(t.trip_date)  AND #t.art_area_name = a.art_area_name
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
		and #t.effort > 0
GROUP BY YEAR(t.trip_date),a.art_area_name, c.sp_code, #t.effort",NA
"56","31b21634-0a80-4ad0-a75d-a7c8008f9e6f"," Species Composition for a paired trip: E-Monitoring vs Observer","trip_id","Species Composition for a paired trip: E-Monitoring vs Observer.
NOTE: You will need to enter the EM_STAFF_CODE together with the TRIPNO as the Observer Trip Id without any space character between them in the box provided below eg 'xxx17-01'","Observer",1,"Observer","3b",3207,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T08:37:01.307","IF OBJECT_ID('tempdb.dbo.#temp_EMOB_1', 'U') IS NOT NULL
	DROP TABLE #temp_EMOB_1;

SELECT sp.sp_name
	,sc.sp_code COLLATE DATABASE_DEFAULT AS sp_code
	,sum(1) AS n_ob
	,sum(000000) AS n_em
	,sum(CASE 
			WHEN LEFT(fate_code, 1) = 'R'
				THEN 0001
			ELSE 0000
			END) AS ret_ob
	,sum(000000) AS ret_em
	,sum(CASE 
			WHEN LEFT(fate_code, 1) = 'D'
				THEN 0001
			ELSE 0000
			END) AS disc_ob
	,sum(000000) AS disc_em
INTO #temp_EMOB_1
FROM obsv.trip ot
INNER JOIN obsv.l_set ls ON ls.obstrip_id = ot.obstrip_id
INNER JOIN obsv.l_setcatch sc ON sc.l_set_id = ls.l_set_id
INNER JOIN ref.species sp ON sp.sp_code COLLATE DATABASE_DEFAULT = sc.sp_code
INNER JOIN ref.vessel_instances vs ON ot.vessel_id = vs.vessel_id
	AND ot.dep_date BETWEEN vs.[start_date]
		AND vs.[calculated_end_date]
INNER JOIN em.trip et ON et.vessel_id=vs.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name
	,sc.sp_code

UNION

SELECT sp_name
	,sc.sp_code
	,sum(000000) AS n_ob
	,sum(1) AS n_em
	,sum(000000) AS ret_ob
	,sum(CASE 
			WHEN LEFT(fate_code, 1) = 'R'
				THEN 0001
			ELSE 0000
			END) AS ret_em
	,sum(000000) AS disc_ob
	,sum(CASE 
			WHEN LEFT(fate_code, 1) = 'D'
				THEN 0001
			ELSE 0000
			END) AS disc_em
FROM em.trip et
INNER JOIN ref.vessel_instances v ON et.vessel_id = v.vessel_id
	AND et.dep_date BETWEEN v.start_date
		AND v.calculated_end_date
INNER JOIN em.[l_set] l ON et.obstrip_id = l.obstrip_id
INNER JOIN em.[l_setcatch] sc ON sc.l_set_id = l.l_set_id
INNER JOIN ref.species sp ON sc.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
inner join obsv.trip ot on ot.vessel_id=v.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp_name
	,sc.sp_code SELECT sp_name
	,sp_code
	,sum(n_em) AS n_em
	,sum(n_ob) AS n_ob
	,sum(ret_em) AS ret_em
	,sum(ret_ob) AS ret_ob
	,sum(disc_em) AS disc_em
	,sum(disc_ob) AS disc_ob
FROM #temp_EMOB_1
GROUP BY sp_name
	,sp_code",NA
"57","22d5a3b1-f15a-45b1-9141-a97d0081417d"," Number of logsheet trips/sets entered per DCT during a given year/period, by various grouping","year, gear_code, date_from, date_to","Lists the number of trips entered per DCT for a given year of entry or period, vith various grouping","Logsheets",NA,NA,"5",3282,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, PoleAndLine, Purseseine, MyFleet","2021-12-16T11:37:01.503"," Select
				CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END as instance,
				'L' as gr,
				:group_by,
				t.assigned_to as dct,
				count(distinct t.log_trip_id) as nbtrips,
				sum(1) as nbsets
from log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
where COALESCE(:year,YEAR(T.changed_date)) = YEAR(T.changed_date) AND
			COALESCE(:year,YEAR(T.entered_date)) = YEAR(T.entered_date) and 
			COALESCE(:date_from,T.entered_date) <= T.entered_date and
			COALESCE(:date_to,T.entered_date) >= T.entered_date and
			COALESCE(:gear_code,'L')='L' and
			system_source= 'Tufman2'
         and instance_source = ref.GetBitFromEntity(@@entity)
group by 
        CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END,
				:group_by,
				t.assigned_to
UNION
select 
        CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END as instance,
				'PS' as gr,
				:group_by,
				t.assigned_to as dct,
				count(distinct t.log_trip_id) as nbtrips,
				sum(1) as nbsets
from log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
where COALESCE(:year,YEAR(T.changed_date)) = YEAR(T.changed_date) AND
			COALESCE(:year,YEAR(T.entered_date)) = YEAR(T.entered_date) and 
			COALESCE(:date_from,T.entered_date) <= T.entered_date and
			COALESCE(:date_to,T.entered_date) >= T.entered_date and
			COALESCE(:gear_code,'S')='S' and
			system_source= 'Tufman2'
         and instance_source = ref.GetBitFromEntity(@@entity)
group by 
        CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END,
				:group_by,
				t.assigned_to
UNION
select 
        CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END as instance,
				'PL' as gr,
				:group_by,
				t.assigned_to as dct,
				count(distinct t.log_trip_id) as nbtrips,
				sum(1) as nbsets
from log.trips_pl t inner join log.sets_pl s on t.log_trip_id = s.log_trip_id 
where COALESCE(:year,YEAR(T.changed_date)) = YEAR(T.changed_date) AND
			COALESCE(:year,YEAR(T.entered_date)) = YEAR(T.entered_date) and 
			COALESCE(:date_from,T.entered_date) <= T.entered_date and
			COALESCE(:date_to,T.entered_date) >= T.entered_date and
			COALESCE(:gear_code,'P')='P' and
			system_source= 'Tufman2'
         and instance_source = ref.GetBitFromEntity(@@entity)
group by 
        CASE 
            WHEN t.instance_source=2 THEN 'OFP' 
            ELSE 'CTY'
        END,
				:group_by,
				t.assigned_to","Year"
"58","f08dbfe8-39bb-4a01-be57-d570cb19b36b"," ARTISANAL - FAD List - Historical and Active","","A list of all FADs, past and present with locations for importing into your favourite GIS tool","Artisanal",NA,NA,"35",3123,"andrewh@spc.int","andrewh@spc.int","Artisanal, DataQuality","2021-10-07T16:04:11.433"," Select distinct (f.deployment_date) as deployment_date,
	(case when (f.lost_date IS null) then 1 else 0 end) as active,
	(case when (f.lost_date IS null) then 0 else 1 end) as lost,
        (f.lost_date) as lost_date, 
	f.fad_name,
	f.island,
	a.art_area_name,
	f.lat,
	f.lon,
	tp.value_en as fad_type,
	tm.value_en as fad_design,
	f.deployment_depth,
	f.shore_distance,
	f.comments
from art2.fad_register f 
	left outer join art2.areas a on a.art_area_id = f.area_id
	left outer join tuf2.translations tp ON tp.translation_key = 'LookupList_ArtisanalFadTypes' + CONVERT(VARCHAR,f.fad_type_id)
	left outer join tuf2.translations tm ON tm.translation_key = 'LookupList_ArtisanalFadDesigns' + CONVERT(VARCHAR,f.fad_design_id)
where f.visibility & (SELECT ref.GetBitFromEntity(@@entity)) <> 0",NA
"59","9a95337a-c6c4-4919-bcfe-40399db4fa9d"," ARTISANAL - Total catch per FAD","year",NA,"Artisanal",NA,NA,"3.1",3088,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:19:36.913"," SELECT	:group_by,f.fad_name, l.landing_site_name, c.sp_code, SUM(COALESCE(c.sp_kg,0)) sp_kg, SUM(COALESCE(c.sp_n,0)) sp_n
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
WHERE	COALESCE(:year,YEAR(trip_date))=YEAR(trip_date)
GROUP BY :group_by,f.fad_name, l.landing_site_name, c.sp_code","Year"
"60","ed018ac2-1087-47a0-8b57-ee3b501c7adf"," ARTISANAL - FAD Number of events per fishing method","year","A quick check of number of trips per FAD to validate the FADs are being fished and recorded properly","Artisanal",NA,NA,"4.3.2",3092,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, DataQuality","2021-10-12T15:35:51.123"," SELECT	:group_by,f.fad_name, l.landing_site_name,e.fish_method_id,tr.value_en as method, COUNT(distinct e.art_effort_id) nb_efforts
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY :group_by,f.fad_name, l.landing_site_name,e.fish_method_id,tr.value_en","Year"
"61","2c5b7af8-0c32-4812-bd86-6379e1295833"," Tufman 2 - count of all pending errors by error type","","A summary of all the outstanding errors","",NA,NA,"3",3046,"andrewh@spc.int","andrewh@spc.int","MyFleet","2021-10-18T12:57:14.477"," SELECT [summary_key],
      count (1) as count
  FROM [tuf2].[check_result_lines]
  where is_accepted = 0
  	and (instance_source = ref.getBitFromEntity(@@entity) or @@entity = 'HIVE')
  group by summary_key",NA
"62","3f70bf0a-62e0-4657-8132-a6fe0104a0de"," LONGLINE - Logsheets with missing captains","min_year, max_year","All logsheets with missing captain field","Logsheets",NA,NA,"7",3146,"andrewh@spc.int","colleyf@spc.int","Logsheet, Longline, DataQuality","2025-10-09T14:39:33.947"," select vi.vesselname vessel_name,
	YEAR(t.depart_date) as year,
	t.depart_date as depart_date
from log.trips_ll t
	inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where t.captain_id is null
and YEAR(t.depart_date) >= coalesce(:min_year,year(t.depart_date)) AND YEAR(t.depart_date) <= coalesce(:max_year,year(t.depart_date))",NA
"63","428b345e-c0f1-40e0-bbcb-d5a22aef5a7c"," LONGLINE -- Shark Catches and FATE, by YEAR and EEZ","eez_code, flag_code, year","LONGLINE -- Shark Catches and FATE, by GEAR, YEAR and EEZ","Observer",NA,"Observer","12",2954,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2025-09-15T16:43:24.177"," SELECT 	DISTINCT
		'L' as gear,
		sp.sp_code as sp_code, 
		sp.sp_name as sp_name, 
		sum(1) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then 1 else 000000 end)  as Retain, 
		sum(case when coalesce(fate_code,'   ') in ('RFR')		then 1 else 000000 end)  as Finned_Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R') and coalesce(fate_code,'   ') not in ('RFR')		then 1 else 000000 end)  as Retain_OR, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then 1 else 000000 end) as Discard, 
		sum(case when coalesce(fate_code,'   ') in ('DSO')		then 1 else 000000 end)  as Discard_Struck_Off,
		sum(case when coalesce(fate_code,'   ') in ('DFR')		then 1 else 000000 end)  as Finned_Trunk_Discard,
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and coalesce(fate_code,'   ') not in ('DFR','DSO')		then 1 else 000000 end)  as Discard_OR,
		sum(case when coalesce(fate_code,'   ') in ('ESC')		then 1 else 000000 end)  as Escaped
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog lsh on ls.l_set_id = lsh.l_set_id and lsh.stend_id = 83
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
    AND sp.sp_cat_code = 'SHK' 
GROUP BY  
	sp.sp_name,
	sp.sp_code
HAVING COUNT(*) > 1",NA
"64","aa70921d-aeea-46c7-9c71-a79000db50c8"," ARTISANAL - DQ Check - Count of logsheets by vessel and data recorder for each day","year","DQ Check - Count of logsheets from each data collector and each vessel each day. Vessels can go for multiple trips in a single day, but this gives a good starting point for finding duplicate trips, as well as a total list of trips collected each day by each data collector.","Artisanal",NA,NA,"7.2",3183,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, DataQuality","2021-10-07T17:06:33.473","   SELECT YEAR(trip_date) as yy,
	MONTH(trip_date) as mm,
	DAY(trip_date) as dd,
	:group_by,
	count(1) as log_count
FROM art2.trips t                  
    left outer JOIN  art2.vessels v on v.vessel_id = t.vessel_id      
where YEAR(trip_date)=coalesce(:year,year(trip_date))
group by YEAR(trip_date), MONTH(trip_date), DAY(trip_date),:group_by","Vessel"
"65","a207d8e5-4769-4050-8c73-5257e38457d3"," ARTISANAL - DUMP - All pelagic catch/effort data","year","DUMP - Full valid catch and effort log data","Artisanal",NA,NA,"6.2",3111,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, ByVessel, Raised, Tuna","2023-03-28T11:24:14.57","   SELECT [landing_site_name],      [skipper_name], 
  convert(varchar,trip_date,111 ) as trip_date,depart_time,
  return_time, [fad_fishing], tr.value_en as fish_method_name, art_area_name,      
   max([hours_fished_n]) as hours_fished_n, max([lines_n]) as lines_n, max([fuel_used_n]) as fuel_used_n, max([fuel_type_id]) as fuel_type_id,
    max([hooks_per_line_n]) as hooks_per_line_n, max([hooks_n]) as hooks_n, 
    max([live_bait_used]) as live_bait_used,       SUM(case when sp_code = 'SKJ' then sp_n else 0000 end) as skj_n, 
    SUM(case when sp_code = 'SKJ' then sp_kg else 0000 end) as skj_kg,SUM(case when sp_code = 'YFT' then sp_n else 0000 end) as yft_n, 
    SUM(case when sp_code = 'YFT' then sp_kg else 0000 end) as yft_kg,       SUM(case when sp_code = 'BET' then sp_n else 0000 end) as bet_n, 
    SUM(case when sp_code = 'BET' then sp_kg else 0000 end) as bet_kg, SUM(case when sp_code = 'ALB' then sp_n else 0000 end) as alb_n, 
    SUM(case when sp_code = 'ALB' then sp_kg else 0000 end) as alb_kg,       SUM(case when sp_code = 'DOL' then sp_n else 0000 end) as dol_n, 
    SUM(case when sp_code = 'DOL' then sp_kg else 0000 end) as dol_kg, SUM(case when sp_code = 'DOT' then sp_n else 0000 end) as dot_n, 
    SUM(case when sp_code = 'DOT' then sp_kg else 0000 end) as dot_kg,       SUM(case when sp_code = 'KAW' then sp_n else 0000 end) as kaw_n, 
    SUM(case when sp_code = 'KAW' then sp_kg else 0000 end) as kaw_kg, SUM(case when sp_code = 'RRU' then sp_n else 0000 end) as rru_n, 
    SUM(case when sp_code = 'RRU' then sp_kg else 0000 end) as rru_kg,       SUM(case when sp_code = 'WAH' then sp_n else 0000 end) as wah_n, 
    SUM(case when sp_code = 'WAH' then sp_kg else 0000 end) as wah_kg, 
    
    SUM(case when sp_code = 'BLM' then sp_n else 0000 end) as blm_n, SUM(case when sp_code = 'BLM' then sp_kg else 0000 end) as blm_kg, 
    SUM(case when sp_code = 'BUM' then sp_n else 0000 end) as bum_n, SUM(case when sp_code = 'BUM' then sp_kg else 0000 end) as bum_kg, 
    SUM(case when sp_code = 'MLS' then sp_n else 0000 end) as mls_n, SUM(case when sp_code = 'MLS' then sp_kg else 0000 end) as mls_kg,
    SUM(case when sp_code = 'SWO' then sp_n else 0000 end) as swo_n, SUM(case when sp_code = 'SWO' then sp_kg else 0000 end) as swo_kg, 
    SUM(case when sp_code = 'SSP' then sp_n else 0000 end) as ssp_n, SUM(case when sp_code = 'SSP' then sp_kg else 0000 end) as ssp_kg, 
    SUM(case when sp_code = 'SFA' then sp_n else 0000 end) as sfa_n, SUM(case when sp_code = 'SFA' then sp_kg else 0000 end) as sfa_kg, 
    SUM(case when sp_code = 'OTH' then sp_n else 0000 end) as oth_n, SUM(case when sp_code = 'OTH' then sp_kg else 0000 end) as oth_kg,       
	SUM(case when sp_code = 'UNS' then sp_n else 0000 end) as uns_n, SUM(case when sp_code = 'UNS' then sp_kg else 0000 end) as uns_kg       
    FROM art2.trips t          
    INNER JOIN  art2.landing_sites ls on t.landing_site_id = ls.landing_site_id         
    INNER JOIN  art2.effort e on t.art_trip_id = e.art_trip_id         
    LEFT OUTER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)       
    LEFT OUTER JOIN  art2.areas a on a.art_area_id = e.art_area_id         
    LEFT OUTER JOIN  art2.catch c on e.art_effort_id = c.art_effort_id 
	where	YEAR(trip_date)=coalesce(:year,year(trip_date))
    GROUP BY [landing_site_name], [skipper_name], convert(varchar,trip_date,111 ), e.art_effort_id, [fad_fishing], 
    tr.value_en, art_area_name,depart_time,
  return_time",NA
"66","a4e4935b-17b4-437a-9297-01f6c6d8f390"," Trip Submission Status","year, obsv_prg","Check the status of your submitted trips to SPC.","Observer",1,"Observer","85",3030,"andrewh@spc.int","colleyf@spc.int","Observer","2021-11-15T17:39:06.83","
 SELECT t.obsprg_code, coalesce(t.data_status,NULL,0) as data_status, coalesce(i.data_status_desc,NULL,'Unknown') as status_description, count(*) as no_of_trips,
 SUM(CASE WHEN t.gear_code='S' THEN 1 else 0 end) as Purse_seine,
 SUM(CASE WHEN t.gear_code='L' THEN 1 else 0 end) as Longline
  FROM obsv.trip t LEFT JOIN ref_static.data_status i ON i.data_status = t.data_status
  WHERE DATEPART(YEAR,t.dep_date) = :year
  AND t.obsprg_code = coalesce(:obsv_prg,t.obsprg_code)
  GROUP BY t.obsprg_code, t.data_status, i.data_status_desc",NA
"67","eeb8073b-11f3-445c-8ec7-4f31af31eb2e"," LONGLINE - Gen3 incident report by trip by vessel by flag","flag_code, year, obsv_prg","This report gives the recorded gen3 incidents for every longline trip. You can filter by flag and by year. This was requested at the IMS meeting in Honiara 2015.","Observer",NA,"Observer","1",2989,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Compliance","2025-01-27T15:42:14.147"," select  
program,
trip_year,
gear,
trip_no,
staff,
vesselname,
flag_id,
ffa_vid,
ISNULL([RS-A],0) [RS-A],
ISNULL([RS-B],0) [RS-B],
ISNULL([RS-C],0) [RS-C],
ISNULL([RS-D],0) [RS-D],
ISNULL([NR-A],0) [NR-A],
ISNULL([NR-B],0) [NR-B],
ISNULL([NR-C],0) [NR-C],
ISNULL([NR-D],0) [NR-D],
ISNULL([NR-E],0) [NR-E],
ISNULL([NR-F],0) [NR-F],
ISNULL([NR-G],0) [NR-G],
ISNULL([WC-A],0) [WC-A],
ISNULL([WC-B],0) [WC-B],
ISNULL([WC-C],0) [WC-C],
ISNULL([LP-A],0) [LP-A],
ISNULL([LP-B],0) [LP-B],
ISNULL([LC-A],0) [LC-A],
ISNULL([LC-B],0) [LC-B],
ISNULL([LC-C],0) [LC-C],
ISNULL([LC-D],0) [LC-D],
ISNULL([LC-E],0) [LC-E],
ISNULL([LC-F],0) [LC-F],
ISNULL([SI-A],0) [SI-A],
ISNULL([SI-B],0) [SI-B],
ISNULL([PN-A],0) [PN-A],
ISNULL([PN-B],0) [PN-B],
ISNULL([PN-C],0) [PN-C],
ISNULL([PN-D],0) [PN-D],
ISNULL([PN-E],0) [PN-E],
ISNULL([SS-A],0) [SS-A],
ISNULL([SS-B],0) [SS-B]
from (

SELECT obsprg_code as program
      ,year(dep_date) as trip_year
      ,gear_code as gear
      ,tripno as trip_no
      ,staff_code as staff
      ,vi.vesselname
      ,vi.flag_id
      ,vi.ffa_vid
      ,coalesce(cast(answer as int),0) as answer
	  ,question_code
FROM obsv.gen3vr09 gen3
    join obsv.trip t on t.obstrip_id = gen3.obstrip_id
    join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
	join ref.field_staff f on f.staff_id=t.observer_id) t1
	PIVOT
	(
		SUM(answer)
		FOR question_code in (
		[RS-A]
      ,[RS-B]
      ,[RS-C]
      ,[RS-D]
      ,[NR-A]
      ,[NR-B]
      ,[NR-C]
      ,[NR-D]
      ,[NR-E]
      ,[NR-F]
      ,[NR-G]
      ,[WC-A]
      ,[WC-B]
      ,[WC-C]
      ,[LP-A]
      ,[LP-B]
      ,[LC-A]
      ,[LC-B]
      ,[LC-C]
      ,[LC-D]
      ,[LC-E]
      ,[LC-F]
      ,[SI-A]
      ,[SI-B]
      ,[PN-A]
      ,[PN-B]
      ,[PN-C]
      ,[PN-D]
      ,[PN-E]
      ,[SS-A]
      ,[SS-B]

	  )) as piv



Where trip_year = coalesce(:year, trip_year)
AND program = COALESCE(:obsv_prg,program)
AND flag_id    = coalesce(:flag_code,flag_id)
and gear='L'
 and ISNULL([RS-A],0)+ISNULL([RS-B],0)+ISNULL([RS-C],0)+ISNULL([RS-D],0)+ISNULL([NR-A],0)+ISNULL([NR-B],0)+ISNULL([NR-C],0)+ISNULL([NR-D],0)+ISNULL([NR-E],0)+ISNULL([NR-F],0)+ISNULL([NR-G],0)+ISNULL([WC-A],0)+ISNULL([WC-B],0)+ISNULL([WC-C],0)+ISNULL([LP-A],0)+ISNULL([LP-B],0)+ISNULL([LC-A],0)+ISNULL([LC-B],0)+ISNULL([LC-C],0)+ISNULL([LC-D],0)+ISNULL([LC-E],0)+ISNULL([LC-F],0)+ISNULL([SI-A],0)+
 ISNULL([SI-B],0)+ISNULL([PN-A],0)+ISNULL([PN-B],0)+ISNULL([PN-C],0)+ISNULL([PN-D],0)+ISNULL([PN-E],0)+ISNULL([SS-A],0)+ISNULL([SS-B],0) > 0",NA
"68","1802b713-bd0b-4414-bce1-e3cc5c796ed6"," FFA API report - Porst sampling data","year",NA,"Port",NA,NA,"88",3001,"andrewh@spc.int","brunod@spc.int","PortSampling, API","2021-10-08T13:57:25.043","select	month(s.sample_date) month, vi.flag_rg_id flag,count(distinct s.sample_id) samples_count, count(distinct v.vessel_id) vessels_count into #t
	from	port.samples s
			inner join ref.vessels v on s.vessel_id = v.vessel_id 
			inner join ref.vessel_instances vi on vi.vessel_id = v.vessel_id and s.sample_date between vi.start_date and vi.calculated_end_date
	where	YEAR(s.sample_date)=:year
	group by month(s.sample_date), vi.flag_rg_id select piv.month, piv.flag,'LL' gear ,#t.samples_count samples_n,#t.vessels_count vessels_n, ALB alb_n, BET bet_n, YFT yft_n, OTH oth_n,  (ALB+BET+YFT+OTH) tot_n, null alb_mt, null bet_mt, null yft_mt, null oth_mt,  null tot_mt
from (
	SELECT MONTH, flag, sp_code, SUM(sp_n) sp_n
	FROM(
		select	month(s.sample_date) month, vi.flag_rg_id flag, 
			CASE WHEN st.sp_code IN ('BET','YFT','ALB') THEN st.sp_code ELSE 'OTH' END sp_code ,SUM(st.samples_n) sp_n
		from	port.samples s inner join port.sample_tot st on st.sample_id = s.sample_id
				inner join ref.vessels v on s.vessel_id = v.vessel_id 
				inner join ref.vessel_instances vi on vi.vessel_id = v.vessel_id and s.sample_date between vi.start_date and vi.calculated_end_date
		where	YEAR(s.sample_date)=:year
		group by month(s.sample_date), vi.flag_rg_id,st.sp_code) sub
	GROUP BY MONTH, flag, sp_code
) src
pivot
(
	sum(sp_n)
	for sp_code in ([ALB],[BET],[YFT],[OTH])
)piv
inner join #t ON piv.month = #t.month AND piv.flag = #t.flag",NA
"69","8dfac382-4475-490b-af5c-8485a3999415"," PURSE SEINE - Unloading - By vessel and port","flag_code, year",NA,"Port",NA,NA,"32b",3005,"andrewh@spc.int","brunod@spc.int","Unloading, Purseseine, ByVessel, Tuna","2024-04-23T14:48:50.537","SELECT	YEAR(up.unload_startdate) Year, MONTH(up.unload_startdate) Month into #vessels
FROM	unload2.unloadings_ps up JOIN ref.vessels v ON v.vessel_id = up.vessel_id
		JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
WHERE 	COALESCE(:year,YEAR(up.unload_startdate))=YEAR(up.unload_startdate)
AND		COALESCE(:flag_code,vi.flag_id) = vi.flag_id
GROUP BY YEAR(up.unload_startdate), MONTH(up.unload_startdate)
ORDER BY YEAR(up.unload_startdate), MONTH(up.unload_startdate)
SELECT Year,Month,port_name,flag_id,carriername,carrier_flag, dest_port,cannery_name, vesselname,SUM(SKJ) SKJ, SUM(YFT) YFT, SUM(BET) BET, SUM(YFT_BET_SKJ) YFT_BET_SKJ, SUM(YFT_BET) YFT_BET, SUM(UNS) UNS
FROM (
	SELECT port_name, carriername, dest_port,cannery_name, carrier_flag, vesselname,flag_id,piv.Year, piv.Month, COALESCE(piv.SKJ,0) SKJ, COALESCE(piv.YFT,0) YFT, COALESCE(piv.BET,0) BET, COALESCE(piv.YFT_BET_SKJ,0) YFT_BET_SKJ, COALESCE(piv.YFT_BET,0) YFT_BET, COALESCE(piv.UNS,0) UNS
	FROM (
		SELECT	COALESCE(p.port_name, 'UNKNOWN') port_name,vim.vesselname as carriername, vim.flag_id carrier_flag,COALESCE(p2.port_name, ' ') dest_port,cannery_name,vi.vesselname,vi.flag_id,YEAR(up.unload_startdate) Year,MONTH(up.unload_startdate) Month,
				CASE WHEN sp_code <> 'TUN' THEN sp_code ELSE 
					CASE WHEN size_class = 'S' THEN 'YFT_BET_SKJ' ELSE 'YFT_BET' END
				END sp_code,SUM(sp_mt) sp_mt
		FROM	unload2.carrier_loading cl LEFT OUTER JOIN  ref.ports p ON p.port_id=cl.port_id LEFT OUTER JOIN  ref.ports p2 ON p2.port_id=cl.carrier_destination_port_id
				JOIN unload2.unloadings_ps up ON cl.carrier_loading_id = up.carrier_loading_id
				JOIN ref.vessels v ON v.vessel_id = up.vessel_id
				JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
				JOIN unload2.unloading_catch_ps upc ON up.unload_id = upc.unload_id
				LEFT OUTER JOIN ref.vessel_instances vim ON cl.carr_vessel_id = vim.vessel_id AND up.unload_startdate BETWEEN vim.start_date AND vim.calculated_end_date
		WHERE 	COALESCE(:year,YEAR(up.unload_startdate))=YEAR(up.unload_startdate)
		AND		COALESCE(:flag_code,vi.flag_id) = vi.flag_id
		GROUP BY p.port_name, vim.vesselname,vim.flag_id,COALESCE(p2.port_name, ' '),cannery_name,vi.vesselname,vi.flag_id,YEAR(up.unload_startdate),MONTH(up.unload_startdate),sp_code, size_class
	) src
	PIVOT(
		SUM(sp_mt)
		for sp_code IN (SKJ, YFT, BET, YFT_BET_SKJ, YFT_BET, UNS)
	) piv JOIN #vessels ON piv.Year=#vessels.Year AND piv.Month=#vessels.Month
) t
GROUP BY Year,Month,port_name,flag_id,carriername, carrier_flag, dest_port,cannery_name,vesselname","PortFlag"
"70","24f74382-362a-4c5a-b636-1b8ed384a47a"," ARTISANAL - Catch by Species by Year","year","Artisanal catch by species for the entire EEZ - Requested by TV.","Artisanal",1,NA,"21",3080,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:19:17.897"," select YEAR(t.trip_date) as year,
	s.sp_code,
	sum(c.sp_n) as num,
	SUM(c.sp_kg) as kg
from art2.trips t
inner join art2.effort e on e.art_trip_id = t.art_trip_id 
inner join art2.catch c on e.art_effort_id = c.art_effort_id
inner join ref.species s on c.sp_code = s.sp_code
where YEAR(trip_date)=coalesce(:year, year(t.trip_date))
group by YEAR(t.trip_date),s.sp_code",NA
"71","f7e4fcdc-7194-4e14-9a89-75d6fc5ddbe4"," PURSE SEINE - Gen 3 incident report by trip by vessel by flag","flag_code, year, obsv_prg","This report gives the recorded gen3 incidents for every purse seine trip. You can filter by flag and by year. This was requested at the IMS meeting in Honiara 2015.","Observer",NA,"Observer","2",3009,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Compliance","2022-03-02T09:44:16.457"," select  
program,
trip_year,
gear,
trip_no,
staff,
vesselname,
flag_id,
ffa_vid,
ISNULL([RS-A],0) [RS-A],
ISNULL([RS-B],0) [RS-B],
ISNULL([RS-C],0) [RS-C],
ISNULL([RS-D],0) [RS-D],
ISNULL([NR-A],0) [NR-A],
ISNULL([NR-B],0) [NR-B],
ISNULL([NR-C],0) [NR-C],
ISNULL([NR-D],0) [NR-D],
ISNULL([NR-E],0) [NR-E],
ISNULL([NR-F],0) [NR-F],
ISNULL([NR-G],0) [NR-G],
ISNULL([WC-A],0) [WC-A],
ISNULL([WC-B],0) [WC-B],
ISNULL([WC-C],0) [WC-C],
ISNULL([LP-A],0) [LP-A],
ISNULL([LP-B],0) [LP-B],
ISNULL([LC-A],0) [LC-A],
ISNULL([LC-B],0) [LC-B],
ISNULL([LC-C],0) [LC-C],
ISNULL([LC-D],0) [LC-D],
ISNULL([LC-E],0) [LC-E],
ISNULL([LC-F],0) [LC-F],
ISNULL([SI-A],0) [SI-A],
ISNULL([SI-B],0) [SI-B],
ISNULL([PN-A],0) [PN-A],
ISNULL([PN-B],0) [PN-B],
ISNULL([PN-C],0) [PN-C],
ISNULL([PN-D],0) [PN-D],
ISNULL([PN-E],0) [PN-E],
ISNULL([SS-A],0) [SS-A],
ISNULL([SS-B],0) [SS-B]
from (

SELECT obsprg_code as program
      ,year(dep_date) as trip_year
      ,gear_code as gear
      ,tripno as trip_no
      ,staff_code as staff
      ,vi.vesselname
      ,vi.flag_id
      ,vi.ffa_vid
      ,coalesce(cast(answer as int),0) as answer
	  ,question_code
FROM obsv.gen3vr09 gen3
    join obsv.trip t on t.obstrip_id = gen3.obstrip_id
    join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
	join ref.field_staff f on f.staff_id=t.observer_id) t1
	PIVOT
	(
		SUM(answer)
		FOR question_code in (
		[RS-A]
      ,[RS-B]
      ,[RS-C]
      ,[RS-D]
      ,[NR-A]
      ,[NR-B]
      ,[NR-C]
      ,[NR-D]
      ,[NR-E]
      ,[NR-F]
      ,[NR-G]
      ,[WC-A]
      ,[WC-B]
      ,[WC-C]
      ,[LP-A]
      ,[LP-B]
      ,[LC-A]
      ,[LC-B]
      ,[LC-C]
      ,[LC-D]
      ,[LC-E]
      ,[LC-F]
      ,[SI-A]
      ,[SI-B]
      ,[PN-A]
      ,[PN-B]
      ,[PN-C]
      ,[PN-D]
      ,[PN-E]
      ,[SS-A]
      ,[SS-B]

	  )) as piv



Where trip_year = coalesce(:year, trip_year)
AND program = COALESCE(:obsv_prg,program)
AND flag_id    = coalesce(:flag_code,flag_id)
and gear='S'
 and ISNULL([RS-A],0)+ISNULL([RS-B],0)+ISNULL([RS-C],0)+ISNULL([RS-D],0)+ISNULL([NR-A],0)+ISNULL([NR-B],0)+ISNULL([NR-C],0)+ISNULL([NR-D],0)+ISNULL([NR-E],0)+ISNULL([NR-F],0)+ISNULL([NR-G],0)+ISNULL([WC-A],0)+ISNULL([WC-B],0)+ISNULL([WC-C],0)+ISNULL([LP-A],0)+ISNULL([LP-B],0)+ISNULL([LC-A],0)+ISNULL([LC-B],0)+ISNULL([LC-C],0)+ISNULL([LC-D],0)+ISNULL([LC-E],0)+ISNULL([LC-F],0)+ISNULL([SI-A],0)+
 ISNULL([SI-B],0)+ISNULL([PN-A],0)+ISNULL([PN-B],0)+ISNULL([PN-C],0)+ISNULL([PN-D],0)+ISNULL([PN-E],0)+ISNULL([SS-A],0)+ISNULL([SS-B],0) > 0",NA
"72","43978f89-0857-41b1-8e73-9306aff84eca"," PURSE SEINE - Species Catch Statistics","sp_code, flag_code, year, obsv_prg","Purse seine catch statistics from observer data broken down by Species and Species Group with selection by YEAR, Observer Programme, Flag, and set type","Observer",NA,"Observer","2",2920,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-01-24T12:37:13.147"," SELECT	YEAR(act_date) as year,coalesce(ids.school_association_desc,'Other') as code_name,case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_code,
		sp.sp_name as species,
		sum(case when coalesce(obs_mt,0) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0) else coalesce(sp_c_est,obs_mt) end) as MT, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end
			 else 000000.000 end) /	sum(case when coalesce(obs_mt,0.00000000001) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0.00000000001) else coalesce(sp_c_est,obs_mt) end)  as Disc_percent, 
		sum(case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end) / MAX(tmp.sets) as MT_PER_SET,
		sum(case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end) / MAX(tmp.tot_mt) as species_comp, 
		count(distinct sc.s_set_id) as freq, 
		1.0 * count(distinct sc.s_set_id) / MAX(tmp.sets)  as freq_perc, 
		1.0 * count(distinct sc.s_set_id) / MAX(case when coalesce(tmp.sets_success,0.00000000001)= 0 then 0.00000000001 else coalesce(tmp.sets_success,0.00000000001) end)  as freq_success_set_perc, 
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Individuals, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end
			 else 000000.000 end) /	sum(case when coalesce(obs_n,0.00000000001) > coalesce(sp_n_est,obs_n) then coalesce(obs_n,0.00000000001) else coalesce(sp_n_est,obs_n) end)	as Disc_n_perc, 
		1.0 * sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) / MAX(tmp.sets) as NO_PER_SET,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) / MAX(case when coalesce(tmp.sets_success,0.00000000001)= 0 then 0.00000000001 else coalesce(tmp.sets_success,0.00000000001) end) as NO_PER_SUCCESS_SET
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
				left outer join ref_static.ps_school_associations ids on coalesce(sa.schas_id,0) = ids.schas_id
				left outer join (SELECT COUNT(distinct sa.s_daylog_id) AS sets,
										COUNT(distinct sc.s_set_id) AS sets_success,
										sum(case when coalesce(obs_mt,000.000) > coalesce(sp_c_est,coalesce(obs_mt,000.000)) then coalesce(obs_mt,000.000) else coalesce(sp_c_est,coalesce(obs_mt,000.000)) end) as tot_mt 
								FROM obsv.trip ot 
										inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
										inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
										inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
										left outer join ref_static.ps_school_associations ids on coalesce(sa.schas_id,0) = ids.schas_id 
										left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
										left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
								WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
									AND coalesce(s_activ_id,0) = 1 
 									AND coalesce(sa.schas_id,20) = coalesce(null,coalesce(sa.schas_id,20))
								    AND flag_id = coalesce(:flag_code,flag_id)
									AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
								    AND case 	when coalesce(sa.schas_id,20)-20 in (1,2) then 'U' 
								 				when coalesce(sa.schas_id,20)-20 in (3,4,5,6) then 'A' 
								 				else 'O' end 
								 		= coalesce(null,
												   case when coalesce(sa.schas_id,20)-20 in (1,2) then 'U' 
												   		when coalesce(sa.schas_id,20)-20 in (3,4,5,6) then 'A' 
												   else 'O' end)
								    AND coalesce(sa.schas_id,20)-20 > 0
								) tmp ON tmp.sets > 0
WHERE ot.obstrip_id = coalesce(null,ot.obstrip_id)
	AND YEAR(act_date) = coalesce(:year,year(act_date))
	AND s_activ_id = 1 
	AND coalesce(sa.schas_id,20) = coalesce(null,coalesce(sa.schas_id,20))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
	AND case 	when coalesce(sa.schas_id,20)-20 in (1,2) then 'U' 
 				when coalesce(sa.schas_id,20)-20 in (3,4,5,6) then 'A' 
 				else 'O' end 
 		= coalesce(null,
			   case when coalesce(sa.schas_id,20)-20 in (1,2) then 'U' 
			   		when coalesce(sa.schas_id,20)-20 in (3,4,5,6) then 'A' 
				   else 'O' end)

GROUP BY  
	YEAR(act_date),coalesce(ids.school_association_desc,'Other'),case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
	sp.sp_code,sp.sp_name
HAVING	sum(case when coalesce(obs_mt,0.00000000001) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0.00000000001) else coalesce(sp_c_est,obs_mt) end) > 0 
	and sum(case when coalesce(obs_n,0.00000000001) > coalesce(sp_n_est,obs_n) then coalesce(obs_n,0.00000000001) else coalesce(sp_n_est,obs_n) end) > 0",NA
"73","0bfff37c-6efe-46a6-b16e-80ffbec8dd39"," Aircraft and Vessel Sightings by OBS Program and Year - GEN1","year, obsv_prg",NA,"Observer",NA,"Observer","5",2924,"andrewh@spc.int","colleyf@spc.int","Observer","2023-07-10T15:08:37.647"," SELECT t.obsprg_code AS obsprg_code,
       year(dep_date) AS trip_year,
       SUM(case when gear_code = 'L' then 1 else 0 end) AS sightings_by_ll,
       SUM(case when gear_code = 'S' then 1 else 0 end) AS sightings_by_ps,
       COUNT(distinct t.obstrip_id) AS no_of_trips 
  FROM obsv.trip t join obsv.gen1sightings g ON t.obstrip_id = g.obstrip_id
WHERE 	year(dep_date) = COALESCE(:year,year(dep_date))
	AND obsprg_code = COALESCE(:obsv_prg,obsprg_code)
GROUP BY t.obsprg_code, year(dep_date)",NA
"74","11584792-dee5-45a2-a38f-cf6b5d9e760f"," LONGLINE Observer LENGTH FREQUENCY","sp_code, flag_code, year, obsv_prg, trip_id","A breakdown of the Length frequency by MONTH and SIZE CLASS for the selected SPECIES ","Observer",1,"Observer"," 3",2928,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-17T10:34:39.663"," select tmp1.species,
		len,
		SUM(f_q1) as f_q1,
		SUM(f_q2) as f_q2,
		SUM(f_q3) as f_q3,
		SUM(f_q4) as f_q4,
		SUM(f_m1) as f_m1,
		SUM(f_m2) as f_m2,
		SUM(f_m3) as f_m3,
		SUM(f_m4) as f_m4,
		SUM(f_m5) as f_m5,
		SUM(f_m6) as f_m6,
		SUM(f_m7) as f_m7,
		SUM(f_m8) as f_m8,
		SUM(f_m9) as f_m9,
		SUM(f_m10) as f_m10,
		SUM(f_m11) as f_m11,
		SUM(f_m12) as f_m12
from (
	SELECT 	
		sp_code as species,
		lc.len as len,
		sum(case when month(catch_date) in (1,2,3)	then 00001 else 00000 end) as f_q1, 
		sum(case when month(catch_date) in (4,5,6)	then 00001 else 00000 end) as f_q2, 
		sum(case when month(catch_date) in (7,8,9)	then 00001 else 00000 end) as f_q3, 
		sum(case when month(catch_date) in (10,11,12)	then 00001 else 00000 end) as f_q4, 
		sum(case when month(catch_date) = 01	then 00001 else 00000 end) as f_m1, 
		sum(case when month(catch_date) = 02	then 00001 else 00000 end) as f_m2, 
		sum(case when month(catch_date) = 03	then 00001 else 00000 end) as f_m3, 
		sum(case when month(catch_date) = 04	then 00001 else 00000 end) as f_m4, 
		sum(case when month(catch_date) = 05	then 00001 else 00000 end) as f_m5, 
		sum(case when month(catch_date) = 06	then 00001 else 00000 end) as f_m6, 
		sum(case when month(catch_date) = 07	then 00001 else 00000 end) as f_m7, 
		sum(case when month(catch_date) = 08	then 00001 else 00000 end) as f_m8, 
		sum(case when month(catch_date) = 09	then 00001 else 00000 end) as f_m9, 
		sum(case when month(catch_date) = 10	then 00001 else 00000 end) as f_m10, 
		sum(case when month(catch_date) = 11	then 00001 else 00000 end) as f_m11, 
		sum(case when month(catch_date) = 12	then 00001 else 00000 end) as f_m12 
	FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.field_staff f on f.staff_id=ot.observer_id
	WHERE YEAR(catch_date) = coalesce(:year,year(catch_date))
		AND sp_code = :sp_code 
	    AND flag_id = coalesce(:flag_code,flag_id)
		AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
		AND COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno
		AND coalesce(lc.len,0) > 0
	GROUP BY sp_code, lc.len 
	UNION 
	SELECT 	
		:sp_code as species,
		tmp.key1 as len,
		sum(00000) as f_q1, 
		sum(00000) as f_q2, 
		sum(00000) as f_q3, 
		sum(00000) as f_q4, 
		sum(00000) as f_m1, 
		sum(00000) as f_m2, 
		sum(00000) as f_m3, 
		sum(00000) as f_m4, 
		sum(00000) as f_m5, 
		sum(00000) as f_m6, 
		sum(00000) as f_m7, 
		sum(00000) as f_m8, 
		sum(00000) as f_m9, 
		sum(00000) as f_m10, 
		sum(00000) as f_m11, 
		sum(00000) as f_m12 
	FROM	(	select key1 
				from (	select n as key1
						from ref.numbers) tmp0
						where key1 <= 200) tmp 
	GROUP BY tmp.key1 ) tmp1
GROUP BY tmp1.species, tmp1.len",NA
"75","d57c4730-d469-43f8-9035-2a63b64f5982"," Summary of Trips","flag_code, year, obsv_prg","Summarised statistics of observer trips from the database for the national observer programme","Observer",NA,"Observer","3",2937,"andrewh@spc.int","aurelienp@spc.int","Observer, MyFleet","2022-01-12T10:58:38.503"," SELECT  
P.obsprg_desc AS observer_prog_desc,
P.obsprg_code AS observer_prog_code,
staff_code AS staff_code,
S.first_name + ' ' + S.family_name + ' - ' + S.staff_code AS name, 
'T'+T.tripno AS trip_number,
gear_code AS gear_desc,
V.vesselname AS vessel_name,
V.flag_id AS vessel_flag,	 
CONVERT(VARCHAR(10), T.dep_date, 103) AS first_day, 
CONVERT(VARCHAR(10), T.ret_date, 103) AS last_day,
DATEPART(mm,T.dep_date) as mth,
DATEDIFF(d, T.dep_date, T.ret_date) + 1 AS sea_days,
(SELECT sum(coalesce(hook_observed,0)) FROM obsv.trip st 
								inner join obsv.l_set ss on st.obstrip_id = ss.obstrip_id 
								left outer join	obsv.l_sethaullog lsh on ss.l_set_id = lsh.l_set_id and stend_id = 83
							WHERE st.obstrip_id = T.obstrip_id 
							/*	and wcpfc_area = 1
    							and YEAR(ss.set_date) = coalesce(:year, YEAR(ss.set_date)) */
				) AS hk_observed,
(SELECT COUNT(*) FROM obsv.s_day d join obsv.s_daylog dl on d.s_day_id=dl.s_day_id WHERE d.obstrip_id = T.obstrip_id and dl.s_activ_id in (1)) + (SELECT COUNT(*) FROM obsv.l_set LS WHERE LS.obstrip_id = T.obstrip_id) AS set_count, 
DP.port_name AS departure_port, 
RP.port_name AS return_port,
data_source
FROM            
obsv.trip AS T INNER JOIN ref.vessel_instances AS V ON T.vessel_id = V.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
LEFT OUTER JOIN ref.field_staff AS S ON S.staff_id = T.observer_id
LEFT JOIN ref.ports AS DP ON DP.port_id = T.dep_port_id
LEFT JOIN ref.ports AS RP ON RP.port_id = T.ret_port_id
INNER JOIN ref_static.obsv_programs AS P ON T.obsprg_code = P.obsprg_code
WHERE 	P.obsprg_code = coalesce(:obsv_prg, P.obsprg_code)
AND YEAR(T.dep_date) = coalesce(:year, YEAR(T.dep_date))
AND V.flag_id = coalesce(:flag_code,V.flag_id)",NA
"76","b03eef0f-a55f-4507-8ba0-660c7fcdb421"," PURSE SEINE - Vessel Catch Report by set type - BY FLEET","flag_code, year","BY FLEET - VESSEL Catch Report by set type, associated sets vs unassociated sets","Logsheets",NA,NA,"16",2971,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2023-06-08T15:06:19.457"," SELECT  vi.flag_id flag_code, 
		vi.vesselname vessel_name, 
                vi.ffa_vid,
		:group_by, 
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as int) AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as int) AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end) as int) AS yft_mt, 
        cast(Sum(sp_mt_est) as int) AS tot_mt
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					left outer JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_PurseSeineSchoolAssociations' + CONVERT(VARCHAR,s.school_id)
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and vi.flag_id = coalesce(:flag_code,vi.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, vi.vesselname ,vi.ffa_vid,tr.value_en, :group_by","YearMonth"
"77","ae961db4-9ac3-426c-be37-0afda72f7995"," LONGLINE - Tuna catch and effort (Year / Year-Month / Vessel) - BY FLAG","flag_code, year","","Logsheets",NA,NA,"11",2891,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Longline, ByVessel, MyEEZ, Tuna","2025-07-21T16:43:40.19"," SELECT  vi.flag_id flag_code, 
		:group_by, 
		COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips,
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when l_activity_id in (1) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		max(tmp.hhooks) as hooks_100,
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000 				as decimal(9,3))	AS alb_mt, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2)) END AS alb_cpue,
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case sp_code when 'ALB' then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2)) END AS alb_npue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000 				as decimal(7,2))	AS bet_mt, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)   as decimal(6,2)) END AS bet_cpue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2)) END AS bet_npue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000				as decimal(7,2))	AS yft_mt, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2)) END AS yft_cpue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		CASE max(tmp.hhooks) WHEN 0 THEN 0 ELSE cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2)) END AS yft_npue, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 000.0 when 'BE0' then 000.0 else sp_kg_est end)/1000 as decimal(7,2)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BE0' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(7,2)) 	AS tot_mt, 
		cast(Sum(sp_n_est)           															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					inner join (SELECT		vi.flag_id, 
											:group_by as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
								WHERE	year(logdate)	= coalesce(:year, year(logdate)) 
									and vi.flag_id		= coalesce(:flag_code,vi.flag_id)
									    AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
								group by vi.flag_id, :group_by) tmp on tmp.flag_id = vi.flag_id and tmp.key1 = :group_by
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
      AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, 
		:group_by","YearMonth"
"78","19b42299-336d-4517-a849-07687693a1d4"," PURSE SEINE - NATIONAL FLEET - All Species Catch and Effort in the WCPFC Area","year","NATIONAL FLEET - PURSE SEINE ALL SPECIES Catch and Effort in the WCPFC Area","Logsheets",NA,NA,"2",2897,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting","2021-10-07T13:51:42.817"," Select	YEAR(logdate) year,
		sp.sp_name,
		cast(SUM(c.sp_mt_est) as decimal(9,1)) as catch,
        cast(SUM(case when c.sp_code = sp.sp_code then c.sp_mt_est else 000.000 end) / tmp.fish_days as decimal(9,3)) as cpue
FROM	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
		inner join ref.species sp on sp.sp_code = c.sp_code
		inner join (SELECT	YEAR(logdate) as key1,
							COUNT(distinct case when s.s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(s.logdate as date) as varchar(10)) else null end) as fish_days
					FROM	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
							inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
					WHERE	year(logdate) = coalesce(:year, year(logdate))
					group by YEAR(logdate)) tmp on tmp.key1 = :group_by
WHERE	year(logdate) = coalesce(:year, year(logdate))
Group by YEAR(logdate), sp.sp_name, tmp.fish_days",NA
"79","01270561-d0e7-4654-a052-84ac1ff0420e"," Part1 - Table 1 - PURSE SEINE - Annual catch and effort by primary species and gear in the WCPFC Convention Area","","PART 1 REPORT (Essential Information 1) - Annual catch and effort estimates for the NATIONAL PURSE SEINE FLEET, in the WCPFC Convention Area","Logsheets",NA,NA,"1b",2906,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, RegionalReporting","2023-08-01T15:44:51.293"," SELECT	distinct 
		'   ---' as category,
		'   ' as species,
		YEAR(GETDATE())-5 as yr1,
		YEAR(GETDATE())-4 as yr2,
		YEAR(GETDATE())-3 as yr3,
		YEAR(GETDATE())-2 as yr4,
		YEAR(GETDATE())-1 as yr_curr
FROM   ref.species sp 
where sp_code = 'ALB'
UNION 
SELECT	case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end as category,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end as species,
		CONVERT(int,MAX(yb.mt_yr1)) as yr1,
		CONVERT(int,MAX(yb.mt_yr2)) as yr2,
		CONVERT(int,MAX(yb.mt_yr3)) as yr3,
		CONVERT(int,MAX(yb.mt_yr4)) as yr4,
		CONVERT(int,SUM(case when year(logdate) = YEAR(GETDATE())-1 then sp_mt else 00000.000 end)) as yr_curr
FROM   log.trips_ps l inner join ref.vessel_instances vi 
					on l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
					INNER JOIN ref.vessels v	ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.sets_ps s	ON l.log_trip_id = s.log_trip_id
					INNER JOIN log.catch_ps c	ON c.log_set_id = s.log_set_id
					INNER JOIN	ref.species sp on c.sp_code = sp.sp_code
					FULL OUTER JOIN (select sp_code,
										SUM(case when yy = YEAR(GETDATE())-5 then sp_mt else 00000.000 end) as mt_yr1,
										SUM(case when yy = YEAR(GETDATE())-4 then sp_mt else 00000.000 end) as mt_yr2,
										SUM(case when yy = YEAR(GETDATE())-3 then sp_mt else 00000.000 end) as mt_yr3,
										SUM(case when yy = YEAR(GETDATE())-2 then sp_mt else 00000.000 end) as mt_yr4
								from [WCPFC_YEARBOOK].[dbo].[A_ACE] a1 inner join [WCPFC_YEARBOOK].[dbo].[A_ACE_CATCH] a2 
										on a1.ACE_ID = a2.ACE_ID
								where YY >= YEAR(GETDATE())-5 and YY <= YEAR(GETDATE())-2
AND (@@entity = 'HIVE' OR flag_code COLLATE DATABASE_DEFAULT = @@entity)
									and GEAR_CODE = 'S'
									and ocean_code = 'WX'
								group by sp_code) yb 
								on yb.sp_code collate database_default =	case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
																					when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
																					when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
																			else	c.sp_code end collate database_default
WHERE	YEAR(logdate) >= YEAR(GETDATE())-5 
	and YEAR(logdate) <= YEAR(GETDATE())-1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
    and c.sp_code in ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
group by case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end",NA
"80","399e7604-68ff-4af2-b923-b535944ce257"," PURSE SEINE - UST Catch report - Excludes Discards","eez_code, year","","Logsheets",NA,NA,"91",3101,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, Tuna","2021-10-07T15:06:08.677"," SELECT  vi.flag_id flag_code,
		comp.company_name,
		vi.vesselname vessel_name, 
		:group_by, 
		COUNT(distinct t.log_trip_id) as trips,
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		cast(Sum(case when sp_code = 'SKJ' and discard = 0 then sp_mt_est else 000.000 end) as decimal(7,2)) AS skj_mt, 
        cast(Sum(case when sp_code = 'BET' and discard = 0 then sp_mt_est else 000.000 end) as decimal(7,2)) AS bet_mt, 
        cast(Sum(case when sp_code = 'YFT' and discard = 0  then sp_mt_est else 000.000 end) as decimal(7,2)) AS yft_mt, 
        cast(Sum(case when discard = 0 then sp_mt_est else 000.00 end) as decimal(7,2)) AS tot_mt
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date	
					left outer join tufman.companies comp on comp.company_id = vi.company_id	
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and vi.flag_id = 'US'
      and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
group by vi.flag_id, comp.company_name, vi.vesselname , :group_by","Year"
"81","666fdf67-825b-4613-a0e0-6f11ea53ada3"," LONGLINE - Catches by species in the WCPO Area","flag_code, year","LONGLINE CATCH by SPECIES, in WCPO Area","Logsheets",NA,NA,"42",3084,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, AllSpecies","2025-07-16T11:11:46.913"," SELECT  v.flag_id flag_code, 
		sp.sp_name, 
                sp.sp_code,
		cast(Sum(case when coalesce(sp_kg_est,0) > coalesce(sp_kg,0) then coalesce(sp_kg_est,0) else coalesce(sp_kg,0) end *1.000) / 1000 as decimal(8,3))	AS metric_tonnes
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.depart_date BETWEEN v.start_date AND v.calculated_end_date
					inner join ref.species sp on c.sp_code = sp.sp_code
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and v.flag_id	= coalesce(:flag_code,v.flag_id)
  and ref.GetLonD360fromLon(lon) > 115 and ref.GetLonD360fromLon(lon) < 210 
group by v.flag_id, sp.sp_name, sp.sp_code",NA
"82","0026f9a9-b8ec-4812-96e5-f22d90914bac"," LONGLINE - Vessel catch report (year, month or set) - BY FLAG AND YEAR","flag_code, year","","Logsheets",NA,NA,"14",2894,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, ByVessel, Raised, Tuna","2021-10-06T11:35:01.48"," SELECT  vi.flag_id flag_code, 
		vi.flag_rg_id registered_country_code,
		vi.vesselname vessel_name, 
		vi.ffa_vid,
		:group_by, 
		COUNT(distinct t.log_trip_id) as trips,
		COUNT(distinct s.log_set_id) as days,
		max(tmp.hhooks) as hooks_100,  
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000 				as decimal(5,2))	AS alb_mt, 
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2))	AS alb_cpue, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS alb_npue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000 				as decimal(5,2))	AS bet_mt, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)   as decimal(6,2)) 	AS bet_cpue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS bet_npue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000				as decimal(5,2))	AS yft_mt, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2))	AS yft_cpue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS yft_npue, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 000.0 when 'BE0' then 0 else sp_kg_est end)/1000 as decimal(5,2)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BE0' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(5,2)) 	AS tot_mt, 
		cast(Sum(sp_n_est)         															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					inner join (SELECT		vi.flag_id,
											vi.vesselname,
											:group_by  as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
								WHERE year(logdate) = coalesce(:year, year(logdate)) 
								  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
								  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
								group by vi.flag_id, vi.vesselname, :group_by) tmp on tmp.flag_id = vi.flag_id and tmp.vesselname = vi.vesselname and tmp.key1 = :group_by
WHERE year(s.logdate) = coalesce(:year, year(s.logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, vi.flag_rg_id, vi.vesselname, vi.ffa_vid,
		:group_by","YearMonth"
"83","28c2c42f-994d-4726-84f1-0c19d92aaa5f"," PURSE SEINE - Vessel Catch Report - BY FLEET","flag_code, year",NA,"Logsheets",NA,NA,"14",2902,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, ByVessel, MyEEZ, Tuna","2021-10-07T14:12:51.58"," SELECT  vi.flag_id flag_code, 
		vi.vesselname vessel_name, 
		:group_by, 
		COUNT(distinct t.log_trip_id) as trips,
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.000 end) as decimal(7,2)) AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.000 end) as decimal(7,2)) AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.000 end) as decimal(7,2)) AS yft_mt, 
        cast(Sum(sp_mt_est) as decimal(7,2)) AS tot_mt
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date					
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and vi.flag_id = coalesce(:flag_code,vi.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, vi.vesselname , :group_by","YearMonth"
"84","fc4d2467-feab-4124-9254-2d40841639f1"," Part1 - OPTIONAL - Map of LONGLINE CATCH in the Home EEZ (national waters) 5x5","year","Map of LONGLINE CATCH in the Home EEZ (national waters) in 5x5","Logsheets",2,NA,"99a",2913,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM","2021-10-06T15:20:05.073"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,
		floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(case sp_code when 'ALB' then sp_kg_est else 0000 end)				AS alb_kg, 
		Sum(case sp_code when 'BET' then sp_kg_est else 0000 end) 				AS bet_kg, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 0000 end) 				AS yft_kg, 
		Sum(case sp_code when 'BLM' then sp_kg_est else 0000 end) 				AS blm_kg, 
		Sum(case sp_code when 'BUM' then sp_kg_est else 0000 end) 				AS bum_kg, 
		Sum(case sp_code when 'MLS' then sp_kg_est else 0000 end) 				AS mls_kg, 
		Sum(case sp_code when 'SWO' then sp_kg_est else 0000 end) 				AS swo_kg 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
 AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5 ,
		floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"85","9c0356b4-649f-4bc9-9510-c84fcbbf33a1"," PURSE SEINE - Observer Effort Statistics","flag_code, year, obsv_prg, date_from, date_to","Observer Effort Statistics selection by YEAR, Observer Programme, Flag","Observer",1,"Observer","1",2921,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2021-10-15T10:20:58.117"," SELECT     
        MAX('DAY') as cat_code,
		Case	when n = 1 then '_0. TRIPS                  ' 
				when n = 2 then '_1. Days AT SEA (trip dates)' 
		end as cat_txt,
		SUM(case 	when n = 1 then 1
					when n = 2 then datediff(d,dep_date,ret_date)+1 end) as cat_value,
                    null as cat_value2 
 FROM    ref.numbers nb, obsv.trip ot 
                inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
WHERE YEAR(dep_date) = coalesce(:year,year(dep_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
    /* AND ot.tripno = coalesce(trip_id,ot.tripno) */
    AND dep_date >= coalesce(:date_from,dep_date)
    AND dep_date <= coalesce(:date_to,dep_date)
	AND gear_code = 'S'
    AND n < 3 and n > 0
GROUP BY 
	Case	when n = 1 then '_0. TRIPS                  ' 
			when n = 2 then '_1. Days AT SEA (trip dates)' 
	end
UNION
SELECT 	
		MAX('DAY') as cat_code,
		Case	when n = 1 then 'D0. TRIPS (processed data)		' 
				when n = 2 then 'D1. Days AT SEA (processed data)' 
				when n = 3 then 'D2. Days FISHING/SEARCHING		' 
				when n = 4 then 'D3. Days with TRANSITS			' 
				when n = 5 then 'D4. Days with FAD DEPLOYMENT Activity	'
				when n = 6 then 'D5. Days with FAD RETRIEVAL Activity	'
		end as cat_txt,
		COUNT( DISTINCT 
					Case	when n = 1 then cast(ot.obstrip_id as varchar(50)) 
							when n = 2 then cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) 
							when n = 3 then case when s_activ_id in (1,2)	then  cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) else null end
							when n = 4 then case when s_activ_id in (3)		then  cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) else null end
							when n = 5 then case when s_activ_id in (10,17)	then  cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) else null end
							when n = 6 then case when s_activ_id in (11,16)	then  cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) else null end
					end ) as cat_value,
					null as cat_value2 
 FROM	ref.numbers nb, obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
WHERE YEAR(dep_date) = coalesce(:year,year(dep_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
    /* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
    AND dep_date >= coalesce(:date_from,dep_date)
    AND dep_date <= coalesce(:date_to,dep_date)
    AND act_date >= dep_date
    AND act_date <= ret_date
	AND gear_code = 'S'
	AND n < 7 
GROUP BY  
		Case	when n = 1 then 'D0. TRIPS (processed data)		' 
				when n = 2 then 'D1. Days AT SEA (processed data)' 
				when n = 3 then 'D2. Days FISHING/SEARCHING		' 
				when n = 4 then 'D3. Days with TRANSITS			' 
				when n = 5 then 'D4. Days with FAD DEPLOYMENT Activity	'
				when n = 6 then 'D5. Days with FAD RETRIEVAL Activity	'
		End
UNION
SELECT 	
		MAX('SET') as cat_code,
		Case	when n = 1 then '    Total Sets					' 
				when n = 2 then 'S0. No information				' 
				when n = 3 then 'S1. Unassociated				' 
				when n = 4 then 'S2. Feeding on Baitfish		' 
				when n = 5 then 'S3. Drifting LOG - debris or dead animal' 
				when n = 6 then 'S4. Drifting Raft - FAD or Payao'
				when n = 7 then 'S5. Anchored Raft - FAD or Payao'
				when n = 8 then 'S6. Live Whale or Marine mammal'
				when n = 9 then 'S7. Live Whale Shark			'
				when n = 10 then 'S8. Others						'
		end as cat_txt,
		COUNT( DISTINCT
					Case	when n = 1 then											  cast(sa.s_daylog_id as varchar(50)) 
							when n = 2 then case when coalesce(schas_id,20) < 21 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 3 then case when coalesce(schas_id,20) = 21 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 4 then case when coalesce(schas_id,20) = 22 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 5 then case when coalesce(schas_id,20) = 23 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 6 then case when coalesce(schas_id,20) = 24 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 7 then case when coalesce(schas_id,20) = 25 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 8 then case when coalesce(schas_id,20) = 26 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 9 then case when coalesce(schas_id,20) = 27 then cast(sa.s_daylog_id as varchar(50)) end 
							when n = 10 then case when coalesce(schas_id,20) > 27 then cast(sa.s_daylog_id as varchar(50)) end 
					end ) as cat_value,
        COUNT( DISTINCT    
                    Case    when n = 1 then case when sc.s_set_id is not null                                  then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 2 then case when coalesce(schas_id,20) < 21 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 3 then case when coalesce(schas_id,20) = 21 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 4 then case when coalesce(schas_id,20) = 22 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 5 then case when coalesce(schas_id,20) = 23 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 6 then case when coalesce(schas_id,20) = 24 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 7 then case when coalesce(schas_id,20) = 25 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 8 then case when coalesce(schas_id,20) = 26 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 9 then case when coalesce(schas_id,20) = 27 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                            when n = 10 then case when coalesce(schas_id,20) > 27 and sc.s_set_id is not null then cast(sa.s_daylog_id as varchar(50)) end 
                    end ) as cat_value2
 FROM	ref.numbers nb, obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
WHERE YEAR(dep_date) = coalesce(:year,year(dep_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
    /* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
	AND s_activ_id = 1
    AND dep_date >= coalesce(:date_from,dep_date)
    AND dep_date <= coalesce(:date_to,dep_date)
	AND n < 11 
GROUP BY  
		Case	when n = 1 then '    Total Sets					' 
				when n = 2 then 'S0. No information				' 
				when n = 3 then 'S1. Unassociated				' 
				when n = 4 then 'S2. Feeding on Baitfish		' 
				when n = 5 then 'S3. Drifting LOG - debris or dead animal' 
				when n = 6 then 'S4. Drifting Raft - FAD or Payao'
				when n = 7 then 'S5. Anchored Raft - FAD or Payao'
				when n = 8 then 'S6. Live Whale or Marine mammal'
				when n = 9 then 'S7. Live Whale Shark			'
				when n = 10 then 'S8. Others						'
		End",NA
"86","68360710-d902-43c8-ba32-bc85db276600"," LONGLINE Observer EFFORT MAP","eez_code, flag_code, year, obsv_prg, trip_id","Produces data used to map LONGLINE OBSERVER EFFORT for use in GIS systems","Observer",2,"Observer"," 4",2929,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2022-02-15T15:28:27.87"," SELECT 	
		:group_by,
		SUM(hook_set) as hooks 
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
			inner join ref.field_staff f on f.staff_id=ot.observer_id
WHERE COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno
	AND YEAR(set_date) = coalesce(:year,year(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)
AND eez_code= coalesce(:eez_code,eez_code)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
GROUP BY  
		:group_by","Longitude(5x5)MAPINFOLatitude(5x5)MAPINFO"
"87","0ae843a0-bf1c-450b-87ee-9ec66d829168"," CMM 12-07 - Seabird interactions by NATIONAL FLEET","flag_code, min_year, max_year","CCMs shall annually provide to the Commission, in part 1 of their annual reports, all available information on interactions with seabirds, including bycatches and details of species, to enable the Scientific Committee to estimate seabird mortality in all fisheries to which the WCPF Convention applies.","Observer",NA,"Observer","12",2938,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2025-09-15T15:45:59.3"," SELECT 	'S' as gear,
		obsprg_code,
		flag_id as flag, 
		v.vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), act_date, 103) AS date, 
		sa.act_time as time,
		case when sa.latd < -30 then '< 30S' when sa.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code, 
		fate_code, 
		case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end as Individuals,
		case when fate_code = 'DPA' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Alive,
		case when fate_code = 'DPD' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Dead,
		case when fate_code != 'DPD' and fate_code != 'DPA' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Unknown,
		NULL as sighted,
		sc.comments
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(act_date) between coalesce(:min_year,year(act_date)) and coalesce(:max_year,year(act_date))
	AND s_activ_id = 1 
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'
UNION ALL
SELECT 	'L' as gear, 
		obsprg_code,
		flag_id as flag, 
		v.vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), sc.catch_date, 103) AS date, 
		sc.catch_time as time,
		case when sa.latd < -30 then '< 30S' when sa.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code, 
		fate_code, 
		1 as Individuals,
		case when LEFT(cond_code2,1)='A' then 1 else 0 end as Alive,
		case when cond_code='D' or cond_code2='D' then 1 else 0 end as Dead,
		case when coalesce(cond_code,'X')!='D' and left(coalesce(cond_code2,'X'),1) not in ('D','A') then 1 else 0 end as Unknown,
		NULL as sighted,
		sc.comments
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83 
				inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(sc.catch_date) between coalesce(:min_year,year(sc.catch_date)) and coalesce(:max_year,year(sc.catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'

UNION ALL
SELECT 	t.gear_code as gear, 
		obsprg_code,
		flag_id as flag, 
		v.vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), g2.sighting_date, 103) AS date, 
		'-' as time,
		case when g2.latd < -30 then '< 30S' when g2.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code, 
		'-' as fate_code, 
		total_n as Individuals,
		NULL as Alive,
		NULL as Dead,
		NULL as Unknown,
		total_n as sighted,
		g2.behaviour_desc as comments
 FROM	obsv.gen2sightings g2
	join obsv.trip t on t.obstrip_id = g2.obstrip_id
	join ref.species sp on sp.sp_code = g2.sp_code
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
WHERE YEAR(g2.sighting_date) between coalesce(:min_year,year(g2.sighting_date)) and coalesce(:max_year,year(g2.sighting_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'",NA
"88","9d0a6da0-aa69-405d-b7d0-cc05a8f3b1e3"," Catch Statistics by YEAR, FLAG, EEZ","eez_code, flag_code, year",NA,"Observer",NA,"Observer","8",2946,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-01-24T12:29:42.33"," SELECT 	YEAR(act_date) as yr, 
		flag_id as flag,
		eez_code as eez, 
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		MAX(tmp.sets) as sets,
		sum(case when coalesce(obs_mt,0) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0) else coalesce(sp_c_est,obs_mt) end) as MT, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end
			 else 000000.000 end) /	sum(case when coalesce(obs_mt,0.00000000001) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0.00000000001) else coalesce(sp_c_est,obs_mt) end)  as Disc_percent, 
		sum(case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end) / MAX(tmp.sets) as MT_PER_SET,
		sum(case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end) / MAX(tmp.tot_mt) as species_comp, 
		count(distinct sc.s_set_id) as freq, 
		1.0 * count(distinct sc.s_set_id) / MAX(tmp.sets)  as freq_perc, 
		1.0 * count(distinct sc.s_set_id) / MAX(case when coalesce(tmp.sets_success,0.00000000001)= 0 then 0.00000000001 else coalesce(tmp.sets_success,0.00000000001) end)  as freq_success_set_perc, 
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Individuals, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end
			 else 000000.000 end) /	sum(case when coalesce(obs_n,0.00000000001) > coalesce(sp_n_est,obs_n) then coalesce(obs_n,0.00000000001) else coalesce(sp_n_est,obs_n) end)	as Disc_n_perc, 
		1.0 * sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) / MAX(tmp.sets) as NO_PER_SET,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) / MAX(case when coalesce(tmp.sets_success,0.00000000001)= 0 then 0.00000000001 else coalesce(tmp.sets_success,0.00000000001) end) as NO_PER_SUCCESS_SET
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
				left outer join ref_static.ps_school_associations ids on coalesce(sa.schas_id,0) = ids.schas_id 
				left outer join (SELECT YEAR(act_date) as yr, 
										flag_id as flag,
										eez_code as eez,
										COUNT(distinct sa.s_daylog_id) AS sets,
										COUNT(distinct sc.s_set_id) AS sets_success,
										sum(case when coalesce(obs_mt,000.000) > coalesce(sp_c_est,coalesce(obs_mt,000.000)) then coalesce(obs_mt,000.000) else coalesce(sp_c_est,coalesce(obs_mt,000.000)) end) as tot_mt 
								FROM obsv.trip ot 
										inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
										inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
										inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
										left outer join ref_static.ps_school_associations ids on coalesce(sa.schas_id,0) = ids.schas_id 
										left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
										left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
								WHERE	YEAR(act_date)		= coalesce(:year, YEAR(act_date))
									AND flag_id	= coalesce(:flag_code,flag_id)
									AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
									AND s_activ_id = 1 
								GROUP BY 
										YEAR(act_date), 
										flag_id,
										eez_code
								) tmp ON	tmp.yr		= YEAR(act_date)
										AND	tmp.flag	= flag_id 
										AND tmp.eez		= eez_code
WHERE YEAR(act_date)		= coalesce(:year, YEAR(act_date))
	AND flag_id	= coalesce(:flag_code,flag_id)
	AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
	AND s_activ_id = 1 
GROUP BY  
		YEAR(act_date), 
		flag_id,
		eez_code,
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name
HAVING	sum(case when coalesce(obs_mt,0.00000000001) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0.00000000001) else coalesce(sp_c_est,obs_mt) end) > 0 
	and sum(case when coalesce(obs_n,0.00000000001) > coalesce(sp_n_est,obs_n) then coalesce(obs_n,0.00000000001) else coalesce(sp_n_est,obs_n) end) > 0",NA
"89","0016411f-9e19-4686-a785-a89f3d2b7206"," CMM 13-08 – Silky shark species catches by National Fleet","flag_code, year",NA,"Logsheets",NA,NA,"24",2955,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2021-09-20T17:32:13.877"," SELECT  'PS' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
		COALESCE(catch_ps.sp_n,0) as number,
        COALESCE(catch_ps.sp_n_est,0) as number_est,
		catch_ps.sp_mt * 1000 as weight,
		catch_ps.sp_mt_est * 1000 as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when discard=1 then 'Discarded' else 'Retained' end as fate
        
FROM    log.trips_ps trip_ps 
		inner join ref.vessel_instances vi 
					on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_code = 'FAL' 
UNION  
SELECT  'LL' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
		COALESCE(catch_ll.sp_n,0)+COALESCE(spdiscard_n,0) as number,
        COALESCE(catch_ll.sp_n_est,0)+COALESCE(spdiscard_n,0) as number_est,
		catch_ll.sp_kg as weight,
		catch_ll.sp_kg_est as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when spdiscard_n>0 then 'Discarded' else 'Retained' end as life_status
FROM    log.trips_ll trip_ll 
		inner join ref.vessel_instances vi 
					on trip_ll.vessel_id = vi.vessel_id AND trip_ll.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ll set_ll on set_ll.log_trip_id = trip_ll.log_trip_id
        inner join log.catch_ll catch_ll on catch_ll.log_set_id = set_ll.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ll.sp_code

WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_code = 'FAL'",NA
"90","55716373-a1c3-4b6f-b3c2-96fe81ef1244"," LONGLINE - NATIONAL FLEET - All Species Catch and Effort in the WCPFC Area","year","NATIONAL FLEET - LONGLINE ALL SPECIES Catch and Effort in the WCPFC Area","Logsheets",1,NA,"2",2888,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, RegionalReporting, AllSpecies","2021-10-06T15:17:07.733"," SELECT  :group_by,
		sp.sp_name,
		cast(Sum(sp_kg_est*1.000) / 1000				as decimal(8,3))	AS sp_mt, 
		cast(Sum(sp_kg_est*1.000) / max(tmp.hhooks)		as decimal(7,4))	AS sp_cpue, 
		cast(Sum(sp_n_est)								as decimal(7,0))	AS sp_n, 
		cast(Sum(sp_n_est*1.0000)  / max(tmp.hhooks)	as decimal(7,4))	AS sp_npue,
		max(tmp.hhooks) as hhooks
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
					inner join ref.species sp on c.sp_code = sp.sp_code
					inner join (SELECT		:group_by  as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
								WHERE	year(logdate) = coalesce(:year, year(logdate)) 
								group by :group_by) tmp on tmp.key1 = :group_by
WHERE year(logdate) = coalesce(:year, year(logdate)) 
group by :group_by, 
		sp.sp_name","YearMonth"
"91","9b29de2a-8e33-4712-b755-ab554809f84e"," Part1 - Table 2/Figure 2 - LONGLINE - Number of vessels by gear type and size (fleet structure)","","PART 1 REPORT (Essential Information 2) - Number of National LONGLINE Fleet vessels, by size category, active in the WCPFC Convention Area","Logsheets",1,NA,"3a",2907,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, CMM","2025-04-01T14:05:06.47"," SELECT	YY as YR, 
		vess_cat1_n as v1, 
		vess_cat2_n as v2,
		vess_cat3_n as v3,
		vess_cat4_n as v4,
		0000		as v_u,
		vess_n		as vtot,
		'Yearbook/ACEs' as source
FROM   [WCPFC_YEARBOOK].[dbo].[A_ACE] a1 
WHERE a1.YY >= YEAR(GETDATE())-1-4
AND (@@entity = 'HIVE' OR a1.flag_code COLLATE DATABASE_DEFAULT = @@entity)
		and a1.GEAR_CODE = 'L'
		and a1.ocean_code = 'WX'	
UNION 
SELECT	YEAR(l.FIRST_LOGDATE)as YR, 
		count(distinct case when coalesce(grt,0) > 0 and coalesce(grt,0) <=50		then vi.vessel_id else null end) as v1,
		count(distinct case when coalesce(grt,0) > 50 and coalesce(grt,0) <=200		then vi.vessel_id else null end) as v2,
		count(distinct case when coalesce(grt,0) > 200 and coalesce(grt,0) <=500	then vi.vessel_id else null end) as v3,
		count(distinct case when coalesce(grt,0) > 500								then vi.vessel_id else null end) as v4,
		count(distinct case when coalesce(grt,0) = 0								then vi.vessel_id else null end) as v_u,
		count(distinct vi.vessel_id) as vtot,
		'Tufman2' as source
FROM  ref.vessel_instances vi 
				INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id 	
					INNER JOIN log.trips_ll l ON l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
					INNER JOIN log.sets_ll s ON l.log_trip_id = s.log_trip_id
WHERE (YEAR(l.FIRST_LOGDATE) = YEAR(GETDATE())-1)
AND (@@entity = 'HIVE' OR vi.flag_id COLLATE DATABASE_DEFAULT = @@entity)
   AND in_wcpfc_area = 1
group by	YEAR(l.FIRST_LOGDATE)",NA
"92","26944361-32eb-4127-9ab6-df7adf8be7a6"," DCT Entry Stats","year","Shows the number of form entries entered by DCT operators. Each separate section of the observer workbook is a form, and one trip will have many forms. These statistics are indicative only as not all forms are the same size etc.","Observer",NA,"Observer","1",2982,"andrewh@spc.int","colleyf@spc.int","Observer","2022-02-14T11:44:39.95"," select assigned_to as Entered_By
,sum(case month(closed_date) when 1 then 1 end) as ""01""
,sum(case month(closed_date) when 2 then 1 end) as ""02""
,sum(case month(closed_date) when 3 then 1 end) as ""03""
,sum(case month(closed_date) when 4 then 1 end) as ""04""
,sum(case month(closed_date) when 5 then 1 end) as ""05""
,sum(case month(closed_date) when 6 then 1 end) as ""06""
,sum(case month(closed_date) when 7 then 1 end) as ""07""
,sum(case month(closed_date) when 8 then 1 end) as ""08""
,sum(case month(closed_date) when 9 then 1 end) as ""09""
,sum(case month(closed_date) when 10 then 1 end) as ""10""
,sum(case month(closed_date) when 11 then 1 end) as ""11""
,sum(case month(closed_date) when 12 then 1 end) as ""12""
from obsv.trip
where assigned_to is not null and year(closed_date)=:year
group by assigned_to",NA
"93","76b6d3f2-5c9f-44d4-8b37-8f8333ecb374"," LONGLINE - Northern Committee - Pacific Bluefin CMM reporting > 20 degrees","","Requested by Vanuatu - Gives the pacific bluefin catch by flag for the area North of 20 degrees. The report has to be classified into < 30kg fish and > 30kg fish however, this will need to be added at a later date when data collection forms make this information available.","Logsheets",NA,NA,"11",2990,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM, Tuna","2021-10-06T14:05:12.47"," SELECT  year(logdate) as year,
		COUNT(distinct case when RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then s.log_set_id else null end) as sets,
		SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n,
		cast(SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE (@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by  year(logdate)",NA
"94","c8b39269-338c-4d3e-bbf2-9ed0cf6e54f0"," Part1 - Figure 3 - Map - POLE AND LINE NATIONAL FLEET catch in the WCPFC Convention Area","year","Map - NATIONAL POLE AND LINE FLEET catch in the WCPFC Convention Area","Logsheets",2,NA,"8c",2998,"andrewh@spc.int","brunod@spc.int","Logsheet, PoleAndLine, CMM","2021-10-11T16:13:40.433","  SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude,
		Sum(case sp_code when 'SKJ' then sp_mt else 0000 end)				AS skj_kg,
		Sum(case sp_code when 'YFT' then sp_mt else 0000 end) 				AS yft_kg,
		Sum(case sp_code when 'BET' then sp_mt else 0000 end) 				AS bet_kg
FROM	log.trips_pl t INNER JOIN log.sets_pl s ON t.log_trip_id = s.log_trip_id 
   		INNER JOIN log.catch_pl c ON s.log_set_id = c.log_set_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	year(logdate) = coalesce(:year, year(logdate))
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"95","0da8a09b-55b9-4cb4-bb0d-1a9b3b305e96"," LONGLINE - Summary Report on Incidents in GEN-3 by Flag and Year","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","5",3006,"andrewh@spc.int","colleyf@spc.int","Observer, Longline, Compliance","2021-11-30T14:29:03.647"," select  
program,
trip_year,
gear,
flag_id,
ISNULL([RS-A],0) [RS-A],
ISNULL([RS-B],0) [RS-B],
ISNULL([RS-C],0) [RS-C],
ISNULL([RS-D],0) [RS-D],
ISNULL([NR-A],0) [NR-A],
ISNULL([NR-B],0) [NR-B],
ISNULL([NR-C],0) [NR-C],
ISNULL([NR-D],0) [NR-D],
ISNULL([NR-E],0) [NR-E],
ISNULL([NR-F],0) [NR-F],
ISNULL([NR-G],0) [NR-G],
ISNULL([WC-A],0) [WC-A],
ISNULL([WC-B],0) [WC-B],
ISNULL([WC-C],0) [WC-C],
ISNULL([LP-A],0) [LP-A],
ISNULL([LP-B],0) [LP-B],
ISNULL([LC-A],0) [LC-A],
ISNULL([LC-B],0) [LC-B],
ISNULL([LC-C],0) [LC-C],
ISNULL([LC-D],0) [LC-D],
ISNULL([LC-E],0) [LC-E],
ISNULL([LC-F],0) [LC-F],
ISNULL([SI-A],0) [SI-A],
ISNULL([SI-B],0) [SI-B],
ISNULL([PN-A],0) [PN-A],
ISNULL([PN-B],0) [PN-B],
ISNULL([PN-C],0) [PN-C],
ISNULL([PN-D],0) [PN-D],
ISNULL([PN-E],0) [PN-E],
ISNULL([SS-A],0) [SS-A],
ISNULL([SS-B],0) [SS-B]
from (

SELECT obsprg_code as program
      ,year(dep_date) as trip_year
      ,gear_code as gear
      ,vi.flag_id
      ,coalesce(cast(answer as int),0) as answer
      ,question_code
FROM obsv.gen3vr09 gen3
    join obsv.trip t on t.obstrip_id = gen3.obstrip_id
    join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
    join ref.field_staff f on f.staff_id=t.observer_id) t1
    PIVOT
    (
        SUM(answer)
        FOR question_code in (
        [RS-A]
      ,[RS-B]
      ,[RS-C]
      ,[RS-D]
      ,[NR-A]
      ,[NR-B]
      ,[NR-C]
      ,[NR-D]
      ,[NR-E]
      ,[NR-F]
      ,[NR-G]
      ,[WC-A]
      ,[WC-B]
      ,[WC-C]
      ,[LP-A]
      ,[LP-B]
      ,[LC-A]
      ,[LC-B]
      ,[LC-C]
      ,[LC-D]
      ,[LC-E]
      ,[LC-F]
      ,[SI-A]
      ,[SI-B]
      ,[PN-A]
      ,[PN-B]
      ,[PN-C]
      ,[PN-D]
      ,[PN-E]
      ,[SS-A]
      ,[SS-B]

      )) as piv
Where trip_year = COALESCE(:year,trip_year)
AND program = COALESCE(:obsv_prg,program)
AND flag_id    = coalesce(:flag_code,flag_id)
and gear='L'
 and ISNULL([RS-A],0)+ISNULL([RS-B],0)+ISNULL([RS-C],0)+ISNULL([RS-D],0)+ISNULL([NR-A],0)+ISNULL([NR-B],0)+ISNULL([NR-C],0)+ISNULL([NR-D],0)+ISNULL([NR-E],0)+ISNULL([NR-F],0)+ISNULL([NR-G],0)+ISNULL([WC-A],0)+ISNULL([WC-B],0)+ISNULL([WC-C],0)+ISNULL([LP-A],0)+ISNULL([LP-B],0)+ISNULL([LC-A],0)+ISNULL([LC-B],0)+ISNULL([LC-C],0)+ISNULL([LC-D],0)+ISNULL([LC-E],0)+ISNULL([LC-F],0)+ISNULL([SI-A],0)+
 ISNULL([SI-B],0)+ISNULL([PN-A],0)+ISNULL([PN-B],0)+ISNULL([PN-C],0)+ISNULL([PN-D],0)+ISNULL([PN-E],0)+ISNULL([SS-A],0)+ISNULL([SS-B],0) > 0",NA
"96","d65a437b-67aa-4810-8c1a-3093406b4108"," Unloading IMS dashboard report","year",NA,"Port",NA,NA,"77c",3015,"andrewh@spc.int","brunod@spc.int","Unloading, API","2021-10-08T13:58:42.787"," select	'PS' gear,vi.flag_id,YEAR(up.unload_startdate) year, MONTH(up.unload_startdate) month,COALESCE(size_class,'A') size_class, sp_code, SUM(sp_mt) sp_mt 
from	unload2.carrier_loading cl INNER JOIN unload2.unloadings_ps up on cl.carrier_loading_id = up.carrier_loading_id
		INNER JOIN unload2.unloading_catch_ps uc on uc.unload_id = up.unload_id
		INNER JOIN ref.vessels v on up.vessel_id=v.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = v.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
where   YEAR(up.unload_startdate)=:year
GROUP BY flag_id,YEAR(up.unload_startdate) , MONTH(up.unload_startdate) ,COALESCE(size_class,'A'), sp_code
UNION
select	'LL' gear,vi.flag_id, YEAR(ul.unload_startdate) year, MONTH(ul.unload_startdate) month, 'A' size_class, sp_code, SUM(sp_kg)/1000.0 sp_mt 	 
from	unload2.unloadings ul inner join unload2.unloading_catch uc on ul.unload_id = uc.unload_id
		INNER JOIN ref.vessels v on ul.vessel_id=v.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = v.vessel_id AND ul.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
where   YEAR(ul.unload_startdate)=:year
group by flag_id,YEAR(ul.unload_startdate), MONTH(ul.unload_startdate), sp_code",NA
"97","2be629ae-84a2-42a1-88f6-4cb2f3ea768a"," LONGLINE - Logsheet / Unloadings / Port sampling reconciliation","flag_code, year",NA,"Logsheets",NA,NA,"3.2.1",3039,"andrewh@spc.int","brunod@spc.int","Logsheet, PortSampling, Unloading, Longline, CoverageMissingData","2021-10-26T10:00:07.59"," SELECT	DISTINCT vi.vesselname vessel_name, 
vi.flag_id flag_code, 
CONVERT(nvarchar,t.depart_date,111) depart_date,
dp.port_name dp,
CONVERT(nvarchar,t.return_date,111) return_date,
rp.port_name rp,
log_trip_id LonglineLogsheetDTO,l.dto_guid_right UnloadingDTO,l2.dto_guid_right PortSamplingDTO
FROM	log.trips_ll t LEFT JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO'  AND l.dto_type_right='UnloadingDTO'
		LEFT JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO'  AND l2.dto_type_right='PortSamplingDTO'
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		JOIN ref.ports dp ON t.depart_port_id = dp.port_id
		JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE 	COALESCE(:year,YEAR(t.depart_date)) = YEAR(t.depart_date)
AND		COALESCE(:flag_code,vi.flag_id) = vi.flag_id",NA
"98","c25ea01e-92ff-4a96-830c-5b5755d43d00"," LONGLINE - Tuna catches in EEZ raised with VMS","flag_code, year",NA,"Logsheets,VMS",NA,NA,"1.2.5",3049,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Tuna","2023-07-16T21:51:45.487","SELECT vms_trip_id INTO #mapped_trip FROM (
	SELECT	dto_guid_left vms_trip_id
	FROM	tufman2.viewpersist_entity_links_two_way
	WHERE	dto_type_left = 'VmsTripDTO'
	AND		dto_type_right = 'LonglineLogsheetDTO'
) t 

SELECT  vi.flag_id,eez.year,AVG(eez.month) month,SUM(eez.day_fishing) day_fishing INTO #missing_trip
FROM    vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
        JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
WHERE t.vms_trip_id NOT IN (SELECT vms_trip_id FROM #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing > 1
AND     ve.gear='L'
and     EXISTS(SELECT 1 FROM tufman2.licence_info WHERE (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) and (@@entity = 'HIVE' OR instance_source = ref.GetBitFromEntity(@@entity))))
AND     eez.year = COALESCE(:year,eez.year)
GROUP BY vi.flag_id, eez.year

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        vi.flag_id,
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate))
AND     l_activity_id = 1
AND	(@@entity = 'HIVE' OR s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, vi.flag_id

SELECT  DATEPART(YEAR, s.logdate) year, 
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        c.sp_code,
        vi.flag_id,
        SUM(COALESCE(c.sp_kg_est,c.sp_kg)) catch INTO #catch
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate)=COALESCE(:year, YEAR(logdate))
AND	(@@entity = 'HIVE' OR s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND     c.sp_code IN ('YFT','BET','ALB')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(month,s.logdate) ,s.eez_code, c.sp_code, vi.flag_id

SELECT  e.year, e.month, e.eez_code, c.sp_code,e.flag_id,c.catch/e.nb_days CPUE, e.nb_days, c.catch, 'Month / Fleet / EEZ' raising_factor INTO #cpue
FROM    #effort e JOIN #catch c ON e.eez_code = c.eez_code AND e.year = c.year AND e.flag_id = c.flag_id AND e.month = c.month

SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_kg, c.raising_factor INTO #missing_catch
FROM	#missing_trip JOIN #cpue c ON #missing_trip.flag_id = c.flag_id AND #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days > 100 
AND     c.sp_code IN ('YFT','BET','ALB')

/*-------------------*/

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_1
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id 
WHERE   YEAR(logdate)=COALESCE(:year, YEAR(logdate))
AND     l_activity_id = 1
AND	(@@entity = 'HIVE' OR s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code

SELECT  DATEPART(YEAR, s.logdate) year, 
        DATEPART(MONTH,s.logdate) month, 
        c.sp_code,
        s.eez_code,
        SUM(COALESCE(c.sp_kg_est,c.sp_kg)) catch INTO #catch_raised_1
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
WHERE   YEAR(logdate)=COALESCE(:year, YEAR(logdate))
AND	(@@entity = 'HIVE' OR s.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND     c.sp_code IN ('YFT','BET','ALB')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code, s.eez_code

SELECT  e.year, e.month, c.sp_code, e.eez_code, c.catch/e.nb_days CPUE, e.nb_days, c.catch, 'MONTH / EEZ' raising_factor INTO #cpue_raised_1
FROM    #effort_raised_1 e JOIN #catch_raised_1 c ON e.year = c.year AND e.eez_code = c.eez_code AND e.month = c.month

INSERT INTO #missing_catch
SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM    #missing_trip JOIN #cpue_raised_1 c ON #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days > 100 
AND     c.sp_code IN ('YFT','BET','ALB')
AND NOT EXISTS (
    SELECT  1
    FROM    #missing_catch temp
    WHERE   temp.year =  #missing_trip.year
    AND     temp.flag_id = #missing_trip.flag_id
    AND     temp.month = #missing_trip.month
)

/*---------------------*/

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_2
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id=s.log_trip_id 
WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate))
AND     l_activity_id = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate)

SELECT  DATEPART(YEAR, s.logdate) year, 
        DATEPART(MONTH,s.logdate) month, 
        c.sp_code,
        SUM(COALESCE(c.sp_kg_est,c.sp_kg)) catch INTO #catch_raised_2
FROM    log.trips_ll  t JOIN log.sets_ll  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
WHERE   YEAR(logdate) = COALESCE(:year,year(logdate))
AND     c.sp_code IN ('YFT','BET','ALB')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate),c.sp_code

SELECT  e.year, e.month, c.sp_code,c.catch/e.nb_days CPUE, e.nb_days, c.catch, 'MONTH' raising_factor INTO #cpue_raised_2
FROM    #effort_raised_2 e JOIN #catch_raised_2 c ON e.year = c.year AND e.month = c.month

INSERT INTO #missing_catch
SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM    #missing_trip JOIN #cpue_raised_2 c ON #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.sp_code IN ('YFT','BET','ALB')
AND NOT EXISTS (
    SELECT  1
    FROM    #missing_catch temp
    WHERE   temp.year =  #missing_trip.year
    AND     temp.flag_id = #missing_trip.flag_id
    AND     temp.month = #missing_trip.month
)

SELECT  COALESCE(c.year,mc.year) year,COALESCE(c.flag_id,mc.flag_id) flag_id, COALESCE(c.sp_code,mc.sp_code) sp_code, CONVERT(DECIMAL(15,2),SUM(COALESCE(c.catch,0))) log_c, CONVERT(DECIMAL(15,2),SUM(COALESCE(mc.sp_kg,0))) vms_c, SUM(COALESCE(mc.day_fishing,0)) vms_missing_days INTO #final
FROM    #catch c FULL OUTER JOIN #missing_catch mc ON c.flag_id = mc.flag_id AND c.year = mc.year and c.month = mc.month and c.sp_code = mc.sp_code
GROUP BY COALESCE(c.year,mc.year), COALESCE(c.flag_id,mc.flag_id), COALESCE(c.sp_code,mc.sp_code)

SELECT  f.year, f.flag_id,sp_code,log_c+vms_c tot_c,SUM(COALESCE(e.nb_days,0)) nb_days,vms_missing_days INTO #final2
FROM    #final f LEFT OUTER JOIN #effort e ON e.flag_id = f.flag_id AND e.year=f.year
GROUP BY f.year, f.flag_id,sp_code,log_c, vms_c, vms_missing_days  SELECT 	:group_by,sp_code,SUM(tot_c)/1000 tot_c, CONVERT(DECIMAL(15,2),SUM(nb_days)*100/(SUM(nb_days)+SUM(vms_missing_days))) log_cov
FROM 	#final2
WHERE 	COALESCE(:flag_code,flag_id)=flag_id
GROUP BY :group_by,sp_code","Year"
"99","17f9ab59-1748-43df-aa63-3e0714071de1"," LONGLINE - Missing Logsheets in WCPFC Area - NATIONAL FLEET","year",NA,"Logsheets,VMS",NA,"Live","2.2.1",3059,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Longline, CoverageMissingData, RegionalReporting","2025-05-06T09:41:43.683","SELECT vms_trip_id INTO #mapped_trip FROM (
	SELECT      distinct t.vms_trip_id
	FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
	INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
	(l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
	OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
	OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
	OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
	)
) t

 SELECT  vi.vesselname vessel_name,vi.flag_rg_id,vi.flag_id flag_code,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing  INTO #temp
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
        INNER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='L'
AND		COALESCE(:year, eez.year)=eez.year AND :year between YEAR(vi.start_date) and YEAR(vi.calculated_end_date)
GROUP BY vi.vesselname,vi.flag_rg_id,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name

SELECT *
FROM #temp
WHERE @@entity = 'HIVE' OR flag_code = @@entity",NA
"100","f42ebbbe-0249-4128-a412-26604691518e"," LONGLINE - Full activity in EEZ based on VMS with License check ","flag_code, year","Longline Full activity based on VMS with License check","VMS",NA,NA,"1.2.6",3067,"andrewh@spc.int","colleyf@spc.int","Longline, MyEEZ","2025-10-21T14:25:07.95","SELECT  t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, SUM(eez.day_at_sea) day_at_sea, SUM(eez.day_fishing) day_fishing INTO #mapped_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
		INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year AND eez.eez_code=@@entity
		INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
		INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
AND     day_fishing>1
and     exists(select 1 from tufman2.licence_info where (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) and instance_source = ref.GetBitFromEntity(@@entity)))
GROUP BY t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name,t.return_date, rp.port_name
ORDER BY vi.vesselname,departure_date 

select vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(DECIMAL(6,2),day_fishing) day_fishing, CONVERT(DECIMAL(6,2),day_at_sea) day_at_sea
from #mapped_trip",NA
"101","65c251e3-2769-4a2d-aacb-ee9064153243","LONGLINE - Catches by species in the North / South WCPFC Area","flag_code, year","LONGLINE catches by species in the North / South WCPFC Area","Logsheets",NA,NA,"43",3085,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline","2025-07-16T11:02:57.913"," SELECT  v.flag_id flag_code, 
		case when right(lat,1) = 'N' then 'WCPFC-North' else 'WCPFC_South' end as area,
		sp.sp_name,
                sp.sp_code,
		cast(Sum(case when coalesce(sp_kg_est,0) > coalesce(sp_kg,0) then coalesce(sp_kg_est,0) else coalesce(sp_kg,0) end *1.000) / 1000				as decimal(8,3))	AS sp_mt 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.depart_date BETWEEN v.start_date AND v.calculated_end_date
					inner join ref.species sp on c.sp_code = sp.sp_code
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and v.flag_id	= coalesce(:flag_code,v.flag_id)
  and ref.GetLonD360fromLon(lon) > 115 and ref.GetLonD360fromLon(lon) < 229 
  and not (ref.GetLatDfromLat(lat) > -4 and  ref.GetLonD360fromLon(lon) > 210)
group by v.flag_id,
		case when right(lat,1) = 'N' then 'WCPFC-North' else 'WCPFC_South' end,
		sp.sp_name,
                sp.sp_code",NA
"102","0c50c4f4-f0e8-453f-b25d-7daebfabdacc"," ARTISANAL - Number of trips per FAD","year",NA,"Artisanal",NA,NA,"3.2",3093,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData","2023-03-28T11:23:43.327"," SELECT	:group_by,f.fad_name, l.landing_site_name, COUNT(distinct t.art_trip_id) nb_trips
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		left outer JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
WHERE	COALESCE(:year,YEAR(trip_date))=YEAR(trip_date)
	and        f.visibility & (SELECT ref.GetBitFromEntity(@@entity)) <> 0
GROUP BY :group_by,f.fad_name, l.landing_site_name","Year"
"103","a80145c1-3438-4583-b3ab-262b15c6e8ea"," Part1 - Figure X - Map - LONGLINE COASTAL STATE REPORT - effort by EEZ","year","","Logsheets",2,NA,"10a",3103,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM","2021-10-06T15:15:17.523"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(coalesce(hooks_n, 0))				AS hooks
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
   		INNER JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate)) 
		AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"104","125b19f4-ad36-4771-b7a1-dc544d3ed90c"," ARTISANAL - DUMP - All size data","","Full valid sampled size data","Artisanal",NA,NA,"6.3",3112,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:16:58.793"," SELECT [landing_site_name],      
[skipper_name], cast([trip_date] as date) as trip_date, [fad_fishing], tr.value_en as fish_method_name, art_area_name, 
      max([hours_fished_n]) as hours_fished_n, max([lines_n]) as lines_n, max([fuel_used_n]) as fuel_used_n, max([fuel_type_id]) as fuel_type_id,   
       max([hooks_per_line_n]) as hooks_per_line_n, max([hooks_n]) as hooks_n, 
       max([live_bait_used]) as live_bait_used, c.sp_code, sp.sp_name, sp.sp_sci_name, sd.sp_len, sd.weight, count(*) as freq   
    FROM art2.trips t          
       INNER JOIN  art2.landing_sites ls on t.landing_site_id = ls.landing_site_id        
       INNER JOIN  art2.effort e on t.art_trip_id = e.art_trip_id        
       INNER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)      
       INNER JOIN  art2.areas a on a.art_area_id = e.art_area_id  
       INNER JOIN art2.catch c on    e.art_effort_id = c.art_effort_id
       INNER JOIN  art2.size_data sd on c.art_catch_id = sd.art_catch_id 
	   inner join ref.species sp on sp.sp_code = c.sp_code
    GROUP BY [landing_site_name], [skipper_name], cast([trip_date] as date), e.art_effort_id, [fad_fishing], tr.value_en, art_area_name, c.sp_code, sp.sp_name, sp.sp_sci_name, sp_len, sd.weight
	having sp_len is not NULL",NA
"105","18c2d07d-7eb3-4483-a425-a71600f3a14b","PURSE SEINE - Logsheet coverage - SUMMARY - NATIONAL FLEET ","year","National fleet Purse Seine logsheet coverage - SUMMARY","Logsheets,VMS",NA,NA,"2.1.4",3155,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, CoverageMissingData, RegionalReporting","2024-09-18T16:13:14.187","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing, COUNT(DISTINCT t.vms_trip_id) trips into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT #mapped_trip.vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		ve.gear='S'
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days,
		COUNT(DISTINCT t.log_trip_id) nb_trips INTO #effort
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		s_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id select 
	COALESCE(mt.year,e.year) year,
	COALESCE(mt.flag_id,e.flag_id) flag_id, 
	CONVERT(DECIMAL(10,2),COALESCE(nb_days,0)*100/(COALESCE(day_fishing,0)+COALESCE(nb_days,0))) cov,
	COALESCE(nb_days,0) log_days,
	COALESCE(nb_trips,0) log_trips,
	CONVERT(INT,COALESCE(day_fishing,0)) missing_vms_days,
	COALESCE(trips,0) missing_vms_trips
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year",NA
"106","76febf56-311e-44c8-ae75-a77000ae6ffd"," Part1 - OPTIONAL - Map of LONGLINE CATCH in the Home EEZ (national waters) 1x1","year","Map of LONGLINE CATCH in the Home EEZ (national waters) in 1x1","Logsheets",2,NA,"98a",3180,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM","2021-10-06T15:09:49.06"," SELECT  floor(ref.GetLatDfromLat(lat)/1)*1+0.5 Latitude,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5 Longitude, 
		Sum(case sp_code when 'ALB' then sp_kg_est else 0000 end)				AS alb_kg, 
		Sum(case sp_code when 'BET' then sp_kg_est else 0000 end) 				AS bet_kg, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 0000 end) 				AS yft_kg, 
		Sum(case sp_code when 'BLM' then sp_kg_est else 0000 end) 				AS blm_kg, 
		Sum(case sp_code when 'BUM' then sp_kg_est else 0000 end) 				AS bum_kg, 
		Sum(case sp_code when 'MLS' then sp_kg_est else 0000 end) 				AS mls_kg, 
		Sum(case sp_code when 'SWO' then sp_kg_est else 0000 end) 				AS swo_kg 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/1)*1+0.5 ,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5",NA
"107","d2b99b11-14dc-4593-9993-a7a20090b308"," PURSE SEINE -- SSI Reports from PS-3 form","flag_code, year",NA,"Observer",NA,"Observer","11b",3188,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2025-02-26T14:01:58.607"," SELECT     
		ot.obstrip_id,
        ot.gear_code as gear,
        v.flag_id as flag,
        YEAR(sa.act_date) as trip_year,
        fs.family_name as obsv_family_name,
        fs.first_name as obsv_first_name,
        ot.tripno as observer_trip_id,
        v.vesselname as vessel_name, 
        cast(sa.act_date as date) as date, 
		set_number,
        coalesce(sa.lat,'-') as lat, 
        coalesce(sa.lon,'-') as lon,
        coalesce(sa.eez_code,'-') as eez_code, 
        'PS-3' as form,
        sp.sp_cat_code as sp_cat_cod,
        sp.sp_code as sp_code,
        sp.sp_name as species,
        fate_code,
		coalesce(cond_code,'U') as caught_cond_code,
		coalesce(discard_cond_code,'U') as discard_cond_code,
		case WHEN sc.gr_interact_code is null then 'LANDED' else 'INTERACTION' end as type, 
		coalesce(gr_interact_code,'-') as gear_interaction_code,
		case gr_interact_code 
			when 'INT' then 'Migrated from old GEN2' 
			when 'IEN' then 'Entangled in gear'
			when 'IJO' then 'Jump out over net'
			when 'ICR' then 'Crew released from net'
			when 'IBR' then 'Broke through net'
			when 'IRN' then 'Roped, pulled from net'
			when 'OTH' then 'Other'
			else '-' END  as gear_interaction_desc,
        obs_n as catch_no,
        obs_mt as catch_mt,
        sp_n_est as est_catch_no,
        sp_c_est as est_catch_mt,
		sa.schas_id - 20 as school_assocation_id,
		coalesce(ids.school_association_desc,'Other') as school_assocation
FROM    obsv.trip ot
                inner join  obsv.s_day sd on ot.obstrip_id = sd.obstrip_id
                inner join  obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
                inner join  obsv.s_set ss on ss.s_daylog_id = sa.s_daylog_id
                inner join  obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
                inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                inner join ref.species sp on sc.sp_code = sp.sp_code
                inner join ref.field_staff fs on fs.staff_id = ot.observer_id
				left outer join ref_static.ps_school_associations ids on ids.schas_id = sa.schas_id
WHERE YEAR(sa.act_date) = coalesce(:year,YEAR(sa.act_date))  
AND flag_id = coalesce(:flag_code,flag_id)
AND sp_cat_code in ('MAM','SHK','TTX','BRD','RAY')
AND ot.gear_code = 'S'",NA
"108","83e62bea-dbc4-4aa5-88f5-a7ad00f79367"," WCPFC Convention area Annual Catch Estimates","flag_code, year, gear_code","WCPFC Annual Catch Estimates in the Convention area","",NA,"Live","1",3196,"andrewh@spc.int","benoitp@spc.int","Logsheet, Unraised, Tuna","2025-03-31T08:43:09.477"," SELECT
	t1.FLAG_CODE flag_code,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY year,
	t1.VESS_N,
	SUM(CASE t2.SP_CODE when 'ALB' THEN sp_mt END) as ALB,
	SUM(CASE t2.SP_CODE when 'BET' THEN sp_mt END) as BET,
	SUM(CASE t2.SP_CODE when 'YFT' THEN sp_mt END) as YFT,
	SUM(CASE t2.SP_CODE when 'SKJ' THEN sp_mt END) as SKJ,
	SUM(CASE t2.SP_CODE when 'PBF' THEN sp_mt END) as PBF,
	SUM(CASE WHEN t2.SP_CODE in ('ALB','BET','SKJ','YFT','PBF') THEN sp_mt END) as TUNA,
	SUM(CASE t2.SP_CODE when 'BLM' THEN sp_mt END) as BLM,
	SUM(CASE t2.SP_CODE when 'BUM' THEN sp_mt END) as BUM,
	SUM(CASE t2.SP_CODE when 'MLS' THEN sp_mt END) as MLS,
	SUM(CASE t2.SP_CODE when 'SWO' THEN sp_mt END) as SWO,
	SUM(CASE WHEN t2.SP_CODE in ('BLM','BUM','MLS','SWO') THEN sp_mt END) as MARLIN,
	SUM(CASE t2.SP_CODE when 'OCS' THEN sp_mt END) as OCS,
	SUM(CASE t2.SP_CODE when 'MAK' THEN sp_mt END) as MAK,
	SUM(CASE t2.SP_CODE when 'BSH' THEN sp_mt END) as BSH,
	SUM(CASE t2.SP_CODE when 'THR' THEN sp_mt END) as THR,
	SUM(CASE t2.SP_CODE when 'POR' THEN sp_mt END) as POR,
	SUM(CASE t2.SP_CODE when 'HAM' THEN sp_mt END) as HAM,
	SUM(CASE t2.SP_CODE when 'FAL' THEN sp_mt END) as FAL,
	SUM(CASE WHEN t2.SP_CODE in ('OCS','MAK','BSH','THR','POR','HAM','FAL') THEN sp_mt END) as SHARK
FROM WCPFC_YEARBOOK.dbo.A_ACE t1
INNER JOIN WCPFC_YEARBOOK.dbo.A_ACE_CATCH t2 ON t1.ACE_ID = t2.ACE_ID
LEFT JOIN WCPFC_YEARBOOK.dbo.species S ON t2.SP_CODE = S.sp_code
WHERE OCEAN_CODE = 'WX'
	AND FLAG_CODE = coalesce(:flag_code, FLAG_CODE)
	AND YY = coalesce(:year,YY)
	AND GEAR_CODE = coalesce(:gear_code,GEAR_CODE)
GROUP BY
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY,
	t1.VESS_N",NA
"109","cf913443-b14c-4e9c-b345-a7bd010754d8"," ARTISANAL - FAD Effort in hours per vessel type","",NA,"Artisanal",NA,NA,"8.1",3204,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData","2021-10-07T16:25:50.84"," SELECT	r.region_name,f.fad_name, ref.GetTranslation('ArtisanalVesselPowerModes',v.boat_power_id,'en') boat_type, SUM(e.hours_fished_n) hours
FROM	art2.trips t INNER JOIN art2.vessels v ON t.vessel_id = v.vessel_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f ON f.fad_register_id = e.fad_register_id
		INNER JOIN art2.areas a ON a.art_area_id = f.area_id
		INNER JOIN art2.regions r ON a.region_id = r.region_id
GROUP BY r.region_name,f.fad_name, v.boat_power_id",NA
"110","473fc4c2-e3be-4565-b375-a82001057c84"," CMM 11-03 - Purse seine CETACEAN interactions (Vessel reporting) by NATIONAL FLEET SUMMARY - Interim","flag_code, year","2. CCMs shall require that, in the event that a cetacean is unintentionally encircled in the purse seine net, the master of the vessel shall:
(a) ensure that all reasonable steps are taken to ensure its safe release. This shall include stopping the net roll and not recommencing fishing operation until the animal has been released and is no longer at risk of recapture; and (b) report the incident to the relevant authority of the flag State, including details of the species (if known) and number of individuals, location and date of such encirclement, steps taken to ensure safe release, and an assessment of the life status of the animal on release (including, if possible, whether the animal was released alive but subsequently died).","Logsheets",NA,NA,"29",3222,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CMM, RegionalReporting, ByCatch","2021-11-17T17:02:17.713"," SELECT  vi.flag_id as flag,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        sp.sp_name as species,
		case when catch_ps.sp_n = 0 then 1 else catch_ps.sp_n end as number,
		case when discard=1 then 'Released' else 'Retained' end as fate
FROM    log.trips_ps trip_ps 
            inner join ref.vessel_instances vi 
                    on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_cat_code = 'MAM'",NA
"111","45a4c704-1ece-4064-afbe-a8f80093e272"," TAILS In App Report - FAD CPUE","staff_code","FAD Vs Non FAD Kg per hour (CPUE)","Artisanal",1,NA,"98.4",3262,"andrewh@spc.int","andrewh@spc.int","API","2021-10-13T14:24:12.63","SELECT	CONVERT(VARCHAR,YEAR(t.trip_date)) + '-Q' + CONVERT(VARCHAR,DATEPART(QUARTER,t.trip_date)) quarter,	
		COALESCE(f.fad_name,'NON-FAD') fad_name,				
		CONVERT(DECIMAL(8,2),CONVERT(FLOAT,SUM(c.sp_kg))/SUM(e.hours_fished_n)) CPUE into #t
FROM	art2.trips t JOIN art2.effort e ON t.art_trip_id=e.art_trip_id
		JOIN art2.catch c ON c.art_effort_id=e.art_effort_id
		LEFT JOIN art2.fad_register f ON e.fad_register_id=f.fad_register_id
WHERE	DATEDIFF(MONTH,t.trip_date, CURRENT_TIMESTAMP)<13
AND		t.entered_by=:staff_code
GROUP BY f.fad_name,CONVERT(VARCHAR,YEAR(t.trip_date)) + '-Q' + CONVERT(VARCHAR,DATEPART(QUARTER,t.trip_date))
ORDER BY quarter SELECT	quarter,fad_name,CPUE FROM #t",NA
"112","7cc13469-711d-414f-8587-a93600b51765"," ARTISANAL - Phils Data Dump of Vessel Activity Logs","","Phils Data dump of Vessel Activity logs","Artisanal",NA,NA,"10",3270,"andrewh@spc.int","andrewh@spc.int","Artisanal","2021-10-07T16:07:51.92"," select YEAR (activity_date) as activity_yr, MONTH (activity_date) as activity_mnth, DAY (activity_date) as activity_dy, motor_vessels_n, paddle_vessels_n, sail_vessels_n,
landing_site_name, start_time, end_time, entered_latitude, entered_longitude, t.entered_by, t.entered_date, current_comments
from art2.fishing_activity_log t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id",NA
"113","9e2b7f1d-e8f1-4d76-95ef-a95f0092dc22","BY FLAG and EEZ - VESSEL TRIP Catch Report - HIDDEN as double of c2e3fba6-e28b-4567-8698-a95b01147654","eez_code, flag_code, year",NA,"Logsheets",NA,NA,"13c",3279,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline","2021-09-10T13:13:00.09"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		s.eez_code as eez,
		cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 000.0 end) as int)   AS skj_kg,
		cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) as int)  AS bet_kg, 
		cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end)  as int)    AS yft_kg
from	log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id
		inner join log.catch_ll c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id
and		(s.eez_code = coalesce(:eez_code,s.eez_code) OR (:eez_code = 'KI' and s.eez_code in ('KI','GL','PX','LN')))
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id,s.eez_code",NA
"114","ae4d4d15-8156-4880-be37-a9ad00eaa7c6"," List of EM trips with corresponding Logbooks and Port sampling","year",NA,"Logsheets,Port",NA,"Observer","7a",3292,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, PortSampling, Longline, Emonitoring","2025-06-13T12:47:14.927"," SELECT DISTINCT vi.vesselname
	,em.obsprg_code
	,st.staff_code
	,em.tripno
	,convert(CHAR(10), em.dep_date, 103) AS em_dep_date
	,convert(CHAR(10), em.ret_date, 103) AS em_ret_date
	,convert(CHAR(10), lt.depart_date, 103) AS log_dep_date
	,convert(CHAR(10), lt.return_date, 103) AS log_ret_date
	,convert(CHAR(10), pl.sample_date, 103) AS sample_date
FROM em.trip em
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=em.vessel_id
	AND em.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = em.vessel_id
	AND em.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.port.samples pl ON pl.vessel_id = em.vessel_id
	AND pl.sample_date BETWEEN em.ret_date AND em.ret_date + 3
inner join ref.field_staff st on st.staff_id=em.observer_id
WHERE COALESCE(:year,year(em.dep_date)) = year(em.dep_date)",NA
"115","2225efc7-c03c-40b6-b38b-aa2a00fe31b2"," List of NATIONAL FLEET Vessels (Flag of Registration and Charters) - based on VMS activity ONLY","flag_code, year",NA,"VMS",NA,NA,"0b",3306,"andrewh@spc.int","brunod@spc.int","ByVessel, RegionalReporting","2021-10-26T12:02:03.477"," SELECT DISTINCT g.[gear_desc]
      ,vin.[vesselname] vessel_name
      ,[flag_id] flag_code
      ,[flag_rg_id]
      ,case when flag_id <> flag_rg_id then 'CHARTERED' else 'FLAG of REGISTRATION' end as status
      ,[start_date]
      ,[end_date]
      ,vin.calculated_end_date
      ,[ffa_vid]
      ,[uvi]
	  ,v.grt
      , LEFT(v.[vessel_id],38) as VesselDTO
  FROM [ref].[vessels] v
			inner join [ref].[vessel_instances] vin on v.vessel_id = vin.vessel_id
			inner join [ref].[gears] g on v.gear = g.gear_code
			left outer join vms.vms_trips vms on v.vessel_id = vms.vessel_id
  WHERE   coalesce(v.is_active,0) = 1
AND (@@entity = 'HIVE' OR vin.flag_id = @@entity)
      AND year(vin.start_date) <= coalesce(:year, year(vin.start_date))
      AND year(vin.calculated_end_date) >= coalesce(:year, year(vin.calculated_end_date))
	  AND (
			year(vms.departure_date) = coalesce(:year, year(vms.departure_date)) 
	 )",NA
"116","8ecd2f8a-0e7f-4779-be9a-aa5000ff9e42"," PURSE SEINE - VESSEL Catch Report - BY FLAG (Date Selection)","flag_code, date_from, date_to",NA,"Logsheets",NA,NA,"13e",3312,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2021-10-19T16:17:14.087"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name,
		count(distinct t.log_trip_id) as trips,
        COUNT(distinct case when s_activity_id in (1,2) then cast(t.vessel_id as nvarchar(50)) + cast(cast(logdate as date) as varchar(10))  else null end) as days,
		Sum(case when sp_code in ('SKJ','YFT','BET') and discard = 0 then sp_mt_est else 0000.0 end)   AS tot_mt_ret,
		Sum(case when sp_code in ('SKJ','YFT','BET') and discard = 1 then sp_mt_est else 0000.0 end)   AS tot_mt_disc
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where   
		logdate >= :date_from
and 	logdate <= :date_to 
and		COALESCE(:flag_code,vi.flag_id) =vi.flag_id
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.vesselname, vi.flag_id",NA
"117","1c7b53bf-1e4e-4d59-b662-aa7f010974b7"," CMM 18-03 - Hook count for seabird report","year","Hook count for the seabird report on table X for CMM 18-03","Logsheets,VMS",NA,NA,"45",3318,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2023-04-05T08:51:26.607","SELECT distinct vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
						 INNER JOIN log.sets_ll s on l.log_trip_id = s.log_trip_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate)
    WHERE in_wcpfc_area = 1
) t

SELECT  vi.flag_id,eez.year,COUNT(DISTINCT t.vms_trip_id) as trips,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
		
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND		vi.flag_id = @@entity
AND		ve.gear='L'
and     exists(select 1 from tufman2.licence_info where (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) and instance_source = ref.GetBitFromEntity(@@entity)))
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		l_activity_id = 1
AND		vi.flag_id = @@entity
AND		in_wcpfc_area = 1
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id;


with #coverage as (select 
	COALESCE(mt.year,e.year) year,
	COALESCE(mt.flag_id,e.flag_id) flag_id, 
	CONVERT(INT,COALESCE(trips,0)) vms_trips,
	CONVERT(DECIMAL(10,2),COALESCE(nb_days,0)*100/(COALESCE(day_fishing,0)+COALESCE(nb_days,0))) cov,
	COALESCE(nb_days,0) log_days,
	CONVERT(INT,COALESCE(day_fishing,0)) vms_days
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year)

 select year(logdate) as year,
	vi.flag_id,
	cov as coverage,
	sum(hooks_n) as NumHooks,
	round(sum(s.hooks_n) / cov.cov * 100, 0) as RaisedHooks
from log.trips_ll t
	inner join log.sets_ll s on s.log_trip_id = t.log_trip_id
	inner join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and logdate between vi.start_date and vi.calculated_end_date
	inner join #coverage cov on cov.year = year(logdate) and cov.flag_id = vi.flag_id
group by 
	year(logdate),
	vi.flag_id,
	cov",NA
"118","19aaaa89-7fb0-4d0c-848e-aac600fa237d"," Total Catch by Vessel by Month","year","Total Catch by vessels","Logsheets",NA,NA,"9",3324,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ","2023-10-12T13:51:43.79"," select

	v.vesselname,
	month(s.logdate) as month,
	Year(s.logdate) as year,
	sum(s.hooks_n) as Tot_hks,
	sum(c.sp_kg) as Tot_kg,
	sum(c.sp_n) as Tot_no,
	s.eez_code

from log.trips_ds t


	join log.sets_ds S on t.log_trip_id = S.log_trip_id

	join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.species sp on c.sp_code = sp.sp_code

	join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date

where Year(s.logdate) = :year
	AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))


Group by v.vesselname, 
	month(s.logdate),
	Year(s.logdate),
	 s.eez_code",NA
"119","8144350b-dfdf-4ffb-b217-aad8010c3618"," ARTISANAL - Data collector report - tally of number of fish/inverts samples and num of logsheets","year, date_from, date_to","Requested by Tuvalu, this report shows a report from logsheets collected of the data collectors for the fortnight, and a summary of catch","Artisanal",NA,NA,"99",3330,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, AllSpecies","2021-10-06T15:56:55.943"," select min(t.return_date) as start_date,
	max(t.return_date) as end_date,
	t.entered_by,
	count(t.art_trip_id) as num_samples,
	sum(case when tp.value_en = 'trolling' then c.sp_n else 0 end) as trolling_catch_num_fish,
	sum(case when tp.value_en <> 'trolling' and sp.sp_cat_code <> 'INV' then c.sp_n else 0 end) as non_trolling_catch_num_fish,
	sum(case when sp.sp_cat_code = 'INV' then c.sp_n else 0 end) as inv_catch_num
from art2.trips t
	inner join art2.effort e on e.art_trip_id = t.art_trip_id
	left outer join art2.catch c on c.art_effort_id = e.art_effort_id
	LEFT OUTER JOIN tuf2.translations tp ON tp.translation_key = 'LookupList_ArtisanalFishingMethods' + CONVERT(VARCHAR,e.fish_method_id)
	inner join ref.species sp on sp.sp_code = c.sp_code
where year(t.return_date) = coalesce(:year, year(t.return_date))
	and t.return_date > :date_from
	and t.return_date < :date_to
group by t.entered_by",NA
"120","b5123ecb-300d-4d33-adcc-a6e3009b40ba"," LONGLINE Observer Trip -- Summary","trip_id","A Summary of information from the selected LONGLINE observer trip","Observer",NA,"Observer","17",3143,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2025-04-30T09:45:08.353"," SELECT  staff_code as staff, 
		tripno as tripno, 
		vesselname as vessel,
		convert(date,dep_date,103) as dep_date,
		convert(date,ret_date,103) as ret_date,
		min(convert(date,set_date,103)) as mn_set_date, 
		max(convert(date,set_date,103)) as mx_set_date,
		count(distinct ls.l_set_id) as sets,
		SUM(cast(bask_set as bigint)) as bask,
		SUM(cast(bask_observed as bigint)) as bask_obsv,
		SUM(cast(hook_set as bigint)) as hook_set,
		SUM(cast(bask_observed as bigint)*cast(hk_bt_flt as bigint)) as hook_obsv,
		MIN(cast(hook_set as bigint)) as mn_hk_set, 
		MAX(cast(hook_set as bigint)) as mx_hk_set, 
		MIN(cast(hk_bt_flt as bigint)) as mn_hk_bt_flt, 
		MAX(cast(hk_bt_flt as bigint)) as mx_hk_bt_flt, 
		avg(cast(hk_bt_flt as bigint)) as avg_hk_bt_flt,
		SUM(case when sp_code = 'YFT' then 0001 else 0000 end) as yft,
		SUM(case when sp_code = 'BET' then 0001 else 0000 end) as bet,
		SUM(case when sp_code = 'ALB' then 0001 else 0000 end) as alb,
		SUM(case when sp_code in ('ALB','YFT','BET') then 0000 else 0001 end) as others
FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join ref.field_staff f on f.staff_id=ot.observer_id
			left outer join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
WHERE LEFT(:trip_id,3)=RTRIM(staff_code) and RIGHT(:trip_id,5)=RTRIM(tripno)
  and not (coalesce(bask_set,0) < bask_observed)
  and coalesce(bask_set,0) > 0
  and coalesce(bask_observed,0) > 0
  and coalesce(hook_set,0) > 0
  and coalesce(hk_bt_flt,0) > 0
group by staff_code, 
		tripno, 
		vesselname,
		convert(date,dep_date,103),
		convert(date,ret_date,103)",NA
"121","c45a5ed2-5e43-4318-b362-ab0300a4cb0f"," MSC - Total Catch by Vessel and trip","flag_code, year","Report for MSC process - Number of catch by vessel and trip - Weights are estimated","Observer",NA,"Observer","86",3338,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2024-06-28T11:16:57.93"," select vesselname,flag_id,t.dep_date,sc.sp_code,sp.sp_cat_code,sp.sp_name,
SUM(case when LEFT(sc.fate_code,1)='R' then 1 else 0 end) as Retained_Number,
SUM(case when LEFT(sc.fate_code,1)='D' then 1 else 0 end) as Discarded_Number,
SUM(case when LEFT(sc.fate_code,1)='R' then wt_est else 0.0 end) as Retained_Weight,
SUM(case when LEFT(sc.fate_code,1)='D' then wt_est else 0.0 end) as Discarded_Weight,
case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end as Discarded_fate_code
from obsv.trip t 
join obsv.l_set s on s.obstrip_id = t.obstrip_id
join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sp.sp_code = sc.sp_code
left join ref_static.fate_codes f on f.fate_code = sc.fate_code
where YEAR(t.dep_date) = coalesce(:year, year(t.dep_date)) 
and flag_id=coalesce(:flag_code,flag_id)
group by vesselname,flag_id,t.dep_date,sc.sp_code,sp.sp_cat_code,sp.sp_name,case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end",NA
"122","1b22d811-6f34-44c7-a722-ab0a011ed80e"," All species catch and effort - source logsheets - cpue kg/hk/hr","eez_code, min_year, max_year",NA,"Logsheets",NA,NA,"1a",3351,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, Raised","2023-10-12T13:59:36.957"," Select
	v.vesselname,
	t.trip_no,
	convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103)  as departure_date,
	convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103)  as return_date,
	COUNT(distinct cast(t.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
	convert(nvarchar(10),s.logdate, 103) as set_date,
	
	ref.getLatDfromLat(s.lat) as latitude, 
	ref.getLonDfromLon(s.lon) as longitude, 
	s.eez_code, 
	s.hooks_n, 
	s.hours_n, 


		cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))												AS pfm_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0 else cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS pfm_cpue, 
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))												AS pfm_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'PFM' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS pfm_npue,
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lwf_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_cpue, 
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))												AS lwf_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_npue, 
	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS etc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS etc_cpue, 
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))												AS etc_n, 
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_n else 000.0 end)  /hooks_n / hours_n as decimal(6,2)) end			AS etc_npue, 
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eta_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS eta_cpue, 
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))												AS eta_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eta_npue, 
	 
	cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eep_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS eep_cpue, 
	cast(Sum(case sp_code when 'EEP' then sp_n else 0 end)							as decimal(7,0))												AS eep_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eep_npue, 

	cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ewo_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS ewo_cpue, 
	cast(Sum(case sp_code when 'EWO' then sp_n else 0 end)							as decimal(7,0))												AS ewo_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS ewo_npue, 

	cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhi_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhi_cpue, 
	cast(Sum(case sp_code when 'LHI' then sp_n else 0 end)							as decimal(7,0))												AS lhi_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhi_npue, 

	cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhb_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhb_cpue, 
	cast(Sum(case sp_code when 'LHB' then sp_n else 0 end)							as decimal(7,0))												AS lhb_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhb_npue, 


	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))												AS arq_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_cpue, 
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))												AS arq_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_npue, 
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lrk_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_cpue, 
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))												AS lrk_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_npue,
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS bwa_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_cpue, 
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))												AS bwa_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_npue,
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ytc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_cpue, 
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))												AS ytc_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_npue,
	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))												AS sey_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS sey_cpue, 
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))												AS sey_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS sey_npue,

	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0 
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0			
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0
						 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n,
	ref.GetEntityFromBit(t.instance_source) as country
	

from log.trips_ds t
	inner join log.sets_ds S on t.log_trip_id = S.log_trip_id
	inner join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.vessel_instances V on t.vessel_id = v.vessel_id  and t.return_date between v.start_date and v.calculated_end_date


  
 WHERE year(logdate) >= coalesce(:min_year, year(logdate)) 
  and year(logdate) <= coalesce(:max_year, year(logdate))  
  and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))

Group by v.vesselname, 
		t.trip_no,
		convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103),
		convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103), 
		s.logdate,
		ref.getLatDfromLat(s.lat), 
		ref.getLonDfromLon(s.lon), 
		s.eez_code,
		s.hooks_n, 
		s.hours_n,
		ref.GetEntityFromBit(t.instance_source)",NA
"123","870a80ad-cce4-4cb6-b5a0-ab5d00b0233c"," LONGLINE - Vessel set catch - BY FLAG","flag_code, year","BY FLAG - VESSEL TRIP Catch by species and set","Logsheets",NA,NA,"13d",3375,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, MyEEZ, Raised, AllSpecies","2023-09-01T10:13:13.723"," SELECT v.flag_id flag_code, 
		v.vesselname vessel_name,
		CONVERT(NVARCHAR(10),logdate, 103) AS log_date, 
		lat latitude,
		lon longitude,
		sp_code species_code,
		CAST(SUM(sp_kg_est) / 1000.000 AS DECIMAL(6,3))	AS metric_tonnes, 
		CAST(SUM(sp_n_est) AS DECIMAL(6)) AS num_caught,
		CAST(SUM(spdiscard_n) AS DECIMAL(6)) AS num_discarded
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
   		JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		JOIN ref.vessel_instances v ON t.vessel_id = v.vessel_id AND t.depart_date BETWEEN v.start_date AND v.calculated_end_date
WHERE	YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
AND	v.flag_id	= COALESCE(:flag_code,v.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY v.flag_id,
		v.vesselname,
		CONVERT(NVARCHAR(10),logdate, 103), 
		lat,
		lon,
		eez_code, 
		sp_code",NA
"124","5907572e-518c-4d21-87dd-ac0600faa91c"," LONGLINE -- Individual tuna catch","flag_code, year","YEAR, FLAG, EEZ, SPECIES, FATE and LEN","Observer",NA,"Observer","25",3399,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-03-28T14:08:19.817"," SELECT	
			YEAR(set_date) as yr,
			vesselname,
            flag_id as flag,
            eez_code as eez, 
            sp.sp_code,
            sp.sp_name as species,
            lc.fate_code as fate_code, 
            f.fate_desc as fate_desc,
			len,
			lec.len_code,
			lec.len_desc

 FROM obsv.trip ot 
                  inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                  inner join  obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
                  inner join  obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
                  inner join  obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
                  inner join ref.species sp on lc.sp_code = sp.sp_code
                  inner join ref_static.fate_codes f on lc.fate_code = f.fate_code
				  left join ref_static.length_codes lec on lec.len_code = lc.len_code
WHERE YEAR(set_date)          = coalesce(:year, YEAR(set_date))
      AND flag_id    = coalesce(:flag_code,flag_id)
	  AND sp_cat_code='TUN'",NA
"125","c6f8c648-ce1b-4f5c-ab54-ac2300dbfdb5"," Gen 3 comments","flag_code, year, obsv_prg, staff_code","Comments from GEN3 form","Observer",NA,"Observer","7",3408,"andrewh@spc.int","colleyf@spc.int","Observer, Compliance","2021-11-15T17:38:22.967"," select year(dep_date) as year, dep_date,obsprg_code,gear_code,staff_code,tripno,vesselname,flag_id,ffa_vid,gen3_date,question_code,
REPLACE(g.comments,CHAR(10),';') as comments
from obsv.gen3vr09details g join obsv.trip ot on g.obstrip_id = ot.obstrip_id
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
Where year(dep_date) = coalesce(:year, year(dep_date))
AND obsprg_code = COALESCE(:obsv_prg,obsprg_code)
AND flag_id    = coalesce(:flag_code,flag_id)
AND staff_code    = coalesce(:staff_code,staff_code)",NA
"126","03991891-da31-40fe-b061-ac54011f118e"," LONGLINE - Observer vs Unloadings vs Logsheet Catch Comparison","year","Built for FJ fisheries, compares logsheet catch to unloadings catch and observer catch","Logsheets,Observer,Port",NA,NA,"46",3414,"andrewh@spc.int","colleyf@spc.int","Logsheet, Observer, Unloading, Custom","2021-11-05T14:16:53.843","
WITH #logcatch as (SELECT	vi.vesselname,
		vi.flag_id,
		CONVERT(nvarchar,t.depart_date,111) depart_date,
		cast(Sum(case c.sp_code when 'ALB' then c.sp_n else 000.0 end)  				as decimal(7,2))	AS log_alb,
		cast(Sum(case c.sp_code when 'YFT' then c.sp_n else 000.0 end)  				as decimal(7,2))	AS log_yft, 
		cast(Sum(case c.sp_code when 'BET' then c.sp_n else 000.0 end)  				as decimal(7,2))	AS log_bet,
		cast(Sum(c.sp_n)   														as decimal(7,2)) 	AS log_tot,
		t.log_trip_id LonglineLogsheetDTO,l.dto_guid_right LonglineUnloadingDTO,l2.dto_guid_right ObserverTripDTO
FROM	log.trips_ll t LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO'  AND l.dto_type_right='UnloadingDTO'
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO'  AND l2.dto_type_right='ObserverTripDTO'
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN log.sets_ll s on s.log_trip_id = t.log_trip_id
		LEFT OUTER JOIN log.catch_ll c on c.log_set_id = s.log_set_id
WHERE 	COALESCE(:year, YEAR(t.depart_date)) = YEAR(t.depart_date)
group by vesselname, flag_id, depart_date, t.log_trip_id,l.dto_guid_right,l2.dto_guid_right),

#unlcatch as (Select unl.unload_id,
	cast(Sum(case c.sp_code when 'ALB' then sp_n else 000.0 end)  				as decimal(7,2))	AS unl_alb,
	cast(Sum(case c.sp_code when 'YFT' then sp_n else 000.0 end)  				as decimal(7,2))	AS unl_yft, 
	cast(Sum(case c.sp_code when 'BET' then sp_n else 000.0 end)  				as decimal(7,2))	AS unl_bet,
	cast(Sum(sp_n) 														as decimal(7,2)) 	AS unl_tot
from unload2.unloadings unl inner join unload2.unloading_catch c on c.unload_id = unl.unload_id
group by unl.unload_id),

#obscatch as (
	SELECT ot.obstrip_id, 
		staff_code as staff, 
		tripno as tripno, 
		vesselname as vessel,
		convert(date,dep_date,103) as dep_date,
		convert(date,ret_date,103) as ret_date,
		count(distinct ls.l_set_id) as sets,
		SUM(cast(bask_set as bigint)) as bask,
		SUM(cast(bask_observed as bigint)) as bask_obsv,
		SUM(cast(hook_set as bigint)) as hook_set,
		SUM(cast(bask_observed as bigint)*cast(hk_bt_flt as bigint)) as hook_obsv,
		SUM(case when sp_code = 'YFT' then 0001 else 0000 end) as obs_yft,
		SUM(case when sp_code = 'BET' then 0001 else 0000 end) as obs_bet,
		SUM(case when sp_code = 'ALB' then 0001 else 0000 end) as obs_alb,
		SUM(1) as obs_tot
FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join ref.field_staff f on f.staff_id=ot.observer_id
			left outer join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
WHERE not (coalesce(bask_set,0) < bask_observed)
  and coalesce(bask_set,0) > 0
  and coalesce(bask_observed,0) > 0
  and coalesce(hook_set,0) > 0
  and coalesce(hk_bt_flt,0) > 0
group by ot.obstrip_id, staff_code, 
		tripno, 
		vesselname,
		convert(date,dep_date,103),
		convert(date,ret_date,103)
)

 select vesselname,
	flag_id,
	depart_date,
	l.LonglineLogsheetDTO,
	l.LonglineUnloadingDTO,
	l.ObserverTripDTO,
	log_tot,
	unl_tot,
	obs_tot,
	log_alb,
	unl_alb,
	obs_alb,
	log_yft,
	unl_yft,
	obs_yft,
	log_bet,
	unl_bet,
	obs_bet
from #logcatch l full join #unlcatch u on l.LonglineUnloadingDTO = u.unload_id
	full join #obscatch o on l.ObserverTripDTO = o.obstrip_id
where log_tot is not NULL and unl_tot is not null and obs_tot is not null",NA
"127","a72e4c22-0a12-4e80-88af-ad4400fc7220"," PURSE SEINE - All Species Catch by EEZ - BY VESSEL","eez_code, year","BY FLEET - All Species Catch in the WCPFC Area","Logsheets",NA,NA,"12b",3431,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting, AllSpecies","2021-11-05T14:14:18.41"," SELECT  vi.flag_id flag_code, 
		vi.vesselname vessel_name,
		:group_by, 
		sp.sp_name,
		cast(SUM(coalesce(c.sp_mt_est,000)) as decimal(9,3)) as catch 
FROM	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.species sp on sp.sp_code = c.sp_code

WHERE year(logdate) = coalesce(:year, year(logdate))
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
  and (s.eez_code = coalesce(:eez_code,s.eez_code) OR (:eez_code = 'KI' and s.eez_code in ('KI','GL','PX','LN')))
  and s.s_activity_id in (1,2) 
group by vi.flag_id,
		vi.vesselname,
		:group_by,
		sp.sp_name","Year"
"128","d0ac5d5e-e208-45ea-ad5e-ad6a0087b0cb"," DQ3b - LONGLINE logsheet - EMPTY trips","flag_code, year","Longline empty trips for a chosen entered year (or all years) - Trips listed have at minimum been entered 6 month ago","",NA,NA,"1",3440,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, DataQuality","2022-03-31T14:12:46.03"," SELECT ref.GetEntityFromBit(t.instance_source) as source, 
    t.system_source,
    year(first_logdate) as yy, 
    v.flag_id, v.vesselname, 
    convert(varchar, first_logdate, 23) as firstdate, 
    convert(varchar, last_logdate, 23) as lastdate,
    CONVERT(VARCHAR, t.entered_date, 23) AS trip_enter_date,
		'https://www.spc.int/ofp/tufman2/data/LonglineLogsheet/'+convert(varchar(36),t.log_trip_id) as trip_link,
    CONVERT(int,getdate()-t.entered_date) as days_since_entry,
    t.log_trip_id as LonglineLogsheetDTO
FROM log.vw_trips_ll_HIVE  t
    INNER JOIN ref.vessel_instances v ON v.vessel_id = t.vessel_id AND t.first_logdate BETWEEN v.start_date AND v.calculated_end_date
WHERE year(t.first_logdate) = coalesce(:year, year(t.first_logdate)) 
        and year(t.first_logdate)>2010
        and v.flag_id = COALESCE(:flag_code,v.flag_id)
	and t.log_trip_id not in (select distinct log_trip_id from log.sets_ll)
",NA
"129","03869603-b8b6-40d6-ac50-ac6f0100544c"," LONGLINE - Compliance - Telex (position reports) vs Logsheet report","flag_code, year","Checks the catch declared between ZENT and ZDEP and matches to logsheet records for LONGLINE catch","Logsheets",NA,NA,"106",3415,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, ByVessel, Compliance, Custom, Tuna","2023-08-31T12:54:27.66","with #t as (
  Select vessel_id,
	rpt_code,
	telex_date,
	alb_mt,
	yft_mt,
	bet_mt
  FROM [pos].[position_reports]
  where alb_mt is not null
	and system_source = 'Tufman2'
	and vessel_id is not null
	and rpt_code in ('ZENT','ZDEP')),



#firstpairs as (Select vessel_id,
	rpt_code,
	telex_date,
	alb_mt,
	yft_mt,
	bet_mt,
	lead(vessel_id) over (order by vessel_id, telex_date ASC) as nxt_vessel,
	lead(rpt_code) over (order by vessel_id, telex_date ASC) as nxt_code,
	lead(telex_date) over (order by vessel_id, telex_date ASC) as nxt_date,
	lead(alb_mt) over (order by vessel_id, telex_date ASC) - alb_mt as alb_change,
	lead(yft_mt) over (order by vessel_id, telex_date ASC) - yft_mt as yft_change,
	lead(bet_mt) over (order by vessel_id, telex_date ASC) - bet_mt as bet_change
from #t),

#logdata as (Select vessel_id,
	logdate,
	cast(Sum(case c.sp_code when 'YFT' then sp_kg else 000.0 end) /1000			as decimal(9,2))	AS log_yft_mt, 
	cast(Sum(case c.sp_code when 'BET' then sp_kg else 000.0 end) /1000			as decimal(9,2))	AS log_bet_mt,
	cast(Sum(case c.sp_code when 'ALB' then sp_kg else 000.0 end) /1000			as decimal(9,2))	AS log_alb_mt 
from log.trips_ll t
	inner join log.sets_ll s on s.log_trip_id = t.log_trip_id
	left outer join log.catch_ll c on  c.log_set_id = s.log_set_id
group by vessel_id, logdate),


#realpairs as (select *
from #firstpairs
where rpt_code = 'ZENT'
	and nxt_date > telex_date),

#subtotals as (select F.vessel_id,
	F.telex_date,
	F.nxt_date,
	avg(f.alb_change) as declared_alb,
	sum(l.log_alb_mt) as logsheet_alb,
	avg(f.yft_change) as declared_yft,
	sum(l.log_yft_mt) as logsheet_yft,
	avg(f.bet_change) as declared_bet,
	sum(l.log_bet_mt) as logsheet_bet
from #realpairs f left outer join #logdata l on f.vessel_id = l.vessel_id and l.logdate between f.telex_date and f.nxt_date
group by f.vessel_id, f.telex_date, f.nxt_date)

 select vi.vesselname vessel_name,
	vi.flag_id flag_code,
	convert(varchar, telex_date, 103) telex_date,
	convert(varchar, nxt_date, 103) nxt_date,
	declared_alb,
	logsheet_alb,
	(logsheet_alb - declared_alb) as alb_diff_telex_from_log,
	declared_yft,
	logsheet_yft,
	(logsheet_yft - declared_yft) as yft_diff_telex_from_log,
	declared_bet,
	logsheet_bet,
	(logsheet_bet - declared_bet) as bet_diff_telex_from_log
from #subtotals s
	inner join ref.vessel_instances vi on vi.vessel_id = s.vessel_id and s.telex_date between vi.start_date and vi.calculated_end_date
where year(telex_date) = coalesce(:year,year(telex_date))
and vi.flag_id = coalesce(:flag_code,vi.flag_id)",NA
"130","36782580-b2ac-4221-aacf-ac7e00f23f51"," API: FFA - Detailed PURSE SEINE tuna catches since 2010 in a given FFA country EEZ","eez_code","Detailed PURSE SEINE tuna catches since 2010 in a given FFA country EEZ, by vessel, set date and position","Logsheets",NA,NA,"999b",3418,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, API","2022-08-16T11:06:42.537"," SELECT			VI.vesselname, VI.ffa_vid, VI.ircs, VI.flag_id, 
                S.logdate AS set_date,
				lat, lon, S.latd, S.lond,
				s.eez_code,
				CASE WHEN S.school_id between 1 and 2 then 'Free School'  WHEN S.school_id between 3 and 9 then 'Associated ' END as school,
                CASE WHEN C.SP_CODE='BET' THEN C.SP_MT ELSE 0000.000 END  AS bet,
                CASE WHEN C.SP_CODE='SKJ' THEN C.SP_MT ELSE 0000.000 END  AS skj,
                CASE WHEN C.SP_CODE='YFT' THEN C.SP_MT ELSE 0000.000 END  AS yft,
                CASE	WHEN (C.SP_CODE <> 'BET' AND C.SP_CODE <> 'SKJ' AND C.SP_CODE <> 'YFT') THEN C.SP_MT ELSE 0000.000 END AS oth
FROM log.trips_ps T 
				inner join log.sets_ps S on T.LOG_TRIP_ID = S.LOG_TRIP_ID
				inner join ref.vessel_instances VI on T.vessel_id = VI.vessel_id and S.logdate between vi.start_date and vi.calculated_end_date
                LEFT OUTER JOIN log.catch_ps C ON S.LOG_SET_ID = C.LOG_SET_ID
WHERE
                COALESCE(:eez_code, S.eez_code)= S.eez_code
                AND YEAR (S.logdate ) BETWEEN 2010 AND Year(getdate()) 
                AND S.s_activity_id = 1",NA
"131","4a27618e-4a78-4e52-a73b-acbf00b48aeb"," DEBRIEFING - PS Score Summary by Year and Flag","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","2",3421,"andrewh@spc.int","colleyf@spc.int","Debriefing, Observer","2024-11-21T14:58:52.93"," SELECT 
        d.debriefer_obsprg_code AS debriefer_obsprg_code,
		f.staff_code AS staff_code,
        'T'+d.tripno AS tripno,
		v.vesselname AS vesselname,
        v.flag_id AS flag, 
		d.gear_code AS gear_code,
		CONVERT(VARCHAR, d.dep_date, 106) AS depart_date,
        CONVERT(VARCHAR, d.ret_date, 106) AS return_date,
		DATEDIFF(D,d.dep_date, d.ret_date)+1 AS trip_days,
		DATEDIFF(DAY,d.ret_dtime,d.debrief_start_dtime) AS waiting_debrief_days,
		CONVERT(VARCHAR, d.debrief_start_dtime, 113) AS debrief_start,
        CONVERT(VARCHAR, d.debrief_end_dtime, 113) AS debrief_end,
		DATEDIFF(HOUR,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_hrs,
		DATEDIFF(DAY,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_days,
		fs.staff_code AS debriefer_code,
		SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END) AS response_score,
        SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) AS ps_score,
        ROUND(SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END)*1.0 / CASE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) WHEN 0 THEN 1 ELSE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) END  *100.0,1) AS ps_pct

  FROM obsv.debrief d
        INNER JOIN ref.vessel_instances v on d.vessel_id = v.vessel_id and d.dep_date between v.start_date and v.calculated_end_date
        INNER JOIN ref.field_staff f on f.staff_id= d.observer_id
		INNER JOIN ref.field_staff fs on d.debriefer_id = fs.staff_id
        INNER JOIN obsv.debrief_answer a on a.debrief_id=d.debrief_id
        INNER JOIN obsv.debrief_question q on q.debrief_question_id = a.debrief_question_id
        LEFT JOIN ref_static.debrief_categories c on c.id = ps_score_category_code

  WHERE YEAR(d.dep_date) = coalesce(:year, YEAR(d.dep_date))
  AND v.flag_id = coalesce(:flag_code,v.flag_id)
  AND d.debriefer_obsprg_code = coalesce(:obsv_prg,d.debriefer_obsprg_code)
  AND d.system_source = 'Tufman2' 
  AND d.gear_code = 'S'
  AND response is not null

GROUP BY d.debriefer_obsprg_code,
		 f.staff_code,
         d.tripno,
		 v.vesselname,
         v.flag_id, 
	 	 d.gear_code,
		 d.dep_date,
		 d.ret_date,
		 d.ret_dtime,
		 d.debrief_start_dtime,
		 d.debrief_end_dtime,
		 fs.staff_code",NA
"132","f2331b55-bb35-4f52-9884-abe400c97859"," IATTC Area -- TASK II -- LONGLINE Catch and effort (1x1) CATCH WEIGHTS","year","Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (1x1 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32f",3397,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-25T07:59:49.853","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
        floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat))+0.5,
         floor(ref.GetLonDfromLon(lon))+0.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
            floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips, 
			COUNT(distinct s.log_set_id) as sets, 
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.GetLatDfromLat(lat))+0.5 = cte.latitude
                                                        and floor(ref.GetLonDfromLon(lon))+0.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  and s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat))+0.5,floor(ref.GetLonDfromLon(lon))+0.5, FORMAT(logdate, 'yyyy-MM')",NA
"133","35bd1d18-08c3-419a-b3c3-acc50108526d"," DEBRIEFING - LL Score Details by Year and Flag","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","5",3424,"andrewh@spc.int","colleyf@spc.int","Debriefing, Observer","2022-03-21T08:21:51.477"," SELECT 
x.debriefer_obsprg_code AS debriefer_obsprg_code,
x.staff_code AS staff_code,
x.tripno AS tripno,
x.vesselname AS vesselname,
x.flag AS flag, 
x.gear_code AS gear_code,
x.depart_date AS depart_date,
x.return_date AS return_date,
x.trip_days AS trip_days,
x.waiting_debrief_days AS waiting_debrief_days,
x.debrief_start AS debrief_start,
x.debrief_end AS debrief_end,
x.debrief_hrs AS debrief_hrs,
x.debrief_days AS debrief_days,
x.debriefer_code AS debriefer_code,
x.summary_details AS summary_details,
SUM(x.response_score) AS response_score,
SUM(x.ll_score) AS ll_score,
CASE WHEN SUM(x.response_score) <> 0 THEN CAST(ROUND( CAST(SUM(coalesce(x.response_score,0)) AS decimal(5,2)) / CAST(SUM(coalesce(x.ll_score,0)) AS decimal(5,2)) *100.0,2) AS decimal(5,2))
     ELSE 0 END AS ll_pct
FROM (

  SELECT 
        d.debriefer_obsprg_code AS debriefer_obsprg_code,
		f.staff_code AS staff_code,
        d.tripno AS tripno,
		v.vesselname AS vesselname,
        v.flag_id AS flag, 
		d.gear_code AS gear_code,
		CONVERT(VARCHAR, d.dep_date, 106) AS depart_date,
        CONVERT(VARCHAR, d.ret_date, 106) AS return_date,
		DATEDIFF(D,d.dep_date, d.ret_date)+1 AS trip_days,
		DATEDIFF(DAY,d.ret_dtime,d.debrief_start_dtime) AS waiting_debrief_days,
		CONVERT(VARCHAR, d.debrief_start_dtime, 113) AS debrief_start,
        CONVERT(VARCHAR, d.debrief_end_dtime, 113) AS debrief_end,
		DATEDIFF(HOUR,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_hrs,
		DATEDIFF(DAY,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_days,
		fs.staff_code AS debriefer_code,

		CASE WHEN ll_score_category_code IN (1) THEN '1. Header details' 
               WHEN ll_score_category_code IN (39,40,41,42,43) THEN '2. Total score (LL forms 1 to 4)'
			   WHEN ll_score_category_code IN (2,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34) THEN '3. GEN and tag recovery forms'
			   WHEN ll_score_category_code IN (35) THEN '4. Written report score'
			   WHEN ll_score_category_code IN (36) THEN '5. Journal score'
			   WHEN ll_score_category_code IN (37,38) THEN '6. Data presentation / submission'
          ELSE '7. Others' END AS summary_details ,

		SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ll_score ELSE 0 END) AS response_score,
        SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) AS ll_score,
        ROUND(SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ll_score ELSE 0 END)*1.0 / CASE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) WHEN 0 THEN 1 ELSE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) END  *100.0,1) AS ll_pct

  FROM obsv.debrief d
        INNER JOIN ref.vessel_instances v on d.vessel_id = v.vessel_id and d.dep_date between v.start_date and v.calculated_end_date
        INNER JOIN ref.field_staff f on f.staff_id= d.observer_id
		INNER JOIN ref.field_staff fs on d.debriefer_id = fs.staff_id
        INNER JOIN obsv.debrief_answer a on a.debrief_id=d.debrief_id
        INNER JOIN obsv.debrief_question q on q.debrief_question_id = a.debrief_question_id
        LEFT JOIN ref_static.debrief_categories c on c.id = q.ll_score_category_code

  WHERE YEAR(d.dep_date) = coalesce(:year, YEAR(d.dep_date))
  AND v.flag_id = coalesce(:flag_code,v.flag_id)
  AND d.debriefer_obsprg_code = coalesce(:obsv_prg,d.debriefer_obsprg_code)
  AND d.system_source = 'Tufman2' 
  AND d.gear_code = 'L'
  AND response is not null

GROUP BY d.debriefer_obsprg_code,
		 f.staff_code,
         d.tripno,
		 v.vesselname,
         v.flag_id, 
	 	 d.gear_code,
		 d.dep_date,
		 d.ret_date,
		 d.ret_dtime,
		 d.debrief_start_dtime,
		 d.debrief_end_dtime,
		 fs.staff_code,
		 ll_score_category_code ) x

GROUP BY x.debriefer_obsprg_code,
x.staff_code,
x.tripno,
x.vesselname,
x.flag, 
x.gear_code,
x.depart_date,
x.return_date,
x.trip_days,
x.waiting_debrief_days,
x.debrief_start,
x.debrief_end,
x.debrief_hrs,
x.debrief_days,
x.debriefer_code,
x.summary_details",NA
"134","31293f2d-cc7e-452b-b88b-ac17008965ae"," CMM 20-02 – North Pacific BLUEFIN catches by National Fleet","year","CCMs shall report to the Executive Director by 31 July each year their fishing effort and <30 kg and >=30 kg catch levels, by fishery, for the previous 3 year, accounting for all catches, including discards. The Executive Director will compile this information each year into an appropriate format for the use of the Northern Committee. (Note: This catch is for north of 20 degrees N)
CCMs shall take measures necessary to ensure that: (1) Total fishing effort by their vessel fishing for Pacific bluefin tuna in the area north of the 20° N shall stay below the 2002–2004 annual average levels.","Logsheets",NA,NA,"30",3404,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, Tuna","2022-01-06T10:40:54.897"," SELECT  
		'L' as gear,
		vi.flag_id as flag, 
		year(logdate) as yr,
        count(distinct case when left(lat,2) >= '20' then CAST(t.vessel_id as varchar(50)) else null end) as vess_num_targ,
        count(distinct case when left(lat,2) >= '20' then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as vess_days_targ,
        SUM(case when c.sp_code = 'PBF' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n_targ,
        cast(SUM(case when c.sp_code = 'PBF' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt_targ,
        count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as vess_num,
        count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as vess_days,
        SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n,
        cast(SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-20
    AND vi.flag_id = @@entity
	and latd > 0
group by vi.flag_id, year(logdate)",NA
"135","934e9484-7dc0-4f2f-8b8b-ac1e010fa7fd"," PURSE SEINE - VESSEL TRIP Catch Report BY SET TYPE (FAD/NON-FAD) and AWs - BY FLAG","flag_code, year, date_from, date_to","BY FLAG - VESSEL TRIP Catch Report requested by FSM for FAD/NON-FAD reporting and AWs","Logsheets",NA,NA,"13g",3406,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Raised, Tuna","2021-10-07T15:01:36.723"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		convert(nvarchar(10),s.logdate,103) logdate,
		s.school_id,
		s.eez_code,
		case when in_AWs = 0 then 'N' else 'Y' end as AWs,
		CASE WHEN s.school_id IN (4,5) THEN 'FAD' ELSE 'Not FAD' END as set_type,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as int)   AS skj_mt,
		cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as int)  AS bet_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end)  as int)    AS yft_mt,
		cast(Sum(case when sp_code not in ('YFT','BET','SKJ') then sp_mt_est else 000.0 end)  as int)    AS oth_mt,
		cast(Sum(case when discard = 1 then sp_mt_est else 000.0 end)  as int)    AS discard_mt
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		inner join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	logdate >= coalesce(:date_from,logdate)
and 	logdate <= coalesce(:date_to,logdate)
and 	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id, s.logdate, s.school_id, s.eez_code,case when in_AWs = 0 then 'N' else 'Y' 
END",NA
"136","a4b20245-5736-4442-9779-aba70093f45d"," ARTISANAL - Activity Log COVERAGE CHECK - Motor vessels","year","Report to check the daily coverage of the ACTIVITY LOG data for select year.  The report is produced for each LANDING SITE.","",NA,NA,"30",3380,"andrewh@spc.int","peterw@spc.int","Artisanal, CoverageMissingData","2024-04-08T16:08:08.087","DECLARE @MinDate DATE = cast(:year as char(4))+'0101',
        @MaxDate DATE = GetDate();

select x.Date
into #All_Dates
from
(SELECT  TOP (DATEDIFF(DAY, @MinDate, @MaxDate) + 1)
        Date = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id) - 1, @MinDate)
FROM    sys.all_objects a
        CROSS JOIN sys.all_objects b) x
where year(x.date) = :year;

select distinct a.landing_site_name, b.Date
INTO #ALL_Sites_Dates
from
(
	SELECT distinct landing_site_name FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id where YEAR(trip_date) = :year  and ref.GetEntityFromBit(a1.instance_source) = @@entity
	UNION 
	SELECT distinct landing_site_name FROM [art2].[fishing_activity_log] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id where YEAR(activity_date) = :year  and ref.GetEntityFromBit(a1.instance_source) = @@entity
) a cross join #All_Dates b

 select  z.landing_site_name, Day(z.Date) as Day_of_month,
		max(case when month(z.Date) = 01 then z.Trips else '   ' end) as jan,
		max(case when month(z.Date) = 02 then z.Trips else '   ' end) as feb,
		max(case when month(z.Date) = 03 then z.Trips else '   ' end) as mar,
		max(case when month(z.Date) = 04 then z.Trips else '   ' end) as apr,
		max(case when month(z.Date) = 05 then z.Trips else '   ' end) as may,
		max(case when month(z.Date) = 06 then z.Trips else '   ' end) as jun,
		max(case when month(z.Date) = 07 then z.Trips else '   ' end) as jul,
		max(case when month(z.Date) = 08 then z.Trips else '   ' end) as aug,
		max(case when month(z.Date) = 09 then z.Trips else '   ' end) as sep,
		max(case when month(z.Date) = 10 then z.Trips else '   ' end) as oct,
		max(case when month(z.Date) = 11 then z.Trips else '   ' end) as nov,
		max(case when month(z.Date) = 12 then z.Trips else '   ' end) as dec 
from 
(		 
select  x.landing_site_name,
		x.Date, 
		case when y.activity_date is null then 'X' else cast(trips as char(3)) end as trips
from #All_Sites_Dates x 
		left outer join 
(		
		SELECT landing_site_name,
				activity_date,
				sum(motor_vessels_n) as trips
		FROM [art2].[fishing_activity_log] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
		where YEAR(activity_date) = :year
		group by  landing_site_name, activity_date
		union 
		SELECT distinct landing_site_name,
				null as activity_date,
				null as trips
		FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
		where YEAR(trip_date) = :year
		and a1.landing_site_id not in (select landing_site_id from [art2].[fishing_activity_log] a1 where YEAR(activity_date) = :year) 
) y on x.landing_site_name = y.landing_site_name and x.Date = y.activity_date
) z
group by z.landing_site_name, Day(z.Date)",NA
"137","81c528f5-36d7-49c2-af36-abaa00f08be1"," ARTISANAL - Custom vessel list","","Constructed originally for CK Ministry of Transport","Artisanal",NA,NA,"101",3382,"andrewh@spc.int","andrewh@spc.int","Artisanal, ByVessel","2021-10-01T13:45:48.133"," SELECT [vessel_name]
	  ,[ves_unique_id]
      ,[ves_island_code]
      ,YEAR(v.entered_date) as first_registered
      ,CASE WHEN vessel_date IS NULL THEN '' ELSE CONVERT(varchar(50), vessel_date, 103) END as vessel_date      
      ,[owner_name]
	  
      ,[owner_postal_address] 
      ,[owner_island]
      ,[owner_contact]
      ,[vessel_make]
      ,tr2.value_en as [hull_material] 
      ,[vessel_length]
      ,[vessel_hull_type]
      ,tr1.value_en as [boat_power]
      ,case WHEN [sports_fishing_boat] = 1 THEN 'Y' WHEN [sports_fishing_boat] = 0 THEN 'N' WHEN [sports_fishing_boat] is null THEN '?' END as sports_fishing_boat 
      ,[engine_power]
      ,[outboards_n]
      ,tr3.value_en as [fuel_type]
	  ,l.landing_site_name
	  ,count(*) as landing_count
  FROM [art2].[vessels] v
	LEFT OUTER JOIN tuf2.translations tr1 ON tr1.translation_key = 'LookupList_ArtisanalVesselPowerModes' + CONVERT(VARCHAR,v.boat_power_id)
	LEFT OUTER JOIN tuf2.translations tr2 ON tr2.translation_key = 'LookupList_HullMaterials' + CONVERT(VARCHAR,v.[hull_material_id])
	LEFT OUTER JOIN tuf2.translations tr3 ON tr3.translation_key = 'LookupList_ArtisanalFuelTypes' + CONVERT(VARCHAR,v.[fuel_type_id])
	left outer join art2.trips t on t.vessel_id = v.vessel_id
	LEFT OUTER JOIN art2.landing_sites l on l.landing_site_id = t.landing_site_id
  where is_active = 1 and v.visibility & (SELECT ref.GetBitFromEntity(@@entity)) <> 0
  group by
  [vessel_name]
	  ,[ves_unique_id]
      ,[ves_island_code]
      ,YEAR(v.entered_date)
      ,CASE WHEN vessel_date IS NULL THEN '' ELSE CONVERT(varchar(50), vessel_date, 103) END   
      ,[owner_name]
      ,[owner_postal_address] 
      ,[owner_island]
      ,[owner_contact]
      ,[vessel_make]
      ,tr2.value_en
      ,[vessel_length]
      ,[vessel_hull_type]
      ,tr1.value_en
      ,case WHEN [sports_fishing_boat] = 1 THEN 'Y' WHEN [sports_fishing_boat] = 0 THEN 'N' WHEN [sports_fishing_boat] is null THEN '?' END
      ,[engine_power]
      ,[outboards_n]
      ,tr3.value_en
	  ,l.landing_site_name",NA
"138","fd0f086c-0c38-4071-b34d-abca00ead3be"," Longline - Observer reports for IATTC - 2.4 Catch-At-Size","flag_code, year","Longline - Observer reports for IATTC - Only includes catches for area : -50 < lat < 50 and -150 < lon < -80","Observer",NA,"Observer","23",3388,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Custom","2022-04-08T11:01:39.443"," Select vesselname,flag_id,dep_date,set_number,set_date,latd,lond,sp_code,fate_code,cond_code as cond_catch,cond_code2 as cond_discard,len,len_code,hook_no,sex_code
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 83
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
where latd between -50 and 50 and lond between -150 and -80 
and year(dep_date) = coalesce(:year,year(dep_date))
and flag_id = coalesce(:flag_code,flag_id)",NA
"139","c9ed96d3-4e58-4bb5-bf53-ad0200b1fa08"," POLE AND LINE - Distinct Vessels fishing in WCPFC Area - NATIONAL FLEET","year","NATIONAL FLEET - List of Pole and line vessels fishing in WCPFC Area - from VMS data","VMS",NA,NA,"2.2.8",3428,"andrewh@spc.int","emmanuels@spc.int","PoleAndLine, ByVessel, RegionalReporting","2025-03-26T10:56:32.85"," /*SELECT  distinct vi.vesselname, vi.flag_id INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date and year(vi.calculated_end_date) > (:year - 1)
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
	WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND     day_fishing>1
	AND		vi.flag_id=@@entity
	ORDER BY vi.vesselname
	*/
	
SELECT  distinct vi.vesselname, vi.flag_id INTO #mapped_trip
FROM	vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='P'
		JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND Year(t.departure_date) = :year
AND day_fishing>1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
ORDER BY vi.vesselname 

select vesselname vessel_name, flag_id flag_code
from #mapped_trip",NA
"140","51cd5f1d-9ef3-41dc-92fc-ab4c00edcf6d"," ARTISANAL - Tails/Creel LENGTH FREQUENCY report for a species - requires fish by fish length data","sp_code, year","Requires fish by fish entry of length data, and provides a length/frequency report for a single species.","Artisanal",1,NA,"90",3370,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2021-10-07T17:08:51.947"," select tmp1.species,
		len,
		SUM(f_q1) as f_q1,
		SUM(f_q2) as f_q2,
		SUM(f_q3) as f_q3,
		SUM(f_q4) as f_q4,
		SUM(f_m1) as f_m1,
		SUM(f_m2) as f_m2,
		SUM(f_m3) as f_m3,
		SUM(f_m4) as f_m4,
		SUM(f_m5) as f_m5,
		SUM(f_m6) as f_m6,
		SUM(f_m7) as f_m7,
		SUM(f_m8) as f_m8,
		SUM(f_m9) as f_m9,
		SUM(f_m10) as f_m10,
		SUM(f_m11) as f_m11,
		SUM(f_m12) as f_m12
from (
	SELECT 	
		sp_code as species,
		sd.sp_len as len,
		sum(case when month(trip_date) in (1,2,3)	then 00001 else 00000 end) as f_q1, 
		sum(case when month(trip_date) in (4,5,6)	then 00001 else 00000 end) as f_q2, 
		sum(case when month(trip_date) in (7,8,9)	then 00001 else 00000 end) as f_q3, 
		sum(case when month(trip_date) in (10,11,12)	then 00001 else 00000 end) as f_q4, 
		sum(case when month(trip_date) = 01	then 00001 else 00000 end) as f_m1, 
		sum(case when month(trip_date) = 02	then 00001 else 00000 end) as f_m2, 
		sum(case when month(trip_date) = 03	then 00001 else 00000 end) as f_m3, 
		sum(case when month(trip_date) = 04	then 00001 else 00000 end) as f_m4, 
		sum(case when month(trip_date) = 05	then 00001 else 00000 end) as f_m5, 
		sum(case when month(trip_date) = 06	then 00001 else 00000 end) as f_m6, 
		sum(case when month(trip_date) = 07	then 00001 else 00000 end) as f_m7, 
		sum(case when month(trip_date) = 08	then 00001 else 00000 end) as f_m8, 
		sum(case when month(trip_date) = 09	then 00001 else 00000 end) as f_m9, 
		sum(case when month(trip_date) = 10	then 00001 else 00000 end) as f_m10, 
		sum(case when month(trip_date) = 11	then 00001 else 00000 end) as f_m11, 
		sum(case when month(trip_date) = 12	then 00001 else 00000 end) as f_m12 
	FROM	art2.trips t          
       INNER JOIN  art2.landing_sites ls on t.landing_site_id = ls.landing_site_id        
       INNER JOIN  art2.effort e on t.art_trip_id = e.art_trip_id        
       INNER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)      
       INNER JOIN  art2.areas a on a.art_area_id = e.art_area_id  
       INNER JOIN art2.catch c on    e.art_effort_id = c.art_effort_id
       INNER JOIN  art2.size_data sd on c.art_catch_id = sd.art_catch_id
	WHERE YEAR(trip_date) = coalesce(:year,year(trip_date))
		AND sp_code = :sp_code
		AND coalesce(sd.sp_len,0) > 0
	GROUP BY sp_code, sd.sp_len  ) tmp1

GROUP BY tmp1.species, len",NA
"141","8153f444-9890-48c7-b1eb-abd600821eca"," LONGLINE - Logsheet in WCPFC Area - Full reconciliation (Vanuatu alternative) - NATIONAL FLEET","year",NA,"Logsheets,VMS",NA,NA,"2.2.7",3392,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CoverageMissingData, Custom, RegionalReporting","2021-10-27T11:31:57.97","    SELECT  t.vms_trip_id,
		vi.vesselname, 
		vi.flag_id,
		t.departure_date,
		dp.port_name dp,
		t.return_date, 
		rp.port_name rp,
		e1.day_at_sea,
		e1.day_fishing,
		sum(coalesce(fish_logdays,0)) as fish_days,
		sum(coalesce(logdays,0)) as logdays 
INTO #mapped_trip
    FROM    vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
            INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
            INNER JOIN 
			( 
			select 	t.vms_trip_id,
					sum(day_at_sea) as day_at_sea,
					sum(day_fishing) as day_fishing 
			from vms.vms_trips t 
						inner join vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			where coalesce(eez.eez_code,'IW') <> 'IW'  
			group by t.vms_trip_id ) e1 on t.vms_trip_id = e1.vms_trip_id
            INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
            INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
            LEFT OUTER JOIN 
			(
			 select 
					l.log_trip_id,
					l.vessel_id, 
					l.depart_date,
					l.return_date,
					l.first_logdate,
					l.last_logdate,
					count(distinct case when coalesce(l_activity_id,0) = 1 then s.log_set_id else null end) as fish_logdays,
					count(distinct s.log_set_id) as logdays
			 from
					log.trips_ll  l  
						INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					            LEFT OUTER JOIN log.sets_ll  s  ON l.log_trip_id = s.log_trip_id
			 where 
					year(logdate) = :year
				AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
				and in_wcpfc_area = 1
		 group by   
					l.log_trip_id, 
					l.vessel_id, 
					l.depart_date,
					l.return_date,
					l.first_logdate,
					l.last_logdate ) l1
		ON t.vessel_id = l1.vessel_id AND (
							l1.depart_date < t.return_date
							AND l1.return_date > t.departure_date
            )
    WHERE    DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by t.vms_trip_id,
		vi.vesselname, 
		vi.flag_id,
		t.departure_date,
		dp.port_name,
		t.return_date, 
		rp.port_name,
		e1.day_at_sea,
		e1.day_fishing
 
  select 
		vesselname vessel_name, 
		flag_id flag_code, 
		CONVERT(nvarchar,departure_date,111) vms_departure_date, 
		dp, 
		CONVERT(nvarchar,return_date,111) vms_return_date, 
		rp, 
		sum(day_at_sea) as days_at_sea,
		sum(day_fishing) as days_fishing,
		sum(logdays) as log_at_sea,
		sum(fish_days) as fish_logdays
from #mapped_trip
group by 
		vesselname, 
		flag_id, 
		CONVERT(nvarchar,departure_date,111) , 
		dp, 
		CONVERT(nvarchar,return_date,111) , 
		rp",NA
"142","29989f53-40ad-419c-aa8a-ab5900a546bd"," Annual Catch and Effort summary: E-Monitoring only","year",NA,"",NA,"Observer","9d",3374,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T15:59:51.947"," select x.yr, 
		sum(case when sp_code = 'ALB' then EM_retain else 00000 end) as alb_ret,
		sum(case when sp_code = 'ALB' then EM_discard else 00000 end) as alb_disc,
		sum(case when sp_code = 'BET' then EM_retain else 00000 end) as bet_ret,
		sum(case when sp_code = 'BET' then EM_discard else 00000 end) as bet_disc,
		sum(case when sp_code = 'YFT' then EM_retain else 00000 end) as yft_ret,
		sum(case when sp_code = 'YFT' then EM_discard else 00000 end) as yft_disc,
		sum(EM_retain) as tot_ret,
		sum(EM_discard) as tot_disc,
		count(distinct x.obstrip_id) as trips,
		count(distinct x.l_set_id) as sets
from
(
select  year(et.dep_date) as yr, 
		s.obstrip_id,
		s.l_set_id,
		sc.sp_code, 
		sum(case when left(fate_code,1) = 'R' then 0001 else 0000 end) as EM_retain,
		sum(case when left(fate_code,1) = 'R' then 0000 else 0001 end) as EM_discard
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join em.l_set s on et.obstrip_id=s.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=s.l_set_id
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by year(et.dep_date),sc.sp_code,s.obstrip_id,s.l_set_id) x 
group by x.yr",NA
"143","12c9b3de-c100-46a2-8f0c-ab0a00f9f3eb"," Monthly unloading by vessel by trip (source unloading)  - target species","year","Monthly unloading by vessel by trip (source unloading) for target species with EEZ","Port",NA,"Live","10",3350,"andrewh@spc.int","brunod@spc.int","Unloading, DeepwaterSnapper, ByVessel","2022-05-16T10:36:37.513"," Select year(unload_startdate) YY,
	 month(unload_startdate) MM,
	 vi.vesselname, 
	 p.port_name,
	
	
	 
	convert(nvarchar(10),case when unload_startdate is null then unload_startdate else unload_startdate end, 103) as unl_date,

	cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))	AS pfm_kg,
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))	AS pfm_n,
		
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lwf_kg,
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))	AS lwf_n,

	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS etc_kg,
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))	AS etc_n, 
	
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS eta_kg,
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))	AS eta_n,
	
	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))	AS arq_kg,
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))	AS arq_n,
	
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lrk_kg,
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))	AS lrk_n,
	
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS bwa_kg,
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))	AS bwa_n,
	
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS ytc_kg,
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))	AS ytc_n,

	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))	AS sey_kg,
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))	AS sey_n,

	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0
						when 'ARQ' then 0 when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 
						when 'YTC' then 0 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n
	

from unload2.unloadings u join ref.vessel_instances vi on u.vessel_id = vi.vessel_id and u.unload_startdate between vi.start_date and vi.calculated_end_date
join unload2.unloading_catch uc on u.unload_id = uc.unload_id LEFT OUTER JOIN  ref.ports p ON p.port_id=u.port_id

where gear_code = 'D' and year(unload_startdate) = :year 
	

group by year(unload_startdate),
	 month(unload_startdate),
	 vi.vesselname, 
	 unload_startdate,
	 p.port_name",NA
"144","ef91b5c1-37e4-42d0-b707-ab0a01288e7e"," Vessel Catch by Trip by Sets for main target species (cpue kg/hk)","year",NA,"Logsheets",NA,NA,"2",3352,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ, Raised","2023-10-12T13:55:38.55"," Select
	v.vesselname vessel_name,
	t.trip_no,
	convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103)  as departure_date,
	convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103)  as return_date,
	COUNT(distinct cast(t.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
	convert(nvarchar(10),s.logdate, 103) as set_date,
	
	ref.getLatDfromLat(s.lat) as latitude, 
	ref.getLonDfromLon(s.lon) as longitude, 
	s.eez_code, 
	s.hooks_n, 
	s.hours_n, 


		cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))												AS pfm_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0 else cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS pfm_cpue, 
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))												AS pfm_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'PFM' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS pfm_npue,
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lwf_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_cpue, 
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))												AS lwf_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_npue, 
	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS etc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS etc_cpue, 
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))												AS etc_n, 
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_n else 000.0 end)  /hooks_n / hours_n as decimal(6,2)) end			AS etc_npue, 
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eta_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS eta_cpue, 
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))												AS eta_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eta_npue, 
	 
	cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eep_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS eep_cpue, 
	cast(Sum(case sp_code when 'EEP' then sp_n else 0 end)							as decimal(7,0))												AS eep_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eep_npue, 

	cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ewo_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS ewo_cpue, 
	cast(Sum(case sp_code when 'EWO' then sp_n else 0 end)							as decimal(7,0))												AS ewo_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS ewo_npue, 

	cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhi_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhi_cpue, 
	cast(Sum(case sp_code when 'LHI' then sp_n else 0 end)							as decimal(7,0))												AS lhi_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhi_npue, 

	cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhb_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhb_cpue, 
	cast(Sum(case sp_code when 'LHB' then sp_n else 0 end)							as decimal(7,0))												AS lhb_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhb_npue, 


	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))												AS arq_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_cpue, 
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))												AS arq_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_npue, 
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lrk_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_cpue, 
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))												AS lrk_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_npue,
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS bwa_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_cpue, 
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))												AS bwa_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_npue,
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ytc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_cpue, 
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))												AS ytc_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_npue,
	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))												AS sey_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS sey_cpue, 
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))												AS sey_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS sey_npue,

	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0 
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0			
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0
						 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n
	

from log.trips_ds t
	inner join log.sets_ds S on t.log_trip_id = S.log_trip_id
	inner join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date


  
 WHERE year(logdate) = :year 
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))

Group by v.vesselname, 
		t.trip_no,
		convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103),
		convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103), 
		s.logdate,
		ref.getLatDfromLat(s.lat), 
		ref.getLonDfromLon(s.lon), 
		s.eez_code,
		s.hooks_n, 
		s.hours_n",NA
"145","f812a0a2-747d-4e52-b769-ab6500d18781"," Total Unloading by Vessels  by Month (source: unloading)","year","Monthly total unloading by vessel","Port",NA,NA,"10c",3376,"andrewh@spc.int","brunod@spc.int","Unloading, DeepwaterSnapper, ByVessel","2021-09-23T15:06:36.957"," Select year(unload_startdate) year,
	 month(unload_startdate) month,
	 vi.vesselname vessel_name, 
		 
	cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))	AS pfm_kg,
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))	AS pfm_n,
		
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lwf_kg,
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))	AS lwf_n,

	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS etc_kg,
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))	AS etc_n, 
	
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS eta_kg,
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))	AS eta_n,
	
	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))	AS arq_kg,
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))	AS arq_n,
	
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lrk_kg,
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))	AS lrk_n,
	
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS bwa_kg,
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))	AS bwa_n,
	
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS ytc_kg,
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))	AS ytc_n,

	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))	AS sey_kg,
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))	AS sey_n,

	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0
						when 'ARQ' then 0 when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 
						when 'YTC' then 0 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n,
	ref.GetEntityFromBit(u.instance_source) as country
	

from unload2.unloadings u join ref.vessel_instances vi on u.vessel_id = vi.vessel_id and u.unload_startdate between vi.start_date and vi.calculated_end_date
join unload2.unloading_catch uc on u.unload_id = uc.unload_id LEFT OUTER JOIN  ref.ports p ON p.port_id=u.port_id

where gear_code = 'D' and year(unload_startdate) = :year 
	

group by year(unload_startdate),
	 month(unload_startdate),
	 vi.vesselname, 

	 ref.GetEntityFromBit(u.instance_source)",NA
"146","07d29c10-1185-46ce-867c-aadb010edf22"," LONGLINE - National FLEET Total catch by FAO Area (PACIFIC OCEAN)","year",NA,"Logsheets",NA,NA,"7a",3331,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Custom, RegionalReporting","2021-11-22T10:44:32.257"," select	c.sp_code,fao.area_id FAO_Area,SUM(COALESCE(c.sp_kg_est,0)) catch_kg
from	log.trips_ll t INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		INNER JOIN log.catch_ll c ON s.log_set_id=c.log_set_id
		INNER JOIN ref.fao_definitions fao WITH (INDEX(spix_fao_definitions_area_def)) ON area_def.STIntersects(tufman2.GetPointFromLatLon(s.latd, s.lond)) = 1
where	YEAR(logdate)=:year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and (((s.lond >= 145 or s.lond < -70) and s.latd <= -8) 
  or ((s.lond >= 105 or s.lond < -70) and s.latd < 10)
  or ((s.lond >= 105 or s.lond < -85) and s.latd >= 10))
group by c.sp_code,
		fao.area_id",NA
"147","49eeb2f9-108e-469d-a85f-aaf500fd981e"," Vessel (PS) Gear & Attributes Report by Trip","min_year, max_year",NA,"Observer",NA,"Observer","12b",3336,"andrewh@spc.int","colleyf@spc.int","Observer","2023-07-10T12:27:04.433"," SELECT 	
	ot.tripno tripno,
	vi.vesselname,
	flag_id,
	dep_date,
	v.grt,
	ot.well_capacity,
	net_depth,
	case net_depth_unit1_id when 1 then 'km' when 2 then 'nM' when 3 then 'm' when 4 then 'Yards' when 5 then 'Fathoms' when 6 then 'cm' when 7 then 'in' end as net_depth_unit,
	net_length,
	case net_length_unit1_id when 1 then 'km' when 2 then 'nM' when 3 then 'm' when 4 then 'Yards' when 5 then 'Fathoms' when 6 then 'cm' when 7 then 'in' end as net_length_unit,
	mesh_main,
	case mesh_main_unit2_id when 1 then 'km' when 2 then 'nM' when 3 then 'm' when 4 then 'Yards' when 5 then 'Fathoms' when 6 then 'cm' when 7 then 'in' end as mesh_main_unit,
	speedboats_n,
	auxboats_n,
	cruise_speed,
	heli_make,
	heli_model,
	heli_reg_no,
	heli_colour
FROM obsv.trip ot join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id and ot.dep_date between vi.start_date and vi.calculated_end_date
join ref.vessels v on v.vessel_id=vi.vessel_id
LEFT JOIN obsv.s_gear g on g.obstrip_id = ot.obstrip_id
LEFT JOIN [obsv].[s_vess_attrib] a on a.obstrip_id = ot.obstrip_id
where YEAR(ot.dep_date) >= coalesce(:min_year,year(ot.dep_date)) and YEAR(ot.dep_date) <= coalesce(:max_year,year(ot.dep_date))",NA
"148","eab8e003-2e31-4519-acaa-aadb01138d71","National FLEET Total catch by FAO Area (ATLANTIC OCEAN)","year",NA,"Logsheets",NA,NA,"7b",3332,"andrewh@spc.int","brunod@spc.int","Logsheet, Custom, RegionalReporting","2021-11-22T10:43:28.67"," select	c.sp_code,fao.area_id FAO_Area,SUM(COALESCE(c.sp_kg_est,0)) catch_kg
from	log.trips_ll t INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		INNER JOIN log.catch_ll c ON s.log_set_id=c.log_set_id
		INNER JOIN ref.fao_definitions fao WITH (INDEX(spix_fao_definitions_area_def)) ON area_def.STIntersects(tufman2.GetPointFromLatLon(s.latd, s.lond)) = 1
where	YEAR(logdate)=:year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and ((ref.GetLonDfromLon(s.lon) >= -75 and ref.GetLonDfromLon(s.lon) < 20 and ref.GetLatDfromLat(s.lat) < 10) 
  or 
	 (ref.GetLonDfromLon(s.lon) >= -85 and ref.GetLonDfromLon(s.lon) < 20 and ref.GetLatDfromLat(s.lat) >= 10))
group by c.sp_code,fao.area_id",NA
"149","dfb02aed-28bb-4c30-95c0-aa3300e627cd"," LONGLINE -- Mitigation summary","",NA,"Observer",NA,"Observer","15",3307,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-01-05T11:37:57.34"," Select year(dep_date) as year,
SUM(CASE WHEN coalesce(DATEPART(hh,set_dtime),10) between 5 and 17 AND coalesce(tori_poles_yn,0) = 0 and coalesce(weighted_lines_yn,0) = 0 and coalesce(underwater_chute_yn,0) = 0 and coalesce(lshoot_ans,0) = 0 then 1 else 0 end) as 'No Mitigation',
SUM(CASE WHEN (DATEPART(hh,set_dtime) >= 18 OR DATEPART(hh,set_dtime) <= 4)  AND coalesce(tori_poles_yn,0) = 0 and coalesce(weighted_lines_yn,0) = 0 and coalesce(underwater_chute_yn,0) = 0 then 1 else 0 end) as 'NS',
SUM(CASE WHEN coalesce(tori_poles_yn,0) = 1 then 1 else 0 end) as 'TL',
SUM(CASE WHEN coalesce(weighted_lines_yn,0)=1 then 1 else 0 end) as 'WB',
SUM(CASE WHEN coalesce(underwater_chute_yn,0) = 1 then 1 else 0 end) as 'DSLS',
SUM(CASE WHEN coalesce(lshoot_ans,0) = 1 then 1 else 0 end) as 'LS',
count(*) as total_trips
from obsv.trip ot 
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
left join obsv.l_gear g on g.obstrip_id=ot.obstrip_id
where year(dep_date) > 2012
group by year(dep_date)",NA
"150","3c2e6e45-2fb4-453c-95c9-aa4e00a3b638"," PURSE SEINE - Logsheet in EEZ - Full reconciliation (Date range selection)","flag_code, date_from, date_to",NA,"Logsheets,VMS",NA,NA,"7.1.3",3310,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, CoverageMissingData, MyEEZ","2023-03-23T14:26:56.707","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='S'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id 
							AND (	(t.departure_date >= :date_from	AND t.departure_date <= :date_to) or 
									(t.return_date >= :date_from	AND t.return_date <= :date_to)) 
							AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ps l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
	AND     day_fishing>1

select vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id PurseseineLogsheetDTO 
from #mapped_trip",NA
"151","94aa12c1-994e-4085-8d91-aa5300f106d9"," PURSE SEINE - Vessel trip Catch Report BY SET TYPE (FAD/NON-FAD) - BY FLAG","flag_code, year, date_from, date_to","BY FLAG - VESSEL TRIP Catch Report requested by FSM for FAD/NON-FAD reporting","Logsheets",NA,NA,"13f",3313,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, Tuna","2021-10-11T16:36:18.65"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		s.logdate,
		s.school_id,
		s.eez_code,
		CASE WHEN s.school_id IN (4,5) THEN 'FAD' ELSE 'Not FAD' END as set_type,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as int)   AS skj_mt,
		cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as int)  AS bet_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end)  as int)    AS yft_mt,
		cast(Sum(case when sp_code not in ('YFT','BET','SKJ') then sp_mt_est else 000.0 end)  as int)    AS oth_mt,
		cast(Sum(case when discard = 1 then sp_mt_est else 000.0 end)  as int)    AS discard_mt
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		inner join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	logdate >= coalesce(:date_from,logdate)
and 	logdate <= coalesce(:date_to,logdate)
and 	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id, s.logdate, s.school_id, s.eez_code",NA
"152","28c1a3a3-52df-47fa-a67c-aa7a00e42629"," PURSE SEINE - sets and location by YEAR and Programmes","year",NA,"Observer",NA,"Observer","128",3316,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Custom","2022-01-14T10:58:22.217"," SELECT 	distinct vesselname,
		flag_id as flag, 
		cast(convert( char(8), dep_date,112) as char(8)) as dep_date, 
		cast(convert( char(8), ret_date,112) as char(8)) as ret_date,
		cast(convert( char(8), act_date,112) as char(8)) as logdate, 
		act_time,
		r1.school_association_desc as set_type, 
		r.detection_desc as detection, 
		beacon, 
		payao, 
		lat, 
		lon, 
		eez_code,
        case when coalesce(in_AWs,999) = 999		then '???'	when coalesce(in_AWs,999) = 0 then 'No' else 'Yes' end as in_AWs,
        case when coalesce(WCPFC_Area,999) = 999	then '???'	when coalesce(WCPFC_Area,999) = 0 then 'No' else 'Yes' end as WCPFC_Area,
        case when coalesce(WCPFC_Overlap,999) = 999 then '???'	when coalesce(WCPFC_Overlap,999) = 0 then 'No' else 'Yes' end as WCPFC_Overlap,
        ot.obsprg_code,
		staff_code,
        ot.tripno,
		cast(sa.comments as char(50)) as comments
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join ref.field_staff f on f.staff_id=ot.observer_id
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join ref_static.ps_detection_codes r on sa.deton_id = r.deton_id
				left outer join ref_static.ps_school_associations r1 on sa.schas_id = r1.schas_id
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
	AND s_activ_id = 1",NA
"153","0fadb1cd-5502-43ef-abc7-a95f00dd2cf0"," CMM 2016-01 para. 25 - Purse seine EFFORT (days) on the high seas -- (vessel reported; unraised)","flag_code, year",NA,"Logsheets",NA,NA,"42",3280,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CMM, Raised, RegionalReporting, Unraised","2022-05-16T09:46:02.473"," SELECT  vi.flag_id as flag,
        vi.vesselname as vessel,
		CONVERT(VARCHAR(10), logdate, 103) as date,
        max(lat+' '+lon+' '+eez_code) as position_eez,
        min(s_activity_id) as activity_code
FROM    log.trips_ps trip_ps 
            inner join ref.vessel_instances vi 
                    on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND s_activity_id in (1,2)
		and eez_code in ('I1','I2','I3','I4','I5','I6','I7','I8','I9','H4','H5')
		and ref.GetLonD360fromLon(lon) > 115 and ref.GetLonD360fromLon(lon) < 229 
  		and not (ref.GetLatDfromLat(lat) > -4 and  ref.GetLonD360fromLon(lon) > 210)
GROUP BY vi.flag_id,
        vi.vesselname,
		CONVERT(VARCHAR(10), logdate, 103)",NA
"154","fefab987-e3c1-4830-b591-a99700d8b965"," LONGLINE - logsheet Coverage in EEZ - SUMMARY (by FLAG) - without link to LICENSE","year",NA,"Logsheets,VMS",NA,NA,"1.2.8",3287,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData, MyEEZ","2023-09-22T14:32:09.647","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND		ve.gear='L'
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		l_activity_id=1
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id 

SELECT COALESCE(mt.year,e.year) year,COALESCE(mt.flag_id,e.flag_id) flag_code,CONVERT(DECIMAL(5,2),COALESCE(nb_days,0)*100/(COALESCE(nb_days,0)+COALESCE(day_fishing,0))) cov
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year",NA
"155","3cf1b288-58be-4f6f-8497-a9a600dd50e6"," SET and HAUL Data Extract (incl. Float hauls)- E-Monitoring only","flag_code, year","SET and HAUL Data Extract (incl. Float hauls)","",NA,"Observer","10b",3290,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T08:20:29.42"," SELECT 	et.obstrip_id as obstrip_id, 
		ls.l_set_id as l_set_id,
		CONVERT(VARCHAR(10), sh.log_date, 103) as log_date,
		sh.log_time as log_time,
		sh.sethaul as sethaul,
		sh.lat as lat,
		sh.lon as lon,
		sh.eez_code as eez_code,
		coalesce(sh.wind_dir,0) as wind_dir,
        coalesce(sh.wind_kts,0) as wind_kts,
        coalesce(sh.sea_code,'-') as sea_code,
        coalesce(sh.cloud,0) as cloud,
        coalesce(sh.comments,'-') as comments,
		et.tripno as tripno,
		st.staff_code as staff_code,
		v.vesselname as vessel_name,
		v.flag_id as flag,
		et.gear_code as gear,
		CONVERT(VARCHAR(10), et.dep_date, 103) as depart_date,
		CONVERT(VARCHAR(10), et.ret_date, 103) as return_date,
		dp.port_name as depart_port,
		rp.port_name as return_port
 FROM	em.trip et 
			inner join ref.vessel_instances v on et.vessel_id = v.vessel_id 
				and et.dep_date between v.start_date and v.calculated_end_date
			inner join	em.l_set ls on et.obstrip_id = ls.obstrip_id 
			inner join	em.l_sethaullog sh on ls.l_set_id = sh.l_set_id
			inner join ref.field_staff st on st.staff_id=et.observer_id
			inner join ref.ports dp on dp.port_id=et.dep_port_id
			inner join ref.ports rp on rp.port_id=et.ret_port_id
WHERE YEAR(set_date) = coalesce(:year,year(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)",NA
"156","b4a5b176-7ddc-49d5-97e9-a8b201019659"," PURSE SEINE - Full OBSERVER reconciliation in WCPFC Area - NATIONAL FLEET","year",NA,"Observer,VMS",NA,"Live","6.1.2",3247,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Observer, Purseseine, CoverageMissingData, RegionalReporting","2025-04-09T08:09:17.957","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.obstrip_id, l.dep_date, l.ret_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='S'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN obsv.trip l  ON t.vessel_id = l.vessel_id AND (
				  (l.dep_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.ret_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date)))
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date

SELECT vesselname vessel_name, 
flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,dep_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, obstrip_id PurseseineObserverDTO 
from #mapped_trip",NA
"157","5e0773b5-9a09-47b5-92e2-a8c700ff5798"," PURSE SEINE - FAD sets and location by YEAR","year",NA,"Observer",NA,"Observer","127",3251,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Custom","2025-05-22T13:47:48.723"," SELECT 	distinct vesselname,
		flag_id as flag, 
		cast(convert( char(8), dep_date,103) as char(8)) as dep_date, 
		cast(convert( char(8), ret_date,103) as char(8)) as ret_date,
		cast(convert( char(8), act_date,103) as char(8)) as logdate, 
		act_time,
		r1.schas_id as set_type, 
		r.deton_id as detection, 
		beacon, 
		payao, 
		lat, 
		lon, 
		eez_code,
        case when coalesce(in_AWs,999) = 999		then '???'	when coalesce(in_AWs,999) = 0 then 'No' else 'Yes' end as in_AWs,
        case when coalesce(WCPFC_Area,999) = 999	then '???'	when coalesce(WCPFC_Area,999) = 0 then 'No' else 'Yes' end as WCPFC_Area,
        case when coalesce(WCPFC_Overlap,999) = 999 then '???'	when coalesce(WCPFC_Overlap,999) = 0 then 'No' else 'Yes' end as WCPFC_Overlap,
        ot.obsprg_code,
		staff_code,
        'T'+ot.tripno as tripno ,
		cast(sa.comments as char(50)) as comments
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join ref.field_staff f on f.staff_id=ot.observer_id
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join ref_static.ps_detection_codes r on sa.deton_id = r.deton_id
				left outer join ref_static.ps_school_associations r1 on sa.schas_id = r1.schas_id
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
	AND s_activ_id = 1 
	and  coalesce(sa.schas_id,20)-20 in (3,4,5)",NA
"158","fedec38a-5fa4-417a-81b1-a8d90124c084"," ARTISANAL - Average fish size by SPECIES","year","Requested by Phil to use with household survey data","Artisanal",1,NA,"3.3",3255,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:16:33.347","with #t (year, country, sp_code, sp_name, num, kg) as (Select 
	YEAR(t.trip_date) as year,
	ref.GetEntityFromBit(t.instance_source) as country,
	c.sp_code,
	s.sp_name,
	SUM(c.sp_n) as num,
	SUM(c.sp_kg) as kg
from art2.trips t
	inner join art2.effort e on t.art_trip_id = e.art_trip_id
	left outer join art2.catch c on c.art_effort_id = e.art_effort_id
	inner join ref.species s on s.sp_code = c.sp_code
where t.validity > 0 and YEAR(t.trip_date) > 2010
group by YEAR(t.trip_date), ref.GetEntityFromBit(t.instance_source), c.sp_code, s.sp_name) Select t.year, t.country, t.sp_code,t.sp_name,t.num, t.kg, t.kg/t.num as avg_kg
from #t t
where t.kg > 0
and t.year=coalesce(:year, t.year)",NA
"159","ee387f42-75ec-4807-95f2-a7d300a2efb8"," Annual Aggregate Species Composition showing Retains and Discards: E-Monitoring vs Observer","year",NA,"Observer",1,"Observer","3d",3213,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T11:40:38.357","IF OBJECT_ID('tempdb.dbo.#temp_EMOB_1', 'U') IS NOT NULL
  DROP TABLE #temp_EMOB_1;
  
  select 
	sp.sp_name COLLATE DATABASE_DEFAULT as sp_name,
	sc.sp_code COLLATE DATABASE_DEFAULT as sp_code,
	sum(000000) as n_ob,
	sum(1) as n_em,
	sum(000000) as ret_ob,
	sum(case when LEFT(fate_code,1) = 'R' then 0001 else 0000 end) as ret_em,
	sum(000000) as disc_ob,
	sum(case when LEFT(fate_code,1) = 'D' then 0001 else 0000 end) as disc_em
into #temp_EMOB_1
from em.trip em
inner join Tufman2_Dorado.ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and em.dep_date between ot.dep_date and ot.ret_date
inner join em.l_set ls on ls.obstrip_id=em.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where COALESCE(:year,year(em.dep_date)) = year(em.dep_date)
group by sp_name, sc.sp_code
UNION
  select 
	sp.sp_name,
	sc.sp_code as sp_code,
	sum(1) as n_ob,
	sum(000000) as n_em,
	sum(case when LEFT(fate_code,1) = 'R' then 0001 else 0000 end) as ret_ob,
	sum(000000) as ret_em,
	sum(case when LEFT(fate_code,1) = 'D' then 0001 else 0000 end) as disc_ob,
	sum(000000) as disc_em
from em.trip em
inner join Tufman2_Dorado.ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and em.dep_date between ot.dep_date and ot.ret_date
inner join obsv.l_set ls on ls.obstrip_id=ot.obstrip_id
inner join obsv.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where COALESCE(:year,year(em.dep_date)) = year(em.dep_date)
group by sp_name, sc.sp_code select 
	sp_name,
	sp_code COLLATE DATABASE_DEFAULT as sp_code,
	sum(n_em) as n_em,
	sum(n_ob) as n_ob,
	sum(ret_em) as ret_em,
	sum(ret_ob) as ret_ob,
	sum(disc_em) as disc_em,
	sum(disc_ob) as disc_ob
from #temp_EMOB_1
group by sp_name,sp_code",NA
"160","223daab7-9ea8-4cec-b848-a92200b543c3"," POLE AND LINE - Catch in EEZ","eez_code, year","Shows the main tuna species catch by EEZ","Logsheets",NA,NA,"62",3267,"andrewh@spc.int","brunod@spc.int","Logsheet, PoleAndLine, RegionalReporting, Tuna","2021-11-16T09:52:06.97"," SELECT  :group_by, eez_code,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt else 000.0 end) as int) AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt else 000.0 end) as int) AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt else 000.0 end) as int) AS yft_mt, 
        cast(Sum(sp_mt) as int) AS tot_mt
FROM log.trips_pl t inner join log.sets_pl s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_pl c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date					
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by :group_by, eez_code","Year"
"161","e683f87a-4247-4a92-806e-a778011672b2","PURSE SEINE - Tuna Catch and Effort - BY FLAG ","flag_code, date_from, date_to",NA,"Logsheets",NA,NA,"95",3181,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2021-10-11T13:52:24.043"," SELECT  vi.flag_id flag_code,
		eez_code,
        COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips, 
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
        Sum(case when sp_code = 'SKJ' and discard = 0 then sp_mt_est else 000.0 end)   AS skj_mt_ret,
        Sum(case when sp_code = 'BET' and discard = 0 then sp_mt_est else 000.0 end)  AS bet_mt_ret, 
        Sum(case when sp_code = 'YFT' and discard = 0 then sp_mt_est else 000.0 end)    AS yft_mt_ret,
        Sum(case when sp_code = 'SKJ' and discard = 1 then sp_mt_est else 000.0 end)   AS skj_mt_disc,
        Sum(case when sp_code = 'BET' and discard = 1 then sp_mt_est else 000.0 end)  AS bet_mt_disc, 
        Sum(case when sp_code = 'YFT' and discard = 1 then sp_mt_est else 000.0 end)    AS yft_mt_disc
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE logdate >= :date_from and logdate <= :date_to
      and vi.flag_id = coalesce(:flag_code, vi.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, eez_code",NA
"162","966e31d3-1f17-4820-90fb-a79a00c86704"," ARTISANAL - Logsheets Entered Per Data Collector","year","Sort by the Year column to get the best view","Artisanal",NA,NA,"81",3185,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, DataQuality","2021-10-01T13:38:15.63"," select :group_by,
	count (1) as trips
from art2.trips t
	inner join art2.landing_sites ls ON t.landing_site_id=ls.landing_site_id
where coalesce(:year,YEAR(t.trip_date)) = YEAR(t.trip_date)
group by :group_by,
	t.entered_by","YearCollector"
"163","4b9e826b-824b-4b75-a875-9afbc8d5f1c5"," LONGLINE - Number of port samples entered by DCT","year, date_from, date_to","List the number of LL samples entered by Data entry technicians for a given year/period","Port",NA,NA,"4",3113,"andrewh@spc.int","emmanuels@spc.int","PortSampling, Longline, MyFleet","2024-06-28T13:33:08.233"," SELECT H.assigned_to as DCT, 
   CASE WHEN H.instance_source=2 THEN 'OFP' ELSE 'CTY' END as instance,
   :group_by, count(*) as nbsamp
FROM port.samples as H inner join port.sample_catch as D on H.sample_id = D.sample_id
WHERE  COALESCE(:year,YEAR(D.entered_date))=YEAR(D.entered_date)
	AND	COALESCE(:date_from,D.entered_date) < D.entered_date
	AND	COALESCE(:date_to,D.entered_date) >= D.entered_date
group by H.assigned_to, CASE WHEN H.instance_source=2 THEN 'OFP' ELSE 'CTY' END, :group_by","YEAR"
"164","09495551-7c38-4c1e-bc5c-878bf51f2278"," IATTC Area -- TASK I -- LONGLINE Data (Main Species - Table 1)","year","Report produced on request for Vanuatu. IATTC Area -- TASK I -- LONGLINE Data (by year or month) - NOTE THAT THIS IS LOGSHEET REPORTED AND UNRAISED","Logsheets",NA,NA,"31a",3082,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-24T13:37:21.147"," SELECT		:group_by,
            COUNT(distinct t.vessel_id) as vessels,
            count(distinct s.log_set_id) as days,
			cast(Sum(case when sp_code = 'ALB' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS alb_mt,
            cast(Sum(case when sp_code = 'ALB' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS alb_disc_mt, 
			cast(Sum(case when sp_code = 'BET' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS bet_mt,
            cast(Sum(case when sp_code = 'BET' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS bet_disc_mt,
			cast(Sum(case when sp_code = 'YFT' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS yft_mt,
            cast(Sum(case when sp_code = 'YFT' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS yft_disc_mt, 
			cast(Sum(case when sp_code = 'SKJ' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS skj_mt,
            cast(Sum(case when sp_code = 'SKJ' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS skj_disc_mt, 
			cast(Sum(case when sp_code = 'PBF' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS pbf_mt,
            cast(Sum(case when sp_code = 'PBF' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS pbf_disc_mt, 
			cast(Sum(case when sp_code = 'BUM' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS bum_mt,
            cast(Sum(case when sp_code = 'BUM' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS bum_disc_mt, 
			cast(Sum(case when sp_code = 'BLM' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS blm_mt,
            cast(Sum(case when sp_code = 'BLM' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS blm_disc_mt, 
			cast(Sum(case when sp_code = 'MLS' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS mls_mt,
            cast(Sum(case when sp_code = 'MLS' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS mls_disc_mt,
			cast(Sum(case when sp_code = 'SFA' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS sfa_mt,
            cast(Sum(case when sp_code = 'SFA' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS sfa_disc_mt,
			cast(Sum(case when sp_code = 'SSP' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS ssp_mt,
            cast(Sum(case when sp_code = 'SSP' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS ssp_disc_mt,
			cast(Sum(case when sp_code = 'SWO' then sp_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS swo_mt,
            cast(Sum(case when sp_code = 'SWO' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(9,2))  AS swo_disc_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND	vi.flag_id = @@entity 
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		and s.l_activity_id = 1
group by :group_by","Year"
"165","b33f0930-8d9c-445d-9282-c3a1cac2c5ca"," PURSE SEINE - Length Frequency by EEZ","eez_code, sp_code, year","Produces length Frequency observer data for selected SPECIES, YEAR Range and EEZ, with grouping by YEAR, MONTH or QUARTER","Observer",NA,"Observer","7",3086,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, MyEEZ","2021-12-13T16:15:55.613"," select tmp1.species,
		len,
		SUM(f_q1) as f_q1,
		SUM(f_q2) as f_q2,
		SUM(f_q3) as f_q3,
		SUM(f_q4) as f_q4,
		SUM(f_m1) as f_m1,
		SUM(f_m2) as f_m2,
		SUM(f_m3) as f_m3,
		SUM(f_m4) as f_m4,
		SUM(f_m5) as f_m5,
		SUM(f_m6) as f_m6,
		SUM(f_m7) as f_m7,
		SUM(f_m8) as f_m8,
		SUM(f_m9) as f_m9,
		SUM(f_m10) as f_m10,
		SUM(f_m11) as f_m11,
		SUM(f_m12) as f_m12
from (
	SELECT 	
		sp_code as species,
		sl.len as len,
		sum(case when month(act_date) in (1,2,3)	then 00001 else 00000 end) as f_q1, 
		sum(case when month(act_date) in (4,5,6)	then 00001 else 00000 end) as f_q2, 
		sum(case when month(act_date) in (7,8,9)	then 00001 else 00000 end) as f_q3, 
		sum(case when month(act_date) in (10,11,12)	then 00001 else 00000 end) as f_q4, 
		sum(case when month(act_date) = 01	then 00001 else 00000 end) as f_m1, 
		sum(case when month(act_date) = 02	then 00001 else 00000 end) as f_m2, 
		sum(case when month(act_date) = 03	then 00001 else 00000 end) as f_m3, 
		sum(case when month(act_date) = 04	then 00001 else 00000 end) as f_m4, 
		sum(case when month(act_date) = 05	then 00001 else 00000 end) as f_m5, 
		sum(case when month(act_date) = 06	then 00001 else 00000 end) as f_m6, 
		sum(case when month(act_date) = 07	then 00001 else 00000 end) as f_m7, 
		sum(case when month(act_date) = 08	then 00001 else 00000 end) as f_m8, 
		sum(case when month(act_date) = 09	then 00001 else 00000 end) as f_m9, 
		sum(case when month(act_date) = 10	then 00001 else 00000 end) as f_m10, 
		sum(case when month(act_date) = 11	then 00001 else 00000 end) as f_m11, 
		sum(case when month(act_date) = 12	then 00001 else 00000 end) as f_m12 
	FROM	obsv.trip ot 
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_lf slf on ss.s_set_id = slf.s_set_id
				inner join obsv.s_lfmeas sl on slf.s_lf_id = sl.s_lf_id
	WHERE YEAR(act_date) = coalesce(:year,year(act_date))
		AND s_activ_id = 1 
		AND sp_code = :sp_code
	    AND eez_code = coalesce(:eez_code,eez_code)
	GROUP BY sp_code, sl.len 
	UNION 
	SELECT 	
		:sp_code as species,
		tmp.key1 as len,
		sum(00000) as f_q1, 
		sum(00000) as f_q2, 
		sum(00000) as f_q3, 
		sum(00000) as f_q4, 
		sum(00000) as f_m1, 
		sum(00000) as f_m2, 
		sum(00000) as f_m3, 
		sum(00000) as f_m4, 
		sum(00000) as f_m5, 
		sum(00000) as f_m6, 
		sum(00000) as f_m7, 
		sum(00000) as f_m8, 
		sum(00000) as f_m9, 
		sum(00000) as f_m10, 
		sum(00000) as f_m11, 
		sum(00000) as f_m12 
	FROM	(	select key1 
				from (	select n as key1
						from ref.numbers) tmp0
						where key1 <= 200) tmp 
	GROUP BY tmp.key1 ) tmp1
GROUP BY tmp1.species, tmp1.len",NA
"166","a22b7929-7f3c-4d95-bdbc-08c6da8362f2"," ARTISANAL - FAD CPUE - Catch per line hour (Year / Quarter)","year",NA,"Artisanal",NA,NA,"4.1.3",3090,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:16:16.623","SELECT	YEAR(t.trip_date) [year],DATEPART(QUARTER,t.trip_date) quarter,f.fad_name, SUM(e.hours_fished_n* e.lines_n) effort into #t
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY YEAR(t.trip_date),DATEPART(QUARTER,t.trip_date),f.fad_name 

SELECT	YEAR(t.trip_date) [year],DATEPART(QUARTER,t.trip_date) quarter,:group_by,CONVERT(DECIMAL(8,4),SUM(COALESCE(c.sp_kg,0))) catch_KG,#t.effort AS effort_HRS, CONVERT(DECIMAL(8,4),SUM(COALESCE(c.sp_kg,0))/#t.effort) cpue_KG_PER_HR
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN #t ON #t.year = YEAR(t.trip_date) AND #t.quarter = DATEPART(QUARTER,t.trip_date) AND #t.fad_name = f.fad_name 
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
		and #t.effort > 0
GROUP BY YEAR(t.trip_date),DATEPART(QUARTER,t.trip_date),:group_by, #t.effort","FadNameSpeciesCode"
"167","293c257a-f3ae-4666-b264-722fb8eb2b45"," LONGLINE - Missing Logsheets in EEZ With License check","flag_code, year","Using VMS data, lists the logsheet that you should see and not entered yet in TUFMAN2","Logsheets,VMS",NA,NA,"1.2.2",3094,"andrewh@spc.int","colleyf@spc.int","Logsheet, Longline, CoverageMissingData","2025-10-15T21:30:46.663","SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                        INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
                              (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                              OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                              OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                              OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
                        )
			) t 

SELECT  vi.vesselname vessel_name,vi.flag_id flag_code,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing 
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND eez.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity))
        INNER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='L'
AND		COALESCE(:flag_code,vi.flag_id)=vi.flag_id
and     exists(select 1 from tufman2.licence_info where (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) and instance_source = ref.GetBitFromEntity(@@entity)))
AND		COALESCE(:year, eez.year)=eez.year
GROUP BY vi.vesselname,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"168","514efbe0-7bad-44d4-b9ee-6a6449c360b3"," PURSE SEINE - Catch by EEZ - NATIONAL FLEET","eez_code","Shows the main tuna species catch by EEZ","Logsheets",NA,NA,"60",3044,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting","2022-01-12T15:09:54.47"," SELECT  year(logdate) year, eez_code,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt else 000.0 end) as int) AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt else 000.0 end) as int) AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt else 000.0 end) as int) AS yft_mt, 
        cast(Sum(sp_mt) as int) AS tot_mt
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date					
WHERE year(logdate) = coalesce(:year, year(logdate)) 
      and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
group by year(logdate), eez_code",NA
"169","e75da8c7-1a7d-4e7e-8db0-dd1a4c5828fa"," LONGLINE - Key species catches in WCPFC Area raised with VMS - NATIONAL FLEET","year","NATIONAL FLEET - Longline - Key species catches (and discards) in WCPFC Area raised with VMS","Logsheets,VMS",NA,NA,"2.2.3",3050,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, RegionalReporting, AllSpecies","2025-03-12T10:02:26.53","/*--
-- New code - rejected
--

SELECT distinct vms_trip_id INTO #mapped_trip FROM (
    SELECT	dto_guid_left vms_trip_id
    FROM    tufman2.viewpersist_entity_links_two_way
    WHERE  	dto_type_left = 'VmsTripDTO' 
	AND 	dto_type_right = 'LonglineLogsheetDTO'
) t 
*/

/*
 Old code -- retained
*/

SELECT vms_trip_id	INTO #mapped_trip FROM (
	SELECT  distinct t.vms_trip_id
	FROM	log.trips_ll l 
				INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
													 AND l.first_logdate BETWEEN vi.start_date AND vi.calculated_end_date
                INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id
							AND l.depart_date < t.return_date
							AND l.return_date > t.departure_date
/* 					        AND in_wcpfc_area = 1*/
			) t

SELECT  eez.eez_code,
		eez.year as cyear,
		eez.month,
		SUM(eez.day_fishing) day_fishing 
into #missing_trip
FROM    vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
        JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN vms.vms_trip_efforts eez ON t.vms_trip_id = eez.vms_trip_id
		LEFT JOIN #mapped_trip ON t.vms_trip_id = #mapped_trip.vms_trip_id
WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND 	:year between YEAR(vi.start_date) and YEAR(vi.calculated_end_date)
AND     day_fishing>1
AND     ve.gear = 'L'
AND     eez.year = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND     eez_code <> 'IW'
AND		#mapped_trip.vms_trip_id IS NULL
GROUP BY eez.eez_code, eez.year, eez.month

/*  Old condition code which is now replaced

 --       JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)
 --           LEFT OUTER JOIN log.vw_trips_ll_VU_ALL  l  ON t.vessel_id = l.vessel_id AND (
 --                (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
 --                 OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
 --                 OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
 --                 OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
 --           )
 
 */

/*--------------------------------------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		l_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, vi.flag_id

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		c.sp_code,
		vi.flag_id,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0))) catch,
        SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0)))/SUM(CASE WHEN COALESCE(c.sp_n_est,coalesce(c.sp_n,0)) = 0 THEN 1 ELSE COALESCE(c.sp_n_est,coalesce(c.sp_n,0)) END) avg_wt,
		SUM(COALESCE(c.spdiscard_kg_est,000000)) discard,
		SUM(COALESCE(c.spdiscard_n,000000)) discard_n INTO #catch0
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')
AND 	in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, c.sp_code, vi.flag_id
UNION 
SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		CASE WHEN sp.sp_code = 'SPN' THEN 'HAM' ELSE sp.sp_code END sp_code,
		vi.flag_id,
		SUM(000000) catch,
        SUM(000000) avg_wt,
		SUM(000000) discard,
		SUM(000000) discard_n
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		JOIN ref.species sp on sp.sp_code = sp.sp_code
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		sp.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','THR','MAK','SPN','POR','SFA','SSP')
AND 	in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, sp.sp_code, vi.flag_id

SELECT  cyear,
        month, 
        eez_code,
        sp_code,
        flag_id,
        SUM(catch) catch,
		MAX(avg_wt) avg_wt,
        SUM(discard) as discard,
		SUM(discard_n) discard_n
into #catch
FROM   #catch0 
GROUP BY  cyear, month, eez_code, sp_code, flag_id


SELECT	e.cyear, e.month, e.eez_code, c.sp_code, e.flag_id, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month / Fleet / EEZ' raising_factor INTO #cpue
FROM	#effort e JOIN #catch c ON e.eez_code = c.eez_code AND e.cyear = c.cyear AND e.eez_code = c.eez_code AND e.month = c.month

SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_kg, c.raising_factor INTO #missing_catch
FROM	#missing_trip JOIN #cpue c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month AND #missing_trip.eez_code = c.eez_code
WHERE	c.nb_days >= 100 
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')

/*---------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_1
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		vi.flag_id = @@entity
AND		l_activity_id = 1
AND 	in_wcpfc_area = 1	
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		c.sp_code,
		s.eez_code,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0000))) catch INTO #catch_raised_1
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		vi.flag_id = @@entity
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')
AND 	in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code, s.eez_code

SELECT	e.cyear, e.month, c.sp_code, e.eez_code, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month / EEZ' raising_factor INTO #cpue_raised_1
FROM	#effort_raised_1 e JOIN #catch_raised_1 c ON e.cyear = c.cyear AND e.eez_code = c.eez_code AND e.month = c.month

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM	#missing_trip JOIN #cpue_raised_1 c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month AND #missing_trip.eez_code = c.eez_code
WHERE	c.nb_days >= 100 
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')
AND NOT EXISTS (
	SELECT	1
	FROM	#missing_catch temp
	WHERE	temp.cyear =  #missing_trip.cyear
	AND		temp.eez_code = #missing_trip.eez_code
	AND		temp.month = #missing_trip.month
)

/*-----------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_2
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
WHERE	YEAR(logdate) = :year
AND		l_activity_id = 1
AND 	in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate)

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		c.sp_code,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0000))) catch into #catch_raised_2
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
WHERE	YEAR(logdate) = :year
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')
AND 	in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code

SELECT	e.cyear, e.month, c.sp_code,CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month' raising_factor into #cpue_raised_2
FROM	#effort_raised_2 e JOIN #catch_raised_2 c ON e.cyear = c.cyear AND e.month = c.month

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM	#missing_trip JOIN #cpue_raised_2 c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month
WHERE	c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM','SFA','SSP')
AND NOT EXISTS (
	SELECT	1
	FROM	#missing_catch temp
	WHERE	temp.cyear =  #missing_trip.cyear
	AND		temp.eez_code = #missing_trip.eez_code
	AND		temp.month = #missing_trip.month
	)

SELECT	COALESCE(c.cyear,mc.cyear) cyear,
		COALESCE(c.eez_code,mc.eez_code) eez_code,  
		COALESCE(c.sp_code,mc.sp_code) sp_code, 
		CONVERT(DECIMAL(15,2),SUM(COALESCE(c.catch,0))) log_c, 
		CONVERT(DECIMAL(15,2),SUM(COALESCE(c.discard,0))) disc_c, 
		CONVERT(DECIMAL(15),SUM(COALESCE(c.discard_n,0))) disc_n, 
		CONVERT(DECIMAL(10,2),SUM(COALESCE(mc.sp_kg,0))) vms_c, 
		SUM(COALESCE(mc.day_fishing,0)) vms_missing_days,
		MAX(coalesce(avg_wt,0)) avg_wt into #final
FROM	#catch c FULL OUTER JOIN #missing_catch mc ON c.eez_code = mc.eez_code AND c.cyear = mc.cyear and c.month = mc.month and c.sp_code = mc.sp_code
GROUP BY COALESCE(c.cyear,mc.cyear),COALESCE(c.eez_code,mc.eez_code), COALESCE(c.sp_code,mc.sp_code)

SELECT	f.cyear, f.eez_code,sp_code,log_c, disc_c,disc_n,log_c+vms_c tot_c,SUM(COALESCE(e.nb_days,0)) nb_days,vms_missing_days,avg_wt INTO #final2
FROM	#final f LEFT OUTER JOIN #effort e ON e.eez_code = f.eez_code AND e.cyear = f.cyear
GROUP BY f.cyear, f.eez_code,sp_code,log_c, disc_c,disc_n,vms_c, vms_missing_days,avg_wt

 SELECT case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end as category,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end as species,
SUM(log_c)/1000 log_c, 
SUM(tot_c)/1000 tot_c, 
CONVERT(DECIMAL(15,2),SUM(nb_days)*100/(SUM(case when nb_days=0 then 1 else nb_days end)+SUM(case when vms_missing_days=0 then 0.1 else vms_missing_days end))) log_cov,
case when SUM(disc_c) = 0 and SUM(disc_n) > 0
		then max(avg_wt) * SUM(disc_n)/ 1000
		else SUM(disc_c)/1000 end disc_c,
SUM(disc_n) disc_n
FROM #final2 c INNER JOIN	ref.species sp on case when c.sp_code = 'HAM' then 'SPN' else c.sp_code end = sp.sp_code
GROUP BY case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end",NA
"170","224b0885-0cf6-4e34-839d-fb6e392ae8de"," LONGLINE - logsheet Coverage in EEZ - SUMMARY (by FLAG)","year",NA,"Logsheets,VMS",NA,NA,"1.2.4",3054,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData","2022-12-07T15:21:04.043","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		COALESCE(:year, eez.year)=eez.year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND		ve.gear='L'
and     exists(select 1 from tufman2.licence_info where (t.vessel_id=vessel_id AND (t.departure_date BETWEEN lic_startdate AND lic_enddate OR t.return_date BETWEEN lic_startdate AND lic_enddate) and (@@entity = 'HIVE' OR instance_source = ref.GetBitFromEntity(@@entity))))
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND		l_activity_id=1
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id 

SELECT COALESCE(mt.year,e.year) year,COALESCE(mt.flag_id,e.flag_id) flag_code, CONVERT(DECIMAL(5,2),COALESCE(nb_days,0)*100/(COALESCE(nb_days,0)+COALESCE(day_fishing,0))) cov
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year",NA
"171","df845917-2e6e-4bb8-81e6-91c270a8c892"," Check LONGLINE Vessels in your NATIONAL FLEET","","Report to check each LONGLINE VESSEL name and GRT for your NATIONAL FLEET based on the most recently completed calendar year","Logsheets",NA,NA,"21a",3060,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, DataQuality, RegionalReporting","2022-01-12T11:11:55.09"," SELECT	distinct vi.flag_id flag_code,
				vi.vesselname, 
				vi.vesselname_normalised,
				v.grt gross_tonnage,
				count(distinct l.log_trip_id) as trips
FROM  ref.vessel_instances vi 
				INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.trips_ll l ON l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE (YEAR(l.FIRST_LOGDATE) = YEAR(GetDate())-1 or YEAR(l.Last_LOGDATE) = YEAR(GetDate())-1)
   AND vi.flag_id COLLATE DATABASE_DEFAULT = @@entity
group by	vi.flag_id,
			vi.vesselname, 
			vi.vesselname_normalised,
			v.grt",NA
"172","8359f70b-d794-4577-a4e1-4c2881fdc8b3"," Rapport IATTC","year",NA,"Logsheets",NA,NA,"90",3016,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Custom, AllSpecies","2025-09-23T15:05:38.78","SELECT	MONTH(logdate) month,
		FLOOR(ref.GetLatDfromLat(s.lat))+0.5 latd,
		FLOOR(ref.GetLonDfromLon(s.lon))+0.5 lond,
		COUNT(*) sets_n,
		COALESCE(SUM(hooks_n),0) hooks_n into #t
FROM	log.trips_ll t 
		INNER JOIN log.sets_ll s on t.log_trip_id = s.log_trip_id 
WHERE	YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
AND		FLOOR(ref.GetLonDfromLon(s.lon))+0.5 between -150 and -70
AND		s.l_activity_id = 1
GROUP BY MONTH(logdate),
		FLOOR(ref.GetLatDfromLat(s.lat))+0.5,
		FLOOR(ref.GetLonDfromLon(s.lon))+0.5  SELECT 	MONTH(logdate) as month, 
		FLOOR(ref.GetLatDfromLat(s.lat))+0.5 latd,
		FLOOR(ref.GetLonDfromLon(s.lon))+0.5 lond,
		#t.sets_n nbset,
		#t.hooks_n hamecons,
		Sum(case sp_code when 'ALB' then sp_kg_est else 0 end)	AS alb_c, 
		Sum(case sp_code when 'ALB' then sp_n_est else 0 end)	AS alb_n, 
		Sum(case sp_code when 'BET' then sp_kg_est else 0 end)  AS bet_c, 
		Sum(case sp_code when 'BET' then sp_n_est else 0 end)	AS bet_n, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 0 end) 	AS yft_c, 
		Sum(case sp_code when 'YFT' then sp_n_est else 0 end)	AS yft_n,
		Sum(case sp_code when 'SKJ' then sp_kg_est else 0 end) 	AS skj_c, 
		Sum(case sp_code when 'SKJ' then sp_n_est else 0 end)	AS skj_n,
		Sum(case sp_code when 'BUM' then sp_kg_est else 0 end) 	AS bum_c, 
		Sum(case sp_code when 'BUM' then sp_n_est else 0 end)	AS bum_n, 
		Sum(case sp_code when 'MLS' then sp_kg_est else 0 end) 	AS stm_c, 
		Sum(case sp_code when 'MLS' then sp_n_est else 0 end)	AS stm_n, 
		Sum(case sp_code when 'BLM' then sp_kg_est else 0 end) 	AS blm_c, 
		Sum(case sp_code when 'BLM' then sp_n_est else 0 end)	AS blm_n, 
		Sum(case sp_code when 'SWO' then sp_kg_est else 0 end) 	AS swo_c, 
		Sum(case sp_code when 'SWO' then sp_n_est else 0 end)	AS swo_n, 
		Sum(case sp_code when 'DOL' then sp_kg_est else 0 end) 	AS mah_c, 
		Sum(case sp_code when 'DOL' then sp_n_est else 0 end)	AS mah_n, 
		Sum(case sp_code when 'WAH' then sp_kg_est else 0 end) 	AS tha_c, 
		Sum(case sp_code when 'WAH' then sp_n_est else 0 end)	AS tha_n,
		Sum(case sp_code when 'MAK' then sp_kg_est else 0 end) 	AS mak_c, 
		Sum(case sp_code when 'MAK' then sp_n_est else 0 end)	AS mak_n,
		Sum(case sp_code when 'SHK' then sp_kg_est else 0 end) 	AS shk_c, 
		Sum(case sp_code when 'SHK' then sp_n_est else 0 end)	AS shk_n,  
		Sum(case sp_code when 'SSP' then sp_kg_est else 0 end) 	AS spr_c, 
		Sum(case sp_code when 'SSP' then sp_n_est else 0 end)	AS spr_n,
		Sum(case sp_code when 'SFA' then sp_kg_est else 0 end) 	AS sai_c, 
		Sum(case sp_code when 'SFA' then sp_n_est else 0 end)	AS sai_n,
		Sum(case sp_code when 'LAG' then sp_kg_est else 0 end) 	AS sau_c, 
		Sum(case sp_code when 'LAG' then sp_n_est else 0 end)	AS sau_n,
		Sum(case sp_code when 'LEC' then sp_kg_est else 0 end) 	AS oth1_c, 
		Sum(case sp_code when 'LEC' then sp_n_est else 0 end)	AS oth1_n,
		Sum(case sp_code when 'TST' then sp_kg_est else 0 end) 	AS oth2_c, 
		Sum(case sp_code when 'TST' then sp_n_est else 0 end)	AS oth2_n,
		Sum(case sp_code when 'YFT' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BUM' then 0 when 'MLS' then 0 when 'BLM' then 0 when 'SWO' then 0 when 'DOL' then 0 when 'WAH' then 0 
			when 'MAK' then 0 when 'SHK' then 0 when 'SSP' then 0 when 'SFA' then 0 when 'LAG' then 0 when 'LEC' then 0 when 'TST' then 0 else sp_kg_est end)  AS oth_c, 
		Sum(case sp_code when 'YFT' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BUM' then 0 when 'MLS' then 0 when 'BLM' then 0 when 'SWO' then 0 when 'DOL' then 0 when 'WAH' then 0 
			when 'MAK' then 0 when 'SHK' then 0 when 'SSP' then 0 when 'SFA' then 0 when 'LAG' then 0 when 'LEC' then 0 when 'TST' then 0 else sp_n_est end) AS oth_n, 
		Sum(case when sp_code IN ('YFT','ALB','BET') then spdiscard_n else 0 end) AS REJ_T_C, 
		Sum(case when sp_code NOT IN ('YFT','ALB','BET') then spdiscard_n else 0 end) AS REJ_O_N,
		Sum(case when sp_code IN ('SMA') then spdiscard_n else 0 end) AS REJ_SMA_N,
		Sum(case when sp_code IN ('OCS') then spdiscard_n else 0 end) AS REJ_OCS_N,
		Sum(case when sp_code IN ('BSH') then spdiscard_n else 0 end) AS REJ_BSH_N,
		Sum(case when sp_code IN ('ALV') then spdiscard_n else 0 end) AS REJ_ALV_N,
		Sum(case when sp_code IN ('FAL') then spdiscard_n else 0 end) AS REJ_FAL_N,
		Sum(case when sp_code IN ('SPK') then spdiscard_n else 0 end) AS REJ_SPK_N,
		Sum(case when sp_code IN ('ALS') then spdiscard_n else 0 end) AS REJ_ALS_N,
		Sum(case when sp_code IN ('AML') then spdiscard_n else 0 end) AS REJ_AML_N,
		Sum(case when sp_code IN ('TIG') then spdiscard_n else 0 end) AS REJ_TIG_N,
		Sum(case when sp_code IN ('SHK') then spdiscard_n else 0 end) AS REJ_SHK_N,
		Sum(sp_kg_est) AS tot_c, 
		Sum(sp_n_est)  AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id
   					inner join #t on #t.month = MONTH(logdate) AND #t.latd = FLOOR(ref.GetLatDfromLat(s.lat))+0.5 AND #t.lond =  FLOOR(ref.GetLonDfromLon(s.lon))+0.5
WHERE year(logdate) = coalesce(:year, year(logdate)) AND FLOOR(ref.GetLonDfromLon(s.lon))+0.5 > -150
group by 
		MONTH(logdate), 
		FLOOR(ref.GetLatDfromLat(s.lat))+0.5,
		FLOOR(ref.GetLonDfromLon(s.lon))+0.5,
		#t.sets_n,
		#t.hooks_n",NA
"173","3d387232-ce2b-4b61-9a54-00a35e76bada"," FFA API Report - PS Unloadings - Species Level","flag_code, year","FFA API Report - PS Unloadings","Port",NA,NA,"89.1",3024,"andrewh@spc.int","brunod@spc.int","Unloading, Purseseine, API","2021-10-08T14:03:19.603"," SELECT	p.country_code,vi.flag_id flag_code, YEAR(u.unload_startdate) year, MONTH(u.unload_startdate) month,uc.sp_code,SUM(uc.sp_mt) sp_mt
FROM	unload2.carrier_loading cl INNER JOIN unload2.unloadings_ps u ON cl.carrier_loading_id = u.carrier_loading_id
		INNER JOIN unload2.unloading_catch_ps uc ON uc.unload_id=u.unload_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = u.vessel_id AND u.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date		
		INNER JOIN ref.ports p ON cl.port_id = p.port_id
WHERE	(@@entity='HIVE' OR p.country_code = @@entity)
AND		COALESCE(:flag_code,flag_id)=flag_id
AND		COALESCE(:year,YEAR(u.unload_startdate))=YEAR(u.unload_startdate)
GROUP BY p.country_code,vi.flag_id, uc.sp_code, YEAR(u.unload_startdate), MONTH(u.unload_startdate)",NA
"174","0a9710f8-d61f-47ee-b962-7a56b502c9f4"," Vessel Safety Equipment and Waste Disposal Report by Trip","min_year, max_year","Report created for FIJI showing the list of safety equipment and waste disposal information per vessel per trip","Observer",NA,"Observer","13",2979,"andrewh@spc.int","colleyf@spc.int","Observer","2022-11-15T10:30:50.523"," select tripno,
		v.vesselname,
		flag_id,
		dep_date,
		case s.lj_provided_ans when 'Y' then 1 else 0 end as lj_provided_ans,
		s.lj_sizeok_ans,
		s.lj_availability,
		s.epirb1_type,
		(coalesce(cast(s.raft1_capac as VARCHAR), '') + coalesce(cast(s.raft1_LD1 as VARCHAR), '')) as raft_capacity,
		coalesce(CONVERT(varchar(11),CAST(s.raft1_expiry as DATETIME),103), '') as raft_expiry,
		s.buoys_n,
		coalesce(t.is_waste_disposal, 0) has_waste_disposal,
		t.waste_disposal_desc
from obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
		inner join obsv.vess_safety s on s.obstrip_id = t.obstrip_id
where YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))",NA
"175","7747d5c1-11cb-4514-a180-b153e6298e3d"," DCT Report -- PS Trip information","year","Report to list the DCT performance in entering PS trips by YEAR, MONTH","",NA,"Observer","2",2983,"andrewh@spc.int","colleyf@spc.int","Observer","2022-01-15T12:10:22.313"," SELECT assigned_to as entered_by,
       year(closed_date) as yr, 
       month(closed_date) as mon,
       count(distinct ot.obstrip_id) as trips, 
       count(distinct sd.s_day_id) as days, 
       count(distinct sa.s_daylog_id) as events, 
       count(distinct ss.s_set_id) as sets, 
       count(distinct slf.s_lfmeas_id) as samples 
FROM [obsv].[trip] ot    LEFT outer join [obsv].[s_day] sd on ot.obstrip_id = sd.obstrip_id 
                                 LEFT OUTER JOIN [obsv].[s_daylog] sa on sd.s_day_id = sa.s_day_id
                                 LEFT OUTER JOIN [obsv].[s_set] ss on ss.s_daylog_id = sa.s_daylog_id
                                 LEFT OUTER JOIN [obsv].[s_lf] slfd on slfd.s_set_id = ss.s_set_id
                                 LEFT OUTER JOIN [obsv].[s_lfmeas] slf on slfd.s_lf_id = slf.s_lf_id
WHERE year(closed_date) = :year and assigned_to is not null and CHARINDEX('spc.int',assigned_to) = 0
group by assigned_to, year(closed_date), month(closed_date)",NA
"176","1adfc763-7c06-4a3f-a407-9601bce0b554"," PURSE SEINE -- Shark Catches and FATE, by YEAR","flag_code, year",NA,"Observer",NA,"Observer","9",2987,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2025-01-27T14:31:25.49"," SELECT 	
		'S' as gear,
		coalesce(sa.schas_id,20)-20 as set_type,
		sp.sp_name as species,
        sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Number, 
        sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Retain, 
        sum(case when coalesce(fate_code,'   ') in ('RFR')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Finned_Retain, 
        sum(case when LEFT(coalesce(fate_code,' '),1) in ('R') and coalesce(fate_code,'   ') not in ('RFR')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Retain_OR, 
        sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard, 
        sum(case when coalesce(fate_code,'   ') in ('DSO')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard_Struck_Off,
        sum(case when coalesce(fate_code,'   ') in ('DFR')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Finned_Trunk_Discard,
        sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and coalesce(fate_code,'   ') not in ('DFR','DSO')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard_OR,
        sum(case when coalesce(fate_code,'   ') in ('ESC')    then    
                     case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Escaped
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'SHK' 
GROUP BY 
coalesce(sa.schas_id,20)-20,
	sp.sp_name",NA
"177","b33a59ee-a024-47c8-b328-db7e1bd6b034"," MAP - IATTC -- LONGLINE Catch and effort in IATTC Area BY MONTH","year","Report produced on request for Vanuatu. IATTC -- LONGLINE Catch in IATTC Area for IATTC reporting requirements. (5x5 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"22",2991,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-09-23T15:50:04.72","WITH cte as (
SELECT  floor(ref.getlatdfromlat(lat)/5)*5+2.5 as latitude,
        floor(ref.getlondfromlon(lon)/5)*5+2.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
group by floor(ref.getlatdfromlat(lat)/5)*5+2.5,
         floor(ref.getlondfromlon(lon)/5)*5+2.5, 
         FORMAT(logdate, 'yyyy-MM')   
         ) SELECT		floor(ref.getlatdfromlat(lat)/5)*5+2.5 as latitude,
            floor(ref.getlondfromlon(lon)/5)*5+2.5 as longitude,
            FORMAT(logdate, 'yyyy-MM') as yearmonth,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips, 
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS alb_mt, 
            cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)                                      as decimal(7,0))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS bet_mt, 
            cast(Sum(case sp_code when 'BET' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS yft_mt, 
            cast(Sum(case sp_code when 'YFT' then sp_n_est else 0 end)                                      as decimal(7,0))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS skj_mt, 
            cast(Sum(case sp_code when 'SKJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS pbf_mt, 
            cast(Sum(case sp_code when 'PBF' then sp_n_est else 0 end)                                      as decimal(7,0))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS bum_mt, 
            cast(Sum(case sp_code when 'BUM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS blm_mt, 
            cast(Sum(case sp_code when 'BLM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS mls_mt, 
            cast(Sum(case sp_code when 'MLS' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then sp_kg_est else 000.0 end) / 1000                         as decimal(5,2))  AS swo_mt, 
            cast(Sum(case sp_code when 'SWO' then sp_n_est else 0 end)                                      as decimal(7,0))  AS swo_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and s.logdate between v.start_date and v.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.getlatdfromlat(lat)/5)*5+2.5 = cte.latitude
                                                        and floor(ref.getlondfromlon(lon)/5)*5+2.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
group by floor(ref.getlatdfromlat(lat)/5)*5+2.5,floor(ref.getlondfromlon(lon)/5)*5+2.5, FORMAT(logdate, 'yyyy-MM')",NA
"178","013c9e3b-5ed7-4c01-9ba5-49d94291e7dd"," Tufman 2 (Chart) - Number of validations by DCT","year","See how many trips you have validated vs not validated","",1,NA,"2",3036,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, MyFleet","2021-10-18T12:50:15.507"," SELECT coalesce(accepted_by, 'Still Pending') as accepted_by,
	  count(*) as number
FROM [tufman2].[tuf2].[check_result_lines]
WHERE instance_source = ref.getBitFromEntity(@@entity) AND
	check_level = 'VerificationRequired' AND
		year(entered_date) = coalesce(:year, year(entered_date))
          
GROUP BY accepted_by",NA
"179","bf47b444-4ae8-474e-a743-ea3d711f8434"," CMM 11-04 - OCEANIC WHITETIP shark interactions in Purse seine & Longline fisheries","flag_code, year","CCMs shall estimate, through data collected from observer programs and other means, the number of releases of oceanic whitetip shark, including the status upon release (dead or alive), and report this information to the WCPFC in Part 1 of their Annual Reports.","Logsheets",NA,NA,"25",2956,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2022-05-18T11:54:49.777"," SELECT  'PS' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
		catch_ps.sp_n as number,
		catch_ps.sp_n_est as number_est,
		catch_ps.sp_mt * 1000 as weight,
		catch_ps.sp_mt_est * 1000 as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when discard=1 then 'Discarded' else 'Retained' end as fate
        
FROM    log.trips_ps trip_ps 
			inner join ref.vessel_instances vi 
					on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code

WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_code = 'OCS' 

UNION  

SELECT  'LL' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
		COALESCE(catch_ll.sp_n,0)+COALESCE(spdiscard_n,0) as number,
        COALESCE(catch_ll.sp_n_est,0)+COALESCE(spdiscard_n,0) as number_est,
		catch_ll.sp_kg as weight,
		catch_ll.sp_kg_est as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when spdiscard_n>0 then 'Discarded' else 'Retained' end as life_status
        
FROM    log.trips_ll trip_ll 
			inner join ref.vessel_instances vi 
					on trip_ll.vessel_id = vi.vessel_id AND trip_ll.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ll set_ll on set_ll.log_trip_id = trip_ll.log_trip_id
        inner join log.catch_ll catch_ll on catch_ll.log_set_id = set_ll.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ll.sp_code

WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_code = 'OCS'",NA
"180","7acaaf4e-c578-479f-8e0c-1209c2d7131d","LONGLINE - Missing sets - SQL SEEMS TO BE TRUNCATED","","List of missing sets","",NA,NA,"4",2960,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, DataQuality","2021-10-07T11:41:40.277"," SELECT vessel_name, flag_code, depart_date, return_date, dt 
FROM #missing_set",NA
"181","76a09f5d-182e-4309-aa61-7a91e763b47f"," Part1 - OPTIONAL - Map of PURSE SEINE CATCH in the Home EEZ (national waters) 5x5","year","Map of PURSE SEINE CATCH in the Home EEZ (national waters) in 5x5","Logsheets",2,NA,"99b",2914,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Purseseine, CMM","2025-07-24T09:44:21.507"," SELECT  floor(latd/5)*5+2.5 Latitude,
		floor(case when s.lond < 0 then s.lond + 360 else s.lond end/5)*5+2.5 Longitude, 
		Sum(case sp_code when 'SKJ' then sp_mt_est else 0000 end)				AS skj_c, 
		Sum(case sp_code when 'YFT' then sp_mt_est else 0000 end) 				AS yft_c,
		Sum(case sp_code when 'BET' then sp_mt_est else 0000 end) 				AS bet_c 		
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(latd/5)*5+2.5,
		floor(case when s.lond < 0 then s.lond + 360 else s.lond end/5)*5+2.5",NA
"182","6b051013-fbfb-49e3-8428-e3eec1bb20f5"," CMM 09-03 – South Pacific Swordfish catch by National Fleet","flag_code, year","CCMs shall report to the Commission the total number of vessels that fished for swordfish and the total catch of swordfish for the following:
a. vessels flying their flag anywhere in the Convention Area south of 20°S other than vessels operating under charter, lease or other similar mechanism as part of the domestic fishery of another CCM;
b. vessels operating under charter, lease or other similar mechanism as part of their domestic fishery south of 20°S; and
c. any other vessels fishing within their waters south of 20°S.
This information shall be provided in Part 1of each CCM’s annual report. Initially, this information will be provided in the template provided at Annex 2 for the period 2000-2009 and then updated annually.","Logsheets",NA,NA,"22",2918,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2023-07-13T07:57:50.813"," SELECT  vi.flag_id as flag, 
		year(logdate) as yr,
		COUNT(distinct case when RIGHT(lat,1) = 'S' and left(lat,2) >= '20' then t.vessel_id else null end) as vessels,
		SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'S' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as SWO_n,
		cast(SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'S' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as SWO_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
   AND in_wcpfc_area = 1
group by vi.flag_id, year(logdate)",NA
"183","5ed9c890-760b-4c32-8402-665a2e5bf3a9","PURSE SEINE - Vessel trip catch by set - BY FLAG ","flag_code, year",NA,"Logsheets",NA,NA,"13",2904,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Raised, Tuna","2021-11-11T09:00:38.983"," select	:group_by,
		vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,  
		convert(nvarchar(10),s.logdate,103) logdate,
		month(logdate) as month,
		s.lat,
		s.lon,
		ref.GetLatDfromLat(s.lat) as latd,
		ref.GetLonDfromLon(s.lon) as lond,
		set_time,
		school_id,
		s.eez_code,
		s_activity_id,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as decimal(8,3))   AS skj_mt,
		cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as decimal(8,3))  AS bet_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end)  as decimal(8,3))    AS yft_mt
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id 
and     s_activity_id in (1,2)
group by :group_by, vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id , s.logdate,s.lat,s.lon,month(logdate),set_time,school_id,s.eez_code, s_activity_id","Year"
"184","053f83c0-3436-444f-bcdc-9fdf8a6498db"," Bryan's Report","year","Requested by FFA for tufman 2 - IMS integration","Logsheets",NA,NA,"50",3003,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, PoleAndLine, Purseseine, API","2021-10-08T14:04:15.717"," SELECT year(S.logdate) as YY, month(S.logdate) as MM,
      'PS' AS gear_code, S.eez_code, 
  V.flag_id as flag_code,
  SUM(DATEDIFF(MM, T.depart_date, T.return_date)) AS days_n,       
       COUNT(DISTINCT T.log_trip_id) AS trips_n,
       COUNT(DISTINCT T.vessel_id) AS vessels_n,
  COUNT(DISTINCT S.log_set_id) AS sets_n,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_mt else 0 end) as bet_mt,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_n else 0 end) as bet_n,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_mt else 0 end) as yft_mt,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_n else 0 end) as yft_n,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_mt else 0 end) as skj_mt,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_n else 0 end) as skj_n,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_mt else 0 end)/1000.0 as alb_mt,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_n else 0 end) as alb_n,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_mt else 0 end) as oth_mt,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_n else 0 end) as oth_n,
  SUM(sp_mt) as tot_mt,
  SUM(sp_n) as tot_n
  FROM log.trips_ps T
 INNER JOIN log.sets_ps S on T.log_trip_id = S.log_trip_id
 INNER JOIN log.catch_ps C on S.log_set_id = C.log_set_id
  LEFT OUTER JOIN ref.vessel_instances V on T.vessel_id = V.vessel_id and T.depart_date >= V.start_date and t.return_date <= V.calculated_end_date
 WHERE :year=year(S.logdate)
 GROUP BY year(S.logdate), month(S.logdate), S.eez_code, V.flag_id
 UNION
 SELECT year(S.logdate) as YY, month(S.logdate) as MM,
      'LL' AS gear_code, S.eez_code, 
  V.flag_id as flag_code,
  SUM(DATEDIFF(MM, T.depart_date, T.return_date)) AS days_n,       
       COUNT(DISTINCT T.log_trip_id) AS trips_n,
       COUNT(DISTINCT T.vessel_id) AS vessels_n,
  COUNT(DISTINCT S.log_set_id) AS sets_n,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_kg else 0 end)/1000.0 as bet_mt,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_n else 0 end) as bet_n,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_kg else 0 end)/1000.0 as yft_mt,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_n else 0 end) as yft_n,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_kg else 0 end)/1000.0 as skj_mt,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_n else 0 end) as skj_n,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_kg else 0 end)/1000.0 as alb_mt,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_n else 0 end) as alb_n,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_kg else 0 end)/1000.0 as oth_mt,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_n else 0 end) as oth_n,
  SUM(sp_kg)/1000.0 as tot_mt,
  SUM(sp_n) as tot_n
  FROM log.trips_ll T
 INNER JOIN log.sets_ll S on T.log_trip_id = S.log_trip_id
 INNER JOIN log.catch_ll C on S.log_set_id = C.log_set_id
  LEFT OUTER JOIN ref.vessel_instances V on T.vessel_id = V.vessel_id and T.depart_date >= V.start_date and t.return_date <= V.calculated_end_date
 WHERE :year=year(S.logdate) 
 GROUP BY year(S.logdate), month(S.logdate), S.eez_code, V.flag_id
 UNION
 SELECT year(S.logdate) as YY, month(S.logdate) as MM,
      'PL' AS gear_code, S.eez_code, 
  V.flag_id as flag_code,
  SUM(DATEDIFF(MM, T.depart_date, T.return_date)) AS days_n,       
       COUNT(DISTINCT T.log_trip_id) AS trips_n,
       COUNT(DISTINCT T.vessel_id) AS vessels_n,
  COUNT(DISTINCT S.log_set_id) AS sets_n,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_mt else 0 end) as bet_mt,
  SUM(CASE WHEN sp_code = 'BET' THEN sp_n else 0 end) as bet_n,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_mt else 0 end) as yft_mt,
  SUM(CASE WHEN sp_code = 'YFT' THEN sp_n else 0 end) as yft_n,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_mt else 0 end) as skj_mt,
  SUM(CASE WHEN sp_code = 'SKJ' THEN sp_n else 0 end) as skj_n,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_mt else 0 end)/1000.0 as alb_mt,
  SUM(CASE WHEN sp_code = 'ALB' THEN sp_n else 0 end) as alb_n,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_mt else 0 end) as oth_mt,
  SUM(CASE WHEN sp_code = 'OTH' THEN sp_n else 0 end) as oth_n,
  SUM(sp_mt) as tot_mt,
  SUM(sp_n) as tot_n
  FROM log.trips_pl T
 INNER JOIN log.sets_pl S on T.log_trip_id = S.log_trip_id
 INNER JOIN log.catch_pl C on S.log_set_id = C.log_set_id
  LEFT OUTER JOIN ref.vessel_instances V on T.vessel_id = V.vessel_id and T.depart_date >= V.start_date and t.return_date <= V.calculated_end_date
 WHERE :year=year(S.logdate)
 GROUP BY year(S.logdate), month(S.logdate), S.eez_code, V.flag_id",NA
"185","85d69ade-4c5f-427e-b231-9a5423e79d3e"," LONGLINE Unloadings / Port sampling coverage","",NA,"Logsheets",1,NA,"3.2.3",3040,"andrewh@spc.int","brunod@spc.int","PortSampling, Unloading, Longline, CoverageMissingData","2021-10-26T11:56:40.273"," SELECT	YEAR(t.depart_date) year, 
		CONVERT(DECIMAL(5,2),count(distinct l.dto_guid_right)*100.0/count(distinct t.log_trip_id)) cov_unloading,
		CONVERT(DECIMAL(5,2),count(distinct l2.dto_guid_right)*100.0/count(distinct t.log_trip_id)) cov_ps
FROM	log.trips_ll t LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO'  AND l.dto_type_right='UnloadingDTO'
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO'  AND l2.dto_type_right='PortSamplingDTO'
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(t.depart_date) >= YEAR(GETDATE())-10
GROUP BY YEAR(t.depart_date)",NA
"186","2521657c-b6ee-4ab0-94e3-bf3d5a2984d4"," LONGLINE - Vessel set catch, effort and CPUE - BY FLAG","flag_code, year",NA,"Logsheets",NA,NA,"13",2893,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, MyEEZ, Raised, Tuna","2021-09-14T15:52:19.293"," SELECT  v.flag_id flag_code, 
		v.vesselname vessel_name,
		convert(nvarchar(10),t.depart_date, 103) as depart_date, 
		convert(nvarchar(10),return_date, 103) as return_date, 
		convert(nvarchar(10),logdate, 103) as log_date, 
		latd as lat,
		lond as lon,
		hooks_n,  
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000 				as decimal(5,2))	AS alb_mt, 
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / hooks_n			as decimal(6,2))	AS alb_cpue, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 000.0 end)  / hooks_n			as decimal(6,2))	AS alb_npue, 
		cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) /1000 				as decimal(5,2))	AS bet_mt, 
		cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) / hooks_n   		as decimal(6,2)) 	AS bet_cpue, 
		cast(Sum(case sp_code when 'BET' then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n, 
		cast(Sum(case sp_code when 'BET' then sp_n_est else 000.0 end)  / hooks_n			as decimal(6,2))	AS bet_npue, 
		cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end) /1000				as decimal(5,2))	AS yft_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end) / hooks_n			as decimal(6,2))	AS yft_cpue, 
		cast(Sum(case sp_code when 'YFT' then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		cast(Sum(case sp_code when 'YFT' then sp_n_est else 000.0 end)  / hooks_n			as decimal(6,2))	AS yft_npue, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'ALB' then 0 when 'BET' then 000.0 else sp_kg_est end)/1000 as decimal(5,0)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'ALB' then 0 when 'BET' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(5,2)) 	AS tot_mt, 
		cast(Sum(sp_n_est)         															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.depart_date BETWEEN v.start_date AND v.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and v.flag_id	= coalesce(:flag_code,v.flag_id)
    AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by v.flag_id,
		v.vesselname,
		t.depart_date,
		t.return_date,
		convert(nvarchar(10),logdate, 103), 
		latd,
		lond,
		month(logdate),
		hooks_n",NA
"187","a5d8acbf-35d7-44a0-a26e-a8a50111b28d"," DCT ratings by observer by year","obsv_prg","Average observer quality ratings, as recorded by the DCTs during entry.","Observer",NA,"Observer","99",3243,"andrewh@spc.int","colleyf@spc.int","Observer","2024-09-24T14:02:30.947"," SELECT  :group_by,  
		s.family_name,
       s.first_name,
	   tripno,
	   year(dep_date) as year,
       CONVERT(DECIMAL(3,2),AVG(CONVERT(DECIMAL(2,1),LEFT(dct_score,1)))) Legibility,
       CONVERT(DECIMAL(3,2),AVG(CONVERT(DECIMAL(2,1),RIGHT(LEFT(dct_score,2),1)))) Errors,
       CONVERT(DECIMAL(3,2),AVG(CONVERT(DECIMAL(2,1),LEFT(RIGHT(dct_score,2),1)))) Missing_Pages,
       COUNT(*) nb_trips
FROM    obsv.trip t join ref.field_staff s ON t.observer_id = s.staff_id
where    dct_score is not null
		and t.obsprg_code = coalesce(:obsv_prg, t.obsprg_code)
GROUP BY :group_by,
		s.family_name,
       s.first_name,
	   tripno,
	   year(dep_date)","ProgramCode"
"188","7ab43e92-a0e6-4000-ac89-0a3a001e36b9"," CMM 08-03 - MARINE TURTLE interactions in the Longline and Purse seine fisheries","flag_code, year",NA,"Observer",NA,"Observer","5",2943,"andrewh@spc.int","andrewh@spc.int","Observer, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2021-11-30T16:28:30.327"," SELECT 	
		'S' as gear, 
		sp.sp_name as species,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Total_Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Total_Discard, 
		sum(case when left(coalesce(discard_cond_code,' '),1) in ('A') and LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Total_Alive, 
		sum(case when left(coalesce(discard_cond_code,' '),1) in ('D') and LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Total_Dead,
		sum(case when left(coalesce(discard_cond_code,'U'),1) in ('U') and LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Total_Unknown,
		sum(case when left(coalesce(discard_cond_code,' '),1) in ('A') and LEFT(coalesce(fate_code,' '),1) in ('D') and gr_interact_code is not null	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Released_Alive_Before_Landing,
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and LEFT(coalesce(fate_code,' '),1) in ('D') and gr_interact_code is null	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discarded_after_Landing
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'TTX' 
GROUP BY  
	sp.sp_name 
UNION 
SELECT 	
		'L' as gear, 
		sp.sp_name, 
		sum(1) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then 1 else 000000 end)  as Total_Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then 1 else 000000 end) as Total_Discard, 
		sum(case when left(coalesce(cond_code2,' '),1) in ('A')	and LEFT(coalesce(fate_code,' '),1) in ('D')	then 1 else 000000 end)  as Total_Alive, 
		sum(case when left(coalesce(cond_code2,' '),1) in ('D') and LEFT(coalesce(fate_code,' '),1) in ('D')		then 1 else 000000 end)  as Total_Dead,
		sum(case when left(coalesce(cond_code2,'U'),1) in ('U') and LEFT(coalesce(fate_code,' '),1) in ('D')		then 1 else 000000 end)  as Total_Unknown,
		sum(case when left(coalesce(cond_code2,' '),1) in ('A') and LEFT(coalesce(fate_code,' '),1) in ('D') and gr_interact_code is not null then 1 else 000000 end)  as Released_Alive_Before_Landing,
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and LEFT(coalesce(fate_code,' '),1) in ('D') and gr_interact_code is null then 1 else 000000 end)  as Discarded_after_Landing
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'TTX' 
GROUP BY  
	sp.sp_name",NA
"189","15065b8f-d582-46c0-ba53-ce42c363b070","PURSE SEINE - NATIONAL FLEET - VESSEL Catch Report ","year",NA,"Logsheets",NA,NA,"4",2899,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting, Tuna","2021-10-07T13:46:31.56"," SELECT  vi.vesselname vessel_name,
		YEAR(logdate) year, 
		COUNT(distinct s.log_trip_id) as trips, 
		COUNT(distinct cast(s.log_trip_id as varchar(100)) + cast(cast(logdate as date) as varchar(100)) ) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(100)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		CAST(SUM(case when sp_code = 'SKJ' then c.sp_mt_est else 000.000 end) as int) as skj_c, 
        CAST(SUM(case when sp_code = 'YFT' then c.sp_mt_est else 000.000 end) as int) as yft_c, 
        CAST(SUM(case when sp_code = 'BET' then c.sp_mt_est else 000.000 end) as int) as bet_c, 
        CAST(SUM(case when sp_code in('SKJ','YFT','BET') then 000.000 else c.sp_mt_est end) as int) as oth_c, 
        CAST(SUM(c.sp_mt_est) as decimal(9,1)) as tot_c  
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
WHERE COALESCE(:year, YEAR(logdate)) = YEAR(logdate) 
group by vi.vesselname, YEAR(logdate)",NA
"190","40cf2e83-a6ee-44d2-9585-f3f2e9bd0606"," CMM 10-07 - Shark catches by NATIONAL FLEET SUMMARY","flag_code, year","Each CCM shall include key shark species*, as identified by the Scientific Committee, in their annual reporting to the Commission of annual catch and fishing effort statistics by gear type, including available historical data, in accordance with the WCPF Convention and agreed reporting procedures. …
*footnote 2: The key shark species are blue shark, silky shark, oceanic whitetip shark, mako sharks, and thresher sharks, porbeagle shark (south of 20°S, until biological data shows this or another geographic limit to be appropriate) and hammerhead sharks (winghead, scalloped, great, and smooth).]
Whale Sharks (Rhincodon typus) was included as a key shark species by SC8 (2012)","Logsheets",NA,NA,"26",2999,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2022-02-01T13:43:05.313","with #temp (gear, flag, species, number, number_est, weight, weight_est, date, lat, lon, eez_code, fate) 
as (SELECT  'PS' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
        catch_ps.sp_n as number,
        catch_ps.sp_n_est as number_est,
        catch_ps.sp_mt * 1000 as weight,
        catch_ps.sp_mt_est * 1000 as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when discard=1 then 'Discarded/Released' else 'Retained' end as fate
FROM    log.trips_ps trip_ps 
			inner join ref.vessel_instances vi 
					on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_cat_code = 'SHK' 
UNION  
SELECT  'LL' as gear,   
        vi.flag_id as flag,
        sp.sp_name as species,
        COALESCE(catch_ll.sp_n,0)+COALESCE(spdiscard_n,0) as number,
        COALESCE(catch_ll.sp_n_est,0)+COALESCE(spdiscard_n,0) as number_est,
        catch_ll.sp_kg as weight,
        catch_ll.sp_kg_est as weight_est,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        case when spdiscard_n>0 then 'Discarded/Released' else 'Retained' end as life_status
FROM    log.trips_ll trip_ll 
			inner join ref.vessel_instances vi 
					on trip_ll.vessel_id = vi.vessel_id AND trip_ll.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ll set_ll on set_ll.log_trip_id = trip_ll.log_trip_id
        inner join log.catch_ll catch_ll on catch_ll.log_set_id = set_ll.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ll.sp_code
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND sp.sp_cat_code = 'SHK') 

select gear,
		flag,
		species,
		fate,
		SUM(number_est) as NumCaught,
		SUM(weight_est) /1000 as WeightCaught
from #temp
group by gear, flag, species, fate",NA
"191","1a41622b-7e5d-40b4-b777-1273c6f38dad"," CMM 10-07 - Shark catches by NATIONAL FLEET","flag_code, year","Each CCM shall include key shark species*, as identified by the Scientific Committee, in their annual reporting to the Commission of annual catch and fishing effort statistics by gear type, including available historical data, in accordance with the WCPF Convention and agreed reporting procedures. …
*footnote 2: The key shark species are blue shark, silky shark, oceanic whitetip shark, mako sharks, and thresher sharks, porbeagle shark (south of 20°S, until biological data shows this or another geographic limit to be appropriate) and hammerhead sharks (winghead, scalloped, great, and smooth).]
Whale Sharks (Rhincodon typus) was included as a key shark species by SC8 (2012)","Observer",NA,"Observer","8",2939,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Purseseine, CMM, RegionalReporting, ByCatch","2024-08-07T02:17:51.123"," SELECT 	
		'S' as gear, 
		sp.sp_name as species,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard, 
sum(case when LEFT(coalesce(fate_code,' '),1) not in ('R','D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Unknown, 
		sum(case when coalesce(fate_code,'   ') in ('RFR')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Finned_Retain, 
		sum(case when coalesce(fate_code,'   ') in ('DFR')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Finned_Trunk_Discard,
		case when in_AWs = 0 then 'N' else 'Y' end as AWs
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'SHK' 
GROUP BY  
	sp.sp_name,case when in_AWs = 0 then 'N' else 'Y' end
UNION 
SELECT 	
		'L' as gear, 
		sp.sp_name, 
		sum(1) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then 1 else 000000 end)  as Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D','E')	then 1 else 000000 end) as Discard, 
sum(case when LEFT(coalesce(fate_code,' '),1) not in ('R','D','E')	then 1 else 000000 end) as Unknown, 
		sum(case when coalesce(fate_code,'   ') in ('RFR')		then 1 else 000000 end)  as Finned_Retain, 
		sum(case when coalesce(fate_code,'   ') in ('DFR')		then 1 else 000000 end)  as Finned_Trunk_Discard,
		case when in_AWs = 0 then 'N' else 'Y' end as AWs
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog sh on sh.l_set_id=ls.l_set_id and stend_id=83
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'SHK' 
GROUP BY  
	sp.sp_name,case when in_AWs = 0 then 'N' else 'Y' end",NA
"192","332ac8e5-434a-4498-82a0-0b95ccd26a54"," ARTISANAL - Number of active vessels","year","Number of active vessels per landing sites","Artisanal",NA,NA,"2",3078,"andrewh@spc.int","andrewh@spc.int","Artisanal","2023-03-28T11:20:25.117"," SELECT	YEAR(trip_date) year, :group_by,tr.value_en as powermode,COUNT(DISTINCT v.vessel_id) nb_vessels
FROM	art2.trips t INNER JOIN art2.landing_sites l ON l.landing_site_id = t.landing_site_id
		INNER JOIN art2.regions r ON l.region_id = r.region_id
		INNER JOIN art2.vessels v ON t.vessel_id = v.vessel_id
		LEFT OUTER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalVesselPowerModes' + CONVERT(VARCHAR,v.boat_power_id)
WHERE	YEAR(trip_date)=coalesce(:year,year(trip_date))
GROUP BY YEAR(trip_date), :group_by,tr.value_en","LandingSiteName"
"193","685febf9-0191-4d16-a513-76ce8b60b841"," LONGLINE - Catch by target species - MAP","flag_code, year","MAP -- LONGLINE Catch by target SPECIES","Logsheets",2,NA,"21",2895,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, MyEEZ, Tuna","2021-11-09T13:56:34.453"," SELECT  :group_by, 
		Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000				AS alb_mt, 
		Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000				AS bet_mt, 
		Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000				AS yft_mt 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by :group_by","LatitudeLongitude"
"194","71d03c05-6338-48ce-a906-cbeb453c3e7f"," Part1 - Table 2/Figure 2 - PURSE SEINE  - Number of vessels by gear type and size (fleet structure)","","PART 1 REPORT (Essential Information 2) - Number of National PURSE SEINE Fleet vessels, by size category, active in the WCPFC Convention Area","Logsheets",1,NA,"3b",2910,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, CMM","2022-03-03T07:44:40.7"," SELECT	YY as YR, 
		vess_cat1_n as v1, 
		vess_cat2_n as v2,
		vess_cat3_n as v3,
		vess_cat4_n as v4,
		0000		as v_u,
		vess_n		as vtot 
FROM   [WCPFC_YEARBOOK].[dbo].[A_ACE] a1 
WHERE a1.YY >= YEAR(GETDATE())-1-4
AND (@@entity = 'HIVE' OR a1.flag_code COLLATE DATABASE_DEFAULT = @@entity )
		and a1.GEAR_CODE = 'S'
		and a1.ocean_code = 'WX'	
UNION 
SELECT	YEAR(l.FIRST_LOGDATE)as YR, 
		count(distinct case when coalesce(grt,0) > 0 and coalesce(grt,0) <=500		then vi.vesselname_normalised else null end) as v1,
		count(distinct case when coalesce(grt,0) > 500 and coalesce(grt,0) <=1000		then vi.vesselname_normalised else null end) as v2,
		count(distinct case when coalesce(grt,0) > 1000 and coalesce(grt,0) <=1500	then vi.vesselname_normalised else null end) as v3,
		count(distinct case when coalesce(grt,0) > 1500								then vi.vesselname_normalised else null end) as v4,
		count(distinct case when coalesce(grt,0) = 0								then vi.vesselname_normalised else null end) as v_u,
		count(distinct vi.vesselname_normalised) as vtot
FROM  ref.vessel_instances vi 
				INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.trips_ps l ON l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE (YEAR(l.FIRST_LOGDATE) = YEAR(GETDATE())-1)
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by	YEAR(l.FIRST_LOGDATE)",NA
"195","6138609f-09af-419c-8cb9-6a5df9068196"," PURSE SEINE - Observer Effort MAP data","eez_code, flag_code, year, obsv_prg","Produces an extract of Observer effort with GIS fields for mapping, selected by YEAR, Observer Programme and Flag","Observer",NA,"Observer","4",2922,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2022-02-15T15:31:34.027"," SELECT 	
		:group_by, 
		COUNT( DISTINCT cast(ot.vessel_id as varchar(50)) + cast(cast(act_date as date) as varchar(10))) as days, 
		SUM( case when s_activ_id = 1 and schas_id-20 in (1,2)		then 00001 else 00000 end) as una_sets, 
		SUM( case when s_activ_id = 1 and schas_id-20 in (3,4,5,6)	then 00001 else 00000 end) as all_ass_sets, 
		SUM( case when s_activ_id = 1 and schas_id-20 = 3			then 00001 else 00000 end) as log_sets,  
		SUM( case when s_activ_id = 1 and schas_id-20 = 4			then 00001 else 00000 end) as dfad_sets,  
		SUM( case when s_activ_id = 1 and schas_id-20 = 5			then 00001 else 00000 end) as afad_sets,  
		SUM( case when s_activ_id = 1 and schas_id-20 > 5			then 00001 else 00000 end) as oth_sets  
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
AND eez_code = coalesce(:eez_code,eez_code)
    /* AND ot.tripno = coalesce(trip_id,ot.tripno)  */
	AND s_activ_id in (1,2) 
	AND lon is not null
	AND lat is not null 
	AND coalesce(schas_id,20) > 20
GROUP BY  :group_by","Longitude(5x5)MapinfoLatitude(5x5)Mapinfo"
"196","98796f2a-268a-49c5-9cce-a6e300a2fc08"," LONGLINE Observer Trip -- Set/Haul Summary","year, trip_id","A Summary of SETTING and HAULING information from the selected LONGLINE observer trip","Observer",NA,"Observer","18",3144,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2025-03-28T14:26:05.11"," Select obsprg_code,vesselname,staff_code, 'T'+tripno as tripno,set_date,month(set_date) as month,datepart(quarter,set_date) as quarter,hook_set,hook_observed,lspeed,branch_length,branch_intvl branch_intvl_s,branch_dist branch_dist_m,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0) as bait_wt,
h1.latd as start_latd, 
h1.lond as start_lond, 
CONVERT(varchar,h1.log_dtime,108) as start_set_time,
CONVERT(varchar,h2.log_dtime,108) as end_set_time,
CONVERT(varchar,h3.log_dtime,108) as start_haul_time,
CONVERT(varchar,h4.log_dtime,108) as end_haul_time,
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108) as Setting_duration,
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108) as Haulling_duration,
count(l_setcatch_id) as catch_n,
hk_bt_flt,
bask_set,
mline_len,
lightsticks
from obsv.trip ot 
join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
Join obsv.l_sethaullog h1 on h1.l_set_id = s.l_set_id and h1.stend_id=83
left Join obsv.l_sethaullog h2 on h2.l_set_id = s.l_set_id and h2.stend_id=84
left Join obsv.l_sethaullog h3 on h3.l_set_id = s.l_set_id and h3.stend_id=85
left Join obsv.l_sethaullog h4 on h4.l_set_id = s.l_set_id and h4.stend_id=86
left Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
left join ref.species sp on sc.sp_code = sp.sp_code
left join obsv.l_gear g on g.obstrip_id = ot.obstrip_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(set_date) = coalesce(:year, YEAR(set_date))
group by vesselname,staff_code,tripno,set_date,hook_set,lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0),cast(h1.log_dtime as time(0)),
CONVERT(varchar,h1.log_dtime,108),
CONVERT(varchar,h2.log_dtime,108),
CONVERT(varchar,h3.log_dtime,108),
CONVERT(varchar,h4.log_dtime,108),
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108),
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108),
hk_bt_flt,
bask_set,
h1.latd, 
h1.lond,
mline_len,
month(set_date),
datepart(quarter,set_date),
hook_observed,
obsprg_code,
lightsticks",NA
"197","329b6954-1a8e-41b7-a73d-e83c9d54e7a9"," PURSE SEINE - Catch - BY FLAG","flag_code, year",NA,"Logsheets",2,NA,"21",2903,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, MyEEZ, Tuna","2021-10-19T15:51:30.983"," SELECT 	floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as Latitude,
		floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as Longitude,
		cast(SUM(case when sp_code = 'SKJ' then c.sp_mt else 000.000 end) as int) as skj_c, 
        cast(SUM(case when sp_code = 'YFT' then c.sp_mt else 000.000 end) as int) as yft_c, 
        cast(SUM(case when sp_code = 'BET' then c.sp_mt else 000.000 end) as int) as bet_c, 
        cast(SUM( case when sp_code = 'SKJ' and school_id in (1,2)    
                    then c.sp_mt else 000.000 end) as int)  as skj_una, 
        cast(SUM( case when sp_code = 'YFT' and school_id in (1,2)    
                    then c.sp_mt else 000.000 end) as int)  as yft_una, 
        cast(SUM( case when sp_code = 'BET' and school_id in (1,2)    
                    then c.sp_mt else 000.000 end) as int)  as bet_una, 
        cast(SUM( case when sp_code = 'SKJ' and school_id in (3,4,5,6)    
                    then c.sp_mt else 000.000 end) as int)  as skj_ass, 
        cast(SUM( case when sp_code = 'YFT' and school_id in (3,4,5,6)    
                    then c.sp_mt else 000.000 end) as int)  as yft_ass, 
        cast(SUM( case when sp_code = 'BET' and school_id in (3,4,5,6)    
                    then c.sp_mt else 000.000 end) as int)  as bet_ass
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id
WHERE year(logdate)			= coalesce(:year, year(logdate)) 
AND COALESCE(:flag_code, vi.flag_id) = vi.flag_id
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonDfromLon(lon)/5)*5+2.5",NA
"198","cdf09434-12e3-49aa-99cb-7b6dd7a9a7aa"," LONGLINE - Tuna catch and effort (incl. unverified) - BY FLAG","eez_code, flag_code, year","BY FLAG - Tuna Catch and Effort by EEZ","Logsheets",NA,NA,"11b",3074,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, ByVessel, Tuna","2022-01-10T15:46:32.64"," SELECT  vi.flag_id flag_code, 
		:group_by, 
		COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips,
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when l_activity_id in (1) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		max(tmp.hhooks) as hooks_100,
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000 				as decimal(5,0))	AS alb_mt, 
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2))	AS alb_cpue, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS alb_npue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000 				as decimal(5,0))	AS bet_mt, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)   as decimal(6,2)) 	AS bet_cpue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS bet_npue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000				as decimal(5,0))	AS yft_mt, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) / max(tmp.hhooks)	as decimal(6,2))	AS yft_cpue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 000.0 end)  / max(tmp.hhooks)	as decimal(6,2))	AS yft_npue, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 000.0 when 'BE0' then 000.0 else sp_kg_est end)/1000 as decimal(5,0)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BE0' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(5,0)) 	AS tot_mt, 
		cast(Sum(sp_n_est)         															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					inner join (SELECT		vi.flag_id, 
											:group_by as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
								WHERE	year(logdate)	= coalesce(:year, year(logdate)) 
									and vi.flag_id		= coalesce(:flag_code,vi.flag_id)
									and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
								group by vi.flag_id, :group_by) tmp on tmp.flag_id = vi.flag_id and tmp.key1 = :group_by
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
  and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
group by vi.flag_id, 
		:group_by","YearMonth"
"199","8a363e0a-c1be-4e03-a596-23c2083cfba1"," LONGLINE Observer Effort Statistics","flag_code, year, obsv_prg, trip_id","A breakdown of EFFORT statistics for LONGLINE Observer trips by YEAR, FLAG, Observer Programme","Observer",1,"Observer"," 1",2926,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-03-15T09:46:56.937"," SELECT 	
		Case	when n =  1 then '     TRIPS					 ' 
				when n =  2 then ' 1.  Sea days          		 '
				when n =  3 then ' 2.  Sets 					 '
				when n =  4 then ' 3.  HBF : 01 - 05 hooks		 ' 
				when n =  5 then ' 4.  HBF : 06 - 10 hooks		 ' 
				when n =  6 then ' 5.  HBF : 11 - 15 hooks		 ' 
				when n =  7 then ' 6.  HBF : 16 - 20 hooks		 ' 
				when n =  8 then ' 7.  HBF : 21 - 25 hooks		 ' 
				when n =  9 then ' 8.  HBF : 26 - 30 hooks		 ' 
				when n = 10 then ' 9.  HBF : 31 - 35 hooks		 ' 
				when n = 11 then '10.  HBF : 36 - 40 hooks		 ' 
				when n = 12 then '11.  HBF : > 40 hooks			 ' 
				when n = 13 then '12.  Hooks set : < 500		 ' 
				when n = 14 then '13.  Hooks set :   501 - 1,000 ' 
				when n = 15 then '14.  Hooks set : 1,001 - 1,500 ' 
				when n = 16 then '15.  Hooks set : 1,501 - 2,000 ' 
				when n = 17 then '16.  Hooks set : 2,001 - 2,500 ' 
				when n = 18 then '17.  Hooks set : 2,501 - 3,000 ' 
				when n = 19 then '18.  Hooks set : 3,001 - 3,500 ' 
				when n = 20 then '19.  Hooks set : 3,501 - 4,000 ' 
				when n = 21 then '20.  Hooks set : > 4,000		 ' 
		end as cat_txt,
		COUNT(DISTINCT case when n = 1 then ot.obstrip_id else null end) as TRIPS,
		COUNT(DISTINCT case when n = 2 then cast(ot.obstrip_id as varchar(50)) + cast(set_date as varchar(10)) else null end) as SEA_DAYS,
		SUM(
					Case	when n =  3 then 00001 
							when n =  4 then case when hk_bt_flt > 00 and hk_bt_flt <= 05	then 00001 else 00000 end 
							when n =  5 then case when hk_bt_flt > 05 and hk_bt_flt <= 10	then 00001 else 00000 end 
							when n =  6 then case when hk_bt_flt > 10 and hk_bt_flt <= 15	then 00001 else 00000 end 
							when n =  7 then case when hk_bt_flt > 15 and hk_bt_flt <= 20	then 00001 else 00000 end 
							when n =  8 then case when hk_bt_flt > 20 and hk_bt_flt <= 25	then 00001 else 00000 end 
							when n =  9 then case when hk_bt_flt > 25 and hk_bt_flt <= 30	then 00001 else 00000 end 
							when n = 10 then case when hk_bt_flt > 30 and hk_bt_flt <= 35   then 00001 else 00000 end 
							when n = 11 then case when hk_bt_flt > 35 and hk_bt_flt <= 40	then 00001 else 00000 end 
							when n = 12 then case when hk_bt_flt > 40                       then 00001 else 00000 end 
							when n = 13 then case when						hook_set  <= 0500	then 00001 else 00000 end 
							when n = 14 then case when hook_set  > 0500 and hook_set  <= 1000	then 00001 else 00000 end 
							when n = 15 then case when hook_set  > 1000 and hook_set  <= 1500	then 00001 else 00000 end 
							when n = 16 then case when hook_set  > 1500 and hook_set  <= 2000	then 00001 else 00000 end 
							when n = 17 then case when hook_set  > 2000 and hook_set  <= 2500	then 00001 else 00000 end 
							when n = 18 then case when hook_set  > 2500 and hook_set  <= 3000	then 00001 else 00000 end 
							when n = 19 then case when hook_set  > 3000 and hook_set  <= 3500	then 00001 else 00000 end 
							when n = 20 then case when hook_set  > 3500 and hook_set  <= 4000	then 00001 else 00000 end 
							when n = 21 then case when hook_set  > 4000                      	then 00001 else 00000 end 
					else null
					end ) as SETS 
 FROM	ref.numbers nb, obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join ref.field_staff s on s.staff_id=ot.observer_id
WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
    AND COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno 
	AND n < 22
GROUP BY  
		Case	when n =  1 then '     TRIPS					 ' 
				when n =  2 then ' 1.  Sea days          		 '
				when n =  3 then ' 2.  Sets 					 '
				when n =  4 then ' 3.  HBF : 01 - 05 hooks		 ' 
				when n =  5 then ' 4.  HBF : 06 - 10 hooks		 ' 
				when n =  6 then ' 5.  HBF : 11 - 15 hooks		 ' 
				when n =  7 then ' 6.  HBF : 16 - 20 hooks		 ' 
				when n =  8 then ' 7.  HBF : 21 - 25 hooks		 ' 
				when n =  9 then ' 8.  HBF : 26 - 30 hooks		 ' 
				when n = 10 then ' 9.  HBF : 31 - 35 hooks		 ' 
				when n = 11 then '10.  HBF : 36 - 40 hooks		 ' 
				when n = 12 then '11.  HBF : > 40 hooks			 ' 
				when n = 13 then '12.  Hooks set : < 500		 ' 
				when n = 14 then '13.  Hooks set :   501 - 1,000 ' 
				when n = 15 then '14.  Hooks set : 1,001 - 1,500 ' 
				when n = 16 then '15.  Hooks set : 1,501 - 2,000 ' 
				when n = 17 then '16.  Hooks set : 2,001 - 2,500 ' 
				when n = 18 then '17.  Hooks set : 2,501 - 3,000 ' 
				when n = 19 then '18.  Hooks set : 3,001 - 3,500 ' 
				when n = 20 then '19.  Hooks set : 3,501 - 4,000 ' 
				when n = 21 then '20.  Hooks set : > 4,000		 ' 
		end",NA
"200","faadf6ba-d825-4554-acb7-a7c8010ebf30"," Species composition for a paired trip: E-Monitoring vs Observer vs Logbook","trip_id","Species composition for a paired trip: E-Monitoring vs Observer vs Logbook.
NOTE: You will need to enter the EM_STAFF_CODE together with the TRIPNO as the Observer Trip Id without any space character between them in the box provided below eg 'xxx17-01'","Logsheets,Observer",1,"Observer","5b",3209,"andrewh@spc.int","colleyf@spc.int","Logsheet, Observer, Longline, Emonitoring","2024-11-29T07:08:03.6","if OBJECT_ID('tempdb.dbo.#temp_EMOBLOG_1','U') IS NOT NULL
DROP TABLE #temp_EMOBLOG_1

SELECT sp.sp_name collate database_default AS sp_name, 
		lc.sp_code collate database_default AS sp_code, 
		sum(0001) AS em_reported, 
		SUM(0000) AS log_reported, 
		SUM(0000) AS obs_reported
INTO #temp_EMOBLOG_1
FROM em.trip et 
INNER JOIN ref.vessel_instances v ON et.vessel_id = v.vessel_id
	AND et.dep_date BETWEEN v.start_date AND v.calculated_end_date
INNER JOIN em.l_set ls ON et.obstrip_id = ls.obstrip_id
INNER JOIN em.l_setcatch lc ON ls.l_set_id = lc.l_set_id
INNER JOIN ref.species sp ON lc.sp_code = sp.sp_code
inner join obsv.trip ot on ot.vessel_id=v.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = v.vessel_id
	AND et.dep_date BETWEEN lt.depart_date AND lt.return_date
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY et.obstrip_key, sp.sp_name, lc.sp_code
UNION
SELECT sp.sp_name collate database_default AS sp_name, 
	sp.sp_code collate database_default AS sp_code, 
	SUM(0000) AS em_reported, 
	sum(coalesce(sp_n, 0000)) AS log_reported, 
	sum(0000) AS obs_reported
FROM tufman2_dorado.log.trips_ll l
INNER JOIN tufman2_dorado.ref.vessel_instances vi ON vi.vessel_id = l.vessel_id
	AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN em.trip et ON et.vessel_id = vi.vessel_id
	AND et.dep_date BETWEEN l.depart_date AND l.return_date
INNER JOIN tufman2_dorado.log.sets_ll s ON l.log_trip_id = s.log_trip_id
INNER JOIN tufman2_dorado.log.catch_ll c ON c.log_set_id = s.log_set_id
INNER JOIN tufman2_dorado.ref.species sp ON c.sp_code = sp.sp_code
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join ref.field_staff st on st.staff_id=et.observer_id
where COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name, sp.sp_code
UNION
SELECT sp.sp_name, 
	sp.sp_code collate database_default AS sp_code,
	SUM(0000) AS em_reported, 
	sum(0000) AS log_reported, 
	sum(0001) AS obs_reported
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date
		AND lt.return_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
INNER JOIN obsv.l_set ls ON ls.obstrip_id = ot.obstrip_id
INNER JOIN obsv.l_setcatch sc ON ls.l_set_id = sc.l_set_id
INNER JOIN ref.species sp ON sp.sp_code = sc.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name, sp.sp_code select 
	sp_name, 
	sp_code,
	sum(em_reported) as em_reported,
	sum(obs_reported) as obs_reported,
	sum(log_reported) as log_reported
from #temp_EMOBLOG_1
group by sp_name, sp_code",NA
"201","5aed128b-4099-4636-a80c-7c14bd22e0de","National FLEET Total catch by FAO Area","year",NA,"Logsheets",NA,NA,"7",3109,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Custom, RegionalReporting","2021-11-22T10:37:42.13"," select	c.sp_code,fao.area_id FAO_Area,SUM(COALESCE(c.sp_kg_est,0)) catch_kg
from	log.trips_ll t INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		INNER JOIN log.catch_ll c ON s.log_set_id=c.log_set_id
		INNER JOIN ref.fao_definitions fao WITH (INDEX(spix_fao_definitions_area_def)) ON area_def.STIntersects(tufman2.GetPointFromLatLon(s.latd, s.lond)) = 1
where	YEAR(logdate)=:year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by c.sp_code, fao.area_id",NA
"202","b59eb64c-436c-4821-b43d-084a5c568406"," ARTISANAL - Tuna and pelagic catch by fisher","year","Catch by fisher for major oceanic species, and total catch. NOTE: the hours fished is only accurate if the hours fished was recorded for each activity.","Artisanal",NA,NA,"3",3139,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, ByVessel, Tuna","2023-03-28T11:24:04.643"," SELECT :group_by, 
  	year(t.trip_date) as year,
   	sum([hours_fished_n]) as hours_fished_n,
	SUM(case when sp_code = 'SKJ' then sp_n else 0000 end) as skj_n, 
    SUM(case when sp_code = 'SKJ' then sp_kg else 0000 end) as skj_kg,
	SUM(case when sp_code = 'YFT' then sp_n else 0000 end) as yft_n, 
    SUM(case when sp_code = 'YFT' then sp_kg else 0000 end) as yft_kg,
	SUM(case when sp_code = 'BET' then sp_n else 0000 end) as bet_n, 
    SUM(case when sp_code = 'BET' then sp_kg else 0000 end) as bet_kg,
    SUM(case when sp_code = 'WAH' then sp_n else 0000 end) as wah_n, 
    SUM(case when sp_code = 'WAH' then sp_kg else 0000 end) as wah_kg,       
	SUM(case when sp_code not in ('SKJ','YFT','BET','WAH') then sp_n else 0000 end) as oth_n, 
	SUM(case when sp_code not in ('SKJ','YFT','BET','WAH') then sp_kg else 0000 end) as oth_kg       
    FROM art2.trips t inner join art2.vessels v on v.vessel_id = t.vessel_id     
    INNER JOIN  art2.landing_sites ls on t.landing_site_id = ls.landing_site_id         
    INNER JOIN  art2.effort e on t.art_trip_id = e.art_trip_id         
    LEFT OUTER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)       
    LEFT OUTER JOIN  art2.areas a on a.art_area_id = e.art_area_id         
    LEFT OUTER JOIN  art2.catch c on e.art_effort_id = c.art_effort_id 
	where	YEAR(trip_date)=COALESCE(:year,YEAR(trip_date))
    GROUP BY :group_by, YEAR(trip_date)","Vessel"
"203","1c732d13-2c69-4a9e-a6de-d13ba4d1924e"," PURSE SEINE - Observer CATCH MAP data","flag_code, year, obsv_prg","Produces an extract of Observer CATCH with GIS fields for mapping, selected by YEAR, Observer Programme and Flag","Observer",2,"Observer","5",2930,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-06-19T18:49:23.063"," SELECT 	:group_by,
		SUM( case when sp_code = 'SKJ' then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as skj_tot, 
		SUM( case when sp_code = 'YFT' then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as yft_tot, 
		SUM( case when sp_code = 'BET' then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as bet_tot, 
		SUM( case when sp_code = 'SKJ' and schas_id-20 in (1,2)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as skj_una, 
		SUM( case when sp_code = 'YFT' and schas_id-20 in (1,2)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as yft_una, 
		SUM( case when sp_code = 'BET' and schas_id-20 in (1,2)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as bet_una, 
		SUM( case when sp_code = 'SKJ' and schas_id-20 in (3,4,5,6)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as skj_ass, 
		SUM( case when sp_code = 'YFT' and schas_id-20 in (3,4,5,6)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as yft_ass, 
		SUM( case when sp_code = 'BET' and schas_id-20 in (3,4,5,6)	
					then case when obs_mt > coalesce(sp_c_est,obs_mt) then obs_mt else coalesce(sp_c_est,obs_mt) end else 00000.000 end) as bet_ass
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
    /* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */ 
	AND s_activ_id in (1) 
	AND lon is not null
	AND lat is not null 
GROUP BY  
		:group_by","Longitude(5x5)MAPINFOLatitude(5x5)MAPINFO"
"204","644a33b9-fda1-40d9-8cb3-ac36be5ced9f"," CMM 13-01 – PURSE SEINE Discard reporting by National Fleet","flag_code, year",NA,"Observer",NA,"Observer","EXTRA",2952,"andrewh@spc.int","andrewh@spc.int","Observer, Purseseine, CMM, Raised, RegionalReporting, Tuna","2021-12-15T14:25:04.603"," SELECT 	flag_id as flag,
		v.vesselname,  
		convert(varchar(10), act_date, 103) as date, 
		act_time as time, 
		case	when coalesce(schas_id,20) in (21,22)	then 'Unassociated' 
				when coalesce(schas_id,20) in (23)		then 'Log' 
				when coalesce(schas_id,20) in (24)		then 'Drifting FAD' 
				when coalesce(schas_id,20) in (25)		then 'Anchored FAD' 
				else 'Other' end as set_type,
		lat, 
		lon, 
		eez_code, 
		fate_desc as fate, 
		sp.sp_name as species,
		case when coalesce(obs_mt,0) > coalesce(sp_c_est,obs_mt) then coalesce(obs_mt,0) else coalesce(sp_c_est,obs_mt) end as sp_mt
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
				left outer join ref_static.fate_codes f on sc.fate_code = f.fate_code
WHERE YEAR(act_date) = coalesce(:year,year(act_date))
	AND s_activ_id = 1 
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_code in ('SKJ', 'YFT','BET')
    AND LEFT(sc.fate_code,1) = 'D'",NA
"205","70aae981-1812-460e-a1f4-a7bd01077d05"," ARTISANAL - NON FAD - Effort in hours per vessel type","",NA,"Artisanal",NA,NA,"8.2",3205,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData","2021-10-12T15:43:24.3"," SELECT	r.region_name,a.art_area_name, ref.GetTranslation('ArtisanalVesselPowerModes',v.boat_power_id,'en') boat_type, SUM(e.hours_fished_n) effort_in_hours
FROM	art2.trips t INNER JOIN art2.vessels v ON t.vessel_id = v.vessel_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.areas a ON a.art_area_id = e.art_area_id
		INNER JOIN art2.regions r ON a.region_id = r.region_id
GROUP BY r.region_name,a.art_area_name, v.boat_power_id",NA
"206","8985be0a-ab47-4dd5-b9ab-fc54513c4d2a"," LONGLINE - Detailed Shark (Marine Turtle) CATCH and EFFORT Statistics","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","1b",3064,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-01-20T15:18:59.54"," SELECT 	case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		sum(1) as No,
		SUM(1) / MAX(n) as sp_comp,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		SUM(0001.000) / MAX(hooks) * 1000 as CPUE,
		COUNT(distinct lc.l_set_id) / max(SETS) as freq,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Disc_perc,
		SUM(case when left(cond_code,1) = 'A' then 0001 else 0000 end)  / SUM(case when left(cond_code,1) IN ('A','D') then 0001 else 0000.00000000001 end) as alive_perc,
		SUM(case when left(cond_code,1) <> 'A' then 0001 else 0000 end) / SUM(case when left(cond_code,1) IN ('A','D') then 0001 else 0000.00000000001 end) as dead_perc,
		SUM(case when sex_code = 'M' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as male_perc,
		SUM(case when sex_code = 'F' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as female_perc
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join (SELECT SUM(1)*1.000 as n,
								count(distinct ls.l_set_id)*1.000 as sets
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
						WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
							) tmp on tmp.n > 0		
			inner join (SELECT SUM(coalesce(hook_set,0000.000)) as hooks
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
						WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
							) tmp2 on tmp2.hooks > 0		
WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
	/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
	AND sp.sp_cat_code = 'TTX'
GROUP BY  
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name",NA
"207","6a031e53-3265-420c-a03c-a74d00bfcb1b"," Longline - Damage report summary (Tuna, billfish, bycatch) and total sum","year","Shows an overview per trip of the discard (damage) catches.","Observer",NA,"Observer","30",3169,"andrewh@spc.int","colleyf@spc.int","Observer, Longline, Custom","2022-04-06T11:30:11.14"," SELECT   v.vesselname,
        SUM(case when sp.sp_cat_code = 'TUN' and fate_code in ('DSD') then 0001 else 0000 end) as tuna_DSD,
        SUM(case when sp.sp_cat_code = 'TUN' and fate_code in ('DWD') then 0001 else 0000 end) as tuna_DWD,
        SUM(case when sp.sp_cat_code = 'BIL' and fate_code in ('DSD') then 0001 else 0000 end) as bil_DSD,
        SUM(case when sp.sp_cat_code = 'BIL' and fate_code in ('DWD') then 0001 else 0000 end) as bil_DWD,
        SUM(case when sp.sp_code in ('DOL','WAH','LAG','TST') and fate_code in ('DSD') then 0001 else 0000 end) as bycatch_DSD,
        SUM(case when sp.sp_code in ('DOL','WAH','LAG','TST') and fate_code in ('DWD') then 0001 else 0000 end) as bycatch_DWD
 FROM    obsv.trip ot 
            inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
            inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
            inner join obsv.l_sethaullog hl on hl.l_set_id = ls.l_set_id
            inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
            inner join ref.species sp on lc.sp_code = sp.sp_code
WHERE
        YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
        and stend_id = 83
GROUP BY  
        v.vesselname",NA
"208","7017780d-3ae8-4286-a724-a82600fb4e85"," LONGLINE - Species Catch composition chart (Logsheet) - DRAFT","year","Species compostion for longline logsheet entered in Tufman2","Logsheets",1,NA,"4a",3227,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Ereporting, AllSpecies","2022-01-12T15:56:50.753","SELECT  sp.sp_name collate database_default as sp_name, 
		sp.sp_code collate database_default as sp_code,
		SUM(0000) as em_reported,
    sum(case when t.system_source='tufman2' then coalesce(sp_n,0000) else 0 end) as T2_reported
INTO #t1
FROM   tufman2.log.trips_ll t 
		INNER JOIN tufman2.log.sets_ll s    ON t.log_trip_id = s.log_trip_id
		INNER JOIN tufman2.log.catch_ll c   ON c.log_set_id = s.log_set_id
		INNER JOIN tufman2.ref.species sp on c.sp_code = sp.sp_code 
WHERE year(first_logdate)=COALESCE(:year, year(first_logdate))
group by sp.sp_name,sp.sp_code

 select 
	sp_name, 
	sp_code,
	sum(T2_reported) as T2_nb
from #t1
group by sp_name, sp_code",NA
"209","3c9f25bc-6460-4c1c-a061-a94a00908a34"," All catches with Comments for EM trips","year",NA,"",NA,"Observer","9b",3276,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T15:59:25.34"," select 
	st.staff_code as EM_ANALYST,
	et.tripno as TRIP_NO,
	vi.vesselname as VESSEL_NAME,
	CONVERT(VARCHAR(10),et.dep_date,103) as DEP_DATE,
	convert(varchar(10),ls.set_date,103) as SET_DATE,
	convert(varchar(10),et.ret_date,103) as RET_DATE,
	case when ls.hook_observed is null then ls.bask_observed*ls.hk_bt_flt
										else ls.hook_observed end as HOOK_OBSERVED,
	convert(char(10),sc.catch_date,103) as CATCH_DATE,
	sc.catch_time as CATCH_TIME,
	sc.lat as LAT,
	sc.lon as LON,
	sc.sp_code as SP_CODE,
	sc.len as LENGTH,
	sc.len_code as LENGTH_CODE,
	sc.fate_code as FATE_CODE,
	sc.cond_code as COND_CODE,
	sc.comments as COMMENTS
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join em.l_set ls on ls.obstrip_id=et.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref_static.fate_codes rf on rf.fate_code=sc.fate_code
inner join ref.field_staff st on st.staff_id=et.observer_id
where COALESCE(:year,year(et.dep_date)) = year(et.dep_date)",NA
"210","4047aff1-e28c-4faa-a781-aad300b9a910"," CMM 19-03 – North Pacific Albacore catches by National Fleet (by YEAR)","year","All CCMs shall report annually to the WCPFC Commission all catches of albacore north of the equator and all fishing effort north of the equator in fisheries directed at albacore (which is interpreted to be ALBACORE TARGET and so north of 20°N). The reports for both catch and fishing effort shall be made by gear type. Catches shall be reported in terms of weight. Fishing effort shall be reported in terms of the most relevant measures for a given gear type, including at a minimum for all gear types, the number of vessel-days fished.*
[* footnote 1: The first such report shall be due on April 30th, 2006 and shall cover calendar year 2004. Small Island Developing States will make their best efforts to comply with this first reporting deadline.]","Logsheets",NA,NA,"20b",3328,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, Tuna","2021-11-09T13:50:38.7"," SELECT  
		'L' as gear,
		vi.flag_id as flag, 
		year(logdate) as yr,
		count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as NumVessels,
		count(distinct case when RIGHT(lat,1) = 'N' and  l_activity_id in (1) then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as DaysFishing,
		SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = @@entity
	and right(lat,1) = 'N'
	and left(lat,2) >= '20'
group by vi.flag_id, year(logdate)",NA
"211","6a2927dc-9176-4a85-9f9f-33b8860e1db3"," Catch by YEAR, FLAG, EEZ, SPECIES and FATE","eez_code, flag_code, year",NA,"Observer",NA,"Observer","11",2947,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, AllSpecies","2025-10-15T13:43:33.01"," SELECT DISTINCT 
			:group_by,
            flag_id as flag,
            eez_code as eez, 
            case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
            sp.sp_name as species,
            lc.fate_code as fate_code, 
            f.fate_desc as fate_desc,
            sum(1) as No,
            SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT
 FROM obsv.trip ot 
                  inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                  inner join  obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
                  inner join  obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
                  inner join  obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
                  inner join ref.species sp on lc.sp_code = sp.sp_code
                  inner join ref_static.fate_codes f on lc.fate_code = f.fate_code
WHERE YEAR(set_date)          = coalesce(:year, YEAR(set_date))
      AND flag_id    = coalesce(:flag_code,flag_id)
      AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
GROUP BY  
            :group_by,
            flag_id,
            eez_code, 
            sp.sp_cat_code,
            sp.sp_name,
            lc.FATE_CODE, 
            f.fate_desc
having count(*) > 1","Year"
"212","87c7daa5-17f4-4ded-8450-4c116ef64e16"," LONGLINE -- Shark and Whale Damage Summary","flag_code, year",NA,"Observer",NA,"Observer","14",3104,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-11T16:37:05.207"," SELECT 	:group_by, 
		COUNT(distinct ls.l_set_id) as sets,
		SUM(case when right(fate_code,2) = 'SD' then 0001.000 else 0000.000 end) as SD_NO,
		SUM(case when right(fate_code,2) = 'SD' then 0001.000 else 0000.000 end) / COUNT(distinct ls.l_set_id)as SD_NPUE,
		SUM(case when right(fate_code,2) = 'SD' then 0001.000 else 0000.000 end) / (COUNT(distinct case when right(fate_code,2) = 'SD' then ls.l_set_id else NULL end)+.00001)as SD_NO_P_SET,
		SUM(case when right(fate_code,2) = 'WD' then 0001.000 else 0000.000 end) as WD_NO,
		SUM(case when right(fate_code,2) = 'WD' then 0001.000 else 0000.000 end) / COUNT(distinct ls.l_set_id)as WD_NPUE,
		SUM(case when right(fate_code,2) = 'WD' then 0001.000 else 0000.000 end) / (COUNT(distinct case when right(fate_code,2) = 'WD' then ls.l_set_id else NULL end)+.00001)as WD_NO_P_SET
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)
GROUP BY  :group_by","Year"
"213","ed4dc48d-cbea-4316-ac5d-a93600bc1856"," Phils Data Dump - Vessel Activity Logs","","A data dump of all activity Logs (created by Lucy)","Artisanal",NA,NA,"996",3271,"andrewh@spc.int","andrewh@spc.int","Artisanal, Custom","2023-03-28T12:04:26.21"," select YEAR (activity_date) as activity_yr, MONTH (activity_date) as activity_mnth, DAY (activity_date) as activity_dy, motor_vessels_n, paddle_vessels_n, sail_vessels_n,
landing_site_name, start_time, end_time, entered_latitude, entered_longitude, t.entered_by, t.entered_date, current_comments
from art2.fishing_activity_log t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id",NA
"214","905ca098-6b92-4c0d-8d75-9920a98e40e8"," PURSE SEINE - Compliance Summary (GEN-3)","year","List of Observer Trip Compliance Reports","Observer",NA,"Observer","4",2935,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Compliance","2022-07-19T13:30:38.997"," SELECT a.obsprg_code as obsprg_code,
       a.trip_year as trip_year, 
       a.gear_code as gear_code,
       SUM(a.RS_A) AS RS_A,
       SUM(a.RS_B) AS RS_B,
       SUM(a.RS_C) AS RS_C,
       SUM(a.RS_D) AS RS_D,
       SUM(a.NR_A) AS NR_A,
       SUM(a.NR_B) AS NR_B,
       SUM(a.NR_C) AS NR_C,
       SUM(a.NR_D) AS NR_D,
       SUM(a.NR_E) AS NR_E,
       SUM(a.NR_F) AS NR_F,
       SUM(a.NR_G) AS NR_G,
       SUM(a.WC_A) AS WC_A,
       SUM(a.WC_B) AS WC_B,
       SUM(a.WC_C) AS WC_C,
       SUM(a.LP_A) AS LP_A,
       SUM(a.LP_B) AS LP_B,
       SUM(a.LC_A) AS LC_A,
       SUM(a.LC_B) AS LC_B,
       SUM(a.LC_C) AS LC_C,
       SUM(a.LC_D) AS LC_D,
       SUM(a.LC_E) AS LC_E,
       SUM(a.LC_F) AS LC_F,
       SUM(a.SI_A) AS SI_A,
       SUM(a.SI_B) AS SI_B,
       SUM(a.PN_A) AS PN_A,
       SUM(a.PN_B) AS PN_B,
       SUM(a.PN_C) AS PN_C,
       SUM(a.PN_D) AS PN_D,
       SUM(a.PN_E) AS PN_E,
       SUM(a.SS_A) AS SS_A,
       SUM(a.SS_B) AS SS_B
FROM (
SELECT t.obsprg_code as obsprg_code
,DATEPART(yyyy,t.dep_date) as trip_year
,t.gear_code as gear_code
, CASE WHEN g.question_code = 'RS-A' THEN COUNT(g.question_code) ELSE 0 END AS RS_A
, CASE WHEN g.question_code = 'RS-B' THEN COUNT(g.question_code) ELSE 0 END AS RS_B
, CASE WHEN g.question_code = 'RS-C' THEN COUNT(g.question_code) ELSE 0 END AS RS_C
, CASE WHEN g.question_code = 'RS-D' THEN COUNT(g.question_code) ELSE 0 END AS RS_D
, CASE WHEN g.question_code = 'NR-A' THEN COUNT(g.question_code) ELSE 0 END AS NR_A
, CASE WHEN g.question_code = 'NR-B' THEN COUNT(g.question_code) ELSE 0 END AS NR_B
, CASE WHEN g.question_code = 'NR-C' THEN COUNT(g.question_code) ELSE 0 END AS NR_C
, CASE WHEN g.question_code = 'NR-D' THEN COUNT(g.question_code) ELSE 0 END AS NR_D
, CASE WHEN g.question_code = 'NR-E' THEN COUNT(g.question_code) ELSE 0 END AS NR_E
, CASE WHEN g.question_code = 'NR-F' THEN COUNT(g.question_code) ELSE 0 END AS NR_F
, CASE WHEN g.question_code = 'NR-G' THEN COUNT(g.question_code) ELSE 0 END AS NR_G
, CASE WHEN g.question_code = 'WC-A' THEN COUNT(g.question_code) ELSE 0 END AS WC_A
, CASE WHEN g.question_code = 'WC-B' THEN COUNT(g.question_code) ELSE 0 END AS WC_B
, CASE WHEN g.question_code = 'WC-C' THEN COUNT(g.question_code) ELSE 0 END AS WC_C
, CASE WHEN g.question_code = 'LP-A' THEN COUNT(g.question_code) ELSE 0 END AS LP_A
, CASE WHEN g.question_code = 'LP-B' THEN COUNT(g.question_code) ELSE 0 END AS LP_B
, CASE WHEN g.question_code = 'LC-A' THEN COUNT(g.question_code) ELSE 0 END AS LC_A
, CASE WHEN g.question_code = 'LC-B' THEN COUNT(g.question_code) ELSE 0 END AS LC_B
, CASE WHEN g.question_code = 'LC-C' THEN COUNT(g.question_code) ELSE 0 END AS LC_C
, CASE WHEN g.question_code = 'LC-D' THEN COUNT(g.question_code) ELSE 0 END AS LC_D
, CASE WHEN g.question_code = 'LC-E' THEN COUNT(g.question_code) ELSE 0 END AS LC_E
, CASE WHEN g.question_code = 'LC-F' THEN COUNT(g.question_code) ELSE 0 END AS LC_F
, CASE WHEN g.question_code = 'SI-A' THEN COUNT(g.question_code) ELSE 0 END AS SI_A
, CASE WHEN g.question_code = 'SI-B' THEN COUNT(g.question_code) ELSE 0 END AS SI_B
, CASE WHEN g.question_code = 'PN-A' THEN COUNT(g.question_code) ELSE 0 END AS PN_A
, CASE WHEN g.question_code = 'PN-B' THEN COUNT(g.question_code) ELSE 0 END AS PN_B
, CASE WHEN g.question_code = 'PN-C' THEN COUNT(g.question_code) ELSE 0 END AS PN_C
, CASE WHEN g.question_code = 'PN-D' THEN COUNT(g.question_code) ELSE 0 END AS PN_D
, CASE WHEN g.question_code = 'PN-E' THEN COUNT(g.question_code) ELSE 0 END AS PN_E
, CASE WHEN g.question_code = 'SS-A' THEN COUNT(g.question_code) ELSE 0 END AS SS_A
, CASE WHEN g.question_code = 'SS-B' THEN COUNT(g.question_code) ELSE 0 END AS SS_B
FROM [obsv].[gen3vr09] g INNER JOIN obsv.trip t
ON g.obstrip_id = t.obstrip_id
WHERE t.gear_code = 'S'
AND g.answer = 1
AND YEAR(t.dep_date) = coalesce(:year, YEAR(t.dep_date))
group by g.question_code,t.dep_date,t.obsprg_code, t.gear_code) a
group by a.obsprg_code,a.trip_year, a.gear_code",NA
"215","1ca37e26-7929-4980-adc5-a88d00c2cb95"," LONGLINE - Logsheet / Unloadings reconciliation - Details by TRIP","flag_code, year",NA,"Logsheets",NA,NA,"5.2.2",3235,"andrewh@spc.int","brunod@spc.int","Logsheet, Unloading, Longline, CoverageMissingData, Tuna","2023-03-07T11:56:06.453","SELECT      
                        t.log_trip_id,
                        unload_id,
			vi.vesselname, 
			vi.flag_id, 
			CONVERT(nvarchar,t.depart_date,111) depart_date,dp.port_name dp,
			CONVERT(nvarchar,t.return_date,111) return_date,rp.port_name rp,
			max(case when z.sp_code = 'ALB' then z.sp_n else 00000 end) 
				+ max(case when z.sp_code = 'BET' then z.sp_n else 00000 end)
				+ max(case when z.sp_code = 'YFT' then z.sp_n else 00000 end) as t_log_n,
			max(case when y.sp_code = 'ALB' then coalesce(y.port_n,0000) else 00000 end)
				+ max(case when y.sp_code = 'BET' then coalesce(y.port_n,0000) else 00000 end)
				+ max(case when y.sp_code = 'YFT' then coalesce(y.port_n,0000) else 00000 end) as t_port_n,
			max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end)
				+ max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) 
				+ max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) as t_unl_n,
			max(case when z.sp_code = 'ALB' then z.sp_n else 00000 end) as a_log_n,
			max(case when y.sp_code = 'ALB' then coalesce(y.port_n,0000) else 00000 end) as a_port_n,
			max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end) as a_unl_n,
			max(case when z.sp_code = 'BET' then z.sp_n else 00000 end) as b_log_n,
			max(case when y.sp_code = 'BET' then coalesce(y.port_n,0000) else 00000 end) as b_port_n,
			max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) as b_unl_n,
			max(case when z.sp_code = 'YFT' then z.sp_n else 00000 end) as y_log_n,
			max(case when y.sp_code = 'YFT' then coalesce(y.port_n,0000) else 00000 end) as y_port_n,
			max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) as y_unl_n
into #Temp1
FROM    log.trips_ll t	
		LEFT OUTER JOIN ( select s.log_trip_id, c.sp_code,
							SUM(c.sp_n) as sp_n
					 from log.sets_ll s 
							INNER JOIN log.catch_ll c on  s.log_set_id = c.log_set_id 
					 where c.sp_code in ('ALB','BET','YFT')
					 group by s.log_trip_id, c.sp_code) z on t.log_trip_id = z.log_trip_id 		
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO' AND l.dto_type_right='UnloadingDTO'
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO' AND l2.dto_type_right='PortSamplingDTO'
        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
        INNER JOIN ref.ports dp ON t.depart_port_id = dp.port_id
        INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
		LEFT OUTER JOIN (	select  u2_c.unload_id, u2_c.sp_code,
									SUM(u2_c.sp_n) as unl_n
							from unload2.unloading_catch u2_c
							where u2_c.sp_code in ('ALB','BET','YFT')
							group by u2_c.unload_id, u2_c.sp_code) x on l.dto_guid_right = x.unload_id
		LEFT OUTER JOIN (	select p_c.sample_id,p_c.sp_code, 
									SUM(p_c.samples_n) as port_n
							from port.sample_tot p_c 
							where p_c.sp_code in ('ALB','BET','YFT')
							group by p_c.sample_id,p_c.sp_code) y on l2.dto_guid_right = y.sample_id
WHERE     COALESCE(:year,YEAR(t.depart_date)) = YEAR(t.depart_date)
	AND   COALESCE(:flag_code,vi.flag_id) = vi.flag_id
group by 
	vi.vesselname, 
	vi.flag_id,
        t.log_trip_id,
        unload_id, 
	CONVERT(nvarchar,t.depart_date,111),dp.port_name,
	CONVERT(nvarchar,t.return_date,111),rp.port_name
having max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end)
				+ max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) 
				+ max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) > 0 
SELECT
		sx.vesselname vessel_name, 
		sx.flag_id flag_code, 
		sx.depart_date,
		sx.dp,
		sx.return_date,
		sx.rp, 
		SUM(sx.t_log_n) as t_log_n,
		SUM(sx.t_unl_n) as t_unl_n,
		SUM(sx.a_log_n) as a_log_n,
		SUM(sx.a_unl_n) as a_unl_n,
		SUM(sx.b_log_n) as b_log_n,
		SUM(sx.b_unl_n) as b_unl_n,
		SUM(sx.y_log_n) as y_log_n,
		SUM(sx.y_unl_n) as y_unl_n,
        cast((SUM(sx.t_unl_n) - SUM(sx.t_log_n)) / (case when SUM(sx.t_log_n) = 0 then 10000.0 else SUM(sx.t_log_n) end) * 100.0 as decimal(7,1)) as t_diff_percent,
        cast((SUM(sx.a_unl_n) - SUM(sx.a_log_n)) / (case when SUM(sx.a_log_n) = 0 then 10000.0 else SUM(sx.a_log_n) end) * 100.0 as decimal(7,1)) as a_diff_percent,
        cast((SUM(sx.b_unl_n) - SUM(sx.b_log_n)) / (case when SUM(sx.b_log_n) = 0 then 10000.0 else SUM(sx.b_log_n) end) * 100.0 as decimal(7,1)) as b_diff_percent,
        cast((SUM(sx.y_unl_n) - SUM(sx.y_log_n)) / (case when SUM(sx.y_log_n) = 0 then 10000.0 else SUM(sx.y_log_n) end) * 100.0 as decimal(7,1)) as y_diff_percent,
        log_trip_id LonglineLogsheetDTO,
        unload_id UnloadingDTO
FROM #temp1 sx
group by 
		sx.vesselname, 
		sx.flag_id, 
		sx.depart_date,
		sx.dp,
		sx.return_date,
		sx.rp,
                log_trip_id,
                unload_id",NA
"216","04664376-fe5c-496d-9086-a9df00e6d27b"," Coverage of eReporting - FOR TRIPS LANDING IN YOUR PORTS","year","Coverage of eReported data - what percentage of trips are eReported?
FOR TRIPS FROM ALL FLEETS LANDING IN YOUR COUNTRY's PORTS","Logsheets",NA,NA,"1",3293,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Longline, PoleAndLine, Purseseine, Ereporting","2023-03-09T10:02:30.517","with #base as (Select 'PS' as gear,	
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.trips_ps t inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id and t.depart_date between vi.start_date and vi.calculated_end_date
	inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
AND (@@entity = 'HIVE' OR p.country_code = @@entity)
group by year(depart_date),
	system_source
UNION
Select 'LL' as gear,	
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.trips_ll t inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id and t.depart_date between vi.start_date and vi.calculated_end_date
	inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
AND (@@entity = 'HIVE' OR p.country_code = @@entity)
group by year(depart_date),
	system_source
UNION
Select 'PL' as gear,	
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.trips_pl t inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id and t.depart_date between vi.start_date and vi.calculated_end_date
	inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
AND (@@entity = 'HIVE' OR p.country_code = @@entity)
group by year(depart_date),
	system_source) 
select gear,
		yy,
		sum(num) as total_trips,
		sum(case when system_source in ('eTunalog') then num else 0 end) as eTunalog_number,
		sum(case when system_source in ('iFIMS') then num else 0 end) as iFIMS_number,
		sum(case when system_source in ('OnBoard') then num else 0 end) as OnBoard_number,
		sum(case when system_source in ('JsonStandard') then num else 0 end) as JsonStandard_number,
		sum(case when system_source in ('eTunalog','iFIMS','OnBoard','JsonStandard') then num else 0 end) as Tot_EReported_number,
		FORMAT(sum(case when system_source in ('iFIMS') then num else 0.00 end) / sum(num) * 100 ,'N2') as iFIMS_perc,
		FORMAT(sum(case when system_source in ('OnBoard') then num else 0.00 end) / sum(num) * 100 ,'N2') as OnBoard_perc,
		FORMAT(sum(case when system_source in ('JsonStandard') then num else 0.00 end) / sum(num) * 100 ,'N2') as JsonStandard_perc,
		FORMAT(sum(case when system_source in ('eTunalog','iFIMS','OnBoard','JsonStandard') then num else 0.00 end) / sum(num) *100 ,'N2') as Tot_EReported_perc
from #base 
group by gear, yy",NA
"217","4a618ab0-53ac-4b52-8378-a75400a0934f"," LONGLINE -- WCPFC key species catch -- detailed statistics","flag_code, year",NA,"Observer",NA,"Observer","32",3173,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-04-06T11:51:29.68","DECLARE @sp_code nvarchar(90)
DECLARE @sp_name char(3)
DECLARE @sp_list nvarchar(90)
DECLARE @cnt_0 int
DECLARE @cnt_0_str char(4)

set @sp_list = 'SKJYFTBETALBMLSBUMBLMSWORHNBSHFALOCSMAKTHRHAMPOR'
set @cnt_0 = 1

create table #temp_d2 (
	sp_name char(3),
	trips	int,
	No_Ret_cnt	int,
	No_Disc_cnt int,
	No_Ret	int,
	Kgs_Ret	decimal(10,3),
	No_Disc int,
	kgs_Disc decimal(10,3),
	MEDIAN_No_Ret	int,
	MEDIAN_Kgs_Ret decimal(10,3),
	MEDIAN_No_Disc	int,
	MEDIAN_kgs_Disc decimal(10,3),
	AVG_No_Ret	decimal(10,3),
	AVG_Kgs_Ret decimal(10,3),
	AVG_No_Disc	decimal(10,3),
	AVG_kgs_Disc decimal(10,3),
		MIN_No_Ret	decimal(19,6),
	MIN_Kgs_Ret decimal(19,6),
	MIN_No_Disc	decimal(19,6),
	MIN_kgs_Disc decimal(19,6),
	MAX_No_Ret	decimal(19,6),
	MAX_Kgs_Ret decimal(19,6),
	MAX_No_Disc	decimal(19,6),
	MAX_kgs_Disc decimal(19,6))



while @cnt_0 < 17
begin

	set @sp_name = substring(@sp_list,(@cnt_0-1)*3+1,3)
	
	if	@sp_name = 'THR' 
		set @sp_code = 'BTH,PTH,THR,ALV'
	if @sp_name = 'MAK' 
		set @sp_code = 'MAK,LMA,SMA'
	if @sp_name = 'HAM' 
		set	@sp_code = 'SPK,SPL,SPN,SPQ,SPZ'
	if @sp_name <> 'HAM' and @sp_name <> 'MAK' and @sp_name <> 'THR' 
		set @sp_code = @sp_name



If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

If(OBJECT_ID('tempdb..#temp_d3') Is Not Null)
Begin
    Drop Table #temp_d3
End

SELECT     
		ot.obstrip_id,
        sum(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then 1.0 else 0.0 end) as No_ret, 
		sum(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then splw.lenwt_a * power(case when len is null or len < 20 then 
						case	when sp.sp_cat_code = 'SHK' then 150 
								when sp.sp_cat_code = 'BIL' then 150
								else	100 end
				else len end,splw.lenwt_b) else 0.0 end) as kgs_ret,
        sum(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' then 1.0 else 0.0 end) as No_disc, 
        sum(case when charindex(lc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' then splw.lenwt_a * power(case when len is null or len < 20 then 
					case when sp.sp_cat_code = 'SHK' then 150 
						 when sp.sp_cat_code = 'BIL' then 150
						 else	100 end
			 else len end,splw.lenwt_b) else 0.0 end) as kgs_disc
INTO #temp_d1
FROM    obsv.trip ot 
            inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
            inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
            inner join    obsv.l_sethaullog lsh on ls.l_set_id = lsh.l_set_id and lsh.stend_id = 83
            inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
            inner join ref.species sp on lc.sp_code = sp.sp_code
            inner join ref.species_lenwt splw on lc.sp_code = splw.sp_id
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
GROUP BY  
        ot.obstrip_id

insert into #temp_d2
select 
	max(@sp_name) as sp_name,
	count(*) as trips,
	sum(case when No_Ret>0 then 1 else 0 end)  as No_Ret_cnt,
	sum(case when No_Disc>0 then 1 else 0 end) as No_Disc_cnt,
	sum(No_Ret)  as No_Ret,
	sum(kgs_Ret) as Kgs_Ret,
	sum(No_Disc) as No_Disc,
	sum(kgs_Disc) as kgs_Disc,
	MAX(100000.000) as MEDIAN_No_Ret,
	MAX(100000.000) as MEDIAN_Kgs_Ret,
	MAX(100000.000) as MEDIAN_No_Disc,
	MAX(100000.000) as MEDIAN_kgs_Disc,
	sum(No_Ret)  / COUNT(*) as AVG_No_Ret,
	sum(kgs_Ret) / COUNT(*) as AVG_Kgs_Ret,
	sum(No_Disc) / COUNT(*) as AVG_No_Disc,
	sum(kgs_Disc) / COUNT(*) as AVG_kgs_Disc,
	min(No_Ret)  as MIN_No_Ret,
	min(kgs_Ret) as MIN_Kgs_Ret,
	min(No_Disc) as MIN_No_Disc,
	min(kgs_Disc) as MIN_kgs_Disc,
	MAX(No_Ret)  as MAX_No_Ret,
	MAX(kgs_Ret) as MAX_Kgs_Ret,
	MAX(No_Disc) as MAX_No_Disc,
	MAX(kgs_Disc) as MAX_kgs_Disc
from #temp_d1 

DECLARE @cnt INT = 1;
DECLARE @Fld_Names CHAR(32) = 'No_Ret  kgs_Ret No_Disc kgs_Disc';
DECLARE @Fld_Name CHAR(8);
DECLARE @Med_Fld_Name CHAR(15);

WHILE @cnt < 5  
BEGIN

	SET @Fld_Name = SUBSTRING(@Fld_Names,(@cnt-1)*8+1,8)
	SET @Med_Fld_Name = 'MEDIAN_'+SUBSTRING(@Fld_Names,(@cnt-1)*8+1,8)
	
	create table #temp_d3 (xfld  decimal(16,7))
	
	EXEC(
	'INSERT INTO #temp_d3 SELECT
	( (SELECT MAX(' + @Fld_Name + ') FROM
		(SELECT TOP 50 PERCENT ' + @Fld_Name + ' FROM #temp_d1 ORDER BY ' + @Fld_Name + ') AS BottomHalf) 
		+
		(SELECT MIN(' + @Fld_Name + ') FROM
		(SELECT TOP 50 PERCENT ' + @Fld_Name + ' FROM #temp_d1 ORDER BY ' + @Fld_Name + ' DESC) AS TopHalf)
	) / 2 AS xfld')

	EXEC(
	
	'UPDATE #temp_d2 SET ' + @Med_Fld_Name + ' = cast(#temp_d3.xfld as float) from #temp_d3 where #temp_d2.sp_name = ''' + @sp_name + '''' )
	
	If(OBJECT_ID('tempdb..#temp_d3') Is Not Null)
	Begin
		Drop Table #temp_d3
	End

	set @cnt = @cnt + 1
END



set @cnt_0 = @cnt_0 + 1

end

select 
	sp_name,
	trips,
	No_Ret_cnt,
	No_Disc_cnt,
	No_Ret,
	Kgs_Ret,
	No_Disc,
	kgs_Disc,
	MEDIAN_No_Ret,
	MEDIAN_Kgs_Ret,
	MEDIAN_No_Disc,
	MEDIAN_kgs_Disc,
	AVG_No_Ret,
	AVG_Kgs_Ret,
	AVG_No_Disc,
	AVG_kgs_Disc,
	MIN_No_Ret,
	MIN_Kgs_Ret,
	MIN_No_Disc,
	MIN_kgs_Disc,
	MAX_No_Ret,
	MAX_Kgs_Ret,
	MAX_No_Disc,
	MAX_kgs_Disc	
from #temp_d2",NA
"218","60f50dec-4618-4005-b056-a7ae00864c64"," North Pacific Annual Catch Estimates","flag_code, year, gear_code","Annual Catch Estimates in the north Pacific","",NA,"Live","3",3197,"andrewh@spc.int","benoitp@spc.int","Logsheet, Unraised","2022-04-07T12:06:15.313"," SELECT
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY,
	SUM(CASE t2.SP_CODE when 'ALB' THEN sp_mt END) as ALB,
	SUM(CASE t2.SP_CODE when 'PBF' THEN sp_mt END) as PBF,
	SUM(CASE t2.SP_CODE when 'SWO' THEN sp_mt END) as SWO,
	SUM(CASE t2.SP_CODE when 'MLS' THEN sp_mt END) as MLS
FROM WCPFC_YEARBOOK.dbo.A_ACE t1
INNER JOIN WCPFC_YEARBOOK.dbo.A_ACE_CATCH t2 ON t1.ACE_ID = t2.ACE_ID
LEFT JOIN WCPFC_YEARBOOK.dbo.species S ON t2.SP_CODE = S.sp_code
WHERE OCEAN_CODE = 'NP'
	AND FLAG_CODE = coalesce(:flag_code, FLAG_CODE)
	AND YY = coalesce(:year,YY)
	AND GEAR_CODE = coalesce(:gear_code,GEAR_CODE)
GROUP BY
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY",NA
"219","6de461b6-c05a-42b3-be96-ab0300a90936"," MSC - Total Catch by Year","flag_code, min_year, max_year","Report for MSC process - Number of catch by Year - Weights are estimated","Observer",NA,"Observer","87",3339,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2024-06-28T11:19:33.107"," select year(t.dep_date) as yr,flag_id,sc.sp_code,sp.sp_cat_code,sp.sp_name,
SUM(case when LEFT(sc.fate_code,1)='R' then 1 else 0 end) as Retained_Number,
SUM(case when LEFT(sc.fate_code,1)='D' then 1 else 0 end) as Discarded_Number,
SUM(case when LEFT(sc.fate_code,1)='R' then wt_est else 0.0 end) as Retained_Weight,
SUM(case when LEFT(sc.fate_code,1)='D' then wt_est else 0.0 end) as Discarded_Weight,
case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end as Discarded_fate_code
from obsv.trip t 
join obsv.l_set s on s.obstrip_id = t.obstrip_id
join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sp.sp_code = sc.sp_code
left join ref_static.fate_codes f on f.fate_code = sc.fate_code
where YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
and flag_id=coalesce(:flag_code,flag_id)
group by year(t.dep_date),flag_id,sc.sp_code,sp.sp_cat_code,sp.sp_name,case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end",NA
"220","f7435710-c529-4087-8998-ab28010e17b9"," Longline Unloading by Vessel","flag_code, year","Longline Unloading reported on by vessel","Port",NA,NA,"33",3361,"andrewh@spc.int","shaazreenb@spc.int","Unloading, Longline, ByVessel, Tuna","2025-10-13T08:41:31.113","SELECT
	YEAR(up.unload_startdate) Year, 
	MONTH(up.unload_startdate) Month, 
	COUNT(DISTINCT up.vessel_id) vessels into #vessels
FROM unload2.unloadings up JOIN ref.vessels v ON v.vessel_id = up.vessel_id
JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
WHERE
	COALESCE(:year, YEAR(up.unload_startdate)) = YEAR(up.unload_startdate)
	AND	COALESCE(:flag_code, vi.flag_id) = vi.flag_id
AND v.gear = 'L'
GROUP BY YEAR(up.unload_startdate), MONTH(up.unload_startdate)
ORDER BY YEAR(up.unload_startdate), MONTH(up.unload_startdate) 

SELECT 
	t1.Year,
	t1.Month,
	t1.vessels,
	:group_by,
	Sum(case sp_code when 'SKJ' then sp_kg else 000.0 end) as SKJ,
	Sum(case sp_code when 'YFT' then sp_kg else 000.0 end) as YFT,
	Sum(case sp_code when 'BET' then sp_kg else 000.0 end) as BET,
	Sum(case sp_code when 'ALB' then sp_kg else 000.0 end) as ALB,
	Sum(case when sp_code not in ('SKJ','YFT','BET','ALB') then sp_kg else 000.0 end) as Other
FROM (
    SELECT 
		src.*, 
		#vessels.vessels
    FROM (
        SELECT COALESCE(p.port_name, 'UNKNOWN') port_name, 
		dest_code,
		vi.vesselname vesselname,
		vi.flag_id,
		YEAR(up.unload_startdate) Year,
		MONTH(up.unload_startdate) Month,
		sp_code,
		SUM(sp_kg) / 1000 sp_kg
        FROM
			unload2.unloadings up LEFT OUTER JOIN ref.ports p ON p.port_id = up.port_id 
            JOIN ref.vessels v ON v.vessel_id = up.vessel_id
            JOIN ref.vessel_instances vi ON v.vessel_id = vi.vessel_id AND up.unload_startdate BETWEEN vi.start_date AND vi.calculated_end_date
            JOIN unload2.unloading_catch upc ON up.unload_id = upc.unload_id
		WHERE COALESCE(:year,YEAR(up.unload_startdate)) = YEAR(up.unload_startdate)
		AND COALESCE(:flag_code, vi.flag_id) = vi.flag_id
AND v.gear = 'L'
        GROUP BY port_name, dest_code, vesselname, flag_id, YEAR(up.unload_startdate), MONTH(up.unload_startdate), sp_code
    	) src
	JOIN #vessels ON src.Year = #vessels.Year AND src.Month = #vessels.Month
	) t1
GROUP BY Year, Month, :group_by, vessels","VesselDestination"
"221","3848c235-4d28-46cc-a3f2-a8f800ef58fc"," Tails in app report - Average weight","staff_code","Average weight","Artisanal",1,NA,"98.5",3263,"andrewh@spc.int","andrewh@spc.int","API","2021-10-13T14:24:53.51","SELECT	TOP 10 c.sp_code,
		SUM(c.sp_kg) sp_kg into #t
FROM	art2.trips t JOIN art2.effort e ON t.art_trip_id=e.art_trip_id
		JOIN art2.catch c ON c.art_effort_id=e.art_effort_id
WHERE	DATEDIFF(MONTH,t.trip_date, CURRENT_TIMESTAMP)<37
AND		t.entered_by=:staff_code
GROUP BY c.sp_code
ORDER BY SUM(c.sp_kg) DESC

SELECT	CONVERT(VARCHAR,YEAR(t.trip_date)) + '-Q' + CONVERT(VARCHAR,DATEPART(QUARTER,t.trip_date)) quarter,
		c.sp_code,
		CONVERT(DECIMAL(8,2),CONVERT(FLOAT,SUM(c.sp_kg))/SUM(c.sp_n)) avg_weight into #t2
FROM	art2.trips t JOIN art2.effort e ON t.art_trip_id=e.art_trip_id
		JOIN art2.catch c ON c.art_effort_id=e.art_effort_id
		JOIN #t ON #t.sp_code = c.sp_code
WHERE	DATEDIFF(MONTH,t.trip_date, CURRENT_TIMESTAMP)<37
AND		t.entered_by=:staff_code
GROUP BY CONVERT(VARCHAR,YEAR(t.trip_date)) + '-Q' + CONVERT(VARCHAR,DATEPART(QUARTER,t.trip_date)),c.sp_code
ORDER BY quarter SELECT	quarter,
		sp_code,
		avg_weight
FROM	#t2",NA
"222","5cd87850-29ac-4717-8e8a-aaf50122ee36"," ARTISANAL - List of all Canoes","","A list of all the Canoes in the database","Artisanal",NA,NA,"105",3337,"andrewh@spc.int","andrewh@spc.int","Artisanal, ByVessel","2021-09-30T11:58:56.31"," select v.vessel_name,
	v.boat_power_id,
	v.system_source,
	v.entered_by,
	tr.value_en
from art2.vessels v
LEFT OUTER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalVesselPowerModes' + CONVERT(VARCHAR,v.boat_power_id)
where boat_power_id = 2
	and v.is_active = 1
	and v.visibility = ref.getbitfromentity(@@entity)",NA
"223","20198ec5-b1e2-4db9-ab80-146bf9c9d247"," ARTISANAL - Custom vessel list WITH landing sites and counts of landings","","Constructed originally for CK Ministry of Transport","Artisanal",NA,NA,"102",3133,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, ByVessel, CoverageMissingData","2021-10-12T15:45:55.133"," SELECT [vessel_name]
      ,[ves_island_code]
      ,YEAR(v.entered_date) as first_registered
      ,CASE WHEN vessel_date IS NULL THEN '' ELSE CONVERT(varchar(50), vessel_date, 103) END as vessel_date      
      ,[owner_name]
      ,[owner_postal_address] 
      ,[owner_island]
      ,[owner_contact]
      ,[vessel_make]
      ,tr2.value_en as [hull_material] 
      ,[vessel_length]
      ,[vessel_hull_type]
      ,tr1.value_en as [boat_power]
      ,case WHEN [sports_fishing_boat] = 1 THEN 'Y' WHEN [sports_fishing_boat] = 0 THEN 'N' WHEN [sports_fishing_boat] is null THEN '?' END as sports_fishing_boat 
      ,[engine_power]
      ,[outboards_n]
      ,tr3.value_en as [fuel_type]
	  ,l.landing_site_name
	  ,count(*) as landing_count
	  ,CONVERT(varchar, max(t.trip_date), 23) as last_landing
  FROM [art2].[vessels] v
	LEFT OUTER JOIN tuf2.translations tr1 ON tr1.translation_key = 'LookupList_ArtisanalVesselPowerModes' + CONVERT(VARCHAR,v.boat_power_id)
	LEFT OUTER JOIN tuf2.translations tr2 ON tr2.translation_key = 'LookupList_HullMaterials' + CONVERT(VARCHAR,v.[hull_material_id])
	LEFT OUTER JOIN tuf2.translations tr3 ON tr3.translation_key = 'LookupList_ArtisanalFuelTypes' + CONVERT(VARCHAR,v.[fuel_type_id])
	left outer join art2.trips t on t.vessel_id = v.vessel_id
	LEFT OUTER JOIN art2.landing_sites l on l.landing_site_id = t.landing_site_id
  where is_active = 1 and v.visibility & (SELECT ref.GetBitFromEntity(@@entity)) <> 0
  group by
  [vessel_name]
      ,[ves_island_code]
      ,YEAR(v.entered_date)
      ,CASE WHEN vessel_date IS NULL THEN '' ELSE CONVERT(varchar(50), vessel_date, 103) END   
      ,[owner_name]
      ,[owner_postal_address] 
      ,[owner_island]
      ,[owner_contact]
      ,[vessel_make]
      ,tr2.value_en
      ,[vessel_length]
      ,[vessel_hull_type]
      ,tr1.value_en
      ,case WHEN [sports_fishing_boat] = 1 THEN 'Y' WHEN [sports_fishing_boat] = 0 THEN 'N' WHEN [sports_fishing_boat] is null THEN '?' END
      ,[engine_power]
      ,[outboards_n]
      ,tr3.value_en
	  ,l.landing_site_name",NA
"224","ebf03431-ba20-44ab-a5d7-ac4800ec98b1"," Total Catch by species by Month (ALL)","year","Total Catch by species","Logsheets",NA,NA,"8a",3412,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ","2023-10-12T13:52:05.953"," select

	v.vesselname vessel_name,
	month(s.logdate) as month,
	Year(s.logdate) as year,
	sum(s.hooks_n) as Tot_hks,
	c.sp_code,
	sp.sp_name,
	sum(c.sp_kg) as Tot_kg,
	sum(c.sp_n) as Tot_no

from log.trips_ds t


	join log.sets_ds S on t.log_trip_id = S.log_trip_id

	join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.species sp on c.sp_code = sp.sp_code

	join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date

where Year(s.logdate) = :year
	AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))


Group by v.vesselname, 
	month(s.logdate),
	Year(s.logdate),
		c.sp_code, sp.sp_name",NA
"225","39884c87-a17d-474e-9cfd-a81200df5583"," Species compostion for a paired trip: E-Monitoring vs Logbook vs Unloadings","trip_id","Species compostion for a paired trip: E-Monitoring vs Logbook vs Unloadings.
NOTE: You will need to enter the EM_STAFF_CODE together with the TRIPNO as the Observer Trip Id without any space character between them in the box provided below eg 'xxx17-01'","Logsheets,Port",1,"Observer","6b",3219,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Unloading, Longline, Emonitoring","2024-10-17T11:22:37.303","SELECT sp.sp_name collate database_default AS sp_name
	,lc.sp_code collate database_default AS sp_code
	,sum(0001) AS obs_reported
	,SUM(0000) AS log_reported
	,SUM(0000) AS unl_reported
INTO #temp_EMLOG_1
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN em.l_set ls ON et.obstrip_id = ls.obstrip_id
INNER JOIN em.l_setcatch lc ON ls.l_set_id = lc.l_set_id
INNER JOIN ref.species sp ON lc.sp_code = sp.sp_code
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.unload2.unloadings ul ON ul.vessel_id = vi.vessel_id
	AND ul.unload_startdate BETWEEN et.ret_date AND et.ret_date + 3
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY obstrip_key
	,sp.sp_name
	,lc.sp_code

UNION

SELECT sp.sp_name collate database_default AS sp_name
	,sp.sp_code collate database_default AS sp_code
	,SUM(0000) AS obs_reported
	,sum(coalesce(sp_n, 0000)) AS log_reported
	,SUM(0000) AS unl_reported
FROM em.trip et
INNER JOIN ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.unload2.unloadings ul ON ul.vessel_id = et.vessel_id
	AND ul.unload_startdate BETWEEN et.ret_date	AND et.ret_date + 3
INNER JOIN tufman2_dorado.log.sets_ll s ON lt.log_trip_id = s.log_trip_id
INNER JOIN tufman2_dorado.log.catch_ll c ON c.log_set_id = s.log_set_id
INNER JOIN tufman2_dorado.ref.species sp ON c.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
GROUP BY sp.sp_name
	,sp.sp_code

UNION

SELECT sp.sp_name collate database_default AS sp_name
	,sp.sp_code collate database_default AS sp_code
	,SUM(0000) AS obs_reported
	,sum(0000) AS log_reported
	,SUM(coalesce(sp_n, 0000)) AS unl_reported
FROM em.trip et
INNER JOIN tufman2_dorado.ref.vessel_instances vi ON vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN tufman2_dorado.log.trips_ll lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.unload2.unloadings ul ON ul.vessel_id = et.vessel_id
	AND ul.unload_startdate BETWEEN et.ret_date	AND et.ret_date + 3
INNER JOIN tufman2_dorado.unload2.unloading_catch c ON c.unload_id = ul.unload_id
INNER JOIN tufman2_dorado.ref.species sp ON c.sp_code = sp.sp_code
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id, RTRIM(st.staff_code) + et.tripno) = RTRIM(st.staff_code) + et.tripno
	AND right(et.obsprg_code, 2) = 'EM'
GROUP BY sp.sp_name
	,sp.sp_code; SELECT sp_name
	,sp_code
	,sum(obs_reported) AS em_reported
	,sum(log_reported) AS log_reported
	,sum(unl_reported) AS unl_reported
FROM #temp_EMLOG_1
GROUP BY sp_name
	,sp_code",NA
"226","4e861178-604e-443d-8795-ab6e00b1b730"," LONGLINE -- Observer All Catch Location","eez_code, flag_code, year, obsv_prg","All catches with location","Observer",NA,"Observer","6",3377,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2022-02-17T15:53:15.007"," SELECT 	
		flag_id,
		obsv.lond1(lond) lon,
		obsv.latd1(latd) lat,
		eez_code,
		sp.sp_cat_code,
		sc.sp_code,
		sp.sp_name,
		fate_code,
		catch_dtime,
sc.len,
sc.len_code
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
			inner join obsv.l_setcatch sc on sc.l_set_id = ls.l_set_id
			inner join ref.species sp on sp.sp_code=sc.sp_code 
WHERE YEAR(set_date) = coalesce(:year,year(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
	AND eez_code = coalesce(:eez_code,eez_code)",NA
"227","7478b4d5-ccce-4d39-ae54-ab0400f4e426"," Number of active PS vessels by month and flag","year","Number of active PS vessels by month and flag - Only include ROP trips and consider setting and searching as fishing activities","Observer",NA,"Observer","4",3343,"andrewh@spc.int","emmanuels@spc.int","Observer","2023-07-12T16:37:32.827"," select 
	t1.flag_rg_id,
	Total_rfv_vessel,
	Total_Active_Vessels,
	SUM(case when _month = 1 then Active_Vessels else 0 end) as 'Jan',
	SUM(case when _month = 2 then Active_Vessels else 0 end) as 'Feb',
	SUM(case when _month = 3 then Active_Vessels else 0 end) as 'Mar',
	SUM(case when _month = 4 then Active_Vessels else 0 end) as 'Apr',
	SUM(case when _month = 5 then Active_Vessels else 0 end) as 'May',
	SUM(case when _month = 6 then Active_Vessels else 0 end) as 'Jun',
	SUM(case when _month = 7 then Active_Vessels else 0 end) as 'Jul',
	SUM(case when _month = 8 then Active_Vessels else 0 end) as 'Aug',
	SUM(case when _month = 9 then Active_Vessels else 0 end) as 'Sep',
	SUM(case when _month = 10 then Active_Vessels else 0 end) as 'Oct',
	SUM(case when _month = 11 then Active_Vessels else 0 end) as 'Nov',
	SUM(case when _month = 12 then Active_Vessels else 0 end) as 'Dec'
from
(
	select MONTH(act_date) as _month,count(distinct ot.vessel_id) as Active_Vessels,flag_rg_id
	FROM obsv.trip ot 
	join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
	join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
	join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
	where s_activ_id in (1,2) and year(act_date)=:year and ot.rop_trip=1
	group by MONTH(act_date),flag_rg_id
) t1 join (
	select count(distinct ot.vessel_id) as Total_Active_Vessels,flag_rg_id
	FROM obsv.trip ot 
	join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
	join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
	join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
	where s_activ_id in (1,2) and year(act_date)=:year and ot.rop_trip=1
	group by flag_rg_id) t2 on t1.flag_rg_id=t2.flag_rg_id join
	(select count(*) as total_rfv_vessel,flag_rg_id from ref.vessel_instances vi join ref.vessels v on vi.vessel_id=v.vessel_id
	 where :year between year(start_date) and year(calculated_end_date) and gear='S' and v.wcpfc_id is not null
	group by flag_rg_id) t3 on t3.flag_rg_id = t2.flag_rg_id
group by t1.flag_rg_id,Total_Active_Vessels,Total_rfv_vessel",NA
"228","9074c411-7457-4960-a2d0-abcf00dfddfd"," IATTC Area -- TASK II -- LONGLINE Catch and effort (1x1)","year","Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (1x1 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32b",3389,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-26T12:09:35.223","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
        floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat))+0.5,
         floor(ref.GetLonDfromLon(lon))+0.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
            floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips, 
	    COUNT(distinct s.log_set_id) as sets, 
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)                                      as decimal(7,0))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then sp_n_est else 0 end)                                      as decimal(7,0))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then sp_n_est else 0 end)                                      as decimal(7,0))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then sp_n_est else 0 end)                                      as decimal(7,0))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then sp_n_est else 0 end)                                      as decimal(7,0))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then sp_n_est else 0 end)                                      as decimal(7,0))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then sp_n_est else 0 end)                                      as decimal(7,0))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then sp_n_est else 0 end)                                      as decimal(7,0))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.GetLatDfromLat(lat))+0.5 = cte.latitude
                                                        and floor(ref.GetLonDfromLon(lon))+0.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  and s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat))+0.5,floor(ref.GetLonDfromLon(lon))+0.5, FORMAT(logdate, 'yyyy-MM')",NA
"229","fec21d75-6386-6360-4fd4-3a0c5ad63d85","CMM 22-02 North Pacific Swordfish","flag_code, year","CMM 22-02 North Pacific Swordfish","Logsheets",NA,NA,NA,3513,"andrewh@spc.int","peterw@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2024-06-19T12:15:11.203"," SELECT  vi.flag_id as flag, 
		year(logdate) as yr,
		COUNT(distinct case when RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then t.vessel_id else null end) as vessels,
		SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as SWO_n,
		cast(SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as SWO_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
   AND in_wcpfc_area = 1
group by vi.flag_id, year(logdate)",NA
"230","1cf293df-1c89-49d5-9d99-a820010ebda0"," ARTISANAL - NON FAD CPUE:  Catch per line hour (Year) BY LANDING SITE","year",NA,"Artisanal",NA,NA,"4.2.2",3223,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2021-09-29T17:19:20.337","SELECT	YEAR(t.trip_date) [year],l.landing_site_name, SUM(e.hours_fished_n * e.lines_n) effort into #t
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.areas a ON a.art_area_id = e.art_area_id
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY YEAR(t.trip_date),l.landing_site_name
having SUM(e.hours_fished_n * e.lines_n) > 0 

SELECT	YEAR(t.trip_date) [year],l.landing_site_name, c.sp_code,CONVERT(DECIMAL(6,2),SUM(COALESCE(c.sp_kg,0))) catch_kg,#t.effort as effort_hours, CONVERT(DECIMAL(6,2),SUM(COALESCE(c.sp_kg,0))/#t.effort) as cpue_kgperhour
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.areas a ON a.art_area_id = e.art_area_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN #t ON #t.year = YEAR(t.trip_date)  AND #t.landing_site_name = l.landing_site_name
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
		and #t.effort > 0
GROUP BY YEAR(t.trip_date),l.landing_site_name, c.sp_code, #t.effort",NA
"231","5fedd61f-8a19-4944-b0c8-abe400c39d81"," IATTC Area -- TASK II -- LONGLINE Catch and effort (1x1) DISCARDS","year","THIS REPORT IS DISCARDS ONLY - Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (5x5 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32d",3395,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-30T13:03:17.367","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
        floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat))+0.5,
         floor(ref.GetLonDfromLon(lon))+0.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat))+0.5 as latitude,
            floor(ref.GetLonDfromLon(lon))+0.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips,
			COUNT(distinct s.log_set_id) as sets,
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.GetLatDfromLat(lat))+0.5 = cte.latitude
                                                        and floor(ref.GetLonDfromLon(lon))+0.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  and s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat))+0.5,floor(ref.GetLonDfromLon(lon))+0.5, FORMAT(logdate, 'yyyy-MM')",NA
"232","7fde16cb-fb9a-45c0-b926-ab1e00b6c250"," Monthly unloading by trip (source unloading)  - target species","year","Monthly unloading by trip (source unloading) for target species with EEZ","Port",NA,NA,"10a1",3359,"andrewh@spc.int","brunod@spc.int","Unloading, DeepwaterSnapper","2021-09-28T12:55:10.613"," Select year(unload_startdate) YY,
	 month(unload_startdate) MM,
	 p.port_name,
	
	 
	convert(nvarchar(10),case when unload_startdate is null then unload_startdate else unload_startdate end, 103) as unl_date,

	cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))	AS pfm_kg,
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))	AS pfm_n,
		
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lwf_kg,
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))	AS lwf_n,

	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS etc_kg,
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))	AS etc_n, 
	
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS eta_kg,
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))	AS eta_n,
	
	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))	AS arq_kg,
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))	AS arq_n,
	
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lrk_kg,
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))	AS lrk_n,
	
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS bwa_kg,
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))	AS bwa_n,
	
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS ytc_kg,
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))	AS ytc_n,

	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))	AS sey_kg,
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))	AS sey_n,

	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0
						when 'ARQ' then 0 when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 
						when 'YTC' then 0 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n,
	ref.GetEntityFromBit(u.instance_source) as country
	

from unload2.unloadings u join ref.vessel_instances vi on u.vessel_id = vi.vessel_id and u.unload_startdate between vi.start_date and vi.calculated_end_date
join unload2.unloading_catch uc on u.unload_id = uc.unload_id LEFT OUTER JOIN  ref.ports p ON p.port_id=u.port_id

where gear_code = 'D' and year(unload_startdate) = :year 


group by year(unload_startdate),
	 month(unload_startdate),
	 unload_startdate,
	 p.port_name,
	 ref.GetEntityFromBit(u.instance_source)",NA
"233","df036d8e-b7a9-4476-931f-ac0701107bc8"," PURSE SEINE -- All Catches with association type location (US expanded version)","eez_code, flag_code, year","PURSE SEINE -- All Catches with association type and location (US expanded version)","Observer",NA,"Observer","12",3400,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2025-09-12T07:47:02.52","select v.vesselname,
v.flag_id,
t.dep_date,
t.ret_date,
'T-'+tripno as trip_no,
set_number,
act_date as set_date,
act_time as set_time,
latd,
lond,
eez_code,
ssi_observed_time,
case when sch.code_used_in_form in ('1','2') then 'free school' else 'associated' end as sch_asso,
sch.school_association_desc,
sp.sp_cat_code,
sc.sp_code,
sp.sp_name,
sp.sp_sci_name,
fate_code,
cond_code,
discard_cond_code,
obs_n,
obs_mt,
sp_n_est,
sp_c_est
from obsv.trip t join obsv.s_day d on d.obstrip_id = t.obstrip_id
join obsv.s_daylog dl on dl.s_day_id = d.s_day_id
join obsv.s_set s on s.s_daylog_id = dl.s_daylog_id
join obsv.s_setcatch sc on sc.s_set_id = s.s_set_id
join ref.species sp on sp.sp_code = sc.sp_code
join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
left join ref_static.ps_school_associations sch on sch.schas_id = dl.schas_id
where eez_code = coalesce(:eez_code,eez_code)
AND flag_id = coalesce(:flag_code,flag_id)
AND YEAR(act_date) = coalesce(:year,year(act_date))",NA
"234","fc21e66b-88c3-4ade-83b6-abd50104b913","LONGLINE - Key species catches in WCPFC Area raised with VMS (Vanuatu alternative) - NATIONAL FLEET ","year","NATIONAL FLEET - Longline - Key species catches (and discards) in WCPFC Area raised with VMS (Vanuatu alternative)","Logsheets,VMS",NA,NA,"2.2.6",3391,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CoverageMissingData, Custom, RegionalReporting, AllSpecies","2023-04-04T11:16:13.223","SELECT  eez.eez_code,
		eez.year as cyear,
		eez.month,
		SUM(case when l.log_trip_id is null then eez.day_fishing else 00000 end) day_fishing 
into #missing_trip
FROM    vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
        JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN vms.vms_trip_efforts eez ON t.vms_trip_id = eez.vms_trip_id
            LEFT OUTER JOIN log.vw_trips_ll_VU  l  ON t.vessel_id = l.vessel_id AND (
							l.depart_date < t.return_date
							AND l.return_date > t.departure_date
            )
WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND        ve.gear = 'L'
AND        eez.year = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and     eez_code <> 'IW'
GROUP BY eez.eez_code, eez.year, eez.month

/*--------------------------------------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id 
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		l_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, vi.flag_id

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		c.sp_code,
		vi.flag_id,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0))) catch,
        SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0)))/SUM(CASE WHEN COALESCE(c.sp_n_est,coalesce(c.sp_n,0)) = 0 THEN 1 ELSE COALESCE(c.sp_n_est,coalesce(c.sp_n,0)) END) avg_wt,
		SUM(COALESCE(c.spdiscard_kg_est,000000)) discard,
		SUM(COALESCE(c.spdiscard_n,000000)) discard_n INTO #catch0
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, c.sp_code, vi.flag_id
UNION 
SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		CASE WHEN sp.sp_code = 'SPN' THEN 'HAM' ELSE sp.sp_code END sp_code,
		vi.flag_id,
		SUM(000000) catch,
        SUM(000000) avg_wt,
		SUM(000000) discard,
		SUM(000000) discard_n
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		JOIN ref.species sp on sp.sp_code = sp.sp_code
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		sp.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','THR','MAK','SPN','POR')
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, sp.sp_code, vi.flag_id

SELECT  cyear,
        month, 
        eez_code,
        sp_code,
        flag_id,
        SUM(catch) catch,
		MAX(avg_wt) avg_wt,
        SUM(discard) as discard,
		SUM(discard_n) discard_n
into #catch
FROM   #catch0 
GROUP BY  cyear, month, eez_code, sp_code, flag_id

SELECT	e.cyear, e.month, e.eez_code, c.sp_code, e.flag_id, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month / Fleet / EEZ' raising_factor INTO #cpue
FROM	#effort e JOIN #catch c ON e.eez_code = c.eez_code AND e.cyear = c.cyear AND e.eez_code = c.eez_code AND e.month = c.month

SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_kg, c.raising_factor INTO #missing_catch
FROM	#missing_trip JOIN #cpue c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month AND #missing_trip.eez_code = c.eez_code
WHERE	c.nb_days >= 100 
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')

/*---------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		s.eez_code,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_1
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		l_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		c.sp_code,
		s.eez_code,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0000))) catch INTO #catch_raised_1
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
		JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = :year
AND		vi.flag_id = @@entity
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code, s.eez_code

SELECT	e.cyear, e.month, c.sp_code, e.eez_code, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month / EEZ' raising_factor INTO #cpue_raised_1
FROM	#effort_raised_1 e JOIN #catch_raised_1 c ON e.cyear = c.cyear AND e.eez_code = c.eez_code AND e.month = c.month

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM	#missing_trip JOIN #cpue_raised_1 c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month AND #missing_trip.eez_code = c.eez_code
WHERE	c.nb_days >= 100 
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
AND NOT EXISTS (
	SELECT	1
	FROM	#missing_catch temp
	WHERE	temp.cyear =  #missing_trip.cyear
	AND		temp.eez_code = #missing_trip.eez_code
	AND		temp.month = #missing_trip.month
)

/*-----------------------*/

SELECT	DATEPART(YEAR, s.logdate) cyear,
		DATEPART(MONTH,s.logdate) month, 
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_2
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
WHERE	YEAR(logdate) = :year
AND		l_activity_id = 1
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate)

SELECT	DATEPART(YEAR, s.logdate) cyear, 
		DATEPART(MONTH,s.logdate) month, 
		c.sp_code,
		SUM(COALESCE(c.sp_kg_est,coalesce(c.sp_kg,0000))) catch into #catch_raised_2
FROM	log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
WHERE	YEAR(logdate) = :year
AND		c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
and     in_wcpfc_area = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code

SELECT	e.cyear, e.month, c.sp_code,CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month' raising_factor into #cpue_raised_2
FROM	#effort_raised_2 e JOIN #catch_raised_2 c ON e.cyear = c.cyear AND e.month = c.month

INSERT INTO #missing_catch
SELECT	#missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM	#missing_trip JOIN #cpue_raised_2 c ON #missing_trip.cyear = c.cyear AND #missing_trip.month = c.month
WHERE	c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
AND NOT EXISTS (
	SELECT	1
	FROM	#missing_catch temp
	WHERE	temp.cyear =  #missing_trip.cyear
	AND		temp.eez_code = #missing_trip.eez_code
	AND		temp.month = #missing_trip.month
	)

SELECT	COALESCE(c.cyear,mc.cyear) cyear,
		COALESCE(c.eez_code,mc.eez_code) eez_code,  
		COALESCE(c.sp_code,mc.sp_code) sp_code, 
		CONVERT(DECIMAL(15,2),SUM(COALESCE(c.catch,0))) log_c, 
		CONVERT(DECIMAL(15,2),SUM(COALESCE(c.discard,0))) disc_c, 
		CONVERT(DECIMAL(15),SUM(COALESCE(c.discard_n,0))) disc_n, 
		CONVERT(DECIMAL(10,2),SUM(COALESCE(mc.sp_kg,0))) vms_c, 
		SUM(COALESCE(mc.day_fishing,0)) vms_missing_days,
		MAX(coalesce(avg_wt,0)) avg_wt into #final
FROM	#catch c FULL OUTER JOIN #missing_catch mc ON c.eez_code = mc.eez_code AND c.cyear = mc.cyear and c.month = mc.month and c.sp_code = mc.sp_code
GROUP BY COALESCE(c.cyear,mc.cyear),COALESCE(c.eez_code,mc.eez_code), COALESCE(c.sp_code,mc.sp_code)

SELECT	f.cyear, f.eez_code,sp_code,log_c, disc_c,disc_n,log_c+vms_c tot_c,SUM(COALESCE(e.nb_days,0)) nb_days,vms_missing_days,avg_wt INTO #final2
FROM	#final f LEFT OUTER JOIN #effort e ON e.eez_code = f.eez_code AND e.cyear = f.cyear
GROUP BY f.cyear, f.eez_code,sp_code,log_c, disc_c,disc_n,vms_c, vms_missing_days,avg_wt

 SELECT case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end as category,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end as species,
SUM(log_c)/1000 log_c, 
SUM(tot_c)/1000 tot_c, 
CONVERT(DECIMAL(15,2),SUM(nb_days)*100/(SUM(nb_days)+SUM(vms_missing_days))) log_cov,
case when SUM(disc_c) = 0 and SUM(disc_n) > 0
		then max(avg_wt) * SUM(disc_n)/ 1000
		else SUM(disc_c)/1000 end disc_c,
SUM(disc_n) disc_n
FROM #final2 c INNER JOIN	ref.species sp on case when c.sp_code = 'HAM' then 'SPN' else c.sp_code end = sp.sp_code
GROUP BY case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end",NA
"235","2c9dfbe7-6163-4992-b219-acca01077b41"," PURSE SEINE - Daily Ship's/UTC dates from PS2","flag_code, min_year, max_year",NA,"Observer",NA,"Observer","14",3425,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-12-06T14:28:52.313"," SELECT 	ot.obstrip_id,
		vesselname,
		flag_id as flag, 
		dep_date, 
		ret_date,
		sd.start_dtime,
		sd.start_time,
		sd.utc_start_dtime,
		sd.utc_start_time
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
WHERE YEAR(dep_date) >= coalesce(:min_year,year(dep_date)) and YEAR(dep_date) <= coalesce(:max_year,year(dep_date)) and flag_id = coalesce(:flag_code,flag_id)",NA
"236","882f27a7-8d6b-455e-ac7f-aac50110ebc3"," SNAPPER - Number of trips by vessel by month","year","Number of trips by vessel by month base on return date (loghseets)","Logsheets",NA,NA,"5",3322,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel","2023-10-12T13:48:48.807"," SELECT	v.vesselname vesel_name,
		YEAR(t.return_date) year,
		SUM(CASE WHEN MONTH(t.return_date) = 1 THEN 1 ELSE 0 END) Jan,
		SUM(CASE WHEN MONTH(t.return_date) = 2 THEN 1 ELSE 0 END) Feb,
		SUM(CASE WHEN MONTH(t.return_date) = 3 THEN 1 ELSE 0 END) Mar,
		SUM(CASE WHEN MONTH(t.return_date) = 4 THEN 1 ELSE 0 END) Apr,
		SUM(CASE WHEN MONTH(t.return_date) = 5 THEN 1 ELSE 0 END) May,
		SUM(CASE WHEN MONTH(t.return_date) = 6 THEN 1 ELSE 0 END) Jun,
		SUM(CASE WHEN MONTH(t.return_date) = 7 THEN 1 ELSE 0 END) Jul,
		SUM(CASE WHEN MONTH(t.return_date) = 8 THEN 1 ELSE 0 END) Aug,
		SUM(CASE WHEN MONTH(t.return_date) = 9 THEN 1 ELSE 0 END) Sep,
		SUM(CASE WHEN MONTH(t.return_date) = 10 THEN 1 ELSE 0 END) Oct,
		SUM(CASE WHEN MONTH(t.return_date) = 11 THEN 1 ELSE 0 END) Nov,
		SUM(CASE WHEN MONTH(t.return_date) = 12 THEN 1 ELSE 0 END) Dec
FROM	log.trips_ds t JOIN ref.vessel_instances v ON t.vessel_id = v.vessel_id  and t.return_date between v.start_date and v.calculated_end_date
WHERE	YEAR(t.return_date) = :year 
GROUP BY  v.vesselname, YEAR(t.return_date)",NA
"237","4652a023-24f2-4a84-93fb-ad4e01193787"," LONGLINE Catch by location, species and vessels (1x1)","year",NA,"Logsheets",NA,NA,"22",3433,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, MyEEZ, AllSpecies","2023-09-25T10:52:43.86"," select year(logdate) yr,company_name,vi.vesselname,
	COUNT(DISTINCT CAST(t.log_trip_id AS VARCHAR(50)) + CAST(CAST(logdate AS DATE) AS VARCHAR(10))) log_days,
	floor(latd/1)*1+0.5 lat,floor(lond/1)*1+0.5 lon,max(hhooks) hks,vi.flag_id,sp.sp_cat_code,c.sp_code,sum(ISNULL(coalesce(sp_kg,sp_kg_est),0)) as wt_kg,sum(ISNULL(coalesce(sp_n,sp_n_est),0)) as nbr,sum(ISNULL(c.spdiscard_n,0)) as discard_nbr,
	sum(ISNULL(coalesce(sp_kg,sp_kg_est),0))*1.0/COUNT(DISTINCT CAST(t.log_trip_id AS VARCHAR(50)) + CAST(CAST(logdate AS DATE) AS VARCHAR(10))) kg_per_day,
	sum(ISNULL(coalesce(sp_kg,sp_kg_est),0))*1.0 / max(hhooks)*1000 as gr_per_hk

FROM    log.trips_ll t 
		JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date 
		JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		JOIN ref.species sp on sp.sp_code = c.sp_code
		LEFT JOIN [tufman].[companies] comp on comp.company_id = vi.company_id
        JOIN (
            SELECT  vesselname,floor(latd/1)*1+0.5 lat1,floor(lond/1)*1+0.5 lon1,flag_id,year(logdate) yr,
                    SUM(hooks_n) hhooks  
            FROM    log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
                    JOIN ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date 
            WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
            GROUP BY vesselname,floor(latd/1)*1+0.5,floor(lond/1)*1+0.5,flag_id,year(logdate)
        ) tmp ON floor(latd/1)*1+0.5 = lat1 and floor(lond/1)*1+0.5 = lon1 and year(logdate) = yr and tmp.flag_id = vi.flag_id and tmp.vesselname = vi.vesselname
WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(latd/1)*1+0.5 ,floor(lond/1)*1+0.5, year(logdate),vi.vesselname,vi.flag_id,c.sp_code,sp.sp_cat_code,company_name",NA
"238","6fcc05e8-d56d-4ff7-af8d-ab4c0116a340"," Annual Bycatch and Tuna numbers- EM vs OB","year","Bycatch and Tuna numbers- EM vs OB","Observer",1,"Observer","3e",3371,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T11:51:34.693","  IF OBJECT_ID('tempdb.dbo.#bycatch', 'U') IS NOT NULL
  DROP TABLE #bycatch;
  
  select
	(case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end) as category ,
	sum(1) as em_n,
	sum(000000) as ob_n,
	sum(case when left(fate_code,1)='R' then 1 else 0 end) as em_ret,
	sum(000000) as ob_ret,
	sum(case when left(fate_code,1)='D' then 1 else 0 end) as em_disc,
	sum(000000) as ob_disc
into #bycatch
from em.trip em
inner join ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and em.dep_date between ot.dep_date and ot.ret_date
inner join em.l_set ls on ls.obstrip_id=em.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where year(em.dep_date)=:year
group by case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end
UNION
  select 
	case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end as category,
	sum(000000) as em_n,
	sum(1) as ob_n,
	sum(000000) as em_ret,
	sum(case when left(fate_code,1)='R' then 1 else 0 end) as ob_ret,
	sum(000000) as em_disc,
	sum(case when left(fate_code,1)='D' then 1 else 0 end) as ob_disc
from em.trip em
inner join ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and em.dep_date between ot.dep_date and ot.ret_date
inner join obsv.l_set ls on ls.obstrip_id=ot.obstrip_id
inner join obsv.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where year(em.dep_date)=:year
group by case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end select 
	category,
	sum(em_n) as em_n,
	sum(ob_n) as ob_n,
	sum(em_ret) as em_ret,
	sum(ob_ret) as ob_ret,
	sum(em_disc) as em_disc,
	sum(ob_disc) as ob_disc
from #bycatch
group by category",NA
"239","10a2d34f-cae4-428a-a840-ad6000a2e915"," Total Catch by Year and EEZ","flag_code, min_year, max_year","Report for MSC process - Number of catch by Year - Weights are estimated","Observer",NA,"Observer","85",3439,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-23T10:39:28.413"," select t.dep_date,year(t.dep_date) as yr,vesselname,flag_id,eez_code,sc.sp_code,sp.sp_cat_code,sp.sp_name,cond_code,cond_code2,
SUM(case when LEFT(sc.fate_code,1)='R' then 1 else 0 end) as Retained_Number,
SUM(case when LEFT(sc.fate_code,1)='D' then 1 else 0 end) as Discarded_Number,
SUM(case when LEFT(sc.fate_code,1)='R' then wt_est else 0.0 end) as Retained_Weight,
SUM(case when LEFT(sc.fate_code,1)='D' then wt_est else 0.0 end) as Discarded_Weight,
case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end as Discarded_fate_code
from obsv.trip t 
join obsv.l_set s on s.obstrip_id = t.obstrip_id
join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=83
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sp.sp_code = sc.sp_code
left join ref_static.fate_codes f on f.fate_code = sc.fate_code
where YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
and flag_id=coalesce(:flag_code,flag_id)
group by t.dep_date,year(t.dep_date),vesselname,flag_id,eez_code,sc.sp_code,sp.sp_cat_code,sp.sp_name,cond_code,cond_code2,case when LEFT(sc.fate_code,1)='R' then 'Retained' else fate_desc end",NA
"240","fb759eef-3e50-9982-517e-3a03e6461adb","PURSE SEINE - NATIONAL FLEET - Fishing effort (trips/fishing days)","year","Purse seine Logsheets - Number of trips/fishing days made by national fleet by year","Logsheets",NA,NA,NA,3476,"emmanuels@spc.int","emmanuels@spc.int","Logsheet, Purseseine, RegionalReporting","2022-05-18T09:18:39.557","SELECT min(ves.flag_id) as flag,count(distinct trip.log_trip_id) as nb_trips,
				Count(*) as Nb_Fishing_days
FROM log.trips_ps AS trip 
		INNER JOIN log.sets_ps AS sets ON trip.log_trip_id = sets.log_trip_id
		INNER JOIN ref.vessel_instances AS ves ON trip.vessel_id = ves.vessel_id AND trip.first_logdate between ves.start_date and ves.calculated_end_date
WHERE sets.s_activity_id = 1 AND YEAR(logdate)=:year AND ves.flag_id = @@entity ",NA
"241","ff1c8a80-fd7f-4ae9-8497-abdf010b7737"," IATTC Area -- TASK II -- LONGLINE Catch and effort (5x5) DISCARDS","year","THIS REPORT IS DISCARDS ONLY - Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (5x5 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32c",3394,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-30T15:20:04.44","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
        floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
       AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,
         floor(ref.GetLonDfromLon(lon)/5)*5+2.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
            floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips,
			COUNT(distinct s.log_set_id) as sets,
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then spdiscard_n else 0 end)                                      as decimal(7,0))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.GetLatDfromLat(lat)/5)*5+2.5 = cte.latitude
                                                        and floor(ref.GetLonDfromLon(lon)/5)*5+2.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  AND s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonDfromLon(lon)/5)*5+2.5, FORMAT(logdate, 'yyyy-MM')",NA
"242","77ec66cd-6ec7-4ef9-a51f-acc500e7d90f"," DEBRIEFING - PS Score Details by Year and Flag","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","4",3423,"andrewh@spc.int","colleyf@spc.int","Debriefing, Observer","2022-03-22T10:03:02.937"," SELECT 
x.debriefer_obsprg_code AS debriefer_obsprg_code,
x.staff_code AS staff_code,
x.tripno AS tripno,
x.vesselname AS vesselname,
x.flag AS flag, 
x.gear_code AS gear_code,
x.depart_date AS depart_date,
x.return_date AS return_date,
x.trip_days AS trip_days,
x.waiting_debrief_days AS waiting_debrief_days,
x.debrief_start AS debrief_start,
x.debrief_end AS debrief_end,
x.debrief_hrs AS debrief_hrs,
x.debrief_days AS debrief_days,
x.debriefer_code AS debriefer_code,
x.summary_details AS summary_details,
SUM(x.response_score) AS response_score,
SUM(x.ps_score) AS ps_score,
CASE WHEN SUM(x.response_score) <> 0 THEN CAST(ROUND( CAST(SUM(coalesce(x.response_score,0)) AS decimal(5,2)) / CAST(SUM(coalesce(x.ps_score,0)) AS decimal(5,2)) *100.0,2) AS decimal(5,2))
     ELSE 0 END AS ps_pct
FROM (

  SELECT 
        d.debriefer_obsprg_code AS debriefer_obsprg_code,
		f.staff_code AS staff_code,
        d.tripno AS tripno,
		v.vesselname AS vesselname,
        v.flag_id AS flag, 
		d.gear_code AS gear_code,
		CONVERT(VARCHAR, d.dep_date, 106) AS depart_date,
        CONVERT(VARCHAR, d.ret_date, 106) AS return_date,
		DATEDIFF(D,d.dep_date, d.ret_date)+1 AS trip_days,
		DATEDIFF(DAY,d.ret_dtime,d.debrief_start_dtime) AS waiting_debrief_days,
		CONVERT(VARCHAR, d.debrief_start_dtime, 113) AS debrief_start,
        CONVERT(VARCHAR, d.debrief_end_dtime, 113) AS debrief_end,
		DATEDIFF(HOUR,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_hrs,
		DATEDIFF(DAY,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_days,
		fs.staff_code AS debriefer_code,
		CASE WHEN ps_score_category_code IN (1) THEN '1. Header details' 
               WHEN ps_score_category_code IN (3,4,5,6,7,8,9,10,11,12,13,14) THEN '2. Total score (PS forms 1 to 5)'
			   WHEN ps_score_category_code IN (2,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34) THEN '3. GEN and tag recovery forms'
			   WHEN ps_score_category_code IN (35) THEN '4. Written report score'
			   WHEN ps_score_category_code IN (36) THEN '5. Journal score'
			   WHEN ps_score_category_code IN (37,38) THEN '6. Data presentation / submission'
           ELSE '7. Others' END AS summary_details ,
		SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END) AS response_score,
        SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) AS ps_score,
        ROUND(SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END)*1.0 / CASE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) WHEN 0 THEN 1 ELSE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ps_score END) END  *100.0,1) AS ps_pct

  FROM obsv.debrief d
        INNER JOIN ref.vessel_instances v on d.vessel_id = v.vessel_id and d.dep_date between v.start_date and v.calculated_end_date
        INNER JOIN ref.field_staff f on f.staff_id= d.observer_id
		INNER JOIN ref.field_staff fs on d.debriefer_id = fs.staff_id
        INNER JOIN obsv.debrief_answer a on a.debrief_id=d.debrief_id
        INNER JOIN obsv.debrief_question q on q.debrief_question_id = a.debrief_question_id
        LEFT JOIN ref_static.debrief_categories c on c.id = q.ps_score_category_code

  WHERE YEAR(d.dep_date) = coalesce(:year, YEAR(d.dep_date))
  AND v.flag_id = coalesce(:flag_code,v.flag_id)
  AND d.debriefer_obsprg_code = coalesce(:obsv_prg,d.debriefer_obsprg_code)
  AND d.system_source = 'Tufman2' 
  AND d.gear_code = 'S'
  AND response is not null

GROUP BY d.debriefer_obsprg_code,
		 f.staff_code,
         d.tripno,
		 v.vesselname,
         v.flag_id, 
	 	 d.gear_code,
		 d.dep_date,
		 d.ret_date,
		 d.ret_dtime,
		 d.debrief_start_dtime,
		 d.debrief_end_dtime,
		 fs.staff_code,
		 ps_score_category_code ) x

GROUP BY x.debriefer_obsprg_code,
x.staff_code,
x.tripno,
x.vesselname,
x.flag, 
x.gear_code,
x.depart_date,
x.return_date,
x.trip_days,
x.waiting_debrief_days,
x.debrief_start,
x.debrief_end,
x.debrief_hrs,
x.debrief_days,
x.debriefer_code,
x.summary_details",NA
"243","2d630f85-c373-4fd0-9bde-ac7600c63a81"," LONGLINE Observer Trip -- Catch Summary by species","trip_id","A Summary of catches information from the selected LONGLINE observer trip","Observer",NA,"Observer","19",3416,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2021-12-16T08:51:22.487","DECLARE @sp_code varchar(50)
SET @sp_code = 'YFT'

DECLARE @trip_id varchar(50)
SET @trip_id = '00000000-0000-0000-0000-000000000000'

DECLARE @staff_code varchar(50)
SET @staff_code = 'XXX'

 Select staff_code,tripno,vesselname,dep_date,sp.sp_code,sp.sp_name,sp.sp_name_french,count(*) as catch_n,round(avg(len*1.0),0) as avg_len
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sc.sp_code = sp.sp_code
WHERE LEFT(:trip_id,3)=RTRIM(staff_code) and RIGHT(:trip_id,5)=tripno
group by vesselname,staff_code,tripno,sp.sp_code,dep_date,sp.sp_name,sp.sp_name_french",NA
"244","fb10ee09-11e5-4985-9799-ad1300c2c806"," LONGLINE -- Individual bycatch catch","flag_code, year","YEAR, FLAG, EEZ, SPECIES, FATE and LEN","Observer",NA,"Observer","26",3429,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-23T08:32:07.827"," SELECT	
			YEAR(set_date) as yr,
			vesselname,
            flag_id as flag,
            eez_code as eez, 
            sp.sp_code,
            sp.sp_name as species,
            lc.fate_code as fate_code, 
            f.fate_desc as fate_desc,
			len,
			lec.len_code,
			lec.len_desc,
			lc.comments

 FROM obsv.trip ot 
                  inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
                  inner join  obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
                  inner join  obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
                  inner join  obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
                  inner join ref.species sp on lc.sp_code = sp.sp_code
                  inner join ref_static.fate_codes f on lc.fate_code = f.fate_code
				  left join ref_static.length_codes lec on lec.len_code = lc.len_code
WHERE YEAR(set_date)          = coalesce(:year, YEAR(set_date))
      AND flag_id    = coalesce(:flag_code,flag_id)
	  AND sp_cat_code<>'TUN'",NA
"245","e7a58dc2-993c-44c1-b9e5-acb40114cc98"," LONGLINE Observer Trip -- Catch details","year, trip_id","Details of catches information from the selected LONGLINE observer trip","Observer",NA,"Observer","22",3419,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2025-01-21T16:39:10.55"," Select staff_code,tripno,vesselname,dep_date,set_number,catch_dtime,hook_no,sp.sp_code,sp.sp_name,sp.sp_name_french,cond_code,cond_code2,fate_code,len,sc.len_code,sex_code,sc.comments
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sc.sp_code = sp.sp_code
WHERE coalesce(LEFT(:trip_id,3),RTRIM(staff_code))=RTRIM(staff_code) and coalesce(RIGHT(:trip_id,5),tripno)=tripno
and year(dep_date) = coalesce(:year,year(dep_date))",NA
"246","e3bbffeb-c473-4498-889c-ab58010c6075"," Annual Aggregate Species Composition- Retain and Discards: E-Monitoring only","year","Annual Aggregate Species Composition: E-Monitoring only","",NA,"Observer","9c",3373,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T15:59:42.347"," select sp.sp_name,
		sc.sp_code, 
		sum(case when left(fate_code,1) = 'R' then 0001 else 0000 end) as EM_retain,
		sum(case when left(fate_code,1) = 'R' then 0000 else 0001 end) as EM_discard
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join em.l_set s on et.obstrip_id=s.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=s.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name",NA
"247","e75d60df-34af-44a3-8b28-ab4f00b64af2"," Bycatch and Tuna numbers- EM vs Logsheets","year",NA,"Logsheets",NA,"Observer","4d",3372,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Longline, Emonitoring","2024-10-17T11:22:16.663","IF OBJECT_ID('tempdb.dbo.#bycatch_emlog', 'U') IS NOT NULL
	DROP TABLE #bycatch_emlog;

  select
	(case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end) as category ,
	sum(1) as em_n,
	sum(000000) as log_n,
	sum(case when left(fate_code,1)='R' then 1 else 0 end) as em_ret,
	sum(000000) as log_ret,
	sum(case when left(fate_code,1)='D' then 1 else 0 end) as em_disc,
	sum(000000) as log_disc
into #bycatch_emlog
from em.trip em
inner join ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
	and em.dep_date between lt.depart_date and lt.return_date
inner join em.l_set ls on ls.obstrip_id=em.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where COALESCE(:year,year(em.dep_date)) = year(em.dep_date)
group by case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end
UNION
  select 
	case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end as category,
	sum(000000) as em_n,
	sum(sc.sp_n + coalesce(sc.spdiscard_n,0))as log_n,
	sum(000000) as em_ret,
	sum(sc.sp_n) as log_ret,
	sum(000000) as em_disc,
	sum(coalesce(sc.spdiscard_n,0)) as log_disc

from em.trip em
inner join ref.vessel_instances vi on vi.vessel_id=em.vessel_id
	and em.dep_date between vi.start_date and vi.calculated_end_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
	 and em.dep_date between lt.depart_date and lt.return_date
inner join tufman2_dorado.log.sets_ll ls on lt.log_trip_id=ls.log_trip_id
inner join tufman2_dorado.log.catch_ll sc on sc.log_set_id=ls.log_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where COALESCE(:year,year(em.dep_date)) = year(em.dep_date)
group by case when sc.sp_code='ALB' or sc.sp_code='BET' or sc.sp_code='BFT' or sc.sp_code='SKJ' or sc.sp_code='PBF' or sc.sp_code='TPZ' or sc.sp_code='YFT' then 'TUNA' else 'BYCATCH' end select 
	category,
	sum(em_ret + em_disc) as em_n,
	sum(log_ret + log_disc) as log_n,
	sum(em_ret) as em_ret,
	sum(log_ret) as log_ret,
	sum(em_disc) as em_disc,
	sum(log_disc) as log_disc

from #bycatch_emlog
group by category",NA
"248","df5af495-a27b-4f90-bb50-ab73010c243e"," DEBRIEFING - PS Scores by categories","",NA,"Observer",NA,"Observer","1",3378,"andrewh@spc.int","aurelienp@spc.int","Debriefing, Observer","2023-11-13T13:42:13.663"," select c.category_desc,
	sum(case when response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END) AS response_score,
	sum(case when response IN ('DNE') then 0 else ps_score end) as ps_score,
	ROUND(sum(case when response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ps_score ELSE 0 END)*1.0 / case sum(case when response IN ('DNE') then 0 else ps_score end) WHEN 0 then 1 else sum(case when response IN ('DNE') then 0 else ps_score end) end  *100.0,1) as pct
from obsv.debrief d join obsv.debrief_answer a on a.debrief_id=d.debrief_id
join obsv.debrief_question q on q.debrief_question_id = a.debrief_question_id
left join ref_static.debrief_categories c on c.id = ps_score_category_code
where d.system_source = 'Tufman2' and gear_code='S' and response is not null
group by c.category_desc",NA
"249","6f67bc2d-5742-42db-b59f-ac2100f729be"," LONGLINE -- Individual bird catch","flag_code, year",NA,"Observer",NA,"Observer","88",3407,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline","2022-08-02T14:08:40.077"," SELECT 	'L' as gear, 
		obsprg_code as obsprg_code,
		flag_id as flag, 
		v.vesselname as vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), sc.catch_date, 103) as date, 
		sc.catch_time as time,
		case when sa.latd < -30 then '< 30S' when sa.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code as eez_code, 
		fate_code as fate_code, 
                '-' as interact_code,
                '-' as sighted_code,
		1 as individuals,
		case when LEFT(cond_code2,1)='A' then 1 else 0 end as alive,
		case when cond_code='D' or cond_code2='D' then 1 else 0 end as dead,
		case when coalesce(cond_code,'X')!='D' and left(coalesce(cond_code2,'X'),1) not in ('D','A') then 1 else 0 end as Unknown,
		NULL as sighted,
		sc.comments as comments,
		case when sd.tori_poles_yn = 1 then 'Y' else 'N' end as tori_poles_used,
		case when sd.bird_curtain_yn = 1 then 'Y' else 'N' end as bird_curtain_used,
		case when sd.bait1_dyed_ans = 1  or sd.bait2_dyed_ans = 1 or sd.bait3_dyed_ans = 1 or sd.bait4_dyed_ans = 1 or sd.bait5_dyed_ans = 1 then 'Y' else 'N' end as bait_dyed_used,
		case when sd.weighted_lines_yn = 1  then 'Y' else 'N' end as weighted_lines_used,
		case when sd.underwater_chute_yn = 1  then 'Y' else 'N' end as underwater_chute_used,
		case when sd.offal_discharged_yn = 1  then 'Y' else 'N' end as offal_discharged,
		case when sd.num_tori_lines > 0  then 'Y' else 'N' end as tori_lines_used,
		case when sd.offal_opposite_yn = 1  then 'Y' else 'N' end as offal_opposite_used
FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83 
				inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'

UNION ALL

SELECT 	t.gear_code as gear, 
		obsprg_code as obsprg_code,
		flag_id as flag, 
		v.vesselname as vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), g2.sighting_date, 103) as date, 
		'-' as time,
		case when g2.latd < -30 then '< 30S' when g2.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code as eez_code, 
		'-' as fate_code, 
                '-' as interact_code,
                coalesce(sighting_code,'OTH') as sighted_code,
		total_n as individuals,
		NULL as alive,
		NULL as dead,
		NULL as unknown,
		total_n as sighted,
		g2.behaviour_desc as comments,
		NULL as tori_poles_used,
		NULL as bird_curtain_used,
		NULL as bait_dyed_used,
		NULL as weighted_lines_used,
		NULL as underwater_chute_used,
		NULL as offal_discharged,
		NULL as tori_lines_used,
		NULL as offal_opposite_used

 FROM	obsv.gen2sightings g2
	join obsv.trip t on t.obstrip_id = g2.obstrip_id
	join ref.species sp on sp.sp_code = g2.sp_code
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
WHERE YEAR(g2.sighting_date) = coalesce(:year,year(g2.sighting_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'
	AND t.gear_code = 'L'

UNION ALL

SELECT 	t.gear_code as gear, 
		obsprg_code as obsprg_code,
		flag_id as flag, 
		v.vesselname as vesselname,
		sp.sp_name as species,
		CONVERT(VARCHAR(10), g2.interact_date, 103) as date, 
		'-' as time,
		case when g2.latd < -30 then '< 30S' when g2.latd > 23 then '> 23N' else '< 23N > 30S' end as lat, 
		eez_code as eez_code, 
		'-' as fate_code, 
                coalesce(interact_code,'OTH') as interact_code,
                '-' as sighted_code,
		 coalesce(g2.adults_n,0) + coalesce(g2.juveniles_n,0) as individuals,
		case when LEFT(condition_code_end,1)='A' then coalesce(g2.adults_n,0) + coalesce(g2.juveniles_n,0) else 0 end as alive,
		case when condition_code_start='D' or condition_code_end='D' then coalesce(g2.adults_n,0) + coalesce(g2.juveniles_n,0) else 0 end as dead,
		case when coalesce(condition_code_start,'X')!='D' and left(coalesce(condition_code_end,'X'),1) not in ('D','A') then coalesce(g2.adults_n,0) + coalesce(g2.juveniles_n,0) else 0 end as Unknown,
		NULL as sighted,
		g2.interact_desc as comments,
		NULL as tori_poles_used,
		NULL as bird_curtain_used,
		NULL as bait_dyed_used,
		NULL as weighted_lines_used,
		NULL as underwater_chute_used,
		NULL as offal_discharged,
		NULL as tori_lines_used,
		NULL as offal_opposite_used
 FROM	obsv.gen2interactions g2
	join obsv.trip t on t.obstrip_id = g2.obstrip_id
	join ref.species sp on sp.sp_code = g2.sp_code
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
WHERE YEAR(g2.interact_date) = coalesce(:year,year(g2.interact_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'BRD'
	AND t.gear_code = 'L'",NA
"250","21b0fb52-3c6a-459d-9414-abbb00efeff5"," Longline - Observer reports for IATTC (LOA >= 20m) - Annex A - Non-Retained Species","min_year","Longline - Observer reports for IATTC - Only includes vessels with length >= 20m; Shallow Set : hks between float < 15 and Deep set : hks between float >=15","Observer",NA,"Observer","24",3384,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Custom","2024-04-30T08:30:32.297"," select year(dep_date) as year,sp_cat_code,sc.sp_code,
SUM(case when LEFT(cond_code2,1) = 'A' then 1 else 0 end) as Tot_Alive,
SUM(case when LEFT(cond_code2,1) = 'D' then 1 else 0 end) as Tot_Dead,
SUM(case when LEFT(coalesce(cond_code2,'U'),1) NOT in ('A','D') then 1 else 0 end) as Tot_Unknown,

SUM(case when LEFT(cond_code2,1) = 'A' and hk_bt_flt <= 15 then 1 else 0 end) as ShadowSet_Alive,
SUM(case when LEFT(cond_code2,1) = 'D' and hk_bt_flt <= 15 then 1 else 0 end) as ShadowSet_Dead,
SUM(case when LEFT(coalesce(cond_code2,'U'),1) NOT in ('A','D') and hk_bt_flt <= 15 then 1 else 0 end) as ShadowSet_Unknown,

SUM(case when LEFT(cond_code2,1) = 'A' and hk_bt_flt > 15 then 1 else 0 end) as DeepSet_Alive,
SUM(case when LEFT(cond_code2,1) = 'D' and hk_bt_flt > 15 then 1 else 0 end) as DeepSet_Dead,
SUM(case when LEFT(coalesce(cond_code2,'U'),1) NOT in ('A','D') and hk_bt_flt > 15 then 1 else 0 end) as DeepSet_Unknown
FROM obsv.trip t    
join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
join ref.vessels ve on ve.vessel_id = v.vessel_id
join obsv.l_set s on t.obstrip_id = s.obstrip_id
join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83
join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
left join ref.species sp on sp.sp_code = sc.sp_code
WHERE year(dep_date) >= coalesce(:min_year,year(dep_date))
and latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L'
and ve.loa >=20 
and sp_cat_code not in ('TUN')
and left(fate_code,1) = 'D'
group by year(dep_date),sp_cat_code,sc.sp_code",NA
"251","4f0c26bd-e37a-4a50-9f90-abcf00f11bee"," IATTC Area -- TASK I -- LONGLINE Data (Other Species - Table 2)","year","Report produced on request for Vanuatu. IATTC Area -- TASK I -- LONGLINE Data (by year or month) - NOTE THAT THIS IS LOGSHEET REPORTED AND UNRAISED","Logsheets",NA,NA,"31b",3390,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-25T10:52:25.133"," SELECT		:group_by,
            COUNT(distinct t.vessel_id) as vessels,
			count(distinct s.log_set_id) as days,
            cast(Sum(case when sp_code = 'BSH' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS bsh_mt,
			cast(Sum(case when sp_code = 'BSH' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS bsh_disc_mt, 
            cast(Sum(case when sp_code = 'LMD' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lmd_mt,
			cast(Sum(case when sp_code = 'LMD' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lmd_disc_mt,
            cast(Sum(case when sp_code = 'BTH' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS bth_mt,
			cast(Sum(case when sp_code = 'BTH' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS bth_disc_mt, 
            cast(Sum(case when sp_code = 'PTH' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS pth_mt,
			cast(Sum(case when sp_code = 'PTH' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS pth_disc_mt, 
            cast(Sum(case when sp_code = 'THR' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS thr_mt,
			cast(Sum(case when sp_code = 'THR' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS thr_disc_mt, 
            cast(Sum(case when sp_code = 'CCL' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ccl_mt,
			cast(Sum(case when sp_code = 'CCL' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ccl_disc_mt, 
            cast(Sum(case when sp_code = 'OCS' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ocs_mt,
			cast(Sum(case when sp_code = 'OCS' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ocs_disc_mt, 
            cast(Sum(case when sp_code = 'FAL' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS fal_mt,
			cast(Sum(case when sp_code = 'FAL' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS fal_disc_mt,
			cast(Sum(case when sp_code = 'SMA' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS sma_mt,
			cast(Sum(case when sp_code = 'SMA' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS sma_disc_mt,
			cast(Sum(case when sp_code = 'LMA' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lma_mt,
			cast(Sum(case when sp_code = 'LMA' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lma_disc_mt,
            cast(Sum(case when sp_code = 'MAK' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS mak_mt,
			cast(Sum(case when sp_code = 'MAK' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS mak_disc_mt,
			cast(Sum(case when sp_code = 'SSN' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ssn_mt,
			cast(Sum(case when sp_code = 'SSN' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS ssn_disc_mt, 
            cast(Sum(case when sp_code = 'SPL' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spl_mt,
			cast(Sum(case when sp_code = 'SPL' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spl_disc_mt,
            cast(Sum(case when sp_code = 'SPE' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spe_mt,
			cast(Sum(case when sp_code = 'SPE' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spe_disc_mt, 
            cast(Sum(case when sp_code = 'SPK' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spk_mt,
			cast(Sum(case when sp_code = 'SPK' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spk_disc_mt, 
            cast(Sum(case when sp_code = 'SPJ' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spj_mt,
			cast(Sum(case when sp_code = 'SPJ' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spj_disc_mt, 
            cast(Sum(case when sp_code = 'SPZ' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spz_mt,
			cast(Sum(case when sp_code = 'SPZ' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spz_disc_mt, 
            cast(Sum(case when sp_code = 'SPY' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spy_mt,
			cast(Sum(case when sp_code = 'SPY' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS spy_disc_mt, 
            cast(Sum(case when sp_code = 'SHK' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS shk_mt,
			cast(Sum(case when sp_code = 'SHK' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS shk_disc_mt,
			cast(Sum(case when sp_code = 'WAH' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS wah_mt,
			cast(Sum(case when sp_code = 'WAH' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS wah_disc_mt,
			cast(Sum(case when sp_code = 'DOL' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS dol_mt,
			cast(Sum(case when sp_code = 'DOL' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS dol_disc_mt,
			cast(Sum(case when sp_code = 'LAG' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lag_mt,
			cast(Sum(case when sp_code = 'LAG' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lag_disc_mt,
			cast(Sum(case when sp_code = 'TST' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS tst_mt,
			cast(Sum(case when sp_code = 'TST' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS tst_disc_mt,
			cast(Sum(case when sp_code = 'LEC' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lec_mt,
			cast(Sum(case when sp_code = 'LEC' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS lec_disc_mt,
			cast(Sum(case when sp_code = 'OIL' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS oil_mt,
			cast(Sum(case when sp_code = 'OIL' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS oil_disc_mt,
			cast(Sum(case when sp_code = 'OTH' AND c.spdiscard_n IS NULL then sp_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS oth_mt,
			cast(Sum(case when sp_code = 'OTH' AND c.spdiscard_n > 0 then spdiscard_kg_est else 000.0 end) / 1000 as decimal(8,2))  AS oth_disc_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
       AND lond > -150 and lond <= -70
		and l_activity_id = 1
group by :group_by","Year"
"252","3cc1239d-cd77-4b9d-8aee-abe400c4fd98"," IATTC Area -- TASK II -- LONGLINE Catch and effort (5x5) CATCH WEIGHTS","year","Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (5x5 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32e",3396,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-24T14:01:50.757","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
        floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,
         floor(ref.GetLonDfromLon(lon)/5)*5+2.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
            floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips,
			COUNT(distinct s.log_set_id) as sets,
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then sp_kg_est else 0 end)                                      as decimal(9,2))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                        floor(ref.GetLatDfromLat(lat)/5)*5+2.5 = cte.latitude
                        and floor(ref.GetLonDfromLon(lon)/5)*5+2.5 = cte.longitude
                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  and s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonDfromLon(lon)/5)*5+2.5, FORMAT(logdate, 'yyyy-MM')",NA
"253","f79a86f8-df4c-4476-9996-aadb0114a2e5","National FLEET Total catch by FAO Area (INDIAN OCEAN)","year",NA,"Logsheets",NA,NA,"7c",3333,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Custom, RegionalReporting","2021-11-22T10:44:59.453"," select	c.sp_code,fao.area_id FAO_Area,SUM(COALESCE(c.sp_kg_est,0)) catch_kg
from	log.trips_ll t INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id=s.log_trip_id
		INNER JOIN log.catch_ll c ON s.log_set_id=c.log_set_id
		INNER JOIN ref.fao_definitions fao WITH (INDEX(spix_fao_definitions_area_def)) ON area_def.STIntersects(tufman2.GetPointFromLatLon(s.latd, s.lond)) = 1
where	YEAR(logdate)=:year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and ((ref.GetLonDfromLon(s.lon) >= 20 and ref.GetLonDfromLon(s.lon) < 145 and ref.GetLatDfromLat(s.lat) <= -8) 
  or 
	 (ref.GetLonDfromLon(s.lon) >= 20 and ref.GetLonDfromLon(s.lon) < 105 and ref.GetLatDfromLat(s.lat) > -8))
group by c.sp_code,fao.area_id",NA
"254","dc6c5085-75eb-4028-9a87-ac1b00fb08d9"," PS OBS - FIA MSC documents for Assessment","eez_code, flag_code, min_year, max_year","Purse seine catch statistics from observer data broken down by Species and Species Group with selection by YEAR, FLAG and EEZ for FIA MSC documents for Assessment","Observer",NA,"Observer","103",3405,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2025-07-04T15:46:39.17"," SELECT  
               year(dep_date) as year, 
               vi.vesselname as vessel_name,
               vi.flag_id as flag,
                vi.ircs as ircs ,
                ot.obstrip_id as trip_code,
		'PS' as gear,
		ot.dep_date as depart_date,
		act_date as set_date,
		act_time as set_time,
               case when coalesce(sa.schas_id,20) in (21,22) then 'UNASSOC' else 'ASSOC' end as set_type, 
		case when coalesce(schas_id,20)-20 in (1) then '1. UNASSOCIATED' 
		     when coalesce(schas_id,20)-20 in (2) then '2. FEEDING ON BAITFISH' 
			 when coalesce(schas_id,20)-20 in (3) then '3. LOG' 
			 when coalesce(schas_id,20)-20 in (4) then '4. DRIFTING FAD' 
			 when coalesce(schas_id,20)-20 in (5) then '5. ANCHORED FAD' 
			 when coalesce(schas_id,20)-20 in (6) then '6. WHALE' 
			 when coalesce(schas_id,20)-20 in (7) then '7. WHALE SHARK' 
		else	
			'OTHER'
		end as set_code, 
ssi_observed_time,
		latd,
		lond,
		eez_code,
		case when in_AWs = 1 then 'AW' else 'EEZ' end as area,
		sp.sp_code as sp_code,
		sp.sp_name as common_name,
		sp.sp_sci_name as sci_name,
		sc.fate_code as fate_code,
               case when sp.sp_cat_code in ('SHK','MAM','TTX','BRD') then discard_cond_code else '--' end as life_status,
		case when left(fate_code,1) = 'R' then coalesce(obs_mt,0) else 0000.000 end as obsv_retain_MT,
		case when left(fate_code,1) = 'R' then coalesce(obs_n,0) else 0000.000 end as obsv_retain_NO,
		case when left(fate_code,1) = 'D' then coalesce(obs_mt,0) else 0000.000 end as obsv_disc_MT,
		case when left(fate_code,1) = 'D' then coalesce(obs_n,0) else 0000.000 end as obsv_disc_NO

FROM    obsv.trip ot 
        inner join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id and ot.dep_date between vi.start_date and vi.calculated_end_date
	    inner join ref.field_staff f on f.staff_id=ot.observer_id
        inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
        inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
        inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
        inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
        inner join ref.species sp on sc.sp_code = sp.sp_code

WHERE YEAR(ot.dep_date) >= coalesce(:min_year,year(ot.dep_date)) and YEAR(ot.dep_date) <= coalesce(:max_year,year(ot.dep_date))
AND sa.s_activ_id IN (1,2) 
AND flag_id = coalesce(:flag_code,flag_id)
AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))",NA
"255","71d5e865-5bb0-4f5d-a864-acbf00fd6723"," DEBRIEFING - LL Score Summary by Year and Flag","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","3",3422,"andrewh@spc.int","colleyf@spc.int","Debriefing, Observer","2024-11-25T09:54:47.647"," SELECT 
        d.debriefer_obsprg_code AS debriefer_obsprg_code,
		f.staff_code AS staff_code,
        d.tripno AS tripno,
		v.vesselname AS vesselname,
        v.flag_id AS flag, 
		d.gear_code AS gear_code,
		CONVERT(VARCHAR, d.dep_date, 106) AS depart_date,
        CONVERT(VARCHAR, d.ret_date, 106) AS return_date,
		DATEDIFF(D,d.dep_date, d.ret_date)+1 AS trip_days,
		DATEDIFF(DAY,d.ret_dtime,d.debrief_start_dtime) AS waiting_debrief_days,
		CONVERT(VARCHAR, d.debrief_start_dtime, 113) AS debrief_start,
        CONVERT(VARCHAR, d.debrief_end_dtime, 113) AS debrief_end,
		DATEDIFF(HOUR,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_hrs,
		DATEDIFF(DAY,d.debrief_start_dtime,d.debrief_end_dtime) AS debrief_days,
		fs.staff_code AS debriefer_code,
		SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ll_score ELSE 0 END) AS response_score,
        SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) AS ll_score,
        ROUND(SUM(CASE WHEN response IN ('CC','Y','EXCELLENT','VERY GOOD','GOOD') THEN ll_score ELSE 0 END)*1.0 / CASE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) WHEN 0 THEN 1 ELSE SUM(CASE WHEN response IN ('DNE') THEN 0 ELSE ll_score END) END  *100.0,1) AS ll_pct

  FROM obsv.debrief d
        INNER JOIN ref.vessel_instances v on d.vessel_id = v.vessel_id and d.dep_date between v.start_date and v.calculated_end_date
        INNER JOIN ref.field_staff f on f.staff_id= d.observer_id
		INNER JOIN ref.field_staff fs on d.debriefer_id = fs.staff_id
        INNER JOIN obsv.debrief_answer a on a.debrief_id=d.debrief_id
        INNER JOIN obsv.debrief_question q on q.debrief_question_id = a.debrief_question_id
        LEFT JOIN ref_static.debrief_categories c on c.id = ps_score_category_code

  WHERE YEAR(d.dep_date) = coalesce(:year, YEAR(d.dep_date))
  AND v.flag_id = coalesce(:flag_code,v.flag_id)
  AND d.debriefer_obsprg_code = coalesce(:obsv_prg,d.debriefer_obsprg_code)
  AND d.system_source = 'Tufman2' 
  AND d.gear_code = 'L'
  AND response is not null

GROUP BY d.debriefer_obsprg_code,
		 f.staff_code,
         d.tripno,
		 v.vesselname,
         v.flag_id, 
	 	 d.gear_code,
		 d.dep_date,
		 d.ret_date,
		 d.ret_dtime,
		 d.debrief_start_dtime,
		 d.debrief_end_dtime,
		 fs.staff_code",NA
"256","f444a715-c6b1-43ae-90a8-ab0a00a4666c"," Vessel Catch by Trip by Sets for main target species (cpue kg/hk/hr)","min_year, max_year",NA,"Logsheets",NA,NA,"2a",3348,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ, Raised","2023-10-12T13:58:46.75"," Select
	v.vesselname vessel_name,
	t.trip_no,
	convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103)  as departure_date,
	convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103)  as return_date,
	COUNT(distinct cast(t.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
	convert(nvarchar(10),s.logdate, 103) as set_date,
	
	ref.getLatDfromLat(s.lat) as latitude, 
	ref.getLonDfromLon(s.lon) as longitude, 
	s.hooks_n, 
	s.hours_n, 


		cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))												AS pfm_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0 else cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS pfm_cpue, 
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))												AS pfm_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'PFM' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS pfm_npue,
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lwf_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_cpue, 
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))												AS lwf_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LWF' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS lwf_npue, 
	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS etc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS etc_cpue, 
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))												AS etc_n, 
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETC' then sp_n else 000.0 end)  /hooks_n / hours_n as decimal(6,2)) end			AS etc_npue, 
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eta_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS eta_cpue, 
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))												AS eta_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ETA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eta_npue, 
	 
	cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) 					as decimal(5,0))												AS eep_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS eep_cpue, 
	cast(Sum(case sp_code when 'EEP' then sp_n else 0 end)							as decimal(7,0))												AS eep_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EEP' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS eep_npue, 

	cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ewo_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_kg else 000.0 end) / hooks_n/ hours_n  as decimal(6,2)) end			AS ewo_cpue, 
	cast(Sum(case sp_code when 'EWO' then sp_n else 0 end)							as decimal(7,0))												AS ewo_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'EWO' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS ewo_npue, 

	cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhi_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhi_cpue, 
	cast(Sum(case sp_code when 'LHI' then sp_n else 0 end)							as decimal(7,0))												AS lhi_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHI' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhi_npue, 

	cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lhb_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_kg else 000.0 end) / hooks_n / hours_n as decimal(6,2)) end			AS lhb_cpue, 
	cast(Sum(case sp_code when 'LHB' then sp_n else 0 end)							as decimal(7,0))												AS lhb_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LHB' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lhb_npue, 


	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))												AS arq_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_cpue, 
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))												AS arq_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'ARQ' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS arq_npue, 
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))												AS lrk_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_cpue, 
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))												AS lrk_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'LRK' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS lrk_npue,
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))												AS bwa_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) / hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_cpue, 
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))												AS bwa_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'BWA' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS bwa_npue,
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))												AS ytc_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_cpue, 
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))												AS ytc_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'YTC' then sp_n else 000.0 end)  /hooks_n		/ hours_n	as decimal(6,2)) end	AS ytc_npue,
	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))												AS sey_kg,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) / hooks_n		/ hours_n	as decimal(6,2)) end	AS sey_cpue, 
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))												AS sey_n,
	case when hooks_n = 0 then 0 when hours_n = 0 then 0  else cast(Sum(case sp_code when 'SEY' then sp_n else 000.0 end)  /hooks_n	/ hours_n		as decimal(6,2)) end	AS sey_npue,

	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0 
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0			
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'PFM' then 0 when 'LWF' then 0 when 'ETC' then 0 when 'ETA' then 0 when 'EEP' then 0
						when 'EWO' then 0 when 'LHI' then 0 when 'LHB' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0
						 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n,
	ref.GetEntityFromBit(t.instance_source) as country
	

from log.trips_ds t
	inner join log.sets_ds S on t.log_trip_id = S.log_trip_id
	inner join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date


  
 WHERE year(logdate) >= coalesce(:min_year, year(logdate)) 
  and year(logdate) <= coalesce(:max_year, year(logdate))  
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))

Group by v.vesselname, 
		t.trip_no,
		convert(nvarchar(10),case when t.depart_date is null then s.logdate else depart_date end, 103),
		convert(nvarchar(10),case when t.return_date is null then s.logdate else return_date end, 103), 
		s.logdate,
		ref.getLatDfromLat(s.lat), 
		ref.getLonDfromLon(s.lon), 
		s.eez_code,
		s.hooks_n, 
		s.hours_n,
		ref.GetEntityFromBit(t.instance_source)",NA
"257","c0fe0cac-b303-4de6-9fda-a97d0097b7f6"," LONGLINE -- HOOK TYPE Usage by Month and Area","year",NA,"",NA,"Observer","81",3283,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-03-31T06:57:45.987"," SELECT year(dep_date) as yr, 
		month(dep_date) as mon,
		round(x.min_lat,1) as min_lat,
		round(x.max_lat,1) as max_lat,
		round(x.min_lon,1) as min_lon,
		round(x.max_lon,1) as max_lon,
		[hksjapan_size]
      ,[hksjapan_perc]
      ,[hkscircle_size]
      ,[hkscircle_perc]
      ,[hksj_size]
      ,[hksj_perc]
      ,[hksoth_type]
      ,[hksoth_size]
      ,[hksoth_perc]
      ,[hks_comments]
FROM [obsv].[trip] ot inner join [obsv].[l_gear] g on ot.obstrip_id = g.obstrip_id 
	INNER JOIN
	(select obstrip_id,
			MIN(latd) as min_lat, 
			MAX(latd) as max_lat, 
			MIN(lond) as min_lon, 
			MAX(lond) as max_lon
	from[obsv].[l_set] ls inner join [obsv].[l_sethaullog] lsh on ls.l_set_id = lsh.l_set_id
	where YEAR(set_date) = coalesce(:year,YEAR(set_date))
	group by obstrip_id) x on x.obstrip_id = ot.obstrip_id
where YEAR(dep_date) = coalesce(:year,YEAR(dep_date))",NA
"258","19cf9c7c-be66-4236-b786-a9a5009f876c"," List of EM trips with corresponding Logbook and Unloading","year",NA,"Port",NA,"Observer","6a",3289,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Unloading, Longline, Emonitoring","2024-10-17T11:22:08.98"," SELECT DISTINCT vi.vesselname AS VESSELNAME
	,et.obsprg_code AS PROG_CODE
	,st.staff_code AS STAFF_CODE
	,et.tripno AS TRIPNO
	,CONVERT(CHAR(10), et.dep_date, 103) AS EM_DEP_DATE
	,CONVERT(CHAR(10), et.ret_date, 103) AS EM_RET_DATE
	,CONVERT(CHAR(10), lt.depart_date, 103) AS LOG_DEP_DATE
	,CONVERT(CHAR(10), lt.return_date, 103) AS LOG_RET_DATE
	,CONVERT(CHAR(10), ut.unload_startdate, 103) AS UNLOAD_START_DATE
	,CONVERT(CHAR(10), ut.unload_enddate, 103) AS UNLOAD_END_DATE
FROM em.trip AS et
INNER JOIN ref.vessel_instances AS vi ON vi.vessel_id=et.vessel_id
	AND et.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN tufman2_dorado.[log].trips_ll AS lt ON lt.vessel_id = et.vessel_id
	AND et.dep_date BETWEEN lt.depart_date - 2 AND lt.depart_date + 2
INNER JOIN tufman2_dorado.unload2.unloadings AS ut ON ut.vessel_id = et.vessel_id
	AND ut.unload_startdate BETWEEN et.ret_date	AND et.ret_date + 3
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE coalesce(:year,year(et.dep_date))=year(et.dep_date)",NA
"259","81ed9193-4bf6-4130-b02f-a9f2009ace1d"," Annual Aggregate Species Composition: EMonitoring vs Observer vs Logbook","year",NA,"Logsheets,Observer",1,"Observer","5d",3297,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Longline, Emonitoring","2024-10-17T11:22:02.92"," select COALESCE(x.sp_name,y.sp_name,z.sp_name) COLLATE DATABASE_DEFAULT as sp_name,COALESCE(x.sp_code,y.sp_code,z.sp_code) COLLATE DATABASE_DEFAULT  as sp_code, x.EM_count,y.OB_count,z.LOG_count from (
select sp.sp_name,sc.sp_code, count(sc.sp_code) as EM_count
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=et.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=et.vessel_id
	and et.dep_date between lt.depart_date and lt.return_date
inner join em.l_set s on et.obstrip_id=s.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=s.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
inner join ref.countries rc on rc.country_code=vi.flag_id COLLATE DATABASE_DEFAULT
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name
) x
FULL OUTER JOIN (
select sp.sp_name,sc.sp_code, count(sc.sp_code) as OB_count
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=et.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=et.vessel_id
	and et.dep_date between lt.depart_date and lt.return_date
inner join obsv.l_set s on s.obstrip_id=ot.obstrip_id
inner join obsv.l_setcatch sc on sc.l_set_id=s.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name
) y on y.sp_code=x.sp_code COLLATE DATABASE_DEFAULT
FULL OUTER JOIN (
select sp.sp_name,sc.sp_code, sum(coalesce(sc.spdiscard_n + sc.sp_n,sc.sp_n + 0)) as LOG_count
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=et.vessel_id
	and et.dep_date between lt.depart_date and lt.return_date
inner join tufman2_dorado.log.sets_ll s on s.log_trip_id=lt.log_trip_id
inner join tufman2_dorado.log.catch_ll sc on sc.log_set_id=s.log_set_id
inner join tufman2_dorado.ref.species sp on sp.sp_code=sc.sp_code
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name
) z on z.sp_code=y.sp_code",NA
"260","7f7d40ba-181e-4ae1-839d-ad260110ffa8"," LONGLINE -- FADs info from comments","",NA,"Observer",NA,"Observer","89",3430,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2024-02-13T08:19:50.327"," Select obsprg_code,dep_date,staff_code,tripno,vesselname,set_dtime,latd,lond,sh.comments
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
join obsv.l_sethaullog sl on sl.l_set_id = s.l_set_id and sl.stend_id=83
Join obsv.l_sethaulnotes sh on sh.l_set_id = s.l_set_id
where sh.comments like '%DCP%'",NA
"261","de134e99-40d4-4fb7-a139-a7c800f04167"," Species compostion for a paired trip: E-Monitoring vs Logbook","trip_id","Species compostion for a paired trip: E-Monitoring vs Logbook. 
NOTE: You will need to enter the EM_STAFF_CODE together with the TRIPNO as the Observer Trip Id without any space character between them in the box provided below eg 'xxx17-01'","Logsheets",1,"Observer","4b",3208,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Longline, Emonitoring","2025-03-12T08:48:10.727","IF OBJECT_ID('tempdb.dbo.#temp_EMLOG_1', 'U') IS NOT NULL
	DROP TABLE #temp_EMLOG_1;

SELECT  sp.sp_name collate database_default as sp_name,
		lc.sp_code collate database_default as sp_code,
		sum(0001) as em_reported,
		SUM(0000) as log_reported
into #temp_EMLOG_1
FROM    em.trip et 
		inner join ref.vessel_instances v on et.vessel_id = v.vessel_id 
			and et.dep_date between v.start_date and v.calculated_end_date
		inner join    em.l_set ls on et.obstrip_id = ls.obstrip_id 
		inner join    em.l_setcatch lc on ls.l_set_id = lc.l_set_id
		inner join ref.species sp on lc.sp_code = sp.sp_code
		inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE  COALESCE(:trip_id,RTRIM(st.staff_code)+et.tripno) = RTRIM(st.staff_code)+et.tripno
group by obstrip_key,sp.sp_name,lc.sp_code
UNION 
SELECT  sp.sp_name collate database_default as sp_name, 
		sp.sp_code collate database_default as sp_code,
		SUM(0000) as em_reported,
        sum(coalesce(sp_n,0000)) as log_reported
FROM   tufman2_dorado.log.trips_ll l 
		INNER join tufman2_dorado.ref.vessel_instances vi    ON vi.vessel_id = l.vessel_id 
														AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
		INNER join em.trip et ON vi.vessel_id=et.vessel_id
									and et.dep_date between l.depart_date and l.return_date
		INNER JOIN tufman2_dorado.log.sets_lL s    ON l.log_trip_id = s.log_trip_id
		INNER JOIN tufman2_dorado.log.catch_ll c   ON c.log_set_id = s.log_set_id
		INNER JOIN tufman2_dorado.ref.species sp on c.sp_code = sp.sp_code
		inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:trip_id,RTRIM(st.staff_code)+et.tripno) = RTRIM(st.staff_code)+et.tripno 
group by sp.sp_name,sp.sp_code; select 
	sp_name, 
	sp_code,
	sum(em_reported) as em_reported,
	sum(log_reported) as log_reported
from #temp_EMLOG_1
group by sp_name, sp_code",NA
"262","27150595-0b6e-4356-be3f-ab21008f1735"," ARTISANAL - DUMP of All logsheet data including creel","","Full valid logsheet data","Artisanal",NA,NA,"6.4",3360,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2021-09-29T17:06:47.543"," SELECT	landing_site_name,      
		skipper_name, 
		CONVERT(VARCHAR(20),trip_date,23) trip_date,
		ref.GetTranslation('ArtisanalTripNatureCodes',t.trip_nature_code,'EN') trip_nature,
		ref.GetTranslation('ArtisanalCatchAssessmentCodes',t.catch_assessment_code,'EN') catch_assessment,
		tr.value_en fish_method_name,
		art_area_name,
		f.fad_name, 
		hours_fished_n, 
		lines_n, 
		fuel_used_n, 
		fuel_type_id,   
		hooks_per_line_n, 
		hooks_n, 
		live_bait_used, 
		c.sp_code, 
		c.sp_n, 
		c.sp_kg,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.SpeciesComment') species_comment,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.EndUseCommunityMarket') end_use_community_market,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.EndUseProvincialMarket') end_use_provincial_market,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.EndUseUrbanMarket') end_use_urban_market,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.EndUseEaten') end_use_eaten,
		JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.EndUseGivenAway') end_use_given_away
FROM	art2.trips  t          
		JOIN art2.landing_sites ls ON t.landing_site_id = ls.landing_site_id        
		JOIN art2.effort e ON t.art_trip_id = e.art_trip_id               
		JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalFishingMethods'+CONVERT(VARCHAR,e.fish_method_id)      
		LEFT JOIN art2.areas a ON a.art_area_id = e.art_area_id
		LEFT JOIN art2.fad_register f ON e.fad_register_id = f.fad_register_id
		LEFT JOIN art2.catch c ON e.art_effort_id = c.art_effort_id",NA
"263","a5c86b88-0c99-48da-9de0-a82600f70f84"," LONGLINE - Species Catch comparison between ER & Logsheet - DRAFT","","Species compostion comparison between ER data (imported) and Logsheet longline data (entered) in TUFMAN2","Logsheets",1,NA,"4",3226,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Ereporting, AllSpecies","2022-04-13T12:11:39.173","SELECT  sp.sp_name collate database_default as sp_name, 
		sp.sp_code collate database_default as sp_code,
		SUM(0000) as em_reported,
    sum(case when t.system_source='tufman2' then coalesce(sp_n,0000) else 0 end) as T2_reported,
    sum(case when t.system_source='onboard' then coalesce(sp_n,0000) else 0 end) as ER_reported
INTO #t1
FROM   tufman2.log.trips_ll t 
		INNER JOIN tufman2.log.sets_ll s    ON t.log_trip_id = s.log_trip_id
		INNER JOIN tufman2.log.catch_ll c   ON c.log_set_id = s.log_set_id
		INNER JOIN tufman2.ref.species sp on c.sp_code = sp.sp_code 
WHERE year(first_logdate)=2017
group by sp.sp_name,sp.sp_code

 select 
	sp_name, 
	sp_code,
	sum(T2_reported) as T2_nb,
	sum(ER_reported) as ER_nb
from #t1
group by sp_name, sp_code",NA
"264","2f387a3b-7e60-4f22-83bb-aa480122962d"," IATTC Area -- North Pacific ALB catch and effort reporting","year","Requested by Vanuatu for:
The CPC reported to the Director by December 1, 2018, using the template in Annex B, its annual fishing effort for fisheries targeting North Pacific albacore from 2013 through 2017, as well as the average effort for the period 2002-2004 reporting that fishing effort shall be reported in fishing days and number of vessels fishing for  (i.e., targeting) North Pacific
albacore.","Logsheets",NA,NA,"33",3309,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-30T09:42:47.49"," SELECT		Year(logdate) as year,
			right(s.lat, 1) as hemi,
            COUNT(distinct t.vessel_id) as vessels,
			count(distinct s.log_set_id) as days,
            cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS alb_mt, 
            cast(Sum(case sp_code when 'BET' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS bet_mt, 
            cast(Sum(case sp_code when 'YFT' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS yft_mt, 
            cast(Sum(case sp_code when 'SKJ' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS skj_mt, 
            cast(Sum(case sp_code when 'PBF' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS pbf_mt, 
            cast(Sum(case sp_code when 'BUM' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS bum_mt, 
            cast(Sum(case sp_code when 'BLM' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS blm_mt, 
            cast(Sum(case sp_code when 'MLS' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS mls_mt, 
            cast(Sum(case sp_code when 'SWO' then sp_kg_est else 000.0 end) / 1000                         as decimal(8,2))  AS swo_mt 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                     join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (vi.flag_id = @@entity OR @@entity = 'HIVE')
                    left join log.catch_ll c on s.log_set_id = c.log_set_id 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		AND right(s.lat, 1) in ('N','S','n','s')
group by Year(logdate), right(s.lat, 1)",NA
"265","5ba09c7e-e023-48f7-80c6-a88d00bba0b6"," LONGLINE - Logsheet / Unloadings reconciliation - Summary statistics","flag_code, year",NA,"Logsheets",NA,NA,"5.2.1",3234,"andrewh@spc.int","brunod@spc.int","Logsheet, Unloading, Longline, CoverageMissingData, Tuna","2021-10-27T10:51:33.473","SELECT      
			vi.vesselname, 
			vi.flag_id, 
			CONVERT(nvarchar,t.depart_date,111) depart_date,dp.port_name dp,
			CONVERT(nvarchar,t.return_date,111) return_date,rp.port_name rp,
			max(case when z.sp_code = 'ALB' then z.sp_n else 00000 end) 
				+ max(case when z.sp_code = 'BET' then z.sp_n else 00000 end)
				+ max(case when z.sp_code = 'YFT' then z.sp_n else 00000 end) as t_log_n,
			max(case when y.sp_code = 'ALB' then coalesce(y.port_n,0000) else 00000 end)
				+ max(case when y.sp_code = 'BET' then coalesce(y.port_n,0000) else 00000 end)
				+ max(case when y.sp_code = 'YFT' then coalesce(y.port_n,0000) else 00000 end) as t_port_n,
			max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end)
				+ max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) 
				+ max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) as t_unl_n,
			max(case when z.sp_code = 'ALB' then z.sp_n else 00000 end) as a_log_n,
			max(case when y.sp_code = 'ALB' then coalesce(y.port_n,0000) else 00000 end) as a_port_n,
			max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end) as a_unl_n,
			max(case when z.sp_code = 'BET' then z.sp_n else 00000 end) as b_log_n,
			max(case when y.sp_code = 'BET' then coalesce(y.port_n,0000) else 00000 end) as b_port_n,
			max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) as b_unl_n,
			max(case when z.sp_code = 'YFT' then z.sp_n else 00000 end) as y_log_n,
			max(case when y.sp_code = 'YFT' then coalesce(y.port_n,0000) else 00000 end) as y_port_n,
			max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) as y_unl_n
into #Temp1
FROM    log.trips_ll t	
		LEFT OUTER JOIN ( select s.log_trip_id, c.sp_code,
							SUM(c.sp_n) as sp_n
					 from log.sets_ll s 
							INNER JOIN log.catch_ll c on  s.log_set_id = c.log_set_id 
					 where c.sp_code in ('ALB','BET','YFT')
					 group by s.log_trip_id, c.sp_code) z on t.log_trip_id = z.log_trip_id 		
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO' AND l.dto_type_right='UnloadingDTO'
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO' AND l2.dto_type_right='PortSamplingDTO'
        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
        INNER JOIN ref.ports dp ON t.depart_port_id = dp.port_id
        INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
		LEFT OUTER JOIN (	select  u2_c.unload_id, u2_c.sp_code,
									SUM(u2_c.sp_n) as unl_n
							from unload2.unloading_catch u2_c
							where u2_c.sp_code in ('ALB','BET','YFT')
							group by u2_c.unload_id, u2_c.sp_code) x on l.dto_guid_right = x.unload_id
		LEFT OUTER JOIN (	select p_c.sample_id,p_c.sp_code, 
									SUM(p_c.samples_n) as port_n
							from port.sample_tot p_c 
							where p_c.sp_code in ('ALB','BET','YFT')
							group by p_c.sample_id,p_c.sp_code) y on l2.dto_guid_right = y.sample_id
WHERE     COALESCE(:year,YEAR(t.depart_date)) = YEAR(t.depart_date)
	AND   COALESCE(:flag_code,vi.flag_id) = vi.flag_id
group by 
	vi.vesselname, 
	vi.flag_id, 
	CONVERT(nvarchar,t.depart_date,111),dp.port_name,
	CONVERT(nvarchar,t.return_date,111),rp.port_name
having max(case when x.sp_code = 'ALB' then coalesce(x.unl_n,0000) else 00000 end)
				+ max(case when x.sp_code = 'BET' then coalesce(x.unl_n,0000) else 00000 end) 
				+ max(case when x.sp_code = 'YFT' then coalesce(x.unl_n,0000) else 00000 end) > 0 
SELECT
		sx.flag_id flag_code, 
		SUM(1) as n_trips,
		SUM(case when sx.t_unl_n > sx.t_log_n*1.1 then 1 else 0 end) as trips_10pc_under,
		SUM(case when sx.a_unl_n > sx.a_log_n*1.1 then 1 else 0 end) as trips_alb_10pc_under,
		SUM(case when sx.b_unl_n > sx.b_log_n*1.1 then 1 else 0 end) as trips_bet_10pc_under,
		SUM(case when sx.y_unl_n > sx.y_log_n*1.1 then 1 else 0 end) as trips_yft_10pc_under,
		SUM(sx.t_log_n) as t_log_n,
		SUM(sx.t_unl_n) as t_unl_n,
		SUM(sx.a_log_n) as a_log_n,
		SUM(sx.a_unl_n) as a_unl_n,
		SUM(sx.b_log_n) as b_log_n,
		SUM(sx.b_unl_n) as b_unl_n,
		SUM(sx.y_log_n) as y_log_n,
		SUM(sx.y_unl_n) as y_unl_n,
        cast((SUM(sx.t_unl_n) - SUM(sx.t_log_n)) / (case when SUM(sx.t_log_n) = 0 then 10000.0 else SUM(sx.t_log_n) end)  as decimal(7,3)) as t_diff_n,
        cast((SUM(sx.a_unl_n) - SUM(sx.a_log_n)) / (case when SUM(sx.a_log_n) = 0 then 10000.0 else SUM(sx.a_log_n) end)  as decimal(7,3)) as a_diff_n,
        cast((SUM(sx.b_unl_n) - SUM(sx.b_log_n)) / (case when SUM(sx.b_log_n) = 0 then 10000.0 else SUM(sx.b_log_n) end)  as decimal(7,3)) as b_diff_n,
        cast((SUM(sx.y_unl_n) - SUM(sx.y_log_n)) / (case when SUM(sx.y_log_n) = 0 then 10000.0 else SUM(sx.y_log_n) end)  as decimal(7,3)) as y_diff_n
FROM #temp1 sx
group by sx.flag_id",NA
"266","4128b48a-d440-4f74-b03c-ac76010727e1"," LONGLINE Observer Trip -- Tuna Catch by hooks","trip_id","Number of catches by hook nulber in the basket and species (Tuna) from the selected LONGLINE observer trip","Observer",NA,"Observer","20",3417,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2021-10-13T10:31:40.64"," Select hook_no,sc.sp_code,count(*) as catch_n
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sp.sp_code = sc.sp_code
WHERE LEFT(:trip_id,3)=RTRIM(staff_code) and RIGHT(:trip_id,5)=tripno and sp.sp_code in ('YFT','BET','ALB')
group by sc.sp_code,hook_no",NA
"267","a7cecd39-8ad6-4217-81c6-a8a2010d5e0d"," List of E-Monitoring trips with corresponding Logbook data","year","List of EM trips with corresponding Logbook data","Logsheets",NA,"Observer","4a",3242,"andrewh@spc.int","brunod@spc.int","Logsheet, Observer, Longline, Emonitoring","2025-03-12T08:47:37.873"," select distinct VI.vesselname as VESSEL_NAME
		,et.obsprg_code as PROG_CODE
		,st.staff_code as EM_STAFF_CODE
		, ('trip@'+et.TRIPNO) AS TRIPNO
		, CONVERT(VARCHAR(10),et.dep_date,103) as EM_DEP_DATE
		, CONVERT(VARCHAR(10),et.ret_date,103) as EM_RET_DATE
		, CONVERT(VARCHAR(10),lt.depart_date,103) as LOG_DEP_DATE
		, CONVERT(VARCHAR(10), lt.return_date,103) AS LOG_RET_DATE
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join tufman2_dorado.log.trips_ll lt on lt.vessel_id=vi.vessel_id
											and et.dep_date between lt.depart_date and lt.return_date
inner join ref.field_staff st on st.staff_id=et.observer_id
where COALESCE(:year,year(et.dep_date)) = year(et.dep_date)",NA
"268","969fefbf-8415-4620-9172-a70600c73fc1"," LONGLINE - List of sets with whale predation","","Shows all the trips/sets that have whale predation","Logsheets",NA,NA,"81",3151,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline","2021-10-06T11:19:40.343"," select YEAR(logdate) as year,
	convert(varchar,t.depart_date, 103) depart_date,	
	vi.vesselname,
	convert(varchar,s.logdate, 103) logdate
from log.trips_ll t
	inner join log.sets_ll s on s.log_trip_id = t.log_trip_id
	inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
where s.is_whale_predation = 1",NA
"269","070e6488-4151-4925-ae3c-aa7a00921e1a"," CMM 18-03 (table y) Proportion of mitigation types","flag_code, year","Table Y for 18-03 Seabirds TL = Tori Line NS = Night Setting WB = Weighted Branchline - % are calculated by year and fleet","Observer",NA,"Observer","14b",3315,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, CMM, RegionalReporting, ByCatch","2025-04-02T14:58:00.293","select year,fleet, nbr_sets_mitigation,Requirements,Comb_mitigation
,south_of_30s,south_of_30s*100.0 /NULLIF(sum(south_of_30s ) over (partition by year,fleet),0) as south_of_30s_pct 
,between_25s_30s,between_25s_30s*100.0 /NULLIF(sum(between_25s_30s) over (partition by year,fleet),0) as between_25s_30s_pct 
,between_25s_23n,between_25s_23n*100.0 /NULLIF(sum(between_25s_23n) over (partition by year,fleet),0) as between_25s_23n_pct 
,north_of_23n,north_of_23n*100.0 /NULLIF(sum(north_of_23n) over (partition by year,fleet),0) as north_of_23n_pct 
from ( 
SELECT
	t1.year
	,t1.flag_id as fleet
	,count(*) as Nbr_sets_mitigation
        ,case when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'TL NS' then '1. Options required south of 25°S' 
                  when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'TL WB' then '1. Options required south of 25°S' 
                  when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'NS WB' then '1. Options required south of 25°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'TL WB NS' then '1. Options required south of 25°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'HS' then '1. Options required south of 25°S' 

                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'WB' then '2. Other options 25°S-30°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'TL' then '2. Other options 25°S-30°S' 

                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB DSL' then '3. Other options north of 230N'
                 when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB MOD' then '3. Other options north of 230N'
                 when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB BDB' then '3. Other options north of 230N'

                 else '4. Other combination' end as Requirements
	,coalesce(NULLIF(TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS,''),'No Mitigation') as Comb_mitigation
	,SUM(case when area = 'South of 30°S' then 1 else 0 end) as south_of_30s
	,SUM(case when area = '25°S-30°S' then 1 else 0 end) as between_25s_30s
	,SUM(case when area = '25°S-23°N' then 1 else 0 end) as between_25s_23n
	,SUM(case when area = 'North of 23°N' then 1 else 0 end) as north_of_23n
FROM (
	SELECT  
		YEAR(dep_date) AS year,
		flag_id,
		ls.l_set_id,
		CASE WHEN coalesce(tori_poles_yn,0) = 1 then 'TL ' else '' end AS TL,
		CASE WHEN (DATEPART(hh,set_dtime) >= 18 OR DATEPART(hh,set_dtime) <= 4) then 'NS ' else '' end AS NS,  
		CASE WHEN coalesce(weighted_lines_yn,0) =1 then 'WB ' else '' end AS WB,
		'' AS HS,
		'' as SS,
		CASE WHEN coalesce(bird_curtain_yn,0) = 1 then 'BC ' else '' end AS BC,
		CASE WHEN coalesce(underwater_chute_yn,0) = 1 then 'DSLS ' else '' end AS DSLS,
		CASE WHEN (coalesce(offal_discharged_yn,0) = 1 and coalesce(offal_opposite_yn,0) = 1) or (coalesce(offal_discharged_yn,0) = 0 and coalesce(offal_opposite_yn,0) = 0) then 'MOD ' else '' end AS MOD,
		CASE WHEN coalesce(bait1_dyed_ans,0) = 1  OR coalesce(bait2_dyed_ans,0) = 1 OR coalesce(bait3_dyed_ans,0) = 1 OR coalesce(bait4_dyed_ans,0) = 1
		OR coalesce(bait5_dyed_ans,0) = 1 then 'BDB ' else '' end AS BDB,
		case when latd < -30 then 'South of 30°S'
			when latd between -30 and -25 then '25°S-30°S'
			when latd between -25 and 23 then '25°S-23°N'
			when latd > 23 then 'North of 23°N' end as area
	FROM    obsv.trip ot 
		join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		JOIN obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
		LEFT JOIN obsv.l_sethaullog hl on hl.l_set_id = ls.l_set_id and stend_id = 83
		LEFT JOIN obsv.l_gear g on g.obstrip_id=ot.obstrip_id
	where latd is not null 
		AND year(dep_date) = coalesce(:year,year(dep_date))
		AND flag_id = coalesce(:flag_code,flag_id)
         ) t1

group by t1.year,flag_id,coalesce(NULLIF(TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS,''),'No Mitigation') ,case when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'TL NS' then '1. Options required south of 25°S' 
                  when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'TL WB' then '1. Options required south of 25°S' 
                  when TL+NS+WB+SS+BC+BDB+DSLS+MOD+HS = 'NS WB' then '1. Options required south of 25°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'TL WB NS' then '1. Options required south of 25°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'HS' then '1. Options required south of 25°S' 

                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'WB' then '2. Other options 25°S-30°S' 
                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'TL' then '2. Other options 25°S-30°S' 

                  when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB DSL' then '3. Other options north of 230N'
                 when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB MOD' then '3. Other options north of 230N'
                 when TL+WB+NS+SS+BC+BDB+DSLS+MOD+HS = 'SS BC WB BDB' then '3. Other options north of 230N'

                 else '4. Other combination' end
)t",NA
"270","1f63bca9-f2bb-40c4-85c4-a7220094a154"," ARTISANAL - Tails statistics - Artisanal activity logs per data collector","year",NA,"Artisanal",NA,NA,"99.2",3159,"andrewh@spc.int","andrewh@spc.int","Artisanal, CoverageMissingData, MyFleet","2021-10-13T14:38:14.887"," SELECT	:group_by,count(*) nb_logs
FROM	art2.fishing_activity_log
WHERE	system_source='tails'
AND		COALESCE(:year,YEAR(activity_date))=YEAR(activity_date)
GROUP BY :group_by","YearEnteredbyCountry"
"271","5277ca59-d622-435d-b3ea-a8c500dcb01e"," Position reports summary","date_from, date_to",NA,"Port",NA,NA,"4",3250,"andrewh@spc.int","andrewh@spc.int","Custom","2022-02-07T16:08:32.693"," SELECT	c.company_code,v.vesselname, p.rpt_code, CONVERT(VARCHAR(10),p.telex_date,103) as telex_date, p.telex_time,p.lat, ref.GetLatDfromLat(p.lat) lat_d, 
		p.lon, ref.GetLonDfromLon(p.lon) lon_d, p.skj_mt, p.yft_mt, p.bet_mt, p.alb_mt, p.oth_mt, p.catch_mt, p.fish_days_n, p.fuel
FROM	pos.position_reports p inner join ref.vessel_instances v ON p.vessel_id = v.vessel_id AND p.telex_date BETWEEN v.start_date AND v.calculated_end_date
		LEFT JOIN tufman.companies c ON v.company_id = c.company_id
WHERE	telex_date >= COALESCE(:date_from,'1970-01-01')
AND		telex_date <= COALESCE(:date_to,'2100-01-01')",NA
"272","d8042051-2e70-4731-8196-a74c00c4a8da"," COVERAGE: Purse Seine Observer Coverage","flag_code, year","Purse seine observer coverage for part 1 reports. This is to allow countries to report against the 100% observer coverage requirement on Purse seine vessels","Observer,VMS",NA,"Live","51",3168,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, CoverageMissingData","2025-10-24T16:31:16.873","SELECT flag_id as vessel_flag,
	gear as gear_code,
	vd.year,
	COUNT(distinct vt.vms_trip_id) as vms_trips,
	SUM(vd.day_fishing) as days_fishing,
	SUM(vd.day_at_sea) as days_at_sea
INTO #mapped_vms_trip
FROM vms.vms_trips vt 
		inner join 
				(SELECT [vms_trip_id],
      					year,
      					SUM(day_fishing) as day_fishing,
      					SUM(day_at_sea) as day_at_sea
  				FROM vms.[vms_trip_efforts]
				group by [vms_trip_id],  year) vd on  vt.[vms_trip_id] = vd.[vms_trip_id]
		inner join ref.vessel_instances vi on vt.vessel_id = vi.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.vessels v on vt.vessel_id = v.vessel_id
where gear = 'S'
  and datediff(d,departure_date,return_date) > 7
  and vd.day_fishing > 3
group by flag_id,
	gear,
	[year] SELECT  right(c.gear_code,1) as Gear,
        c.year AS Year,
        c.vessel_flag,  
        sum(vms_trips) as trips_est,
        coalesce(max(x1.obs_trips),0) as obs_trips,
        cast(convert(decimal(5,1), coalesce(max(x1.obs_trips),0) / sum(coalesce(vms_trips,0.01)) * 100) as varchar(6)) + '%' as trip_cov,  
        coalesce(max(x1.obs_trips_proc),0) as obs_trips_proc,
        cast(convert(decimal(5,1), coalesce(max(x1.obs_trips_proc),0) / sum(coalesce(vms_trips,0.01)) * 100) as varchar(6)) + '%' as trip_proc_cov,  
        convert(decimal(9,1), sum(days_fishing)) as days_est,
        coalesce(MAX(x1.fish_days),0) as fish_days,
        cast(convert(decimal(5,1),coalesce(MAX(x1.fish_days),0) / sum(coalesce(days_fishing,0.01)) * 100) as varchar(6)) + '%' as days_cov
FROM #mapped_vms_trip c 
                    left join (SELECT t.gear_code as gear, 
                                    Year(dep_date) as yr,
                                    v.flag_id as flag, 
                                    coalesce(COUNT(distinct case when t.gear_code = 'S' then t.obstrip_id else t.obstrip_id end),0) as obs_trips, 
									coalesce(count(distinct t1.obstrip_id),0) as obs_trips_proc, 
                                    coalesce(COUNT(distinct case when t.gear_code = 'S' then cast(s1.obstrip_id as varchar(50)) + cast(cast(act_date as date) as varchar(10)) else cast(s2.obstrip_id as varchar(50)) + cast(cast(set_date as date) as varchar(10)) end),0) as fish_days 
                                FROM obsv.trip t    
                                        inner join ref.vessel_instances v    on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
                                        left join obsv.s_day s1        on t.obstrip_id = s1.obstrip_id AND year(s1.start_date) = coalesce(:year, year(s1.start_date)) 
                                        left join obsv.s_daylog sa1    on s1.s_day_id = sa1.s_day_id and s_activ_id in (1,2) 
                                        left join obsv.l_set s2        on t.obstrip_id = s2.obstrip_id AND year(set_date) = coalesce(:year, year(set_date))
										left join (select obstrip_id from obsv.trip where data_status in (263,264)) t1 on t1.obstrip_id=t.obstrip_id
                                WHERE year(dep_date) = coalesce(:year, year(dep_date)) and obsprg_code not like '%EM' 
                                GROUP BY t.gear_code, Year(dep_date), v.flag_id) x1 
                    ON right(c.gear_code,1) COLLATE Latin1_General_CI_AS = x1.gear
                    and c.year = x1.yr
                    and c.vessel_flag  COLLATE Latin1_General_CI_AS = x1.flag  
WHERE c.year = coalesce(:year, c.year) 
AND c.vessel_flag = coalesce(:flag_code,c.vessel_flag)
AND c.gear_code = 'S' 
group by right(c.gear_code,1), c.year, c.vessel_flag",NA
"273","0b32f214-df07-4cdc-b973-a75900f88c51","PURSE SEINE - Distinct vessels in WCPFC Area - NATIONAL FLEET ","year","NATIONAL FLEET - Purse Seine distinct vessels fishing in WCPFC Area - From VMS data","Logsheets,VMS",NA,"Live","2.1.5",3176,"andrewh@spc.int","emmanuels@spc.int","Purseseine, RegionalReporting","2023-04-18T15:14:19.457","    SELECT  distinct vi.vesselname, vi.flag_id INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='S'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ps l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
	AND     day_fishing>0
	ORDER BY vi.vesselname

SELECT vesselname vessel_name, flag_id flag_code
FROM #mapped_trip",NA
"274","0d82e937-7f82-4fdb-8f8e-2ee60ce81a86"," IATTC Area -- TASK II -- LONGLINE Catch and effort (5x5)","year","Report produced on request for Vanuatu. TASK II -- LONGLINE Catch and effort for IATTC reporting requirements. (5x5 degree squares) this time the data is split by month and not by year.","Logsheets",NA,NA,"32a",3081,"andrewh@spc.int","christelled@spc.int","Logsheet, Longline, Custom, AllSpecies","2025-06-30T14:19:52.823","WITH cte as (
SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
        floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
        FORMAT(logdate, 'yyyy-MM') as key1,
        SUM(coalesce(hooks_n, 0)) as hooks
FROM    log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE    year(logdate) = coalesce(:year, year(logdate)) 
        AND lond > -150 and lond <= -70
		and vi.flag_id = @@entity
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,
         floor(ref.GetLonDfromLon(lon)/5)*5+2.5, 
         FORMAT(logdate, 'yyyy-MM')   
         )
          SELECT		FORMAT(logdate, 'yyyy-MM') as yearmonth,
			floor(ref.GetLatDfromLat(lat)/5)*5+2.5 as latitude,
            floor(ref.GetLonDfromLon(lon)/5)*5+2.5 as longitude,
            COUNT(distinct t.vessel_id) as vessels,
            COUNT(distinct t.log_trip_id) as trips,
			COUNT(distinct s.log_set_id) as sets,
            MAX(cte.hooks) as hooks,
            cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)                                      as decimal(7,0))  AS alb_n,
            cast(Sum(case sp_code when 'BET' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bet_n,
            cast(Sum(case sp_code when 'YFT' then sp_n_est else 0 end)                                      as decimal(7,0))  AS yft_n,
            cast(Sum(case sp_code when 'SKJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS skj_n,
            cast(Sum(case sp_code when 'PBF' then sp_n_est else 0 end)                                      as decimal(7,0))  AS pbf_n,
            cast(Sum(case sp_code when 'BUM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bum_n,
            cast(Sum(case sp_code when 'BLM' then sp_n_est else 0 end)                                      as decimal(7,0))  AS blm_n,
            cast(Sum(case sp_code when 'MLS' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mls_n,
            cast(Sum(case sp_code when 'SWO' then sp_n_est else 0 end)                                      as decimal(7,0))  AS swo_n,    
			cast(Sum(case sp_code when 'BSH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bsh_n,
            cast(Sum(case sp_code when 'LMD' then sp_n_est else 0 end)                                      as decimal(7,0))  AS lmd_n,
            cast(Sum(case sp_code when 'BTH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bth_n,
			cast(Sum(case sp_code when 'PTH' then sp_n_est else 0 end)                                      as decimal(7,0))  AS pth_n,
            cast(Sum(case sp_code when 'THR' then sp_n_est else 0 end)                                      as decimal(7,0))  AS thr_n,
            cast(Sum(case sp_code when 'CCL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ccl_n,
            cast(Sum(case sp_code when 'OCS' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ocs_n,
            cast(Sum(case sp_code when 'FAL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS fal_n,
            cast(Sum(case sp_code when 'SMA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS sma_n,
            cast(Sum(case sp_code when 'LMA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS lma_n,
			cast(Sum(case sp_code when 'MAK' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mak_n,
            cast(Sum(case sp_code when 'SSN' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ssn_n,
            cast(Sum(case sp_code when 'SPL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spl_n,
            cast(Sum(case sp_code when 'SPE' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spe_n,
            cast(Sum(case sp_code when 'SPK' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spk_n,
            cast(Sum(case sp_code when 'SPJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spj_n,
			cast(Sum(case sp_code when 'SPZ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spz_n,
            cast(Sum(case sp_code when 'SPY' then sp_n_est else 0 end)                                      as decimal(7,0))  AS spy_n,
            cast(Sum(case sp_code when 'SKX' then sp_n_est else 0 end)                                      as decimal(7,0))  AS skx_n,
            cast(Sum(case sp_code when 'MZZ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS mzz_n,
			cast(Sum(case sp_code when 'TUN' then sp_n_est else 0 end)                                      as decimal(7,0))  AS tun_n,
            cast(Sum(case sp_code when 'BEP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bep_n,
            cast(Sum(case sp_code when 'BIP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bip_n,
            cast(Sum(case sp_code when 'BZX' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bzx_n,
            cast(Sum(case sp_code when 'BKJ' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bkj_n,
            cast(Sum(case sp_code when 'SFA' then sp_n_est else 0 end)                                      as decimal(7,0))  AS sfa_n,
			cast(Sum(case sp_code when 'SSP' then sp_n_est else 0 end)                                      as decimal(7,0))  AS ssp_n,
            cast(Sum(case sp_code when 'BIL' then sp_n_est else 0 end)                                      as decimal(7,0))  AS bil_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join cte on 
                                                        floor(ref.GetLatDfromLat(lat)/5)*5+2.5 = cte.latitude
                                                        and floor(ref.GetLonDfromLon(lon)/5)*5+2.5 = cte.longitude
                                                        and cte.key1 = FORMAT(logdate, 'yyyy-MM')
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND lond > -150 and lond <= -70
  AND vi.flag_id = @@entity
  and s.l_activity_id = 1
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonDfromLon(lon)/5)*5+2.5, FORMAT(logdate, 'yyyy-MM')",NA
"275","00c30b18-1a85-4884-a134-a8e900a64398"," TAILS In app report - Vessel report","staff_code","Total catches, effort and cost per vessel (current year)","Artisanal",NA,NA,"98.1",3258,"andrewh@spc.int","andrewh@spc.int","API","2021-10-13T14:35:03.89"," SELECT	vessel_name filter_vessel_name, 
		SUM(c.sp_kg) tot_kg, 
		CONVERT(INT,SUM(e.hours_fished_n)) tot_hours,
		SUM(COALESCE(fuel_cost,0)+COALESCE(bait_cost,0)+COALESCE(ice_cost,0)+COALESCE(JSON_VALUE(t.extensions,'$.NfdsFadMonitoring.OtherCost'),0)) tot_costs,
		CONVERT(INT,SUM(COALESCE(fuel_cost,0)+COALESCE(bait_cost,0)+COALESCE(ice_cost,0)+COALESCE(JSON_VALUE(t.extensions,'$.NfdsFadMonitoring.OtherCost'),0))/SUM(c.sp_kg)) avg_cost_per_kg		
FROM	art2.trips t JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		JOIN art2.catch c ON c.art_effort_id = e.art_effort_id
		JOIN art2.vessels v ON t.vessel_id = v.vessel_id
WHERE	t.entered_by=:staff_code
	and year(t.trip_date) = YEAR(getdate())
GROUP BY vessel_name",NA
"276","75c8f12b-21f5-4b6e-b4ba-b01e019efc62"," ARTISANAL - FAD CPUE - Catch per line hour (Year / Month)","year",NA,"Artisanal",NA,NA,"4.1.2",3089,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2021-09-29T16:49:00.22","SELECT	YEAR(t.trip_date) [year],MONTH(t.trip_date) month,f.fad_name, l.landing_site_name, SUM(e.hours_fished_n * e.lines_n) effort into #t
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
GROUP BY YEAR(t.trip_date),MONTH(t.trip_date),f.fad_name, l.landing_site_name SELECT	YEAR(t.trip_date) [year],MONTH(t.trip_date) month,f.fad_name, l.landing_site_name, c.sp_code,CONVERT(DECIMAL(6,2),SUM(COALESCE(c.sp_kg,0))) catch,#t.effort, CONVERT(DECIMAL(6,2),SUM(COALESCE(c.sp_kg,0))/#t.effort) cpue
FROM	art2.trips t INNER JOIN art2.landing_sites l ON t.landing_site_id = l.landing_site_id
		INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
		INNER JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
		INNER JOIN art2.catch c ON e.art_effort_id=c.art_effort_id
		INNER JOIN #t ON #t.year = YEAR(t.trip_date) AND #t.month = MONTH(t.trip_date) AND #t.fad_name = f.fad_name AND #t.landing_site_name = l.landing_site_name
WHERE	COALESCE(:year,YEAR(t.trip_date))=YEAR(t.trip_date)
		and #t.effort > 0
GROUP BY YEAR(t.trip_date),MONTH(t.trip_date),f.fad_name, l.landing_site_name, c.sp_code, #t.effort",NA
"277","d14d5b8f-c733-42e2-9ad7-a79a00c84b13"," ARTISANAL - Activity Logs Entry stats","year","Sort by the Year column to get the best view","Artisanal",NA,NA,"80",3184,"andrewh@spc.int","andrewh@spc.int","Artisanal, CoverageMissingData, DataQuality","2021-10-12T15:47:25.687"," select :group_by as :group_alias,
	count (1) as activity_logs
from art2.fishing_activity_log t inner join art2.landing_sites ls ON t.landing_site_id=ls.landing_site_id
where COALESCE(:year,YEAR(t.activity_date))=YEAR(t.activity_date)
group by :group_by","YearCollector"
"278","573c6c16-d9a7-4d1b-b4da-fd8ec3f5e137"," Part1 - Figure 3 - Map - PURSE SEINE NATIONAL FLEET effort in the WCPFC Convention Area","year","Map - NATIONAL PURSE SEINE FLEET effort in the WCPFC Convention Area","Logsheets",2,NA,"9b",3097,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting","2021-10-07T13:42:26.487"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor (ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Count(distinct case when (s.s_activity_id in (1,2)) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as Days
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate)) 
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"279","fc3281e4-a839-4abe-983e-aac4010d04c1"," SNAPPER - Vessel Catch by month","year","Vessels catch by month","Logsheets",NA,NA,"6",3321,"andrewh@spc.int","andrewh@spc.int","Logsheet, DeepwaterSnapper, ByVessel, MyEEZ","2023-10-12T13:52:58.73"," Select
	v.vesselname vessel_name,
	month(s.logdate) as Month,
	format(s.logdate, 'yyyy') as year,
	s.eez_code, 
	s.hooks_n, 
	s.hours_n, 
	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS etc_kg,
	cast(Sum(case sp_code when 'ETC' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS etc_cpue, 
	cast(Sum(case sp_code when 'ETC' then sp_n else 0 end)							as decimal(7,0))	AS etc_n, 
	cast(Sum(case sp_code when 'ETC' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS etc_npue, 
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS eta_kg,
	cast(Sum(case sp_code when 'ETA' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS eta_cpue, 
	cast(Sum(case sp_code when 'ETA' then sp_n else 0 end)							as decimal(7,0))	AS eta_n,
	cast(Sum(case sp_code when 'ETA' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS eta_npue, 
	cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) 					as decimal(5,0))	AS pfm_kg,
	cast(Sum(case sp_code when 'PFM' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS pfm_cpue, 
	cast(Sum(case sp_code when 'PFM' then sp_n else 0 end)							as decimal(7,0))	AS pfm_n,
	cast(Sum(case sp_code when 'PFM' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS pfm_npue, 
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lwf_kg,
	cast(Sum(case sp_code when 'LWF' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS lwf_cpue, 
	cast(Sum(case sp_code when 'LWF' then sp_n else 0 end)							as decimal(7,0))	AS lwf_n,
	cast(Sum(case sp_code when 'LWF' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS lwf_npue, 
	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) 					as decimal(5,0))	AS arq_kg,
	cast(Sum(case sp_code when 'ARQ' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS arq_cpue, 
	cast(Sum(case sp_code when 'ARQ' then sp_n else 0 end)							as decimal(7,0))	AS arq_n,
	cast(Sum(case sp_code when 'ARQ' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS arq_npue, 
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) 					as decimal(5,0))	AS lrk_kg,
	cast(Sum(case sp_code when 'LRK' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS lrk_cpue, 
	cast(Sum(case sp_code when 'LRK' then sp_n else 0 end)							as decimal(7,0))	AS lrk_n,
	cast(Sum(case sp_code when 'LRK' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS lrk_npue,
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) 					as decimal(5,0))	AS bwa_kg,
	cast(Sum(case sp_code when 'BWA' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS bwa_cpue, 
	cast(Sum(case sp_code when 'BWA' then sp_n else 0 end)							as decimal(7,0))	AS bwa_n,
	cast(Sum(case sp_code when 'BWA' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS bwa_npue,
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) 					as decimal(5,0))	AS ytc_kg,
	cast(Sum(case sp_code when 'YTC' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS ytc_cpue, 
	cast(Sum(case sp_code when 'YTC' then sp_n else 0 end)							as decimal(7,0))	AS ytc_n,
	cast(Sum(case sp_code when 'YTC' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS ytc_npue,
	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) 					as decimal(5,0))	AS bsp_kg,
	cast(Sum(case sp_code when 'SEY' then sp_kg else 000.0 end) / hooks_n			as decimal(6,2))	AS bsp_cpue, 
	cast(Sum(case sp_code when 'SEY' then sp_n else 0 end)							as decimal(7,0))	AS bsp_n,
	cast(Sum(case sp_code when 'SEY' then sp_n else 000.0 end)  /hooks_n			as decimal(6,2))	AS bsp_npue,
	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0 when 'ARQ' then 0 
						when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 when 'YTC' then 0 
						when 'SEY'  then 000.0 else sp_kg end) as decimal(5,0)) AS oth_kg, 
	cast(Sum(case sp_code when 'ETC' then 0 when 'ETA' then 0 when 'PFM' then 0 when 'LWF' then 0
						when 'ARQ' then 0 when 'LRK' then 0 when 'LRK' then 0 when 'BWA' then 0 
						when 'YTC' then 0 when 'SEY' then 0 else sp_n end) as decimal(7,0))	AS oth_n, 
	cast(Sum(sp_kg) as decimal(5,0)) 	AS tot_kg, 
	cast(Sum(sp_n)  as decimal(7,0))	AS tot_n
from log.trips_ds t
	inner join log.sets_ds S on t.log_trip_id = S.log_trip_id
	inner join log.catch_ds C on s.log_set_id = c.log_set_id
	inner join ref.vessel_instances V on t.vessel_id = v.vessel_id and t.return_date between v.start_date and v.calculated_end_date
where Year(s.logdate) = :year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
Group by v.vesselname, 
		month(s.logdate),
		format(s.logdate, 'yyyy'),
		s.eez_code,
		s.hooks_n, 
		s.hours_n",NA
"280","cbe667cb-b854-4bc5-8cbb-a7d600c1ab82"," Pole and line logsheet in EEZ - Full list of all trips and reconciliation status (with link to trips if entered)","flag_code, year",NA,"Logsheets,VMS",NA,NA,"1.3.3",3214,"andrewh@spc.int","brunod@spc.int","Logsheet, PoleAndLine, CoverageMissingData, MyEEZ, MyFleet","2023-03-21T15:36:38.987","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='P'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year AND eez.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity))
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_pl l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date
	 select vesselname, flag_id, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp as depart_port, CONVERT(nvarchar,return_date,111) vms_return_date, rp as return_port, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id PoleAndLineLogsheetDTO 
from #mapped_trip",NA
"281","b8670dd7-5c39-4f66-bc2b-ab0a00b25096"," Phils Artisinal Report Dump NEW","year",NA,"Artisanal",NA,NA,"998b.",3349,"andrewh@spc.int","andrewh@spc.int","Artisanal, Custom","2023-03-28T11:23:58.483","SELECT t.art_trip_id, e.art_effort_id, c.art_catch_id, 
YEAR (trip_date) as trp_yr, 
MONTH (trip_date) as trp_mnth, 
DAY (trip_date) as trp_dy, 
t.skipper_name, 
recorder_name, 
crew_n, 
CONVERT (VARCHAR,t.entered_date, 111) as Entered_date,v.vessel_name,
ref.GetTranslation('ArtisanalVesselPowerModes',v.boat_power_id,'en') as power, 
vessel_type_id,gear_cost,
CONVERT (VARCHAR,return_date,111) as Return_date,
fuel_used,
fuel_cost,
bait_used,
bait_cost,
ice_used,
ice_cost,
gear_purchased,
t.system_source, 
depart_time,
return_time,
entered_latitude, 
entered_longitude, 
t.extensions trip_ext,
ls.landing_site_name, 
target_fishery_type, 
data_recorder_type, 
ref.GetTranslation('ArtisanalFishingMethods',fish_method_id,'en') fish_method,
hours_fished_n, lines_n, 
hooks_per_line_n, 
live_bait_used, 
a.art_area_name, 
region_name,
fad_name, 
e.extra_info_json eff_ext, 
c.sp_code, 
sp_name, 
sp_n, 
sp_kg,
c.extensions catch_ext, 
SpeciesComment,
EndUseCommunityMarket,
EndUseProvincialMarket,
EndUseUrbanMarket,
EndUseEaten,
EndUseGivenAway 
FROM art2.trips t INNER JOIN art2.landing_sites ls ON t.landing_site_id = ls.landing_site_id
		LEFT JOIN art2.regions r ON ls.region_id = r.region_id
         left JOIN art2.vessels v ON t.vessel_id = v.vessel_id
         INNER JOIN art2.effort e ON e.art_trip_id = t.art_trip_id
         LEFT JOIN art2.areas a ON a.art_area_id = e.art_area_id
          LEFT JOIN art2.fad_register f on e.fad_register_id = f.fad_register_id
          LEFT JOIN art2.catch c ON c.art_effort_id = e.art_effort_id
		  inner join ref.species spp on spp.sp_code = c.sp_code
OUTER APPLY OPENJSON(c.extensions,'lax $.NfdsFadMonitoring')  
     WITH (
			SpeciesComment varchar(1000),
			EndUseCommunityMarket  float,
			EndUseProvincialMarket float,
			EndUseUrbanMarket float,
			EndUseEaten float,
			EndUseGivenAway float			
		)  
     AS location",NA
"282","48a81b4d-a5ab-44d9-be57-48a835d4181d"," Part1 - OPTIONAL - Map of POLE AND LINE CATCH in the Home EEZ (national waters) 5x5","year","Map of POLE AND LINE CATCH in the Home EEZ (national waters) in 5x5","Logsheets",2,NA,"99c",3108,"andrewh@spc.int","brunod@spc.int","Logsheet, PoleAndLine, CMM","2021-10-11T16:12:34.603"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,
		floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(case sp_code when 'SKJ' then sp_mt_est else 0000 end)				AS skj_c, 
		Sum(case sp_code when 'YFT' then sp_mt_est else 0000 end) 				AS yft_c,
		Sum(case sp_code when 'BET' then sp_mt_est else 0000 end) 				AS bet_c 		
FROM log.trips_pl t inner join log.sets_pl s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_pl c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5 ,
		floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"283","b7f8cf16-14b1-46f6-8fdc-387dfefdfef2"," Part1 - Annual POLE AND LINE catch and effort estimates by FLEET in the Home EEZ (national waters)","year","Annual POLE AND LINE catch and effort estimates by FLEET in the Home EEZ (national waters)","Logsheets",NA,"Live","11c",3010,"andrewh@spc.int","benoitp@spc.int","Logsheet, CMM","2022-07-08T10:55:47.803"," SELECT  vi.flag_id flag_code,
        COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt else 000.0 end) as decimal(9,3))           AS skj_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt else 000.0 end)  as decimal(9,3))             AS yft_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt else 000.0 end) as decimal(9,3))             AS bet_mt, 
        cast(Sum(sp_mt) as decimal(9,3))  AS tot_mt 
FROM log.trips_pl t inner join log.sets_pl pl on t.log_trip_id = pl.log_trip_id 
   					inner join log.catch_pl c on pl.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate))
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id",NA
"284","52ee62fd-5a31-409b-a4cc-a7a900eb15bd"," CMM 10-01 – North Pacific Striped Marlin catches by National Fleet","flag_code, year","By 30 April 2011, each flag/chartering CCM shall report to the Commission verifiable information regarding its catch of North Pacific Striped Marlin by its flagged/chartered vessels north of the equator. ","Logsheets",NA,NA,"23",3192,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2022-03-07T16:30:24.68"," SELECT  vi.flag_id as flag, 
		year(logdate) as yr,
		COUNT(distinct case when RIGHT(lat,1) = 'N' then t.vessel_id else null end) as NumVessels,
		SUM(case when c.sp_code = 'MLS' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'MLS' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
group by vi.flag_id, year(logdate)",NA
"285","2e9b232d-20a2-43cd-8d6d-855b1f57900c"," Missing US Treaty logsheets","year","Using VMS data, lists the US Treaty logsheet not entered yet in TUFMAN2","Logsheets",NA,NA,"8.1",3019,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CoverageMissingData, MyFleet","2022-09-12T16:34:05.667","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT  DISTINCT t.vms_trip_id
    FROM	log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
            INNER JOIN [vms].vms_trips t ON t.vessel_id = vi.vessel_id AND (
                  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
            )
	) t SELECT  vi.vesselname,vi.flag_id,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing 
FROM	[vms].vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN [vms].vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
        JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='S'
AND		vi.flag_id='US'
AND     eez.eez_code <> 'IW' 
AND		COALESCE(:year, eez.year)=eez.year
GROUP BY vi.vesselname,vi.flag_id,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"286","254f076c-23e4-452b-a264-a90e00eeff50"," Annual total catch count Not of Tuna category by Fleet","year",NA,"",NA,"Observer","8b",3266,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T15:56:47.017"," select vi.vesselname, case 
						when sp_cat_code is null or sp_cat_code='' THEN 'UNSPECIFIED' 
						when sp_cat_code = 'TTX' THEN 'TURTLE' 
						when sp_cat_code = 'MAM' THEN 'MAMMAL' 
						when sp_cat_code = 'SHK' THEN 'SHARK' 
						when sp_cat_code = 'BRD' THEN 'BIRD' 
						when sp_cat_code = 'TUN' THEN 'TUNA' 
						when sp_cat_code = 'BIL' THEN 'BILLFISH' 
						when sp_cat_code = 'INV' THEN 'INVERTEBRATE' 
						ELSE sp_cat_code END as sp_cat_code,sp.sp_name,count(sc.sp_code) as catch_count
from em.trip et
inner join em.l_set ls on ls.obstrip_id=et.obstrip_id
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where right(et.obsprg_code,2)='EM' and  COALESCE(:year,year(dep_date)) = year(dep_date) and sp.sp_cat_code<>'TUN'
group by vi.vesselname,sp.sp_cat_code, sp.sp_name",NA
"287","1f488678-dc25-4891-8bb8-36e3176001de"," Tufman 2 - Number of validations by data type and DCT","year","See how many trips you have validated, who validated them and how many are invalid still.","",NA,NA,"1",3035,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, Purseseine, MyFleet","2021-10-18T12:48:18.93"," SELECT :group_by,
	dto_type, 
      coalesce(accepted_by, 'Still Pending') as accepted_by,
	  count(*) as number
FROM [tuf2].[check_result_lines]
WHERE instance_source = ref.getBitFromEntity(@@entity) AND
	check_level = 'VerificationRequired' AND
		year(changed_date) = coalesce(:year, year(changed_date))
          
GROUP BY :group_by,dto_type,accepted_by","YearMonth"
"288","c97c3605-3500-4413-8f9a-aa3bf1cbc77a"," CMM 12-04 - WHALE SHARK interactions in the Purse seine fishery","flag_code, min_year, max_year","CCMs shall advise in their Part 1 Annual Report of any instances in which whale sharks have been encircled by the purse seine nets of their flagged vessels, including details required under paragraph 4(b)","Observer",NA,"Observer","11",2942,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine, CMM, Raised, RegionalReporting, ByCatch","2025-09-15T16:00:00.723"," SELECT 	'S' as gear,
		flag_id as flag, 
		sp.sp_name as species,
		v.vesselname,
		CONVERT(VARCHAR(10), act_date, 103) as date, 
		lat as lat, 
		lon, 
		eez_code, 
		sa.s_activ_id as activity_code,
		fate_code, 
		case when gr_interact_code is null then 'LANDED' else 'INTERACTION' END as type,
		coalesce(obs_n,00000) as Individuals,
		coalesce(obs_mt,0000.000) as MT,
		case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end as N_estimate,
		case when discard_cond_code in ('A1','A4') then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Alive_healthy,
		case when discard_cond_code in ('A2','A3','A5','A6','A7','A8') then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Alive_injured,
		case when discard_cond_code = 'A0' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Alive_unknown,
		case when discard_cond_code like 'D%' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Dead,
		case when coalesce(discard_cond_code,'U') like 'U%' then case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 0 end as Unknown
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				inner join ref.species sp on sc.sp_code = sp.sp_code
WHERE YEAR(act_date) between coalesce(:min_year,year(act_date)) and coalesce(:max_year,year(act_date))
	AND s_activ_id = 1 
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_code = 'RHN'",NA
"289","7fc2f425-ccd4-492b-b218-10b3b8770000"," CMM 13-08 – Silky shark species catches by National Fleet (unraised)","flag_code, year","CMM 13-08 – Silky shark species catches by National Fleet","Observer",NA,"Observer","13",2951,"andrewh@spc.int","andrewh@spc.int","Observer, Longline, Purseseine, CMM, Raised, RegionalReporting, ByCatch","2022-01-08T11:02:43.833"," SELECT  'S' as gear,
	ot.tripno as tripno, 
	v.vesselname as vessel_name,  
	flag_id as flag,    
	sp.sp_name as species,   
	CONVERT(VARCHAR, ss.skiffoff_dtime, 121) as date,     
	lat as lat,    
	lon as lon,    
	eez_code as eez_code,
	coalesce(schas_id,20)-20 as schtype,
	fate_code as fate_code,   
	coalesce(cond_code,'-') as caught_cond_code,
	coalesce(discard_cond_code,'-') as discard_cond_code,
	case WHEN fate_code='DFR' then coalesce(replace(sc.obs_n,0,NULL),sc.sp_n_est) end as Discarded_body_fins_retained,
	case WHEN fate_code='RFR' then coalesce(replace(sc.obs_n,0,NULL),sc.sp_n_est) end as Body_fins_retained,
	coalesce(sc.obs_n,0) as observed_number,
	coalesce(sc.obs_mt,0.000) as observed_weight,
	coalesce(sc.sp_n_est,0) as estimated_number,
	coalesce(sc.sp_c_est,0.000) as estimated_weight,
	coalesce(sc.sp_w_est,0.000) as estimated_avwt,
	coalesce(r.avwt_desc,' ') as est_notes
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
		inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
		inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
		left outer join [ref_static].avwt_codes r on r.avwt_id = sc.sp_w_id
	WHERE YEAR(act_date) = coalesce(:year,year(act_date))
		AND s_activ_id = 1
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code = 'FAL' 
	UNION
	SELECT  'L' as gear,
			ot.tripno as tripno,
			v.vesselname as vessel_name,
			flag_id as flag,
			sp.sp_name as species,
			CONVERT(VARCHAR, sc.catch_dtime, 121) as date, 
			sa.lat as lat,
			sa.lon as lon,
			eez_code as eez_code,
			0 as schtype,
			fate_code as fate_code,
			coalesce(cond_code,'-') as caught_cond_code,
			coalesce(cond_code2,'-') as discard_cond_code,
			case WHEN fate_code='DFR' then 1 end as Discarded_body_fins_retained,
			case WHEN fate_code='RFR' then 1 end as Body_fins_retained,
			1 as observed_number,
			wt_est/1000 as observed_weight,
			1 as estimated_number,
			wt_est/1000 as estimated_weight,
			wt_est as estimated_avwt,
			' ' as est_notes
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83
		inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
	WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code = 'FAL'",NA
"290","44531c4b-17f8-46f0-9f28-a7ae00c3d7a7"," LONGLINE - Reporting Summary","year","Requested by French Polynesia, a summary of all eReporting sets by technology","Logsheets",NA,NA,"10",3200,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, ByVessel, Ereporting","2024-06-14T12:28:38.183"," SELECT  YEAR(s.logdate) as year,
		:group_by,
		Sum(case system_source when 'OnBoard' then 1 else 0 end) as onboard_sets,
		Sum(case system_source when 'eTunalog' then 1 else 0 end) as tunalog_sets,
		Sum(case when system_source LIKE 'Tufman%' then 1 else 0 end) as tufman_sets,
		Sum(case when system_source not in ('Tufman','eTunalog','OnBoard','Tufman2') then 1 else 0 end) as other_sets
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
group by YEAR(s.logdate), :group_by","vesselname"
"291","2de0f9db-00d2-4750-a343-7b2a5cd60115"," CMR - Species of Special interest reports from the GEN-2 form","flag_code, year","Speciies of Special interest reports from the GEN-2 form","Observer",NA,"Observer","EXTRA",2959,"andrewh@spc.int","aurelienp@spc.int","Observer, RegionalReporting","2023-02-02T14:01:23.1","SELECT 	ot.gear_code as gear,
		flag_id as flag,
		v.vesselname, 
		cast(interact_date as date) as date, 
		g2.lat, 
		g2.lon,
		coalesce(schas_id,20)-20 as set_type, 
		g2.eez_code, 
		sp_cat_code, 
		sp.sp_name as species,
		coalesce(g2.interact_code,'-') as interact_code,
		coalesce(condition_code_start,'-') as condition_code_start,
        coalesce(condition_code_end,'-') as condition_code_end,
		adults_n, 
		juveniles_n,
		interact_desc

FROM	obsv.trip ot 
                inner join [obsv].[gen2interactions]g2 on ot.obstrip_id = g2.obstrip_id
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join ref.species sp on g2.sp_code = sp.sp_code
				left outer join  obsv.s_day sd on ot.obstrip_id = sd.obstrip_id and interact_date = sd.start_date
				left outer join  obsv.s_daylog sa on sd.s_day_id = sa.s_day_id  and LEFT(interact_start_time,2) = LEFT(act_time,2) and s_activ_id = 1
WHERE YEAR(interact_date) = coalesce(:year,year(interact_date)) 
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp_cat_code in ('MAM','SHK','TTX','BRD')",NA
"292","397874e2-9ed7-4673-941c-ae8ea024c67c"," PURSE SEINE - Logsheet Coverage in EEZ - SUMMARY (by FLAG)","year",NA,"Logsheets,VMS",NA,NA,"1.1.4",3053,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, CoverageMissingData, MyEEZ","2024-08-22T14:31:30.307","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
        /*INNER JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)*/
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND	COALESCE(:year, eez.year)=eez.year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND	ve.gear='S'
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND	s_activity_id=1
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id 

SELECT COALESCE(mt.year,e.year) year,COALESCE(mt.flag_id,e.flag_id) flag_code, CONVERT(DECIMAL(5,2),COALESCE(nb_days,0)*100/(COALESCE(nb_days,0)+COALESCE(day_fishing,0))) cov
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year",NA
"293","c99057bd-baab-4216-8f29-a7503d4a59dd"," LONGLINE - Missing Logsheets in EEZ","flag_code, year","Using VMS data, lists the logsheet that you should see and not entered yet in TUFMAN2","Logsheets,VMS",NA,NA,"1.2.1",3018,"andrewh@spc.int","eparamal@spc.int","Logsheet, Longline, CoverageMissingData, MyEEZ","2024-11-28T14:02:09.15","SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ll l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                        INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
                              (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                              OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                              OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                              OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
                        )
			) t 

SELECT  vi.vesselname vessel_name, vi.flag_id flag_code, vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing 
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
        INNER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
		INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		ve.gear='L'
AND		COALESCE(:flag_code,vi.flag_id)=vi.flag_id
AND		COALESCE(:year, eez.year)=eez.year
GROUP BY vi.vesselname,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"294","94f4c612-c6de-4bd6-b5e5-ce7d3abf9fd9"," Purse Seine - Set level breakdown of BY-CATCH","year",NA,"Observer",NA,"Observer","24",3132,"andrewh@spc.int","andrewh@spc.int","Observer, Purseseine, Custom","2022-08-18T12:00:09.73"," SELECT 	ot.obstrip_id,
		v.vesselname,
		set_number,
		CONVERT(VARCHAR(10), act_date, 103) as set_date,
		act_time as set_time,
		latd as lat,
		lond as lon,
		eez_code as eez_code,
		coalesce(s_activ_id,0) as activity_code,
		coalesce(schas_id,20)-20 as sch_ass_code,
		coalesce(deton_id,29)-29 as sch_detect_code,
		coalesce(sp_code,'-') as sp_code,
		coalesce(fate_code,'-') as fate_code, 
		coalesce(obs_n,0) as obs_no, 
		coalesce(obs_mt,0) as obs_mt, 
		coalesce(sp_n_est,0) as est_no,
		coalesce(sp_c_est,0) as est_mt
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))",NA
"295","24d3f096-64bc-40e2-8061-3c722553f876"," Part1 - Annual PURSE SEINE catch and effort estimates by FLEET in the Home EEZ (national waters)","year","Annual PURSE SEINE catch and effort estimates by FLEET in the Home EEZ (national waters)","Logsheets",NA,"Live","11b",2912,"andrewh@spc.int","benoitp@spc.int","Logsheet, Purseseine, CMM","2022-04-29T12:40:42.82"," SELECT  vi.flag_id flag_code,
        COUNT(distinct t.vessel_id) as vessels,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt else 000.0 end) as decimal(9,3))           AS skj_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt else 000.0 end)  as decimal(9,3))             AS yft_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt else 000.0 end) as decimal(9,3))             AS bet_mt, 
        cast(Sum(sp_mt) as decimal(9,3))  AS tot_mt 
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate))  
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id",NA
"296","d916c561-f98f-421e-83cc-90081a74c2aa"," Vessel (LL) Gear Report by Trip","min_year, max_year","Report created for FIJI showing the list of gear per vessel per trip","Observer",NA,"Observer","12a",2978,"andrewh@spc.int","colleyf@spc.int","Observer","2022-02-03T10:35:22.043","with avge (tripno, vesselname, float_length, branch_length, hk_bt_flt)
as (select t.tripno, 
		vesselname,
		AVG(s.float_length) as float_length,
		AVG(s.branch_length) as branch_length,
		AVG(s.hk_bt_flt) as hk_bt_flt
		from obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
		inner join obsv.l_set s on s.obstrip_id = t.obstrip_id
		group by t.tripno, vesselname) select t.tripno tripno,
		v.vesselname,
		g.mlinehaul_ans,
		g.blinehaul_ans,
		g.lshoot_ans,
		g.baitthr_ans,
		g.branchatt_ans,
		g.weightsca_ans,
		g.mline_mat,
		(coalesce(g.bline_mat1, '') + ' ' + coalesce(g.bline_mat2, '') + ' ' + coalesce(g.bline_mat3, '')) as blinemats,
		coalesce(g.hkscircle_perc, 0) as circlehook,
		coalesce(g.hksj_perc,0) as jhook,
		coalesce(g.hksjapan_perc,0) as japhook,
		coalesce(g.hksoth_perc,0) as othhook,
		coalesce(a.branch_length, 0) as avg_branch_length,
		coalesce(a.float_length, 0) as avg_float_length,
		coalesce(a.hk_bt_flt, 0) as avg_hk_bt_flt	
from obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.l_gear g on g.obstrip_id = t.obstrip_id
		inner join avge a on (a.tripno = t.tripno and a.vesselname = v.vesselname)
where YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))",NA
"297","4c49a4f3-a7e3-404f-a983-37597557dd7a"," CMM 19-03 – North Pacific Albacore catches by National Fleet","year","All CCMs shall report annually to the WCPFC Commission all catches of albacore north of the equator and all fishing effort north of the equator in fisheries directed at albacore (which is interpreted to be ALBACORE TARGET and so north of 20°N). The reports for both catch and fishing effort shall be made by gear type. Catches shall be reported in terms of weight. Fishing effort shall be reported in terms of the most relevant measures for a given gear type, including at a minimum for all gear types, the number of vessel-days fished.*
[* footnote 1: The first such report shall be due on April 30th, 2006 and shall cover calendar year 2004. Small Island Developing States will make their best efforts to comply with this first reporting deadline.]","Logsheets",NA,NA,"20",2916,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, Tuna","2022-01-06T10:38:19.777"," SELECT  
		'L' as gear,
		vi.flag_id as flag, 
		year(logdate) as yr,
        count(distinct case when left(lat,2) >= '20' then CAST(t.vessel_id as varchar(50)) else null end) as vess_num_targ,
        count(distinct case when left(lat,2) >= '20' then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as vess_days_targ,
        SUM(case when c.sp_code = 'ALB' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n_targ,
        cast(SUM(case when c.sp_code = 'ALB' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt_targ,
        count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as vess_num,
        count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as vess_days,
        SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n,
        cast(SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-10
    AND vi.flag_id = @@entity
	and right(lat,1) = 'N'
group by vi.flag_id, year(logdate)",NA
"298","ce2e52ce-5da3-4fc0-80fb-eae457de4519"," Part1 - Figure 1 - PURSE SEINE - Annual catch and effort by primary species and gear in the WCPFC Convention Area","","PART 1 REPORT (Essential Information 1) - Annual catch and effort estimates for the NATIONAL PURSE SEINE FLEET, in the WCPFC Convention Area","Logsheets",1,"Live","2b",3063,"andrewh@spc.int","benoitp@spc.int","Logsheet, Purseseine, CMM","2024-08-21T12:21:37.323"," SELECT YY as YR,
    sum(case when SP_CODE ='ALB' then SP_MT    else 0 end) as ALB,
    sum(case when SP_CODE ='YFT' then SP_MT    else 0 end) as YFT,
    sum(case when SP_CODE ='BET' then SP_MT    else 0 end) as BET,
    sum(case when SP_CODE ='SKJ' then SP_MT    else 0 end) as SKJ,
    sum(case when SP_CODE ='PBF' then SP_MT    else 0 end) as PBF,
    sum(case when SP_CODE in ('BLM','BUM','MLS','SWO') then SP_MT    else 0 end) as BILL,
    sum(case when SP_CODE  in ('BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM') then SP_MT    else 0 end) as SHK
FROM [WCPFC_YEARBOOK].[dbo].[A_ACE] YB_H inner join WCPFC_YEARBOOK.dbo.A_ACE_CATCH YB_C on YB_H.ACE_ID = YB_C.ACE_ID
WHERE GEAR_CODE COLLATE DATABASE_DEFAULT = 'S'
    AND (@@entity = 'HIVE' OR FLAG_CODE COLLATE DATABASE_DEFAULT = @@entity )
    and YY >= YEAR(GETDATE())-1-4 
    and OCEAN_CODE = 'WX'
GROUP BY YY
UNION
SELECT  year(logdate) as YR,
        sum(case when c.sp_code = 'ALB' then sp_mt else 0000 end)  as alb, 
        sum(case when c.sp_code = 'YFT' then sp_mt else 0000 end)  as yft, 
        sum(case when c.sp_code = 'BET' then sp_mt else 0000 end)  as bet, 
        sum(case when c.sp_code = 'SKJ' then sp_mt else 0000 end)  as skj,
        sum(case when c.sp_code = 'PBF' then sp_mt else 0000 end)  as pbf,
        sum(case when c.sp_code in ('BLM','BUM','MLS','SWO') then sp_mt else 0000 end)  as bill, 
        sum(case when c.sp_code in ('BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM') then sp_mt else 0000 end)  as SHK
FROM   log.trips_ps l inner join ref.vessel_instances vi 
					on l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id COLLATE DATABASE_DEFAULT = @@entity)
					INNER JOIN ref.vessels v	ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.sets_ps s	ON l.log_trip_id = s.log_trip_id
					INNER JOIN log.catch_ps c	ON c.log_set_id = s.log_set_id
WHERE year(logdate) = YEAR(GETDATE())-1
  and c.sp_code in ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
group by year(logdate)",NA
"299","11cb37e9-00f3-47b5-838c-c8ac4c0ab8a9"," LONGLINE - All species catch and effort - BY VESSEL FLAG AND EEZ","flag_code, year","BY FLAG - All Species Catch and Effort by EEZ","Logsheets",NA,NA,"12",2892,"andrewh@spc.int","colleyf@spc.int","Logsheet, Longline, MyEEZ, AllSpecies","2025-10-21T05:52:44.233"," SELECT  vi.flag_id flag_code, vi.vesselname,
		:group_by, 
		sp.sp_name,
		cast(Sum(sp_kg_est*1.000) / 1000				as decimal(9,3))	AS sp_mt, 
		cast(Sum(sp_kg_est*1.000) / max(tmp.hhooks)		as decimal(9,4))	AS sp_cpue, 
		cast(Sum(sp_n_est)								as decimal(9,0))	AS sp_n, 
		cast(Sum(sp_n_est*1.0000)  / max(tmp.hhooks)			as decimal(9,4))	AS sp_npue,
SUM(spdiscard_n) spdiscard_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					inner join ref.species sp on c.sp_code = sp.sp_code
					inner join (SELECT		vi.flag_id,
											vi.vesselname  as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
								WHERE	year(logdate) 	= coalesce(:year, year(logdate)) 
									and vi.flag_id		= coalesce(:flag_code,vi.flag_id)
									and (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
								group by vi.flag_id,vi.vesselname) tmp on tmp.flag_id = vi.flag_id and tmp.key1 = vi.vesselname
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and vi.flag_id	= coalesce(:flag_code,vi.flag_id)
  AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by vi.flag_id, vi.vesselname,
		:group_by,
		sp.sp_name","YearMonth"
"300","24e34bfe-4a7f-43f5-8695-9d305e5b95f4"," Part1 - Table 1/Figure 1 - POLE AND LINE - Annual catch and effort by primary species and gear in the WCPFC Convention Area","","PART 1 REPORT (Essential Information 1) - Annual catch and effort estimates for the NATIONAL POLE AND LINE FLEET, in the WCPFC Convention Area","Logsheets",1,"Live","1c",2972,"andrewh@spc.int","benoitp@spc.int","Logsheet, CMM","2025-02-13T14:56:11.077"," SELECT YY as YEAR,
    sum(case when SP_CODE ='SKJ' then SP_MT    else 0 end) as SKJ,
	sum(case when SP_CODE ='YFT' then SP_MT    else 0 end) as YFT,
    sum(case when SP_CODE ='BET' then SP_MT    else 0 end) as BET
FROM [WCPFC_YEARBOOK].[dbo].[A_ACE] YB_H inner join WCPFC_YEARBOOK.dbo.A_ACE_CATCH YB_C on YB_H.ACE_ID = YB_C.ACE_ID
WHERE GEAR_CODE COLLATE DATABASE_DEFAULT = 'P'
AND (@@entity = 'HIVE' OR FLAG_CODE COLLATE DATABASE_DEFAULT = @@entity)
    and YY >= YEAR(GETDATE())-1-4 
    and OCEAN_CODE = 'WX'
GROUP BY YY
UNION
SELECT  year(logdate) as YR,
		cast(sum(case when c.sp_code = 'SKJ' then sp_mt else 0000 end) as int)  as skj, 
        cast(sum(case when c.sp_code = 'YFT' then sp_mt else 0000 end) as int)  as yft, 
        cast(sum(case when c.sp_code = 'BET' then sp_mt else 0000 end) as int)  as bet  
FROM log.trips_pl t inner join log.sets_pl s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_pl c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity) 
WHERE year(logdate) > (Select max(YY) from [WCPFC_YEARBOOK].[dbo].[A_ACE]) 
  and c.sp_code in ('YFT','BET','SKJ') 
group by year(logdate)",NA
"301","265aefbe-b830-4b60-9c35-ca1c1edb67c9"," COVERAGE: Longline Observer Coverage","flag_code, year","Longline observer coverage for part 1 reports. This is to allow countries to report against the 5% observer coverage requirement on longline vessels","Observer,VMS",NA,"Live","50",2986,"andrewh@spc.int","emmanuels@spc.int","Observer, Longline, CoverageMissingData","2025-04-11T14:30:18.033","SELECT flag_id as vessel_flag,
	gear as gear_code,
	[year],
	COUNT(distinct vt.vms_trip_id) as vms_trips,
	SUM(vd.day_fishing) as days_fishing,
	SUM(vd.day_at_sea) as days_at_sea
INTO #mapped_vms_trip
FROM vms.vms_trips vt 
		inner join vms.[vms_trip_efforts] vd on  vt.[vms_trip_id] = vd.[vms_trip_id]
		inner join ref.vessel_instances vi on vt.vessel_id = vi.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.vessels v on vt.vessel_id = v.vessel_id
where gear = 'L'
 and eez_code <> 'IW'
 and ( year(vt.departure_date) = :year or year(vt.return_date) = :year or ( year(vt.departure_date) < :year and year(vt.return_date) > :year) ) 
 and flag_id = coalesce(:flag_code,flag_id)
group by flag_id,
	gear,
	[year]
	
	 select
	c.vessel_flag,
	c.vms_trips as trips_est,
	ISNULL(obs.obs_trips,0) as obs_trips,
	ISNULL(ROUND(obs.obs_trips*1.0 / c.vms_trips * 100.0,1),0) as trip_cov,
	ISNULL(trip_processed,0) as obs_trips_proc,
	ISNULL(ROUND(trip_processed*1.0 / c.vms_trips *100,1),0) trip_proc_cov,
	ROUND(c.days_at_sea,0) days_at_sea,
	ROUND(c.days_fishing,0) days_fishing,
	ISNULL(obs_sea_days,0) as obs_sea_days,
	ISNULL(ROUND(obs_sea_days*1.0 / c.days_at_sea *100,1),0) sea_cov,
	ISNULL(obs_fish_days,0) as obs_fish_days,
	ISNULL(ROUND(obs_fish_days*1.0 / c.days_fishing *100,1),0) fishday_cov,
       hks_obsv
from (
	select 
		v.flag_id,
		count( obstrip_id) as obs_trips,
		SUM(case when data_status in (263,264) then 1 else 0 end) as trip_processed,
        sum(datediff(dd,case when year(dep_date) < :year then cast(cast(:year as char(4))+'-01-01' as datetime) else dep_date end,
						case when year(ret_date) > :year then cast(cast(:year as char(4))+'-12-31' as datetime) else ret_date end)+1) as obs_sea_days,
 		max(x.fish_days) as obs_fish_days,
               max(hks_obsv) as hks_obsv
	FROM obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
		left outer join 
		(
		select 
			v.flag_id,
			count(distinct case when year(set_date) = :year then ls.l_set_id else null end) as fish_days ,
                       sum(hook_observed) as hks_obsv
		FROM obsv.trip t 
			inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date			
			inner join obsv.l_set ls on t.obstrip_id = ls.obstrip_id
		WHERE obsprg_code not like '%EM' 
			and gear_code = 'L'
			and v.flag_id = coalesce(:flag_code,v.flag_id)
			and ( year(dep_date) = :year or year(ret_date) = :year or ( year(dep_date) < :year and year(ret_date) > :year) ) 
		group by v.flag_id ) x on x.flag_id = v.flag_id
	WHERE obsprg_code not like '%EM'
		and gear_code = 'L'
		and v.flag_id = coalesce(:flag_code,v.flag_id)
		and ( year(dep_date) = coalesce(:year,year(dep_date)) or year(ret_date) = coalesce(:year,year(ret_date)) or ( year(dep_date) < coalesce(:year,year(dep_date)) and year(ret_date) > coalesce(:year,year(ret_date))) ) 
	group by t.gear_code,v.flag_id) obs
right join #mapped_vms_trip c on c.vessel_flag=obs.flag_id
where c.year=coalesce(:year, c.year) 
	and c.vessel_flag = coalesce(:flag_code,c.vessel_flag)
	AND c.gear_code = 'L'",NA
"302","3373218c-e30d-4c35-81a2-0bd738cfaba1"," PURSE SEINE - Vessel catch by set - National fleet","year",NA,"Logsheets",NA,NA,"3",2898,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, ByVessel, Raised, RegionalReporting","2021-09-28T14:21:37.547"," SELECT  vi.vesselname vessel_name,
		convert(nvarchar(10),case when depart_date is null then first_logdate else depart_date end, 103)  as departure_date, 
		convert(nvarchar(10),case when return_date is null then last_logdate else return_date end, 103)  as return_date,
		convert(nvarchar(10),logdate, 103) as set_date, 
		lat latitude,
		lon longitude,
		eez_code,
		Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) AS skj_mt, 
		Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) AS bet_mt, 
		Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end) AS yft_mt, 
		Sum(sp_mt_est) AS tot_mt		
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND	( @@entity = 'HIVE' OR vi.flag_id = @@entity )
WHERE year(logdate) = coalesce(:year, year(logdate))
GROUP BY vi.vesselname,
		 convert(nvarchar(10),case when depart_date is null then first_logdate else depart_date end, 103), 
		 convert(nvarchar(10),case when return_date is null then last_logdate else return_date end, 103),
		 convert(nvarchar(10),logdate, 103), 
		 lat,
		 lon,
		 eez_code",NA
"303","0fdd3e47-b799-42c9-97fc-b24100a9c8c5"," Part1 - Figure 3 - Map - PURSE SEINE NATIONAL FLEET catch in the WCPFC Convention Area","year","Map - NATIONAL PURSE SEINE FLEET catch in the WCPFC Convention Area","Logsheets",2,NA,"8b",2909,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, CMM","2021-10-07T13:40:51.6"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(case sp_code when 'SKJ' then COALESCE(sp_mt_est,0) else 0000 end)				AS skj_c,  
		Sum(case sp_code when 'YFT' then COALESCE(sp_mt_est,0) else 0000 end) 				AS yft_c,
		Sum(case sp_code when 'BET' then COALESCE(sp_mt_est,0) else 0000 end) 				AS bet_c
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id 
   		INNER JOIN log.catch_ps c ON s.log_set_id = c.log_set_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate))
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		ref.GetLatDfromLat(lat) IS NOT NULL
AND		ref.GetLonD360fromLon(lon) IS NOT NULL
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"304","819c251e-e776-4917-a9fa-1a1315df6d64"," Vessel Electronics Report by Trip","min_year, max_year","Report created for FIJI showing the list of electronic devices per vessel per trip","Observer",NA,"Observer","11",2977,"andrewh@spc.int","colleyf@spc.int","Observer","2022-03-23T04:50:30.837"," select tripno,
		v.vesselname,
		cast(Sum(case RTRIM(m.device_cat) when 'GPS' then 1 else 0.00 end) as INTEGER) as gps,
		cast(Sum(case RTRIM(m.device_cat) when 'Track Plotter' then 1 else 0.00 end) as INTEGER) as track,
		cast(Sum(case RTRIM(m.device_cat) when 'Depth Sounder' then 1 else 0.00 end) as INTEGER) as sounder,
		cast(Sum(case RTRIM(m.device_cat) when 'Sea Surface Temperature Gauge' then 1 else 0.00 end) as INTEGER) as sst,
		cast(Sum(case RTRIM(m.device_cat) when 'Sonar' then 1 else 0.00 end) as INTEGER) as sonar,
		cast(Sum(case RTRIM(m.device_cat) when 'Echo Sounding Buoy' then 1 else 0.00 end) as INTEGER) as Echo_Sounding_Buoy,
		cast(Sum(case RTRIM(m.device_cat) when 'Radio Direction Finder' then 1 else 0.00 end) as INTEGER) as radio_direction,
		cast(Sum(case RTRIM(m.device_cat) when 'GPS Beacon' then 1 else 0.00 end) as INTEGER) as gps_beacon,
		cast(Sum(case RTRIM(m.device_cat) when 'Doppler Current Meter' then 1 else 0.00 end) as INTEGER) as doppler,
		cast(Sum(case RTRIM(m.device_cat) when 'Bathythermograph' then 1 else 0.00 end) as INTEGER) as XBT,
		cast(Sum(case when RTRIM(m.device_cat) IN ('Satellite / HF Telex','Telephone / Facsimile') then 1 else 0.00 end) as INTEGER) as Satellite_Comm_Services,
		cast(Sum(case RTRIM(m.device_cat) when 'Fishery Information Services' then 1 else 0.00 end) as INTEGER) as Fishery_Information_Services,            
		cast(Sum(case RTRIM(m.device_cat) when 'VMS' then 1 else 0.00 end) as INTEGER) as FFA_VMS
from obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
		inner join obsv.vess_electronics_detail e on e.obstrip_id = t.obstrip_id
		inner join ref_static.marine_devices m on m.device_id = e.device_id
where
		YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
group by tripno, v.vesselname",NA
"305","12f61a9f-5b4c-4f93-a315-4330e44944b4","LONGLINE - NATIONAL FLEET Vessel Trip Catch by set ","year",NA,"Logsheets",NA,NA,"3",2889,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Raised, RegionalReporting, Tuna","2021-11-09T13:50:26.51"," SELECT  vi.vesselname vessel_name,
		convert(nvarchar(10),case when depart_date is null then first_logdate else depart_date end, 103)  as departure_date, 
		convert(nvarchar(10),case when return_date is null then last_logdate else return_date end, 103)  as return_date,
		convert(nvarchar(10),logdate, 103) as log_date, 
		ref.getLatDfromLat(lat) as latitude,
        ref.getLonDfromLon(lon) as longitude,
		eez_code, 
		hooks_n num_hooks,  
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / 1000.0 				as decimal(5,1))	AS alb_mt, 
		cast(Sum(case sp_code when 'ALB' then sp_kg_est else 000.0 end) / (hooks_n/100)			as decimal(6,2))	AS alb_cpue, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 0 end)							as decimal(7,0))	AS alb_n, 
		cast(Sum(case sp_code when 'ALB' then sp_n_est else 000.0 end)  / (hooks_n/100)				as decimal(6,2))	AS alb_npue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) /1000.0 				as decimal(5,1))	AS bet_mt, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_kg_est else 000.0 end) / (hooks_n/100)	   		as decimal(6,2)) 	AS bet_cpue, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 0 end)							as decimal(7,0))	AS bet_n, 
		cast(Sum(case when sp_code in ('BET','BE0') then sp_n_est else 000.0 end)  / (hooks_n/100)				as decimal(6,2))	AS bet_npue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) /1000.0				as decimal(5,1))	AS yft_mt, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_kg_est else 000.0 end) / (hooks_n/100)				as decimal(6,2))	AS yft_cpue, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 0 end)							as decimal(7,0))	AS yft_n, 
		cast(Sum(case when sp_code in ('YFT','YF0') then sp_n_est else 000.0 end)  / (hooks_n/100)		as decimal(6,2))	AS yft_npue, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 000.0 when 'BE0' then 000.0 else sp_kg_est end)/1000.0 as decimal(5,1)) AS oth_mt, 
		cast(Sum(case sp_code when 'YFT' then 0 when 'YF0' then 0 when 'ALB' then 0 when 'BET' then 0 when 'BE0' then 0 else sp_n_est end) as decimal(7,0))			AS oth_n, 
		cast(Sum(sp_kg_est) /1000.0  														as decimal(5,1)) 	AS tot_mt, 
		cast(Sum(sp_n_est)         															as decimal(7,0))	AS tot_n 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND	vi.flag_id = @@entity 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
group by vi.vesselname,
		convert(nvarchar(10),case when depart_date is null then first_logdate else depart_date end, 103), 
		convert(nvarchar(10),case when return_date is null then last_logdate else return_date end, 103),
		convert(nvarchar(10),logdate, 103), 
		ref.getLatDfromLat(lat),
        ref.getLonDfromLon(lon),
		eez_code, 
		hooks_n",NA
"306","e77c9e11-594c-4516-a0a0-6d2e0769d8d6"," CMM 06-04 – South-west Striped Marlin catches by National Fleet","flag_code, year","In accordance with paragraph 1, CCMs shall provide information to the Commission, by 1 July 2007, on the number of their vessels that have fished for striped marlin in the Convention area south of 15°S, during the period 2000 – 2004, and in doing so, nominate the maximum number of vessels that shall continue to be permitted to fish for striped marlin in the area south of 15°S. CCMs shall report annually to the Commission the catch levels of their fishing vessels that have taken striped marlin as a bycatch as well as the number and catch levels of vessels fishing for striped marlin in the Convention Area south of 15°S.","Logsheets",NA,NA,"21",2917,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2022-04-05T07:04:36.913"," SELECT  vi.flag_id as flag, 
		year(logdate) as yr,
		COUNT(distinct case when RIGHT(lat,1) = 'S' and left(lat,2) >= '15' then t.vessel_id else null end) as vessels,
		SUM(case when c.sp_code = 'MLS' and RIGHT(lat,1) = 'S' and left(lat,2) >= '15' then coalesce(sp_n_est,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'MLS' and RIGHT(lat,1) = 'S' and left(lat,2) >= '15' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
group by vi.flag_id, year(logdate)",NA
"307","5738498b-dbd3-447a-8eba-aad601023bc7"," LONGLINE - Northern Committee - Pacific Bluefin CMM reporting -- Table 2","","Requested by Vanuatu - Gives the pacific bluefin catch by flag for the area North of 20 degrees. The report has to be classified into < 30kg fish and > 30kg fish h","Logsheets",NA,NA,"15",3329,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM, Tuna","2021-10-06T14:29:08.143"," SELECT  year(logdate) as year,
		case when (coalesce(sp_kg_est,sp_kg) / coalesce(sp_n_est,sp_n)) >= 30 then '>= 30 kgs' else '< 30 kgs' end as size_class, 
		SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_n_est,sp_n) else 0000 end) as sp_n,
		cast(SUM(case when c.sp_code = 'PBF' and RIGHT(lat,1) = 'N' and left(lat,2) >= '20' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as sp_c_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and RIGHT(lat,1) = 'N' 
and left(lat,2) >= '20' 
and c.sp_code = 'PBF'
and coalesce(sp_n_est,sp_n) > 0
group by  year(logdate),
			case when (coalesce(sp_kg_est,sp_kg) / coalesce(sp_n_est,sp_n)) >= 30 then '>= 30 kgs' else '< 30 kgs' end",NA
"308","f2c7cb9c-ca7c-4211-a985-472dc1a7e955"," LONGLINE - Logsheet in WCPFC Area - Full reconciliation - NATIONAL FLEET","year",NA,"Logsheets,VMS",NA,NA,"2.2.2",3055,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData, RegionalReporting","2023-02-01T13:13:55.617","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ll l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND		:year between YEAR(vi.start_date) and YEAR(vi.calculated_end_date)
	AND     day_fishing>1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
	ORDER BY vi.vesselname,departure_date
	 
SELECT vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id LonglineLogsheetDTO 
from #mapped_trip",NA
"309","de6e807a-dd07-47f2-b97b-c8aaaafaa4c6"," LONGLINE - logsheet in EEZ - Full reconciliation","flag_code, year",NA,"Logsheets,VMS",NA,NA,"1.2.3",3056,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData, MyEEZ","2022-11-09T06:41:21.68","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ll l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date
	 
select vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id LonglineLogsheetDTO 
from #mapped_trip",NA
"310","a692a647-0817-4d50-be8c-a9f2008de9af"," Annual Aggregate Species Composition: EMonitoring vs Observer","year",NA,"Observer",1,"Observer","3c",3296,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T10:54:18.82"," select COALESCE(x.sp_name,y.sp_name) COLLATE DATABASE_DEFAULT as sp_name,COALESCE(x.sp_code,y.sp_code) COLLATE DATABASE_DEFAULT  as sp_code, x.EM_count,y.OB_count from (
select sp.sp_name,sc.sp_code, count(sc.sp_code) as EM_count
from em.trip et
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
			and et.dep_date between vi.start_date and vi.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=vi.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join em.l_set s on et.obstrip_id=s.obstrip_id
inner join em.l_setcatch sc on sc.l_set_id=s.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
inner join ref.countries rc on rc.country_code=vi.flag_id COLLATE DATABASE_DEFAULT
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name
) x
FULL OUTER JOIN (
select sp.sp_name,sc.sp_code, count(sc.sp_code) as OB_count
from em.trip et
inner join ref.vessel_instances rv on rv.vessel_id=et.vessel_id
	and et.dep_date between rv.start_date and rv.calculated_end_date
inner join obsv.trip ot on ot.vessel_id=rv.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join obsv.l_set s on s.obstrip_id=ot.obstrip_id
inner join obsv.l_setcatch sc on sc.l_set_id=s.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where coalesce(:year,year(et.dep_date))=year(et.dep_date)
group by sc.sp_code, sp.sp_name
) y on y.sp_code=x.sp_code COLLATE DATABASE_DEFAULT",NA
"311","11983566-74aa-4330-88ba-12e3be70c165"," Fish, Bunkering  and Other Transfers Logs by Action Codes (GEN-1)","obsv_prg",NA,"Observer",NA,"Observer","6",2925,"andrewh@spc.int","colleyf@spc.int","Observer","2022-11-15T10:39:29.54"," SELECT a.prg as obsprg_code,
a.yr as trip_year, 
a.gr as gear_code,
a.eez_code,
SUM(a.cnt) as total_cnt,
SUM(a.BG) as BG,
SUM(a.BR) as BR,
SUM(a.DF) as DF,
SUM(a.FI) as FI,
SUM(a.NF) as NF,
SUM(a.OG) as OG,
SUM(a.[OR]) as [OR],
SUM(a.PF) as PF,
SUM(a.SG) as SG,
SUM(a.SR) as SR,
SUM(a.TG) as TG,
SUM(a.TR) as TR
FROM
(SELECT 
DATEPART(yyyy,t.dep_date) as yr
,t.obsprg_code as prg
,t.gear_code as gr
,g.eez_code
, CASE WHEN g.action_code is not null then count(g.action_code) ELSE 0 END cnt
, CASE WHEN g.action_code = 'BG' THEN COUNT(g.action_code) ELSE 0 END AS BG
, CASE WHEN g.action_code = 'BR' THEN COUNT(g.action_code) ELSE 0 END AS BR
, CASE WHEN g.action_code = 'DF' THEN COUNT(g.action_code) ELSE 0 END AS DF
, CASE WHEN g.action_code = 'FI' THEN COUNT(g.action_code) ELSE 0 END AS FI
, CASE WHEN g.action_code = 'NF' THEN COUNT(g.action_code) ELSE 0 END AS NF
, CASE WHEN g.action_code = 'OG' THEN COUNT(g.action_code) ELSE 0 END AS OG
, CASE WHEN g.action_code = 'OR' THEN COUNT(g.action_code) ELSE 0 END AS [OR]
, CASE WHEN g.action_code = 'PF' THEN COUNT(g.action_code) ELSE 0 END AS PF
, CASE WHEN g.action_code = 'SG' THEN COUNT(g.action_code) ELSE 0 END AS SG
, CASE WHEN g.action_code = 'SR' THEN COUNT(g.action_code) ELSE 0 END AS SR
, CASE WHEN g.action_code = 'TG' THEN COUNT(g.action_code) ELSE 0 END AS TG
, CASE WHEN g.action_code = 'TR' THEN COUNT(g.action_code) ELSE 0 END AS TR
FROM obsv.gen1fishtransfer g INNER JOIN obsv.trip t
ON g.obstrip_id = t.obstrip_id
group by g.action_code,t.dep_date,t.obsprg_code, t.gear_code,g.eez_code)a
WHERE a.prg = coalesce(:obsv_prg,a.prg)
GROUP BY a.yr, a.prg, a.gr,a.eez_code",NA
"312","ea6b1fbb-a699-4e83-80ed-0fab52012d57"," LONGLINE - All Species Catch and Effort for WCPFC Area - National fleet","year",NA,"Logsheets",NA,NA,"31",3071,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, RegionalReporting, AllSpecies","2021-10-06T11:32:14.943"," SELECT  
		:group_by, 
		sp.sp_name,
		cast(Sum(sp_kg_est*1.000) / 1000				as decimal(8,3))	AS sp_mt, 
		cast(Sum(sp_kg_est*1.000) / max(tmp.hhooks)		as decimal(7,4))	AS sp_cpue, 
		cast(Sum(sp_n_est)								as decimal(7,0))	AS sp_n, 
		cast(Sum(sp_n_est*1.0000)  / max(tmp.hhooks)			as decimal(7,4))	AS sp_npue,
SUM(spdiscard_n) spdiscard_n
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					inner join ref.species sp on c.sp_code = sp.sp_code
					inner join (SELECT													:group_by  as key1, 
											SUM(hooks_n)/100 as hhooks  
								FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
													inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
								WHERE	year(logdate) 	= coalesce(:year, year(logdate)) 
									AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
								group by :group_by) tmp on tmp.key1 = :group_by
WHERE year(logdate) = coalesce(:year, year(logdate)) 
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
  and in_wcpfc_area = 1
group by :group_by,
		sp.sp_name","YearMonth"
"313","52449a41-550b-45f5-b70e-ce33c2042b10"," PURSE SEINE - All Species Catch and Effort - BY FLAG","flag_code, year","BY FLEET - All Species Catch and Effort in the WCPFC Area","Logsheets",NA,NA,"12",2901,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, MyEEZ, AllSpecies","2022-08-17T16:44:17.107"," SELECT  vi.flag_id flag_code, 
		:group_by, 
                c.sizeclass,
		sp.sp_name,
		cast(SUM(coalesce(c.sp_mt_est,000)) as decimal(9,3)) as catch,
        cast(SUM(case when c.sp_code = sp.sp_code then coalesce(c.sp_mt_est,000) else 000.000 end) / coalesce(tmp.fish_days,001) as decimal(9,3)) as cpue_mt_day  
FROM	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		left outer join log.catch_ps c on s.log_set_id = c.log_set_id
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.species sp on sp.sp_code = c.sp_code
		inner join (SELECT	vi.flag_id,
							:group_by as key1,
							COUNT(distinct case when s.s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(s.logdate as date) as varchar(10)) else null end) as fish_days
					FROM	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
							inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
					WHERE	YEAR(logdate)		= coalesce(:year, year(logdate))
							and vi.flag_id		= coalesce(:flag_code,vi.flag_id)
							AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
							and s.s_activity_id in (1,2) 
					group by vi.flag_id, :group_by) tmp on tmp.flag_id = vi.flag_id and tmp.key1 = :group_by
WHERE year(logdate) = coalesce(:year, year(logdate))
  and vi.flag_id	= coalesce(:flag_code, vi.flag_id)
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
  and s.s_activity_id in (1,2) 
group by vi.flag_id,
		:group_by,
		sp.sp_name,
                c.sizeclass,
		tmp.fish_days","Year"
"314","9f792ecc-6cd0-4b3f-b78a-058a9e38fb19"," CMM 07-01 – Observer obstruction reports","flag_code, year, obsv_prg","CMM 2007-01 – Observer obstruction reports","Observer",NA,"Observer","EXTRA",2958,"andrewh@spc.int","colleyf@spc.int","Observer, CMM, RegionalReporting","2025-10-06T16:18:25.93"," SELECT  'T'+tripno as tripno, 
		vesselname,
		flag_id as flag, 
		CONVERT(VARCHAR, dep_date, 106) as depart_date,
                CONVERT(VARCHAR, ret_date, 106) as return_date,
		max(cast(convert( char(8), gen3_date,112) as char(8))) as report_date,
		obsprg_code as programme_code,
		max(case when upper(g.question_code) = 'RS-A' then 'YES' else ' - ' end) as RS_A, 
		max(case when upper(g.question_code) = 'RS-B' then 'YES' else ' - ' end) as RS_B, 
		max(case when upper(g.question_code) = 'RS-D' then 'YES' else ' - ' end) as RS_D, 
		max(cast(gd.comments as char(150))) as comments

FROM obsv.gen3vr09 AS g 
			INNER JOIN obsv.trip AS t ON g.obstrip_id = t.obstrip_id
			inner join ref.field_staff f on f.staff_id=t.observer_id
			inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
			LEFT OUTER join obsv.gen3vr09details gd on g.gen3_id = gd.gen3vr09details_id

WHERE (g.answer = 1)
    AND flag_id = coalesce(:flag_code,flag_id)
	AND YEAR(dep_date) = coalesce(:year,year(dep_date))
    AND t.obsprg_code = COALESCE(:obsv_prg,t.obsprg_code)
	AND upper(g.question_code) in ('RS-A','RS-B','RS-D')

group by staff_code, 
		'T'+tripno, 
		vesselname,
		flag_id, 
		CONVERT(VARCHAR, dep_date, 106),
                CONVERT(VARCHAR, ret_date, 106),
		obsprg_code",NA
"315","3093649f-fadb-4072-90c5-c262a01e962e","PURSE SEINE - Logsheet in WCPFC Area - Full reconciliation - NATIONAL FLEET ","year",NA,"Logsheets,VMS",NA,NA,"2.1.2",3058,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, RegionalReporting","2023-06-05T09:34:37.167","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='S'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ps l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date
	 
SELECT vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id PurseseineLogsheetDTO 
from #mapped_trip",NA
"316","438f8a2b-50f6-4efe-a427-4e472449a7ff"," LONGLINE OBSERVER CATCH MAP","flag_code, year, obsv_prg, trip_id","Produces data used to map LONGLINE OBSERVER CATCH BY SPECIES for use in GIS systems","Observer",2,"Observer"," 5",2932,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-01-19T11:37:35.503"," SELECT 	
		:group_by,
		SUM( case when sp_code = 'ALB' then 00001 else 00000 end) as ALB, 
		SUM( case when sp_code = 'YFT' then 00001 else 00000 end) as YFT, 
		SUM( case when sp_code = 'BET' then 00001 else 00000 end) as BET, 
		SUM( case when sp_code = 'SWO' then 00001 else 00000 end) as SWO, 
		SUM( case when sp_code = 'BUM' then 00001 else 00000 end) as BUM, 
		SUM( case when sp_code = 'BLM' then 00001 else 00000 end) as BLM, 
		SUM( case when sp_code = 'MLS' then 00001 else 00000 end) as MLS 
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join ref.field_staff f on f.staff_id = ot.observer_id
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
WHERE COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno
	AND YEAR(catch_date) = coalesce(:year,year(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
GROUP BY  
		:group_by","Longitude(5x5)MAPINFOLatitude(5x5)MAPINFO"
"317","6345e570-88f4-4375-a4bd-63efc2be6cc5"," CMM 11-04 - OCEANIC WHITETIP shark interactions in Purse seine & Longline fisheries (unraised)","flag_code, year","CCMs shall estimate, through data collected from observer programs and other means, the number of releases of oceanic whitetip shark, including the status upon release (dead or alive), and report this information to the WCPFC in Part 1 of their Annual Reports.

NOTE: THIS MEANS YOU NEED TO PROVIDE A RAISED ESTIMATE FROM THE UNRAISED DATA THAT IS IN THIS REPORT","Observer",NA,"Observer","10",2941,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Purseseine, CMM, Raised, RegionalReporting, Unraised, ByCatch","2022-08-09T11:27:41.63"," SELECT  'S' as gear,   
flag_id as flag,    
sp.sp_name as species,   
CONVERT(VARCHAR(10), act_date, 103) as date,    
lat as lat,    
lon as lon,    
eez_code as eez_code,    
fate_code as fate_code,      
coalesce(cond_code,'-') as caught_cond_code,
coalesce(discard_cond_code,'-') as discard_cond_code,
case WHEN fate_code='DFR' then coalesce(replace(sc.obs_n,0,NULL),sc.sp_n_est) end as Discarded_body_fins_retained,
case WHEN fate_code='RFR' then coalesce(replace(sc.obs_n,0,NULL),sc.sp_n_est) end as Body_fins_retained,  
case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end as Individuals   
FROM obsv.trip ot      
inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date      
inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id      
inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id     
inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id     
inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id     
inner join ref.species sp on sc.sp_code = sp.sp_code 
WHERE YEAR(act_date) = coalesce(:year,year(act_date))  
AND s_activ_id = 1      
AND flag_id = coalesce(:flag_code,flag_id)     
AND sp.sp_code = 'OCS' 

UNION  ALL

SELECT  'L' as gear,    
flag_id as flag,    
sp.sp_name as species,   
CONVERT(VARCHAR(10), sc.catch_date, 103) as date,    
sa.lat as lat,    
sa.lon as lon,    
eez_code as eez_code,    
fate_code as fate_code,      
coalesce(cond_code,'-') as caught_cond_code,
coalesce(cond_code2,'-') as discard_cond_code,
case WHEN fate_code='DFR' then 1 end as Discarded_body_fins_retained,
case WHEN fate_code='RFR' then 1 end as Body_fins_retained,   
1 as Individuals   
FROM obsv.trip ot      
inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date      
inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id      
inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83      
inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id     
inner join ref.species sp on sc.sp_code = sp.sp_code 
WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))     
AND flag_id = coalesce(:flag_code,flag_id)     
AND sp.sp_code = 'OCS'",NA
"318","305fe1c3-6daf-4a1a-9d80-4701d2a85865"," Part1 - Figure 1 - LONGLINE - Annual catch and effort by primary species and gear in the WCPFC Convention Area","","PART 1 REPORT (Essential Information 1) - Annual catch and effort estimates for the NATIONAL LONGLINE FLEET, in the WCPFC Convention Area","Logsheets",1,"Live","2a",3062,"andrewh@spc.int","benoitp@spc.int","Logsheet, Longline, CMM","2024-07-01T15:08:51.71"," SELECT YY as YR,
    sum(case when SP_CODE ='ALB' then SP_MT    else 0 end) as ALB,
    sum(case when SP_CODE ='YFT' then SP_MT    else 0 end) as YFT,
    sum(case when SP_CODE ='BET' then SP_MT    else 0 end) as BET,
    sum(case when SP_CODE ='SKJ' then SP_MT    else 0 end) as SKJ,
    sum(case when SP_CODE ='PBF' then SP_MT    else 0 end) as PBF,
    sum(case when SP_CODE in ('BLM','BUM','MLS','SWO') then SP_MT    else 0 end) as BILL,
    sum(case when SP_CODE  in ('BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM') then SP_MT    else 0 end) as SHK
FROM [WCPFC_YEARBOOK].[dbo].[A_ACE] YB_H inner join WCPFC_YEARBOOK.dbo.A_ACE_CATCH YB_C on YB_H.ACE_ID = YB_C.ACE_ID
WHERE GEAR_CODE COLLATE DATABASE_DEFAULT = 'L'
AND (@@entity = 'HIVE' OR FLAG_CODE COLLATE DATABASE_DEFAULT = @@entity )
    and YY >= YEAR(GETDATE())-1-4 
    and OCEAN_CODE = 'WX'
GROUP BY YY
UNION
SELECT  year(logdate) as YR,
        sum(case when c.sp_code = 'ALB' then sp_kg_est else 0000 end)/1000  as alb, 
        sum(case when c.sp_code = 'YFT' then sp_kg_est else 0000 end)/1000  as yft, 
        sum(case when c.sp_code = 'BET' then sp_kg_est else 0000 end)/1000  as bet, 
        sum(case when c.sp_code = 'SKJ' then sp_kg_est else 0000 end)/1000  as skj,
        sum(case when c.sp_code = 'PBF' then sp_kg_est else 0000 end)/1000  as pbf,
        sum(case when c.sp_code in ('BLM','BUM','MLS','SWO') then sp_kg_est else 0000 end)/1000  as bill, 
        sum(case when c.sp_code in ('BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM') then sp_kg_est else 0000 end)/1000  as SHK
FROM   log.trips_ll l inner join ref.vessel_instances vi 
					on l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id COLLATE DATABASE_DEFAULT = @@entity)
					INNER JOIN ref.vessels v	ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.sets_ll s	ON l.log_trip_id = s.log_trip_id
					INNER JOIN log.catch_ll c	ON c.log_set_id = s.log_set_id
WHERE year(logdate) = YEAR(GETDATE())-1
  and c.sp_code in ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
group by year(logdate)",NA
"319","ac445516-6d68-4c6b-97e1-d0f9b1beef0a"," PURSE SEINE - Logsheet in EEZ - Full reconciliation","flag_code, year",NA,"Logsheets,VMS",NA,NA,"1.1.3",3066,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, CoverageMissingData","2023-03-15T10:38:05.587","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='S'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year AND eez.eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity))
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ps l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date
	 
select vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id PurseseineLogsheetDTO 
from #mapped_trip",NA
"320","d8584632-4460-4f97-97c3-a317817e89de"," Fish, Bunkering and Other Transfers Logs by OBS Trip - (GEN-1)","year, obsv_prg",NA,"Observer",NA,"Observer","5",2933,"andrewh@spc.int","colleyf@spc.int","Observer","2025-10-06T12:03:48.003"," SELECT a.prg as obsprg_code,
a.yr as trip_year, 
a.gr as gear_code, 
a.id as obstrip_id,
a.sc as observer_code,
a.tn as tripno,
SUM(a.cnt) as total_count,
SUM(a.BG) BG,SUM(a.BR) BR,SUM(a.DF) DF,SUM(a.FI) FI,SUM(a.NF) NF,SUM(a.OG) OG,SUM(a.[OR]) [OR],SUM(a.PF) PF,SUM(a.SG) SG,SUM(a.SR) SR,SUM(a.TG) TG,SUM(a.TR) TR
FROM
(SELECT 
 t.obstrip_id as id
 ,staff_code as sc
 ,t.tripno as tn
,DATEPART(yyyy,t.dep_date) as yr
,t.obsprg_code as prg
,t.gear_code as gr
, CASE WHEN g.action_code is not null
  THEN COUNT(g.action_code) ELSE 0 END cnt
, CASE WHEN g.action_code = 'BG' THEN COUNT(g.action_code) ELSE 0 END AS BG
, CASE WHEN g.action_code = 'BR' THEN COUNT(g.action_code) ELSE 0 END AS BR
, CASE WHEN g.action_code = 'DF' THEN COUNT(g.action_code) ELSE 0 END AS DF
, CASE WHEN g.action_code = 'FI' THEN COUNT(g.action_code) ELSE 0 END AS FI
, CASE WHEN g.action_code = 'NF' THEN COUNT(g.action_code) ELSE 0 END AS NF
, CASE WHEN g.action_code = 'OG' THEN COUNT(g.action_code) ELSE 0 END AS OG
, CASE WHEN g.action_code = 'OR' THEN COUNT(g.action_code) ELSE 0 END AS [OR]
, CASE WHEN g.action_code = 'PF' THEN COUNT(g.action_code) ELSE 0 END AS PF
, CASE WHEN g.action_code = 'SG' THEN COUNT(g.action_code) ELSE 0 END AS SG
, CASE WHEN g.action_code = 'SR' THEN COUNT(g.action_code) ELSE 0 END AS SR
, CASE WHEN g.action_code = 'TG' THEN COUNT(g.action_code) ELSE 0 END AS TG
, CASE WHEN g.action_code = 'TR' THEN COUNT(g.action_code) ELSE 0 END AS TR
FROM obsv.gen1fishtransfer g INNER JOIN obsv.trip t ON g.obstrip_id = t.obstrip_id
inner join ref.field_staff f on f.staff_id=t.observer_id
WHERE t.gear_code IN ('S','L')
AND YEAR(t.dep_date) = coalesce(:year,year(dep_date))
AND t.obsprg_code = coalesce(:obsv_prg,t.obsprg_code)
group by g.action_code,t.dep_date,t.obsprg_code, t.gear_code,t.obstrip_id,staff_code,t.tripno
)a
GROUP BY a.yr, a.prg, a.gr,a.id,a.sc,a.tn",NA
"321","adaba656-2726-46f6-b92d-a70600c165eb"," LONGLINE - Whale predation percentage","","Percentage of sets with whale predations","Logsheets",NA,NA,"80",3150,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline","2021-09-14T15:50:25.977"," select YEAR(logdate) as year, 
	sum(case s.is_whale_predation when 1 then 1 else 0 end) as whale_sets,
	sum(case s.is_whale_predation when 0 then 1 else 0 end) as not_whale_sets,
	count(log_set_id) as total_sets
from log.trips_ll t
	inner join log.sets_ll s on s.log_trip_id = t.log_trip_id
	inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
group by YEAR(logdate)",NA
"322","7a4471f7-f313-4f0b-9851-841ad8f8e747"," Part1 - Figure 3 - Map - LONGLINE NATIONAL FLEET catch in the WCPFC Convention Area","year","Map - NATIONAL LONGLINE FLEET catch in the WCPFC Convention Area","Logsheets",2,NA,"8a",2908,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, CMM","2021-10-06T15:03:17.627"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(case sp_code when 'ALB' then sp_kg_est else 0000 end)				AS alb_kg, 
		Sum(case sp_code when 'BET' then sp_kg_est else 0000 end) 				AS bet_kg, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 0000 end) 				AS yft_kg, 
		Sum(case sp_code when 'BLM' then sp_kg_est else 0000 end) 				AS blm_kg, 
		Sum(case sp_code when 'BUM' then sp_kg_est else 0000 end) 				AS bum_kg, 
		Sum(case sp_code when 'MLS' then sp_kg_est else 0000 end) 				AS mls_kg, 
		Sum(case sp_code when 'SWO' then sp_kg_est else 0000 end) 				AS swo_kg 
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
   		INNER JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate)) 
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"323","2c66ad15-5d1a-4b8a-bf9d-a75900f426c9","LONGLINE - Distinct Vessels fishing in WCPFC Area - NATIONAL FLEET ","year","NATIONAL FLEET - List of longline vessels fishing in WCPFC Area - from VMS data","VMS",NA,"Live","2.2.5",3175,"andrewh@spc.int","emmanuels@spc.int","Longline, ByVessel, RegionalReporting","2023-04-18T14:27:46.493","SELECT	DISTINCT vi.vesselname, vi.flag_id INTO #mapped_trip
FROM	vms.vms_trips t JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND return_date >= vi.start_date AND departure_date <= vi.calculated_end_date AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
		JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
		JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year = :year
WHERE	YEAR(vi.start_date) <= :year
AND		YEAR(vi.calculated_end_date) >= :year
AND     day_fishing > 0
ORDER BY vi.vesselname

/*SELECT  distinct vi.vesselname, vi.flag_id INTO #mapped_trip
FROM	vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
		JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND		vi.flag_id=@@entity
ORDER BY vi.vesselname*/ 

select vesselname vessel_name, flag_id flag_code
from #mapped_trip",NA
"324","4af616ff-dc20-4d7f-a492-d251ba9bf1d5"," Part1 - Figure 3 - Map - LONGLINE NATIONAL FLEET effort in the WCPFC Convention Area","year","Map - NATIONAL LONGLINE FLEET effort in the WCPFC Convention Area","Logsheets",2,NA,"9a",3070,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM","2023-04-03T10:54:37.32"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Sum(coalesce(hooks_n, 0))				AS hooks
FROM	log.trips_ll t INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id 
   		INNER JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate)) 
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"325","6d8a29ee-4a88-4cb5-8f95-ec3468671c02"," LONGLINE - Detailed Shark (SHK) CATCH and EFFORT Statistics","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","1a",2934,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-02-22T09:35:00.23"," SELECT 	case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		sum(1) as No,
		SUM(1) / MAX(n) as sp_comp,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		SUM(0001.000) / MAX(hooks) * 1000 as CPUE,
		COUNT(distinct lc.l_set_id) / max(SETS) as freq,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Disc_perc,
		SUM(case when left(cond_code,1) = 'A' then 0001 else 0000 end)  / SUM(case when left(cond_code,1) IN ('A','D') then 0001 else 0000.00000000001 end) as alive_perc,
		SUM(case when left(cond_code,1) <> 'A' then 0001 else 0000 end) / SUM(case when left(cond_code,1) IN ('A','D') then 0001 else 0000.00000000001 end) as dead_perc,
		SUM(case when sex_code = 'M' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as male_perc,
		SUM(case when sex_code = 'F' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as female_perc
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join (SELECT SUM(1)*1.000 as n,
								count(distinct ls.l_set_id)*1.000 as sets
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
						WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
							) tmp on tmp.n > 0		
			inner join (SELECT SUM(coalesce(hook_set,0000.000)) as hooks
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
						WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
							) tmp2 on tmp2.hooks > 0		
WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
	/* AND ot.obstrip_id = coalesce(trip_id,ot.obstrip_id) */
	AND sp.sp_cat_code = 'SHK'
GROUP BY  
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name",NA
"326","cac87d52-9922-46a5-9ed7-a77000a96557"," Part1 - OPTIONAL - Map of PURSE SEINE CATCH in the Home EEZ (national waters) 1x1","year","Map of PURSE SEINE CATCH in the Home EEZ (national waters) in 1x1","Logsheets",2,NA,"98b",3179,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, CMM","2021-10-07T13:37:19.167"," SELECT  floor(ref.GetLatDfromLat(lat)/1)*1+0.5 Latitude,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5 Longitude, 
		Sum(case sp_code when 'SKJ' then sp_mt_est else 0000 end)				AS skj_c, 
		Sum(case sp_code when 'YFT' then sp_mt_est else 0000 end) 				AS yft_c,
		Sum(case sp_code when 'BET' then sp_mt_est else 0000 end) 				AS bet_c 		
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ps c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/1)*1+0.5 ,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5",NA
"327","7d4abff6-fc6c-4d3d-91e0-cd558d3a4e08"," PURSE SEINE - Whale Shark (RHN) Interactions by YEAR","year",NA,"Observer",NA,"Observer","126",3119,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Custom","2022-06-19T18:38:17.283"," select YEAR(act_date) as yr, 
		count(distinct sd.obstrip_id) as trips,
		sum(case when sp_code = 'RHN' then obs_n else 00000 end) as rhn_no 
FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
			inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
			inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
			inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
where year(act_date) = coalesce(:year,year(act_date))		
group  by YEAR(act_date)",NA
"328","54f5e03b-e693-4fd7-a03c-a7a8012a762c"," CMM 22-04 – Silky shark & Oceanic whitetip shark -- RELEASE Life Status estimates (unraised)","flag_code, year","CMM 22-04 – Silky shark & Oceanic whitetip shark -- RELEASE Life Status estimates - report only keeps Discarded fate codes - NOTE: THIS MEANS YOU NEED TO PROVIDE A RAISED ESTIMATE FROM THE UNRAISED DATA THAT IS IN THIS REPORT","Observer",NA,"Observer","13a",3191,"andrewh@spc.int","aurelienp@spc.int","Observer, Longline, Purseseine, CMM, Raised, RegionalReporting, Unraised, ByCatch","2024-04-12T10:35:19.87"," SELECT  'S' as gear,
	v.flag_id as flag,    
	sp.sp_name as species,   
	sum(coalesce(sc.sp_n_est,0)) as unraised_number,
	sum(case LEFT(discard_cond_code,1) when  'D' then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_dead,
	sum(case LEFT(discard_cond_code,1) when  'A' then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_alive,
	sum(case when coalesce(LEFT(discard_cond_code,1),'X') not in ('D','A') then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_unknown,
    sum(case LEFT(discard_cond_code,1) when  'D' then coalesce(sc.sp_n_est,0) else 0000.000 end) / nullif(sum(coalesce(sc.sp_n_est,0)),0) * 100.00 as percent_dead
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
		inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
		inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
	WHERE YEAR(act_date) = coalesce(:year,year(act_date))
		AND s_activ_id = 1
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code IN ('FAL','OCS')
		and left(fate_code,1) = 'D'
	GROUP BY 
		v.flag_id,    
		sp.sp_name
	UNION
	SELECT  'L' as gear,
			v.flag_id as flag,
			sp.sp_name as species,
			sum(1) as unraised_number,
			sum(case left(cond_code2,1) when  'D' then 1.000 else 0000.000 end) as discard_dead,
			sum(case left(cond_code2,1) when  'A' then 1.000 else 0000.000 end) as discard_alive,
			sum(case when coalesce(left(cond_code2,1),'X') not in ('D','A') then 1.000 else 0000.000 end) as discard_unknown,
    sum(case left(cond_code2,1) when  'D' then 1.000 else 0000.000 end) / nullif(sum(1.000),0) *100.00 as percent_dead
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83
		inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
	WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code IN ('FAL','OCS')
		AND left(fate_code,1) = 'D'
	GROUP BY 
		v.flag_id,
			sp.sp_name",NA
"329","87d7db71-deb4-4b94-bb03-2d4ed360330a"," Part1 - Figure X - Map - POLE AND LINE COASTAL STATE REPORT - effort by EEZ","year","Map - ALL POLE AND LINE FLEET effort in EEZ","Logsheets",2,NA,"10c",3141,"andrewh@spc.int","brunod@spc.int","Logsheet, PoleAndLine, CMM","2021-10-11T16:05:52.79"," SELECT  floor(ref.GetLatDfromLat(lat)/5)*5+2.5 Latitude,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5 Longitude, 
		Count(distinct case when (s.p_activity_id in (1,2)) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as days
FROM	log.trips_pl t INNER JOIN log.sets_pl s ON t.log_trip_id = s.log_trip_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate)) 
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
group by floor(ref.GetLatDfromLat(lat)/5)*5+2.5,floor(ref.GetLonD360fromLon(lon)/5)*5+2.5",NA
"330","52a7d663-cf16-4a6e-887c-a7aa00e2b3ef"," COVERAGE: Longline Observer Coverage (ROP-defined trips only) - Under construction","flag_code, year","Longline observer coverage for part 1 reports. This is to allow countries to report against the 5% ROP coverage requirement on longline vessels.  This report is for Pacific Island countries that need to exclude the domestic (non-ROP trips) from the total vessel trips.","Observer,VMS",NA,NA,"50a",3195,"andrewh@spc.int","andrewh@spc.int","Observer, Longline, CoverageMissingData","2024-06-11T15:45:20.36","SELECT flag_id as vessel_flag,
	gear as gear_code,
	[year],
	COUNT(distinct vt.vms_trip_id) as vms_trips,
	SUM(vd.day_fishing) as days_fishing,
	SUM(vd.day_at_sea) as days_at_sea
INTO #mapped_vms_trip
FROM vms.vms_trips vt 
		inner join vms.[vms_trip_efforts] vd on  vt.[vms_trip_id] = vd.[vms_trip_id]
		inner join ref.vessel_instances vi on vt.vessel_id = vi.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.vessels v on vt.vessel_id = v.vessel_id
where gear = 'L'
 /* and eez_code <> 'IW' */
and eez_code not in ('IW','I1','I2','I3','I4','I5','I6','I7','I8','I9','H4','H5')
 and ( year(vt.departure_date) = :year or year(vt.return_date) = :year or ( year(vt.departure_date) < :year and year(vt.return_date) > :year) ) 
 and flag_id = coalesce(:flag_code,flag_id)
group by flag_id,
	gear,
	[year]
	
select
	c.vessel_flag,
	c.vms_trips as trips_est,
	ISNULL(obs.obs_trips,0) as obs_trips,
	ISNULL(ROUND(obs.obs_trips*1.0 / c.vms_trips * 100.0,1),0) as trip_cov,
	ISNULL(trip_processed,0) as obs_trips_proc,
	ISNULL(ROUND(trip_processed*1.0 / c.vms_trips *100,1),0) trip_proc_cov,
	ROUND(c.days_at_sea,0) days_at_sea,
	ROUND(c.days_fishing,0) days_fishing,
	ISNULL(obs_sea_days,0) as obs_sea_days,
	ISNULL(ROUND(obs_sea_days*1.0 / c.days_at_sea *100,1),0) sea_cov,
	ISNULL(obs_fish_days,0) as obs_fish_days,
	ISNULL(ROUND(obs_fish_days*1.0 / c.days_fishing *100,1),0) fishday_cov
from (
	select 
		v.flag_id,
		count( obstrip_id) as obs_trips,
		SUM(case when data_status in (263,264) then 1 else 0 end) as trip_processed,
        sum(datediff(dd,case when year(dep_date) < :year then cast(cast(:year as char(4))+'-01-01' as datetime) else dep_date end,
						case when year(ret_date) > :year then cast(cast(:year as char(4))+'-12-31' as datetime) else ret_date end)+1) as obs_sea_days,
 		max(x.fish_days) as obs_fish_days
	FROM obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
		left outer join 
		(
		select 
			v.flag_id,
			count(distinct case when year(set_date) = :year then ls.l_set_id else null end) as fish_days 
		FROM obsv.trip t 
			inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date			
			inner join obsv.l_set ls on t.obstrip_id = ls.obstrip_id
		WHERE obsprg_code not like '%EM' 
			and gear_code = 'L'
			and v.flag_id = coalesce(:flag_code,v.flag_id)
			and ( year(dep_date) = :year or year(ret_date) = :year or ( year(dep_date) < :year and year(ret_date) > :year) ) 
		group by v.flag_id ) x on x.flag_id = v.flag_id
	WHERE obsprg_code not like '%EM'
		and gear_code = 'L'
		and v.flag_id = coalesce(:flag_code,v.flag_id)
		and ( year(dep_date) = :year or year(ret_date) = :year or ( year(dep_date) < :year and year(ret_date) > :year) ) 
	group by t.gear_code,v.flag_id) obs
right join #mapped_vms_trip c on c.vessel_flag=obs.flag_id
where c.year=coalesce(:year, c.year) 
	and c.vessel_flag = coalesce(:flag_code,c.vessel_flag)
	AND c.gear_code = 'L'	",NA
"331","8bd40090-5c96-4f07-9642-2f5e55f1ed6b"," PURSE SEINE - Logsheet Coverage in EEZ - SUMMARY - without link to LICENSE","year",NA,"Logsheets,VMS",NA,NA,"1.1.7",3076,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, CoverageMissingData, MyEEZ","2023-03-27T09:28:44.013","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT      distinct t.vms_trip_id
    FROM  log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  vi.flag_id,eez.year,SUM(eez.day_fishing) day_fishing into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND	COALESCE(:year, eez.year)=eez.year
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
AND	ve.gear='S'
GROUP BY vi.flag_id,eez.year

SELECT	DATEPART(YEAR, s.logdate) year,
		vi.flag_id,
		COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND	s_activity_id=1
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY ve.gear,DATEPART(YEAR, s.logdate),vi.flag_id 

SELECT COALESCE(mt.year,e.year) year, CONVERT(DECIMAL(5,2),SUM(COALESCE(nb_days,0))*100/SUM((COALESCE(nb_days,0)+COALESCE(day_fishing,0)))) cov
from #missing_trip mt FULL OUTER JOIN  #effort e ON mt.flag_id = e.flag_id AND mt.year = e.year
GROUP BY COALESCE(mt.year,e.year)",NA
"332","61fe4ee7-20ea-47cb-9318-a7ae008bfa45","WCPFC Convention Area Annual Catch Estimates by EEZ","eez_code, flag_code, year","The ANNUAL CATCH BY EEZ database used for this report is an attempt to stratify the annual catch estimates of the main tuna and billfish species compiled for the WCPFC Convention Area into EEZs and high seas areas.  The main source of data for this database is therefore the WCPFC Yearbook (annual catch estimates) data. The only data that are available to use in the process of breaking down annual catch estimates by year and flag across EEZs and high seas areas is operational logsheet data. However, operational logsheet data are not complete and for some gears and fleets the coverage is very low.  Low coverage of logsheet data will mean that the estimates of catch by EEZ and high seas area are often biased. 

CAVEAT EMPTOR --- DUE CAUTION SHOULD BE EXERCISED WHEN USING THESE DATA DUE TO THE LOW COVERAGE OF LOGSHEET DATA FOR SOME FLEETS.","",NA,NA,"2",3199,"andrewh@spc.int","brunod@spc.int","Logsheet, Unraised","2022-04-27T11:42:55.953"," SELECT
	t1.EEZ_CODE,
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY,
	SUM(CASE t2.SP_CODE when 'ALB' THEN sp_mt END) as ALB,
	SUM(CASE t2.SP_CODE when 'BET' THEN sp_mt END) as BET,
	SUM(CASE t2.SP_CODE when 'YFT' THEN sp_mt END) as YFT,
	SUM(CASE t2.SP_CODE when 'SKJ' THEN sp_mt END) as SKJ,
	SUM(CASE WHEN t2.SP_CODE in ('ALB','BET','SKJ','YFT') THEN sp_mt END) as TUNA
FROM WCPFC_YEARBOOK.dbo.A_ACE_EZ t1
INNER JOIN WCPFC_YEARBOOK.dbo.A_ACE_EZ_CATCH t2 ON t1.ACE_EZ_ID = t2.ACE_EZ_ID
LEFT JOIN WCPFC_YEARBOOK.dbo.species S ON t2.SP_CODE = S.sp_code
WHERE OCEAN_CODE = 'WX'
	AND FLAG_CODE = coalesce(:flag_code, FLAG_CODE)
	AND YY = coalesce(:year,YY)
	AND EEZ_CODE = coalesce(:eez_code,EEZ_CODE)
GROUP BY
	t1.EEZ_CODE,
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY",NA
"333","127d10c3-f7f0-44d4-a1da-d45cadc78faf"," Summary Catch Statistics by YEAR, FLAG, EEZ","eez_code, flag_code, year",NA,"Observer",NA,"Observer","10",2945,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-01-20T15:26:37.38"," SELECT 	YEAR(Catch_date) as yr, 
		flag_id as flag,
		eez_code as eez, 
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		MAX(hooks) as hooks, 		
		sum(1) as No,
		SUM(1) / MAX(n) as sp_comp,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		SUM(0001.000) / MAX(hooks) * 1000 as CPUE,
		COUNT(distinct lc.l_set_id) / max(SETS) as freq,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(1.0) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(1.0) as Disc_perc,
		SUM(case when left(cond_code,1) = 'A' then 0001 else 0000 end)  / SUM(1.0) as alive_perc,
		SUM(case when left(cond_code,1) <> 'A' then 0001 else 0000 end) / SUM(1.0) as dead_perc,
		SUM(case when sex_code = 'M' then 0001 else 0000 end)  / SUM(1.0) as male_perc,
		SUM(case when sex_code = 'F' then 0001 else 0000 end)  / SUM(1.0) as female_perc
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join (SELECT  YEAR(catch_date) as yr, 
								flag_id as flag,
								eez_code as eez, 
								SUM(1)*1.000 as n,
								count(distinct ls.l_set_id)*1.000 as sets
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id 
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
								inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
						WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
							AND flag_id = coalesce(:flag_code,flag_id)
							AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
						GROUP BY	YEAR(catch_date), 
									flag_id,
									eez_code) tmp on tmp.n > 0	
													and tmp.yr = YEAR(Catch_date)
													and tmp.flag = flag_id
													and tmp.eez = eez_code
			inner join (SELECT YEAR(set_date) as yr, 
								flag_id as flag,
								eez_code as eez, 
								SUM(coalesce(hook_set,0000.000)) as hooks
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id 
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_sethaullog lh on ls.l_set_id = lh.l_set_id and stend_id = 83
						WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date))
							AND flag_id = coalesce(:flag_code,flag_id)
							AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
						GROUP BY	YEAR(set_date), 
									flag_id,
									eez_code) tmp2 on tmp2.hooks > 0		
													and tmp2.yr = YEAR(Catch_date)
													and tmp2.flag = flag_id
													and tmp2.eez = eez_code
WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
	AND flag_id = coalesce(:flag_code,flag_id)
	AND (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
GROUP BY  
		YEAR(Catch_date), 
		flag_id,
		eez_code, 
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name",NA
"334","01146006-b7f8-4caf-a3d7-a8e8010d46f0"," TAILS in app reports","","List the reports to be launched after push of data to the server","",NA,NA,"98",3257,"andrewh@spc.int","andrewh@spc.int","API","2021-10-13T14:32:18.4","declare @Foo as Table ( guid uniqueidentifier )
insert into @Foo values ('390b941c-3ec6-4bbd-b66a-a8f600e112c7'),('00c30b18-1a85-4884-a134-a8e900a64398'),('c8801893-d043-4b72-ae95-a8f700f19e18'),('45a4c704-1ece-4064-afbe-a8f80093e272'),('3848c235-4d28-46cc-a3f2-a8f800ef58fc')

 select guid reportId from @Foo",NA
"335","7a5c7000-9e07-4ef6-b771-a722009412f1"," ARTISANAL - Tails statistics - Artisanal logsheet submissions","year","Tails statistics - Artisanal logsheet","Artisanal",NA,NA,"99.1",3158,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, MyFleet","2021-10-13T14:42:55.823"," SELECT	:group_by,count(*) nb_trips
FROM	art2.trips
WHERE		COALESCE(:year,YEAR(entered_date))=YEAR(entered_date)
GROUP BY :group_by","YearEnteredby"
"336","c8801893-d043-4b72-ae95-a8f700f19e18"," TAILS In App Report - Activity Logs","staff_code","Number of activity logs","Artisanal",1,NA,"98.3",3261,"andrewh@spc.int","andrewh@spc.int","Artisanal, CoverageMissingData, API","2021-10-13T14:30:45.98","SELECT	MONTH(activity_date) Month_id,
		DATENAME(month,activity_date) Month,
		SUM(CASE WHEN YEAR(activity_date)=YEAR(CURRENT_TIMESTAMP)-1 THEN 1 ELSE 0 END) AS 'Y-1',
		SUM(CASE WHEN YEAR(activity_date)=YEAR(CURRENT_TIMESTAMP)   THEN 1 ELSE 0 END) AS 'Y' into #t
FROM	art2.fishing_activity_log
WHERE	entered_by=:staff_code
AND		YEAR(activity_date)>=YEAR(CURRENT_TIMESTAMP)-1
GROUP BY MONTH(activity_date),DATENAME(month,activity_date)
ORDER BY MONTH(activity_date) SELECT	CONVERT(VARCHAR,Month_id) + ' - ' + LEFT(Month,3) Month,
		[Y-1] as lastyear,
		Y as thisyear
FROM 	#t",NA
"337","193cc7bc-3e41-4025-84d8-83d082d6940f","SSI Vessel-Interaction Reports from GEN-2 form by GEAR, YEAR and FLAG","flag_code, year",NA,"Observer",NA,"Observer","11",3100,"andrewh@spc.int","aurelienp@spc.int","Observer, Purseseine","2023-02-02T13:55:45.07"," select
ot.gear_code as gear,
v.flag_id as flag,
year(ot.dep_date) as trip_year,
f.staff_code as obsv_staff_code,
f.family_name as obsv_family_name,
f.first_name as obsv_first_name,
ot.tripno as observer_trip_id,
v.vesselname as vessel_name,
g2.interact_date as date,
coalesce(g2.interact_start_time,'-') as start_time,
coalesce(g2.interact_end_time,'-') as end_time,
coalesce(g2.lat,'-') as lat,
coalesce(g2.lon,'-') as lon,
coalesce(g2.eez_code,'-') as eez_code,
'GEN2' as form,
'VESSEL INTERACTION' as type,
sp.sp_cat_code as sp_cat_code,
sp.sp_code as sp_code,
sp.sp_name as species,
coalesce(g2.interact_code,'-') as interaction_code,
CASE g2.interact_code 
	WHEN 'IBV' then 'Beside vessel'
	WHEN 'ION' then 'Outside net'
	WHEN 'ICF' then 'Crew feeding'
	WHEN 'IWF' then 'Interaction with FADs but not set on'
	WHEN 'IDW' then 'Dead in water'
	WHEN 'OTH' then 'Other'
	WHEN 'ICV' then 'Collision with vessel'
	WHEN 'ICP' then 'Collision with propeller'
	WHEN 'ICT' then 'Collision with Tori line'
	WHEN 'FRB' then 'Feeding on bait during set'
	WHEN 'IFO' then 'Feeding on discarded offal'
	WHEN 'IRE' then 'Resting on vessel,floats or FADs(Birds)'
	WHEN 'INT' then 'Interaction from old GEN2-form'
	ELSE '-' END as interaction_code_desc,
coalesce(g2.interact_desc,'-') as [desc],
g2.dist_from_vessel_start as distance_start,
coalesce(g2.dist_start_unit,'-') as distance_start_unit,
g2.dist_from_vessel_end as distance_end,
coalesce(g2.dist_end_unit,'-') as distance_end_unit,
coalesce(g2.condition_code_start,'-') as condition_code_start,
coalesce(g2.condition_code_end,'-') as condition_code_end,
adults_len,
coalesce(adults_len_unit,'-') as adults_len_unit,
juveniles_len,
coalesce(adults_len_unit,'-') as juveniles_len_unit,
g2.adults_n as adult_n,
g2.juveniles_n as juveniles_n
FROM obsv.gen2interactions g2
left join obsv.trip ot on ot.obstrip_id = g2.obstrip_id 
left join ref.vessel_instances v on v.vessel_id = ot.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
left join ref.field_staff f on f.staff_id = ot.observer_id 
left join ref.species sp on sp.sp_code = g2.sp_code
--left join obsv.ref_ids ids_sg on ids_sg.id = g2.vessel_activity 
where sp_cat_code in ('MAM','SHK','TTX','BRD') and
YEAR(interact_date) = coalesce(:year,year(interact_date)) 
    AND flag_id = coalesce(:flag_code,flag_id)",NA
"338","a0b7021d-78b3-4440-b9ce-a90e00df70cc"," Annual total catch count of Tuna category by Fleet- E-Monitoring only","year",NA,"",NA,"Observer","8a",3265,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T15:56:14.7"," select vi.vesselname, case
						when sp_cat_code is null or sp_cat_code='' THEN 'UNSPECIFIED' 
						when sp_cat_code = 'TTX' THEN 'TURTLE' 
						when sp_cat_code = 'MAM' THEN 'MAMMAL' 
						when sp_cat_code = 'SHK' THEN 'SHARK' 
						when sp_cat_code = 'BRD' THEN 'BIRD' 
						when sp_cat_code = 'TUN' THEN 'TUNA' 
						when sp_cat_code = 'BIL' THEN 'BILLFISH' 
						when sp_cat_code = 'INV' THEN 'INVERTEBRATE' 
						ELSE sp_cat_code END as sp_cat_code,sp.sp_name,count(sc.sp_code) as catch_count
from em.trip et
inner join em.l_set ls on ls.obstrip_id=et.obstrip_id
inner join ref.vessel_instances vi on vi.vessel_id=et.vessel_id
	and et.dep_date between vi.start_date and vi.calculated_end_date
inner join em.l_setcatch sc on sc.l_set_id=ls.l_set_id
inner join ref.species sp on sp.sp_code=sc.sp_code
where COALESCE(:year,year(dep_date)) = year(dep_date) and sp.sp_cat_code='TUN'
group by vi.vesselname, sp.sp_cat_code, sp.sp_name",NA
"339","b010fc4a-c2f8-4042-aca7-a72f0003a4b5"," ARTISANAL - Vessel costs and catch","year","Requested by NU shows vessel catch and costs per month","Artisanal",NA,NA,"2.2",3162,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, ByVessel","2023-03-28T11:14:57.11","with #catch (art_trip_id, skipper_name, fuel_cost, fuel_used, bait_cost, ice_cost, gear_cost, catch_kg) as
(
	select t.art_trip_id,
	t.skipper_name,
	t.fuel_cost,
	t.fuel_used,
	t.bait_cost,
	t.ice_cost,
	t.gear_cost,
	SUM(sp_kg) as catch_kg
from	art2.trips t inner join art2.effort e ON t.art_trip_id=e.art_trip_id
	left outer join art2.catch c on c.art_effort_id = e.art_effort_id
group by t.art_trip_id,skipper_name,fuel_cost,fuel_used,bait_cost,ice_cost,gear_cost
)


 select	YEAR(trip_date) year, 
	MONTH(trip_date) month,
	:group_by,
	sum(h.catch_kg) as catch_kg,
	sum(h.fuel_cost) as fuel_cost,
	sum(h.fuel_used) as fuel_used,
	sum(h.bait_cost) as bait_cost,
	sum(h.ice_cost) as ice_cost,
	sum(h.gear_cost) as gear_cost,
        sum(coalesce(h.fuel_cost,0)+coalesce(h.bait_cost,0)+coalesce(h.ice_cost,0)+coalesce(h.gear_cost,0)) as total_cost
from	art2.trips t 
	inner join #catch h on h.art_trip_id = t.art_trip_id
	inner join art2.vessels v on v.vessel_id = t.vessel_id
where year(trip_date) = coalesce(:year, year(trip_date))
group by YEAR(trip_date), MONTH(trip_date),:group_by","Vessel"
"340","671623b3-c857-4b26-afb1-a82000916e89"," CMM 12-04 - Purse seine WHALE SHARK catches (Vessel reporting) by NATIONAL FLEET SUMMARY - Interim","flag_code, year","4. CCMs shall require that, in the event that a whale shark is not deliberately encircled in the purse seine net, the master of the vessel shall:
(a) ensure that all reasonable steps are taken to ensure its safe release.; and (b) report the incident to the relevant authority of the flag State, including the number of individuals, details of how and why the encirclement happened, where it occurred, steps taken to ensure safe release, and an assessment of the life status of the whale shark on release (including whether the animal was released alive but subsequently died).","Logsheets",NA,NA,"28",3221,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CMM, RegionalReporting, ByCatch","2022-07-06T17:37:46.833"," SELECT  vi.flag_id as flag,
        CONVERT(VARCHAR(10), logdate, 103) as date,
        lat,
        lon,
        eez_code,
        sp.sp_name as species,
        catch_ps.sp_n as number,
        catch_ps.sp_mt as mt,
        case when discard=1 then 'Released' else 'Retained' end as fate
FROM    log.trips_ps trip_ps 
            inner join ref.vessel_instances vi 
                    on trip_ps.vessel_id = vi.vessel_id AND trip_ps.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
        inner join log.sets_ps set_ps on set_ps.log_trip_id = trip_ps.log_trip_id
        inner join log.catch_ps catch_ps on catch_ps.log_set_id = set_ps.log_set_id
        Inner join ref.species sp on sp.sp_code = catch_ps.sp_code
WHERE   YEAR(logdate) = coalesce(:year,year(logdate))
        AND vi.flag_id = coalesce(:flag_code,vi.flag_id)
        AND catch_ps.sp_code = 'RHN'",NA
"341","78ff2ecd-0bfc-4a3b-a64a-a74b00eb1acc"," PURSE SEINE - Missing logsheets in EEZ","flag_code, year","Using VMS data, lists the logsheet that you should see and not entered yet in TUFMAN2","Logsheets,VMS",NA,NA,"1.1.8",3167,"andrewh@spc.int","andrewh@spc.int","Logsheet, Purseseine, CoverageMissingData, MyEEZ","2022-09-12T16:33:45.797","SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ps l 
						INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                        INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
                              (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                              OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                              OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                              OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
                        )
			INNER JOIN vms.vms_trip_efforts map ON map.year=:year AND (@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity))) AND map.vms_trip_id = t.vms_trip_id
			) t 

SELECT  vi.vesselname vessel_name,vi.flag_id flag_code,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111) depart_date, dp.port_name dp, CONVERT(nvarchar,t.return_date,111) return_date, rp.port_name rp,CONVERT(DECIMAL(6,2),SUM(eez.day_fishing)) day_fishing 
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
	INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
        INNER JOIN ref.ports dp ON t.departure_port_id = dp.port_id
	INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
WHERE	t.vms_trip_id NOT IN (SELECT vms_trip_id from #mapped_trip)
AND 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND 	day_fishing>1
AND	ve.gear='S'
AND	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
AND	COALESCE(:year, eez.year)=eez.year
GROUP BY vi.vesselname,vi.flag_id,vi.ffa_vid,CONVERT(nvarchar,t.departure_date,111),dp.port_name,CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"342","e84bba02-9ebc-4d11-aae1-a8fe00ec418b"," ARTISANAL - Report on Tails extensions fields","",NA,"Artisanal",NA,NA,"999",3264,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, DataQuality","2021-10-11T13:29:15.457"," SELECT	t.trip_date,t.skipper_name,v.vessel_name,l.landing_site_name,l.landing_site_desc,
		JSON_VALUE(t.extensions,'$.NfdsFadMonitoring.GenderCode') Gender,
		JSON_VALUE(t.extensions,'$.NfdsFadMonitoring.OtherPurchased') OtherPurchased,
		JSON_VALUE(t.extensions,'$.NfdsFadMonitoring.OtherCost') OtherCost
FROM	art2.trips t JOIN art2.vessels v ON t.vessel_id=v.vessel_id
LEFT OUTER JOIN art2.landing_sites l on l.landing_site_id = t.landing_site_id
WHERE	t.system_source='tails'",NA
"343","8a92787c-bf8b-4339-bc6e-a82600e0244e"," LONGLINE - Comparison summary between ER/Logsheet trips - DRAFT","","Comparisons between ER and T2 longline data","Logsheets",NA,NA,"3",3225,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Ereporting","2021-10-11T16:02:40.773","select year(first_logdate) as year, 
	sum(case when t.system_source='onboard' then 1 else 0 end) as no_ER_trips,
	sum(case when t.system_source='tufman2' then 1 else 0 end) as no_T2_trips
INTO #table1
FROM log.trips_ll T 
WHERE year(t.first_logdate)>=2016
GROUP by year(first_logdate)

--------------------------------------------------------------------------------

select year(first_logdate) as year, 
	sum(case when t.system_source='onboard' then hooks_n else 0 end) as no_ER_hooks,
	sum(case when t.system_source='tufman2' then hooks_n else 0 end) as no_T2_hooks,
	sum(case when t.system_source='onboard' then 1 else 0 end) as no_ER_days,
	sum(case when t.system_source='tufman2' then 1 else 0 end) as no_T2_days
INTO #table2
FROM log.trips_ll T 
	inner join log.sets_ll S on t.log_trip_id = s.log_trip_id
WHERE year(t.first_logdate)>=2016
	AND l_activity_id = 1
GROUP by year(first_logdate)

--------------------------------------------------------------------------------

Select t.log_trip_id, year(first_logdate) as year,
	SUM(case when t.system_source='onboard' then hooks_n else 0 end) as ER_hks_trip,
	SUM(case when t.system_source='tufman2' then hooks_n else 0 end) as T2_hks_trip
INTO #table3
FROM log.trips_ll T 
	inner join log.sets_ll S on t.log_trip_id = s.log_trip_id
WHERE year(t.first_logdate)>=2016
	AND l_activity_id = 1
GROUP by t.log_trip_id, year(first_logdate)

Select year,
	AVG(ER_hks_trip) as avg_ER_hks_trip
INTO #table3a
from #table3
WHERE ER_hks_trip<>0
group by year

Select year,
	AVG(T2_hks_trip) as avg_T2_hks_trip
INTO #table3b
from #table3
WHERE T2_hks_trip<>0
group by year

--------------------------------------------------------------------------------

 select t1.year, 
	sum(no_ER_trips) as ER_no_trips,
	sum(no_T2_trips) as T2_no_trips,
	SUM(no_ER_days) as ER_no_days,
	SUM(no_T2_days) as T2_no_days,
	sum(no_ER_hooks) as ER_no_hooks,
	SUM(no_T2_hooks) as T2_no_hooks,
	SUM(avg_ER_hks_trip) as ER_avg_hks_trip,
	SUM(avg_T2_hks_trip) as T2_avg_hks_trip
FROM #table1 t1 
	inner join #table2 t2 on t1.year = t2.year
	LEFT join #table3a t3a on t1.year = t3a.year
	LEFT join #table3b t3b on t1.year = t3b.year
GROUP by t1.year",NA
"344","e0a3e8f3-a517-4963-b8c8-a938009412a6"," FAD report","year","Report on FAD, vessel activity, position, FAD number ...","Observer",NA,"Observer","41",3273,"andrewh@spc.int","aurelienp@spc.int","Observer, Custom","2025-10-23T09:35:03.187"," select vi.vesselname,ot.dep_date,staff_code,ot.tripno,a.activity_desc,sa.act_dtime,g.object_number,fo.fad_origin_desc as fad_origin,g.deployment_date,sa.latd,sa.lond,sa.eez_code,type_found.fad_type_desc as FAD_as_found,type_left.fad_type_desc as FAD_as_left,g.max_depth_m,g.length_m,g.width_m,g.buoy_number,g.markings,ISNULL(g.fad_lifted,0) as fad_lifted,ISNULL(g.ssi_trapped,0) as ssi_trapped,g.comments,fmat.fad_material_desc as fad_material,fm.is_attachment
FROM obsv.trip ot 
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id and ot.dep_date between vi.start_date and vi.calculated_end_date
join ref.field_staff f on f.staff_id=ot.observer_id
join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
join obsv.gen5fad g on g.s_daylog_id = sa.s_daylog_id
left outer join obsv.gen5fadmaterial fm on fm.fad_id = g.fad_id
left join ref_static.fad_material fmat on fmat.fad_material_id = fm.material_code
left join ref_static.fad_origin fo on fo.fad_origin_code = g.origin_code
left join [ref_static].[fad_type] type_found on type_found.fad_type_code = as_found_code
left join [ref_static].[fad_type] type_left on type_left.fad_type_code = as_left_code
left join ref_static.ps_activities a on a.s_activ_id = sa.s_activ_id
WHERE YEAR(ot.dep_date) = coalesce(:year,year(ot.dep_date))",NA
"345","41c69422-fc69-42f5-9655-d44fa4f0cbb6"," PURSE SEINE - Logsheet / Unloadings reconciliation","flag_code, year","For each loghseet, displays the link to the corresponding unloadings if it has been entered in TUFMAN2","Logsheets",NA,NA,"3.1.1",3038,"andrewh@spc.int","colleyf@spc.int","Logsheet, Unloading, Purseseine, CoverageMissingData","2025-10-20T15:31:52.983"," SELECT	DISTINCT vi.vesselname vessel_name, vi.flag_id flag_code, CONVERT(nvarchar,t.depart_date,111) depart_date,dp.port_name dp,CONVERT(nvarchar,t.return_date,111) return_date,rp.port_name rp,t.log_trip_id PurseseineLogsheetDTO,l.dto_guid_right CarrierLoadingDTO
FROM	log.trips_ps t LEFT JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='PurseseineLogsheetDTO'  AND l.dto_type_right='CarrierLoadingDTO'
		JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		JOIN ref.ports dp ON t.depart_port_id = dp.port_id
		JOIN ref.ports rp ON t.return_port_id = rp.port_id
                JOIN log.sets_ps s ON s.log_trip_id = t.log_trip_id
		JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
WHERE	COALESCE(:year,YEAR(depart_date)) = YEAR(depart_date)
AND	COALESCE(:flag_code,vi.flag_id)=vi.flag_id",NA
"346","759079c6-1293-4fdb-99fb-a83800a2276c"," List of E-Monitoring with corresponding Observer trips","year","List of all E-Monitoring trips where conventional observer trips where conducted simultaneously","Observer",NA,"Observer","3a",3229,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2022-08-30T08:26:12.823"," SELECT DISTINCT rv.vesselname AS VESSEL_NAME
	,et.obsprg_code AS PROG_CODE
	,st.staff_code AS EM_STAFF_CODE
	,obst.staff_code AS OB_STAFF_CODE
	,('trip@' + et.TRIPNO) AS TRIPNO
	,CONVERT(VARCHAR(10), et.dep_date, 103) AS EM_DEP_DATE
	,CONVERT(VARCHAR(10), et.ret_date, 103) AS EM_RET_DATE
	,CONVERT(VARCHAR(10), ot.dep_date, 103) AS OBS_DEP_DATE
	,CONVERT(VARCHAR(10), ot.ret_date, 103) AS OBS_RET_DATE
FROM em.trip et
INNER JOIN ref.vessel_instances rv ON rv.vessel_id = et.vessel_id
	and et.dep_date between rv.start_date and rv.calculated_end_date
INNER JOIN obsv.trip ot ON ot.vessel_id=rv.vessel_id
	and et.dep_date between ot.dep_date and ot.ret_date
inner join ref.field_staff st on st.staff_id=et.observer_id
inner join ref.field_staff obst on obst.staff_id=ot.observer_id
WHERE COALESCE(:year, year(et.dep_date)) = year(et.dep_date)",NA
"347","5de3a839-57b3-6351-f037-3a13ac1b0063","IATTC ANNEX B option 1 - Crew Information","flag_code, min_year, max_year",NA,"Observer",NA,"Observer",NA,3547,"colleyf@spc.int","colleyf@spc.int","Observer, Longline","2024-07-10T11:42:02.447","SELECT t.tripno as tripno,
	v.vesselname as vesselname,
	v.flag_id as flag_id,
	v.regist_no as regist_no,
        v.ircs as ircs,
	CONVERT(VARCHAR(10), t.dep_date, 103) AS depart_date,
	CONVERT(VARCHAR(10), t.ret_date, 103) AS return_date,
	coalesce(VC.name,'-') as captain_name,
	coalesce(VM.name,'-') as master_name,
	(SELECT coalesce(sum(c.crewcount),0) 
	 FROM obsv.vess_crew c
	 INNER JOIN obsv.trip st ON c.obstrip_id=st.obstrip_id
	 WHERE st.obstrip_id = t.obstrip_id) as total_crews
FROM obsv.trip t 
     INNER JOIN (SELECT DISTINCT t.obstrip_id 
                 FROM obsv.trip t join obsv.l_set s on t.obstrip_id = s.obstrip_id 
	             INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83 
	             WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
	             AND latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L') iattc_fishing on iattc_fishing.obstrip_id=t.obstrip_id
	INNER JOIN ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
	LEFT JOIN ref.vessel_staff AS VC ON T.captain_id = VC.vessel_staff_id
	LEFT JOIN ref.vessel_staff AS VM ON T.master_id = VM.vessel_staff_id
WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
AND v.flag_id = coalesce(:flag_code,flag_id)",NA
"348","dc15421d-6241-41c9-9e9e-a9970113227b"," LONGLINE - logsheet in EEZ - Full reconciliation (with days)","flag_code, year","Longline logsheet in EEZ - Full reconciliation  (with days)","Logsheets,VMS",NA,NA,"1.2.9",3288,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CoverageMissingData, MyEEZ","2022-11-22T10:08:56.627","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,vi.flag_rg_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.log_trip_id, l.depart_date, l.return_date log_return_date,day_fishing INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN log.trips_ll l  ON t.vessel_id = l.vessel_id AND (
				  (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
				  OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
				  OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
				  OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
			)
	WHERE DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND 	COALESCE(:flag_code,vi.flag_id)=vi.flag_id
	AND     day_fishing>1
	ORDER BY vi.vesselname,departure_date
	 
select vesselname vessel_name, flag_id flag_code, flag_rg_id, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,depart_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, log_trip_id LonglineLogsheetDTO, sum(day_fishing) as vms_days 
from #mapped_trip
group by 
vesselname, flag_id, flag_rg_id, CONVERT(nvarchar,departure_date,111), dp, CONVERT(nvarchar,return_date,111), rp, CONVERT(nvarchar,depart_date ,111), CONVERT(nvarchar,log_return_date ,111), log_trip_id",NA
"349","19a5d7b8-2788-431c-b8ae-a74d01231095"," PURSE SEINE -- WCPFC key species catch and discard/release used to produce estimate for Part 1 Report","flag_code, year",NA,"Observer",NA,"Observer","31",3171,"andrewh@spc.int","emmanuels@spc.int","Observer, Purseseine","2025-03-12T11:33:46.38","
DECLARE @sp_code nvarchar(90)
DECLARE @sp_name char(3)
DECLARE @sp_list nvarchar(90)
DECLARE @cnt_0 int
DECLARE @cnt_0_str char(4)

set @sp_list = 'ALBBETPBFSKJYFTBLMBUMMLSSWOSSPSFABSHFALHAMMAKOCSPORRHNTHR'
set @cnt_0 = 1

If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

If(OBJECT_ID('tempdb..#temp_d2') Is Not Null)
Begin
    Drop Table #temp_d2
End

create table #temp_d2 (
	sp_name char(3),
	trips	int,
	days	int,
	No_Ret_days	int,
	No_Disc_days int,
	No_Ret	int,
	Kgs_Ret	decimal(29,8),
	No_Disc int,
	kgs_Disc decimal(29,8),
	AVG_No_Ret	decimal(29,8),
	AVG_Kgs_Ret decimal(29,8),
	AVG_No_Disc	decimal(29,8),
	AVG_kgs_Disc decimal(29,8),
	AVG_D_No_Ret	decimal(29,8),
	AVG_D_Kgs_Ret decimal(29,8),
	AVG_D_No_Disc	decimal(29,8),
	AVG_D_kgs_Disc decimal(29,8))

while @cnt_0 < 20
begin

	set @sp_name = substring(@sp_list,(@cnt_0-1)*3+1,3)
	
	if	@sp_name = 'THR' 
		set @sp_code = 'BTH,PTH,THR,ALV'
	if @sp_name = 'MAK' 
		set @sp_code = 'MAK,LMA,SMA'
	if @sp_name = 'HAM' 
		set	@sp_code = 'SPK,SPL,SPN,SPQ,SPZ'
	if @sp_name <> 'HAM' and @sp_name <> 'MAK' and @sp_name <> 'THR' 
		set @sp_code = @sp_name


If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

SELECT     
		ot.obstrip_id,
		CAST(ot.obstrip_id as VARCHAR(50))+CAST(act_date as CHAR(12)) as day_key,
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then sp_n_est else 0.0 end) as No_ret, 
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then sp_c_est else 0.000 end)*1000 as kgs_ret,
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' and coalesce(cond_code,'XX') not in ('A0','A1','A2') then sp_n_est else 0.0 end) as No_disc, 
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' and coalesce(cond_code,'XX') not in ('A0','A1','A2') then sp_c_est else 0.000 end)*1000 as kgs_disc
INTO #temp_d1
FROM    obsv.trip ot 
            inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
 			inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
			inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
			left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
			left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id  
 WHERE YEAR(act_date) = coalesce(:year, YEAR(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND s_activ_id in (1,2)
GROUP BY  
        ot.obstrip_id,
        CAST(ot.obstrip_id as VARCHAR(50))+CAST(act_date as CHAR(12))

insert into #temp_d2
select 
	max(@sp_name) as sp_name,
	count(distinct obstrip_id) as trips,
	count(distinct day_key) as days,
	sum(case when No_Ret>0 then 1 else 0 end)  as No_Ret_days,
	sum(case when No_Disc>0 then 1 else 0 end) as No_Disc_days,
	sum(No_Ret)  as No_Ret,
	sum(kgs_Ret) as Kgs_Ret,
	sum(No_Disc) as No_Disc,
	sum(kgs_Disc) as kgs_Disc,
	sum(No_Ret)  / COUNT(distinct obstrip_id) as AVG_No_Ret,
	sum(kgs_Ret) / COUNT(distinct obstrip_id) as AVG_Kgs_Ret,
	sum(No_Disc) / COUNT(distinct obstrip_id) as AVG_No_Disc,
	sum(kgs_Disc) / COUNT(distinct obstrip_id) as AVG_kgs_Disc,
	sum(No_Ret)  / COUNT(distinct day_key) as AVG_D_No_Ret,
	sum(kgs_Ret) / COUNT(distinct day_key) as AVG_D_Kgs_Ret,
	sum(No_Disc) / COUNT(distinct day_key) as AVG_D_No_Disc,
	sum(kgs_Disc) / COUNT(distinct day_key) as AVG_D_kgs_Disc
from #temp_d1 

set @cnt_0 = @cnt_0 + 1

end

select 
	sp_name,
	trips,
	No_Ret_days,
	No_Disc_days,
	No_Ret,
	Kgs_Ret,
	No_Disc,
	kgs_Disc,
	AVG_No_Ret,
	AVG_Kgs_Ret,
	AVG_No_Disc,
	AVG_kgs_Disc,
	AVG_D_No_Ret,
	AVG_D_Kgs_Ret,
	AVG_D_No_Disc,
	AVG_D_kgs_Disc
from #temp_d2",NA
"350","897f8979-1dcf-41cb-bcbd-a7ae008825c2"," South Pacific Annual Catch Estimates","flag_code, year, gear_code","Annual Catch Estimates in the south Pacific","",NA,"Live","4",3198,"andrewh@spc.int","benoitp@spc.int","Logsheet, Unraised","2025-04-02T14:02:09.49"," SELECT
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY,
	SUM(CASE t2.SP_CODE when 'ALB' THEN sp_mt END) as ALB,
	SUM(CASE t2.SP_CODE when 'PBF' THEN sp_mt END) as PBF,
	SUM(CASE t2.SP_CODE when 'SWO' THEN sp_mt END) as SWO,
	SUM(CASE t2.SP_CODE when 'MLS' THEN sp_mt END) as MLS
FROM WCPFC_YEARBOOK.dbo.A_ACE t1
INNER JOIN WCPFC_YEARBOOK.dbo.A_ACE_CATCH t2 ON t1.ACE_ID = t2.ACE_ID
LEFT JOIN WCPFC_YEARBOOK.dbo.species S ON t2.SP_CODE = S.sp_code
WHERE OCEAN_CODE = 'SP'
	AND FLAG_CODE = coalesce(:flag_code, FLAG_CODE)
	AND YY = coalesce(:year,YY)
	AND GEAR_CODE = coalesce(:gear_code,GEAR_CODE)
GROUP BY
	t1.FLAG_CODE,
	t1.FLEET_CODE,
	t1.GEAR_CODE,
	t1.YY",NA
"351","ccdb784b-1f16-4a15-abfb-a9e500a58ab4"," PURSESEINE - Compliance - Telex (position reports) vs Logsheet report","flag_code, year","Checks the catch declared between ZENT and ZDEP and matches to logsheet records.","Logsheets",NA,NA,"105",3294,"andrewh@spc.int","steve@shoreinformatics.com","Logsheet, Purseseine, Compliance, Custom","2022-01-13T08:09:00.1","with #t as (
  Select vessel_id,
	rpt_code,
	telex_date,
	skj_mt,
	yft_mt,
	bet_mt
  FROM [pos].[position_reports]
  where skj_mt is not null
	and system_source = 'Tufman2'
	and vessel_id is not null
	and rpt_code in ('ZENT','ZDEP')),



#firstpairs as (Select vessel_id,
	rpt_code,
	telex_date,
	skj_mt,
	yft_mt,
	bet_mt,
	lead(vessel_id) over (order by vessel_id, telex_date ASC) as nxt_vessel,
	lead(rpt_code) over (order by vessel_id, telex_date ASC) as nxt_code,
	lead(telex_date) over (order by vessel_id, telex_date ASC) as nxt_date,
	lead(skj_mt) over (order by vessel_id, telex_date ASC) - skj_mt as skj_change,
	lead(yft_mt) over (order by vessel_id, telex_date ASC) - yft_mt as yft_change,
	lead(bet_mt) over (order by vessel_id, telex_date ASC) - bet_mt as bet_change
from #t),

#logdata as (Select vessel_id,
	logdate,
	cast(Sum(case c.sp_code when 'YFT' then sp_mt else 000.0 end)			as decimal(9,2))	AS log_yft_mt, 
	cast(Sum(case c.sp_code when 'BET' then sp_mt else 000.0 end)			as decimal(9,2))	AS log_bet_mt,
	cast(Sum(case c.sp_code when 'SKJ' then sp_mt else 000.0 end)			as decimal(9,2))	AS log_skj_mt 
from log.trips_ps t
	inner join log.sets_ps s on s.log_trip_id = t.log_trip_id
	left outer join log.catch_ps c on  c.log_set_id = s.log_set_id
group by vessel_id, logdate),


#realpairs as (select *
from #firstpairs
where rpt_code = 'ZENT'
	and nxt_date > telex_date),

#subtotals as (select F.vessel_id,
	F.telex_date,
	F.nxt_date,
	avg(f.skj_change) as declared_skj,
	sum(l.log_skj_mt) as logsheet_skj,
	avg(f.yft_change) as declared_yft,
	sum(l.log_yft_mt) as logsheet_yft,
	avg(f.bet_change) as declared_bet,
	sum(l.log_bet_mt) as logsheet_bet
from #realpairs f left outer join #logdata l on f.vessel_id = l.vessel_id and l.logdate between f.telex_date and f.nxt_date
group by f.vessel_id, f.telex_date, f.nxt_date)

 select vi.vesselname vessel_name,
	vi.flag_id flag_code,
	convert(varchar, telex_date, 103) telex_date,
	convert(varchar, nxt_date, 103) nxt_date,
	declared_skj,
	logsheet_skj,
	(logsheet_skj - declared_skj) as skj_diff_telex_from_log,
	declared_yft,
	logsheet_yft,
	(logsheet_yft - declared_yft) as yft_diff_telex_from_log,
	declared_bet,
	logsheet_bet,
	(logsheet_bet - declared_bet) as bet_diff_telex_from_log
from #subtotals s
	inner join ref.vessel_instances vi on vi.vessel_id = s.vessel_id and s.telex_date between vi.start_date and vi.calculated_end_date
where year(telex_date) = coalesce(:year,year(telex_date))
and vi.flag_id = coalesce(:flag_code,vi.flag_id)",NA
"352","6dfc73ab-24f3-4008-bf6c-a7c300ddfeee"," List of all E-Monitoring trips","year",NA,"",NA,"Observer","1",3206,"andrewh@spc.int","aurelienp@spc.int","Observer, Emonitoring","2022-08-16T12:00:10.657"," SELECT vesselname
	,obsprg_code
,et.obstrip_key
	,CONVERT(VARCHAR(10), dep_date, 103) dep_date
	,CONVERT(VARCHAR(10), ret_date, 103) ret_date
	,staff_code
	,('trip:' + et.tripno) AS tripno
	,DATEDIFF(DAY, dep_date, ret_date) + 1 AS tripdays
	,count(DISTINCT l.l_set_id) AS sets
	,sum(hook_set) as total_hooks
FROM em.trip et
INNER JOIN ref.vessel_instances v ON et.vessel_id = v.vessel_id
	and et.dep_date between v.start_date and v.calculated_end_date
LEFT OUTER JOIN em.l_set l ON et.obstrip_id = l.obstrip_id
inner join ref.field_staff st on st.staff_id=et.observer_id
WHERE COALESCE(:year, year(dep_date)) = year(dep_date)
	AND right(obsprg_code, 2) = 'EM'
GROUP BY vesselname
	,obsprg_code
,et.obstrip_key
	,dep_date
	,staff_code
	,tripno
	,CONVERT(VARCHAR(10), dep_date, 103)
	,ret_date",NA
"353","03f78c5a-0a56-4ada-9153-a85000b3820b"," PURSE SEINE - VESSEL TRIP Catch Report - BY FLAG","flag_code, year",NA,"Logsheets",NA,NA,"13b",3233,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, Tuna","2021-10-07T14:42:21.23"," select	vi.flag_id flag_code,
		vi.vesselname vessel_name, 
		convert(nvarchar(10),COALESCE(t.depart_date,t.first_logdate),103) depart_date, 
		convert(nvarchar(10),COALESCE(t.return_date,t.last_logdate),103) return_date,
		cast(Sum(case sp_code when 'SKJ' then sp_mt_est else 000.0 end) as int)   AS skj_mt,
		cast(Sum(case sp_code when 'BET' then sp_mt_est else 000.0 end) as int)  AS bet_mt, 
		cast(Sum(case sp_code when 'YFT' then sp_mt_est else 000.0 end)  as int)    AS yft_mt
from	log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id
		inner join log.catch_ps c on s.log_set_id = c.log_set_id 
		inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
where	COALESCE(:year,YEAR(logdate))=YEAR(logdate)
and		COALESCE(:flag_code,vi.flag_id )=vi.flag_id
group by vi.vesselname, COALESCE(t.depart_date,t.first_logdate), COALESCE(t.return_date,t.last_logdate), vi.flag_id",NA
"354","44e46a9f-e490-462e-819a-a7dd00e54a4b"," ALL Species Catch-Raw Data Extract- E-Monitoring only","flag_code, year","ALL Species Catch Data Extract","",NA,"Observer","10a",3216,"andrewh@spc.int","eparamal@spc.int","Observer, Emonitoring","2025-06-16T10:41:21.437"," SELECT 	et.obstrip_id as obstrip_id, 
		ls.l_set_id as l_set_id,
		CONVERT(VARCHAR(10), lc.catch_date, 103) as catch_date,
		lc.catch_time as catch_time,
		lc.sp_code as sp_code, 
		coalesce(sp_cat_code,'OTH') as sp_category,
		ls.hk_bt_flt as hk_bt_flt,
		ls.hook_set,
		ls.bask_set,
		case when ls.hook_observed is null then ls.bask_observed*ls.hk_bt_flt
			 else ls.hook_observed end as hook_observed,
		ls.bask_observed,
		lc.hook_no as hook_no,
		lc.cond_code as condition_land,
		lc.cond_code2 as condition_release,
		lc.fate_code as fate_code, 
		coalesce(lc.len,0) as length,
		lc.len_code as len_code,
		lc.wt_est as wt_est,
		lc.sex_code as sex_code,
		et.tripno as tripno,
		st.staff_code as staff_code,
		v.vesselname as vessel_name,
		v.flag_id as flag,
		et.gear_code as gear,
		lc.comments,
		CONVERT(VARCHAR(10), et.dep_date, 103) as depart_date,
		CONVERT(VARCHAR(10), et.ret_date, 103) as return_date,
		dp.port_name as depart_port,
		rp.port_name as return_port
 FROM	em.trip et 
			inner join ref.vessel_instances v on et.vessel_id = v.vessel_id and et.dep_date between v.start_date and v.calculated_end_date
			inner join	em.l_set ls on et.obstrip_id = ls.obstrip_id 
			inner join	em.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code 
			left join ref.field_staff st on st.staff_id=et.observer_id
			inner join ref.ports dp on dp.port_id=et.dep_port_id
			inner join ref.ports rp on rp.port_id=et.ret_port_id
WHERE YEAR(set_date) = coalesce(:year,year(set_date))
    AND flag_id = coalesce(:flag_code,flag_id)",NA
"355","75172926-6fa2-28f7-6d8e-3a09cca5bcc8","Coverage of eReporting - FOR TRIPS LANDING IN YOUR PORTS with flag id","year","Coverage of eReported data - what percentage of trips are eReported(eTunalog,iFims,OnBoard,JsonStandard)? FOR TRIPS FROM ALL FLEETS LANDING IN YOUR COUNTRY's PORTS(including flag- Part 2 of report# 3293)","",NA,NA,NA,3505,"eparamal@spc.int","eparamal@spc.int","Logsheet, Longline, PoleAndLine, Purseseine, Ereporting","2023-03-07T16:18:22.497","with #base as (Select 'PS' as gear,
	vi.flag_id,
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.vw_trips_ps_HIVE_valid t 
inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id 
	and t.depart_date between vi.start_date and vi.calculated_end_date
inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
	AND ('HIVE' = 'HIVE' OR p.country_code = 'HIVE')
group by year(depart_date),
	system_source,
	vi.flag_id
UNION
Select 'LL' as gear,
	vi.flag_id,
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.vw_trips_ll_HIVE_valid t inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id and t.depart_date between vi.start_date and vi.calculated_end_date
	inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
AND ('HIVE' = 'HIVE' OR p.country_code = 'HIVE')
group by year(depart_date),
	system_source,
	vi.flag_id
UNION
Select 'PL' as gear,
	vi.flag_id,
	year(depart_date) as yy,
	system_source,
	count(1) as num
from log.vw_trips_pl_HIVE_valid t inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id and t.depart_date between vi.start_date and vi.calculated_end_date
	inner join ref.ports p on p.port_id = t.return_port_id
where year(depart_date) = coalesce(:year,year(depart_date))
AND ('HIVE' = 'HIVE' OR p.country_code = 'HIVE')
group by year(depart_date),
	system_source, vi.flag_id) select gear,
	flag_id,
		yy,
		sum(num) as total_trips,
		sum(case when system_source in ('eTunalog','iFIMS','OnBoard','JsonStandard') then num else 0 end) as eReported_number
from #base 
group by gear, yy, flag_id",NA
"356","77cfc3b9-793b-4c8e-8fc2-ac0e00adb3cd"," LONGLINE -- Baits usage","eez_code, year","LONGLINE -- Baits usage by year, flag","Observer",NA,"Observer","80",3401,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-03-14T14:58:21.183"," select yr,flag_id,eez_code,bait_sp_code,sp_name,sum(bait_w) as bait_w from (
	select year(dep_date) as yr,flag_id,bait1_sp_code as bait_sp_code,sum(coalesce(bait1_w,0)) as bait_w,eez_code FROM obsv.trip t    
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
	join ref.vessels ve on ve.vessel_id = v.vessel_id
	join obsv.l_set s on t.obstrip_id = s.obstrip_id
	join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83
	group by year(dep_date),flag_id,bait1_sp_code,eez_code
	union all
	select year(dep_date) as yr,flag_id,bait2_sp_code as bait_sp_code,sum(coalesce(bait2_w,0)) as bait_w,eez_code FROM obsv.trip t    
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
	join obsv.l_set s on t.obstrip_id = s.obstrip_id
	join ref.vessels ve on ve.vessel_id = v.vessel_id
	join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83
	group by year(dep_date),flag_id,bait2_sp_code,eez_code
	union all
	select year(dep_date) as yr,flag_id,bait3_sp_code as bait_sp_code,sum(coalesce(bait3_w,0)) as bait_w,eez_code FROM obsv.trip t    
	join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
	join obsv.l_set s on t.obstrip_id = s.obstrip_id
	join ref.vessels ve on ve.vessel_id = v.vessel_id
	join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83
	group by year(dep_date),flag_id,bait3_sp_code,eez_code) t join ref.species sp on sp.sp_code = t.bait_sp_code
where bait_w >0 and yr = coalesce(:year,YEAR(yr)) and eez_code = coalesce(:eez_code,eez_code)
group by yr,flag_id,bait_sp_code,sp_name,eez_code",NA
"357","e8085ffa-cf6d-42ca-9517-a82600ab006f"," LONGLINE - Logsheets - Average delay (days) between end of trip and data availability for reporting","","This report highlight the average number of days needed (per year/month) to get logsheet data entered and available for reporting after the end of trips","Logsheets",1,NA,"2",3224,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, Ereporting","2021-10-19T15:37:04.883"," SELECT 	str(year(first_logdate),4) + '-' + REPLACE(Str(MONTH(first_logdate),2),SPACE(1),'0') as yr_week,
		AVG(DATEDIFF(day,return_date,entered_date)) as avg_delay
FROM log.trips_ll T
WHERE year(first_logdate)>=2016 and return_date is not null and entered_date is not null
GROUP BY str(year(first_logdate),4) + '-' +  REPLACE(Str(MONTH(first_logdate),2),SPACE(1),'0')",NA
"358","aee6bb7f-694f-43ed-aa6d-a84e01219bc4"," ARTISANAL - Tails statistics - Percentage of zero catch logs per data collector","year","Find data collectors who skip no catch logsheets by checking what percent of their recorded logs actually include zero catch logsheets.","Artisanal",1,NA,"99.3",3232,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, CoverageMissingData, DataQuality","2021-10-13T14:26:07.753","with #t1 (trip_date, art_trip_id, entered_by, catch_or_not) as
(select t.trip_date,
	t.art_trip_id,
	t.entered_by,
	case when c.sp_code is null then 0 else 1 end as catch_or_not
from art2.trips t inner join art2.effort e on t.art_trip_id = e.art_trip_id
	left join art2.catch c on c.art_effort_id = e.art_effort_id),

#t2 (trip_date, entered_by, art_trip_id, catch_op)  as 
(select trip_date, entered_by, art_trip_id, MAX(catch_or_not)
from #t1
group by trip_date, entered_by, art_trip_id),

#t3 (entered_by,zero_catches,non_zero_catches) as (select entered_by,
	sum(case when catch_op = 0 then 1 else 0 end) as zero_catches,
	sum(case when catch_op = 1 then 1 else 0 end) as non_zero_catches
from #t2
where YEAR(trip_date) = coalesce(:year,YEAR(trip_date))
group by entered_by)



 select entered_by,
	zero_catches,
	non_zero_catches,
	(zero_catches + non_zero_catches) as total_trips,
	cast((cast(zero_catches as decimal(7,2)) / (zero_catches + non_zero_catches)) as decimal(7,2)) * 100 as percent_zero
from #t3",NA
"359","a32822d4-73e7-4b48-96e7-9c260639412c"," Part1 - Figure X - Map - PURSE SEINE COASTAL STATE REPORT - effort by EEZ","year","Map - ALL PURSE SEINE FLEET effort in EEZ","Logsheets",2,NA,"10b",3140,"andrewh@spc.int","shaazreenb@spc.int","Logsheet, Purseseine, CMM","2025-07-24T09:42:46.477"," SELECT floor(latd/5)*5+2.5 Latitude,floor(case when s.lond < 0 then s.lond + 360 else s.lond end/5)*5+2.5 Longitude, 
		Count(distinct case when (s.s_activity_id in (1,2)) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as days
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id = s.log_trip_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	YEAR(logdate) = coalesce(:year, year(logdate))
AND	(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY floor(latd/5)*5+2.5 ,floor(case when s.lond < 0 then s.lond + 360 else s.lond end/5)*5+2.5",NA
"360","6c89aea1-3580-40e8-a891-a89e00d05140"," PURSE SEINE - Logsheet / Unloadings reconciliation - Details by TRIP","flag_code, year",NA,"Port,Logsheets",NA,NA,"5.1.2",3240,"andrewh@spc.int","brunod@spc.int","Logsheet, Unloading, Purseseine, CoverageMissingData","2021-10-29T15:06:12.733"," SELECT      vi.vesselname vessel_name, 
			vi.flag_id flag_code, 
			CONVERT(nvarchar,t.depart_date,111) depart_date,dp.port_name dp,
			CONVERT(nvarchar,t.return_date,111) return_date,rp.port_name rp,
			max(coalesce(z.skj_c,0)) as skj_log,
			max(coalesce(z.yft_c,0)) as yft_log,
			max(coalesce(z.bet_c,0)) as bet_log,
			max(coalesce(x.skj_c,0)) as skj_unl,
			max(coalesce(x.yft_c,0)) as yft_unl,
			max(coalesce(x.bet_c,0)) as bet_unl
FROM    log.trips_ps t
		LEFT OUTER JOIN ( select s.log_trip_id, 
							SUM(case when sp_code = 'SKJ' then c.sp_mt else 000000 end) as skj_c,
							SUM(case when sp_code = 'YFT' then c.sp_mt else 000000 end) as yft_c,
							SUM(case when sp_code = 'BET' then c.sp_mt else 000000 end) as bet_c
					 from log.sets_ps s 
							INNER JOIN log.catch_ps c on  s.log_set_id = c.log_set_id 
					 group by s.log_trip_id, c.sp_code) z on t.log_trip_id = z.log_trip_id 		
		LEFT OUTER JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left 
					AND l.dto_type_left='PurseseineLogsheetDTO'  
					AND l.dto_type_right='CarrierLoadingDTO'
        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
        INNER JOIN ref.ports dp ON t.depart_port_id = dp.port_id
        INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
		LEFT OUTER JOIN (	select  c.carrier_loading_id, 
									h.vessel_id,
									SUM(case when sp_code = 'SKJ' then d.sp_mt else 000000 end) as skj_c,
									SUM(case when sp_code = 'YFT' then d.sp_mt else 000000 end) as yft_c,
									SUM(case when sp_code = 'BET' then d.sp_mt else 000000 end) as bet_c
							from unload2.carrier_loading c
									inner join unload2.unloadings_ps h on c.carrier_loading_id = h.carrier_loading_id
									inner join unload2.unloading_catch_ps d on h.unload_id = d.unload_id
							group by c.carrier_loading_id, h.vessel_id,d.sp_code) x on l.dto_guid_right = x.carrier_loading_id and x.vessel_id = t.vessel_id
WHERE     COALESCE(:year,YEAR(t.depart_date)) = YEAR(t.depart_date)
	AND   COALESCE(:flag_code,vi.flag_id) = vi.flag_id
group by 
	vi.vesselname, 
	vi.flag_id, 
	CONVERT(nvarchar,t.depart_date,111),dp.port_name,
	CONVERT(nvarchar,t.return_date,111),rp.port_name",NA
"361","1c9d7129-c150-4ae2-8680-a716010eab57"," Longline - Catch report summary (Tuna, billfish, bycatch, sharks, turtles, birds, mammals) and total sum","year","Shows an overview per trip of the catch. The catch is broken up into tuna caught, billfish caught, bycatch, unmarketable, crew consumption, sharks birds, turtles and mammals. Built on request for NC fisheries.
Bycatch = DOL;WAH;LAG;TST;","Observer",NA,"Observer","31",3157,"andrewh@spc.int","colleyf@spc.int","Observer, Longline, Custom","2021-11-17T11:40:10.107"," select staff_code,tripno,vesselname,dep_date,sum(coalesce(setlog_recs,0)) setlog_recs,sum(hook_set) total_hooks,sum(tuna_no) tuna_no,sum(tuna_kg) tuna_kg,sum(bil_no) bil_no,sum(bil_kg) bil_kg, sum(bycatch_no) bycatch_no, sum(bycatch_kg) bycatch_kg,sum(unmark_no) unmark_no,
	sum(unmark_kg) unmark_kg,sum(cc_no) cc_no,sum(cc_kg) cc_kg,sum(shk_no) shk_no,sum(shk_kg) shk_kg,sum(brd_no) brd_no,sum(brd_kg) brd_kg,sum(turt_no) turt_no,sum(turt_kg) turt_kg,sum(mam_no) mam_no,sum(mam_kg) mam_kg,
	sum(tuna_no)+sum(bil_no)+sum(bycatch_no)+sum(cc_no)+sum(shk_no)+sum(brd_no)+sum(turt_no)+sum(unmark_no)+sum(mam_no) as total
from (
SELECT     staff_code,ot.tripno,v.vesselname,ot.dep_date,
        hook_set,
		set_number,
		count(distinct l_setlog_id) as setlog_recs,
        SUM(case when sp.sp_cat_code = 'TUN' and fate_code <> 'RCC' then 0001 else 0000 end) as tuna_no,
        SUM(case when sp.sp_cat_code = 'TUN' and fate_code <> 'RCC' then lc.wt_est else 0000 end) as tuna_kg,
        SUM(case when sp.sp_cat_code = 'BIL' and fate_code <> 'RCC' then 0001 else 0000 end) as bil_no,
        SUM(case when sp.sp_cat_code = 'BIL' and fate_code <> 'RCC' then lc.wt_est else 0000 end) as bil_kg,
        SUM(case when sp.sp_code in ('DOL','WAH','LAG','TST') and fate_code <> 'RCC' then 0001 else 0000 end) as bycatch_no,
        SUM(case when sp.sp_code in ('DOL','WAH','LAG','TST') and fate_code <> 'RCC' then lc.wt_est else 0000 end) as bycatch_kg,
		SUM(case when coalesce(sp.sp_cat_code,'X') not in ( 'TUN','BIL','SHK','BRD','TTX','MAM') and coalesce(sp.sp_code,'X') not in ('DOL','WAH','LAG','TST') and fate_code <> 'RCC' then 0001 else 0000 end) as unmark_no,
        SUM(case when coalesce(sp.sp_cat_code,'X') not in ( 'TUN','BIL','SHK','BRD','TTX','MAM') and coalesce(sp.sp_code,'X') not in ('DOL','WAH','LAG','TST') and fate_code <> 'RCC' then lc.wt_est else 0000 end) as unmark_kg,
        SUM(case when fate_code = 'RCC' then 0001 else 0000 end) as cc_no,
        SUM(case when fate_code = 'RCC' then lc.wt_est else 0000 end) as cc_kg,
        SUM(case when sp.sp_cat_code = 'SHK' or sp_cat_code = 'SHK' and sp_name LIKE '%SHARK%' or sp_name LIKE '%HAMMERHEAD%' or sp_name LIKE '%DOGFISH%' then 0001 else 0000 end) as shk_no,
        SUM(case when sp.sp_cat_code = 'SHK' or sp_cat_code = 'SHK' and sp_name LIKE '%SHARK%' or sp_name LIKE '%HAMMERHEAD%' or sp_name LIKE '%DOGFISH%' then lc.wt_est else 0000 end) as shk_kg,
        SUM(case when sp.sp_cat_code = 'BRD' then 0001 else 0000 end) as brd_no,
        SUM(case when sp.sp_cat_code = 'BRD' then lc.wt_est else 0000 end) as brd_kg,
        SUM(case when sp.sp_cat_code = 'TTX' then 0001 else 0000 end) as turt_no,
        SUM(case when sp.sp_cat_code = 'TTX' then lc.wt_est else 0000 end) as turt_kg,
		SUM(case when sp.sp_cat_code = 'MAM' then 0001 else 0000 end) as mam_no,
        SUM(case when sp.sp_cat_code = 'MAM' then lc.wt_est else 0000 end) as mam_kg

 FROM    obsv.trip ot 
            left outer join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
            inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
            left outer join obsv.l_sethaullog hl on hl.l_set_id = ls.l_set_id and stend_id = 83
            inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
            inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join ref.field_staff f on f.staff_id=ot.observer_id
WHERE
        YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
GROUP BY  
        staff_code,ot.tripno,v.vesselname,ot.dep_date,hook_set, set_number) t1
group by staff_code,tripno,vesselname,dep_date",NA
"362","6cd73534-1014-4d5a-b5be-a79e01221ecb"," CMM 05-03 – North Pacific Albacore catches by National Fleet BY VESSEL","year","Custom Version of CMM 05-03 for Fiji requested by jyanti to be able to break down the reported CMM by charter vessels and actual flagged vessels.","Logsheets",NA,NA,"60",3187,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, ByVessel, CMM, Custom, RegionalReporting, Tuna","2023-07-04T11:07:13.85"," SELECT  vi.flag_id as flag, 
		year(logdate) as yr,
		vi.vesselname as vessel,
		case when month(logdate) < 7 then 'Jan-Jun' else 'Jul-Dec' end as period,
		count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as NumVessels,
		count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as DaysAtSea,
		SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = @@entity
group by vi.flag_id, year(logdate), vi.vesselname, case when month(logdate) < 7 then 'Jan-Jun' else 'Jul-Dec' end",NA
"363","cbbd2571-39ad-4301-b48e-09aebac08e12"," PURSE SEINE - Check Vessels in your NATIONAL FLEET","year","Report to check each PURSE SEINE VESSEL name and GRT for your NATIONAL FLEET based on the most recently completed calendar year","Logsheets",NA,NA,"21b",3061,"andrewh@spc.int","brunod@spc.int","Logsheet, Purseseine, ByVessel, DataQuality, RegionalReporting","2021-10-07T14:15:22.457"," SELECT	distinct vi.flag_id flag_code,
				vi.vesselname vessel_name, 
				vi.vesselname_normalised,
				v.grt,
				count(distinct l.log_trip_id) as trips
FROM  ref.vessel_instances vi 
				INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.trips_ps l ON l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(l.FIRST_LOGDATE) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by	vi.flag_id,
			vi.vesselname, 
			vi.vesselname_normalised,
			v.grt",NA
"364","c3800034-3d75-4b1a-8483-4600b71624b1"," ARTISANAL - Catch by Species Type by Year","year","Artisanal catch by species type for the entire EEZ - Requested by TV. ","Artisanal",1,NA,"20",3069,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, AllSpecies","2023-03-28T11:14:42.65"," select YEAR(t.trip_date) as year,
	s.sp_cat_code,
	sum(c.sp_n) as num,
	SUM(c.sp_kg) as kg
from art2.trips t
inner join art2.effort e on e.art_trip_id = t.art_trip_id 
inner join art2.catch c on e.art_effort_id = c.art_effort_id
inner join ref.species s on c.sp_code = s.sp_code
where YEAR(trip_date)=coalesce(:year, year(t.trip_date))
group by YEAR(t.trip_date),s.sp_cat_code",NA
"365","5074d21e-5b52-4761-8f28-a8b20101a58b"," LONGLINE Observer in WCPFC Area - Full reconciliation - NATIONAL FLEET","year",NA,"Observer,VMS",NA,NA,"6.2.2",3248,"andrewh@spc.int","brunod@spc.int","Observer, Longline, CoverageMissingData, RegionalReporting","2023-04-03T15:32:40.203","    SELECT  distinct t.vms_trip_id,vi.vesselname, vi.flag_id,t.departure_date,dp.port_name dp,t.return_date, rp.port_name rp, l.obstrip_id, l.dep_date, l.ret_date log_return_date INTO #mapped_trip
    FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
			INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id AND v.gear='L'
			INNER JOIN vms.vms_trip_efforts eez ON eez.vms_trip_id = t.vms_trip_id AND eez.year=:year
			INNER JOIN ref.ports dp ON dp.port_id = t.departure_port_id
			INNER JOIN ref.ports rp ON rp.port_id = t.return_port_id
			LEFT OUTER JOIN obsv.trip l  ON t.vessel_id = l.vessel_id AND (
				  (l.dep_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.ret_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date)))
	WHERE 	DATEDIFF(DAY, t.departure_date,t.return_date)>5
	AND     day_fishing>1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
	ORDER BY vi.vesselname,departure_date
	 
select vesselname vessel_name, flag_id flag_code, CONVERT(nvarchar,departure_date,111) vms_departure_date, dp, CONVERT(nvarchar,return_date,111) vms_return_date, rp, CONVERT(nvarchar,dep_date ,111) log_departure_date, CONVERT(nvarchar,log_return_date ,111) log_return_date, obstrip_id LonglineObserverDTO 
from #mapped_trip",NA
"366","e199b31b-1df9-42a7-a273-a75400b4b66b"," PURSE SEINE -- WCPFC key species catch and discard/release -- detailed statistics","flag_code, year",NA,"Observer",NA,"Observer","32",3174,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine","2022-02-22T09:50:46.563","DECLARE @sp_code nvarchar(90)
DECLARE @sp_name char(3)
DECLARE @sp_list nvarchar(90)
DECLARE @cnt_0 int
DECLARE @cnt_0_str char(4)

set @sp_list = 'SKJYFTBETALBMLSBUMBLMSWORHNBSHFALOCSMAKTHRHAMPOR'
set @cnt_0 = 1

create table #temp_d2 (
	sp_name char(3),
	trips	int,
	No_Ret_cnt	int,
	No_Disc_cnt int,
	No_Ret	int,
	Kgs_Ret	decimal(19,6),
	No_Disc int,
	kgs_Disc decimal(19,6),
	MEDIAN_No_Ret	int,
	MEDIAN_Kgs_Ret decimal(19,6),
	MEDIAN_No_Disc	int,
	MEDIAN_kgs_Disc decimal(19,6),
	AVG_No_Ret	decimal(19,6),
	AVG_Kgs_Ret decimal(19,6),
	AVG_No_Disc	decimal(19,6),
	AVG_kgs_Disc decimal(19,6))



while @cnt_0 < 17
begin

	set @sp_name = substring(@sp_list,(@cnt_0-1)*3+1,3)
	
	if	@sp_name = 'THR' 
		set @sp_code = 'BTH,PTH,THR,ALV'
	if @sp_name = 'MAK' 
		set @sp_code = 'MAK,LMA,SMA'
	if @sp_name = 'HAM' 
		set	@sp_code = 'SPK,SPL,SPN,SPQ,SPZ'
	if @sp_name <> 'HAM' and @sp_name <> 'MAK' and @sp_name <> 'THR' 
		set @sp_code = @sp_name



If(OBJECT_ID('tempdb..#temp_d1') Is Not Null)
Begin
    Drop Table #temp_d1
End

If(OBJECT_ID('tempdb..#temp_d3') Is Not Null)
Begin
    Drop Table #temp_d3
End

SELECT     
		ot.obstrip_id,
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then sp_n_est else 0.0 end) as No_ret, 
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'R' then sp_c_est else 0.000 end)*1000 as kgs_ret,
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' then sp_n_est else 0.0 end) as No_disc, 
        sum(case when charindex(sc.sp_code,(@sp_code)) > 0 and left(fate_code,1) = 'D' then sp_c_est else 0.000 end)*1000 as kgs_disc
INTO #temp_d1
FROM    obsv.trip ot 
            inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
 			inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
			inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
			inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
			inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id  
 WHERE YEAR(act_date) = coalesce(:year, YEAR(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
GROUP BY  
        ot.obstrip_id

insert into #temp_d2
select 
	max(@sp_name) as sp_name,
	count(*) as trips,
	sum(case when No_Ret>0 then 1 else 0 end)  as No_Ret_cnt,
	sum(case when No_Disc>0 then 1 else 0 end) as No_Disc_cnt,
	sum(No_Ret)  as No_Ret,
	sum(kgs_Ret) as Kgs_Ret,
	sum(No_Disc) as No_Disc,
	sum(kgs_Disc) as kgs_Disc,
	MAX(100000.000) as MEDIAN_No_Ret,
	MAX(100000.000) as MEDIAN_Kgs_Ret,
	MAX(100000.000) as MEDIAN_No_Disc,
	MAX(100000.000) as MEDIAN_kgs_Disc,
	sum(No_Ret)  / COUNT(*) as AVG_No_Ret,
	sum(kgs_Ret) / COUNT(*) as AVG_Kgs_Ret,
	sum(No_Disc) / COUNT(*) as AVG_No_Disc,
	sum(kgs_Disc) / COUNT(*) as AVG_kgs_Disc
from #temp_d1 

DECLARE @cnt INT = 1;
DECLARE @Fld_Names CHAR(32) = 'No_Ret  kgs_Ret No_Disc kgs_Disc';
DECLARE @Fld_Name CHAR(8);
DECLARE @Med_Fld_Name CHAR(15);

WHILE @cnt < 5  
BEGIN

	SET @Fld_Name = SUBSTRING(@Fld_Names,(@cnt-1)*8+1,8)
	SET @Med_Fld_Name = 'MEDIAN_'+SUBSTRING(@Fld_Names,(@cnt-1)*8+1,8)
	
	create table #temp_d3 (xfld  decimal(20,7))
	
	EXEC(
	'INSERT INTO #temp_d3 SELECT
	( (SELECT MAX(' + @Fld_Name + ') FROM
		(SELECT TOP 50 PERCENT ' + @Fld_Name + ' FROM #temp_d1 ORDER BY ' + @Fld_Name + ') AS BottomHalf) 
		+
		(SELECT MIN(' + @Fld_Name + ') FROM
		(SELECT TOP 50 PERCENT ' + @Fld_Name + ' FROM #temp_d1 ORDER BY ' + @Fld_Name + ' DESC) AS TopHalf)
	) / 2 AS xfld')

	EXEC(
	
	'UPDATE #temp_d2 SET ' + @Med_Fld_Name + ' = cast(#temp_d3.xfld as float) from #temp_d3 where #temp_d2.sp_name = ''' + @sp_name + '''' )
	
	If(OBJECT_ID('tempdb..#temp_d3') Is Not Null)
	Begin
		Drop Table #temp_d3
	End

	set @cnt = @cnt + 1
END


set @cnt_0 = @cnt_0 + 1

end
 select 
	sp_name,
	trips,
	No_Ret_cnt,
	No_Disc_cnt,
	No_Ret,
	Kgs_Ret/1000 as MT_Ret,
	No_Disc,
	kgs_Disc/1000 as MT_Disc,
	MEDIAN_No_Ret,
	MEDIAN_Kgs_Ret/1000 as MEDIAN_MT_Ret,
	MEDIAN_No_Disc,
	MEDIAN_kgs_Disc/1000 as MEDIAN_MT_Disc,
	AVG_No_Ret,
	AVG_Kgs_Ret/1000 as AVG_MT_Ret,
	AVG_No_Disc,
	AVG_kgs_Disc/1000 as AVG_MT_Disc
from #temp_d2",NA
"367","02ef1ff2-14c7-45a0-87a2-a6ef34e48151"," CHECK GROUP BY UNLOADINGS - Monthly unloadings by fresh / frozen or market destination","year","UNLOADINGS - Monthly unloadings by fresh / frozen","Port",NA,NA,"51",3087,"andrewh@spc.int","emmanuels@spc.int","Unloading, Longline, ByVessel, AllSpecies","2022-07-08T10:22:01.07"," SELECT	YEAR(U.unload_startdate) AS year,:group_by,C.sp_code species_code,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=1 THEN C.sp_n ELSE 0 END) AS Jan_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=2 THEN C.sp_n ELSE 0 END) AS Feb_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=3 THEN C.sp_n ELSE 0 END) AS Mar_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=4 THEN C.sp_n ELSE 0 END) AS Apr_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=5 THEN C.sp_n ELSE 0 END) AS May_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=6 THEN C.sp_n ELSE 0 END) AS Jun_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=7 THEN C.sp_n ELSE 0 END) AS Jul_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=8 THEN C.sp_n ELSE 0 END) AS Aug_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=9 THEN C.sp_n ELSE 0 END) AS Sep_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=10 THEN C.sp_n ELSE 0 END) AS Oct_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=11 THEN C.sp_n ELSE 0 END) AS Nov_n,SUM(CASE WHEN MONTH(U.Unload_startdate)=12 THEN C.sp_n ELSE 0 END) AS Dec_n,
		SUM(C.sp_n) AS Tot_n,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=1 THEN C.sp_kg ELSE 0 END) AS Jan_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=2 THEN C.sp_kg ELSE 0 END) AS Feb_Kg,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=3 THEN C.sp_kg ELSE 0 END) AS Mar_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=4 THEN C.sp_kg ELSE 0 END) AS Apr_Kg,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=5 THEN C.sp_kg ELSE 0 END) AS May_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=6 THEN C.sp_kg ELSE 0 END) AS Jun_Kg,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=7 THEN C.sp_kg ELSE 0 END) AS Jul_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=8 THEN C.sp_kg ELSE 0 END) AS Aug_Kg,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=9 THEN C.sp_kg ELSE 0 END) AS Sep_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=10 THEN C.sp_kg ELSE 0 END) AS Oct_Kg,
		SUM(CASE WHEN MONTH(U.Unload_startdate)=11 THEN C.sp_kg ELSE 0 END) AS Nov_Kg,SUM(CASE WHEN MONTH(U.Unload_startdate)=12 THEN C.sp_kg ELSE 0 END) AS Dec_Kg,
		SUM(C.sp_kg) AS Tot_Kg 
FROM	unload2.unloadings AS U INNER JOIN unload2.unloading_catch AS C ON U.unload_id = C.unload_id 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id = U.vessel_id AND U.unload_enddate BETWEEN vi.start_date AND vi.calculated_end_date
		left join ref.ports P on U.port_id = P.port_id
WHERE	YEAR(U.Unload_startdate)=:year
GROUP BY YEAR(U.unload_startdate), :group_by, C.sp_code","FishState"
"368","3ab44421-5b33-463f-8e80-43d6e0d0412f"," ARTISANAL - Annual Catch and Effort for main species - UNRAISED","year",NA,"Artisanal",NA,NA,"5",3095,"andrewh@spc.int","andrewh@spc.int","Logsheet, Artisanal, Unraised, AllSpecies","2021-10-07T17:06:48.127"," SELECT	(
			SELECT	SUM(e.hours_fished_n)
			FROM	art2.trips t INNER JOIN art2.effort e ON t.art_trip_id = e.art_trip_id
			WHERE	YEAR(t.trip_date)=:year
		) nb_hours,
		SUM(CASE sp_code WHEN 'ALB' THEN c.sp_kg ELSE 000.0 END) / 1000 AS alb_mt, 
		SUM(CASE sp_code WHEN 'BET' THEN c.sp_kg ELSE 000.0 END) / 1000 AS BET_mt,
		SUM(CASE sp_code WHEN 'YFT' THEN c.sp_kg ELSE 000.0 END) / 1000 AS YFT_mt,
		SUM(CASE sp_code WHEN 'SKJ' THEN c.sp_kg ELSE 000.0 END) / 1000 AS SKJ_mt,
		SUM(CASE sp_code WHEN 'PBF' THEN c.sp_kg ELSE 000.0 END) / 1000 AS PBF_mt,
		SUM(CASE sp_code WHEN 'BLM' THEN c.sp_kg ELSE 000.0 END) / 1000 AS BLM_mt,
		SUM(CASE sp_code WHEN 'BUM' THEN c.sp_kg ELSE 000.0 END) / 1000 AS BUM_mt,
		SUM(CASE sp_code WHEN 'MLS' THEN c.sp_kg ELSE 000.0 END) / 1000 AS MLS_mt,
		SUM(CASE sp_code WHEN 'SWO' THEN c.sp_kg ELSE 000.0 END) / 1000 AS SWO_mt,
		SUM(CASE sp_code WHEN 'SSP' THEN c.sp_kg ELSE 000.0 END) / 1000 AS SSP_mt,
		SUM(CASE sp_code WHEN 'SFA' THEN c.sp_kg ELSE 000.0 END) / 1000 AS SFA_mt,
		SUM(CASE sp_code WHEN 'DOL' THEN c.sp_kg ELSE 000.0 END) / 1000 AS DOL_mt,
		SUM(CASE sp_code WHEN 'LAG' THEN c.sp_kg ELSE 000.0 END) / 1000 AS LAG_mt,
		SUM(CASE sp_code WHEN 'OIL' THEN c.sp_kg ELSE 000.0 END) / 1000 AS OIL_mt,
		SUM(CASE sp_code WHEN 'WAH' THEN c.sp_kg ELSE 000.0 END) / 1000 AS WAH_mt,
		SUM(CASE sp_code WHEN 'BSH' THEN c.sp_kg ELSE 000.0 END) / 1000 AS BSH_mt,
		SUM(CASE sp_code WHEN 'FAL' THEN c.sp_kg ELSE 000.0 END) / 1000 AS FAL_mt,
		SUM(CASE sp_code WHEN 'OCS' THEN c.sp_kg ELSE 000.0 END) / 1000 AS OCS_mt,
		SUM(CASE sp_code WHEN 'MAK' THEN c.sp_kg ELSE 000.0 END) / 1000 AS MAK_mt,
		SUM(CASE sp_code WHEN 'THR' THEN c.sp_kg ELSE 000.0 END) / 1000 AS THR_mt,
		SUM(CASE sp_code WHEN 'SHK' THEN c.sp_kg ELSE 000.0 END) / 1000 AS SHK_mt,
		SUM(CASE sp_code WHEN 'ALB' THEN 0 WHEN 'BET' THEN 0 WHEN 'YFT' THEN 0 WHEN 'SKJ' THEN 0 WHEN 'PBF' THEN 0 WHEN 'BLM' THEN 0 WHEN 'BUM' THEN 0 WHEN 'MLS' THEN 0 WHEN 'SWO' THEN 0
		WHEN 'SSP' THEN 0 WHEN 'SFA' THEN 0 WHEN 'DOL' THEN 0 WHEN 'LAG' THEN 0 WHEN 'OIL' THEN 0 WHEN 'WAH' THEN 0 WHEN 'BSH' THEN 0 WHEN 'FAL' THEN 0 WHEN 'OCS' THEN 0 WHEN 'MAK' THEN 0 WHEN 'THR' THEN 0 WHEN 'SHK' THEN 0 ELSE c.sp_kg END) / 1000 AS OTH_mt
FROM	art2.trips t INNER JOIN art2.effort e ON t.art_trip_id = e.art_trip_id 
		INNER JOIN art2.catch c ON e.art_effort_id = c.art_effort_id
WHERE	YEAR(t.trip_date)=:year",NA
"369","825849d3-8315-e81d-1022-3a037a6dafac"," LONGLINE - NATIONAL FLEET - All Species Catch BY EEZ, vessel AND/OR flag","eez_code, year",NA,"Logsheets",NA,NA,NA,3472,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, ByVessel, RegionalReporting, AllSpecies","2022-06-24T13:45:34.093"," SELECT  Year(logdate) as year, 
		:group_by,
        c.sp_code,
	spec.sp_name,
        cast(Sum(sp_kg_est) /1000.0                                                          as decimal(7,2))     AS tot_mt, 
        cast(Sum(sp_n_est)                                                                       as decimal(7,0))    AS tot_n,
        cast(Sum(spdiscard_n)                                                                as decimal(7,0)) as discard_N
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
                    left outer join log.catch_ll c on s.log_set_id = c.log_set_id 
                    inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
                    inner join ref.species spec on spec.sp_code = c.sp_code
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  and (s.eez_code = coalesce(:eez_code,s.eez_code) OR (:eez_code = 'KI' and s.eez_code in ('KI','GL','PX','LN')))
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
and vi.flag_id = @@entity
group by Year(logdate), 
		:group_by,
        c.sp_code,  spec.sp_name","VesselFlagEEZ"
"370","12c58d8c-b014-4685-93a4-a79000c1fbd3"," ARTISANAL - DQ Check: Count of fishing activity data, per landing site per day (only shows results > 1)","year","DQ Check - Check for duplicate activity logs requested by Phil. Sometimes there might legitimately be landing sites with more than one activity log on one day (eg. morning and afternoon collection) however this gives some clues about possible duplicates","Artisanal",NA,NA,"7.1",3182,"andrewh@spc.int","andrewh@spc.int","Artisanal, DataQuality","2021-09-29T16:43:02.693","  SELECT ls.[landing_site_name]
	  ,CONVERT(VARCHAR(10),[activity_date],103) as activity_date
	  ,DATENAME(dw,[activity_date]) as day
	  ,Count(*) as record_count
  FROM art2.fishing_activity_log val
  inner join art2.landing_sites ls ON val.landing_site_id = ls.landing_site_id
  where	YEAR(activity_date)=coalesce(:year,year(activity_date))
  group by ls.[landing_site_name], CONVERT(VARCHAR(10),[activity_date],103), DATENAME(dw,[activity_date])
having count(*) > 1",NA
"371","25068726-f3ce-4f97-911d-a8e30096e116"," List of EM trips with existing/non-existing OBS and Logbook","year",NA,"Logsheets,Observer",NA,"Observer","5c",3256,"andrewh@spc.int","eparamal@spc.int","Logsheet, Observer, Longline, Emonitoring","2025-06-16T08:56:11.243"," SELECT trp.VESSEL_NAME
	,trp.obsprg_code as PROG_CODE
	,trp.EM_STAFF_CODE STAFF_CODE
	,('trip:' + trp.TRIPNO) AS TRIPNO
	,CONVERT(VARCHAR(10), trp.EM_DEP_DATE, 103) EM_DEP_DATE
	,CONVERT(VARCHAR(10), trp.EM_RET_DATE, 103) EM_RET_DATE
	,CASE 
		WHEN (
				trp.EM_DEP_DATE IS NOT NULL
				AND trp.EM_RET_DATE IS NOT NULL
				)
			THEN 'Y'
		ELSE 'N'
		END EM_TRIP
	,CASE 
		WHEN (
				trp.OBS_DEP_DATE IS NOT NULL
				AND trp.OBS_RET_DATE IS NOT NULL
				)
			THEN 'Y'
		ELSE 'N'
		END OBS_TRIP
	,CASE 
		WHEN (
				trp.LOG_DEP_DATE IS NOT NULL
				AND trp.LOG_RET_DATE IS NOT NULL
				)
			THEN 'Y'
		ELSE 'N'
		END LOG_TRIP
FROM (
	SELECT vi.vesselname AS VESSEL_NAME
		,em.obsprg_code
		,st.staff_code AS EM_STAFF_CODE
		,em.tripno AS TRIPNO
		,CASE 
			WHEN 'X' <> (
					SELECT 'X'
					FROM tufman2_dorado.obsv.trip ob
					WHERE ob.vessel_id = vi.vessel_id
						AND em.dep_date BETWEEN ob.dep_date - 2
							AND ob.dep_date + 2
					)
				AND 'X' <> (
					SELECT TOP 1 'X'
					FROM tufman2_dorado.log.trips_ll lg
					WHERE lg.vessel_id = vi.vessel_id
						AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
							AND vi.calculated_end_date
						AND em.dep_date BETWEEN lg.depart_date - 2
							AND lg.depart_date + 2
					)
				THEN NULL
			ELSE CONVERT(VARCHAR(10), em.dep_date, 103)
			END EM_DEP_DATE
		,CASE 
			WHEN 'X' <> (
					SELECT 'X'
					FROM tufman2_dorado.obsv.trip ob
					WHERE ob.vessel_id = vi.vessel_id
						AND em.dep_date BETWEEN ob.dep_date - 2
							AND ob.dep_date + 2
					)
				AND 'X' <> (
					SELECT TOP 1 'X'
					FROM tufman2_dorado.log.trips_ll lg
					WHERE lg.vessel_id = vi.vessel_id
						AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
							AND vi.calculated_end_date
						AND em.dep_date BETWEEN lg.depart_date - 2
							AND lg.depart_date + 2
					)
				THEN NULL
			ELSE CONVERT(VARCHAR(10), em.ret_date, 103)
			END EM_RET_DATE
		,CASE 
			WHEN 'X' = (
					SELECT 'X'
					FROM tufman2_dorado.obsv.trip ob
					WHERE ob.vessel_id = vi.vessel_id
						AND em.dep_date BETWEEN ob.dep_date - 2
							AND ob.dep_date + 2
					)
				THEN (
						SELECT CONVERT(VARCHAR(10), ob.dep_date, 103)
						FROM tufman2_dorado.obsv.trip ob
						WHERE ob.vessel_id = vi.vessel_id
							AND em.dep_date BETWEEN ob.dep_date - 2
								AND ob.dep_date + 2
						)
			ELSE NULL
			END OBS_DEP_DATE
		,CASE 
			WHEN 'X' = (
					SELECT 'X'
					FROM tufman2_dorado.obsv.trip ob
					WHERE ob.vessel_id = vi.vessel_id
						AND em.dep_date BETWEEN ob.dep_date - 2
							AND ob.dep_date + 2
					)
				THEN (
						SELECT CONVERT(VARCHAR(10), ob.ret_date, 103)
						FROM tufman2_dorado.obsv.trip ob
						WHERE ob.vessel_id = vi.vessel_id
							AND em.dep_date BETWEEN ob.dep_date - 2
								AND ob.dep_date + 2
						)
			ELSE NULL
			END OBS_RET_DATE
		,CASE 
			WHEN 'X' = (
					SELECT TOP 1 'X'
					FROM tufman2_dorado.log.trips_ll lg
					WHERE lg.vessel_id = vi.vessel_id
						AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
							AND vi.calculated_end_date
						AND em.dep_date BETWEEN lg.depart_date - 2
							AND lg.depart_date + 2
					)
				THEN (
						SELECT TOP 1 CONVERT(VARCHAR(10), lg.depart_date, 103)
						FROM tufman2_dorado.log.trips_ll lg
						WHERE lg.vessel_id = vi.vessel_id
							AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
								AND vi.calculated_end_date
							AND em.dep_date BETWEEN lg.depart_date - 2
								AND lg.depart_date + 2
						)
			ELSE NULL
			END AS LOG_DEP_DATE
		,CASE 
			WHEN 'X' = (
					SELECT TOP 1 'X'
					FROM tufman2_dorado.log.trips_ll lg
					WHERE lg.vessel_id = vi.vessel_id
						AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
							AND vi.calculated_end_date
						AND em.dep_date BETWEEN lg.depart_date - 2
							AND lg.depart_date + 2
					)
				THEN (
						SELECT TOP 1 CONVERT(VARCHAR(10), lg.return_date, 103)
						FROM tufman2_dorado.log.trips_ll lg
						WHERE lg.vessel_id = vi.vessel_id
							AND lg.FIRST_LOGDATE BETWEEN vi.[start_date]
								AND vi.calculated_end_date
							AND em.dep_date BETWEEN lg.depart_date - 2
								AND lg.depart_date + 2
						)
			ELSE NULL
			END AS LOG_RET_DATE
	FROM em.trip em
	INNER JOIN tufman2_dorado.ref.vessel_instances vi ON vi.vessel_id=em.vessel_id
		AND em.dep_date BETWEEN vi.[start_date] AND vi.calculated_end_date
	inner join ref.field_staff st on st.staff_id=em.observer_id
	WHERE COALESCE(:year, year(dep_date)) = year(dep_date)
	) trp",NA
"372","a8f817f0-8fce-4f09-8d92-f574f891d82f"," LONGLINE Observer CATCH Statistics","flag_code, year, obsv_prg, trip_id","A breakdown of CATCH by SPECIES and SPECIES GROUP  statistics for LONGLINE Observer trips by YEAR, FLAG, Observer Programme","Observer",1,"Observer"," 2",2927,"andrewh@spc.int","colleyf@spc.int","Observer, Longline","2022-03-14T14:59:45.79"," SELECT 	case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		sum(1) as No,
		SUM(1) / MAX(n) as sp_comp,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		SUM(0001.000) / MAX(hooks) * 1000 as CPUE,
		COUNT(distinct lc.l_set_id) / max(SETS) as freq,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Disc_perc,
		SUM(case when left(COALESCE(cond_code,cond_code2),1) = 'A' then 0001 else 0000 end)  / SUM(1.000) as alive_perc,
		SUM(case when left(COALESCE(cond_code,cond_code2),1) = 'D' then 0001 else 0000 end) / SUM(1.000) as dead_perc,
		SUM(case when sex_code = 'M' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as male_perc,
		SUM(case when sex_code = 'F' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as female_perc
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join ref.field_staff f on f.staff_id=ot.observer_id
			inner join (SELECT SUM(1)*1.000 as n,
								count(distinct ls.l_set_id)*1.000 as sets
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
								inner join ref.field_staff f on f.staff_id=ot.observer_id
						WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							AND COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno) tmp on tmp.n > 0		
			inner join (SELECT SUM(coalesce(hook_set,0000.000)) as hooks
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join ref.field_staff f on f.staff_id=ot.observer_id
						WHERE YEAR(set_date) = coalesce(:year, YEAR(set_date)) 
							AND flag_id = coalesce(:flag_code,flag_id)
							AND obsprg_code = coalesce(:obsv_prg,obsprg_code) 
							AND COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno) tmp2 on tmp2.hooks > 0		
WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
	AND obsprg_code = coalesce(:obsv_prg,obsprg_code)
	AND COALESCE(:trip_id,RTRIM(staff_code)+tripno) = RTRIM(staff_code)+tripno
GROUP BY  
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name",NA
"373","e88b78bf-e92f-4cd4-9760-cfdc4679d021"," LONGLINE - Compliance Summary (GEN-3)","year","List of Observer Trip Compliance Reports","Observer",NA,"Observer","3",2936,"andrewh@spc.int","colleyf@spc.int","Observer, Longline, Compliance","2022-07-19T13:31:12.39"," SELECT a.obsprg_code as obsprg_code,
       a.trip_year as trip_year, 
       a.gear_code as gear_code,
       SUM(a.RS_A) AS RS_A,
       SUM(a.RS_B) AS RS_B,
       SUM(a.RS_C) AS RS_C,
       SUM(a.RS_D) AS RS_D,
       SUM(a.NR_A) AS NR_A,
       SUM(a.NR_B) AS NR_B,
       SUM(a.NR_C) AS NR_C,
       SUM(a.NR_D) AS NR_D,
       SUM(a.NR_E) AS NR_E,
       SUM(a.NR_F) AS NR_F,
       SUM(a.NR_G) AS NR_G,
       SUM(a.WC_A) AS WC_A,
       SUM(a.WC_B) AS WC_B,
       SUM(a.WC_C) AS WC_C,
       SUM(a.LP_A) AS LP_A,
       SUM(a.LP_B) AS LP_B,
       SUM(a.LC_A) AS LC_A,
       SUM(a.LC_B) AS LC_B,
       SUM(a.LC_C) AS LC_C,
       SUM(a.LC_D) AS LC_D,
       SUM(a.LC_E) AS LC_E,
       SUM(a.LC_F) AS LC_F,
       SUM(a.SI_A) AS SI_A,
       SUM(a.SI_B) AS SI_B,
       SUM(a.PN_A) AS PN_A,
       SUM(a.PN_B) AS PN_B,
       SUM(a.PN_C) AS PN_C,
       SUM(a.PN_D) AS PN_D,
       SUM(a.PN_E) AS PN_E,
       SUM(a.SS_A) AS SS_A,
       SUM(a.SS_B) AS SS_B
FROM (
SELECT t.obsprg_code as obsprg_code
,DATEPART(yyyy,t.dep_date) as trip_year
,t.gear_code as gear_code
, CASE WHEN g.question_code = 'RS-A' THEN COUNT(g.question_code) ELSE 0 END AS RS_A
, CASE WHEN g.question_code = 'RS-B' THEN COUNT(g.question_code) ELSE 0 END AS RS_B
, CASE WHEN g.question_code = 'RS-C' THEN COUNT(g.question_code) ELSE 0 END AS RS_C
, CASE WHEN g.question_code = 'RS-D' THEN COUNT(g.question_code) ELSE 0 END AS RS_D
, CASE WHEN g.question_code = 'NR-A' THEN COUNT(g.question_code) ELSE 0 END AS NR_A
, CASE WHEN g.question_code = 'NR-B' THEN COUNT(g.question_code) ELSE 0 END AS NR_B
, CASE WHEN g.question_code = 'NR-C' THEN COUNT(g.question_code) ELSE 0 END AS NR_C
, CASE WHEN g.question_code = 'NR-D' THEN COUNT(g.question_code) ELSE 0 END AS NR_D
, CASE WHEN g.question_code = 'NR-E' THEN COUNT(g.question_code) ELSE 0 END AS NR_E
, CASE WHEN g.question_code = 'NR-F' THEN COUNT(g.question_code) ELSE 0 END AS NR_F
, CASE WHEN g.question_code = 'NR-G' THEN COUNT(g.question_code) ELSE 0 END AS NR_G
, CASE WHEN g.question_code = 'WC-A' THEN COUNT(g.question_code) ELSE 0 END AS WC_A
, CASE WHEN g.question_code = 'WC-B' THEN COUNT(g.question_code) ELSE 0 END AS WC_B
, CASE WHEN g.question_code = 'WC-C' THEN COUNT(g.question_code) ELSE 0 END AS WC_C
, CASE WHEN g.question_code = 'LP-A' THEN COUNT(g.question_code) ELSE 0 END AS LP_A
, CASE WHEN g.question_code = 'LP-B' THEN COUNT(g.question_code) ELSE 0 END AS LP_B
, CASE WHEN g.question_code = 'LC-A' THEN COUNT(g.question_code) ELSE 0 END AS LC_A
, CASE WHEN g.question_code = 'LC-B' THEN COUNT(g.question_code) ELSE 0 END AS LC_B
, CASE WHEN g.question_code = 'LC-C' THEN COUNT(g.question_code) ELSE 0 END AS LC_C
, CASE WHEN g.question_code = 'LC-D' THEN COUNT(g.question_code) ELSE 0 END AS LC_D
, CASE WHEN g.question_code = 'LC-E' THEN COUNT(g.question_code) ELSE 0 END AS LC_E
, CASE WHEN g.question_code = 'LC-F' THEN COUNT(g.question_code) ELSE 0 END AS LC_F
, CASE WHEN g.question_code = 'SI-A' THEN COUNT(g.question_code) ELSE 0 END AS SI_A
, CASE WHEN g.question_code = 'SI-B' THEN COUNT(g.question_code) ELSE 0 END AS SI_B
, CASE WHEN g.question_code = 'PN-A' THEN COUNT(g.question_code) ELSE 0 END AS PN_A
, CASE WHEN g.question_code = 'PN-B' THEN COUNT(g.question_code) ELSE 0 END AS PN_B
, CASE WHEN g.question_code = 'PN-C' THEN COUNT(g.question_code) ELSE 0 END AS PN_C
, CASE WHEN g.question_code = 'PN-D' THEN COUNT(g.question_code) ELSE 0 END AS PN_D
, CASE WHEN g.question_code = 'PN-E' THEN COUNT(g.question_code) ELSE 0 END AS PN_E
, CASE WHEN g.question_code = 'SS-A' THEN COUNT(g.question_code) ELSE 0 END AS SS_A
, CASE WHEN g.question_code = 'SS-B' THEN COUNT(g.question_code) ELSE 0 END AS SS_B
FROM [obsv].[gen3vr09] g INNER JOIN obsv.trip t
ON g.obstrip_id = t.obstrip_id
WHERE t.gear_code = 'L'
AND g.answer = 1
AND YEAR(t.dep_date) = coalesce(:year, YEAR(t.dep_date))
group by g.question_code,t.dep_date,t.obsprg_code, t.gear_code) a
group by a.obsprg_code,a.trip_year, a.gear_code",NA
"374","752935c9-0345-1452-ea9b-3a0bce78eec0","CMM 22-02 North Pacific Swordfish","year",NA,"Logsheets",NA,NA,NA,3512,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM, RegionalReporting, ByCatch","2023-06-15T10:44:54"," SELECT  
		'L' as gear,
		vi.flag_id as flag, 
		year(logdate) as yr,
		count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as NumVessels,
		count(distinct case when RIGHT(lat,1) = 'N' and  l_activity_id in (1) then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as DaysFishing,
		SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'N' then coalesce(sp_n_est,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'SWO' and RIGHT(lat,1) = 'N' then coalesce(sp_kg_est,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id = @@entity
	and right(lat,1) = 'N'
	and left(lat,2) >= '20'
group by vi.flag_id, year(logdate)",NA
"375","d5384922-9f22-c2af-682c-3a0bce423475","Number of artisanal data per submitter","year",NA,"Artisanal",NA,NA,NA,3511,"brunod@spc.int","brunod@spc.int","Artisanal, MyFleet","2023-06-15T09:45:57.313","SELECT	entered_by, YEAR(entered_date) year, MONTH(entered_date) month, COUNT(*) nb_logsheet
FROM	art2.trips
WHERE	COALESCE(:year, YEAR(entered_date)) = YEAR(entered_date)
GROUP BY entered_by, YEAR(entered_date), MONTH(entered_date)",NA
"376","1d11f7a9-ae7f-d2b1-9e57-3a0503240098","LONGLINE - Logsheet vs observer set catches","year","Comparison at set level between logsheet and observer data","Logsheets,Observer",NA,NA,NA,3487,"brunod@spc.int","aurelienp@spc.int","Logsheet, Observer, Longline, DataQuality, AllSpecies","2023-04-28T06:35:21.847","SELECT	vi.vesselname,
		CONVERT(nvarchar, t.depart_date, 111) depart_date, 
		CONVERT(nvarchar, t.return_date, 111) return_date, 
		o.tripno,
		CONVERT(nvarchar, s.logdate, 111) logdate, 
		c.sp_code,
		COALESCE(c.sp_n, 0) sp_n, 
		COALESCE(c.spdiscard_n, 0) spdiscard_n, 
		COUNT(DISTINCT oc.counter) obs_n,
		t.log_trip_id LonglineLogsheetDTO,
		o.obstrip_id ObserverTripDTO,
                bask_set,
                bask_observed,
                CASE WHEN bask_set = 0 THEN 0 ELSE round(bask_observed*1.0/bask_set*100,0) END as pct_observed
FROM	tufman2.viewpersist_entity_links_two_way el JOIN
		log.trips_ll t ON t.log_trip_id = el.dto_guid_left JOIN
		obsv.trip o ON o.obstrip_id = el.dto_guid_right JOIN
		ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date JOIN
		log.sets_ll s ON s.log_trip_id = t.log_trip_id JOIN
		obsv.l_set os ON os.obstrip_id = o.obstrip_id AND os.set_date = s.logdate JOIN
		log.catch_ll c ON c.log_set_id = s.log_set_id LEFT JOIN
		obsv.l_setcatch oc ON oc.l_set_id = os.l_set_id AND oc.sp_code = c.sp_code
WHERE	dto_type_left = 'LonglineLogsheetDTO'
AND		dto_type_right = 'ObserverTripDTO'
AND		YEAR(logdate) = COALESCE(:year, year(logdate))
GROUP BY vi.vesselname, t.depart_date, t.return_date, o.tripno, s.logdate, c.sp_code, COALESCE(c.sp_n, 0), COALESCE(c.spdiscard_n, 0), t.log_trip_id, o.obstrip_id,os.hook_set,os.hook_observed,bask_set,bask_observed",NA
"377","34c19f5a-086c-a32a-f339-3a1449bb7904","CMM Rays report","flag_code, year",NA,"Observer",NA,"Observer",NA,3553,"aurelienp@spc.int","aurelienp@spc.int","","2024-08-13T14:44:56.507"," SELECT 	
		'S' as gear, 
		sp.sp_name as species,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard, 

sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and left(discard_cond_code,1)='A'	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard_Alive, 
sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and left(discard_cond_code,1)='D'	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard_Dead, 
sum(case when LEFT(coalesce(fate_code,' '),1) in ('D') and left(isnull(discard_cond_code,'U'),1) not in('A','D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Discard_Unknown, 

sum(case when LEFT(coalesce(fate_code,' '),1) not in ('R','D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Fate_Unknown, 
		case when in_AWs = 0 then 'N' else 'Y' end as AWs
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'RAY' 
GROUP BY  
	sp.sp_name,case when in_AWs = 0 then 'N' else 'Y' end
UNION 
SELECT 	
		'L' as gear, 
		sp.sp_name, 
		sum(1) as Number, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('R')	then 1 else 000000 end)  as Retain, 
		sum(case when LEFT(coalesce(fate_code,' '),1) in ('D','E')	then 1 else 000000 end) as Discard, 

sum(case when LEFT(coalesce(fate_code,' '),1) in ('D','E') and left(cond_code2,1)='A'	then	
					 1 else 000000 end)  as Discard_Alive, 
sum(case when LEFT(coalesce(fate_code,' '),1) in ('D','E') and left(cond_code2,1)='D'	then	
					 1 else 000000 end)  as Discard_Dead, 
sum(case when LEFT(coalesce(fate_code,' '),1) in ('D','E') and left(ISNULL(cond_code2,'U'),1) not in('A','D')	then	
					 1 else 000000 end)  as Discard_Unknown, 

sum(case when LEFT(coalesce(fate_code,' '),1) not in ('R','D','E')	then 1 else 000000 end) as Fate_Unknown, 
		case when in_AWs = 0 then 'N' else 'Y' end as AWs
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_sethaullog sh on sh.l_set_id=ls.l_set_id and stend_id=83
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND sp.sp_cat_code = 'RAY' 
GROUP BY  
	sp.sp_name,case when in_AWs = 0 then 'N' else 'Y' end",NA
"378","e4ddff67-ddb9-479f-992d-b4bcd9d7b04a"," PURSE SEINE - Summary Report on Incidents in GEN-3 by Flag and Year","flag_code, year, obsv_prg",NA,"Observer",NA,"Observer","6",2944,"andrewh@spc.int","colleyf@spc.int","Observer, Purseseine, Compliance","2022-01-24T12:29:06.89"," select  
program,
trip_year,
gear,
flag_id,
ISNULL([RS-A],0) [RS-A],
ISNULL([RS-B],0) [RS-B],
ISNULL([RS-C],0) [RS-C],
ISNULL([RS-D],0) [RS-D],
ISNULL([NR-A],0) [NR-A],
ISNULL([NR-B],0) [NR-B],
ISNULL([NR-C],0) [NR-C],
ISNULL([NR-D],0) [NR-D],
ISNULL([NR-E],0) [NR-E],
ISNULL([NR-F],0) [NR-F],
ISNULL([NR-G],0) [NR-G],
ISNULL([WC-A],0) [WC-A],
ISNULL([WC-B],0) [WC-B],
ISNULL([WC-C],0) [WC-C],
ISNULL([LP-A],0) [LP-A],
ISNULL([LP-B],0) [LP-B],
ISNULL([LC-A],0) [LC-A],
ISNULL([LC-B],0) [LC-B],
ISNULL([LC-C],0) [LC-C],
ISNULL([LC-D],0) [LC-D],
ISNULL([LC-E],0) [LC-E],
ISNULL([LC-F],0) [LC-F],
ISNULL([SI-A],0) [SI-A],
ISNULL([SI-B],0) [SI-B],
ISNULL([PN-A],0) [PN-A],
ISNULL([PN-B],0) [PN-B],
ISNULL([PN-C],0) [PN-C],
ISNULL([PN-D],0) [PN-D],
ISNULL([PN-E],0) [PN-E],
ISNULL([SS-A],0) [SS-A],
ISNULL([SS-B],0) [SS-B]
from (

SELECT obsprg_code as program
      ,year(dep_date) as trip_year
      ,gear_code as gear
      ,vi.flag_id
      ,coalesce(cast(answer as int),0) as answer
      ,question_code
FROM obsv.gen3vr09 gen3
    join obsv.trip t on t.obstrip_id = gen3.obstrip_id
    join ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
    join ref.field_staff f on f.staff_id=t.observer_id) t1
    PIVOT
    (
        SUM(answer)
        FOR question_code in (
        [RS-A]
      ,[RS-B]
      ,[RS-C]
      ,[RS-D]
      ,[NR-A]
      ,[NR-B]
      ,[NR-C]
      ,[NR-D]
      ,[NR-E]
      ,[NR-F]
      ,[NR-G]
      ,[WC-A]
      ,[WC-B]
      ,[WC-C]
      ,[LP-A]
      ,[LP-B]
      ,[LC-A]
      ,[LC-B]
      ,[LC-C]
      ,[LC-D]
      ,[LC-E]
      ,[LC-F]
      ,[SI-A]
      ,[SI-B]
      ,[PN-A]
      ,[PN-B]
      ,[PN-C]
      ,[PN-D]
      ,[PN-E]
      ,[SS-A]
      ,[SS-B]

      )) as piv
Where trip_year = COALESCE(:year,trip_year)
AND program = COALESCE(:obsv_prg,program)
AND flag_id    = coalesce(:flag_code,flag_id)
and gear='S'
 and ISNULL([RS-A],0)+ISNULL([RS-B],0)+ISNULL([RS-C],0)+ISNULL([RS-D],0)+ISNULL([NR-A],0)+ISNULL([NR-B],0)+ISNULL([NR-C],0)+ISNULL([NR-D],0)+ISNULL([NR-E],0)+ISNULL([NR-F],0)+ISNULL([NR-G],0)+ISNULL([WC-A],0)+ISNULL([WC-B],0)+ISNULL([WC-C],0)+ISNULL([LP-A],0)+ISNULL([LP-B],0)+ISNULL([LC-A],0)+ISNULL([LC-B],0)+ISNULL([LC-C],0)+ISNULL([LC-D],0)+ISNULL([LC-E],0)+ISNULL([LC-F],0)+ISNULL([SI-A],0)+
 ISNULL([SI-B],0)+ISNULL([PN-A],0)+ISNULL([PN-B],0)+ISNULL([PN-C],0)+ISNULL([PN-D],0)+ISNULL([PN-E],0)+ISNULL([SS-A],0)+ISNULL([SS-B],0) > 0",NA
"379","e54ea528-ee76-4e9f-9339-b9a2ea44ffcb"," PURSE SEINE - Unloadings - detailed","year",NA,"Port",NA,NA,"89.3",3037,"andrewh@spc.int","brunod@spc.int","Unloading, Purseseine, Tuna, API","2021-10-08T14:28:16.227"," SELECT	u.counter unload_id, u.recon_trip_id, v.ffa_vid vessel_id, p.counter port_id, vc.ffa_vid unload_carr_id,v.flag_id,u.unload_startdate,u.unload_enddate,u.log_trip_id,u.log_dep_date,u.log_ret_date,u.obs_trip_id,u.vess_act_id,u.license_id,u.unload_type_code,u.sample_id,u.batch_code,u.nat_fleet_id,
		SUM (CASE WHEN sp_code = 'SKJ' THEN sp_mt ELSE 0 END) AS skj_mt,
		SUM (CASE WHEN sp_code = 'YFT' AND size_class = 'S' THEN sp_mt ELSE 0 END) AS yft_lt9_mt,
		SUM (CASE WHEN sp_code = 'YFT' AND size_class = 'L' THEN sp_mt ELSE 0 END) AS yft_gt9_mt,
		SUM (CASE WHEN sp_code = 'YFT' AND size_class = 'A' THEN sp_mt ELSE 0 END) AS yft_mt,
		SUM (CASE WHEN sp_code = 'BET' AND size_class = 'S' THEN sp_mt ELSE 0 END) AS bet_lt9_mt,
		SUM (CASE WHEN sp_code = 'BET' AND size_class = 'L' THEN sp_mt ELSE 0 END) AS bet_gt9_mt,
		SUM (CASE WHEN sp_code = 'BET' AND size_class = 'A' THEN sp_mt ELSE 0 END) AS bet_mt,
		SUM (CASE WHEN sp_code = 'TUN' THEN sp_mt ELSE 0 END) AS yft_bet_mt,
		0 AS skj_yft_bet_mt,
		SUM (CASE WHEN sp_code = 'UNS' THEN sp_mt ELSE 0 END) AS oth_mt,
		SUM (sp_mt) AS tot_mt,
		u.unload_type_code2,u.entered_by,u.entered_date,u.changed_date
FROM	unload2.carrier_loading c INNER JOIN unload2.unloadings_ps u ON u.carrier_loading_id = c.carrier_loading_id
		INNER JOIN ref.vessel_instances v ON u.vessel_id = v.vessel_id AND u.unload_startdate BETWEEN v.start_date AND v.calculated_end_date
		INNER JOIN ref.ports p ON p.port_id = c.port_id
		INNER JOIN ref.vessel_instances vc ON vc.vessel_id = c.carr_vessel_id AND c.unload_startdate BETWEEN vc.start_date AND vc.calculated_end_date
		INNER JOIN unload2.unloading_catch_ps cat ON cat.unload_id = u.unload_id
WHERE	YEAR(u.unload_startdate) = :year
GROUP BY u.counter, u.recon_trip_id, v.ffa_vid, p.counter, vc.ffa_vid,v.flag_id,u.unload_startdate,u.unload_enddate,u.log_trip_id,u.log_dep_date,u.log_ret_date,u.obs_trip_id,u.vess_act_id,u.license_id,u.unload_type_code,u.sample_id,u.batch_code,u.nat_fleet_id,u.unload_type_code2,u.unload_type_code2,u.entered_by,u.entered_date,u.changed_date",NA
"380","ff83b6e8-a682-492b-81b4-2ab39d383a74"," Part 1 (Table 3) - Catches of species of special interest (seabird, turtle, rays & marine mammals)","flag_code, year","Observed annual estimated catches of species of special interest (seabird, turtle, rays and marine mammals) by gear for the [National fleet], in the WCPFC Convention Area, for years [x-5] to [x-1] to the extent available.","Observer",NA,"Observer","1",2953,"andrewh@spc.int","colleyf@spc.int","Observer, RegionalReporting","2025-02-14T15:55:11.33","  SELECT 	
		'S' as gear, 
		case	when sp.sp_cat_code = 'BRD' then 'BIRDS        '
				when sp.sp_cat_code = 'MAM' then 'MARINE MAMMALS'
				when sp.sp_cat_code = 'TTX' then 'MARINE REPTILES'
				when sp.sp_cat_code = 'RAY' then 'RAYS'
				when sp.sp_code = 'RHN'		then 'WHALE SHARK' end as Category,
		sp.sp_name as species,
		sum(case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end) as Number, 
		sum(case when left(coalesce(cond_code,' '),1) in ('A')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Alive, 
		sum(case when left(coalesce(cond_code,' '),1) in ('D')	then	
					 case when obs_n > coalesce(sp_n_est,obs_n) then obs_n else coalesce(sp_n_est,obs_n) end else 000000 end)  as Dead
 FROM	obsv.trip ot 
				inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
				inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
				inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
				left outer join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
				left outer join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
				left outer join ref.species sp on sc.sp_code = sp.sp_code
WHERE  YEAR(act_date) = coalesce(:year,year(act_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND ( sp.sp_cat_code in ('TTX','MAM','BRD') or sp.sp_code IN ('RHN','EAG','MAE','MAN','MNT','RMB','RMJ','RMK','RMT','RMU','RMV'))
GROUP BY  
		case	when sp.sp_cat_code = 'BRD' then 'BIRDS        '
				when sp.sp_cat_code = 'MAM' then 'MARINE MAMMALS'
				when sp.sp_cat_code = 'TTX' then 'MARINE REPTILES'
				when sp.sp_cat_code = 'RAY' then 'RAYS'
				when sp.sp_code = 'RHN'		then 'WHALE SHARK' end,
	sp.sp_name 
UNION 
SELECT 	
		'L' as gear, 
		case	when sp.sp_cat_code = 'BRD' then 'BIRDS        '
				when sp.sp_cat_code = 'MAM' then 'MARINE MAMMALS'
				when sp.sp_cat_code = 'TTX' then 'MARINE REPTILES'
				when sp.sp_cat_code = 'RAY' then 'RAYS'
				when sp.sp_code = 'RHN'		then 'WHALE SHARK' end as Category,
		sp.sp_name, 
		sum(1) as Number, 
		sum(case when left(coalesce(cond_code,' '),1) in ('A')		then 1 else 000000 end)  as Alive, 
		sum(case when left(coalesce(cond_code,' '),1) in ('D')		then 1 else 000000 end)  as Dead
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			left outer join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			left outer join ref.species sp on lc.sp_code = sp.sp_code
 WHERE YEAR(catch_date) = coalesce(:year, YEAR(catch_date))
    AND flag_id = coalesce(:flag_code,flag_id)
    AND ( sp.sp_cat_code in ('TTX','MAM','BRD') or sp.sp_code IN ('RHN','EAG','MAE','MAN','MNT','RMB','RMJ','RMK','RMT','RMU','RMV'))
GROUP BY  
		case	when sp.sp_cat_code = 'BRD' then 'BIRDS        '
				when sp.sp_cat_code = 'MAM' then 'MARINE MAMMALS'
				when sp.sp_cat_code = 'TTX' then 'MARINE REPTILES'
				when sp.sp_cat_code = 'RAY' then 'RAYS'
				when sp.sp_code = 'RHN'		then 'WHALE SHARK' end,
	sp.sp_name",NA
"381","e9b40530-1660-4102-a0a6-a7a801248d95"," CMM 11-04 – Oceanic White-tip  -- RELEASE Life Status estimates (unraised)","flag_code, year","CMM 11-04 – Oceanic White-tip  -- RELEASE Life Status estimates - NOTE: THIS MEANS YOU NEED TO PROVIDE A RAISED ESTIMATE FROM THE UNRAISED DATA THAT IS IN THIS REPORT","Observer",NA,"Observer","10a",3190,"andrewh@spc.int","andrewh@spc.int","Observer, Longline, Purseseine, CMM, Raised, RegionalReporting, Unraised, ByCatch","2022-05-06T14:08:12.783"," SELECT  'S' as gear,
	flag_id as flag,    
	sp.sp_name as species,   
	sum(coalesce(sc.sp_n_est,0)) as unraised_number,
	sum(case LEFT(discard_cond_code,1) when  'D' then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_dead,
	sum(case LEFT(discard_cond_code,1) when  'A' then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_alive,
	sum(case when coalesce(LEFT(discard_cond_code,1),'X') not in ('D','A') then coalesce(sc.sp_n_est,0) else 0000.000 end) as discard_unknown,
    sum(case LEFT(discard_cond_code,1) when  'D' then coalesce(sc.sp_n_est,0) else 0000.000 end) / nullif(sum(coalesce(sc.sp_n_est,0)),0) * 100.00 as percent_dead
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
		inner join obsv.s_set ss on sa.s_daylog_id = ss.s_daylog_id
		inner join obsv.s_setcatch sc on ss.s_set_id = sc.s_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
	WHERE YEAR(act_date) = coalesce(:year,year(act_date))
		AND s_activ_id = 1
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code = 'OCS'
		and left(fate_code,1) = 'D'
	GROUP BY 
		flag_id,    
		sp.sp_name
	UNION
	SELECT  'L' as gear,
			flag_id as flag,
			sp.sp_name as species,
			sum(1) as unraised_number,
			sum(case left(cond_code2,1) when  'D' then 1.000 else 0000.000 end) as discard_dead,
			sum(case left(cond_code2,1) when  'A' then 1.000 else 0000.000 end) as discard_alive,
			sum(case when coalesce(left(cond_code2,1),'X') not in ('A','D') then 1.000 else 0000.000 end) as discard_unknown,
    sum(case left(cond_code2,1) when  'D' then 1.000 else 0000.000 end) / nullif(sum(1.000),0) *100.00 as percent_dead
	FROM obsv.trip ot
		inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
		inner join obsv.l_set sd on ot.obstrip_id = sd.obstrip_id
		inner join obsv.l_sethaullog sa on sd.l_set_id = sa.l_set_id and sa.stend_id = 83
		inner join obsv.l_setcatch sc on sc.l_set_id = sd.l_set_id
		inner join ref.species sp on sc.sp_code = sp.sp_code 
	WHERE YEAR(sc.catch_date) = coalesce(:year,year(sc.catch_date))
		AND flag_id = coalesce(:flag_code,flag_id)
		AND sp.sp_code = 'OCS'
		AND left(fate_code,1) = 'D'
	GROUP BY 
		flag_id,
			sp.sp_name",NA
"382","5e983dda-f03e-4072-abb4-2cb18b986aa9"," ARTISANAL - Total catch by vessel, landing site, vessel type etc.","year","Total catch","Artisanal",NA,NA,"1",3045,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Artisanal, ByVessel, AllSpecies","2024-11-05T13:54:44.337"," select	YEAR(trip_date) year, MONTH(trip_date) month,:group_by,sp.sp_code,sp.sp_name,SUM(cast(c.sp_kg as decimal(6,2))) as tot_kg,SUM(COALESCE(c.sp_n,0)) tot_n
from	art2.trips t inner join art2.effort e ON t.art_trip_id=e.art_trip_id
		INNER JOIN art2.catch c on c.art_effort_id=e.art_effort_id
		LEFT JOIN ref.species sp on sp.sp_code = c.sp_code
		LEFT OUTER JOIN art2.vessels v on v.vessel_id=t.vessel_id
		LEFT OUTER JOIN art2.landing_sites l on l.landing_site_id = t.landing_site_id
		LEFT OUTER JOIN art2.areas a on a.art_area_id = e.art_area_id
		LEFT OUTER JOIN tuf2.translations tr ON tr.translation_key = 'LookupList_ArtisanalVesselPowerModes' + CONVERT(VARCHAR,v.boat_power_id)
		LEFT OUTER JOIN tuf2.translations tp ON tp.translation_key = 'LookupList_ArtisanalFishingMethods' + CONVERT(VARCHAR,e.fish_method_id)
		LEFT OUTER JOIN art2.regions r on l.region_id = r.region_id
		LEFT OUTER JOIN art2.fad_register fr on fr.fad_register_id = e.fad_register_id
where	YEAR(trip_date)=coalesce(:year,year(trip_date))
group by YEAR(trip_date), MONTH(trip_date),:group_by,sp.sp_code,sp.sp_name","Vessel"
"383","16d69ecb-6ec7-4e1d-970d-af02ae9ddcde"," Number of Unloading species entered by DCT","year, date_from, date_to","List the number of species records entered by Data entry technicians for a given year (PS + LL)","Port",NA,NA,"6",3134,"andrewh@spc.int","brunod@spc.int","Unloading, Longline, Purseseine, MyFleet","2021-10-08T15:10:32.807","

 SELECT H.entered_by, :group_by, count(*) as nb_sp 
FROM unload2.unloadings H INNER JOIN unload2.unloading_catch D on H.unload_id = D.unload_id
WHERE COALESCE(:year,YEAR(H.changed_date))=YEAR(H.changed_date)
	AND CHARINDEX('@spc.int',entered_by) > 0 and CHARINDEX('stevenb',entered_by) = 0 and CHARINDEX('francoisef',entered_by) = 0 
	AND COALESCE(:date_from,H.entered_date) <= H.entered_date
	AND COALESCE(:date_to,H.entered_date) >= H.entered_date
GROUP BY H.entered_by,:group_by
UNION
SELECT H.entered_by, :group_by, count(*) as nb_sp
FROM unload2.unloadings_ps H INNER JOIN unload2.unloading_catch_ps D on H.unload_id = D.unload_id
WHERE COALESCE(:year,YEAR(H.entered_date))=YEAR(H.entered_date)
	AND CHARINDEX('@spc.int',entered_by) > 0 and CHARINDEX('stevenb',entered_by) = 0 and CHARINDEX('francoisef',entered_by) = 0 
	AND COALESCE(:date_from,H.entered_date) <= H.entered_date
	AND COALESCE(:date_to,H.entered_date) >= H.entered_date
GROUP BY H.entered_by,:group_by","Year"
"384","f91e4803-be4c-459a-bc75-8c1634d3f288"," PURSE SEINE - Tuna Catch and Effort in the WCPFC Area - National fleet","year","NATIONAL FLEET - PURSE SEINE Catch and Effort in the WCPFC Area","Logsheets",NA,"Live","1",2896,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, RegionalReporting, Tuna","2025-09-22T11:25:00.707"," SELECT  :group_by, 
		COUNT(distinct t.vessel_id) as vessels, 
		COUNT(distinct s.log_trip_id) as trips, 
		COUNT(distinct cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) ) as sea_days,
		COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end) as fish_days,
		cast(SUM(case when sp_code = 'SKJ' then c.sp_mt else 000.000 end) as int) as skj_c, 
        cast(COALESCE(SUM(case when sp_code = 'SKJ' then c.sp_mt else 000.000 end) / NULLIF(COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end),0),0) as decimal(9,1)) as skj_cpue, 
        cast(SUM(case when sp_code = 'YFT' then c.sp_mt else 000.000 end) as int) as yft_c, 
        cast(COALESCE(SUM(case when sp_code = 'YFT' then c.sp_mt else 000.000 end) / NULLIF(COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end),0),0)  as decimal(9,1)) as yft_cpue, 
        cast(SUM(case when sp_code = 'BET' then c.sp_mt else 000.000 end) as int) as bet_c, 
        cast(COALESCE(SUM(case when sp_code = 'BET' then c.sp_mt else 000.000 end) / NULLIF(COUNT(distinct case when s_activity_id in (1,2) then cast(s.log_trip_id as varchar(50)) + cast(cast(logdate as date) as varchar(10)) else null end),0),0)  as decimal(9,1)) as bet_cpue, 
        cast(COALESCE(SUM(case when sp_code in('SKJ','YFT','BET') then 000.000 else c.sp_mt end),0) as int) as oth_c, 
        cast(COALESCE(SUM(c.sp_mt),0) as decimal(9,1)) as tot_c 
FROM log.trips_ps t inner join log.sets_ps s on t.log_trip_id = s.log_trip_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date AND	(@@entity = 'HIVE' OR vi.flag_id = @@entity)
   					left outer join log.catch_ps c on s.log_set_id = c.log_set_id 
WHERE year(logdate) = coalesce(:year, year(logdate)) 
group by :group_by","YearMonth"
"385","c26f4770-525d-4066-90ff-51827fb75465"," Vessel Refrigeration Equipment Report by Trip","min_year, max_year","Report created for FIJI showing the list of refrigeration equipment per vessel per trip","Observer",NA,"Observer","14",2980,"andrewh@spc.int","colleyf@spc.int","Observer","2024-07-08T09:33:14.377"," select tripno,
		v.vesselname,
		flag_id,
		dep_date,
		g.blastfreezer_ans,
		g.seawater_ans,
		g.ice_ans,
		g.chilledseawater_ans,
		g.otherstorage_ans,
		coalesce(g.otherstorage_desc, '') as oth_desc
from obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
		inner join obsv.l_gear g on g.obstrip_id = t.obstrip_id
where YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))",NA
"386","ab721049-28dd-4df5-b1a8-8893aae33757"," Part1 - Table 1 - LONGLINE - Annual catch and effort by primary species and gear in the WCPFC Convention Area","","PART 1 REPORT (Essential Information 1) - Annual catch and effort estimates for the NATIONAL LONGLINE FLEET, in the WCPFC Convention Area","Logsheets",NA,NA,"1a",2905,"andrewh@spc.int","andrewh@spc.int","Logsheet, Longline, CMM","2022-04-28T10:42:57.233"," SELECT	distinct 
		'   ---' as category,
		'   ' as species,
		YEAR(GETDATE())-5 as yr1,
		YEAR(GETDATE())-4 as yr2,
		YEAR(GETDATE())-3 as yr3,
		YEAR(GETDATE())-2 as yr4,
		YEAR(GETDATE())-1 as yr_curr,
		YEAR(GETDATE())-1 as yr_curr_dsc_n
FROM   ref.species sp 
where sp_code = 'ALB'
UNION 
SELECT	case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end as category,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end as species,
		CONVERT(int,MAX(yb.mt_yr1)) as yr1,
		CONVERT(int,MAX(yb.mt_yr2)) as yr2,
		CONVERT(int,MAX(yb.mt_yr3)) as yr3,
		CONVERT(int,MAX(yb.mt_yr4)) as yr4,
		CONVERT(int,SUM(case when year(logdate) = YEAR(GETDATE())-1 then case when coalesce(sp_kg_est,0) > coalesce(sp_kg,0) then coalesce(sp_kg_est,0) else coalesce(sp_kg,0) end end)/1000) as yr_curr,
		CONVERT(int,SUM(case when year(logdate) = YEAR(GETDATE())-1 then coalesce(spdiscard_n,0) end )) as yr_curr_dsc_n
FROM   log.trips_ll l inner join ref.vessel_instances vi 
					on l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
					INNER JOIN ref.vessels v	ON v.vessel_id = vi.vessel_id 
					INNER JOIN log.sets_ll s	ON l.log_trip_id = s.log_trip_id
					INNER JOIN log.catch_ll c	ON c.log_set_id = s.log_set_id
					INNER JOIN	ref.species sp on c.sp_code = sp.sp_code
					FULL OUTER JOIN (select sp_code,
										SUM(case when yy = YEAR(GETDATE())-5 then sp_mt else 00000000 end) as mt_yr1,
										SUM(case when yy = YEAR(GETDATE())-4 then sp_mt else 00000000 end) as mt_yr2,
										SUM(case when yy = YEAR(GETDATE())-3 then sp_mt else 00000000 end) as mt_yr3,
										SUM(case when yy = YEAR(GETDATE())-2 then sp_mt else 00000000 end) as mt_yr4
								from [WCPFC_YEARBOOK].[dbo].[A_ACE] a1 inner join [WCPFC_YEARBOOK].[dbo].[A_ACE_CATCH] a2 
										on a1.ACE_ID = a2.ACE_ID
								where YY >= YEAR(GETDATE())-5 and YY <= YEAR(GETDATE())-2
AND (@@entity = 'HIVE' OR FLAG_CODE = @@entity)
									and GEAR_CODE = 'L'
									and ocean_code = 'WX'
								group by sp_code) yb 
								on yb.sp_code collate database_default =	case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
																					when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
																					when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
																			else	c.sp_code end collate database_default
WHERE	YEAR(logdate) >= YEAR(GETDATE())-5 
	and YEAR(logdate) <= YEAR(GETDATE())-1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
    and c.sp_code in ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM')
group by case	when sp.sp_cat_code = 'TUN' then '1. TUN' 
				when sp.sp_cat_code = 'BIL' then '2. BIL' 
				when sp.sp_cat_code = 'SHK' then '3. SHK' end,
		case	when c.sp_code in ('BTH','PTH','THR','ALV')			then 'THR'
				when c.sp_code in ('MAK','LMA','SMA')				then 'MAK'
				when c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ')	then 'HAM'
		else	c.sp_code end",NA
"387","837572d8-901f-4a4b-936a-1c837be0b110","PURSE SEINE - Key species catches in WCPFC Area raised with VMS - NATIONAL FLEET ","year","Purse seine - Catch estimates of key WCPFC Species by NATIONAL FLEET in WCPFC Area raised with VMS","Logsheets,VMS",NA,NA,"2.1.3",3051,"andrewh@spc.int","emmanuels@spc.int","Logsheet, Purseseine, RegionalReporting, AllSpecies","2025-03-12T11:30:21.327","/*
SELECT vms_trip_id INTO #mapped_trip FROM (
	SELECT	dto_guid_left vms_trip_id
	FROM	tufman2.viewpersist_entity_links_two_way
    WHERE   (  dto_type_left = 'VmsTripDTO' AND dto_type_right = 'PurseseineLogsheetDTO' )
    OR		(  dto_type_left = 'PurseseineLogsheetDTO' AND dto_type_right = 'VmsTripDTO' )
) t 
*/

SELECT vms_trip_id INTO #mapped_trip FROM (
            SELECT      distinct t.vms_trip_id
            FROM  log.trips_ps l 
				INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id AND l.first_logdate BETWEEN vi.start_date AND vi.calculated_end_date
                INNER JOIN vms.vms_trips t ON 
						t.vessel_id = vi.vessel_id
							AND l.depart_date < t.return_date
							AND l.return_date > t.departure_date
			) t


/*
 Old conditional statement, replaced with Manu's code above ...
						AND (	
                              (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
                              OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
                              OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
                              OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
                        )

 Manu's code 
							AND l.depart_date < t.return_date
							AND l.return_date > t.departure_date


*/


SELECT  eez.eez_code, eez.year, eez.month, SUM(eez.day_fishing) day_fishing INTO #missing_trip
FROM	vms.vms_trips t JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        JOIN vms.vms_trip_efforts eez ON t.vms_trip_id = eez.vms_trip_id
		LEFT JOIN #mapped_trip ON t.vms_trip_id = #mapped_trip.vms_trip_id
        /*JOIN tufman2.licence_info lic ON t.vessel_id=lic.vessel_id AND (t.departure_date BETWEEN lic.lic_startdate AND lic.lic_enddate OR t.return_date BETWEEN lic.lic_startdate AND lic.lic_enddate)*/
WHERE	DATEDIFF(DAY, t.departure_date,t.return_date) > 5
AND     day_fishing > 1
AND		ve.gear = 'S'
AND		eez.year = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		#mapped_trip.vms_trip_id IS NULL
GROUP BY eez.eez_code, eez.year, eez.month

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        vi.flag_id,
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND     s_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, vi.flag_id

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        c.sp_code,
        vi.flag_id,
        SUM(CASE WHEN COALESCE(discard,0) = 0 THEN COALESCE(c.sp_mt_est,c.sp_mt) ELSE 0000000.000 END) catch,
        SUM(CASE WHEN COALESCE(discard,0) = 1 THEN COALESCE(c.sp_mt_est,c.sp_mt) ELSE 0000000.000 END) discard INTO #catch0
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')
GROUP BY DATEPART(YEAR, s.logdate) ,DATEPART(MONTH,s.logdate), s.eez_code, c.sp_code, vi.flag_id
UNION 
SELECT  DATEPART(YEAR, s.logdate) cyear, 
        DATEPART(MONTH,s.logdate) month, 
        s.eez_code,
        CASE WHEN sp.sp_code = 'SPN' THEN 'HAM' ELSE sp.sp_code END sp_code,
        vi.flag_id,
        SUM(000000.000) catch,
        SUM(000000.000) discard
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id
        JOIN ref.species sp on sp.sp_code = sp.sp_code
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND     sp.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','THR','MAK','SPN','POR', 'SSP','SFA')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), s.eez_code, sp.sp_code, vi.flag_id

SELECT  year,
        month, 
        eez_code,
        sp_code,
        flag_id,
        SUM(catch) catch,
        SUM(discard) discard into #catch
FROM	#catch0 
GROUP BY  year, month, eez_code, sp_code, flag_id

SELECT  e.year, e.month, e.eez_code, c.sp_code, e.flag_id, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, c.discard, 'Month / Fleet / EEZ' raising_factor INTO #cpue
FROM    #effort e JOIN #catch c ON e.eez_code = c.eez_code AND e.year = c.year AND e.flag_id = c.flag_id AND e.month = c.month

SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor INTO #missing_catch
FROM    #missing_trip JOIN #cpue c ON #missing_trip.eez_code = c.eez_code AND #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days >= 100 
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_1
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND     s_activity_id = 1
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate)

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        c.sp_code,
        SUM(CASE WHEN COALESCE(discard,0) = 0 THEN COALESCE(c.sp_mt_est,c.sp_mt) ELSE 0000000.000 END) catch INTO #catch_raised_1
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code

SELECT  e.year, e.month, c.sp_code, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month / Fleet' raising_factor INTO #cpue_raised_1
FROM    #effort_raised_1 e JOIN #catch_raised_1 c ON e.year = c.year AND e.month = c.month

INSERT INTO #missing_catch
SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM    #missing_trip JOIN #cpue_raised_1 c ON #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days >= 100 
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')
AND NOT EXISTS (
	SELECT  1
	FROM    #missing_catch temp
	WHERE   temp.year =  #missing_trip.year
	AND     temp.month = #missing_trip.month
	AND     temp.eez_code = #missing_trip.eez_code
)

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        COUNT(DISTINCT s.log_set_id) nb_days INTO #effort_raised_2
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id 
        JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate) = :year
AND     s_activity_id = 1
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate)

SELECT  DATEPART(YEAR, s.logdate) year,
        DATEPART(MONTH,s.logdate) month, 
        c.sp_code,
        SUM(CASE WHEN COALESCE(discard,0) = 0 THEN COALESCE(c.sp_mt_est,c.sp_mt) ELSE 0000000.000 END) catch INTO #catch_raised_2
FROM    log.trips_ps  t JOIN log.sets_ps  s ON t.log_trip_id = s.log_trip_id
        JOIN log.catch_ps c ON c.log_set_id = s.log_set_id
        JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE   YEAR(logdate)=:year
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')
GROUP BY DATEPART(YEAR, s.logdate), DATEPART(MONTH,s.logdate), c.sp_code

SELECT  e.year, e.month, c.sp_code, CONVERT(FLOAT,c.catch)/e.nb_days CPUE, e.nb_days, c.catch, 'Month' raising_factor INTO #cpue_raised_2
FROM    #effort_raised_1 e JOIN #catch_raised_1 c ON e.year = c.year AND e.month = c.month

INSERT INTO #missing_catch
SELECT  #missing_trip.*, c.sp_code, c.CPUE * #missing_trip.day_fishing sp_mt, c.raising_factor
FROM    #missing_trip JOIN #cpue_raised_1 c ON #missing_trip.year = c.year AND #missing_trip.month = c.month
WHERE   c.nb_days >= 100 
AND     c.sp_code IN ('ALB','BET','YFT','SKJ','PBF','MLS','BUM','BLM','SWO','BSH','RHN','FAL','OCS','BTH','PTH','THR','ALV','MAK','LMA','SMA','SPK','SPL','SPN','SPQ','SPZ','HAM', 'SSP','SFA')
AND NOT EXISTS (
    SELECT  1
    FROM    #missing_catch temp
    WHERE   temp.year =  #missing_trip.year
    AND     temp.month = #missing_trip.month
    AND     temp.eez_code = #missing_trip.eez_code
)

SELECT  COALESCE(c.year,mc.year) year,COALESCE(c.eez_code,mc.eez_code) eez_code,  COALESCE(c.sp_code,mc.sp_code) sp_code, CONVERT(DECIMAL(10,2),SUM(COALESCE(c.catch,0))) log_c, CONVERT(DECIMAL(10,2), SUM(COALESCE(c.discard,0))) disc_c, CONVERT(DECIMAL(10,2), SUM(COALESCE(mc.sp_mt,0))) vms_c, SUM(COALESCE(mc.day_fishing,0)) vms_missing_days INTO #final
FROM    #catch c FULL OUTER JOIN #missing_catch mc ON c.eez_code = mc.eez_code AND c.year = mc.year and c.month = mc.month and c.sp_code = mc.sp_code
GROUP BY COALESCE(c.year,mc.year), COALESCE(c.eez_code,mc.eez_code), COALESCE(c.sp_code,mc.sp_code)

SELECT  f.year, f.eez_code, sp_code, log_c,disc_c, log_c+vms_c tot_c, SUM(COALESCE(e.nb_days,0)) nb_days, vms_missing_days INTO #final2
FROM    #final f LEFT OUTER JOIN #effort e ON e.eez_code = f.eez_code AND e.year = f.year
GROUP BY f.year, f.eez_code, sp_code,log_c, disc_c,vms_c, vms_missing_days
 SELECT 
	CASE WHEN sp.sp_cat_code = 'TUN' THEN '1. TUN' 
            WHEN sp.sp_cat_code = 'BIL' THEN '2. BIL' 
            WHEN sp.sp_cat_code = 'SHK' THEN '3. SHK' END category,
	CASE WHEN c.sp_code in ('BTH','PTH','THR','ALV') THEN 'THR'
            WHEN c.sp_code in ('MAK','LMA','SMA') THEN 'MAK'
            WHEN c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ','HAM') THEN 'HAM'
			ELSE c.sp_code END species,
	SUM(log_c) log_c, 
	SUM(tot_c) tot_c, 
	CONVERT(DECIMAL(5,2),
	SUM(nb_days)*100/(SUM(nb_days)+SUM(vms_missing_days))) log_cov,
	SUM(disc_c) disc_c
FROM #final2 c JOIN ref.species sp ON CASE WHEN c.sp_code = 'HAM' THEN 'SPN' ELSE c.sp_code END = sp.sp_code
GROUP BY 
	CASE WHEN sp.sp_cat_code = 'TUN' THEN '1. TUN' 
            WHEN sp.sp_cat_code = 'BIL' THEN '2. BIL' 
            WHEN sp.sp_cat_code = 'SHK' THEN '3. SHK' END,
	CASE WHEN c.sp_code in ('BTH','PTH','THR','ALV') THEN 'THR'
            WHEN c.sp_code in ('MAK','LMA','SMA') THEN 'MAK'
            WHEN c.sp_code in ('SPK','SPL','SPN','SPQ','SPZ','HAM') THEN 'HAM'
			ELSE c.sp_code END",NA
"388","48a8bc31-0d98-4aab-bcdd-934a2d7ac8f7"," LONGLINE - Hook between Float issues","flag_code, year",NA,"Logsheets",NA,NA,"5",2988,"andrewh@spc.int","brunod@spc.int","Logsheet, Longline, DataQuality","2022-05-16T10:43:42.533"," SELECT year(t.depart_date) as yy, 
	v.flag_id as fleet,
	/*coalesce(company_name,'        ') as company,*/
	vesselname,
	COUNT(distinct case when x.hk_bt_flt = 0 then t.log_trip_id else null end) as hbf_zero_trips,
	COUNT(distinct case when x.hk_bt_flt > 40 then t.log_trip_id else null end) as hbf_too_high_trips
FROM log.trips_ll t inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.depart_date between v.start_date and v.calculated_end_date
	inner join (select tx.log_trip_id,
				MAX(coalesce(hk_bt_flt_n,0)) as hk_bt_flt
				FROM log.trips_ll tx inner join log.sets_ll sx on tx.log_trip_id = sx.log_trip_id
					inner join ref.vessel_instances vi on tx.vessel_id = vi.vessel_id and tx.depart_date between vi.start_date and vi.calculated_end_date
				WHERE year(logdate) = coalesce(:year, year(first_logdate))
					and coalesce(:flag_code,vi.flag_id) = vi.flag_id
					and sx.l_activity_id = 1
				group by tx.log_trip_id) x on x.log_trip_id = t.log_trip_id 
	/*left outer join ref.licenses l on t.license_id = l.license_id
	left outer join lic.agreements a on a.agr_code = l.agr_code
	left outer join tufman.companies c on c.company_id = a.company_id*/
WHERE year(first_logdate) = coalesce(:year, year(first_logdate))
	and coalesce(:flag_code,v.flag_id) = v.flag_id
group by year(t.depart_date),v.flag_id,
	/*coalesce(company_name,'        '),*/
	vesselname
having COUNT(distinct case when x.hk_bt_flt = 0 then t.log_trip_id else null end) > 0 OR
	COUNT(distinct case when x.hk_bt_flt > 40 then t.log_trip_id else null end) > 0",NA
"389","f4a0f036-55ff-3066-a726-3a1ada1adfa6","Longline - Observer report for IATTC - All catch","year","IATTC area defined as latitude between -50 and 50 and longitude between -150 and -80","Observer",NA,"Observer",NA,3586,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline","2025-08-27T01:55:58.127","SELECT  year(dep_date) yr,vi.vesselname, 
		cast(dep_date as DATE) as depart_date,
		eez_code as EEZ,lsh.latd,lsh.lond,
		case when eez_code is null then null when eez_code in ('H4','H5','I1','I2','I3','I4','I5','I6','I7','I8','I9','IW','I0') then 'High Seas' else 'EEZ' end as area,
		case when sp.sp_cat_code is null then 'OTHERS' else sp.sp_cat_code end as sp_category,
		sp.sp_name, 
		case when sp.sp_cat_code in ('SHK','MAM','TTX','BRD', 'RAY') then fate_code else 'N/A' end as fate,
		case when fate_code = 'DPD' then 'D'
		     when fate_code = 'DPA' then 'A1'
			 ELSE coalesce(cond_code,'N/A') end as life_status,
		SUM(case when left(fate_code,1) = 'R' and left(cond_code,1) = 'A' then 0001 else 0000 end) as retained_alive,
		SUM(case when left(fate_code,1) = 'R' and left(cond_code,1) = 'D' then 0001 else 0000 end) as retained_dead,
		SUM(case when left(fate_code,1) = 'R' and left(cond_code,1) not in ('A','D') then 0001 else 0000 end) as retained_unknown,
		SUM(case when left(fate_code,1) = 'D' and left(cond_code,1) = 'A' then 0001 else 0000 end) as disc_rel_alive,
		SUM(case when left(fate_code,1) = 'D' and left(cond_code,1) = 'D' then 0001 else 0000 end) as disc_rel_dead,
		SUM(case when left(fate_code,1) = 'D' and left(cond_code,1) not in ('A','D') then 0001 else 0000 end) as disc_rel_unknown
FROM	obsv.trip ot 
		INNER join ref.vessel_instances vi    ON vi.vessel_id = ot.vessel_id AND dep_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
		inner join    obsv.l_sethaullog lsh on ls.l_set_id = lsh.l_set_id and stend_id = 83
		inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
		inner join ref.species sp on lc.sp_code = sp.sp_code		
where gear_code = 'L' 
	and year(dep_date) = :year
	and latd between -50 and 50 and lond between -150 and -80
group by 
		year(dep_date),case when sp.sp_cat_code in ('SHK','MAM','TTX','BRD','RAY') then fate_code else 'N/A' end,		case when fate_code = 'DPD' then 'D'
		     when fate_code = 'DPA' then 'A1'
			 ELSE coalesce(cond_code,'N/A') end,
		vi.vesselname, 
		cast(dep_date as DATE),
		eez_code,lsh.latd,lsh.lond,
		case when sp.sp_cat_code is null then 'OTHERS' else sp.sp_cat_code end,
		case when eez_code is null then null when eez_code in ('H4','H5','I1','I2','I3','I4','I5','I6','I7','I8','I9','IW','I0') then 'High Seas' else 'EEZ' end,
		sp.sp_name ",NA
"390","67b46def-4ee7-95ae-380c-3a1ac205592f","LONGLINE - Annual VESSEL catch/effort report - BY EEZ","eez_code, year",NA,"Logsheets",NA,NA,NA,3585,"shaazreenb@spc.int","shaazreenb@spc.int","Logsheet, Longline","2025-10-30T17:43:04.847","SELECT  z1.vesselname,
		z1.flag_id,
		YEAR(z1.logdate) as year,
		z1.eez_code as EEZ, 
		SUM(1.00 * z1.eez_days / z2.eezs) as eez_days
into #t1
FROM
(SELECT 	distinct vi.vesselname, 
				vi.flag_id,
				s.logdate,
				s.eez_code, 
				1 as eez_days
		FROM	log.trips_ll t 
				INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
				INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
			AND		( COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
			and l_activity_id in (1,2)	) z1 inner join 
(SELECT 	vi.vesselname,
			vi.flag_id,
			s.logdate,
			count(distinct s.eez_code) as eezs
		FROM	log.trips_ll t 
				INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
				INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
		WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
				and l_activity_id in (1,2)
		GROUP BY vi.vesselname, vi.flag_id,s.logdate) z2 on z1.vesselname = z2.vesselname and z1.logdate = z2.logdate
group by z1.vesselname,
		z1.flag_id,
		YEAR(z1.logdate),
		z1.eez_code	
		
SELECT eez_code as EEZ,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate) as year,
		count(*) as sets
into #t2
FROM	log.trips_ll t 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
		AND		(COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
		and l_activity_id in (1)
GROUP BY 
		eez_code,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate)
		
SELECT eez_code as EEZ,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate) as year,
		 SUM(CASE WHEN sp_code = 'ALB' THEN COALESCE(c.sp_kg_est, 0) / 1000.0 ELSE 0.000 END) as alb_c,
    SUM(CASE WHEN sp_code = 'YFT' THEN COALESCE(c.sp_kg_est, 0) / 1000.0 ELSE 0.000 END) as yft_c,
    SUM(CASE WHEN sp_code = 'BET' THEN COALESCE(c.sp_kg_est, 0) / 1000.0 ELSE 0.000 END) as bet_c,
    SUM(CASE WHEN sp_code IN ('ALB', 'YFT', 'BET') THEN 0.000 ELSE COALESCE(c.sp_kg_est, 0) / 1000.0 END) as oth_c
into #t3
FROM	log.trips_ll t 
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
		INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
        INNER JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
WHERE	COALESCE(:year,YEAR(s.logdate))=YEAR(s.logdate)
		AND		(COALESCE(:eez_code,s.eez_code)=s.eez_code OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN')))
		and l_activity_id in (1)
GROUP BY 
		eez_code,
		vi.vesselname, 
		vi.flag_id,
		YEAR(s.logdate)
 SELECT	#t1.EEZ as EEZ,
		#t1.vesselname as vessel_name, 
		#t1.flag_id as flag_code,
		#t1.year as year,
		#t1.eez_days as days,
		sum(coalesce(#t2.sets,0)) as sets,
		sum(coalesce(#t3.alb_c,000)) as alb_c,
		sum(coalesce(#t3.yft_c,000)) as yft_c,
		sum(coalesce(#t3.bet_c,000)) as bet_c,
		sum(coalesce(#t3.oth_c,000)) as oth_c
FROM	#t1 left outer join #t2 on #t2.vesselname = #t1.vesselname and #t2.year = #t1.year and #t2.EEZ = #t1.EEZ
			left outer join #t3 on #t2.EEZ = #t3.EEZ and #t2.vesselname = #t3.vesselname and #t2.flag_id = #t3.flag_id and #t2.year = #t3.year
GROUP BY 
		#t1.EEZ,
		#t1.vesselname, 
		#t1.flag_id,
		#t1.year,
		#t1.eez_days",NA
"391","3cfbe990-11ac-b5ae-66b5-3a1bb81ab437","Observer biosampling debriefing","staff_code, date_from","Biosampling debriefing for observer trips. Use observer code and trip departure date to identify trip.","Observer",NA,"Live",NA,3594,"marcg@spc.int","marcg@spc.int","Debriefing, Observer","2025-10-09T09:30:20.217","declare @staff_code nvarchar(3) = :staff_code;
declare @departure_date datetime = :date_from;

select
  a.vesselname,
  a.observer_full_name,
  a.set_number,
  a.set_date,
  a.catch_dtime,
  a.sp_code,
  a.sex_code,
  a.fish_length,
  a.label,
  a.Gonads,
  a.Liver,
  a.Stomach,
  a.Otolith,
  string_agg(a.Muscle, ' / ') as Muscle,
  a.Spine,
  a.Blood,
  a.comments
from (
select
    vessel_instances.vesselname,
    concat(field_staff.first_name, ' ', field_staff.family_name) as observer_full_name,
    l_set.set_number,
    l_set.set_date,
    l_setcatch.catch_dtime,
    l_setcatch.sp_code,
    l_setcatch.sex_code,
    l_setcatch.len as fish_length,
    bio_sampling.label,
    bio_sampling.comments,
    case when json_value(bio_sampling.extra_info_json, '$.ExtraInfo.GonadsWeight') is null and (json_value(bio_sampling.extra_info_json, '$.ExtraInfo.AreGonadsFrozen') <> 'true' or json_value(bio_sampling.extra_info_json, '$.ExtraInfo.AreGonadsFrozen') is null) and json_value(bio_sampling.extra_info_json, '$.ExtraInfo.GonadStorageCode') is null
      then 'No'
      else
        case json_value(bio_sampling.extra_info_json, '$.ExtraInfo.AreGonadsFrozen')
          when 'true' then
            case
                when JSON_VALUE(bio_sampling.extra_info_json, '$.ExtraInfo.GonadStorageCode') = 'C' then 'Frozen in cassette'
                when JSON_VALUE(bio_sampling.extra_info_json, '$.ExtraInfo.GonadStorageCode') = 'V' then 'Frozen in vial'
                else 'Frozen in plastic bag'
            end
          else
            case
                when JSON_VALUE(bio_sampling.extra_info_json, '$.ExtraInfo.GonadStorageCode') = 'C' then 'Fresh in cassette'
                when JSON_VALUE(bio_sampling.extra_info_json, '$.ExtraInfo.GonadStorageCode') = 'V' then 'Fresh in vial'
                else 'Fresh'
            end
          end
    end as 'Gonads',
    case when bio_sampling.is_liver_collected is null or bio_sampling.is_liver_collected = 0
        then 'No'
        else 'Yes'
    end as 'Liver',
    case when bio_sampling.is_stomach_collected is null or bio_sampling.is_stomach_collected = 0
        then 'No'
        else 'Yes'
    end as 'Stomach',
    case when bio_sampling.otolith_cond_code is null then 'No' else bio_sampling.otolith_cond_code end as 'Otolith',
    case when (json_query(bio_sampling.extra_info_json, '$.ExtraInfo.MuscleSiteCodes') is null or json_query(bio_sampling.extra_info_json, '$.ExtraInfo.MuscleSiteCodes') = '[]') and (json_query(bio_sampling.extra_info_json, '$.ExtraInfo.BiopsyMuscleSiteCodes') is null or json_query(bio_sampling.extra_info_json, '$.ExtraInfo.BiopsyMuscleSiteCodes') = '[]') and (json_query(bio_sampling.extra_info_json, '$.ExtraInfo.WidgetMuscleSiteCodes') is null or json_query(bio_sampling.extra_info_json, '$.ExtraInfo.WidgetMuscleSiteCodes') = '[]')
        then 'No'
        else MuscleSiteCodes.position
    end as 'Muscle',
    case when json_query(bio_sampling.extra_info_json, '$.ExtraInfo.SpineSiteCodes') is null or json_query(bio_sampling.extra_info_json, '$.ExtraInfo.SpineSiteCodes') = '[]'
      then 'No'
      else SpineSiteCodes.position
    end as Spine,
    case when bio_sampling.is_blood_collected is null or bio_sampling.is_blood_collected = 0
        then 'No'
        else 'Yes'
    end as 'Blood',
    case when bio_sampling.is_finclip_collected is null or bio_sampling.is_finclip_collected = 0
        then 'No'
        else 'Yes'
    end as 'Fin'
from obsv.trip trip
    join obsv.l_set l_set on trip.obstrip_id = l_set.obstrip_id
    join obsv.l_setcatch l_setcatch on l_setcatch.l_set_id = l_set.l_set_id
    join tufman2.bio_sampling bio_sampling on l_setcatch.l_setcatch_id = bio_sampling.parent_dto_guid
    left join (
        select
            l_setcatch.l_setcatch_id,
            concat('Knife [', string_agg(value, ','), ']') as position
        from obsv.l_setcatch l_setcatch
            join tufman2.bio_sampling bio_sampling on l_setcatch.l_setcatch_id = bio_sampling.parent_dto_guid
            cross apply openjson(bio_sampling.extra_info_json, '$.ExtraInfo.MuscleSiteCodes')
            group by 
              l_setcatch.l_setcatch_id

        union all

        select
            l_setcatch.l_setcatch_id,
            concat('Widget [', string_agg(value, ','), ']') as position
        from obsv.l_setcatch l_setcatch
            join tufman2.bio_sampling bio_sampling on l_setcatch.l_setcatch_id = bio_sampling.parent_dto_guid
            cross apply openjson(bio_sampling.extra_info_json, '$.ExtraInfo.WidgetMuscleSiteCodes')
            group by 
              l_setcatch.l_setcatch_id

        union all

        select
            l_setcatch.l_setcatch_id,
            concat('Biopsy punch [', string_agg(value, ','), ']') as position
        from obsv.l_setcatch l_setcatch
            join tufman2.bio_sampling bio_sampling on l_setcatch.l_setcatch_id = bio_sampling.parent_dto_guid
            cross apply openjson(bio_sampling.extra_info_json, '$.ExtraInfo.BiopsyMuscleSiteCodes')
            group by 
              l_setcatch.l_setcatch_id
        ) MuscleSiteCodes on MuscleSiteCodes.l_setcatch_id = l_setcatch.l_setcatch_id
        left join (
        select
            l_setcatch.l_setcatch_id,
            string_agg(value, ',') as position
        from obsv.l_setcatch l_setcatch
            join tufman2.bio_sampling bio_sampling on l_setcatch.l_setcatch_id = bio_sampling.parent_dto_guid
            cross apply openjson(bio_sampling.extra_info_json, '$.ExtraInfo.SpineSiteCodes')
            group by 
              l_setcatch.l_setcatch_id
        ) SpineSiteCodes on SpineSiteCodes.l_setcatch_id = l_setcatch.l_setcatch_id
    join ref.vessel_instances on vessel_instances.vessel_id = trip.vessel_id and coalesce(trip.ret_date, l_set.set_date, trip.dep_date) between vessel_instances.start_date and vessel_instances.calculated_end_date
    join ref.field_staff on field_staff.staff_code = @staff_code

where field_staff.staff_code = @staff_code and trip.dep_date= @departure_date
) a
group by
  a.vesselname,
  a.observer_full_name,
  a.set_number,
  a.set_date,
  a.catch_dtime,
  a.sp_code,
  a.sex_code,
  a.fish_length,
  a.label,
  a.comments,
  a.Gonads,
  a.Liver,
  a.Stomach,
  a.Otolith,
  a.Spine,
  a.Blood
order by a.set_number, a.label
;
",NA
"392","09f2ca2d-ef4f-6824-d040-3a1d014547cd","Longline Logsheet vs Observer effort (hooks) by year, Flag and EEZ","flag_code, year","Longline Logsheet vs Observer effort (hooks) by year, Flag and EEZ","Logsheets,Observer",NA,"Live",NA,3597,"aurelienp@spc.int","aurelienp@spc.int","Logsheet, Observer, Longline","2025-10-17T09:23:16.947","select l.*,ISNULL(o.hooks_obsv,0) hooks_obsv
from (
SELECT year(logdate) yr,vi.flag_id, eez_code,
SUM(cast(hooks_n as int)) as hooks_total_logsheet
FROM log.trips_ll t 
join log.sets_ll s on t.log_trip_id = s.log_trip_id 
join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate)= coalesce(:year,year(logdate)) and hooks_n is not null and flag_id = coalesce(:flag_code,flag_id)
group by year(logdate),vi.flag_id,eez_code) l left join 

(
select year(set_date) yr,vi.flag_id,eez_code,
	SUM(coalesce(bask_observed*cast(hk_bt_flt as int),0)) as hooks_obsv 
FROM [obsv].[trip] ot 
join [ref].[vessel_instances] vi on ot.vessel_id = vi.vessel_id and dep_date between start_date and calculated_end_date
join obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
join obsv.l_sethaullog lsh on ls.l_set_id = lsh.l_set_id and stend_id = 1
WHERE year(set_date) = coalesce(:year,year(set_date)) and eez_code is not null
group by year(set_date),vi.flag_id,eez_code) o on l.yr=o.yr and l.flag_id=o.flag_id and l.eez_code=o.eez_code",NA
"393","dff732cd-c822-544b-c8f6-3a03e6399fa1","LONGLINE - NATIONAL FLEET - Fishing effort (trips/fishing days)","year","Longline Logsheets - Number of trips/fishing days made by national fleet by year","Logsheets",NA,NA,NA,3475,"emmanuels@spc.int","emmanuels@spc.int","Logsheet, Longline, RegionalReporting","2022-05-25T12:04:50.017","SELECT min(ves.flag_id) as flag,count(distinct trip.log_trip_id) as nb_trips,
				Count(*) as Nb_Fishing_days
FROM log.trips_ll AS trip 
		INNER JOIN log.sets_ll AS sets ON trip.log_trip_id = sets.log_trip_id
		INNER JOIN ref.vessel_instances AS ves ON trip.vessel_id = ves.vessel_id AND trip.first_logdate between ves.start_date and ves.calculated_end_date
WHERE sets.l_activity_id = 1 AND YEAR(logdate)=:year AND ves.flag_id = @@entity ",NA
"394","5c539d4a-b272-ba73-5927-3a13a50022bd","IATTC ANNEX B Option 1 - SSI Vessel iteractions","flag_code, year",NA,"Observer",NA,"Observer",NA,3544,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline","2024-07-10T09:16:43.763","select
ot.gear_code as gear,
v.flag_id as flag,
year(ot.dep_date) as trip_year,
v.vesselname as vessel_name,
g2.interact_date as date,
coalesce(g2.interact_start_time,'-') as start_time,
coalesce(g2.interact_end_time,'-') as end_time,
coalesce(g2.lat,'-') as lat,
coalesce(g2.lon,'-') as lon,
coalesce(g2.eez_code,'-') as eez_code,
'VESSEL INTERACTION' as type,
sp.sp_cat_code as sp_cat_code,
sp.sp_code as sp_code,
sp.sp_name as species,
coalesce(g2.interact_code,'-') as interaction_code,
i.interact_desc,
coalesce(g2.interact_desc,'-') as [desc],
g2.dist_from_vessel_start as distance_start,
coalesce(g2.dist_start_unit,'-') as distance_start_unit,
g2.dist_from_vessel_end as distance_end,
coalesce(g2.dist_end_unit,'-') as distance_end_unit,
coalesce(g2.condition_code_start,'-') as condition_code_start,
coalesce(g2.condition_code_end,'-') as condition_code_end,
adults_len,
coalesce(adults_len_unit,'-') as adults_len_unit,
juveniles_len,
coalesce(adults_len_unit,'-') as juveniles_len_unit,
g2.adults_n as adult_n,
g2.juveniles_n as juveniles_n
FROM obsv.gen2interactions g2
join obsv.trip ot on ot.obstrip_id = g2.obstrip_id 
join (select distinct t.obstrip_id from obsv.trip t join obsv.l_set s on t.obstrip_id = s.obstrip_id 
	join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83 
	WHERE latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L') iattc_fishing on iattc_fishing.obstrip_id=ot.obstrip_id
left join ref.vessel_instances v on v.vessel_id = ot.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
left join ref.species sp on sp.sp_code = g2.sp_code
left join ref_static.gen2_interact_codes i on i.interact_code = g2.interact_code
where sp_cat_code in ('MAM','SHK','TTX','BRD') and
YEAR(interact_date) = coalesce(:year,year(interact_date)) 
    AND flag_id = coalesce(:flag_code,flag_id)",NA
"395","4e2dc7ef-b9e7-3222-f8b7-3a05981b6e58"," COVERAGE: Longline Observer Coverage by EEZ","eez_code, flag_code, year",NA,"Observer,VMS",NA,"Observer",NA,3488,"aurelienp@spc.int","andrewh@spc.int","Observer, Longline, CoverageMissingData","2022-10-06T08:40:31.45","SELECT flag_id as vessel_flag,
	gear as gear_code,
	[year],eez_code,
	COUNT(distinct vt.vms_trip_id) as vms_trips,
	SUM(vd.day_fishing) as days_fishing,
	SUM(vd.day_at_sea) as days_at_sea
INTO #mapped_vms_trip2
FROM tufman2_dorado.vms.vms_trips vt 
		inner join tufman2_dorado.vms.[vms_trip_efforts] vd on  vt.[vms_trip_id] = vd.[vms_trip_id]
		inner join ref.vessel_instances vi on vt.vessel_id = vi.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date
		inner join ref.vessels v on vt.vessel_id = v.vessel_id
where gear = 'L'
 and eez_code <> 'IW'
and eez_code = coalesce(:eez_code ,eez_code )
 and ( year(vt.departure_date) = :year or year(vt.return_date) = :year or ( year(vt.departure_date) < :year and year(vt.return_date) > :year) ) 
 and flag_id = coalesce(:flag_code,flag_id)
group by flag_id,
	gear,
	[year],eez_code
	
	 select
	c.vessel_flag,c.eez_code,
	ROUND(c.days_at_sea,0) days_at_sea,
	ROUND(c.days_fishing,0) days_fishing,
	ISNULL(obs_sea_days,0) as obs_sea_days,
	ISNULL(ROUND(obs_sea_days*1.0 / c.days_at_sea *100,1),0) sea_cov,
	ISNULL(obs_fish_days,0) as obs_fish_days,
	ISNULL(ROUND(obs_fish_days*1.0 / c.days_fishing *100,1),0) fishday_cov
from (
	select 
		v.flag_id,eez_code,
		count( obstrip_id) as obs_trips,
		SUM(case when data_status in (263,264) then 1 else 0 end) as trip_processed,
        sum(datediff(dd,case when year(dep_date) < :year then cast(cast(:year as char(4))+'-01-01' as datetime) else dep_date end,
						case when year(ret_date) > :year then cast(cast(:year as char(4))+'-12-31' as datetime) else ret_date end)+1) as obs_sea_days,
 		max(x.fish_days) as obs_fish_days
	FROM obsv.trip t 
		inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
		left outer join 
		(
		select 
			v.flag_id,eez_code,
			count(distinct case when year(set_date) = :year then ls.l_set_id else null end) as fish_days 
		FROM obsv.trip t 
			inner join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date			
			inner join obsv.l_set ls on t.obstrip_id = ls.obstrip_id
                        join obsv.l_sethaullog sh on sh.l_set_id = ls.l_set_id and stend_id=83
		WHERE obsprg_code not like '%EM' 
			and gear_code = 'L'
			and v.flag_id = coalesce(:flag_code,v.flag_id)
			and ( year(dep_date) = :year or year(ret_date) = :year or ( year(dep_date) < :year and year(ret_date) > :year) ) 
		group by v.flag_id,eez_code ) x on x.flag_id = v.flag_id
	WHERE  gear_code = 'L'
		and v.flag_id = coalesce(:flag_code,v.flag_id)
		and ( year(dep_date) = :year or year(ret_date) = :year or ( year(dep_date) < :year and year(ret_date) > :year) ) 
	group by t.gear_code,v.flag_id,x.eez_code) obs
right join #mapped_vms_trip2 c on c.vessel_flag=obs.flag_id and obs.eez_code=c.eez_code
where c.year=coalesce(:year, c.year) 
	and c.vessel_flag = coalesce(:flag_code,c.vessel_flag)
	AND c.gear_code = 'L'",NA
"396","42955d62-1c92-83c8-3cf0-3a1d5fb06e35","VU Catch Summary","eez_code, date_from, date_to","Custom Report for VU to get total catch in their EEZ","Logsheets",NA,NA,NA,3600,"shaazreenb@spc.int","shaazreenb@spc.int","","2025-11-04T17:20:34.957","  SELECT 
    flag_id,
    YEAR(logdate) AS year,
	month(logdate) as month,
	vesselname,
      CAST(SUM(CAST(CASE WHEN sp.sp_code = 'SKJ' THEN sp_kg ELSE 0 END AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS skj_mt,
      CAST(SUM(CAST(CASE WHEN sp.sp_code = 'YFT' THEN sp_kg ELSE 0 END AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS yft_mt,
      CAST(SUM(CAST(CASE WHEN sp.sp_code = 'BET' THEN sp_kg ELSE 0 END AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS bet_mt,
      CAST(SUM(CAST(CASE WHEN sp.sp_code = 'ALB' THEN sp_kg ELSE 0 END AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS alb_mt,

      CAST(SUM(CAST(CASE WHEN sp.sp_code NOT IN ('SKJ','YFT','BET','ALB') THEN sp_kg ELSE 0 END AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS other_mt,

      CAST(SUM(CAST(sp_kg AS DECIMAL(18,3))) / 1000 AS DECIMAL(9,3)) AS total_mt
FROM log.trips_ll t
    INNER JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
    LEFT JOIN log.catch_ll c ON s.log_set_id = c.log_set_id
    INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND COALESCE(t.first_logdate,t.depart_date) BETWEEN vi.start_date AND vi.calculated_end_date
	  INNER JOIN ref.species sp ON c.sp_code = sp.sp_code
    AND l_activity_id = 1
  GROUP BY vi.flag_id, vi.vessel_id, vi.vesselname, YEAR(logdate), MONTH(logdate)
",NA
"397","0b48f911-475d-7140-b8af-3a06ae259dda","LONGLINE - Logsheet / Unloadings / Port sampling catch comparison","flag_code, year","Report used to compare the total trip catch by species (ALB, YFT and BET only) reported on LOGSHEETs with PORT SAMPLED catch and UNLOADED catch.  The port sampled catch includes the catch by species that are NOT MEASURED also.","Logsheets,Port",NA,NA,NA,3494,"peterw@spc.int","peterw@spc.int","Logsheet, PortSampling, Unloading, Longline, DataQuality","2022-10-04T08:42:46.297","SELECT      vi.vesselname, 
			vi.flag_id, 
			CONVERT(nvarchar,t.depart_date,111) depart_date,dp.port_name dp,
			CONVERT(nvarchar,t.return_date,111) return_date,rp.port_name rp,
			max(case when z.sp_code = 'ALB' then z.sp_n else 00000 end) as alb_log_n,
			max(case when y.sp_code = 'ALB' then y.port_n else 00000 end) as alb_port_n,
			max(case when x.sp_code = 'ALB' then x.unl_n else 00000 end) as alb_unl_n,
			max(case when z.sp_code = 'YFT' then z.sp_n else 00000 end) as YFT_log_n,
			max(case when y.sp_code = 'YFT' then y.port_n else 00000 end) as YFT_port_n,
			max(case when x.sp_code = 'YFT' then x.unl_n else 00000 end) as YFT_unl_n,
			max(case when z.sp_code = 'BET' then z.sp_n else 00000 end) as BET_log_n,
			max(case when y.sp_code = 'BET' then y.port_n else 00000 end) as BET_port_n,
			max(case when x.sp_code = 'BET' then x.unl_n else 00000 end) as BET_unl_n
FROM    log.trips_ll t	
		LEFT JOIN tufman2.viewpersist_entity_links_two_way l ON t.log_trip_id = l.dto_guid_left AND l.dto_type_left='LonglineLogsheetDTO'  AND l.dto_type_right='UnloadingDTO'
		LEFT JOIN tufman2.viewpersist_entity_links_two_way l2 ON t.log_trip_id = l2.dto_guid_left AND l2.dto_type_left='LonglineLogsheetDTO'  AND l2.dto_type_right='PortSamplingDTO'
        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
        INNER JOIN ref.ports dp ON t.depart_port_id = dp.port_id
        INNER JOIN ref.ports rp ON t.return_port_id = rp.port_id
		INNER JOIN (select	t.log_trip_id,
							c.sp_code, 
							sum(c.sp_n) as sp_n 
					FROM    log.trips_ll t	
					    INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
						INNER JOIN log.sets_ll s on t.log_trip_id = s.log_trip_id 
						INNER JOIN log.catch_ll c on  s.log_set_id = c.log_set_id 
					WHERE     
						YEAR(t.depart_date) >= COALESCE(:year,YEAR(t.depart_date))  
						AND   COALESCE(:flag_code,vi.flag_id) = vi.flag_id
						and c.sp_code in ('ALB','YFT','BET')
					GROUP by t.log_trip_id, c.sp_code) z on t.log_trip_id = z.log_trip_id
		LEFT OUTER JOIN (	select  u2_c.unload_id, 
									u2_c.sp_code,
									SUM(u2_c.sp_n) as unl_n
							from unload2.unloading_catch u2_c
							where u2_c.sp_code in ('ALB','YFT','BET')
							group by u2_c.unload_id, u2_c.sp_code) x on l.dto_guid_right = x.unload_id
		LEFT OUTER JOIN (	select p_c.sample_id,
									p_c.sp_code, 
									count(p_c.sample_catch_id) + max(coalesce(p_n.num_not_measured,0)) as port_n
							from port.samples p 
									inner join port.sample_catch p_c on p.sample_id = p_c.sample_id 
									left outer join port.not_measured_fish p_n on p.sample_id = p_n.sample_id and p_n.sp_code = p_c.sp_code
							where p_c.sp_code in ('ALB','YFT','BET')
							group by p_c.sample_id,p_c.sp_code
							) y on l2.dto_guid_right = y.sample_id
WHERE     
			YEAR(t.depart_date) = COALESCE(:year, YEAR(t.depart_date))  
	AND   COALESCE(:flag_code, vi.flag_id) = vi.flag_id
group by 
	vi.vesselname, 
	vi.flag_id, 
	CONVERT(nvarchar,t.depart_date,111),dp.port_name,
	CONVERT(nvarchar,t.return_date,111),rp.port_name
	",NA
"398","d1b0d08a-2d94-b08d-8933-3a06b2701c80","VMS-LOG-OBS reconciliation","flag_code, year, gear_code","find missing data from logsheet or observer, by comparing with VMS","Logsheets,Observer,VMS",NA,"Live",NA,3495,"emmanuels@spc.int","aurelienp@spc.int","Logsheet, Observer, VMS, Longline, PoleAndLine, Purseseine, CoverageMissingData","2025-09-19T08:40:24.58","Select * from (
SELECT	v.gear,
		vi.flag_id,
		vi.vesselname,
		vi.vessel_id,
		CONVERT(nvarchar, vt.departure_date, 111) VMS_dep_date, 
		CONVERT(nvarchar, vt.return_date, 111) VMS_ret_date,
		linklog.dto_guid_right as log_trip_id,
		CONVERT(nvarchar, lt.first_logdate, 111) as LOG_dep_date, 
		CONVERT(nvarchar, lt.last_logdate, 111) as LOG_ret_date,
		linkobs.dto_guid_right as obs_trip_id,
		CONVERT(nvarchar, ot.dep_date, 111) as OBS_dep_date, 
		CONVERT(nvarchar, ot.ret_date, 111) as OBS_ret_date,
		ot.data_status
FROM	vms.vms_trips vt
			left join tufman2.viewpersist_entity_links_two_way linklog on vt.vms_trip_id = linklog.dto_guid_left and linklog.dto_type_left = 'VmsTripDTO' and linklog.dto_type_right = 'PurseseineLogsheetDTO' 
			left join log.trips_ps lt ON lt.log_trip_id = linklog.dto_guid_right
			left join tufman2.viewpersist_entity_links_two_way linkObs on vt.vms_trip_id = linkObs.dto_guid_left and linkObs.dto_type_left = 'VmsTripDTO' and linkObs.dto_type_right = 'ObserverTripDTO' 
			left join obsv.trip ot ON ot.obstrip_id = linkObs.dto_guid_right
			INNER JOIN ref.vessel_instances vi ON vi.vessel_id = vt.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
			INNER JOIN ref.vessels v ON vi.vessel_id = v.vessel_id 
WHERE	YEAR(vt.departure_date) = COALESCE(:year, year(vt.departure_date))
		AND vi.flag_id = COALESCE(:flag_code,vi.flag_id)
		AND v.gear in ('S')
union
SELECT	v.gear,
		vi.flag_id,
		vi.vesselname,
		vi.vessel_id,
		CONVERT(nvarchar, vt.departure_date, 111) VMS_dep_date, 
		CONVERT(nvarchar, vt.return_date, 111) VMS_ret_date,
		linklog.dto_guid_right as log_trip_id,
		CONVERT(nvarchar, lt.first_logdate, 111) as LOG_dep_date, 
		CONVERT(nvarchar, lt.last_logdate, 111) as LOG_ret_date,
		linkobs.dto_guid_right as obs_trip_id,
		CONVERT(nvarchar, ot.dep_date, 111) as OBS_dep_date, 
		CONVERT(nvarchar, ot.ret_date, 111) as OBS_ret_date,
		ot.data_status
FROM	vms.vms_trips vt
			left join tufman2.viewpersist_entity_links_two_way linklog on vt.vms_trip_id = linklog.dto_guid_left and linklog.dto_type_left = 'VmsTripDTO' and linklog.dto_type_right = 'LonglineLogsheetDTO' 
			left join log.trips_ll lt ON lt.log_trip_id = linklog.dto_guid_right
			left join tufman2.viewpersist_entity_links_two_way linkObs on vt.vms_trip_id = linkObs.dto_guid_left and linkObs.dto_type_left = 'VmsTripDTO' and linkObs.dto_type_right = 'ObserverTripDTO' 
			left join obsv.trip ot ON ot.obstrip_id = linkObs.dto_guid_right
			INNER JOIN ref.vessel_instances vi ON vi.vessel_id = vt.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
			INNER JOIN ref.vessels v ON vi.vessel_id = v.vessel_id 
WHERE	YEAR(vt.departure_date) = COALESCE(:year, year(vt.departure_date))
		AND vi.flag_id = COALESCE(:flag_code,vi.flag_id)
		AND v.gear in ('L')
UNION
SELECT	v.gear,
		vi.flag_id,
		vi.vesselname,
		vi.vessel_id,
		CONVERT(nvarchar, vt.departure_date, 111) VMS_dep_date, 
		CONVERT(nvarchar, vt.return_date, 111) VMS_ret_date,
		linklog.dto_guid_right as log_trip_id,
		CONVERT(nvarchar, lt.first_logdate, 111) as LOG_dep_date, 
		CONVERT(nvarchar, lt.last_logdate, 111) as LOG_ret_date,
		linkobs.dto_guid_right as obs_trip_id,
		CONVERT(nvarchar, ot.dep_date, 111) as OBS_dep_date, 
		CONVERT(nvarchar, ot.ret_date, 111) as OBS_ret_date,
		ot.data_status
FROM	vms.vms_trips vt
			left join tufman2.viewpersist_entity_links_two_way linklog on vt.vms_trip_id = linklog.dto_guid_left and linklog.dto_type_left = 'VmsTripDTO' and linklog.dto_type_right = 'PoleAndLineLogsheetDTO' 
			left join log.trips_pl lt ON lt.log_trip_id = linklog.dto_guid_right
			left join tufman2.viewpersist_entity_links_two_way linkObs on vt.vms_trip_id = linkObs.dto_guid_left and linkObs.dto_type_left = 'VmsTripDTO' and linkObs.dto_type_right = 'ObserverTripDTO' 
			left join obsv.trip ot ON ot.obstrip_id = linkObs.dto_guid_right
			INNER JOIN ref.vessel_instances vi ON vi.vessel_id = vt.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
			INNER JOIN ref.vessels v ON vi.vessel_id = v.vessel_id 
WHERE	YEAR(vt.departure_date) = COALESCE(:year, year(vt.departure_date))
		AND vi.flag_id = COALESCE(:flag_code,vi.flag_id)
		AND v.gear in ('P')
) tmp
where coalesce(:gear_code, tmp.gear) = tmp.gear",NA
"399","434b6e42-28cf-b7ed-5797-3a0936212b7a","LONGLINE - Logsheet vs observer set catches (including not matching records)","year","Comparison at set level between logsheet and observer data - Only for matching trips (obsv / logsheet) and include all catches even if no match between logs/obsv","Logsheets,Observer",NA,NA,NA,3501,"aurelienp@spc.int","aurelienp@spc.int","Logsheet, Observer, Longline, DataQuality, AllSpecies","2023-02-06T11:17:30.87","select coalesce(logs.vesselname,obsv.vesselname) vesselname,coalesce(depart_date,dep_date) depart_date,coalesce(return_date,ret_date) return_date,coalesce(logdate,set_date) logdate,coalesce(logs.sp_code,obsv.sp_code) sp_code,sp_n logs_n,spdiscard_n log_n_discard,obs_n,coalesce(logs.LonglineLogsheetDTO,obsv.LonglineLogsheetDTO) LonglineLogsheetDTO,coalesce(obsv.ObserverTripDTO,logs.ObserverTripDTO) ObserverTripDTO,pct_observed
from (
SELECT	
		vi.vesselname,
		CONVERT(nvarchar, t.depart_date, 111) depart_date, 
		CONVERT(nvarchar, t.return_date, 111) return_date, 
                CONVERT(nvarchar, logdate, 111) logdate, 
		c.sp_code,
		COALESCE(c.sp_n, 0) sp_n, 
		COALESCE(c.spdiscard_n, 0) spdiscard_n, 
		t.log_trip_id LonglineLogsheetDTO,
                el.dto_guid_right ObserverTripDTO,
		t.vessel_id
FROM	
		log.trips_ll t JOIN
		tufman2.viewpersist_entity_links_two_way el ON t.log_trip_id = el.dto_guid_left and dto_type_right = 'ObserverTripDTO' JOIN
		ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date JOIN
		log.sets_ll s ON s.log_trip_id = t.log_trip_id JOIN
		log.catch_ll c ON c.log_set_id = s.log_set_id 
WHERE	YEAR(logdate) = COALESCE(:year, year(logdate))
) logs full outer join
(
	SELECT	
			vesselname,
			o.tripno,
                        CONVERT(nvarchar, o.dep_date, 111) dep_date, 
		        CONVERT(nvarchar, o.ret_date, 111) ret_date, 
			o.vessel_id,
			sp_code,
			o.obstrip_id ObserverTripDTO,
			el.dto_guid_left LonglineLogsheetDTO,
                        CONVERT(nvarchar, set_date, 111) set_date, 
			bask_set,bask_observed,round(bask_observed*1.0/bask_set*100,0)as pct_observed,
			count(*) as obs_n
	FROM	obsv.trip o JOIN
			tufman2.viewpersist_entity_links_two_way el ON o.obstrip_id = el.dto_guid_right and dto_type_left = 'LonglineLogsheetDTO' JOIN
			ref.vessel_instances vi ON vi.vessel_id = o.vessel_id AND o.dep_date BETWEEN vi.start_date AND vi.calculated_end_date JOIN
			obsv.l_set os ON os.obstrip_id = o.obstrip_id JOIN
			obsv.l_setcatch oc ON oc.l_set_id = os.l_set_id 
	WHERE	YEAR(set_date) = COALESCE(:year, year(set_date))
	GROUP BY o.tripno,o.vessel_id,CONVERT(nvarchar, o.dep_date, 111) ,CONVERT(nvarchar, o.ret_date, 111) ,
			sp_code,
			o.obstrip_id,
			CONVERT(nvarchar, set_date, 111) ,
			bask_set,bask_observed,round(bask_observed*1.0/bask_set*100,0),vesselname,el.dto_guid_left
) obsv on logs.LonglineLogsheetDTO = obsv.LonglineLogsheetDTO
	and obsv.set_date=logs.logdate
	and logs.sp_code=obsv.sp_code
",NA
"400","144ca9ba-f573-f823-43ce-3a0d2ca6e54d","LONGLINE - Map of catches - NATIONAL FLEET","year","Map of catches for your national fleet","Logsheets",2,NA,NA,3518,"brunod@spc.int","brunod@spc.int","Logsheet, Longline, RegionalReporting","2023-08-22T10:44:23.027"," SELECT  floor(ref.GetLatDfromLat(lat)/1)*1+0.5 Latitude,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5 Longitude, 
		Sum(case sp_code when 'ALB' then sp_kg_est else 0000 end)				AS alb_kg, 
		Sum(case sp_code when 'BET' then sp_kg_est else 0000 end) 				AS bet_kg, 
		Sum(case sp_code when 'YFT' then sp_kg_est else 0000 end) 				AS yft_kg, 
		Sum(case sp_code when 'BLM' then sp_kg_est else 0000 end) 				AS blm_kg, 
		Sum(case sp_code when 'BUM' then sp_kg_est else 0000 end) 				AS bum_kg, 
		Sum(case sp_code when 'MLS' then sp_kg_est else 0000 end) 				AS mls_kg, 
		Sum(case sp_code when 'SWO' then sp_kg_est else 0000 end) 				AS swo_kg 
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) = coalesce(:year, year(logdate)) 
  AND	(@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by floor(ref.GetLatDfromLat(lat)/1)*1+0.5 ,
		floor(ref.GetLonD360fromLon(lon)/1)*1+0.5",NA
"401","edaccf48-7f72-a99d-d5f6-3a0da3c602be"," LONGLINE Catch by location, species and vessels (5x5)","year",NA,"Logsheets",NA,NA,NA,3519,"brunod@spc.int","shaazreenb@spc.int","Logsheet, Longline, MyEEZ, AllSpecies","2024-10-01T23:04:56.56","SELECT YEAR(logdate) yr,
	company_name,
	vi.vesselname,
	COUNT(DISTINCT CAST(t.log_trip_id AS VARCHAR(50)) + CAST(CAST(logdate AS DATE) AS VARCHAR(10))) log_days,
	FLOOR(latd/5)*5+2.5 lat,
	FLOOR(lond/5)*5+2.5 lon,
	MAX(hhooks) hks,
	vi.flag_id,
	sp.sp_cat_code,
	c.sp_code,
	SUM(ISNULL(coalesce(sp_kg,sp_kg_est),0)) AS wt_kg,
	SUM(ISNULL(coalesce(sp_n,sp_n_est),0)) AS nbr,
	SUM(ISNULL(c.spdiscard_n,0)) AS discard_nbr,
	SUM(ISNULL(coalesce(sp_kg,sp_kg_est),0))*1.0/COUNT(DISTINCT CAST(t.log_trip_id AS VARCHAR(50)) + CAST(CAST(logdate AS DATE) AS VARCHAR(10))) kg_per_day,
	SUM(ISNULL(coalesce(sp_kg,sp_kg_est),0))*1.0 / MAX(hhooks)*1000 AS gr_per_hk
FROM
	log.trips_ll t 
	JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date 
	JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
	JOIN log.catch_ll c ON s.log_set_id = c.log_set_id 
	JOIN ref.species sp ON sp.sp_code = c.sp_code
	LEFT JOIN [tufman].[companies] comp on comp.company_id = vi.company_id
	JOIN (
		SELECT  
			vesselname,
			FLOOR(latd/5)*5+2.5 lat1,
			FLOOR(lond/5)*5+2.5 lon1,
			flag_id,
			year(logdate) yr,
			SUM(hooks_n) hhooks  
		FROM
			log.trips_ll t JOIN log.sets_ll s ON t.log_trip_id = s.log_trip_id
			JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_END_date 
		WHERE   
			YEAR(logdate) = COALESCE(:year, YEAR(logdate)) 
		GROUP BY 
			vesselname,
			FLOOR(latd/5)*5+2.5,
			FLOOR(lond/5)*5+2.5,
			flag_id,year(logdate)
	) tmp ON FLOOR(latd/5)*5+2.5 = lat1 AND FLOOR(lond/5)*5+2.5 = lon1 AND year(logdate) = yr AND tmp.flag_id = vi.flag_id AND tmp.vesselname = vi.vesselname
WHERE   YEAR(logdate) = COALESCE(:year, YEAR(logdate))
AND		(@@entity = 'HIVE' OR eez_code IN (SELECT eez_code FROM ref.GetEEzAndSubEEzFromEEz(@@entity)))
GROUP BY 
	FLOOR(latd/5)*5+2.5,
	FLOOR(lond/5)*5+2.5,
	YEAR(logdate),
	vi.vesselname,
	vi.flag_id,
	c.sp_code,
	sp.sp_cat_code,
	company_name",NA
"402","e8d3a41f-0f7a-1c11-f1ee-3a11dd5e12de","DUMP artisanal vessels","","All fields","Artisanal",NA,NA,NA,3525,"benoitp@spc.int","shaazreenb@spc.int","Artisanal","2025-09-22T18:10:40.007","SELECT vessel_name
      ,vessel_type_id
      ,skipper_name
      ,owner_name
      ,owner_postal_address
      ,owner_island
      ,owner_contact
      ,owner_vessels_n
      ,vessel_date
      ,region_id
      ,mooring
      ,vessel_make
      ,hull_material_id
      ,vessel_hull_type
      ,vessel_colour
      ,boat_power_id
      ,motor_location
      ,engine_power
      ,outboards_n
      ,fuel_type_id
      ,repairs_required
      ,vessel_use_id
      ,trips_per_day_id
      ,where_fished_id
      ,fish_targeted_id
      ,expiration_date
      ,entered_date
      ,changed_date
      ,ves_island_code
      ,ves_unique_id
      ,vessel_id
      ,visibility
      ,has_cabin
      ,not_seaworthy
      ,fished_last_year
      ,will_fish_this_year
      ,sports_fishing_boat
      ,has_lifejacket
      ,has_life_raft
      ,has_first_aid_kit
      ,has_water
      ,has_engine_tools
      ,has_bailing_device
      ,has_anchor
      ,has_spare_fuel
      ,has_auxiliary_motor
      ,has_paddle
      ,has_sail
      ,has_shade_cloth
      ,has_flares
      ,has_mirror
      ,has_laser
      ,has_torch
      ,has_radio_beacon
      ,has_gps
      ,has_echo_sounder
      ,has_radio
      ,has_compass
      ,date_completed
      ,form_filled_by
      ,is_active
      ,vessel_length
  FROM art2.vessels v",NA
"403","8e912dd2-3c85-bce7-eaf4-3a11ddaf691a","ARTISANAL - Monthly Activity Log by Landing Site (ACE Rep #1)","year","ARTISANAL - Monthly Activity Log by Landing Site  (ACE Rep #1)","",NA,NA,NA,3526,"peterw@spc.int","peterw@spc.int","Artisanal","2024-04-11T15:58:33.193","SELECT landing_site_name,
		sum(case when MONTH(activity_date) = 1 then motor_vessels_n else 0 end) as jan_motor_trips,
		sum(case when MONTH(activity_date) = 2 then motor_vessels_n else 0 end) as feb_motor_trips,
		sum(case when MONTH(activity_date) = 3 then motor_vessels_n else 0 end) as mar_motor_trips,
		sum(case when MONTH(activity_date) = 4 then motor_vessels_n else 0 end) as apr_motor_trips,
		sum(case when MONTH(activity_date) = 5 then motor_vessels_n else 0 end) as may_motor_trips,
		sum(case when MONTH(activity_date) = 6 then motor_vessels_n else 0 end) as jun_motor_trips,
		sum(case when MONTH(activity_date) = 7 then motor_vessels_n else 0 end) as jul_motor_trips,
		sum(case when MONTH(activity_date) = 8 then motor_vessels_n else 0 end) as aug_motor_trips,
		sum(case when MONTH(activity_date) = 9 then motor_vessels_n else 0 end) as sep_motor_trips,
		sum(case when MONTH(activity_date) = 10 then motor_vessels_n else 0 end) as oct_motor_trips,
		sum(case when MONTH(activity_date) = 11 then motor_vessels_n else 0 end) as nov_motor_trips,
		sum(case when MONTH(activity_date) = 12 then motor_vessels_n else 0 end) as dec_motor_trips
  FROM [art2].[fishing_activity_log] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
  where YEAR(activity_date) = :year
  and ref.GetEntityFromBit(a1.instance_source) = @@entity
group by  landing_site_name 
order by 1",NA
"404","567c42e0-425d-5b95-6368-3a11ddb47641","ARTISANAL - Monthly LOG Trips by Landing Site (ACE Rep #3)","year","ARTISANAL - Monthly LOG Trips by Landing Site (ACE Rep #3)","Artisanal",NA,NA,NA,3527,"peterw@spc.int","shaazreenb@spc.int","Artisanal","2025-06-27T16:30:32.087","SELECT landing_site_name,
		count(distinct case when MONTH(trip_date) = 1 then a1.art_trip_id else null end) as jan_days_rec,
		count(distinct case when MONTH(trip_date) = 2 then a1.art_trip_id else null end) as feb_days_rec,
		count(distinct case when MONTH(trip_date) = 3 then a1.art_trip_id else null end) as mar_days_rec,
		count(distinct case when MONTH(trip_date) = 4 then a1.art_trip_id else null end) as apr_days_rec,
		count(distinct case when MONTH(trip_date) = 5 then a1.art_trip_id else null end) as may_days_rec,
		count(distinct case when MONTH(trip_date) = 6 then a1.art_trip_id else null end) as jun_days_rec,
		count(distinct case when MONTH(trip_date) = 7 then a1.art_trip_id else null end) as jul_days_rec,
		count(distinct case when MONTH(trip_date) = 8 then a1.art_trip_id else null end) as aug_days_rec,
		count(distinct case when MONTH(trip_date) = 9 then a1.art_trip_id else null end) as sep_days_rec,
		count(distinct case when MONTH(trip_date) = 10 then a1.art_trip_id else null end) as oct_days_rec,
		count(distinct case when MONTH(trip_date) = 11 then a1.art_trip_id else null end) as nov_days_rec,
		count(distinct case when MONTH(trip_date) = 12 then a1.art_trip_id else null end) as dec_days_rec
  FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
  where YEAR(trip_date) = :year
  and ref.GetEntityFromBit(a1.instance_source) = @@entity
group by  landing_site_name 
order by 1
",NA
"405","dbb72c07-8fc4-894b-80e6-3a11ddb90aec","ARTISANAL - Monthly ACTIVITY LOG days monitored (ACE Rep #2)","year","ARTISANAL - Monthly ACTIVITY LOG days monitored (ACE Rep #2)","",NA,NA,NA,3528,"peterw@spc.int","peterw@spc.int","Artisanal","2024-04-17T09:39:29.253","SELECT landing_site_name,
		count(distinct case when MONTH(activity_date) = 1 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as jan_days_rec,
		count(distinct case when MONTH(activity_date) = 2 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as feb_days_rec,
		count(distinct case when MONTH(activity_date) = 3 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as mar_days_rec,
		count(distinct case when MONTH(activity_date) = 4 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as apr_days_rec,
		count(distinct case when MONTH(activity_date) = 5 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as may_days_rec,
		count(distinct case when MONTH(activity_date) = 6 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as jun_days_rec,
		count(distinct case when MONTH(activity_date) = 7 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as jul_days_rec,
		count(distinct case when MONTH(activity_date) = 8 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as aug_days_rec,
		count(distinct case when MONTH(activity_date) = 9 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as sep_days_rec,
		count(distinct case when MONTH(activity_date) = 10 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as oct_days_rec,
		count(distinct case when MONTH(activity_date) = 11 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as nov_days_rec,
		count(distinct case when MONTH(activity_date) = 12 then cast(a1.landing_site_id as varchar(50))+cast(activity_date as char(12)) else null end) as dec_days_rec
  FROM [art2].[fishing_activity_log] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
  where YEAR(activity_date) = :year
   and ref.GetEntityFromBit(a1.instance_source) = @@entity
group by  landing_site_name ",NA
"406","ad6ae720-3ea4-4062-fa35-3a11ddbd5f1b","ARTISANAL - Monthly unraised SKJ catch (ACE Rep #4)","year","ARTISANAL - Monthly unraised SKJ catch (ACE Rep #4)","",NA,NA,NA,3529,"peterw@spc.int","peterw@spc.int","Artisanal","2024-04-12T09:48:29.31","SELECT landing_site_name,
		sum(case when MONTH(trip_date) = 1 then sp_kg else 0 end) as jan_skj_kgs,
		sum(case when MONTH(trip_date) = 2 then sp_kg else 0 end) as feb_skj_kgs,
		sum(case when MONTH(trip_date) = 3 then sp_kg else 0 end) as mar_skj_kgs,
		sum(case when MONTH(trip_date) = 4 then sp_kg else 0 end) as apr_skj_kgs,
		sum(case when MONTH(trip_date) = 5 then sp_kg else 0 end) as may_skj_kgs,
		sum(case when MONTH(trip_date) = 6 then sp_kg else 0 end) as jun_skj_kgs,
		sum(case when MONTH(trip_date) = 7 then sp_kg else 0 end) as jul_skj_kgs,
		sum(case when MONTH(trip_date) = 8 then sp_kg else 0 end) as aug_skj_kgs,
		sum(case when MONTH(trip_date) = 9 then sp_kg else 0 end) as sep_skj_kgs,
		sum(case when MONTH(trip_date) = 10 then sp_kg else 0 end) as oct_skj_kgs,
		sum(case when MONTH(trip_date) = 11 then sp_kg else 0 end) as nov_skj_kgs,
		sum(case when MONTH(trip_date) = 12 then sp_kg else 0 end) as dec_skj_kgs
  FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
						 inner join [art2].[effort] e on a1.art_trip_id = e.art_trip_id
						 inner join [art2].[catch] c on e.art_effort_id = c.art_effort_id
  where YEAR(trip_date) = :year
    and ref.GetEntityFromBit(a1.instance_source) = @@entity
  and sp_code = 'SKJ'
group by  landing_site_name 
order by 1",NA
"407","498d03a8-ef89-dff6-0f74-3a11ddc1a83b","ARTISANAL - Monthly unraised YFT Catch (ACE Rep #5)","year","ARTISANAL - Monthly unraised YFT Catch (ACE Rep #5)","",NA,NA,NA,3530,"peterw@spc.int","peterw@spc.int","Artisanal","2024-04-23T10:17:16.44","SELECT landing_site_name,
		sum(case when MONTH(trip_date) = 1 then sp_kg else 0 end) as jan_skj_kgs,
		sum(case when MONTH(trip_date) = 2 then sp_kg else 0 end) as feb_skj_kgs,
		sum(case when MONTH(trip_date) = 3 then sp_kg else 0 end) as mar_skj_kgs,
		sum(case when MONTH(trip_date) = 4 then sp_kg else 0 end) as apr_skj_kgs,
		sum(case when MONTH(trip_date) = 5 then sp_kg else 0 end) as may_skj_kgs,
		sum(case when MONTH(trip_date) = 6 then sp_kg else 0 end) as jun_skj_kgs,
		sum(case when MONTH(trip_date) = 7 then sp_kg else 0 end) as jul_skj_kgs,
		sum(case when MONTH(trip_date) = 8 then sp_kg else 0 end) as aug_skj_kgs,
		sum(case when MONTH(trip_date) = 9 then sp_kg else 0 end) as sep_skj_kgs,
		sum(case when MONTH(trip_date) = 10 then sp_kg else 0 end) as oct_skj_kgs,
		sum(case when MONTH(trip_date) = 11 then sp_kg else 0 end) as nov_skj_kgs,
		sum(case when MONTH(trip_date) = 12 then sp_kg else 0 end) as dec_skj_kgs
  FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
						 inner join [art2].[effort] e on a1.art_trip_id = e.art_trip_id
						 inner join [art2].[catch] c on e.art_effort_id = c.art_effort_id
  where YEAR(trip_date) = :year
    and ref.GetEntityFromBit(a1.instance_source) = @@entity
  and sp_code = 'YFT'
group by  landing_site_name 
order by 1
",NA
"408","2122c405-6389-df8c-d7c4-3a11ddc34171","ARTISANAL - Monthly unraised BET Catch (ACE Rep #6)","year","ARTISANAL - Monthly unraised BET Catch (ACE Rep #6)","",NA,NA,NA,3531,"peterw@spc.int","peterw@spc.int","Artisanal","2024-11-01T11:07:44.73","SELECT landing_site_name,
		sum(case when MONTH(trip_date) = 1 then sp_kg else 0 end) as jan_skj_kgs,
		sum(case when MONTH(trip_date) = 2 then sp_kg else 0 end) as feb_skj_kgs,
		sum(case when MONTH(trip_date) = 3 then sp_kg else 0 end) as mar_skj_kgs,
		sum(case when MONTH(trip_date) = 4 then sp_kg else 0 end) as apr_skj_kgs,
		sum(case when MONTH(trip_date) = 5 then sp_kg else 0 end) as may_skj_kgs,
		sum(case when MONTH(trip_date) = 6 then sp_kg else 0 end) as jun_skj_kgs,
		sum(case when MONTH(trip_date) = 7 then sp_kg else 0 end) as jul_skj_kgs,
		sum(case when MONTH(trip_date) = 8 then sp_kg else 0 end) as aug_skj_kgs,
		sum(case when MONTH(trip_date) = 9 then sp_kg else 0 end) as sep_skj_kgs,
		sum(case when MONTH(trip_date) = 10 then sp_kg else 0 end) as oct_skj_kgs,
		sum(case when MONTH(trip_date) = 11 then sp_kg else 0 end) as nov_skj_kgs,
		sum(case when MONTH(trip_date) = 12 then sp_kg else 0 end) as dec_skj_kgs
  FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
						 inner join [art2].[effort] e on a1.art_trip_id = e.art_trip_id
						 inner join [art2].[catch] c on e.art_effort_id = c.art_effort_id
  where YEAR(trip_date) = :year
    and ref.GetEntityFromBit(a1.instance_source) = @@entity
  and sp_code = 'BET'
group by  landing_site_name 
order by 1
",NA
"409","edfb4bbb-7d35-10ae-d8e2-3a1205666ff7","IATTC observer coverage","","Observer coverage in the IATTC using the logsheet to estimate the totals. Vessel LOA >=20m","Logsheets,Observer",NA,"Live",NA,3533,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline, CoverageMissingData","2025-09-16T09:55:51.99","select 
	lo.yr,lo.flag_id,
	Total_vessels_deep+Total_vessels_shallow as Total_vessels_all,
	obsv_vessels_deep+obsv_vessels_shallow as obsv_vessels_all,
	ROUND((obsv_vessels_deep+obsv_vessels_shallow)*1.0/(Total_vessels_deep+Total_vessels_shallow)*100.0,1) as pct_vessels_observed_all,
	Total_trips_deep+Total_trips_shallow as Total_trips_all,
	obsv_trips_deep+obsv_trips_shallow as obsv_trips_all,
	ROUND((obsv_trips_deep+obsv_trips_shallow)*1.0/(Total_trips_deep+Total_trips_shallow)*100.0,1) as pct_trips_observed_all,
	Total_fishingDays_deep+Total_fishingDays_shallow as Total_fishingDays_all,
	obsv_fishingDays_deep+obsv_fishingDays_shallow as obsv_fishingDays_all,
	ROUND((obsv_fishingDays_deep+obsv_fishingDays_shallow)*1.0/(Total_fishingDays_deep+Total_fishingDays_shallow)*100.0,1) as pct_FishingDays_observed_all,
	Total_sets_deep+Total_sets_shallow as Total_sets_all,
	obsv_sets_deep+obsv_sets_shallow as obsv_sets_all,
	ROUND((obsv_sets_deep+obsv_sets_shallow)*1.0/(Total_sets_deep+Total_sets_shallow)*100.0,1) as pct_sets_observed_all,
	Total_hks_shallow+Total_hks_deep as Total_hks_all,
	obsv_hks_deep+obsv_hks_shallow as obsv_hks_all,
	ROUND((obsv_hks_deep+obsv_hks_shallow)*1.0/(Total_hks_shallow+Total_hks_deep)*100.0,1) as pct_hks_observed_all,
	bait.bait_total,
	hks.hook_type as hook_type_total,
	Total_vessels_shallow,
	obsv_vessels_shallow,
	ROUND(obsv_vessels_shallow*1.0/Total_vessels_shallow*100.0,2) as pct_vessels_observed_shallow,
	Total_trips_shallow,
	obsv_trips_shallow,
	ROUND(obsv_trips_shallow*1.0/Total_trips_shallow*100.0,2) as pct_trips_observed_shallow,
	Total_fishingDays_shallow,
	obsv_fishingDays_shallow,
	ROUND(obsv_fishingDays_shallow*1.0/Total_fishingDays_shallow*100.0,2) as pct_FishingDays_observed_shallow,
	Total_sets_shallow,
	obsv_sets_shallow,
	ROUND(obsv_sets_shallow*1.0/Total_sets_shallow*100.0,2) as pct_sets_observed_shallow,
	Total_hks_shallow,
	obsv_hks_shallow,
	ROUND(obsv_hks_shallow*1.0/Total_hks_shallow*100.0,2) as pct_hks_observed_shallow,
	bait.bait_shallow,
	Total_vessels_deep,
	obsv_vessels_deep,
	ROUND(obsv_vessels_deep*1.0/Total_vessels_deep*100.0,2) as pct_vessels_observed_deep,
	Total_trips_deep,
	obsv_trips_deep,
	ROUND(obsv_trips_deep*1.0/Total_trips_deep*100.0,2) as pct_trips_observed_deep,
	Total_fishingDays_deep,
	obsv_fishingDays_deep,
	ROUND(obsv_fishingDays_deep*1.0/Total_fishingDays_deep*100.0,2) as pct_FishingDays_observed_deep,
	Total_sets_deep,
	obsv_sets_deep,
	ROUND(obsv_sets_deep*1.0/Total_sets_deep*100.0,2) as pct_sets_observed_deep,
	Total_hks_deep,
	obsv_hks_deep,
	ROUND(obsv_hks_deep*1.0/Total_hks_deep*100.0,2) as pct_hks_observed_deep,
	bait.bait_deep
from
(
	Select year(set_date) yr,flag_id,
	COUNT(DISTINCT(case when hk_bt_flt<15 then ot.obstrip_id else NULL end)) as obsv_trips_shallow,
	COUNT(DISTINCT(case when hk_bt_flt>=15 then ot.obstrip_id else NULL end)) as obsv_trips_deep,
	COUNT(DISTINCT(case when hk_bt_flt<15 then ot.vessel_id else NULL end)) as obsv_vessels_shallow,
	COUNT(DISTINCT(case when hk_bt_flt>=15 then ot.vessel_id else NULL end)) as obsv_vessels_deep,
	COUNT(DISTINCT(case when hk_bt_flt<15 then cast(set_date as varchar(50))+cast(ot.vessel_id as varchar(50)) else NULL end)) as obsv_fishingDays_shallow,
	COUNT(DISTINCT(case when hk_bt_flt>=15 then cast(set_date as varchar(50))+cast(ot.vessel_id as varchar(50)) else NULL end)) as obsv_fishingDays_deep,
	COUNT(DISTINCT(case when hk_bt_flt<15 then s.l_set_id else NULL end)) as obsv_sets_shallow,
	COUNT(DISTINCT(case when hk_bt_flt>=15 then s.l_set_id else NULL end)) as obsv_sets_deep,
	SUM(case when hk_bt_flt<15 then coalesce(s.hook_observed,bask_observed*hk_bt_flt) else 0 end)/1000.0 as obsv_hks_shallow,
	SUM(case when hk_bt_flt>=15 then coalesce(s.hook_observed,bask_observed*hk_bt_flt) else 0 end)/1000.0 as obsv_hks_deep
	from obsv.trip ot 
	join obsv.l_set s on s.obstrip_id = ot.obstrip_id
	join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=1
	join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
	join ref.vessels ve on ve.vessel_id = vi.vessel_id
	where latd between -50 and 50 and lond between -150 and -80
	and ve.loa >=20
	group by year(set_date),flag_id) ob join 
(
	Select year(logdate) yr,flag_id,
	COUNT(DISTINCT(case when hk_bt_flt_n<15 then t.log_trip_id else NULL end)) as Total_trips_shallow,
	COUNT(DISTINCT(case when hk_bt_flt_n>=15 then t.log_trip_id else NULL end)) as Total_trips_deep,
	COUNT(DISTINCT(case when hk_bt_flt_n<15 then t.vessel_id else NULL end)) as Total_vessels_shallow,
	COUNT(DISTINCT(case when hk_bt_flt_n>=15 then t.vessel_id else NULL end)) as Total_vessels_deep,
	COUNT(DISTINCT(case when hk_bt_flt_n<15 then cast(logdate as varchar(50))+cast(t.vessel_id as varchar(50)) else NULL end)) as Total_fishingDays_shallow,
	COUNT(DISTINCT(case when hk_bt_flt_n>=15 then cast(logdate as varchar(50))+cast(t.vessel_id as varchar(50)) else NULL end)) as Total_fishingDays_deep,
	COUNT(DISTINCT(case when hk_bt_flt_n<15 then s.log_set_id else NULL end)) as Total_sets_shallow,
	COUNT(DISTINCT(case when hk_bt_flt_n>=15 then s.log_set_id else NULL end)) as Total_sets_deep,
	SUM(case when hk_bt_flt_n<15 then s.hooks_n else NULL end)/1000.0 as Total_hks_shallow,
	SUM(case when hk_bt_flt_n>=15 then s.hooks_n else NULL end)/1000.0 as Total_hks_deep
	from log.trips_ll t join log.sets_ll s on s.log_trip_id=t.log_trip_id
	join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
	join ref.vessels ve on ve.vessel_id = vi.vessel_id
	where latd between -50 and 50 and lond between -150 and -80
	and ve.loa >=20 and l_activity_id = 1
	group by year(logdate),flag_id) lo on ob.yr=lo.yr and ob.flag_id=lo.flag_id
join (
	select yr,flag_id,
	MAX(case when set_type='deep' and rn_type=1 then bait_code end) as bait_deep,
	MAX(case when set_type='shallow' and rn_type=1 then bait_code end) as bait_shallow,
        MAX(case when rn_total=1 then bait_code end) as bait_total
	from (
		select yr,flag_id,bait_code,set_type,SUM(bait_wt) as wt,ROW_NUMBER () over( partition by yr,flag_id,set_type order by SUM(bait_wt) desc) rn_type,ROW_NUMBER () over( partition by yr,flag_id order by SUM(bait_wt) desc) rn_total
		from(
			select year(set_date) yr,flag_id,bait1_sp_code as bait_code,isnull(bait1_w,0) as bait_wt, case when hk_bt_flt>=15 then 'deep' when hk_bt_flt<15 then 'shallow' end as set_type
			from obsv.trip ot 
			join obsv.l_set s on s.obstrip_id = ot.obstrip_id
			join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=1
			join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
			join ref.vessels ve on ve.vessel_id = vi.vessel_id
			where latd between -50 and 50 and lond between -150 and -80	and ve.loa >=20 and NULLIF(bait1_sp_code,'') is not null
			union all
			select year(set_date),flag_id,bait2_sp_code as bait_code,isnull(bait2_w,0) as bait_wt, case when hk_bt_flt>=15 then 'deep' when hk_bt_flt<15 then 'shallow' end as set_type
			from obsv.trip ot 
			join obsv.l_set s on s.obstrip_id = ot.obstrip_id
			join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=1
			join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
			join ref.vessels ve on ve.vessel_id = vi.vessel_id
			where latd between -50 and 50 and lond between -150 and -80	and ve.loa >=20  and NULLIF(bait2_sp_code,'') is not null
			union all
			select year(set_date),flag_id,bait3_sp_code as bait_code,isnull(bait3_w,0) as bait_wt, case when hk_bt_flt>=15 then 'deep' when hk_bt_flt<15 then 'shallow' end as set_type
			from obsv.trip ot 
			join obsv.l_set s on s.obstrip_id = ot.obstrip_id
			join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=1
			join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
			join ref.vessels ve on ve.vessel_id = vi.vessel_id
			where latd between -50 and 50 and lond between -150 and -80	and ve.loa >=20  and NULLIF(bait3_sp_code,'') is not null
		)  t
		group by yr,flag_id,bait_code,set_type
	) b
	group by yr,flag_id
	) bait on lo.yr=bait.yr and lo.flag_id=bait.flag_id
join 
(
	select yr,flag_id,case 
	when hkscircle >= hksj and hkscircle >= hksjapan and hkscircle >= hksoth then 'CIRCLE'
	when hksj >= hkscircle and hksj >= hksjapan and hksj >= hksoth then 'J'
	when hksjapan >= hksj and hksjapan >= hkscircle and hksjapan >= hksoth then 'JAPAN'
	when hksoth >= hksj and hksoth >= hksjapan and hksoth >= hkscircle then 'OTHER'
	end as hook_type
		from (
		select year(dep_date) yr,flag_id,sum(hook_observed*ISNULL(hkscircle_perc*1.0,0)) hkscircle,sum(hook_observed*ISNULL(hksjapan_perc*1.0,0)) hksjapan,sum(hook_observed*ISNULL(hksj_perc*1.0,0)) hksj,sum(hook_observed*ISNULL(hksoth_perc*1.0,0)) hksoth
		from obsv.trip ot 
		join obsv.l_gear g on g.obstrip_id=ot.obstrip_id
		join obsv.l_set s on s.obstrip_id = ot.obstrip_id
		join obsv.l_sethaullog sh on sh.l_set_id=s.l_set_id and stend_id=1
		join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
		join ref.vessels ve on ve.vessel_id = vi.vessel_id
		where latd between -50 and 50 and lond between -150 and -80	and ve.loa >=20 
		group by year(dep_date),flag_id) t
) hks on hks.flag_id = lo.flag_id and hks.yr = lo.yr

",NA
"410","f6bd7317-ec28-b32c-ae91-3a13661f0669","IATTC report Observer Annex A Table 1","flag_code, min_year","IATTC report Observer Annex A Table 1","Observer",NA,"Observer",NA,3537,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline","2025-05-13T15:18:40.53","select year(dep_date) yr,case when hk_bt_flt < 15 then 'Shadow' when hk_bt_flt >=15 then 'Deep' end as Set_Type,dbo.gpsConvertDecimalToDMS(min(latd),0) min_lat,dbo.gpsConvertDecimalToDMS(max(latd),0) max_lat,dbo.gpsConvertDecimalToDMS(min(lond),1) min_lon,dbo.gpsConvertDecimalToDMS(max(lond),1) max_lon 

FROM obsv.trip t     

join ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date 

join ref.vessels ve on ve.vessel_id = v.vessel_id 

join obsv.l_set s on t.obstrip_id = s.obstrip_id 

join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83 

WHERE year(dep_date) >= :min_year

and latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L' 

and ve.loa >=20 and hk_bt_flt is not null and flag_id=:flag_code

group by year(dep_date),case when hk_bt_flt < 15 then 'Shadow' when hk_bt_flt >=15 then 'Deep' end ",NA
"411","496badb5-db1d-10de-a9a9-3a133609e9e3","DUMP all catch and effort data","year","DUMP all catch and effort data","Artisanal",NA,NA,NA,3534,"brunod@spc.int","emmanuels@spc.int","Artisanal, AllSpecies","2025-02-11T10:28:33.983","SELECT	
	t.art_trip_id,
	e.art_effort_id,
	c.art_catch_id,
	YEAR(t.trip_date) trp_yr,
	MONTH(t.trip_date) trp_mn,
	DAY(t.trip_date) trp_dy,
	t.skipper_name,
	v.vessel_name,
	ref.GetTranslation('HullTypes',v.vessel_hull_type,'EN') vessel_hull_type,
	t.trip_date,
	t.return_date,
	t.depart_time,
	t.return_time,
	ls.landing_site_name,
	ref.GetTranslation('ArtisanalFishingMethods',e.fish_method_id,'EN') fish_method_id,
	e.hours_fished_n,
	a.art_area_name,
	r.region_name,
	f.fad_name,
	c.sp_code,
	s.sp_name,
	c.sp_n,
	c.sp_kg,
	JSON_VALUE(c.extensions,'$.NfdsFadMonitoring.SpeciesComment') species_comment,
	ref.GetTranslation('ArtisanalNonFishingTripReasons',t.non_fishing_trip_reason_id,'EN') non_fishing_reason
FROM	
	art2.trips t 
LEFT JOIN 
	art2.effort e ON t.art_trip_id = e.art_trip_id
LEFT JOIN 
	art2.vessels v ON v.vessel_id = t.vessel_id
LEFT JOIN
	art2.landing_sites ls ON ls.landing_site_id = t.landing_site_id
LEFT JOIN 
	art2.catch c ON e.art_effort_id = c.art_effort_id 
LEFT JOIN
	art2.areas a ON a.art_area_id = e.art_area_id
LEFT JOIN
	art2.regions r ON r.region_id = a.region_id
LEFT JOIN
	art2.fad_register f ON f.fad_register_id = e.fad_register_id
LEFT JOIN
	ref.species s ON s.sp_code = c.sp_code
WHERE
	YEAR(t.trip_date) = COALESCE(:year,t.trip_date)
",NA
"412","6636259c-3edb-23a4-7919-3a13a4e6f345","IATTC ANNEX B option 1 - Trip and vessels info","min_year, max_year",NA,"Observer",NA,"Observer",NA,3542,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline","2024-07-10T09:09:33.5","select 
v.vesselname,
V.flag_id AS vessel_flag,
v.regist_no,
v.ircs,
coalesce(t.vesowner,co.company_name) as vessel_owner,
vess_dep_date,
vp.port_name as vess_dep_port,
staff_code AS staff_code,
S.first_name + ' ' + S.family_name + ' - ' + S.staff_code AS name, 
P.obsprg_code AS observer_prog_code,
CONVERT(VARCHAR(10), T.dep_date, 103) AS obs_emb_date, 
CONVERT(VARCHAR(10), T.ret_date, 103) AS obs_disemb_date,
DP.port_name AS obs_emb_port, 
RP.port_name AS obs_disemb_port, 
t.well_capacity,
ve.loa,
ve.grt,
case when seawater_ans = 1 then 'yes' else 'no' end as seawater_ans,
case when blastfreezer_ans = 1 then 'yes' else 'no' end as blastfreezer_ans,
case when ice_ans = 1 then 'yes' else 'no' end as ice_ans,
case when chilledseawater_ans = 1 then 'yes' else 'no' end as chilledseawater_ans,
cast(Sum(case RTRIM(m.device_cat) when 'Radio' then 1 else 0.00 end) as INTEGER) as radio,
cast(Sum(case RTRIM(m.device_cat) when 'Depth Sounder' then 1 else 0.00 end) as INTEGER) as sounder,
cast(Sum(case RTRIM(m.device_cat) when 'GPS' then 1 else 0.00 end) as INTEGER) as gps,
cast(Sum(case RTRIM(m.device_cat) when 'Track Plotter' then 1 else 0.00 end) as INTEGER) as track,
cast(Sum(case RTRIM(m.device_cat) when 'Weather Facsimile' then 1 else 0.00 end) as INTEGER) as Weather_Facsimile,
cast(Sum(case RTRIM(m.device_cat) when 'Sea Surface Temperature Gauge' then 1 else 0.00 end) as INTEGER) as sst,
cast(Sum(case RTRIM(m.device_cat) when 'Sonar' then 1 else 0.00 end) as INTEGER) as sonar,
cast(Sum(case LEFT(m.device_cat,11) when 'Radio Buoys' then 1 else 0.00 end) as INTEGER) as Echo_Sounding_Buoy,
cast(Sum(case RTRIM(m.device_cat) when 'Doppler Current Meter' then 1 else 0.00 end) as INTEGER) as doppler,
cast(Sum(case RTRIM(m.device_cat) when 'Bathythermograph' then 1 else 0.00 end) as INTEGER) as XBT,
cast(Sum(case when RTRIM(m.device_cat) IN ('Satellite / HF Telex','Telephone / Facsimile') then 1 else 0.00 end) as INTEGER) as Satellite_Comm_Services,
cast(Sum(case RTRIM(m.device_cat) when 'Fishery Information Services' then 1 else 0.00 end) as INTEGER) as Fishery_Information_Services,            
cast(Sum(case RTRIM(m.device_cat) when 'VMS' then 1 else 0.00 end) as INTEGER) as FFA_VMS	
from obsv.trip t 
join (select distinct t.obstrip_id from obsv.trip t join obsv.l_set s on t.obstrip_id = s.obstrip_id 
	join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83 
	WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
	and latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L') iattc_fishing on iattc_fishing.obstrip_id=t.obstrip_id
join ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
join ref.vessels ve on ve.vessel_id = v.vessel_id
join obsv.vess_electronics_detail e on e.obstrip_id = t.obstrip_id
join ref_static.marine_devices m on m.device_id = e.device_id
LEFT JOIN ref.field_staff S ON S.staff_id = T.observer_id
LEFT JOIN ref.ports DP ON DP.port_id = T.dep_port_id
LEFT JOIN ref.ports RP ON RP.port_id = T.ret_port_id
LEFT JOIN ref.ports vp ON vp.port_id = t.vess_dep_port_id
left join ref.companies co on co.company_id = t.company_id
JOIN ref_static.obsv_programs AS P ON T.obsprg_code = P.obsprg_code
left join [obsv].[l_gear] g on g.obstrip_id = t.obstrip_id
where
		YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
group by
v.vesselname,
V.flag_id ,
v.regist_no,
v.ircs,
coalesce(t.vesowner,co.company_name) ,
vess_dep_date,
vp.port_name ,
staff_code ,
S.first_name + ' ' + S.family_name + ' - ' + S.staff_code , 
P.obsprg_code ,
CONVERT(VARCHAR(10), T.dep_date, 103) , 
CONVERT(VARCHAR(10), T.ret_date, 103) ,
DP.port_name, 
RP.port_name, 
t.well_capacity,
ve.loa,
ve.grt,
case when seawater_ans = 1 then 'yes' else 'no' end,
case when blastfreezer_ans = 1 then 'yes' else 'no' end,
case when ice_ans = 1 then 'yes' else 'no' end,
case when chilledseawater_ans = 1 then 'yes' else 'no' end",NA
"413","36510511-ff69-afd7-d42d-3a13a4f896c2","IATTC ANNEX B option 1 - Landed SSI","flag_code, year",NA,"Observer",NA,"Observer",NA,3543,"aurelienp@spc.int","aurelienp@spc.int","Observer, Longline","2024-07-10T10:42:23.68","Select vesselname,flag_id,dep_date,set_number,set_date,latd,lond,sc.sp_code,fate_code,cond_code as cond_catch,cond_code2 as cond_discard,len,sc.len_code,sex_code
from obsv.trip ot 
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
join obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 83
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
join ref.species sp on sp.sp_code = sc.sp_code
left join ref_static.LL_gear_interact_codes g on g.gr_interact_code=sc.gr_interact_code
where latd between -50 and 50 and lond between -150 and -80 and sp_cat_code in ('MAM','TTX','BRD','SHK')
and year(dep_date) = coalesce(:year,year(dep_date))
and flag_id = coalesce(:flag_code,flag_id)",NA
"414","b38ef35a-078c-4114-00da-3a13ac500d3a","IATTC ANNEX B option 1 - General Gear Characteristics","flag_code, min_year, max_year",NA,"Observer",NA,"Observer",NA,3548,"colleyf@spc.int","colleyf@spc.int","Observer, Longline","2024-07-10T11:55:28.92","SELECT 
        t.tripno as tripno ,
		v.vesselname as vesselname,
	    v.flag_id as flag_id,
	    v.regist_no as regist_no,
        v.ircs as ircs,
	    CONVERT(VARCHAR(10), t.dep_date, 103) AS depart_date,
	    CONVERT(VARCHAR(10), t.ret_date, 103) AS return_date,
		(SELECT count(s1.set_number)
		 FROM obsv.l_set s1
		 INNER JOIN obsv.trip t1 ON s1.obstrip_id = t1.obstrip_id
		 WHERE t1.obstrip_id = t.obstrip_id) AS trip_no_sets,
		(SELECT sum(s1.hook_set)
		 FROM obsv.l_set s1
		 INNER JOIN obsv.trip t1 ON s1.obstrip_id = t1.obstrip_id
		 WHERE t1.obstrip_id = t.obstrip_id) AS trip_total_hooks,
		g.mlinehaul_ans as mlinehaul_ans,
		g.blinehaul_ans as blinehaul_ans,
		g.lshoot_ans as lshoot_ans,
		g.baitthr_ans as baitthr_ans,
		g.branchatt_ans as branchatt_ans,
		g.weightsca_ans as weightsca_ans,
		g.mline_mat as mainline_material,
		g.mline_len as mainline_length,
                g.mline_diam as mainline_diameter,
		(coalesce(g.bline_mat1, '') + ' ' + coalesce(g.bline_mat2, '') + ' ' + coalesce(g.bline_mat3, '')) as brnachline_material,
		coalesce(g.hkscircle_perc, 0) as circlehook_perc,
		coalesce(g.hkscircle_size,'-') as circlehook_size,
		coalesce(g.hksj_perc,0) as jhook_perc,
		coalesce(g.hksj_size,'-') as jhook_size,
		coalesce(g.hksjapan_perc,0) as japhook_perc,
		coalesce(g.hksjapan_size,'-') as japhook_size,
		coalesce(g.hksoth_perc,0) as othhook_perc,
		coalesce(g.hksoth_size,'-') as othhook_size,
		coalesce(g.bline_has_weights,'-') as bline_has_weights,
                coalesce(g.bline_weight,0) as bline_weight,
		coalesce(g.bline_weighthook_dist,0) as bline_weighthook_dist,
		coalesce(g.wiretrace_ans,0) as wiretrace_ans
FROM obsv.trip t 
INNER JOIN (SELECT DISTINCT t.obstrip_id 
                 FROM obsv.trip t join obsv.l_set s on t.obstrip_id = s.obstrip_id 
	             INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id=83 
	             WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
	             AND latd between -50 and 50 and lond between -150 and -80 and t.gear_code='L') iattc_fishing on iattc_fishing.obstrip_id=t.obstrip_id
INNER JOIN ref.vessel_instances v on t.vessel_id = v.vessel_id and t.dep_date between v.start_date and v.calculated_end_date
INNER JOIN obsv.l_gear g on g.obstrip_id = t.obstrip_id
WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
AND v.flag_id = coalesce(:flag_code,flag_id)",NA
"415","bc9eb101-50fd-4e48-e043-3a13ac585f81","IATTC ANNEX B option 1  - Special Gear Characteristics","flag_code, min_year, max_year",NA,"Observer",NA,"Observer",NA,3549,"colleyf@spc.int","colleyf@spc.int","Observer, Longline","2024-07-10T12:08:46.967","SELECT 
                ot.tripno as tripno ,
		vi.vesselname as vesselname,
                vi.flag_id as flag_id,
	        vi.regist_no as regist_no,
                vi.ircs as ircs,
	        CONVERT(VARCHAR(10), ot.dep_date, 103) AS depart_date,
	        CONVERT(VARCHAR(10), ot.ret_date, 103) AS return_date,
		s.set_number as set_number,
		s.set_dtime as set_start_datetime,
		(SELECT sh1.log_dtime
		  FROM obsv.l_sethaullog sh1
		  INNER JOIN obsv.l_set s1 ON sh1.l_set_id = s1.l_set_id and sh1.stend_id = 84
		  WHERE s1.l_set_id = s.l_set_id) AS set_end_datetime,
		sh.latd as set_start_latd,
		sh.lond as set_srart_lond,
		(SELECT sh1.latd
		  FROM obsv.l_sethaullog sh1
		  INNER JOIN obsv.l_set s1 ON sh1.l_set_id = s1.l_set_id and sh1.stend_id = 84
		  WHERE s1.l_set_id = s.l_set_id) AS latd_end,
		(SELECT sh1.lond
		  FROM obsv.l_sethaullog sh1
		  INNER JOIN obsv.l_set s1 ON sh1.l_set_id = s1.l_set_id and sh1.stend_id = 84
		  WHERE s1.l_set_id = s.l_set_id) AS lond_end,
		 (SELECT sh1.log_dtime
		  FROM obsv.l_sethaullog sh1
		  INNER JOIN obsv.l_set s1 ON sh1.l_set_id = s1.l_set_id and sh1.stend_id = 85
		  WHERE s1.l_set_id = s.l_set_id) AS haul_start_datetime,
		(SELECT sh1.log_dtime
		 FROM obsv.l_sethaullog sh1
		 INNER JOIN obsv.l_set s1 ON sh1.l_set_id = s1.l_set_id and sh1.stend_id = 86
		 WHERE s1.l_set_id = s.l_set_id) AS haul_end_datetime,
		coalesce(s.bask_set,0) as bask_set,
		coalesce(s.hk_bt_flt,0) as hk_bt_flt,
		coalesce(s.hook_set,0) as hook_set,
		coalesce(s.bask_observed,0) as bask_observed,
		coalesce(s.lspeed,0) as lspeed,
		coalesce(s.float_length,0) as float_length,
		coalesce(s.branch_dist,0) as branch_dist,
		coalesce(s.branch_length,0) as branch_length,
		coalesce(s.tdr_deployed_ans,0) as tdr_ans,
		coalesce(s.lightsticks,0) as lightsticks,
		coalesce(s.target_tun_yn,0) as target_tun_yn,
                coalesce(s.target_swo_yn,0) as target_swo_yn,
		coalesce(s.target_skh_yn,0) as target_skh_yn,
		coalesce(s.bait1_sp_code,'-') as bait1_sp_code,
		coalesce(s.bait2_sp_code,'-') as bait2_sp_code,
		coalesce(s.bait3_sp_code,'-') as bait3_sp_code,
		coalesce(s.bait4_sp_code,'-') as bait4_sp_code,
		coalesce(s.bait5_sp_code,'-') as bait5_sp_code,
		coalesce(s.tori_poles_yn,0) as tori_poles_yn,
		coalesce(s.num_tori_lines,0) as num_tori_lines,
		coalesce(s.hook99_n,0) as shark_line_num,
		coalesce(s.hook99_length,0) as shark_line_len,
		coalesce(s.bait1_dyed_ans,0) as bait1_dyed_ans,
		coalesce(s.bait2_dyed_ans,0) as bait2_dyed_ans,
		coalesce(s.bait3_dyed_ans,0) as bait3_dyed_ans,
		coalesce(s.bait4_dyed_ans,0) as bait4_dyed_ans,
		coalesce(s.bait5_dyed_ans,0) as bait5_dyed_ans,
		coalesce(s.offal_discharged_yn,0) as offal_discharged_yn,
		coalesce(s.offal_opposite_yn,0) as offal_opposite_yn
FROM obsv.trip ot 
INNER JOIN ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN obsv.l_set s on s.obstrip_id = ot.obstrip_id
INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 83
WHERE latd between -50 and 50 and lond between -150 and -80 
AND YEAR(ot.dep_date) >= coalesce(:min_year,year(ot.dep_date)) and YEAR(ot.dep_date) <= coalesce(:max_year,year(ot.dep_date))
AND ot.gear_code = 'L'
AND vi.flag_id = coalesce(:flag_code,flag_id)
",NA
"416","f6577c13-3c52-c4bf-a2a2-3a1515a3214a","PURSE SEINE - Logsheet Coverage for all/each NF vessel","year","Coverage calculation in number of days/sets and number of trips, between VMS and logbook data - for the National Fleet","Logsheets,VMS",NA,"Live",NA,3557,"emmanuels@spc.int","emmanuels@spc.int","Logsheet, Purseseine, CoverageMissingData","2024-11-14T12:28:45.757","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT distinct t.vms_trip_id
    FROM  log.trips_ps l INNER JOIN ref.vessel_instances vi ON l.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips t ON t.vessel_id = vi.vessel_id AND (
          (l.depart_date BETWEEN DATEADD(day,-4,t.departure_date) AND DATEADD(day,4,t.departure_date) AND l.return_date BETWEEN DATEADD(day,-4,t.return_date) and DATEADD(day,4,t.return_date))
          OR          DATEDIFF(day,t.departure_date,l.FIRST_LOGDATE)>=0 AND DATEDIFF(day,l.FIRST_LOGDATE,t.return_date)>=1
          OR          DATEDIFF(day,t.departure_date,l.last_LOGDATE)>1 AND DATEDIFF(day,l.last_LOGDATE,t.return_date)>=0
          OR          t.departure_date>l.FIRST_LOGDATE AND t.return_date<l.last_logdate
    )
) t

SELECT  eez.year, vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs, 
		SUM(eez.day_fishing) day_fishing, COUNT(DISTINCT t.vms_trip_id) trips 
		into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT #mapped_trip.vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND    COALESCE(:year, eez.year)=eez.year
AND    (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND	ve.gear='S'
GROUP BY eez.year, vi.flag_id, vi.vessel_id, vi.vesselname, vi.ircs

SELECT 
		YEAR(s.logdate) year, vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs,
		COUNT(DISTINCT s.log_set_id) nb_days,
		COUNT(DISTINCT t.log_trip_id) nb_trips 
		INTO #effort
FROM	log.trips_ps t INNER JOIN log.sets_ps s ON t.log_trip_id=s.log_trip_id 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(logdate))=YEAR(logdate)
AND	s_activity_id = 1
AND       (@@entity = 'HIVE' OR vi.flag_id = @@entity)
GROUP BY YEAR(s.logdate), vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs

SELECT
	COALESCE(mt.year, e.year) year,
	COALESCE(mt.vessel_id, e.vessel_id) as vessel_id,
	COALESCE(mt.flag_id, e.flag_id) flag_id, 
	COALESCE(mt.vesselname, e.vesselname) vessel,
	COALESCE(mt.ircs, e.ircs) ircs,
	CONVERT(DECIMAL(10,2),COALESCE(nb_days,0)*100/(COALESCE(day_fishing,0)+COALESCE(nb_days,0))) cov,
	COALESCE(nb_days,0) log_days,
	COALESCE(nb_trips,0) log_trips,
	CONVERT(INT,COALESCE(day_fishing,0)) missing_days,
	COALESCE(trips,0) missing_trips,
	CONVERT(INT,COALESCE(day_fishing,0)+COALESCE(nb_days,0)) total_days,
	COALESCE(trips,0)+COALESCE(e.nb_trips,0) total_trips
FROM #effort e FULL OUTER JOIN #missing_trip mt ON mt.flag_id = e.flag_id AND mt.year = e.year and mt.vessel_id = e.vessel_id

",NA
"417","57ca1e46-52b3-4a85-b329-3a1515b24b90","PURSE SEINE - Observer Coverage for all/each NF vessel","year","Coverage calculation in number of days/sets and number of trips, between VMS and observer data - for the National Fleet","Observer,VMS",NA,"Live",NA,3558,"emmanuels@spc.int","emmanuels@spc.int","Observer, Purseseine, CoverageMissingData","2025-01-08T13:50:09.617","SELECT vms_trip_id INTO #mapped_trip FROM (
    SELECT distinct vt.vms_trip_id
    FROM  obsv.trip t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id
    INNER JOIN vms.vms_trips vt ON vt.vessel_id = vi.vessel_id AND (
          (t.dep_date BETWEEN DATEADD(day,-4,vt.departure_date) AND DATEADD(day,4,vt.departure_date) AND t.ret_date BETWEEN DATEADD(day,-4,vt.return_date) and DATEADD(day,4,vt.return_date))
          OR          DATEDIFF(day,vt.departure_date,t.dep_date)>=0 AND DATEDIFF(day,t.dep_date,vt.return_date)>=1
          OR          DATEDIFF(day,vt.departure_date,t.ret_date)>1 AND DATEDIFF(day,t.ret_date,vt.return_date)>=0
          OR          vt.departure_date>t.dep_date AND vt.return_date < t.ret_date
    )
) t

SELECT  eez.year, vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs, 
		SUM(eez.day_fishing) day_fishing, COUNT(DISTINCT t.vms_trip_id) trips 
		into #missing_trip
FROM	vms.vms_trips t INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
        INNER JOIN vms.vms_trip_efforts eez ON t.vms_trip_id=eez.vms_trip_id
WHERE	t.vms_trip_id NOT IN (SELECT #mapped_trip.vms_trip_id from #mapped_trip)
AND     DATEDIFF(DAY, t.departure_date,t.return_date)>5
AND     day_fishing>1
AND    COALESCE(:year, eez.year)=eez.year
AND    (@@entity = 'HIVE' OR vi.flag_id = @@entity)
AND		ve.gear='S'
GROUP BY eez.year, vi.flag_id, vi.vessel_id, vi.vesselname, vi.ircs

SELECT 
		YEAR(sdl.act_date) year, vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs,
		COUNT(DISTINCT sdl.s_day_id) nb_days,
		COUNT(DISTINCT t.obstrip_id) nb_trips 
		INTO #effort
FROM	obsv.trip t 
		INNER JOIN obsv.s_day sd on t.obstrip_id = sd.obstrip_id
		INNER JOIN obsv.s_daylog sdl on sd.s_day_id = sdl.s_day_id
		INNER JOIN ref.vessels ve ON t.vessel_id = ve.vessel_id
		INNER JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE	COALESCE(:year, YEAR(sdl.act_date))=YEAR(sdl.act_date)
AND	s_activ_id = 1
AND    (@@entity = 'HIVE' OR vi.flag_id = @@entity)
GROUP BY YEAR(sdl.act_date), vi.vessel_id, vi.vesselname, vi.flag_id, vi.ircs

SELECT
	COALESCE(mt.year, e.year) year,
	COALESCE(mt.vessel_id, e.vessel_id) as vessel_id,
	COALESCE(mt.flag_id, e.flag_id) flag_id, 
	COALESCE(mt.vesselname, e.vesselname) vessel,
	COALESCE(mt.ircs, e.ircs) ircs,
	CONVERT(DECIMAL(10,2),COALESCE(nb_days,0)*100/(COALESCE(day_fishing,0)+COALESCE(nb_days,0))) cov,
	COALESCE(nb_days,0) obs_days,
	COALESCE(nb_trips,0) obs_trips,
	CONVERT(INT,COALESCE(day_fishing,0)) missing_days,
	COALESCE(trips,0) missing_trips,
	CONVERT(INT,COALESCE(day_fishing,0)+COALESCE(nb_days,0)) total_days,
	COALESCE(trips,0)+COALESCE(e.nb_trips,0) total_trips
FROM #effort e FULL OUTER JOIN #missing_trip mt ON mt.flag_id = e.flag_id AND mt.year = e.year and mt.vessel_id = e.vessel_id

",NA
"418","914e8ba1-ede4-f052-f3d1-3a16dfe3ddb0","OLLO Observer CATCH Statistics","year, trip_id","OLLO Observer CATCH Statistics","Observer",NA,"Observer",NA,3565,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-01-20T07:51:16.51","SELECT 	
        ot.obstrip_id, obsprg_code,vesselname, v.flag_id,staff_code,'T'+tripno as tripno, 
        ot.dep_date,
        case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end as species_category,
		sp.sp_name as species,
		sum(1) as catch_n,
		SUM(1) / MAX(n) as sp_comp,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		SUM(0001.000) / MAX(hooks) * 1000 as CPUE,
		COUNT(distinct lc.l_set_id) / max(SETS) as freq,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Disc_perc,
		SUM(case when left(COALESCE(cond_code,cond_code2),1) = 'A' then 0001 else 0000 end)  / SUM(1.000) as alive_perc,
		SUM(case when left(COALESCE(cond_code,cond_code2),1) = 'D' then 0001 else 0000 end) / SUM(1.000) as dead_perc,
		SUM(case when sex_code = 'M' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as male_perc,
		SUM(case when sex_code = 'F' then 0001 else 0000 end)  / SUM(case when sex_code IN ('M','F') then 0001 else 0000.00000000001 end) as female_perc
 FROM	obsv.trip ot 
			inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
			inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
			inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
			inner join ref.species sp on lc.sp_code = sp.sp_code
			inner join ref.field_staff f on f.staff_id=ot.observer_id
			inner join (SELECT SUM(1)*1.000 as n,
								count(distinct ls.l_set_id)*1.000 as sets
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join	obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
								inner join ref.field_staff f on f.staff_id=ot.observer_id
						
						    WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
                            AND ot.system_source = 'Ollo'
							
							) tmp on tmp.n > 0		
			inner join (SELECT SUM(coalesce(hook_set,0000.000)) as hooks
						FROM obsv.trip ot 
								inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
								inner join	obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
								inner join ref.field_staff f on f.staff_id=ot.observer_id						
						WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
                        AND ot.system_source = 'Ollo'				
							) tmp2 on tmp2.hooks > 0		

WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
AND ot.system_source = 'Ollo'

GROUP BY  
		case when sp.sp_cat_code = '   ' then 'OTHER FISH' else coalesce(sp.sp_cat_code,'OTHER FISH') end,
		sp.sp_name,
		ot.obstrip_id, obsprg_code,vesselname, v.flag_id, staff_code,tripno,ot.dep_date",NA
"419","4290afa2-1e60-3d7b-4d4d-3a16e4321a27","OLLO TRIP Summary Table","year, trip_id","OLLO Trip Summary Table","Observer",NA,"Observer",NA,3566,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-02-17T13:20:59.06","
SELECT x.obstrip_id, x.obsprg_code, x.vesselname, x.flag_id, x.staff_code, x.tripno, x.dep_date, x.sea_days, MAX(x.set_number) as no_of_sets,
       AVG(x.set_time_hrs) as avg_set_time, 
       AVG(x.soak_time_hrs) as avg_soak_time, AVG(x.haul_time_hrs) as avg_haul_time, 
	   MIN(x.hook_set) as min_hks_set, AVG(x.hook_set) as avg_hks_set, MAX(x.hook_set) as max_hks_set,
	   MIN(x.hk_bt_flt) as min_hk_bt_flt, AVG(x.hk_bt_flt) as avg_hk_bt_flt, MAX(x.hk_bt_flt) as max_hk_bt_flt,
	   MIN(x.bask_set) as min_bask_set, AVG(x.bask_set) as avg_bask_set, MAX(x.bask_set) as max_bask_set,
	   MIN(x.branch_dist) as min_branch_dist, AVG(x.branch_dist) as avg_branch_dist, MAX(x.branch_dist) as max_branch_dist,
	   MIN(x.float_length) as min_float_length, AVG(x.float_length) as avg_float_length, MAX(x.float_length) as max_float_length,
	   MIN(x.vessel_speed) as min_vessel_speed, AVG(x.vessel_speed) as avg_vessel_speed, MAX(x.vessel_speed) as max_vessel_speed,
	   MIN(x.lspeed) as min_lspeed, AVG(x.lspeed) as avg_lspeed, MAX(x.lspeed) as max_lspeed,
	   MIN(x.branch_intvl) as min_branch_intvl, AVG(x.branch_intvl) as avg_branch_intvl, MAX(x.branch_intvl) as max_branch_intvl
FROM (
Select ot.obstrip_id, obsprg_code,vesselname, v.flag_id, staff_code,'T'+tripno as tripno, 
ot.dep_date,ot.ret_date,DATEDIFF(DAY,ot.dep_date, ot.ret_date)+1 AS sea_days,
set_number, set_date,
CONVERT(varchar,h1.log_dtime,108) as start_set_time,
CONVERT(varchar,h2.log_dtime,108) as end_set_time,
CONVERT(varchar,h3.log_dtime,108) as start_haul_time,
CONVERT(varchar,h4.log_dtime,108) as end_haul_time,
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108) as Setting_duration,
DATEDIFF(HOUR,MAX(case h1.stend_id  when 83 then h1.log_dtime else 0 end),MAX(case h2.stend_id when 84 then h2.log_dtime else 0 end)) as set_time_hrs,
DATEDIFF(HOUR,MAX(case h2.stend_id  when 84 then h2.log_dtime else 0 end),MAX(case h3.stend_id  when 85 then h3.log_dtime else 0 end)) as soak_time_hrs,
DATEDIFF(HOUR,MAX(case h3.stend_id  when 85 then h3.log_dtime else 0 end),MAX(case h4.stend_id  when 86 then h4.log_dtime else 0 end)) as haul_time_hrs,
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108) as Haulling_duration,
hook_set,hook_observed,lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0) as bait_wt,
coalesce(bait1_sp_code,'--') as bait1_sp_code,
coalesce(bait2_sp_code,'--') as bait2_sp_code,
CASE WHEN target_tun_yn = 1 THEN 'Y' ELSE 'N' END as target_tun_yn,
CASE WHEN target_swo_yn = 1 THEN 'Y' ELSE 'N' END as target_swo_yn,
CASE WHEN target_skh_yn = 1 THEN 'Y' ELSE 'N' END as target_shk_yn,
h1.latd as start_latd, 
h1.lond as start_lond, 
hk_bt_flt,
bask_set,
mline_len,
lightsticks,
CASE WHEN hook_set IS NULL THEN 'N' ELSE 'Y' END as is_monitored
FROM obsv.trip ot 
join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
Join obsv.l_sethaullog h1 on h1.l_set_id = s.l_set_id and h1.stend_id=83
left Join obsv.l_sethaullog h2 on h2.l_set_id = s.l_set_id and h2.stend_id=84
left Join obsv.l_sethaullog h3 on h3.l_set_id = s.l_set_id and h3.stend_id=85
left Join obsv.l_sethaullog h4 on h4.l_set_id = s.l_set_id and h4.stend_id=86
left join obsv.l_gear g on g.obstrip_id = ot.obstrip_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(ot.dep_date) = coalesce(:year, YEAR(ot.dep_date))
AND ot.system_source = 'Ollo'
GROUP BY ot.obstrip_id, vesselname, v.flag_id, staff_code,tripno,
ot.dep_date,
ot.ret_date,
set_number,set_date,hook_set,lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0),cast(h1.log_dtime as time(0)),
CONVERT(varchar,h1.log_dtime,108),
CONVERT(varchar,h2.log_dtime,108),
CONVERT(varchar,h3.log_dtime,108),
CONVERT(varchar,h4.log_dtime,108),
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108),
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108),
hk_bt_flt,
bask_set,
h1.latd, 
h1.lond,
mline_len,
hook_observed,
obsprg_code,
lightsticks,
bait1_sp_code,
bait2_sp_code,
target_tun_yn,
target_swo_yn,
target_skh_yn
) x
GROUP BY x.obstrip_id, x.obsprg_code,  x.vesselname, x.flag_id, x.staff_code,x.tripno, x.dep_date, x.sea_days",NA
"420","25bb1abc-3219-6f0d-e8d8-3a16e4420529","OLLO SET Summary Table","year, trip_id","OLLO SET Summary Table","Observer",NA,"Observer",NA,3567,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-06-07T11:59:39.527","Select ot.obstrip_id, obsprg_code,vesselname,v.flag_id,staff_code,'T'+tripno as tripno, ot.dep_date,set_number, set_date,
CONVERT(varchar,h1.log_dtime,108) as start_set_time,
CONVERT(varchar,h2.log_dtime,108) as end_set_time,
CONVERT(varchar,h3.log_dtime,108) as start_haul_time,
CONVERT(varchar,h4.log_dtime,108) as end_haul_time,
DATEDIFF(HOUR,MAX(case h1.stend_id  when 83 then h1.log_dtime else 0 end),MAX(case h2.stend_id when 84 then h2.log_dtime else 0 end)) as set_time_hrs,
DATEDIFF(HOUR,MAX(case h2.stend_id  when 84 then h2.log_dtime else 0 end),MAX(case h3.stend_id  when 85 then h3.log_dtime else 0 end)) as soak_time_hrs,
DATEDIFF(HOUR,MAX(case h3.stend_id  when 85 then h3.log_dtime else 0 end),MAX(case h4.stend_id  when 86 then h4.log_dtime else 0 end)) as haul_time_hrs,
hook_set,
hk_bt_flt,
bask_set,
hook_observed,
lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0) as bait_wt,
coalesce(bait1_sp_code,'--') as bait1_sp_code,
coalesce(bait2_sp_code,'--') as bait2_sp_code,
CASE WHEN target_tun_yn = 1 THEN 'Y' ELSE 'N' END as target_tun_yn,
CASE WHEN target_swo_yn = 1 THEN 'Y' ELSE 'N' END as target_swo_yn,
CASE WHEN target_skh_yn = 1 THEN 'Y' ELSE 'N' END as target_shk_yn,
h1.latd as start_latd, 
h1.lond as start_lond, 
mline_len,
lightsticks,
CASE WHEN hook_set IS NULL THEN 'N' ELSE 'Y' END as is_monitored
FROM obsv.trip ot 
join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
Join obsv.l_sethaullog h1 on h1.l_set_id = s.l_set_id and h1.stend_id=83
left Join obsv.l_sethaullog h2 on h2.l_set_id = s.l_set_id and h2.stend_id=84
left Join obsv.l_sethaullog h3 on h3.l_set_id = s.l_set_id and h3.stend_id=85
left Join obsv.l_sethaullog h4 on h4.l_set_id = s.l_set_id and h4.stend_id=86
left join obsv.l_gear g on g.obstrip_id = ot.obstrip_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(ot.dep_date) = coalesce(:year, YEAR(ot.dep_date))
AND ot.system_source = 'Ollo'
GROUP BY ot.obstrip_id, vesselname, v.flag_id, staff_code,tripno,
ot.dep_date,
ot.ret_date,
set_number,set_date,hook_set,lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0),cast(h1.log_dtime as time(0)),
CONVERT(varchar,h1.log_dtime,108),
CONVERT(varchar,h2.log_dtime,108),
CONVERT(varchar,h3.log_dtime,108),
CONVERT(varchar,h4.log_dtime,108),
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108),
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108),
hk_bt_flt,
bask_set,
h1.latd, 
h1.lond,
mline_len,
hook_observed,
obsprg_code,
lightsticks,
bait1_sp_code,
bait2_sp_code,
target_tun_yn,
target_swo_yn,
target_skh_yn",NA
"421","8859ac12-97dd-7e06-3b75-3a16974d090a","LONGLINE - Crew Details","flag_code, min_year, max_year","LONGLINE - Crew Details","Observer",NA,"Observer",NA,3563,"colleyf@spc.int","colleyf@spc.int","Observer, Longline","2024-12-04T12:48:12.477","SELECT DISTINCT
t.gear_code as gear_code,
YEAR(t.dep_date) as yr,
v.flag_id as flag,
coalesce(VC.country_code,'NA') as country_code,
C.country_name as country_name,
	(SELECT coalesce(sum(c.crewcount),0) 
	 FROM obsv.vess_crew c
	 INNER JOIN obsv.trip st ON c.obstrip_id=st.obstrip_id
	 WHERE st.obstrip_id = t.obstrip_id) as tot_nbr
FROM obsv.trip t 
	INNER JOIN ref.vessel_instances v on t.vessel_id = v.vessel_id AND t.dep_date BETWEEN v.start_date AND v.calculated_end_date
	LEFT JOIN ref.vessel_staff AS VC ON T.captain_id = VC.vessel_staff_id
	LEFT JOIN ref.vessel_staff AS VM ON T.master_id = VM.vessel_staff_id
	INNER JOIN ref.countries AS C ON VC.country_code = C.country_code
WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
AND v.flag_id = coalesce(:flag_code,flag_id)
AND t.gear_code = 'L'
AND (SELECT coalesce(sum(c.crewcount),0) 
	 FROM obsv.vess_crew c
	 INNER JOIN obsv.trip st ON c.obstrip_id=st.obstrip_id
	 WHERE st.obstrip_id = t.obstrip_id) <> 0",NA
"422","cf4c45f5-f37a-46df-de93-3a16dfbd6f2d","OLLO Observer Trip -- Set/Haul Summary","year, trip_id","A Summary of SETTING and HAULING information from the selected OLLO observer trip","Observer",NA,"Observer",NA,3564,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-11-05T07:13:56.427","Select ot.obstrip_id, obsprg_code,vesselname,v.flag_id,staff_code,'T'+tripno as tripno, 
ot.dep_date,ot.ret_date,DATEDIFF(DAY,ot.dep_date, ot.ret_date)+1 AS sea_days,
set_number, set_date,hook_set,hook_observed,lspeed,branch_length,branch_intvl branch_intvl_s,branch_dist branch_dist_m,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0) as bait_wt,
coalesce(bait1_sp_code,'--') as bait1_sp_code,
coalesce(bait2_sp_code,'--') as bait2_sp_code,
CASE WHEN target_tun_yn = 1 THEN 'Y' ELSE 'N' END as target_tun_yn,
CASE WHEN target_swo_yn = 1 THEN 'Y' ELSE 'N' END as target_swo_yn,
CASE WHEN target_skh_yn = 1 THEN 'Y' ELSE 'N' END as target_shk_yn,
h1.latd as start_latd, 
h1.lond as start_lond, 
CONVERT(varchar,h1.log_dtime,108) as start_set_time,
CONVERT(varchar,h2.log_dtime,108) as end_set_time,
CONVERT(varchar,h3.log_dtime,108) as start_haul_time,
CONVERT(varchar,h4.log_dtime,108) as end_haul_time,
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108) as Setting_duration,
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108) as Haulling_duration,
count(l_setcatch_id) as catch_n,
hk_bt_flt,
bask_set,
mline_len,
lightsticks
FROM obsv.trip ot 
join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.l_set s on s.obstrip_id = ot.obstrip_id
Join obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
Join obsv.l_sethaullog h1 on h1.l_set_id = s.l_set_id and h1.stend_id=83
left Join obsv.l_sethaullog h2 on h2.l_set_id = s.l_set_id and h2.stend_id=84
left Join obsv.l_sethaullog h3 on h3.l_set_id = s.l_set_id and h3.stend_id=85
left Join obsv.l_sethaullog h4 on h4.l_set_id = s.l_set_id and h4.stend_id=86
join ref.species sp on sc.sp_code = sp.sp_code
left join obsv.l_gear g on g.obstrip_id = ot.obstrip_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
AND ot.system_source = 'Ollo'
GROUP BY ot.obstrip_id, vesselname, v.flag_id, staff_code,tripno,ot.dep_date,ot.ret_date,
set_number,set_date,hook_set,lspeed,branch_length,branch_intvl,branch_dist,float_length,vessel_speed,ISNULL(bait1_w,0)+ISNULL(bait2_w,0)+ISNULL(bait3_w,0),cast(h1.log_dtime as time(0)),
CONVERT(varchar,h1.log_dtime,108),
CONVERT(varchar,h2.log_dtime,108),
CONVERT(varchar,h3.log_dtime,108),
CONVERT(varchar,h4.log_dtime,108),
CONVERT(varchar,h2.log_dtime-h1.log_dtime,108),
CONVERT(varchar,h4.log_dtime-h3.log_dtime,108),
hk_bt_flt,
bask_set,
h1.latd, 
h1.lond,
mline_len,
hook_observed,
obsprg_code,
lightsticks,
bait1_sp_code,
bait2_sp_code,
target_tun_yn,
target_swo_yn,
target_skh_yn",NA
"423","f9bf4d9e-d8e9-ac05-bf51-3a16e8e385ee","OLLO GEN-3 Summary","year, trip_id","OLLO GEN-3 Summary","Observer",NA,"Observer",NA,3570,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-10-16T11:54:07.973","SELECT 
       a.obstrip_id, a.obsprg_code, a.vesselname, a.flag_id, a.staff_code, tripno as tripno,a.dep_date,
       SUM(a.RS_A) AS RS_A,
       SUM(a.RS_B) AS RS_B,
       SUM(a.RS_C) AS RS_C,
       SUM(a.RS_D) AS RS_D,
       SUM(a.NR_A) AS NR_A,
       SUM(a.NR_B) AS NR_B,
       SUM(a.NR_C) AS NR_C,
       SUM(a.NR_D) AS NR_D,
       SUM(a.NR_E) AS NR_E,
       SUM(a.NR_F) AS NR_F,
       SUM(a.NR_G) AS NR_G,
       SUM(a.WC_A) AS WC_A,
       SUM(a.WC_B) AS WC_B,
       SUM(a.WC_C) AS WC_C,
       SUM(a.LP_A) AS LP_A,
       SUM(a.LP_B) AS LP_B,
       SUM(a.LC_A) AS LC_A,
       SUM(a.LC_B) AS LC_B,
       SUM(a.LC_C) AS LC_C,
       SUM(a.LC_D) AS LC_D,
       SUM(a.LC_E) AS LC_E,
       SUM(a.LC_F) AS LC_F,
       SUM(a.SI_A) AS SI_A,
       SUM(a.SI_B) AS SI_B,
       SUM(a.PN_A) AS PN_A,
       SUM(a.PN_B) AS PN_B,
       SUM(a.PN_C) AS PN_C,
       SUM(a.PN_D) AS PN_D,
       SUM(a.PN_E) AS PN_E,
       SUM(a.SS_A) AS SS_A,
       SUM(a.SS_B) AS SS_B
FROM (
SELECT 
t.obstrip_id, t.obsprg_code,vesselname,flag_id,staff_code,'T'+tripno as tripno,t.dep_date
, CASE WHEN g.question_code = 'RS-A' THEN COUNT(g.question_code) ELSE 0 END AS RS_A
, CASE WHEN g.question_code = 'RS-B' THEN COUNT(g.question_code) ELSE 0 END AS RS_B
, CASE WHEN g.question_code = 'RS-C' THEN COUNT(g.question_code) ELSE 0 END AS RS_C
, CASE WHEN g.question_code = 'RS-D' THEN COUNT(g.question_code) ELSE 0 END AS RS_D
, CASE WHEN g.question_code = 'NR-A' THEN COUNT(g.question_code) ELSE 0 END AS NR_A
, CASE WHEN g.question_code = 'NR-B' THEN COUNT(g.question_code) ELSE 0 END AS NR_B
, CASE WHEN g.question_code = 'NR-C' THEN COUNT(g.question_code) ELSE 0 END AS NR_C
, CASE WHEN g.question_code = 'NR-D' THEN COUNT(g.question_code) ELSE 0 END AS NR_D
, CASE WHEN g.question_code = 'NR-E' THEN COUNT(g.question_code) ELSE 0 END AS NR_E
, CASE WHEN g.question_code = 'NR-F' THEN COUNT(g.question_code) ELSE 0 END AS NR_F
, CASE WHEN g.question_code = 'NR-G' THEN COUNT(g.question_code) ELSE 0 END AS NR_G
, CASE WHEN g.question_code = 'WC-A' THEN COUNT(g.question_code) ELSE 0 END AS WC_A
, CASE WHEN g.question_code = 'WC-B' THEN COUNT(g.question_code) ELSE 0 END AS WC_B
, CASE WHEN g.question_code = 'WC-C' THEN COUNT(g.question_code) ELSE 0 END AS WC_C
, CASE WHEN g.question_code = 'LP-A' THEN COUNT(g.question_code) ELSE 0 END AS LP_A
, CASE WHEN g.question_code = 'LP-B' THEN COUNT(g.question_code) ELSE 0 END AS LP_B
, CASE WHEN g.question_code = 'LC-A' THEN COUNT(g.question_code) ELSE 0 END AS LC_A
, CASE WHEN g.question_code = 'LC-B' THEN COUNT(g.question_code) ELSE 0 END AS LC_B
, CASE WHEN g.question_code = 'LC-C' THEN COUNT(g.question_code) ELSE 0 END AS LC_C
, CASE WHEN g.question_code = 'LC-D' THEN COUNT(g.question_code) ELSE 0 END AS LC_D
, CASE WHEN g.question_code = 'LC-E' THEN COUNT(g.question_code) ELSE 0 END AS LC_E
, CASE WHEN g.question_code = 'LC-F' THEN COUNT(g.question_code) ELSE 0 END AS LC_F
, CASE WHEN g.question_code = 'SI-A' THEN COUNT(g.question_code) ELSE 0 END AS SI_A
, CASE WHEN g.question_code = 'SI-B' THEN COUNT(g.question_code) ELSE 0 END AS SI_B
, CASE WHEN g.question_code = 'PN-A' THEN COUNT(g.question_code) ELSE 0 END AS PN_A
, CASE WHEN g.question_code = 'PN-B' THEN COUNT(g.question_code) ELSE 0 END AS PN_B
, CASE WHEN g.question_code = 'PN-C' THEN COUNT(g.question_code) ELSE 0 END AS PN_C
, CASE WHEN g.question_code = 'PN-D' THEN COUNT(g.question_code) ELSE 0 END AS PN_D
, CASE WHEN g.question_code = 'PN-E' THEN COUNT(g.question_code) ELSE 0 END AS PN_E
, CASE WHEN g.question_code = 'SS-A' THEN COUNT(g.question_code) ELSE 0 END AS SS_A
, CASE WHEN g.question_code = 'SS-B' THEN COUNT(g.question_code) ELSE 0 END AS SS_B
FROM [obsv].[gen3vr09] g 
INNER JOIN obsv.trip t ON g.obstrip_id = t.obstrip_id
INNER JOIN  ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN  ref.field_staff f on f.staff_id = t.observer_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
AND t.system_source = 'Ollo'
AND g.answer = 1
GROUP BY g.question_code,t.obstrip_id, t.obsprg_code,vi.vesselname,vi.flag_id,f.staff_code,t.tripno,t.dep_date) a
GROUP BY a.obsprg_code,a.obstrip_id, a.obsprg_code,a.vesselname,a.flag_id,a.staff_code,a.tripno,a.dep_date",NA
"424","abe5a6f8-929b-29b0-1be6-3a16e4a04bdb","OLLO Catch Statistics and Catch FATE","year, trip_id","OLLO Catch Statistics and Catch FATE","Observer",NA,"Observer",NA,3568,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-06-07T11:08:55.767","SELECT  
		ot.obstrip_id, obsprg_code,vesselname,flag_id,staff_code,'T'+tripno as tripno, 
        ot.dep_date,
		coalesce(sp.sp_cat_code,'OTH') as sp_cat_code,
		sp.sp_name,
		lc.sp_code,
		count(*) as total_caught,
        sum(case when left(fate_code,1) = 'R' then 0001 else 0000 end) as no_retained,
		sum(case when left(fate_code,1) = 'D' then 0001 else 0000 end) as no_discards,
		SUM(case when left(fate_code,1) = 'R' then 0001 else 0000 end)  / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Ret_perc,
		SUM(case when left(fate_code,1) <> 'R' then 0001 else 0000 end) / SUM(case when left(fate_code,1) IN ('R','D','E') then 0001 else 0000.00000000001 end) as Disc_perc,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / 1000 as WT,
		SUM(case when coalesce(wt,0) > coalesce(wt_est,wt) then coalesce(wt,0) else coalesce(wt_est,wt) end) / SUM(1) as AVG_WT,
		SUM(case when coalesce(len,0) > 0 then len else 0000 end) / SUM(case when coalesce(len,0) > 0 then 0001 else 0000.00000000001 end) as AVG_LEN,
		sum(case when fate_code = 'RWW' then 0001 else 0000 end) as RWW,
		sum(case when fate_code = 'RCC' then 0001 else 0000 end) as RCC,
		sum(case when fate_code = 'RFR' then 0001 else 0000 end) as RFR,
		sum(case when left(fate_code,1) = 'R' and fate_code not in ('RWW','RCC','RFR') then 0001 else 0000 end) as ROR,
		sum(case when fate_code = 'DPA' then 0001 else 0000 end) as DPA,
		sum(case when fate_code = 'DPD' then 0001 else 0000 end) as DPD,
		sum(case when fate_code = 'DPU' then 0001 else 0000 end) as DPU,
		sum(case when fate_code = 'DFR' then 0001 else 0000 end) as DFR,
		sum(case when fate_code = 'DCF' or fate_code = 'DSO'then 0001 else 0000 end) as DCF,
		sum(case when fate_code = 'DUS' then 0001 else 0000 end) as DUS,
		sum(case when left(fate_code,1) = 'D' and fate_code not in ('DPA','DPD','DPU','DFR','DUS','DCF','DSO') then 0001 else 0000 end) as DOR,	
		coalesce(gr_interact_code,'--') as gr_interact_code
FROM    obsv.trip ot 
        inner join ref.vessel_instances v on ot.vessel_id = v.vessel_id and ot.dep_date between v.start_date and v.calculated_end_date
        inner join    obsv.l_set ls on ot.obstrip_id = ls.obstrip_id 
        inner join    obsv.l_setcatch lc on ls.l_set_id = lc.l_set_id
	    inner join ref.species sp on lc.sp_code = sp.sp_code
		inner join ref.field_staff f on f.staff_id=ot.observer_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(ot.dep_date) = coalesce(:year, YEAR(ot.dep_date))
AND ot.system_source = 'Ollo'
group by ot.obstrip_id, obsprg_code,vesselname,staff_code,tripno,ot.dep_date,sp.sp_name,lc.sp_code,flag_id,YEAR(ot.dep_date),sp.sp_cat_code,gr_interact_code",NA
"425","49863c83-9701-ba72-50a4-3a16e8c83bb5","OLLO GEN-3 Comments","year, trip_id","OLLO GEN-3 Comments","Observer",NA,"Observer",NA,3569,"colleyf@spc.int","colleyf@spc.int","Observer, Longline, Ereporting","2025-09-02T13:03:52.943","SELECT ot.obstrip_id, obsprg_code,vesselname,flag_id,staff_code,'T'+tripno as tripno,ot.dep_date, gen3_date,question_code, REPLACE(g.comments,CHAR(10),';') as comments
FROM obsv.gen3vr09details g join obsv.trip ot on g.obstrip_id = ot.obstrip_id
INNER JOIN ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN ref.field_staff f on f.staff_id = ot.observer_id
WHERE RTRIM(staff_code)= coalesce(LEFT(:trip_id,3),RTRIM(staff_code)) and tripno=coalesce(RIGHT(:trip_id,5),tripno) and YEAR(dep_date) = coalesce(:year, YEAR(dep_date))
AND ot.system_source = 'Ollo'",NA
"426","908c5867-eded-655c-f968-3a18c93874e3"," POLE AND LINE - Catch in EEZ by YEAR","year","Shows the main tuna species catch by EEZ by Year - Used in ACE Module","Logsheets",NA,NA,NA,3577,"benoitp@spc.int","benoitp@spc.int","Logsheet, PoleAndLine, Unraised, Tuna","2025-03-24T08:18:16.083"," SELECT   year(logdate), eez_code,
		COUNT(distinct t.log_trip_id) as trips,
		cast(Sum(case sp_code when 'SKJ' then sp_mt else 000.0 end) as int) AS skj_mt, 
        cast(Sum(case sp_code when 'BET' then sp_mt else 000.0 end) as int) AS bet_mt, 
        cast(Sum(case sp_code when 'YFT' then sp_mt else 000.0 end) as int) AS yft_mt, 
        cast(Sum(sp_mt) as int) AS tot_mt
FROM log.trips_pl t inner join log.sets_pl s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_pl c on s.log_set_id = c.log_set_id 
					inner join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date					
WHERE year(logdate) = coalesce(:year, year(logdate)) 
AND (@@entity = 'HIVE' OR vi.flag_id = @@entity)
group by year(logdate), eez_code",NA
"427","259627b5-e636-2460-d128-3a137ded569c","LL OBS - FIA MSC documents for Assessment","flag_code, min_year, max_year","Longline catch statistics from observer data broken down by Species and Species Group with selection by YEAR, FLAG and EEZ for FIA MSC documents for Assessment","Observer",NA,"Observer",NA,3541,"colleyf@spc.int","aurelienp@spc.int","Observer, Longline","2025-09-08T10:41:06.237","SELECT YEAR(t.dep_date) as yr,
vesselname as vesselname,
flag_id as flag_id,
vi.ircs as ircs ,
t.obstrip_id as trip_code,
'LL' as gear_code,
CONVERT(nvarchar,t.dep_date,111) as depart_date,
CONVERT(nvarchar,s.set_date,111) as set_date,
'WCPFC' AS RMFO_Area,
lsh.latd AS latd, 
lsh.lond AS lond, 
lsh.eez_code AS eez_code,
sc.sp_code as sp_code,
sp.sp_name AS common_name,
sp.sp_sci_name AS sci_name,
CASE WHEN LEFT(sc.fate_code,1)='R' THEN  'Retained' ELSE fate_desc END AS fate,
CASE WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='A' THEN 'Alive'
     WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='D' THEN 'Dead'
	 WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='U' THEN 'Unknown'
	 WHEN COALESCE(LEFT(cond_code2,1),'N/A') NOT IN ('A','D','U') THEN 'N/A'
END AS life_status,
CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='R' THEN  1               
		      WHEN flag_id <> coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='R'  THEN 1 ELSE 0  END) AS DECIMAL(7,0)) AS Ret_n,  
			  
CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='R' THEN  COALESCE(sc.wt_est,0.00)/ 1000
		      WHEN flag_id <> coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='R'  THEN COALESCE(sc.wt_est,0.00)/ 1000 ELSE 0.00000  END) AS DECIMAL(5,4)) AS Ret_MT_est,

CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='D' THEN  1               
		      WHEN flag_id <> coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='D' THEN 1 ELSE 0  END) AS DECIMAL(7,0)) AS Disc_n,   

CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='D' THEN  COALESCE(sc.wt_est,0.00)/ 1000
		     WHEN flag_id <> coalesce(:flag_code,flag_id) AND LEFT(sc.fate_code,1)='D'  THEN COALESCE(sc.wt_est,0.00)/ 1000 ELSE 0.00000  END) AS DECIMAL(5,4)) AS Disc_MT_est

FROM obsv.trip t 
INNER JOIN obsv.l_set s ON s.obstrip_id = t.obstrip_id
INNER JOIN ref.vessel_instances vi ON t.vessel_id = vi.vessel_id AND t.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN obsv.l_sethaullog lsh ON s.l_set_id = lsh.l_set_id AND lsh.stend_id = 83
INNER JOIN obsv.l_setcatch sc ON sc.l_set_id = s.l_set_id
INNER JOIN ref.species sp ON sp.sp_code = sc.sp_code
LEFT JOIN ref_static.fate_codes f ON f.fate_code = sc.fate_code

WHERE YEAR(t.dep_date) >= coalesce(:min_year,year(t.dep_date)) and YEAR(t.dep_date) <= coalesce(:max_year,year(t.dep_date))
AND flag_id = coalesce(:flag_code,flag_id)
AND t.gear_code = 'L' 

GROUP BY vesselname,flag_id,t.dep_date,sc.sp_code,sp.sp_name,sp.sp_sci_name,vi.ircs,t.obstrip_id,s.set_date,lsh.latd,lsh.lond,lsh.eez_code,
CASE WHEN LEFT(sc.fate_code,1)='R' THEN 'Retained' ELSE fate_desc END, 
CASE WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='A' THEN 'Alive'
     WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='D' THEN 'Dead'
	 WHEN COALESCE(LEFT(cond_code2,1),'N/A') ='U' THEN 'Unknown'
	 WHEN COALESCE(LEFT(cond_code2,1),'N/A') NOT IN ('A','D','U') THEN 'N/A'
END",NA
"428","35f04680-00c0-1d8c-cffe-3a136f34751e","LL LOG - FIA MSC documents for Assessment: ","eez_code, flag_code, min_year, max_year","Longline catch statistics from logsheet data broken down by Species and Species Group with selection by YEAR, FLAG and EEZ for FIA MSC documents for Assessment","Logsheets",NA,NA,NA,3539,"colleyf@spc.int","emmanuels@spc.int","Logsheet, Longline","2024-09-03T14:06:07.483","SELECT  YEAR(logdate) AS yr,
		vi.vesselname AS vesselname, 
		flag_id AS flag_id,
		vi.ircs AS ircs ,
		l.log_trip_id AS trip_code,
		'LL' AS gear_code,
		CONVERT(nvarchar,l.depart_date,111) depart_date,
		CONVERT(nvarchar,s.logdate,111) set_date,
		'WCPFC' AS RMFO_Area,
		s.latd AS latd, 
		s.lond AS lond, 
		s.eez_code AS eez_code,
		c.sp_code AS sp_code, 
		sp.sp_name AS common_name,
		sp.sp_sci_name AS sci_name,
		'N/A' AS fate,
		'N/A' AS life_status, 
		CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) THEN COALESCE(c.sp_n,0) 
		              WHEN flag_id <> coalesce(:flag_code,flag_id) AND s.eez_code = coalesce(:eez_code,eez_code) THEN COALESCE(c.sp_n,0) ELSE 0.00000  END) AS DECIMAL(7,0))	AS Ret_n,
	    CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) THEN COALESCE(c.sp_kg_est,0.00)/ 1000
		              WHEN flag_id <> coalesce(:flag_code,flag_id) AND s.eez_code = coalesce(:eez_code,eez_code) THEN COALESCE(c.sp_kg_est,0.00)/ 1000 ELSE 0.00000  END) AS DECIMAL(5,2)) AS Ret_MT_est,
		CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) THEN COALESCE(spdiscard_n,0) 
		              WHEN flag_id <> coalesce(:flag_code,flag_id) AND s.eez_code = coalesce(:eez_code,eez_code) THEN COALESCE(spdiscard_n,0) ELSE 0.00000  END) AS DECIMAL(6,0))	AS Disc_n,
		CAST(SUM(CASE WHEN flag_id = coalesce(:flag_code,flag_id) THEN COALESCE(c.spdiscard_kg_est,0.00)/ 1000
		              WHEN flag_id <> coalesce(:flag_code,flag_id) AND s.eez_code = coalesce(:eez_code,eez_code) THEN COALESCE(c.spdiscard_kg_est,0.00)/ 1000 ELSE 0.00000  END) AS DECIMAL(5,2)) AS Disc_MT_est
FROM ref.vessel_instances vi 
INNER JOIN ref.vessels v ON v.vessel_id = vi.vessel_id 	AND v.gear = 'L'
INNER JOIN log.trips_ll l ON l.vessel_id = vi.vessel_id AND l.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
INNER JOIN log.sets_ll s ON l.log_trip_id = s.log_trip_id
INNER JOIN log.catch_ll c ON c.log_set_id = s.log_set_id
INNER JOIN ref.species sp ON sp.sp_code = c.sp_code
WHERE YEAR(logdate) >= coalesce(:min_year,year(logdate)) and YEAR(logdate) <= coalesce(:max_year,year(logdate))
AND s.l_activity_id = 1
AND (flag_id = coalesce(:flag_code,flag_id) OR (eez_code = coalesce(:eez_code,eez_code) OR (:eez_code = 'KI' and eez_code in ('KI','GL','PX','LN'))))
GROUP BY YEAR(logdate), vi.vesselname, flag_id,c.sp_code, sp.sp_name,sp.sp_sci_name,l.depart_date, 
l.log_trip_id, s.logdate, vi.ircs, s.latd,s.lond,s.eez_code",NA
"429","de86e794-d079-d92e-facd-3a186b3736cb","Total Logsheet trips vs Observer trips by vessel","flag_code, year","Compare the total number of trips by year and vessel, between Logsheet and Observer","Observer,Logsheets",NA,"Live",NA,3574,"aurelienp@spc.int","aurelienp@spc.int","","2025-10-13T09:11:28.327","select l.*,o.obsv_trips
from
	(
	SELECT	year(depart_date) year,vesselname,flag_id,
			count(*) logs_trips
	FROM	log.trips_ps t
			JOIN ref.vessel_instances vi ON vi.vessel_id=t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
	where flag_id=coalesce(:flag_id,flag_id)
	and year(depart_date) = :year
	group by year(depart_date),flag_id,vesselname ) l
	JOIN
	(
	select year(dep_date) year,vesselname,flag_id,count(*) obsv_trips
	FROM obsv.trip ot 
	join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
	where flag_id=coalesce(:flag_id,flag_id)
	and year(dep_date) = :year
	group by year(dep_date),flag_id,vesselname ) o on l.year = o.year and l.vesselname = o.vesselname",NA
"430","2526ce25-3aa1-957d-ec77-3a1a07036528","LONGLINE - VMS-Logsheet-Observer Trips  - Bycatches by YEAR","min_year, max_year, obsv_prg","LONGLINE - VMS-Logsheet-Observer Trips  - Bycatches by YEAR","Logsheets,Observer,VMS",NA,"Live",NA,3579,"colleyf@spc.int","colleyf@spc.int","Logsheet, Observer, VMS, Longline","2025-09-18T14:47:24.32","USE tufman2_dorado
SELECT 
x.yr as yr,
x.gear as gear,
x.flag_id as flag,
x.vesselname as vesselname,
x.vessel_id as vessel_id,
x.VMS_dep_date as vms_dep_date ,
x.VMS_ret_date as vms_ret_date,
x.VMS_days as vms_days,
x.log_trip_id as log_trip_id,
x.LOG_dep_date as log_dep_date,
x.LOG_ret_date as log_ret_date,
x.LOG_days as log_days,
x.obs_trip_id as obs_trip_id,
x.obsprg_code as obsprg_code,
x.staff_code as staff_code,
x.first_name as first_name,
x.family_name as family_name,
x.tripno as tripno,
x.OBS_dep_date as obs_dep_date,
x.OBS_ret_date as obs_ret_date,
x.OBS_days as obs_days,
x.data_status as obs_data_status,
coalesce(x.log_TUN_catch_n,0) as log_tun_catch_n,
coalesce(x.log_OTH_catch_n,0) as log_oth_catch_n,
coalesce(x.log_Total_catch_n,0) as log_total_catch_n, 
coalesce(x.obs_TUN_catch_n,0) as obs_tun_catch_n,
coalesce(x.obs_OTH_catch_n,0) as obs_oth_catch_n,
coalesce(x.obs_Total_catch_n,0) as obs_total_catch_n,
CASE 
    WHEN ISNULL(x.obs_Total_catch_n, 0) = 0 THEN 0 
    WHEN ISNULL(x.obs_OTH_catch_n, 0) = 0 THEN 0  
    ELSE (CAST(ISNULL(x.obs_OTH_catch_n, 0) AS FLOAT) / CAST(ISNULL(x.obs_Total_catch_n, 0) AS FLOAT)) * 100
END as obs_bycatch_percent,
CASE 
    WHEN ISNULL(x.log_Total_catch_n, 0) = 0 THEN 0 
    WHEN ISNULL(x.log_OTH_catch_n, 0) = 0 THEN 0  
    ELSE (CAST(ISNULL(x.log_OTH_catch_n, 0) AS FLOAT) / CAST(ISNULL(x.log_Total_catch_n, 0) AS FLOAT)) * 100
END as log_bycatch_percent
FROM (
SELECT	
        year(ot.dep_date) as yr,
        v.gear as gear,
		vi.flag_id as flag_id,
		vi.vesselname as vesselname,
		vi.vessel_id as vessel_id,
		CONVERT(nvarchar, vt.departure_date, 111) as vms_dep_date, 
		CONVERT(nvarchar, vt.return_date, 111) as vms_ret_date,
		DATEDIFF(DAY,vt.departure_date,vt.return_date) as vms_days,
		linklog.dto_guid_right as log_trip_id,
		CONVERT(nvarchar, lt.first_logdate, 111) as log_dep_date, 
		CONVERT(nvarchar, lt.last_logdate, 111) as log_ret_date,
		DATEDIFF(DAY,lt.first_logdate,last_logdate) as log_days,
		linkobs.dto_guid_right as obs_trip_id,
		ot.obsprg_code as obsprg_code,
		s.staff_code as staff_code,
        s.first_name as first_name,
        s.family_name as family_name,
        'T'+ot.tripno as tripno,
		CONVERT(nvarchar, ot.dep_date, 111) as obs_dep_date, 
		CONVERT(nvarchar, ot.ret_date, 111) as obs_ret_date,
		DATEDIFF(DAY,ot.dep_date,ot.ret_date) as obs_days,
		ot.data_status as data_status,
		 (SELECT	cast(Sum(case when c.sp_code IN ('ALB','SKJ','YFT','BET') then sp_n else 000.0 end) as decimal(7,0)) 
         FROM	log.trips_ll t 
		        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
		        INNER JOIN log.sets_ll s on s.log_trip_id = t.log_trip_id
		        LEFT OUTER JOIN log.catch_ll c on c.log_set_id = s.log_set_id
         WHERE t.log_trip_id = lt.log_trip_id) as log_tun_catch_n,
		 (SELECT	cast(Sum(case when c.sp_code NOT IN ('ALB','SKJ','YFT','BET') then sp_n else 000.0 end) as decimal(7,0)) 
         FROM	log.trips_ll t 
		        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
		        INNER JOIN log.sets_ll s on s.log_trip_id = t.log_trip_id
		        LEFT OUTER JOIN log.catch_ll c on c.log_set_id = s.log_set_id
         WHERE t.log_trip_id = lt.log_trip_id) as log_oth_catch_n,
		 (SELECT	cast(Sum(sp_n) as decimal(7,0)) 	
         FROM	log.trips_ll t 
		        INNER JOIN ref.vessel_instances vi ON vi.vessel_id = t.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date 
		        INNER JOIN log.sets_ll s on s.log_trip_id = t.log_trip_id
		        LEFT OUTER JOIN log.catch_ll c on c.log_set_id = s.log_set_id
         WHERE t.log_trip_id = lt.log_trip_id) as log_total_catch_n,
		 (SELECT sum(case when sc.sp_code in ('ALB','SKJ','YFT','BET') and left(fate_code,1) = 'R' OR left(fate_code,1) = 'D' then 1 end) 
		 FROM obsv.trip t1 
              INNER JOIN obsv.l_set s on s.obstrip_id = t1.obstrip_id
              INNER JOIN ref.vessel_instances vi on t1.vessel_id = vi.vessel_id AND t1.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
              INNER JOIN obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
              INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 1
          WHERE t1.obstrip_id = ot.obstrip_id) as obs_tun_catch_n,

		  (SELECT sum(case when sc.sp_code NOT in ('ALB','SKJ','YFT','BET') and left(fate_code,1) = 'R' OR left(fate_code,1) = 'D' then 1 end) 
		 FROM obsv.trip t1 
              INNER JOIN obsv.l_set s on s.obstrip_id = t1.obstrip_id
              INNER JOIN ref.vessel_instances vi on t1.vessel_id = vi.vessel_id AND t1.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
              INNER JOIN obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
              INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 1
          WHERE t1.obstrip_id = ot.obstrip_id) as obs_oth_catch_n,
		 (SELECT sum(case when left(fate_code,1) = 'R' OR left(fate_code,1) = 'D' then 1 end) 
		 FROM obsv.trip t1 
              INNER JOIN obsv.l_set s on s.obstrip_id = t1.obstrip_id
              INNER JOIN ref.vessel_instances vi on t1.vessel_id = vi.vessel_id AND t1.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
              INNER JOIN obsv.l_setcatch sc on sc.l_set_id = s.l_set_id
              INNER JOIN obsv.l_sethaullog sh on sh.l_set_id = s.l_set_id and stend_id = 1
          WHERE t1.obstrip_id = ot.obstrip_id) as obs_total_catch_n
FROM	vms.vms_trips vt
			left join tufman2.viewpersist_entity_links_two_way linklog on vt.vms_trip_id = linklog.dto_guid_left and linklog.dto_type_left = 'VmsTripDTO' and linklog.dto_type_right = 'LonglineLogsheetDTO' 
			left join log.trips_ll lt ON lt.log_trip_id = linklog.dto_guid_right
			left join tufman2.viewpersist_entity_links_two_way linkObs on vt.vms_trip_id = linkObs.dto_guid_left and linkObs.dto_type_left = 'VmsTripDTO' and linkObs.dto_type_right = 'ObserverTripDTO' 
			left join obsv.trip ot ON ot.obstrip_id = linkObs.dto_guid_right
			INNER JOIN ref.vessel_instances vi ON vi.vessel_id = vt.vessel_id AND vt.departure_date BETWEEN vi.start_date AND vi.calculated_end_date 
			INNER JOIN ref.vessels v ON vi.vessel_id = v.vessel_id 
			INNER JOIN ref.field_staff s on ot.observer_id = s.staff_id
WHERE YEAR(vt.departure_date) >= coalesce(:min_year,year(vt.departure_date)) AND YEAR(vt.departure_date) <= coalesce(:max_year,year(vt.departure_date))
		AND v.gear in ('L')
		AND obsprg_code = COALESCE(:obsv_prg,obsprg_code)
) x;",NA
"431","5533951b-fa76-e6b2-5607-3a1a6e54ac0a","PURSE SEINE - GEN-3 Incidents Report by Trip by Vessel by YEAR-MONTH-QUARTER","flag_code, year, obsv_prg","PURSE SEINE - GEN-3 Incidents Report by Trip by Vessel by YEAR-MONTH-QUARTER","Observer",NA,"Observer",NA,3582,"colleyf@spc.int","colleyf@spc.int","Observer, Purseseine","2025-06-11T11:01:49.29","SELECT a.obsprg_code as obsprg_code,
       a.trip_year as trip_year, 
	   a.trip_month as trip_month,
	   a.trip_quarter as trip_quarter,
       a.gear_code as gear_code,
	   'T'+a.trip_no as trip_no,
       a.staff_code as staff_code,
       a.vesselname as vesselname,
       a.flag_id as flag_id,
       a.ffa_vid as ffa_vid,
	   CONVERT(VARCHAR, a.depart_date, 106) as depart_date,
       SUM(a.RS_A) AS RS_A,
       SUM(a.RS_B) AS RS_B,
       SUM(a.RS_C) AS RS_C,
       SUM(a.RS_D) AS RS_D,
       SUM(a.NR_A) AS NR_A,
       SUM(a.NR_B) AS NR_B,
       SUM(a.NR_C) AS NR_C,
       SUM(a.NR_D) AS NR_D,
       SUM(a.NR_E) AS NR_E,
       SUM(a.NR_F) AS NR_F,
       SUM(a.NR_G) AS NR_G,
       SUM(a.WC_A) AS WC_A,
       SUM(a.WC_B) AS WC_B,
       SUM(a.WC_C) AS WC_C,
       SUM(a.LP_A) AS LP_A,
       SUM(a.LP_B) AS LP_B,
       SUM(a.LC_A) AS LC_A,
       SUM(a.LC_B) AS LC_B,
       SUM(a.LC_C) AS LC_C,
       SUM(a.LC_D) AS LC_D,
       SUM(a.LC_E) AS LC_E,
       SUM(a.LC_F) AS LC_F,
       SUM(a.SI_A) AS SI_A,
       SUM(a.SI_B) AS SI_B,
       SUM(a.PN_A) AS PN_A,
       SUM(a.PN_B) AS PN_B,
       SUM(a.PN_C) AS PN_C,
       SUM(a.PN_D) AS PN_D,
       SUM(a.PN_E) AS PN_E,
       SUM(a.SS_A) AS SS_A,
       SUM(a.SS_B) AS SS_B
FROM (
SELECT t.obsprg_code as obsprg_code
,DATEPART(yyyy,t.dep_date) as trip_year
,DATEPART(MONTH,t.dep_date) as trip_month
,DATEPART(QUARTER,t.dep_date) as trip_quarter
,t.gear_code as gear_code
,t.tripno as trip_no
,f.staff_code as staff_code
,vi.vesselname as vesselname
,vi.flag_id as flag_id
,vi.ffa_vid as ffa_vid
,CONVERT(VARCHAR, t.dep_date, 106) as depart_date
, CASE WHEN g.question_code = 'RS-A' THEN COUNT(g.question_code) ELSE 0 END AS RS_A
, CASE WHEN g.question_code = 'RS-B' THEN COUNT(g.question_code) ELSE 0 END AS RS_B
, CASE WHEN g.question_code = 'RS-C' THEN COUNT(g.question_code) ELSE 0 END AS RS_C
, CASE WHEN g.question_code = 'RS-D' THEN COUNT(g.question_code) ELSE 0 END AS RS_D
, CASE WHEN g.question_code = 'NR-A' THEN COUNT(g.question_code) ELSE 0 END AS NR_A
, CASE WHEN g.question_code = 'NR-B' THEN COUNT(g.question_code) ELSE 0 END AS NR_B
, CASE WHEN g.question_code = 'NR-C' THEN COUNT(g.question_code) ELSE 0 END AS NR_C
, CASE WHEN g.question_code = 'NR-D' THEN COUNT(g.question_code) ELSE 0 END AS NR_D
, CASE WHEN g.question_code = 'NR-E' THEN COUNT(g.question_code) ELSE 0 END AS NR_E
, CASE WHEN g.question_code = 'NR-F' THEN COUNT(g.question_code) ELSE 0 END AS NR_F
, CASE WHEN g.question_code = 'NR-G' THEN COUNT(g.question_code) ELSE 0 END AS NR_G
, CASE WHEN g.question_code = 'WC-A' THEN COUNT(g.question_code) ELSE 0 END AS WC_A
, CASE WHEN g.question_code = 'WC-B' THEN COUNT(g.question_code) ELSE 0 END AS WC_B
, CASE WHEN g.question_code = 'WC-C' THEN COUNT(g.question_code) ELSE 0 END AS WC_C
, CASE WHEN g.question_code = 'LP-A' THEN COUNT(g.question_code) ELSE 0 END AS LP_A
, CASE WHEN g.question_code = 'LP-B' THEN COUNT(g.question_code) ELSE 0 END AS LP_B
, CASE WHEN g.question_code = 'LC-A' THEN COUNT(g.question_code) ELSE 0 END AS LC_A
, CASE WHEN g.question_code = 'LC-B' THEN COUNT(g.question_code) ELSE 0 END AS LC_B
, CASE WHEN g.question_code = 'LC-C' THEN COUNT(g.question_code) ELSE 0 END AS LC_C
, CASE WHEN g.question_code = 'LC-D' THEN COUNT(g.question_code) ELSE 0 END AS LC_D
, CASE WHEN g.question_code = 'LC-E' THEN COUNT(g.question_code) ELSE 0 END AS LC_E
, CASE WHEN g.question_code = 'LC-F' THEN COUNT(g.question_code) ELSE 0 END AS LC_F
, CASE WHEN g.question_code = 'SI-A' THEN COUNT(g.question_code) ELSE 0 END AS SI_A
, CASE WHEN g.question_code = 'SI-B' THEN COUNT(g.question_code) ELSE 0 END AS SI_B
, CASE WHEN g.question_code = 'PN-A' THEN COUNT(g.question_code) ELSE 0 END AS PN_A
, CASE WHEN g.question_code = 'PN-B' THEN COUNT(g.question_code) ELSE 0 END AS PN_B
, CASE WHEN g.question_code = 'PN-C' THEN COUNT(g.question_code) ELSE 0 END AS PN_C
, CASE WHEN g.question_code = 'PN-D' THEN COUNT(g.question_code) ELSE 0 END AS PN_D
, CASE WHEN g.question_code = 'PN-E' THEN COUNT(g.question_code) ELSE 0 END AS PN_E
, CASE WHEN g.question_code = 'SS-A' THEN COUNT(g.question_code) ELSE 0 END AS SS_A
, CASE WHEN g.question_code = 'SS-B' THEN COUNT(g.question_code) ELSE 0 END AS SS_B
FROM [obsv].[gen3vr09] g 
INNER JOIN obsv.trip t ON g.obstrip_id = t.obstrip_id
INNER JOIN ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN ref.field_staff f on f.staff_id=t.observer_id
WHERE  YEAR(t.dep_date) = coalesce(:year, YEAR(t.dep_date))
AND t.obsprg_code = COALESCE(:obsv_prg, t.obsprg_code)
AND vi.flag_id  = coalesce(:flag_code,flag_id)
AND t.gear_code = 'S'
AND g.answer = 1
GROUP BY g.question_code,t.dep_date,t.obsprg_code, t.gear_code, t.tripno,f.staff_code,vi.vesselname,vi.flag_id,vi.ffa_vid) a
GROUP BY a.obsprg_code,a.trip_year, a.gear_code,  a.trip_month, a.trip_quarter, a.trip_no,a.staff_code,a.vesselname,a.flag_id,a.ffa_vid, a.depart_date ",NA
"432","85da8c08-dcde-d67d-124f-3a1a6e66a5e8","LONGLINE - GEN-3 Incidents Report by Trip by Vessel by YEAR-MONTH-QUARTER","flag_code, year, obsv_prg","LONGLINE - GEN-3 Incidents Report by Trip by Vessel by YEAR-MONTH-QUARTER","Observer",NA,"Observer",NA,3583,"colleyf@spc.int","colleyf@spc.int","Observer, Longline","2025-06-11T11:03:05.803","SELECT a.obsprg_code as obsprg_code,
       a.trip_year as trip_year, 
	   a.trip_month as trip_month,
	   a.trip_quarter as trip_quarter,
       a.gear_code as gear_code,
	   'T'+a.trip_no as trip_no,
       a.staff_code as staff_code,
       a.vesselname as vesselname,
       a.flag_id as flag_id,
       a.ffa_vid as ffa_vid,
	   CONVERT(VARCHAR, a.depart_date, 106) as depart_date,
       SUM(a.RS_A) AS RS_A,
       SUM(a.RS_B) AS RS_B,
       SUM(a.RS_C) AS RS_C,
       SUM(a.RS_D) AS RS_D,
       SUM(a.NR_A) AS NR_A,
       SUM(a.NR_B) AS NR_B,
       SUM(a.NR_C) AS NR_C,
       SUM(a.NR_D) AS NR_D,
       SUM(a.NR_E) AS NR_E,
       SUM(a.NR_F) AS NR_F,
       SUM(a.NR_G) AS NR_G,
       SUM(a.WC_A) AS WC_A,
       SUM(a.WC_B) AS WC_B,
       SUM(a.WC_C) AS WC_C,
       SUM(a.LP_A) AS LP_A,
       SUM(a.LP_B) AS LP_B,
       SUM(a.LC_A) AS LC_A,
       SUM(a.LC_B) AS LC_B,
       SUM(a.LC_C) AS LC_C,
       SUM(a.LC_D) AS LC_D,
       SUM(a.LC_E) AS LC_E,
       SUM(a.LC_F) AS LC_F,
       SUM(a.SI_A) AS SI_A,
       SUM(a.SI_B) AS SI_B,
       SUM(a.PN_A) AS PN_A,
       SUM(a.PN_B) AS PN_B,
       SUM(a.PN_C) AS PN_C,
       SUM(a.PN_D) AS PN_D,
       SUM(a.PN_E) AS PN_E,
       SUM(a.SS_A) AS SS_A,
       SUM(a.SS_B) AS SS_B
FROM (
SELECT t.obsprg_code as obsprg_code
,DATEPART(yyyy,t.dep_date) as trip_year
,DATEPART(MONTH,t.dep_date) as trip_month
,DATEPART(QUARTER,t.dep_date) as trip_quarter
,t.gear_code as gear_code
,t.tripno as trip_no
,f.staff_code as staff_code
,vi.vesselname as vesselname
,vi.flag_id as flag_id
,vi.ffa_vid as ffa_vid
,CONVERT(VARCHAR, t.dep_date, 106) as depart_date
, CASE WHEN g.question_code = 'RS-A' THEN COUNT(g.question_code) ELSE 0 END AS RS_A
, CASE WHEN g.question_code = 'RS-B' THEN COUNT(g.question_code) ELSE 0 END AS RS_B
, CASE WHEN g.question_code = 'RS-C' THEN COUNT(g.question_code) ELSE 0 END AS RS_C
, CASE WHEN g.question_code = 'RS-D' THEN COUNT(g.question_code) ELSE 0 END AS RS_D
, CASE WHEN g.question_code = 'NR-A' THEN COUNT(g.question_code) ELSE 0 END AS NR_A
, CASE WHEN g.question_code = 'NR-B' THEN COUNT(g.question_code) ELSE 0 END AS NR_B
, CASE WHEN g.question_code = 'NR-C' THEN COUNT(g.question_code) ELSE 0 END AS NR_C
, CASE WHEN g.question_code = 'NR-D' THEN COUNT(g.question_code) ELSE 0 END AS NR_D
, CASE WHEN g.question_code = 'NR-E' THEN COUNT(g.question_code) ELSE 0 END AS NR_E
, CASE WHEN g.question_code = 'NR-F' THEN COUNT(g.question_code) ELSE 0 END AS NR_F
, CASE WHEN g.question_code = 'NR-G' THEN COUNT(g.question_code) ELSE 0 END AS NR_G
, CASE WHEN g.question_code = 'WC-A' THEN COUNT(g.question_code) ELSE 0 END AS WC_A
, CASE WHEN g.question_code = 'WC-B' THEN COUNT(g.question_code) ELSE 0 END AS WC_B
, CASE WHEN g.question_code = 'WC-C' THEN COUNT(g.question_code) ELSE 0 END AS WC_C
, CASE WHEN g.question_code = 'LP-A' THEN COUNT(g.question_code) ELSE 0 END AS LP_A
, CASE WHEN g.question_code = 'LP-B' THEN COUNT(g.question_code) ELSE 0 END AS LP_B
, CASE WHEN g.question_code = 'LC-A' THEN COUNT(g.question_code) ELSE 0 END AS LC_A
, CASE WHEN g.question_code = 'LC-B' THEN COUNT(g.question_code) ELSE 0 END AS LC_B
, CASE WHEN g.question_code = 'LC-C' THEN COUNT(g.question_code) ELSE 0 END AS LC_C
, CASE WHEN g.question_code = 'LC-D' THEN COUNT(g.question_code) ELSE 0 END AS LC_D
, CASE WHEN g.question_code = 'LC-E' THEN COUNT(g.question_code) ELSE 0 END AS LC_E
, CASE WHEN g.question_code = 'LC-F' THEN COUNT(g.question_code) ELSE 0 END AS LC_F
, CASE WHEN g.question_code = 'SI-A' THEN COUNT(g.question_code) ELSE 0 END AS SI_A
, CASE WHEN g.question_code = 'SI-B' THEN COUNT(g.question_code) ELSE 0 END AS SI_B
, CASE WHEN g.question_code = 'PN-A' THEN COUNT(g.question_code) ELSE 0 END AS PN_A
, CASE WHEN g.question_code = 'PN-B' THEN COUNT(g.question_code) ELSE 0 END AS PN_B
, CASE WHEN g.question_code = 'PN-C' THEN COUNT(g.question_code) ELSE 0 END AS PN_C
, CASE WHEN g.question_code = 'PN-D' THEN COUNT(g.question_code) ELSE 0 END AS PN_D
, CASE WHEN g.question_code = 'PN-E' THEN COUNT(g.question_code) ELSE 0 END AS PN_E
, CASE WHEN g.question_code = 'SS-A' THEN COUNT(g.question_code) ELSE 0 END AS SS_A
, CASE WHEN g.question_code = 'SS-B' THEN COUNT(g.question_code) ELSE 0 END AS SS_B
FROM [obsv].[gen3vr09] g 
INNER JOIN obsv.trip t ON g.obstrip_id = t.obstrip_id
INNER JOIN ref.vessel_instances vi on vi.vessel_id = t.vessel_id and t.dep_date between vi.start_date and vi.calculated_end_date
INNER JOIN ref.field_staff f on f.staff_id=t.observer_id
WHERE  YEAR(t.dep_date) = coalesce(:year, YEAR(t.dep_date))
AND t.obsprg_code = COALESCE(:obsv_prg, t.obsprg_code)
AND vi.flag_id  = coalesce(:flag_code,flag_id)
AND t.gear_code = 'L'
AND g.answer = 1
GROUP BY g.question_code,t.dep_date,t.obsprg_code, t.gear_code, t.tripno,f.staff_code,vi.vesselname,vi.flag_id,vi.ffa_vid) a
GROUP BY a.obsprg_code,a.trip_year, a.gear_code,  a.trip_month, a.trip_quarter, a.trip_no,a.staff_code,a.vesselname,a.flag_id,a.ffa_vid, a.depart_date ",NA
"433","286e2cfd-8e77-0201-a557-3a1b226cfaa1","Total FADs deployed and retrieved - MSC","min_year","Total FADs deployed and retrieved by year and vessels","Observer",NA,"Observer",NA,3589,"aurelienp@spc.int","aurelienp@spc.int","Observer","2025-08-18T13:39:09.75","select year(act_date) year, vesselname,flag_id,
SUM(case when(s_activ_id) = 10 then 1 else 0 end) as FADs_deployed,
SUM(case when(s_activ_id) = 11 then 1 else 0 end) as FADs_retrieved
FROM obsv.trip ot 
join ref.vessel_instances vi on ot.vessel_id = vi.vessel_id AND ot.dep_date BETWEEN vi.start_date AND vi.calculated_end_date
join ref.field_staff f on f.staff_id = ot.observer_id
join obsv.s_day sd on ot.obstrip_id = sd.obstrip_id 
join obsv.s_daylog sa on sd.s_day_id = sa.s_day_id
where s_activ_id in (10,11) and year(act_date)>= :min_year
group by year(act_date), vesselname,flag_id",NA
"434","f81b69bf-810b-8bb7-2828-3a1b1d423f98","Albacore catches - WCPFC Convention Area","year","Albacore catches in the convention area for VU IATTC reporting - Northern Committee Reporting","Logsheets",NA,NA,NA,3588,"shaazreenb@spc.int","shaazreenb@spc.int","Logsheet","2025-07-15T10:12:21.593"," SELECT  
		'L' as gear,
		vi.flag_id as flag, 
		year(logdate) as yr,
		count(distinct case when RIGHT(lat,1) = 'N' then CAST(t.vessel_id as varchar(50)) else null end) as NumVessels,
		count(distinct case when RIGHT(lat,1) = 'N' and  l_activity_id in (1) then CAST(t.vessel_id as varchar(50))+cast(logdate as varchar(20)) else null end) as DaysFishing,
		SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_n,sp_n) else 0000 end) as NumCaught,
		cast(SUM(case when c.sp_code = 'ALB' and RIGHT(lat,1) = 'N' then coalesce(sp_kg,sp_kg) else 000.000 end)/1000 as decimal(10,3)) as WeightCaught_mt
FROM log.trips_ll t inner join log.sets_ll s on t.log_trip_id = s.log_trip_id 
   					inner join log.catch_ll c on s.log_set_id = c.log_set_id 
			inner join ref.vessel_instances vi 
					on t.vessel_id = vi.vessel_id AND t.FIRST_LOGDATE BETWEEN vi.start_date AND vi.calculated_end_date
WHERE YEAR(logdate) <= coalesce(:year,year(logdate))
    AND YEAR(logdate) >= coalesce(:year,year(logdate))-2
    AND vi.flag_id =  @@entity

	and in_wcpfc_area = 1
group by vi.flag_id, year(logdate)",NA
"435","31e787c0-1cf5-1733-f963-3a1b227e7ec1","Logsheet Purse Seine effort, trips, sets by year and vessels","min_year",NA,"Logsheets",NA,NA,NA,3590,"aurelienp@spc.int","aurelienp@spc.int","Logsheet, Purseseine","2025-09-30T18:34:36.94"," SELECT  year(logdate) year,vesselname,vi.flag_id flag_code,
		COUNT(distinct t.log_trip_id) as trips,
		count(s.log_set_id) as sets
FROM log.trips_ps t 
join log.sets_ps s on t.log_trip_id = s.log_trip_id 
join ref.vessel_instances vi on t.vessel_id = vi.vessel_id AND t.depart_date BETWEEN vi.start_date AND vi.calculated_end_date
WHERE year(logdate) >= :min_year and s_activity_id=1
group by year(logdate),vi.flag_id,vesselname",NA
